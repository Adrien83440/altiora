<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTIORA â€” Marge brute & nette</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --blue-dark:#0f1f5c;--blue-main:#1a3dce;--blue-light:#4f7ef8;--blue-ghost:#f0f4ff;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f5f7ff;--sidebar-w:252px;--radius:12px;
      --green:#10b981;--green-light:#d1fae5;--orange:#f59e0b;--orange-light:#fef3c7;
      --red:#ef4444;--red-light:#fee2e2;--purple:#6366f1;--purple-light:#eef2ff;--teal:#14b8a6;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}

    /* SIDEBAR */
    .sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#0f1f5c 0%,#162366 100%);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;overflow-y:auto;}
    .sidebar-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 22px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:10px;}
    .sidebar-logo-icon{width:36px;height:36px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .sidebar-logo-text{font-size:18px;font-weight:800;color:white;letter-spacing:1px;}
    .sidebar-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,0.3);letter-spacing:1.2px;text-transform:uppercase;padding:14px 20px 5px;}
    .nav-item{display:flex;align-items:center;gap:11px;padding:10px 20px;color:rgba(255,255,255,0.6);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;user-select:none;}
    .nav-item:hover{color:white;background:rgba(255,255,255,0.06);}
    .nav-item.active{color:white;background:rgba(255,255,255,0.1);border-left-color:#4f7ef8;}
    .nav-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0;}
    .nav-label{flex:1;}
    .nav-chevron{font-size:11px;color:rgba(255,255,255,0.3);transition:transform 0.25s;margin-left:auto;}
    .nav-item.open .nav-chevron{transform:rotate(90deg);}
    .submenu{overflow:hidden;max-height:0;transition:max-height 0.3s ease;}
    .submenu.open{max-height:300px;}
    .sub-item{display:flex;align-items:center;gap:9px;padding:8px 20px 8px 44px;color:rgba(255,255,255,0.45);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;}
    .sub-item:hover{color:rgba(255,255,255,0.8);background:rgba(255,255,255,0.05);}
    .sub-item.active{color:white;background:rgba(79,126,248,0.15);border-left-color:rgba(79,126,248,0.6);}
    .sub-dot{width:5px;height:5px;background:rgba(255,255,255,0.3);border-radius:50%;flex-shrink:0;}
    .sub-item.active .sub-dot{background:#4f7ef8;}
    .sub-year-badge{margin-left:auto;font-size:10px;color:rgba(255,255,255,0.25);font-weight:600;}
    .sidebar-footer{margin-top:auto;padding:16px 20px 0;border-top:1px solid rgba(255,255,255,0.08);}
    .user-card{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.07);border-radius:10px;}
    .user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--blue-light),#6366f1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
    .user-name{font-size:12px;font-weight:600;color:white;}
    .user-plan{font-size:10px;color:rgba(255,255,255,0.4);}
    .logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:14px;padding:4px;}

    /* MAIN */
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:17px;font-weight:700;}
    .topbar-left p{font-size:12px;color:var(--muted);}
    .topbar-right{display:flex;align-items:center;gap:10px;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.18s;}
    .btn-primary{background:linear-gradient(135deg,var(--blue-main),var(--blue-light));color:white;box-shadow:0 3px 10px rgba(26,61,206,0.25);}
    .btn-primary:hover{opacity:0.9;transform:translateY(-1px);}
    .btn-success{background:linear-gradient(135deg,#10b981,#34d399);color:white;}
    .btn-outline{background:white;color:var(--blue-main);border:1.5px solid var(--border);}
    .btn-outline:hover{border-color:var(--blue-main);background:var(--blue-ghost);}
    .btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}
    .btn-sim{background:linear-gradient(135deg,#6366f1,#a5b4fc);color:white;box-shadow:0 3px 10px rgba(99,102,241,0.3);}
    .btn-sm{padding:5px 12px;font-size:12px;}
    .btn-xs{padding:3px 8px;font-size:11px;}

    

    /* LAYOUT */
    .content{padding:22px 28px;flex:1;display:flex;gap:20px;}
    .left-panel{width:290px;flex-shrink:0;display:flex;flex-direction:column;gap:14px;}
    .right-panel{flex:1;min-width:0;display:flex;flex-direction:column;gap:16px;}

    /* CATALOGUE */
    .panel-card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .panel-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);}
    .panel-title{font-size:13px;font-weight:700;color:var(--text);}
    .search-wrap{padding:10px 12px;border-bottom:1px solid var(--border);}
    .search-input{width:100%;padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;outline:none;}
    .search-input:focus{border-color:var(--blue-main);}
    .product-item{display:flex;align-items:center;gap:8px;padding:9px 14px;cursor:pointer;border-left:3px solid transparent;transition:all 0.15s;}
    .product-item:hover{background:#fafbff;}
    .product-item.active{background:var(--blue-ghost);border-left-color:var(--blue-main);}
    .product-emoji{font-size:18px;}
    .product-info{flex:1;min-width:0;}
    .product-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .product-cat{font-size:10px;color:var(--muted);}
    .product-mb{font-size:11px;font-weight:700;}
    .mb-good{color:var(--green);}
    .mb-warn{color:var(--orange);}
    .mb-bad{color:var(--red);}

    /* EMPTY */
    .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:500px;text-align:center;color:var(--muted);padding:40px;}
    .empty-icon{font-size:52px;margin-bottom:14px;}

    /* MARGE CARD */
    .marge-header{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px 24px;}
    .marge-product-name{font-size:22px;font-weight:800;color:var(--text);margin-bottom:4px;}
    .marge-meta{display:flex;align-items:center;gap:10px;margin-bottom:18px;}
    .meta-badge{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;background:var(--blue-ghost);color:var(--blue-main);}

    /* KPI ROW */
    .kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
    .kpi-box{padding:14px 16px;border-radius:10px;border:1px solid var(--border);background:white;}
    .kpi-box.green{background:var(--green-light);border-color:#6ee7b7;}
    .kpi-box.orange{background:var(--orange-light);border-color:#fcd34d;}
    .kpi-box.red{background:var(--red-light);border-color:#fca5a5;}
    .kpi-box.blue{background:var(--blue-ghost);border-color:#c7d2fe;}
    .kpi-box.purple{background:var(--purple-light);border-color:#c7d2fe;}
    .kpi-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;}
    .kpi-val{font-size:19px;font-weight:800;color:var(--text);}
    .kpi-val.pos{color:var(--green);}
    .kpi-val.neg{color:var(--red);}
    .kpi-val.blue{color:var(--blue-main);}
    .kpi-sub{font-size:10px;color:var(--muted);margin-top:3px;}

    /* DECOMPOSITION */
    .decomp-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
    .decomp-card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .decomp-head{display:flex;align-items:center;justify-content:space-between;padding:13px 18px;background:#f8faff;border-bottom:1px solid var(--border);}
    .decomp-title{font-size:12px;font-weight:700;display:flex;align-items:center;gap:6px;}
    .decomp-total{font-size:13px;font-weight:800;color:var(--blue-main);}
    .decomp-body{padding:14px 18px;}
    .decomp-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
    .decomp-row:last-child{margin-bottom:0;}
    .decomp-label{font-size:12px;color:var(--text);display:flex;align-items:center;gap:6px;}
    .decomp-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
    .decomp-val{font-size:12px;font-weight:700;}
    .decomp-pct{font-size:11px;color:var(--muted);margin-left:4px;}
    .decomp-bar-wrap{margin-top:4px;height:4px;background:#f1f5f9;border-radius:99px;overflow:hidden;}
    .decomp-bar-fill{height:100%;border-radius:99px;}

    /* CLE REPARTITION */
    .cle-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:18px;}
    .cle-title{font-size:13px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
    .cle-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px;}
    .cle-btn{padding:10px;border:2px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;background:white;transition:all 0.15s;font-family:'Plus Jakarta Sans',sans-serif;}
    .cle-btn:hover{border-color:var(--blue-light);background:var(--blue-ghost);}
    .cle-btn.active{border-color:var(--blue-main);background:var(--blue-ghost);}
    .cle-icon{font-size:20px;margin-bottom:3px;}
    .cle-label{font-size:11px;font-weight:600;color:var(--text);}
    .cle-inputs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    .cle-field{display:flex;flex-direction:column;gap:4px;}
    .cle-field label{font-size:11px;font-weight:600;color:var(--muted);}
    .cle-input{padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;color:var(--text);outline:none;}
    .cle-input:focus{border-color:var(--blue-main);}
    .cle-result{margin-top:12px;padding:10px 14px;background:var(--blue-ghost);border-radius:8px;font-size:12px;color:var(--blue-main);font-weight:600;}

    /* MARGE VISUELLE */
    .marge-viz{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:18px;}
    .viz-title{font-size:13px;font-weight:700;margin-bottom:14px;}
    .viz-bar-wrap{margin-bottom:8px;}
    .viz-bar-label{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:4px;}
    .viz-bar{height:28px;background:#f1f5f9;border-radius:8px;overflow:hidden;display:flex;}
    .viz-seg{display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:white;min-width:0;transition:width 0.6s ease;overflow:hidden;white-space:nowrap;}
    .viz-legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .viz-leg-item{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted);}
    .viz-leg-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}

    /* SIMULATEUR */
    .sim-card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:0 4px 24px rgba(99,102,241,0.08);}
    .sim-head{padding:18px 24px;background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%);display:flex;align-items:center;justify-content:space-between;}
    .sim-title{font-size:15px;font-weight:700;color:white;display:flex;align-items:center;gap:8px;}
    .sim-body{padding:22px 24px;}
    .sim-levers{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:18px;}
    .sim-lever{background:white;border:1.5px solid #e8eaf6;border-radius:14px;padding:18px;transition:border-color 0.15s;}
    .sim-lever:hover{border-color:#c7d2fe;}
    .sim-lever-label{font-size:12px;font-weight:700;color:#374151;margin-bottom:14px;display:flex;align-items:center;gap:7px;}
    .sim-lever-tag{font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px;background:#f0f4ff;color:var(--blue-main);margin-left:auto;}
    .sim-fields-row{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
    .sim-field-group{display:flex;flex-direction:column;gap:3px;}
    .sim-field-lbl{font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;}
    .sim-field-wrap{display:flex;align-items:center;gap:4px;padding:7px 10px;background:#f8faff;border:1.5px solid #e2e8f0;border-radius:8px;transition:border-color 0.15s;}
    .sim-field-wrap:focus-within{border-color:var(--blue-main);background:white;box-shadow:0 0 0 3px rgba(79,126,248,0.1);}
    .sim-field-input{width:54px;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;font-weight:800;color:#1a1f36;text-align:center;outline:none;}
    .sim-field-input::placeholder{color:#cbd5e1;}
    .sim-field-unit{font-size:11px;font-weight:700;color:var(--muted);flex-shrink:0;}
    .sim-sep{font-size:14px;color:#d1d5db;font-weight:300;padding:0 2px;margin-top:18px;}
    .sim-slider-wrap{display:flex;flex-direction:column;gap:3px;}
    .sim-slider{width:100%;height:4px;accent-color:#6366f1;cursor:pointer;border-radius:99px;}
    .sim-range-labels{display:flex;justify-content:space-between;font-size:10px;color:#94a3b8;}
    .sim-lever-full{background:white;border:1.5px solid #e8eaf6;border-radius:14px;padding:18px;margin-bottom:18px;}

    /* RÃ‰SULTAT SIMULATEUR */
    .sim-result{background:linear-gradient(135deg,#1a1f36,#2d3561);border-radius:12px;padding:20px;color:white;}
    .sim-result-title{font-size:12px;font-weight:600;color:rgba(255,255,255,0.6);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:14px;}
    .sim-result-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
    .sim-res-box{text-align:center;}
    .sim-res-label{font-size:10px;color:rgba(255,255,255,0.5);font-weight:600;text-transform:uppercase;margin-bottom:5px;}
    .sim-res-current{font-size:11px;color:rgba(255,255,255,0.4);margin-bottom:2px;}
    .sim-res-new{font-size:18px;font-weight:800;}
    .sim-res-new.pos{color:#34d399;}
    .sim-res-new.neg{color:#f87171;}
    .sim-res-new.neutral{color:white;}
    .sim-res-delta{font-size:11px;font-weight:700;margin-top:3px;}
    .sim-res-delta.pos{color:#6ee7b7;}
    .sim-res-delta.neg{color:#fca5a5;}
    .sim-reset{margin-top:14px;text-align:center;}

    /* TABLEAU COMPARATIF */
    .comp-table{width:100%;border-collapse:collapse;font-size:12px;}
    .comp-table th{padding:9px 14px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;background:#f8faff;border-bottom:1px solid var(--border);}
    .comp-table th:not(:first-child){text-align:right;}
    .comp-table td{padding:9px 14px;border-bottom:1px solid #f1f5f9;}
    .comp-table td:not(:first-child){text-align:right;font-weight:600;}
    .comp-table tr:last-child td{border-bottom:none;font-weight:800;background:#f0f4ff;}
    .td-pos{color:var(--green);}
    .td-neg{color:var(--red);}
    .td-blue{color:var(--blue-main);}
    .td-arrow-pos{color:var(--green);}
    .td-arrow-neg{color:var(--red);}

    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(15,31,92,0.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;width:100%;max-width:500px;box-shadow:0 24px 60px rgba(15,31,92,0.2);overflow:hidden;}
    .modal-head{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
    .modal-head h3{font-size:15px;font-weight:700;}
    .modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);}
    .modal-body{padding:20px 24px;max-height:70vh;overflow-y:auto;}
    .modal-foot{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;}
    .modal-field{margin-bottom:14px;}
    .modal-label{font-size:12px;font-weight:600;color:var(--muted);margin-bottom:5px;display:block;}
    .modal-input{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;}
    .modal-input:focus{border-color:var(--blue-main);}
    .modal-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all 0.3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.success{background:#10b981;}

    .loader{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--muted);gap:10px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--blue-main);border-radius:50%;animation:spin .7s linear infinite;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .right-panel{animation:fadeIn 0.25s ease both;}
  .ucard:hover{background:rgba(255,255,255,.12);transform:translateY(-1px);transition:.15s}


/* â”€â”€ MOBILE UNIQUEMENT â”€â”€ */









/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘   ALTIORA â€” RESPONSIVE MOBILE (iPhone/Android)  â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* 1. RESET global overflow */
html, body { overflow-x: hidden; max-width: 100vw; }

/* 2. HAMBURGER â€” masquÃ© par dÃ©faut */
.hamburger {
  display: none;
  position: fixed;
  top: 14px; left: 14px;
  z-index: 1001;
  width: 44px; height: 44px;
  background: #0f1f5c;
  border: none; border-radius: 12px;
  cursor: pointer;
  flex-direction: column;
  align-items: center; justify-content: center;
  gap: 5px;
  box-shadow: 0 4px 16px rgba(15,31,92,.45);
  -webkit-tap-highlight-color: transparent;
  transition: background .2s;
}
.hamburger:active { background: #1a3dce; }
.hamburger span {
  display: block; width: 20px; height: 2.5px;
  background: #fff; border-radius: 2px;
  transition: all .25s ease;
  pointer-events: none;
}
.hamburger.open span:nth-child(1) { transform: translateY(7.5px) rotate(45deg); }
.hamburger.open span:nth-child(2) { opacity: 0; transform: scaleX(0); }
.hamburger.open span:nth-child(3) { transform: translateY(-7.5px) rotate(-45deg); }

/* 3. OVERLAY */
.nav-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.5); z-index: 1000;
  -webkit-tap-highlight-color: transparent;
}
.nav-overlay.show { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MOBILE â‰¤768px â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {

  /* HAMBURGER visible */
  .hamburger { display: flex !important; }

  /* SIDEBAR / NAV â†’ drawer */
  nav, aside.sidebar, .sidebar {
    position: fixed !important;
    top: 0 !important; left: 0 !important;
    height: 100vh !important;
    height: -webkit-fill-available !important;
    width: min(280px, 84vw) !important;
    z-index: 1001 !important;
    transform: translateX(-105%) !important;
    transition: transform .3s cubic-bezier(.4,0,.2,1) !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
    margin: 0 !important;
    box-sizing: border-box !important;
  }
  nav.open, aside.sidebar.open, .sidebar.open {
    transform: translateX(0) !important;
    box-shadow: 8px 0 32px rgba(0,0,0,.3) !important;
  }

  /* MAIN CONTENT â†’ pleine largeur */
  .main, main, div.main, .main-content {
    margin-left: 0 !important;
    width: 100vw !important;
    overflow-x: hidden !important;
    box-sizing: border-box !important;
  }

  /* TOPBAR */
  .topbar {
    padding: 10px 10px 10px 62px !important;
    flex-wrap: wrap !important;
    gap: 6px !important;
    position: sticky !important;
    top: 0 !important; z-index: 50 !important;
    background: #fff !important;
    box-shadow: 0 1px 6px rgba(0,0,0,.08) !important;
    box-sizing: border-box !important;
    width: 100% !important;
  }
  .topbar h1, .topbar-left h1, .topbar-left h2 { font-size: 14px !important; }
  .topbar p, .topbar-left p { font-size: 10px !important; }
  .topbar-right, .tb-r {
    width: 100% !important;
    flex-wrap: wrap !important;
    gap: 6px !important;
  }
  .topbar-right .btn, .tb-r .btn,
  .topbar-right button, .tb-r button {
    flex: 1 1 auto !important;
    font-size: 11px !important;
    padding: 7px 8px !important;
    min-height: 36px !important;
    white-space: nowrap !important;
    min-width: 0 !important;
  }

  /* PAGE / CONTENT */
  .content, .page {
    padding: 12px 10px !important;
    overflow-x: hidden !important;
    width: 100% !important;
    box-sizing: border-box !important;
    gap: 12px !important;
  }
  .content > *, .page > * {
    box-sizing: border-box !important;
    max-width: 100% !important;
  }

  /* â”€â”€ TOUTES LES GRILLES â†’ 1 COLONNE â”€â”€ */
  /* Dashboard */
  .kpi-grid-4, .kpi-grid-5 { grid-template-columns: 1fr 1fr !important; gap: 8px !important; margin-bottom: 12px !important; }
  .charts-grid, .charts-grid-3 { grid-template-columns: 1fr !important; gap: 12px !important; }
  /* Suivi CA */
  .kpi-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .charts-grid-2 { grid-template-columns: 1fr !important; gap: 12px !important; }
  /* CoÃ»t de revient */
  .fiche-kpis { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .prix-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  /* Marges */
  .decomp-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .cle-grid { grid-template-columns: 1fr !important; gap: 8px !important; }
  .cle-inputs { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .sim-levers { grid-template-columns: 1fr !important; gap: 8px !important; }
  .sim-result-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .modal-row { grid-template-columns: 1fr !important; gap: 8px !important; }
  /* Pilotage */
  .summary-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; margin-bottom: 12px !important; }
  .sections-grid { grid-template-columns: 1fr !important; gap: 12px !important; }
  .tva-result { grid-template-columns: 1fr !important; gap: 8px !important; }
  .cashflow-grid { grid-template-columns: 1fr !important; gap: 8px !important; }
  /* Panier moyen */
  .fields-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .results-row { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .g2, .g3 { grid-template-columns: 1fr !important; gap: 12px !important; }
  .cats { grid-template-columns: 1fr !important; gap: 10px !important; }
  .sim-g { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .sim-rg { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  /* Dettes */
  .detail-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .mgrid2 { grid-template-columns: 1fr !important; gap: 10px !important; }
  /* Profil */
  .plan-grid { grid-template-columns: 1fr !important; gap: 12px !important; }
  /* Universels */
  .kpi-row { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .type-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .fact-kpis { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .calendar-grid { grid-template-columns: repeat(4, 1fr) !important; gap: 5px !important; }

  /* â”€â”€ KPI CARDS â€” texte lisible â”€â”€ */
  .kpi-card, .kpi, .summary-card, .fkpi {
    padding: 12px 10px !important;
    overflow: hidden !important;
    min-width: 0 !important;
  }
  .kpi-value, .kpi-val, .summary-value { font-size: 16px !important; letter-spacing: -0.3px !important; }
  .kpi-label, .kpi-lbl, .summary-label { font-size: 9px !important; line-height: 1.3 !important; }
  .kpi-sub { font-size: 10px !important; }

  /* â”€â”€ TABLEAUX â€” scroll interne propre â”€â”€ */
  .echeancier-wrap,
  div[style*="overflow-x"],
  .section-body, .section-content,
  .table-wrap, .table-card, .table-container,
  .card > div { overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; }
  table { min-width: 460px !important; font-size: 11px !important; }
  
  /* â”€â”€ INPUTS TOUCH (Ã©vite zoom iOS) â”€â”€ */
  input[type=text], input[type=number], input[type=email],
  input[type=date], input[type=tel], input[type=password],
  select, textarea {
    font-size: 16px !important;
    -webkit-appearance: none !important;
  }
  .field-wrap, .mfield-wrap, .sim-fw {
    min-height: 46px !important;
    padding: 10px 12px !important;
  }

  /* â”€â”€ BOUTONS â”€â”€ */
  .btn { min-height: 40px !important; }
  .btn-xs, .btn-sm { min-height: 34px !important; }

  /* â”€â”€ PILOTAGE SUMMARY CARDS â”€â”€ */
  .summary-card .kpi-value,
  .summary-card .summary-value { white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }
  .summary-card .kpi-sub,
  .summary-card .summary-sub { white-space: normal !important; font-size: 10px !important; }

  /* â”€â”€ SECTION HEAD â”€â”€ */
  .section-head { flex-wrap: wrap !important; gap: 6px !important; padding: 10px 12px !important; }
  .section-head .btn, .section-head button { font-size: 10px !important; padding: 4px 8px !important; }

  /* â”€â”€ MONTH STRIP (panier moyen) â”€â”€ */
  .month-strip { overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; flex-wrap: nowrap !important; padding-bottom: 6px !important; }
  .mbtn { flex-shrink: 0 !important; }

  /* â”€â”€ YEAR BAR â”€â”€ */
  .yr-bar { overflow-x: auto !important; flex-wrap: nowrap !important; -webkit-overflow-scrolling: touch !important; }
  .yr { flex-shrink: 0 !important; }

  /* â”€â”€ TABS â”€â”€ */
  .tabs { overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; flex-wrap: nowrap !important; width: 100% !important; }
  .tab { flex-shrink: 0 !important; white-space: nowrap !important; }

  /* â”€â”€ DETTE CARDS â”€â”€ */
  .dette-head { flex-wrap: wrap !important; gap: 8px !important; }
  .dette-stats { flex-direction: column !important; align-items: flex-start !important; gap: 4px !important; }

  /* â”€â”€ SAISIE (panier) â”€â”€ */
  .saisie-head { flex-direction: column !important; gap: 8px !important; align-items: flex-start !important; }

  /* â”€â”€ HERO (profil) â”€â”€ */
  .hero { flex-direction: column !important; text-align: center !important; padding: 16px !important; gap: 12px !important; }
  .hero-right { text-align: center !important; }
  .hero-tags { justify-content: center !important; }
  .hero-name { font-size: 17px !important; }

  /* â”€â”€ MODAL â†’ bottom sheet â”€â”€ */
  .overlay, .modal-overlay { align-items: flex-end !important; padding: 0 !important; }
  .modal {
    width: 100% !important; max-width: 100% !important;
    margin: 0 !important;
    border-radius: 18px 18px 0 0 !important;
    max-height: 92vh !important;
  }

  /* â”€â”€ CANVAS â”€â”€ */
  canvas { max-width: 100% !important; }

  /* â”€â”€ CONTEXT BAR (dashboard) â”€â”€ */
  .context-bar { flex-wrap: wrap !important; gap: 8px !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PETIT MOBILE â‰¤420px â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 420px) {
  .kpi-grid-4, .kpi-grid-5, .kpi-grid, .kpi-row,
  .fiche-kpis, .summary-grid, .fact-kpis,
  .type-grid, .results-row, .sim-g { grid-template-columns: 1fr !important; }
  .sim-rg, .sim-result-grid, .cle-inputs { grid-template-columns: 1fr !important; }
  .calendar-grid { grid-template-columns: repeat(3, 1fr) !important; }
}


    .nav-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 20px 4px}
</style>
</head>
<body>
  <button class="hamburger" id="hamburger" onclick="toggleSidebar()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
  <div class="nav-overlay" id="navOverlay" onclick="closeSidebar()"></div>
<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo"><div class="sidebar-logo-icon">ğŸ“Š</div><div class="sidebar-logo-text">ALTIORA</div></div>
  <div class="sidebar-section-label">Principal</div>
  <div class="nav-item" onclick="window.location.href='dashboard.html'"><span class="nav-icon">ğŸ </span><span class="nav-label">Tableau de bord</span></div>
  <div class="nav-item" onclick="window.location.href='suivi-ca.html'"><span class="nav-icon">ğŸ“ˆ</span><span class="nav-label">Suivi CA & RÃ©sultats</span></div>
  <div class="nav-item active" id="kpis-nav"><span class="nav-icon">ğŸ¯</span><span class="nav-label" onclick="toggleMenu('kpis-menu',document.getElementById('kpis-nav'))">KPIs ClÃ©s</span><span class="nav-chevron" onclick="toggleMenu('kpis-menu',document.getElementById('kpis-nav'))">â€º</span></div>
  <div class="submenu open" id="kpis-menu">
    <div class="sub-item" onclick="window.location.href='cout-revient.html'"><span class="sub-dot"></span>CoÃ»t de revient</div>
    <div class="sub-item active"><span class="sub-dot"></span>Marge brute & nette</div>
    <div class="sub-item" onclick="window.location.href='panier-moyen.html'"><span class="sub-dot"></span>Panier moyen</div>
  </div>
  <div class="nav-item" onclick="toggleMenu('pilotage-menu',this)"><span class="nav-icon">ğŸ§­</span><span class="nav-label">Pilotage</span><span class="nav-chevron">â€º</span></div>
  <div class="submenu" id="pilotage-menu">
    <div class="sub-item" onclick="window.location.href='pilotage.html?year=2025'"><span class="sub-dot"></span>Pilotage 2025<span class="sub-year-badge">2025</span></div>
    <div class="sub-item" onclick="window.location.href='pilotage.html?year=2026'"><span class="sub-dot"></span>Pilotage 2026<span class="sub-year-badge">2026</span></div>
    <div class="sub-item" onclick="window.location.href='pilotage.html?year=2027'"><span class="sub-dot"></span>Pilotage 2027<span class="sub-year-badge">2027</span></div>
  </div>
  <div class="nav-item"><span class="nav-icon">ğŸ¦</span><span class="nav-label">Dettes & Emprunts</span></div>
  <div class="nav-section-label">FidÃ©lisation</div>
  <div class="nav-item" onclick="toggleFidNav(this)" style="justify-content:space-between">
    <span style="display:flex;align-items:center;gap:8px"><span class="nav-icon">ğŸ’</span><span class="nav-label">FidÃ©lisation</span></span>
    <span class="nav-chev" style="font-size:11px;color:rgba(255,255,255,.3);transition:transform .25s">â€º</span>
  </div>
  <div class="nav-fid-sub" style="overflow:hidden;max-height:0;transition:max-height .35s ease">
    <div class="nav-sub-item" onclick="location.href='fidelisation.html'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Dashboard fidÃ©litÃ©</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#clients'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Clients</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#carte'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Carte fidÃ©litÃ©</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#points'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Points & RÃ©compenses</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#coupons'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Coupons & Offres</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#campagnes'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Campagnes</div>
  </div>
  <div class="nav-item" onclick="location.href='import.html'" style="border-top:1px solid rgba(255,255,255,.08);padding-top:10px"><span class="nav-icon">ğŸ“¥</span><span class="nav-label">Import de donnÃ©es</span></div>
  <div class="sidebar-footer">
    <div class="user-card" onclick="location.href='profil.html'" style="cursor:pointer;transition:.15s" title="Mon compte">
      <div class="user-avatar" id="userAvatar">A</div>
      <div><div class="user-name" id="userName">Utilisateur</div><div class="user-plan">Plan gratuit</div></div>
      <button class="logout-btn" onclick="handleLogout()">â‹</button>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>Marge brute & nette</h1>
      <p>Analyse des marges <strong>HT</strong> par produit Â· ClÃ© de rÃ©partition des charges fixes Â· Toutes les valeurs sont en HT</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="window.location.href='cout-revient.html'">ğŸ§® CoÃ»t de revient</button>
      <button class="btn btn-primary btn-sm" onclick="openNewProductModal()">+ Ajouter un produit</button>
    </div>
  </div>

  <div class="content">
    <!-- LEFT -->
    <div class="left-panel">
      <div class="panel-card" style="flex:1">
        <div class="panel-head">
          <div class="panel-title">ğŸ“¦ Produits</div>
          <button class="btn btn-primary btn-xs" onclick="openNewProductModal()">+ Nouveau</button>
        </div>
        <div class="search-wrap">
          <input class="search-input" placeholder="ğŸ” Rechercher..." oninput="filterProducts(this.value)"/>
        </div>
        <div id="productList"><div class="loader"><div class="spin"></div></div></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="right-panel" id="rightPanel">
      <div class="empty-state">
        <div class="empty-icon">ğŸ“Š</div>
        <h3 style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px">SÃ©lectionnez un produit</h3>
        <p style="font-size:13px;line-height:1.7;max-width:320px">Choisissez un produit pour analyser ses marges brute et nette, configurer votre clÃ© de rÃ©partition et simuler des scÃ©narios.</p>
        <button class="btn btn-primary" style="margin-top:16px" onclick="openNewProductModal()">+ CrÃ©er un produit</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL NOUVEAU PRODUIT -->
<div class="modal-overlay" id="newProductModal">
  <div class="modal">
    <div class="modal-head">
      <h3>â• Nouveau produit / service</h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-row">
        <div class="modal-field">
          <label class="modal-label">Nom *</label>
          <input class="modal-input" id="mn-nom" placeholder="Ex: Tarte citron, Consulting..."/>
        </div>
        <div class="modal-field">
          <label class="modal-label">CatÃ©gorie</label>
          <input class="modal-input" id="mn-cat" placeholder="PÃ¢tisseries, Services..."/>
        </div>
      </div>
      <div class="modal-row">
        <div class="modal-field">
          <label class="modal-label">Prix de vente HT (â‚¬)</label>
          <input class="modal-input" id="mn-pv" type="number" placeholder="0.00"/>
        </div>
        <div class="modal-field">
          <label class="modal-label">QuantitÃ© / pÃ©riode</label>
          <input class="modal-input" id="mn-qte" type="number" placeholder="Ex: 100 unitÃ©s/mois"/>
        </div>
      </div>
      <div style="font-size:12px;font-weight:700;color:var(--text);margin:14px 0 10px">CoÃ»ts variables (par unitÃ©)</div>
      <div class="modal-row">
        <div class="modal-field">
          <label class="modal-label">MatiÃ¨res premiÃ¨res (â‚¬)</label>
          <input class="modal-input" id="mn-mp" type="number" placeholder="0.00"/>
        </div>
        <div class="modal-field">
          <label class="modal-label">Main d'Å“uvre (â‚¬)</label>
          <input class="modal-input" id="mn-mo" type="number" placeholder="0.00"/>
        </div>
      </div>
      <div class="modal-row">
        <div class="modal-field">
          <label class="modal-label">Emballages (â‚¬)</label>
          <input class="modal-input" id="mn-emb" type="number" placeholder="0.00"/>
        </div>
        <div class="modal-field">
          <label class="modal-label">Livraison (â‚¬)</label>
          <input class="modal-input" id="mn-liv" type="number" placeholder="0.00"/>
        </div>
      </div>
      <div style="font-size:12px;font-weight:700;color:var(--text);margin:14px 0 10px">Charges fixes totales de la structure (â‚¬/mois)</div>
      <div class="modal-row">
        <div class="modal-field">
          <label class="modal-label">Total charges fixes (â‚¬)</label>
          <input class="modal-input" id="mn-cf" type="number" placeholder="Ex: 5000"/>
        </div>
        <div class="modal-field">
          <label class="modal-label">Emoji</label>
          <input class="modal-input" id="mn-emoji" placeholder="ğŸ°" maxlength="2"/>
        </div>
      </div>
      <div style="font-size:11px;color:var(--muted);background:var(--blue-ghost);padding:10px;border-radius:8px;margin-top:4px">
        ğŸ’¡ Si vous avez dÃ©jÃ  saisi ce produit dans le <strong>CoÃ»t de revient</strong>, sÃ©lectionnez-le depuis la liste existante â€” les donnÃ©es seront importÃ©es automatiquement.
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" onclick="createProduct()">CrÃ©er & Analyser â†’</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth=getAuth(app); const db=getFirestore(app);
  window._auth=auth;window._db=db;window._doc=doc;window._setDoc=setDoc;
  window._getDoc=getDoc;window._collection=collection;window._getDocs=getDocs;
  window._deleteDoc=deleteDoc;window._signOut=signOut;
  onAuthStateChanged(auth,user=>{
    if(!user){window.location.href='index.html';return;}
    window._uid=user.uid;
    const name=user.displayName||user.email.split('@')[0];
    document.getElementById('userName').textContent=name;
    document.getElementById('userAvatar').textContent=name.charAt(0).toUpperCase();
    loadProducts();
  });
</script>

<script>
// â”€â”€ STATE â”€â”€
let _products = {};
let _currentId = null;
// Simulateur
let _sim = { pv:0, mp:0, mo:0, cf:0, vol:0 };
// ClÃ© rÃ©partition
let _cle = { type:'temps', produit:0, total:0 };

function toggleMenu(id,el){document.getElementById(id).classList.toggle('open');el.classList.toggle('open');}
async function handleLogout(){await window._signOut(window._auth);window.location.href='index.html';}

// â”€â”€ LOAD â”€â”€
async function loadProducts(){
  if(!window._uid){setTimeout(loadProducts,500);return;}
  _products = {};

  // 1. Charger depuis module CoÃ»t de revient
  try{
    const snap = await window._getDocs(window._collection(window._db,'produits',window._uid,'items'));
    snap.forEach(d=>{
      const p = d.data();
      const qte = parseFloat(p.quantiteProduites)||1;
      const mp = (p.ingredients||[]).reduce((s,r)=>(parseFloat(r.qte)||0)*(parseFloat(r.prixUnitaire)||0)+s,0)/qte;
      const mo = (p.mainOeuvre||[]).reduce((s,r)=>(parseFloat(r.heures)||0)*(parseFloat(r.tauxHoraire)||0)+s,0)/qte;
      const emb = (p.emballages||[]).reduce((s,r)=>(parseFloat(r.qte)||0)*(parseFloat(r.prixUnit)||0)+s,0)/qte;
      const liv = (p.livraison||[]).reduce((s,r)=>s+(parseFloat(r.montant)||0),0)/qte;
      const cfTotal = (p.chargesFixes||[]).reduce((s,r)=>{
        const m=parseFloat(r.montant)||0, rep=parseFloat(r.repartition)||0;
        return s+(rep>0?m*rep/100:m);
      },0)/qte;
      _products['cr_'+d.id] = {
        id:'cr_'+d.id, nom:p.nom, categorie:p.categorie||'', emoji:p.emoji||'ğŸ“¦',
        source:'cout-revient',
        pv: parseFloat(p.prixVente)||0,
        qte: parseFloat(p.quantiteProduites)||1,
        mp, mo, emb, liv,
        cfTotal: cfTotal,
        cle: {type:'temps',produit:0,total:0},
        sim: {pv:0,mp:0,mo:0,cf:0,vol:0}
      };
    });
  }catch(e){console.warn(e);}

  // 2. Charger depuis module Marges (saisie directe)
  try{
    const snap = await window._getDocs(window._collection(window._db,'marges',window._uid,'produits'));
    snap.forEach(d=>_products['mg_'+d.id]={id:'mg_'+d.id,...d.data(),source:'marges'});
  }catch(e){console.warn(e);}

  renderList();
}

// â”€â”€ CALCULS â”€â”€
function calcMB(p){
  const cv = (parseFloat(p.mp)||0)+(parseFloat(p.mo)||0)+(parseFloat(p.emb)||0)+(parseFloat(p.liv)||0);
  const mb = (parseFloat(p.pv)||0) - cv;
  const txMB = p.pv>0 ? mb/p.pv*100 : 0;
  return {cv, mb, txMB};
}

function calcCleRep(p){
  const cle = p.cle||{type:'temps',produit:0,total:0};
  const prod = parseFloat(cle.produit)||0;
  const total = parseFloat(cle.total)||1;
  const ratio = total>0 ? Math.min(prod/total,1) : 0;
  const cf = p.cfTotal>0 ? p.cfTotal : 0;
  // Si clÃ© configurÃ©e, utiliser le ratio, sinon utiliser cfTotal dÃ©jÃ  calculÃ© par unitÃ©
  const cfImpute = p.cfTotal>0 && prod>0 ? cf * ratio / Math.max(parseFloat(p.qte)||1,1) : cf;
  return {ratio, cfImpute, cle};
}

function calcMN(p){
  const {cv,mb,txMB} = calcMB(p);
  const {cfImpute} = calcCleRep(p);
  const mn = mb - cfImpute;
  const txMN = p.pv>0 ? mn/p.pv*100 : 0;
  return {cv, mb, txMB, cfImpute, mn, txMN};
}

function calcSim(p, sim){
  const pvSim = p.pv*(1+(parseFloat(sim.pv)||0)/100);
  const mpSim = (p.mp||0)*(1-(parseFloat(sim.mp)||0)/100);
  const moSim = (p.mo||0)*(1-(parseFloat(sim.mo)||0)/100);
  const cfSim = (p.cfTotal||0)*(1-(parseFloat(sim.cf)||0)/100);
  const volSim = parseFloat(sim.vol)||parseFloat(p.qte)||1;
  const cvSim = mpSim + moSim + (parseFloat(p.emb)||0) + (parseFloat(p.liv)||0);
  const mbSim = pvSim - cvSim;
  const txMBSim = pvSim>0 ? mbSim/pvSim*100 : 0;
  const {ratio} = calcCleRep(p);
  const cfImputeSim = cfSim * ratio / Math.max(volSim,1);
  const mnSim = mbSim - cfImputeSim;
  const txMNSim = pvSim>0 ? mnSim/pvSim*100 : 0;
  const margeTotSim = mbSim * volSim;
  const margeNetTotSim = mnSim * volSim;
  return {pvSim,cvSim,mbSim,txMBSim,cfImputeSim,mnSim,txMNSim,margeTotSim,margeNetTotSim,volSim};
}

// â”€â”€ RENDER LIST â”€â”€
function renderList(filter=''){
  const list = document.getElementById('productList');
  const items = Object.values(_products).filter(p=>
    !filter || p.nom.toLowerCase().includes(filter.toLowerCase()) || (p.categorie||'').toLowerCase().includes(filter.toLowerCase())
  );
  if(items.length===0){
    list.innerHTML=`<div style="padding:24px;text-align:center;color:var(--muted);font-size:12px"><div style="font-size:32px;margin-bottom:8px">ğŸ“¦</div>Aucun produit.<br>CrÃ©ez-en un ou saisissez dans<br>le CoÃ»t de revient.</div>`;
    return;
  }
  list.innerHTML = items.map(p=>{
    const {mb,txMB}=calcMB(p);
    const cls=txMB>=30?'mb-good':txMB>=10?'mb-warn':'mb-bad';
    return `<div class="product-item ${_currentId===p.id?'active':''}" onclick="openProduct('${p.id}')">
      <span class="product-emoji">${p.emoji||'ğŸ“¦'}</span>
      <div class="product-info">
        <div class="product-name">${p.nom}</div>
        <div class="product-cat">${p.categorie||'â€”'} ${p.source==='cout-revient'?'<span style="color:#4f7ef8;font-size:9px;font-weight:700">â—CR</span>':''}</div>
      </div>
      <div class="product-mb ${cls}">${p.pv>0?txMB.toFixed(1)+'%':''}</div>
    </div>`;
  }).join('');
}

function filterProducts(v){renderList(v);}

// â”€â”€ OPEN PRODUCT â”€â”€
function openProduct(id){
  _currentId = id;
  renderList();
  renderProduct(_products[id]);
}

function renderProduct(p){
  const {cv,mb,txMB,cfImpute,mn,txMN} = calcMN(p);
  const sim = p.sim||{pv:0,mp:0,mo:0,cf:0,vol:parseFloat(p.qte)||1};
  const s = calcSim(p,sim);
  const cle = p.cle||{type:'temps',produit:0,total:0};
  const cleLabels={temps:['â± Temps','Heures ce produit','Heures totales prod.'],superficie:['ğŸ“ Superficie','mÂ² utilisÃ©s','mÂ² total atelier'],volume:['ğŸ“¦ Volume','UnitÃ©s produit','UnitÃ©s totales'],ca:['ğŸ’° CA','CA ce produit (â‚¬)','CA total (â‚¬)']};
  const cl=cleLabels[cle.type]||cleLabels['temps'];

  const right = document.getElementById('rightPanel');
  right.innerHTML = `
    <!-- HEADER -->
    <div class="marge-header">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <div class="marge-product-name">${p.emoji||'ğŸ“¦'} ${p.nom}</div>
          <div class="marge-meta">
            <span class="meta-badge">${p.categorie||'Sans catÃ©gorie'}</span>
            ${p.source==='cout-revient'?'<span class="meta-badge" style="background:#f0fdf4;color:#10b981">ğŸ“¥ ImportÃ© du CoÃ»t de revient</span>':''}
            <span style="font-size:12px;color:var(--muted)">PV : <b>${fmtE(p.pv)}</b> HT Â· QtÃ© : <b>${p.qte||1}</b> unitÃ©s/pÃ©riode</span>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-outline btn-sm" onclick="editProduct('${p.id}')">âœï¸ Modifier</button>
          <button class="btn btn-danger btn-sm" onclick="deleteProduct('${p.id}')">ğŸ—‘</button>
        </div>
      </div>

      <!-- KPI ROW -->
      <div class="kpi-row" id="kpi-row-live">
        <div class="kpi-box blue">
          <div class="kpi-label">Prix vente <span style="font-size:9px;background:#e0f2fe;color:#0369a1;padding:1px 5px;border-radius:4px;font-weight:700">HT</span></div>
          <div class="kpi-val blue" id="kpi-pv">${fmtE(p.pv)}</div>
          <div class="kpi-sub">Par unitÃ©</div>
        </div>
        <div class="kpi-box ${txMB>=30?'green':txMB>=10?'orange':'red'}" id="kpi-box-mb">
          <div class="kpi-label">Marge brute <span style="font-size:9px;background:#dcfce7;color:#166534;padding:1px 5px;border-radius:4px;font-weight:700">HT</span></div>
          <div class="kpi-val ${txMB>=30?'pos':txMB>=10?'':'neg'}" id="kpi-mb">${fmtE(mb)}</div>
          <div class="kpi-sub" id="kpi-mb-sub">${txMB.toFixed(1)}% du PV</div>
        </div>
        <div class="kpi-box ${txMN>=20?'green':txMN>=5?'orange':'red'}" id="kpi-box-mn">
          <div class="kpi-label">Marge nette <span style="font-size:9px;background:#dcfce7;color:#166534;padding:1px 5px;border-radius:4px;font-weight:700">HT</span></div>
          <div class="kpi-val ${txMN>=20?'pos':txMN>=5?'':'neg'}" id="kpi-mn">${fmtE(mn)}</div>
          <div class="kpi-sub" id="kpi-mn-sub">${txMN.toFixed(1)}% du PV</div>
        </div>
        <div class="kpi-box">
          <div class="kpi-label">CoÃ»ts variables <span style="font-size:9px;background:#fef9c3;color:#854d0e;padding:1px 5px;border-radius:4px;font-weight:700">HT</span></div>
          <div class="kpi-val" id="kpi-cv">${fmtE(cv)}</div>
          <div class="kpi-sub">${p.pv>0?(cv/p.pv*100).toFixed(1)+'% du PV':'â€”'}</div>
        </div>
        <div class="kpi-box purple" id="kpi-box-cf">
          <div class="kpi-label">CF imputÃ©es <span style="font-size:9px;background:#f3e8ff;color:#6b21a8;padding:1px 5px;border-radius:4px;font-weight:700">HT</span></div>
          <div class="kpi-val" id="kpi-cf">${fmtE(cfImpute)}</div>
          <div class="kpi-sub">Par unitÃ© (clÃ© rÃ©part.)</div>
        </div>
      </div>
    </div>

    <!-- DÃ‰COMPOSITION -->
    <div class="decomp-grid">
      <div class="decomp-card">
        <div class="decomp-head">
          <div class="decomp-title">ğŸŸ¢ Marge Brute <span style="font-size:10px;color:var(--muted);font-weight:400;margin-left:4px">= PV âˆ’ CoÃ»ts variables</span></div>
          <div class="decomp-total ${txMB>=30?'':''}"> ${fmtE(mb)} <span style="font-size:11px;color:var(--muted)">(${txMB.toFixed(1)}%)</span></div>
        </div>
        <div class="decomp-body">
          ${renderDecompRow('Prix de vente HT','#1a3dce',p.pv,p.pv,true)}
          ${renderDecompRow('MatiÃ¨res premiÃ¨res','#ef4444',p.mp||0,p.pv,false)}
          ${renderDecompRow('Main d\'Å“uvre','#f59e0b',p.mo||0,p.pv,false)}
          ${renderDecompRow('Emballages','#14b8a6',p.emb||0,p.pv,false)}
          ${renderDecompRow('Livraison','#8b5cf6',p.liv||0,p.pv,false)}
          <div style="margin-top:12px;padding-top:10px;border-top:2px solid var(--border);display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:12px;font-weight:700">= Marge brute</span>
            <span style="font-size:16px;font-weight:800;color:${txMB>=30?'var(--green)':txMB>=10?'var(--orange)':'var(--red)'}">${fmtE(mb)} <span style="font-size:12px">(${txMB.toFixed(1)}%)</span></span>
          </div>
        </div>
      </div>
      <div class="decomp-card">
        <div class="decomp-head">
          <div class="decomp-title">ğŸ”µ Marge Nette <span style="font-size:10px;color:var(--muted);font-weight:400;margin-left:4px">= MB âˆ’ Charges fixes imputÃ©es</span></div>
          <div class="decomp-total">${fmtE(mn)} <span style="font-size:11px;color:var(--muted)">(${txMN.toFixed(1)}%)</span></div>
        </div>
        <div class="decomp-body">
          ${renderDecompRow('Marge brute','#10b981',mb,p.pv,true)}
          ${renderDecompRow('Charges fixes imputÃ©es','#6366f1',cfImpute,p.pv,false)}
          <div style="margin-top:8px;padding:8px 10px;background:var(--purple-light);border-radius:8px;font-size:11px;color:var(--purple)">
            ğŸ”‘ ClÃ© : <b>${cl[0]}</b> Â· Produit : <b>${cle.produit||'?'}</b> / Total : <b>${cle.total||'?'}</b> = <b>${cle.total>0?((parseFloat(cle.produit)||0)/(parseFloat(cle.total)||1)*100).toFixed(1)+'%':'â€”'}</b>
          </div>
          <div style="margin-top:12px;padding-top:10px;border-top:2px solid var(--border);display:flex;justify-content:space-between;align-items:center">
            <span style="font-size:12px;font-weight:700">= Marge nette</span>
            <span style="font-size:16px;font-weight:800;color:${txMN>=20?'var(--green)':txMN>=5?'var(--orange)':'var(--red)'}">${fmtE(mn)} <span style="font-size:12px">(${txMN.toFixed(1)}%)</span></span>
          </div>
        </div>
      </div>
    </div>

    <!-- BARRE VISUELLE -->
    <div class="marge-viz">
      <div class="viz-title">ğŸ“Š DÃ©composition visuelle du prix de vente</div>
      <div class="viz-bar-wrap">
        <div class="viz-bar">
          ${p.pv>0?`
          <div class="viz-seg" style="width:${((p.mp||0)/p.pv*100).toFixed(1)}%;background:#ef4444" title="MP">${(p.mp||0)/p.pv>0.05?'MP':''}</div>
          <div class="viz-seg" style="width:${((p.mo||0)/p.pv*100).toFixed(1)}%;background:#f59e0b" title="MO">${(p.mo||0)/p.pv>0.05?'MO':''}</div>
          <div class="viz-seg" style="width:${((p.emb||0)/p.pv*100).toFixed(1)}%;background:#14b8a6" title="Emb.">${(p.emb||0)/p.pv>0.05?'Emb.':''}</div>
          <div class="viz-seg" style="width:${((p.liv||0)/p.pv*100).toFixed(1)}%;background:#8b5cf6" title="Liv.">${(p.liv||0)/p.pv>0.05?'Liv.':''}</div>
          <div class="viz-seg" style="width:${(cfImpute/p.pv*100).toFixed(1)}%;background:#6366f1" title="CF">CF</div>
          <div class="viz-seg" style="flex:1;background:${mn>=0?'#10b981':'#ef4444'}" title="Marge nette">${mn>=0?'âœ“ Marge':'Perte'}</div>
          `:'<div class="viz-seg" style="flex:1;background:#e2e8f0;color:var(--muted)">Saisissez un prix de vente</div>'}
        </div>
      </div>
      <div class="viz-legend">
        <div class="viz-leg-item"><div class="viz-leg-dot" style="background:#ef4444"></div>MatiÃ¨res premiÃ¨res</div>
        <div class="viz-leg-item"><div class="viz-leg-dot" style="background:#f59e0b"></div>Main d'Å“uvre</div>
        <div class="viz-leg-item"><div class="viz-leg-dot" style="background:#14b8a6"></div>Emballages</div>
        <div class="viz-leg-item"><div class="viz-leg-dot" style="background:#8b5cf6"></div>Livraison</div>
        <div class="viz-leg-item"><div class="viz-leg-dot" style="background:#6366f1"></div>Charges fixes</div>
        <div class="viz-leg-item"><div class="viz-leg-dot" style="background:#10b981"></div>Marge nette</div>
      </div>
    </div>

    <!-- CAMEMBERT -->
    <div class="marge-viz" style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:center">
      <div>
        <div class="viz-title">ğŸ¥§ RÃ©partition du prix de vente</div>
        <div style="position:relative;height:200px"><canvas id="chartCamembert"></canvas></div>
      </div>
      <div>
        <div class="viz-title" style="margin-bottom:12px">ğŸ“‹ DÃ©tail par poste</div>
        <div id="camembert-legend" style="display:flex;flex-direction:column;gap:8px"></div>
      </div>
    </div>

    <!-- CLÃ‰ DE RÃ‰PARTITION -->
    <div class="cle-card">
      <div class="cle-title">ğŸ”‘ ClÃ© de rÃ©partition des charges fixes <span style="font-size:11px;font-weight:400;color:var(--muted)">â€” Comment allouer les charges fixes Ã  ce produit ?</span></div>
      <div class="cle-grid">
        ${['temps','superficie','volume','ca'].map(k=>`
          <button class="cle-btn ${(p.cle||{type:'temps'}).type===k?'active':''}" onclick="setCle('${p.id}','${k}',this)">
            <div class="cle-icon">${{temps:'â±',superficie:'ğŸ“',volume:'ğŸ“¦',ca:'ğŸ’°'}[k]}</div>
            <div class="cle-label">${{temps:'Temps',superficie:'Superficie',volume:'Volume',ca:'CA'}[k]}</div>
          </button>`).join('')}
      </div>
      <div class="cle-inputs">
        <div class="cle-field">
          <label>${cl[1]}</label>
          <input class="cle-input" type="number" id="cle-produit" placeholder="Ex: 120" value="${cle.produit||''}" oninput="updateCle('${p.id}','produit',this.value)"/>
        </div>
        <div class="cle-field">
          <label>${cl[2]}</label>
          <input class="cle-input" type="number" id="cle-total" placeholder="Ex: 800" value="${cle.total||''}" oninput="updateCle('${p.id}','total',this.value)"/>
        </div>
        <div class="cle-field">
          <label>Total charges fixes (â‚¬)</label>
          <input class="cle-input" type="number" id="cle-cf" placeholder="Ex: 5000" value="${p.cfTotal||''}" oninput="updateCleTotal('${p.id}',this.value)"/>
        </div>
      </div>
      <div class="cle-result" id="cle-result">
        ${cle.total>0&&cle.produit>0?`âœ… Quote-part : <b>${((parseFloat(cle.produit)||0)/(parseFloat(cle.total)||1)*100).toFixed(1)}%</b> â†’ <b>${fmtE(cfImpute)}</b> de charges fixes imputÃ©es par unitÃ©`:'âš ï¸ Renseignez les valeurs pour calculer la quote-part de charges fixes'}
      </div>
    </div>

    <!-- SIMULATEUR -->
    <div class="sim-card">
      <div class="sim-head">
        <div class="sim-title">ğŸ”® Simulateur de scÃ©narios <span style="font-size:11px;opacity:0.7;font-weight:400">â€” Testez l'impact sur vos marges</span></div>
        <button class="btn btn-sm" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.3)" onclick="resetSim('${p.id}')">â†º RÃ©initialiser</button>
      </div>
      <div class="sim-body">
        <div class="sim-levers">

          <!-- LEVER PV -->
          <div class="sim-lever">
            <div class="sim-lever-label">ğŸ’° Prix de vente <span class="sim-lever-tag">HT</span></div>
            <div class="sim-fields-row">
              <div class="sim-field-group">
                <div class="sim-field-lbl">Nouveau prix HT</div>
                <div class="sim-field-wrap">
                  <input type="number" class="sim-field-input" id="sn-pv-eur" min="0" step="0.1" value="${p.pv>0?p.pv:''}" oninput="updateSimEur('${p.id}','pv',this.value,${p.pv})" onchange="updateSimEur('${p.id}','pv',this.value,${p.pv})" placeholder="${p.pv||'0'}"/>
                  <span class="sim-field-unit">â‚¬</span>
                </div>
              </div>
              <div class="sim-sep">ou</div>
              <div class="sim-field-group">
                <div class="sim-field-lbl">Augmentation</div>
                <div class="sim-field-wrap">
                  <input type="number" class="sim-field-input" id="sn-pv" min="0" max="100" step="1" value="${parseFloat(sim.pv)||0}" oninput="updateSimNum('${p.id}','pv',this.value)" onchange="updateSimNum('${p.id}','pv',this.value)" placeholder="0"/>
                  <span class="sim-field-unit">%</span>
                </div>
              </div>
            </div>
            <div class="sim-slider-wrap">
              <input type="range" class="sim-slider" id="sr-pv" min="0" max="100" step="1" value="${parseFloat(sim.pv)||0}" oninput="updateSim('${p.id}','pv',this.value)"/>
              <div class="sim-range-labels"><span>0%</span><span>+100%</span></div>
            </div>
          </div>

          <!-- LEVER MP -->
          <div class="sim-lever">
            <div class="sim-lever-label">ğŸ§ª MatiÃ¨res premiÃ¨res <span class="sim-lever-tag">HT</span></div>
            <div class="sim-fields-row">
              <div class="sim-field-group">
                <div class="sim-field-lbl">Nouveau coÃ»t HT</div>
                <div class="sim-field-wrap">
                  <input type="number" class="sim-field-input" id="sn-mp-eur" min="0" step="0.01" value="${p.mp>0?p.mp:''}" oninput="updateSimEur('${p.id}','mp',this.value,${p.mp||0})" onchange="updateSimEur('${p.id}','mp',this.value,${p.mp||0})" placeholder="${p.mp||'0'}"/>
                  <span class="sim-field-unit">â‚¬</span>
                </div>
              </div>
              <div class="sim-sep">ou</div>
              <div class="sim-field-group">
                <div class="sim-field-lbl">RÃ©duction</div>
                <div class="sim-field-wrap">
                  <input type="number" class="sim-field-input" id="sn-mp" min="0" max="100" step="1" value="${parseFloat(sim.mp)||0}" oninput="updateSimNum('${p.id}','mp',this.value)" onchange="updateSimNum('${p.id}','mp',this.value)" placeholder="0"/>
                  <span class="sim-field-unit">%</span>
                </div>
              </div>
            </div>
            <div class="sim-slider-wrap">
              <input type="range" class="sim-slider" id="sr-mp" min="0" max="100" step="1" value="${parseFloat(sim.mp)||0}" oninput="updateSim('${p.id}','mp',this.value)"/>
              <div class="sim-range-labels"><span>0%</span><span>âˆ’100%</span></div>
            </div>
          </div>

          <!-- LEVER MO -->
          <div class="sim-lever">
            <div class="sim-lever-label">ğŸ‘· Main d'Å“uvre <span class="sim-lever-tag">HT</span></div>
            <div class="sim-fields-row">
              <div class="sim-field-group">
                <div class="sim-field-lbl">Nouveau coÃ»t HT</div>
                <div class="sim-field-wrap">
                  <input type="number" class="sim-field-input" id="sn-mo-eur" min="0" step="0.01" value="${p.mo>0?p.mo:''}" oninput="updateSimEur('${p.id}','mo',this.value,${p.mo||0})" onchange="updateSimEur('${p.id}','mo',this.value,${p.mo||0})" placeholder="${p.mo||'0'}"/>
                  <span class="sim-field-unit">â‚¬</span>
                </div>
              </div>
              <div class="sim-sep">ou</div>
              <div class="sim-field-group">
                <div class="sim-field-lbl">RÃ©duction</div>
                <div class="sim-field-wrap">
                  <input type="number" class="sim-field-input" id="sn-mo" min="0" max="100" step="1" value="${parseFloat(sim.mo)||0}" oninput="updateSimNum('${p.id}','mo',this.value)" onchange="updateSimNum('${p.id}','mo',this.value)" placeholder="0"/>
                  <span class="sim-field-unit">%</span>
                </div>
              </div>
            </div>
            <div class="sim-slider-wrap">
              <input type="range" class="sim-slider" id="sr-mo" min="0" max="100" step="1" value="${parseFloat(sim.mo)||0}" oninput="updateSim('${p.id}','mo',this.value)"/>
              <div class="sim-range-labels"><span>0%</span><span>âˆ’100%</span></div>
            </div>
          </div>

          <!-- LEVER CF -->
          <div class="sim-lever">
            <div class="sim-lever-label">ğŸ—ï¸ Charges fixes <span class="sim-lever-tag">HT</span></div>
            <div class="sim-fields-row">
              <div class="sim-field-group">
                <div class="sim-field-lbl">Nouveau total HT</div>
                <div class="sim-field-wrap">
                  <input type="number" class="sim-field-input" id="sn-cf-eur" min="0" step="1" value="${p.cfTotal>0?p.cfTotal:''}" oninput="updateSimEur('${p.id}','cf',this.value,${p.cfTotal||0})" onchange="updateSimEur('${p.id}','cf',this.value,${p.cfTotal||0})" placeholder="${p.cfTotal||'0'}"/>
                  <span class="sim-field-unit">â‚¬</span>
                </div>
              </div>
              <div class="sim-sep">ou</div>
              <div class="sim-field-group">
                <div class="sim-field-lbl">RÃ©duction</div>
                <div class="sim-field-wrap">
                  <input type="number" class="sim-field-input" id="sn-cf" min="0" max="100" step="1" value="${parseFloat(sim.cf)||0}" oninput="updateSimNum('${p.id}','cf',this.value)" onchange="updateSimNum('${p.id}','cf',this.value)" placeholder="0"/>
                  <span class="sim-field-unit">%</span>
                </div>
              </div>
            </div>
            <div class="sim-slider-wrap">
              <input type="range" class="sim-slider" id="sr-cf" min="0" max="100" step="1" value="${parseFloat(sim.cf)||0}" oninput="updateSim('${p.id}','cf',this.value)"/>
              <div class="sim-range-labels"><span>0%</span><span>âˆ’100%</span></div>
            </div>
          </div>

        </div>

        <!-- LEVER VOLUME -->
        <div class="sim-lever-full">
          <div class="sim-lever-label">ğŸ“ˆ Volume de ventes (unitÃ©s / pÃ©riode) <span class="sim-lever-tag">HT</span></div>
          <div class="sim-fields-row" style="margin-bottom:10px">
            <div class="sim-field-group">
              <div class="sim-field-lbl">Nombre d'unitÃ©s</div>
              <div class="sim-field-wrap" style="min-width:100px">
                <input type="number" class="sim-field-input" style="width:70px" id="sn-vol" min="1" step="1" value="${parseFloat(sim.vol)||parseFloat(p.qte)||1}" oninput="updateSimNum('${p.id}','vol',this.value)" onchange="updateSimNum('${p.id}','vol',this.value)" placeholder="1"/>
                <span class="sim-field-unit">unitÃ©s</span>
              </div>
            </div>
            <div style="flex:1;margin-top:18px">
              <input type="range" class="sim-slider" id="sr-vol" min="1" max="${Math.max((parseFloat(p.qte)||1)*10,500)}" step="1" value="${parseFloat(sim.vol)||parseFloat(p.qte)||1}" oninput="updateSim('${p.id}','vol',this.value)" style="width:100%"/>
              <div class="sim-range-labels"><span>1</span><span>${Math.max((parseFloat(p.qte)||1)*10,500)} unitÃ©s</span></div>
            </div>
          </div>
        </div>

        <!-- RÃ‰SULTAT SIMULATION -->
        <div class="sim-result">
          <div class="sim-result-title">ğŸ“Š RÃ©sultat simulÃ© vs situation actuelle</div>
          <div class="sim-result-grid" id="sim-result-grid">${renderSimResult(p,s,calcMN(p))}</div>
        </div>

        <!-- TABLEAU COMPARATIF -->
        <div style="margin-top:16px;border:1px solid rgba(255,255,255,0.1);border-radius:10px;overflow:hidden">
          <table class="comp-table" id="comp-table">${renderCompTable(p,s,calcMN(p))}</table>
        </div>
      </div>
    </div>

    <!-- SAUVEGARDE -->
    <div style="display:flex;justify-content:flex-end;gap:10px;padding-bottom:20px">
      <button class="btn btn-success" onclick="saveProduct('${p.id}')">ğŸ’¾ Sauvegarder les paramÃ¨tres</button>
    </div>
  `;
  // Render camembert aprÃ¨s injection DOM
  const {cfImpute:_cfi,mn:_mn}=calcMN(p);
  setTimeout(()=>renderCamembert(p,_cfi,_mn),50);
}

function renderDecompRow(label,color,val,pv,isRevenu){
  const pct = pv>0?(val/pv*100).toFixed(1):0;
  return `<div class="decomp-row">
    <div class="decomp-label"><span class="decomp-dot" style="background:${color}"></span>${label}</div>
    <div class="decomp-val" style="color:${isRevenu?'var(--green)':'var(--red)'}">
      ${isRevenu?'+':'-'}${fmtE(val)} <span class="decomp-pct">(${pct}%)</span>
    </div>
  </div>
  <div class="decomp-bar-wrap"><div class="decomp-bar-fill" style="width:${Math.min(pct,100)}%;background:${color}"></div></div>`;
}

function renderSimResult(p,s,cur){
  const items=[
    {label:'Prix vente HT', cur:p.pv, sim:s.pvSim},
    {label:'Marge brute', cur:cur.mb, sim:s.mbSim, pct:true, curPct:cur.txMB, simPct:s.txMBSim},
    {label:'Marge nette', cur:cur.mn, sim:s.mnSim, pct:true, curPct:cur.txMN, simPct:s.txMNSim},
    {label:'Marge brute totale', cur:cur.mb*(parseFloat(p.qte)||1), sim:s.margeTotSim},
    {label:'Marge nette totale', cur:cur.mn*(parseFloat(p.qte)||1), sim:s.margeNetTotSim},
  ];
  return items.map(item=>{
    const delta=item.sim-item.cur;
    const deltaPos=delta>=0;
    // Couleur valeur simulÃ©e : vert si positif, rouge si nÃ©gatif (valeur absolue)
    const simPos=item.sim>=0;
    const simCls=simPos?'pos':'neg';
    const fmt=item.pct?(v=>`${fmtE(v)} (${item.simPct!==undefined?item.simPct.toFixed(1):0}%)`):fmtE;
    return `<div class="sim-res-box">
      <div class="sim-res-label">${item.label}</div>
      <div class="sim-res-current" style="color:${item.cur>=0?'rgba(255,255,255,0.5)':'#f87171'}">${fmtE(item.cur)}${item.pct?` (${item.curPct!==undefined?item.curPct.toFixed(1):0}%)`:''}
      </div>
      <div class="sim-res-new ${simCls}">${fmtE(item.sim)}${item.pct?` (${item.simPct!==undefined?item.simPct.toFixed(1):0}%)`:''}
      </div>
      <div class="sim-res-delta ${deltaPos?'pos':'neg'}">${deltaPos?'â–²':'â–¼'} ${fmtE(Math.abs(delta))}</div>
    </div>`;
  }).join('');
}

function renderCompTable(p,s,cur){
  const qte=parseFloat(p.qte)||1;
  return `<thead><tr>
    <th>Indicateur</th><th>Situation actuelle</th><th>Simulation</th><th>Ã‰cart</th><th>Ã‰volution</th>
  </tr></thead>
  <tbody>
    ${compRow('Prix de vente HT',p.pv,s.pvSim)}
    ${compRow('CoÃ»ts variables',cur.cv,s.cvSim,true)}
    ${compRow('Marge brute / unitÃ©',cur.mb,s.mbSim)}
    ${compRow('Taux marge brute',cur.txMB,s.txMBSim,false,true)}
    ${compRow('Charges fixes imputÃ©es',cur.cfImpute,s.cfImputeSim,true)}
    ${compRow('Marge nette / unitÃ©',cur.mn,s.mnSim)}
    ${compRow('Taux marge nette',cur.txMN,s.txMNSim,false,true)}
    ${compRow('Marge totale (Ã—'+s.volSim+'u)',cur.mb*qte,s.margeTotSim)}
    ${compRow('Marge nette totale',cur.mn*qte,s.margeNetTotSim)}
  </tbody>`;
}

function compRow(label,cur,sim,inversed=false,isPct=false){
  const delta=sim-cur;
  const deltaGood=inversed?(delta<=0):(delta>=0);
  const simNeg=sim<0;
  const fmt=isPct?(v=>v.toFixed(1)+'%'):fmtE;
  // Couleur valeur sim : rouge si valeur nÃ©gative OU si delta mauvais
  const simCls=simNeg?'td-neg':(deltaGood?'td-pos':'td-neg');
  const curCls=cur<0?'td-neg':'';
  return `<tr>
    <td style="font-weight:600">${label}</td>
    <td class="${curCls}">${fmt(cur)}</td>
    <td class="${simCls}">${fmt(sim)}</td>
    <td class="${deltaGood?'td-pos':'td-neg'}">${delta>=0?'+':''}${fmt(delta)}</td>
    <td class="${deltaGood?'td-arrow-pos':'td-arrow-neg'}">${deltaGood?'â–² Mieux':'â–¼ Moins bien'}</td>
  </tr>`;
}

// â”€â”€ ACTIONS CLÃ‰ â”€â”€
function setCle(id,type,btn){
  if(!_products[id])return;
  if(!_products[id].cle)_products[id].cle={type,produit:0,total:0};
  _products[id].cle.type=type;
  document.querySelectorAll('.cle-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  const labels={temps:['â± Temps','Heures ce produit','Heures totales prod.'],superficie:['ğŸ“ Superficie','mÂ² utilisÃ©s','mÂ² total atelier'],volume:['ğŸ“¦ Volume','UnitÃ©s produit','UnitÃ©s totales'],ca:['ğŸ’° CA','CA ce produit (â‚¬)','CA total (â‚¬)']};
  const cl=labels[type];
  const inputs=document.querySelectorAll('.cle-field label');
  if(inputs[0])inputs[0].textContent=cl[1];
  if(inputs[1])inputs[1].textContent=cl[2];
  refreshMarge(id);
}

function updateCle(id,field,value){
  if(!_products[id])return;
  if(!_products[id].cle)_products[id].cle={type:'temps',produit:0,total:0};
  _products[id].cle[field]=parseFloat(value)||0;
  refreshMarge(id);
}

function updateCleTotal(id,value){
  if(!_products[id])return;
  _products[id].cfTotal=parseFloat(value)||0;
  refreshMarge(id);
}

function refreshMarge(id){
  const p=_products[id];
  const {cv,mb,txMB,cfImpute,mn,txMN}=calcMN(p);
  const sim=p.sim||{pv:0,mp:0,mo:0,cf:0,vol:parseFloat(p.qte)||1};
  const s=calcSim(p,sim);
  const cle=p.cle||{type:'temps',produit:0,total:0};

  // â”€â”€ MISE Ã€ JOUR KPI BOXES DU HAUT â”€â”€
  const set=(eid,val)=>{const el=document.getElementById(eid);if(el)el.textContent=val;};
  const setCls=(eid,...cls)=>{const el=document.getElementById(eid);if(el){el.className=el.className.replace(/\b(pos|neg)\b/g,'');if(cls[0])el.classList.add(cls[0]);}};

  set('kpi-mn', fmtE(mn));
  set('kpi-mn-sub', txMN.toFixed(1)+'% du PV');
  set('kpi-cf', fmtE(cfImpute));
  set('kpi-mb', fmtE(mb));
  set('kpi-mb-sub', txMB.toFixed(1)+'% du PV');
  set('kpi-cv', fmtE(cv));

  // Couleur marge nette
  const boxMN=document.getElementById('kpi-box-mn');
  if(boxMN){boxMN.className='kpi-box '+(txMN>=20?'green':txMN>=5?'orange':'red');}
  const valMN=document.getElementById('kpi-mn');
  if(valMN){valMN.className='kpi-val '+(txMN>=20?'pos':txMN>=5?'':'neg');}

  // Couleur marge brute
  const boxMB=document.getElementById('kpi-box-mb');
  if(boxMB){boxMB.className='kpi-box '+(txMB>=30?'green':txMB>=10?'orange':'red');}
  const valMB=document.getElementById('kpi-mb');
  if(valMB){valMB.className='kpi-val '+(txMB>=30?'pos':txMB>=10?'':'neg');}

  // Re-render simulateur + table
  const srg=document.getElementById('sim-result-grid');
  if(srg)srg.innerHTML=renderSimResult(p,s,{mb,txMB,mn,txMN,cfImpute});
  const ct=document.getElementById('comp-table');
  if(ct)ct.innerHTML=renderCompTable(p,s,{cv,mb,txMB,cfImpute,mn,txMN});

  // Update clÃ© result
  const cr=document.getElementById('cle-result');
  if(cr)cr.innerHTML=cle.total>0&&cle.produit>0?
    `âœ… Quote-part : <b>${((parseFloat(cle.produit)||0)/(parseFloat(cle.total)||1)*100).toFixed(1)}%</b> â†’ <b>${fmtE(cfImpute)}</b> de charges fixes imputÃ©es par unitÃ©`:
    'âš ï¸ Renseignez les valeurs pour calculer la quote-part de charges fixes';

  // Mise Ã  jour camembert
  setTimeout(()=>renderCamembert(p,cfImpute,mn),20);
}

// â”€â”€ SIMULATEUR â”€â”€
function updateSim(id,lever,value){
  if(!_products[id])return;
  if(!_products[id].sim)_products[id].sim={pv:0,mp:0,mo:0,cf:0,vol:parseFloat(_products[id].qte)||1};
  _products[id].sim[lever]=parseFloat(value)||0;
  // Sync input numÃ©rique
  const numInput=document.getElementById('sn-'+lever);
  if(numInput)numInput.value=parseFloat(value)||0;
  const p=_products[id];
  const sim=p.sim;
  const s=calcSim(p,sim);
  const cur=calcMN(p);
  const srg=document.getElementById('sim-result-grid');
  if(srg)srg.innerHTML=renderSimResult(p,s,cur);
  const ct=document.getElementById('comp-table');
  if(ct)ct.innerHTML=renderCompTable(p,s,cur);
}

function resetSim(id){
  if(!_products[id])return;
  _products[id].sim={pv:0,mp:0,mo:0,cf:0,vol:parseFloat(_products[id].qte)||1};
  ['pv','mp','mo','cf'].forEach(k=>{
    const sr=document.getElementById(`sr-${k}`);const sl=document.getElementById(`sl-${k}`);
    if(sr)sr.value=0;
    if(sl)sl.textContent=k==='pv'?'+0%':'âˆ’0%';
  });
  const svol=document.getElementById('sr-vol');const slvol=document.getElementById('sl-vol');
  const qte=parseFloat(_products[id].qte)||1;
  if(svol)svol.value=qte;if(slvol)slvol.textContent=`${qte} unitÃ©s`;
  const s=calcSim(_products[id],_products[id].sim);
  const cur=calcMN(_products[id]);
  const srg=document.getElementById('sim-result-grid');
  if(srg)srg.innerHTML=renderSimResult(_products[id],s,cur);
  const ct=document.getElementById('comp-table');
  if(ct)ct.innerHTML=renderCompTable(_products[id],s,cur);
}

// â”€â”€ SAVE / DELETE â”€â”€
async function saveProduct(id){
  if(!window._uid)return;
  const p=_products[id];
  if(p.source==='cout-revient'){
    // Sauvegarder les paramÃ¨tres marge (cle, sim) sÃ©parÃ©ment
    try{
      await window._setDoc(window._doc(window._db,'marges',window._uid,'params',id),{cle:p.cle||{},sim:p.sim||{}});
      showToast('âœ… ParamÃ¨tres sauvegardÃ©s !','success');
    }catch(e){showToast('Erreur','warning');console.error(e);}
  } else {
    try{
      await window._setDoc(window._doc(window._db,'marges',window._uid,'produits',id.replace('mg_','')),p);
      showToast('âœ… Produit sauvegardÃ© !','success');
    }catch(e){showToast('Erreur','warning');console.error(e);}
  }
}

async function deleteProduct(id){
  if(!confirm('Supprimer ce produit ?'))return;
  try{
    if(_products[id].source==='marges')
      await window._deleteDoc(window._doc(window._db,'marges',window._uid,'produits',id.replace('mg_','')));
    delete _products[id];
    _currentId=null;
    renderList();
    document.getElementById('rightPanel').innerHTML=`<div class="empty-state"><div class="empty-icon">ğŸ—‘</div><h3 style="font-size:16px;font-weight:700;color:var(--text)">Produit supprimÃ©</h3></div>`;
  }catch(e){console.error(e);}
}

// â”€â”€ MODAL â”€â”€
function openNewProductModal(){document.getElementById('newProductModal').classList.add('show');}
function closeModal(){document.getElementById('newProductModal').classList.remove('show');}

function createProduct(){
  const nom=document.getElementById('mn-nom').value.trim();
  if(!nom){document.getElementById('mn-nom').focus();return;}
  const id='mg_prod_'+Date.now();
  _products[id]={
    id,source:'marges',
    nom, categorie:document.getElementById('mn-cat').value,
    emoji:document.getElementById('mn-emoji').value||'ğŸ“¦',
    pv:parseFloat(document.getElementById('mn-pv').value)||0,
    qte:parseFloat(document.getElementById('mn-qte').value)||1,
    mp:parseFloat(document.getElementById('mn-mp').value)||0,
    mo:parseFloat(document.getElementById('mn-mo').value)||0,
    emb:parseFloat(document.getElementById('mn-emb').value)||0,
    liv:parseFloat(document.getElementById('mn-liv').value)||0,
    cfTotal:parseFloat(document.getElementById('mn-cf').value)||0,
    cle:{type:'temps',produit:0,total:0},
    sim:{pv:0,mp:0,mo:0,cf:0,vol:parseFloat(document.getElementById('mn-qte').value)||1}
  };
  closeModal();
  renderList();
  openProduct(id);
}

function editProduct(id){openNewProductModal();}

// â”€â”€ UTILS â”€â”€
function fmtE(n){return (parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' â‚¬';}
function showToast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(()=>t.className='toast',3200);}

// â”€â”€ SYNC INPUT NUMÃ‰RIQUE â†’ SLIDER â”€â”€
function updateSimNum(id, lever, value){
  const v = Math.max(0, parseFloat(value)||0);
  const sr = document.getElementById('sr-'+lever);
  if(sr) sr.value = v;
  // Sync input â‚¬ si existe
  const p = _products[id];
  if(p && lever !== 'vol'){
    const baseVals = {pv: parseFloat(p.pv)||0, mp: parseFloat(p.mp)||0, mo: parseFloat(p.mo)||0, cf: parseFloat(p.cfTotal)||0};
    const base = baseVals[lever]||0;
    const eurInput = document.getElementById('sn-'+lever+'-eur');
    if(eurInput && base > 0){
      const mult = lever==='pv' ? (1+v/100) : (1-v/100);
      eurInput.value = (base * mult).toFixed(2);
    }
  }
  updateSim(id, lever, v);
}

// â”€â”€ SAISIE EN EUROS â†’ calcule le % â”€â”€
function updateSimEur(id, lever, eurValue, baseValue){
  const eur = parseFloat(eurValue)||0;
  const base = parseFloat(baseValue)||0;
  if(base <= 0) return;
  let pct = 0;
  if(lever === 'pv') pct = Math.max(0, (eur - base) / base * 100);
  else pct = Math.max(0, (base - eur) / base * 100);
  pct = Math.min(pct, 100);
  // Sync slider + input %
  const sr = document.getElementById('sr-'+lever);
  const sn = document.getElementById('sn-'+lever);
  if(sr) sr.value = pct.toFixed(1);
  if(sn) sn.value = pct.toFixed(1);
  updateSim(id, lever, pct);
}

// â”€â”€ CAMEMBERT â”€â”€
let _chartCamembert = null;
function renderCamembert(p, cfImpute, mn){
  const ctx = document.getElementById('chartCamembert');
  if(!ctx) return;
  if(_chartCamembert){ try{_chartCamembert.destroy();}catch(e){} }

  const data = [
    {label:'MatiÃ¨res premiÃ¨res', val:parseFloat(p.mp)||0, color:'#ef4444'},
    {label:"Main d'Å“uvre",       val:parseFloat(p.mo)||0, color:'#f59e0b'},
    {label:'Emballages',         val:parseFloat(p.emb)||0, color:'#14b8a6'},
    {label:'Livraison',          val:parseFloat(p.liv)||0, color:'#8b5cf6'},
    {label:'Charges fixes',      val:cfImpute||0,          color:'#6366f1'},
    {label:'Marge nette',        val:Math.max(mn,0)||0,    color:'#10b981'},
  ].filter(d=>d.val>0);

  const pv = parseFloat(p.pv)||1;
  _chartCamembert = new Chart(ctx, {
    type:'doughnut',
    data:{
      labels: data.map(d=>d.label),
      datasets:[{
        data: data.map(d=>d.val),
        backgroundColor: data.map(d=>d.color),
        borderWidth:2, borderColor:'white', hoverOffset:6
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      cutout:'60%',
      plugins:{
        legend:{display:false},
        tooltip:{callbacks:{label:ctx=>{
          const v=ctx.raw;
          const pct=(v/pv*100).toFixed(1);
          return ` ${fmtE(v)} (${pct}%)`;
        }}}
      }
    }
  });

  // LÃ©gende custom
  const leg = document.getElementById('camembert-legend');
  if(leg) leg.innerHTML = data.map(d=>{
    const pct=(d.val/pv*100).toFixed(1);
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:5px 8px;border-radius:6px;background:#f8faff">
      <div style="display:flex;align-items:center;gap:8px">
        <div style="width:10px;height:10px;border-radius:3px;background:${d.color};flex-shrink:0"></div>
        <span style="font-size:12px;color:var(--text)">${d.label}</span>
      </div>
      <span style="font-size:12px;font-weight:700;color:var(--text)">${fmtE(d.val)} <span style="font-size:10px;color:var(--muted)">(${pct}%)</span></span>
    </div>`;
  }).join('');
}

window.toggleMenu=toggleMenu;window.handleLogout=handleLogout;
window.openProduct=openProduct;window.filterProducts=filterProducts;
window.openNewProductModal=openNewProductModal;window.closeModal=closeModal;
window.createProduct=createProduct;window.editProduct=editProduct;window.deleteProduct=deleteProduct;
window.setCle=setCle;window.updateCle=updateCle;window.updateCleTotal=updateCleTotal;
window.updateSim=updateSim;window.updateSimNum=updateSimNum;window.updateSimEur=updateSimEur;window.resetSim=resetSim;window.saveProduct=saveProduct;
</script>

<script>
function toggleNav(subId, el) {
  const sub = document.getElementById(subId);
  const isOpen = sub.classList.contains('open');
  sub.classList.toggle('open');
  // rotate chevron
  const chevId = subId === 'kpis-sub' ? 'chev-kpis' : 'chev-pil';
  const chev = document.getElementById(chevId);
  if (chev) chev.style.transform = isOpen ? '' : 'rotate(90deg)';
}
function activatePage(pageId, openSub) {
  const el = document.getElementById(pageId);
  if (el) el.classList.add('on');
  if (openSub) {
    const sub = document.getElementById(openSub);
    if (sub) sub.classList.add('open');
    const chevId = openSub === 'kpis-sub' ? 'chev-kpis' : 'chev-pil';
    const chev = document.getElementById(chevId);
    if (chev) chev.style.transform = 'rotate(90deg)';
  }
}
</script>
<script>document.addEventListener('DOMContentLoaded',()=>activatePage('nav-marges','kpis-sub'));</script>



<script>
(function(){
  function toggleSidebar(){
    var nav = document.querySelector('nav, aside.sidebar, .sidebar');
    var btn = document.getElementById('hamburger');
    var overlay = document.getElementById('navOverlay');
    var isOpen = nav.classList.contains('open');
    if(isOpen){ closeSidebar(); return; }
    nav.classList.add('open');
    btn.classList.add('open');
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
  function closeSidebar(){
    var nav = document.querySelector('nav, aside.sidebar, .sidebar');
    var btn = document.getElementById('hamburger');
    var overlay = document.getElementById('navOverlay');
    nav.classList.remove('open');
    btn.classList.remove('open');
    overlay.classList.remove('show');
    document.body.style.overflow = '';
  }
  window.toggleSidebar = toggleSidebar;
  window.closeSidebar = closeSidebar;
  document.addEventListener('DOMContentLoaded', function(){
    var nav = document.querySelector('nav, aside.sidebar, .sidebar');
    if(!nav) return;
    nav.querySelectorAll('.ni, .si, .nav-item, .sub-item').forEach(function(el){
      el.addEventListener('click', function(){
        if(window.innerWidth <= 768) closeSidebar();
      });
    });
  });
})();
</script>
<script>
(function(){
  function getSidebar(){ return document.querySelector('nav, aside.sidebar, .sidebar'); }
  function toggleSidebar(){
    var s=getSidebar(), b=document.getElementById('hamburger'), o=document.getElementById('navOverlay');
    var open=s.classList.contains('open');
    s.classList.toggle('open',!open); b.classList.toggle('open',!open);
    o.classList.toggle('show',!open);
    document.body.style.overflow = open ? '' : 'hidden';
  }
  function closeSidebar(){
    var s=getSidebar(), b=document.getElementById('hamburger'), o=document.getElementById('navOverlay');
    s.classList.remove('open'); b.classList.remove('open'); o.classList.remove('show');
    document.body.style.overflow='';
  }
  window.toggleSidebar=toggleSidebar; window.closeSidebar=closeSidebar;
  document.addEventListener('DOMContentLoaded',function(){
    var s=getSidebar(); if(!s) return;
    s.querySelectorAll('.ni,.si,.nav-item,.sub-item').forEach(function(el){
      el.addEventListener('click',function(){ if(window.innerWidth<=768) closeSidebar(); });
    });
  });
})();
</script>
<script>
function toggleFidNav(el){
  var sub=el.nextElementSibling;
  var chev=el.querySelector('.nav-chev');
  var open=sub.style.maxHeight&&sub.style.maxHeight!=='0px';
  sub.style.maxHeight=open?'0px':'300px';
  if(chev)chev.style.transform=open?'':'rotate(90deg)';
}
</script>
</body>
</html>
