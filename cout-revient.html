<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE â€” CoÃ»t de revient</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js">
  main.addEventListener('change', e=>{
    if(e.target.matches('select'))
  });
});
</script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --blue-dark:#0f1f5c;--blue-main:#1a3dce;--blue-light:#4f7ef8;--blue-ghost:#f0f4ff;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f5f7ff;--sidebar-w:252px;--radius:12px;
      --green:#10b981;--orange:#f59e0b;--red:#ef4444;--purple:#6366f1;--teal:#14b8a6;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}

    /* SIDEBAR */
    .sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#0f1f5c 0%,#162366 100%);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;overflow-y:auto;}
    .sidebar-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 22px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:10px;}
    .sidebar-logo-icon{width:36px;height:36px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .sidebar-logo-text{font-size:18px;font-weight:800;color:white;letter-spacing:1px;}
    .sidebar-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,0.3);letter-spacing:1.2px;text-transform:uppercase;padding:14px 20px 5px;}
    .nav-item{display:flex;align-items:center;gap:11px;padding:10px 20px;color:rgba(255,255,255,0.6);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;user-select:none;}
    .nav-item:hover{color:white;background:rgba(255,255,255,0.06);}
    .nav-item.active{color:white;background:rgba(255,255,255,0.1);border-left-color:#4f7ef8;}
    .nav-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0;}
    .nav-label{flex:1;}
    .nav-chevron{font-size:11px;color:rgba(255,255,255,0.3);transition:transform 0.25s;margin-left:auto;}
    .nav-item.open .nav-chevron{transform:rotate(90deg);}
    .submenu{overflow:hidden;max-height:0;transition:max-height 0.3s ease;}
    .submenu.open{max-height:300px;}
    .sub-item{display:flex;align-items:center;gap:9px;padding:8px 20px 8px 44px;color:rgba(255,255,255,0.45);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;}
    .sub-item:hover{color:rgba(255,255,255,0.8);background:rgba(255,255,255,0.05);}
    .sub-item.active{color:white;background:rgba(79,126,248,0.15);border-left-color:rgba(79,126,248,0.6);}
    .sub-dot{width:5px;height:5px;background:rgba(255,255,255,0.3);border-radius:50%;flex-shrink:0;}
    .sub-item.active .sub-dot{background:#4f7ef8;}
    .sub-year-badge{margin-left:auto;font-size:10px;color:rgba(255,255,255,0.25);font-weight:600;}
    .sidebar-footer{margin-top:auto;padding:16px 20px 0;border-top:1px solid rgba(255,255,255,0.08);}
    .user-card{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.07);border-radius:10px;}
    .user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--blue-light),#6366f1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
    .user-name{font-size:12px;font-weight:600;color:white;}
    .user-plan{font-size:10px;color:rgba(255,255,255,0.4);}
    .logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:14px;padding:4px;}

    /* MAIN */
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:17px;font-weight:700;}
    .topbar-left p{font-size:12px;color:var(--muted);}
    .topbar-right{display:flex;align-items:center;gap:10px;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.18s;}
    .btn-primary{background:linear-gradient(135deg,var(--blue-main),var(--blue-light));color:white;box-shadow:0 3px 10px rgba(26,61,206,0.25);}
    .btn-primary:hover{opacity:0.9;transform:translateY(-1px);}
    .btn-success{background:linear-gradient(135deg,#10b981,#34d399);color:white;}
    .btn-outline{background:white;color:var(--blue-main);border:1.5px solid var(--border);}
    .btn-outline:hover{border-color:var(--blue-main);background:var(--blue-ghost);}
    .btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}
    .btn-danger:hover{background:#fee2e2;}
    .btn-sm{padding:5px 11px;font-size:12px;}
    .btn-xs{padding:3px 8px;font-size:11px;}

    /* LAYOUT */
    .content{padding:22px 28px;flex:1;display:flex;gap:20px;}
    .left-panel{width:300px;flex-shrink:0;display:flex;flex-direction:column;gap:14px;}
    .right-panel{flex:1;min-width:0;}

    /* CATALOGUE */
    .catalogue-card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .catalogue-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);}
    .catalogue-title{font-size:13px;font-weight:700;}
    .search-input{width:100%;padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;outline:none;margin:10px 16px;width:calc(100% - 32px);}
    .search-input:focus{border-color:var(--blue-main);}

    /* CATEGORY */
    .cat-group{border-bottom:1px solid #f1f5f9;}
    .cat-group:last-child{border-bottom:none;}
    .cat-header{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;cursor:pointer;background:#fafbff;}
    .cat-header:hover{background:var(--blue-ghost);}
    .cat-name{font-size:12px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:6px;}
    .cat-count{font-size:10px;font-weight:600;background:#e8eeff;color:var(--blue-main);padding:1px 6px;border-radius:10px;}
    .cat-chevron{font-size:10px;color:var(--muted);transition:transform 0.2s;}
    .cat-group.open .cat-chevron{transform:rotate(90deg);}
    .cat-products{max-height:0;overflow:hidden;transition:max-height 0.25s ease;}
    .cat-group.open .cat-products{max-height:500px;}

    /* PRODUCT ITEM */
    .product-item{display:flex;align-items:center;gap:8px;padding:8px 16px;cursor:pointer;border-left:3px solid transparent;transition:all 0.15s;}
    .product-item:hover{background:#fafbff;}
    .product-item.active{background:var(--blue-ghost);border-left-color:var(--blue-main);}
    .product-emoji{font-size:16px;flex-shrink:0;}
    .product-info{flex:1;min-width:0;}
    .product-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .product-type-badge{font-size:10px;color:var(--muted);}
    .product-cr{font-size:11px;font-weight:700;color:var(--blue-main);flex-shrink:0;}

    /* TYPE ICONS */
    .type-icons={recette:'ğŸ°',physique:'ğŸ“¦',service:'ğŸ› ï¸',revente:'ğŸ·ï¸'}

    /* FICHE PRODUIT */
    .fiche-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:500px;text-align:center;color:var(--muted);}
    .fiche-empty-icon{font-size:52px;margin-bottom:16px;}
    .fiche-empty h3{font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px;}
    .fiche-empty p{font-size:13px;line-height:1.7;max-width:320px;}

    .fiche{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .fiche-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
    .fiche-head-left{display:flex;align-items:center;gap:12px;}
    .fiche-emoji-btn{font-size:28px;background:var(--blue-ghost);border:none;border-radius:10px;width:50px;height:50px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
    .fiche-name-input{font-size:18px;font-weight:800;border:none;outline:none;font-family:'Plus Jakarta Sans',sans-serif;color:var(--text);width:260px;}
    .fiche-name-input::placeholder{color:#d1d5db;}
    .fiche-type-select{padding:4px 10px;border:1.5px solid var(--border);border-radius:20px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;color:var(--muted);outline:none;cursor:pointer;}
    .fiche-cat-input{padding:4px 10px;border:1.5px solid var(--border);border-radius:6px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;color:var(--text);outline:none;width:140px;}
    .fiche-head-actions{display:flex;gap:8px;align-items:center;}

    /* KPI RÃ‰SUMÃ‰ */
    .fiche-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:0;border-bottom:1px solid var(--border);}
    .fiche-kpi{padding:16px 20px;border-right:1px solid var(--border);}
    .fiche-kpi:last-child{border-right:none;}
    .fk-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;}
    .fk-value{font-size:20px;font-weight:800;color:var(--text);}
    .fk-value.positive{color:var(--green);}
    .fk-value.negative{color:var(--red);}
    .fk-value.blue{color:var(--blue-main);}
    .fk-sub{font-size:11px;color:var(--muted);margin-top:3px;}

    /* SECTIONS FICHE */
    .fiche-body{padding:0;}
    .fiche-section{border-bottom:1px solid var(--border);}
    .fiche-section:last-child{border-bottom:none;}
    .fiche-section-head{display:flex;align-items:center;justify-content:space-between;padding:12px 22px;background:#fafbff;cursor:pointer;user-select:none;}
    .fiche-section-head:hover{background:var(--blue-ghost);}
    .fiche-section-title{font-size:12px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px;}
    .section-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;}
    .sb-blue{background:var(--blue-ghost);color:var(--blue-main);}
    .sb-green{background:#f0fdf4;color:#10b981;}
    .sb-orange{background:#fffbeb;color:#f59e0b;}
    .sb-purple{background:#eef2ff;color:#6366f1;}
    .sb-teal{background:#f0fdfa;color:#14b8a6;}
    .sb-red{background:#fef2f2;color:#ef4444;}
    .section-total{font-size:13px;font-weight:800;color:var(--blue-main);}
    .fiche-section-body{padding:12px 22px 16px;}

    /* INGREDIENT TABLE */
    .ingr-table{width:100%;border-collapse:collapse;}
    .ingr-table th{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.4px;padding:6px 8px;text-align:left;background:#f8faff;border-bottom:1px solid var(--border);}
    .ingr-table td{padding:6px 8px;border-bottom:1px solid #f8f9fa;vertical-align:middle;}
    .ingr-table tr:last-child td{border-bottom:none;}
    .cell-in{width:100%;padding:5px 7px;border:1.5px solid transparent;border-radius:6px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;color:var(--text);background:transparent;outline:none;transition:all 0.15s;}
    .cell-in:focus{border-color:var(--blue-main);background:white;}
    .cell-in:hover{background:#f8faff;}
    select.cell-in{cursor:pointer;}
    .cost-pill{font-size:12px;font-weight:700;color:var(--blue-main);}

    /* PRIX DE VENTE */
    .prix-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;margin-top:4px;}
    .prix-box{background:var(--blue-ghost);border-radius:10px;padding:14px;}
    .prix-box.green-box{background:#f0fdf4;}
    .prix-box.orange-box{background:#fffbeb;}
    .prix-label{font-size:11px;font-weight:600;color:var(--muted);margin-bottom:6px;}
    .prix-input{width:100%;padding:8px 10px;border:2px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:16px;font-weight:800;color:var(--text);outline:none;background:white;}
    .prix-input:focus{border-color:var(--blue-main);}
    .prix-calc{font-size:12px;font-weight:600;margin-top:6px;}
    .prix-calc.positive{color:var(--green);}
    .prix-calc.negative{color:var(--red);}
    .prix-calc.blue{color:var(--blue-main);}

    /* MARGE VISUELLE */
    .marge-bar-wrap{margin-top:12px;}
    .marge-bar-label{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:4px;}
    .marge-bar{height:8px;background:#e2e8f0;border-radius:99px;overflow:hidden;}
    .marge-bar-fill{height:100%;border-radius:99px;transition:width 0.6s ease;}

    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(15,31,92,0.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;width:100%;max-width:420px;box-shadow:0 24px 60px rgba(15,31,92,0.2);overflow:hidden;}
    .modal-head{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
    .modal-head h3{font-size:15px;font-weight:700;}
    .modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);}
    .modal-body{padding:20px 24px;}
    .modal-field{margin-bottom:16px;}
    .modal-label{font-size:12px;font-weight:600;color:var(--muted);margin-bottom:5px;display:block;}
    .modal-input{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;}
    .modal-input:focus{border-color:var(--blue-main);}
    .modal-foot{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;}
    .type-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:4px;}
    .type-card{padding:12px;border:2px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;transition:all 0.15s;}
    .type-card:hover{border-color:var(--blue-light);background:var(--blue-ghost);}
    .type-card.selected{border-color:var(--blue-main);background:var(--blue-ghost);}
    .type-card-icon{font-size:22px;margin-bottom:4px;}
    .type-card-label{font-size:12px;font-weight:600;color:var(--text);}

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all 0.3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.success{background:#10b981;}
    .toast.warning{background:#f59e0b;}

    .loader{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--muted);gap:10px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--blue-main);border-radius:50%;animation:spin .7s linear infinite;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .fiche{animation:fadeIn 0.25s ease both;}

    /* EMOJI PICKER */
    .emoji-picker{position:absolute;background:white;border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:0 8px 30px rgba(0,0,0,0.12);z-index:100;display:none;flex-wrap:wrap;gap:4px;width:220px;}
    .emoji-picker.show{display:flex;}
    .ep-btn{font-size:20px;cursor:pointer;padding:4px;border-radius:6px;border:none;background:none;}
    .ep-btn:hover{background:#f3f4f6;}
  .ucard:hover{background:rgba(255,255,255,.12);transform:translateY(-1px);transition:.15s}


/* â”€â”€ MOBILE UNIQUEMENT â”€â”€ */









/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘   ALTIORA â€” RESPONSIVE MOBILE (iPhone/Android)  â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* 1. RESET global overflow */
html, body { overflow-x: hidden; max-width: 100vw; }

/* 2. HAMBURGER â€” masquÃ© par dÃ©faut */
.hamburger {
  display: none;
  position: fixed;
  top: 14px; left: 14px;
  z-index: 1001;
  width: 44px; height: 44px;
  background: #0f1f5c;
  border: none; border-radius: 12px;
  cursor: pointer;
  flex-direction: column;
  align-items: center; justify-content: center;
  gap: 5px;
  box-shadow: 0 4px 16px rgba(15,31,92,.45);
  -webkit-tap-highlight-color: transparent;
  transition: background .2s;
}
.hamburger:active { background: #1a3dce; }
.hamburger span {
  display: block; width: 20px; height: 2.5px;
  background: #fff; border-radius: 2px;
  transition: all .25s ease;
  pointer-events: none;
}
.hamburger.open span:nth-child(1) { transform: translateY(7.5px) rotate(45deg); }
.hamburger.open span:nth-child(2) { opacity: 0; transform: scaleX(0); }
.hamburger.open span:nth-child(3) { transform: translateY(-7.5px) rotate(-45deg); }

/* 3. OVERLAY */
.nav-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.5); z-index: 1000;
  -webkit-tap-highlight-color: transparent;
}
.nav-overlay.show { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MOBILE â‰¤768px â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {

  /* HAMBURGER visible */
  .hamburger { display: flex !important; }

  /* SIDEBAR / NAV â†’ drawer */
  nav, aside.sidebar, .sidebar {
    position: fixed !important;
    top: 0 !important; left: 0 !important;
    height: 100vh !important;
    height: -webkit-fill-available !important;
    width: min(280px, 84vw) !important;
    z-index: 1001 !important;
    transform: translateX(-105%) !important;
    transition: transform .3s cubic-bezier(.4,0,.2,1) !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
    margin: 0 !important;
    box-sizing: border-box !important;
  }
  nav.open, aside.sidebar.open, .sidebar.open {
    transform: translateX(0) !important;
    box-shadow: 8px 0 32px rgba(0,0,0,.3) !important;
  }

  /* MAIN CONTENT â†’ pleine largeur */
  .main, main, div.main, .main-content {
    margin-left: 0 !important;
    width: 100vw !important;
    overflow-x: hidden !important;
    box-sizing: border-box !important;
  }

  /* TOPBAR */
  .topbar {
    padding: 10px 10px 10px 62px !important;
    flex-wrap: wrap !important;
    gap: 6px !important;
    position: sticky !important;
    top: 0 !important; z-index: 50 !important;
    background: #fff !important;
    box-shadow: 0 1px 6px rgba(0,0,0,.08) !important;
    box-sizing: border-box !important;
    width: 100% !important;
  }
  .topbar h1, .topbar-left h1, .topbar-left h2 { font-size: 14px !important; }
  .topbar p, .topbar-left p { font-size: 10px !important; }
  .topbar-right, .tb-r {
    width: 100% !important;
    flex-wrap: wrap !important;
    gap: 6px !important;
  }
  .topbar-right .btn, .tb-r .btn,
  .topbar-right button, .tb-r button {
    flex: 1 1 auto !important;
    font-size: 11px !important;
    padding: 7px 8px !important;
    min-height: 36px !important;
    white-space: nowrap !important;
    min-width: 0 !important;
  }

  /* PAGE / CONTENT */
  .content, .page {
    padding: 12px 10px !important;
    overflow-x: hidden !important;
    width: 100% !important;
    box-sizing: border-box !important;
    gap: 12px !important;
  }
  .content > *, .page > * {
    box-sizing: border-box !important;
    max-width: 100% !important;
  }

  /* â”€â”€ TOUTES LES GRILLES â†’ 1 COLONNE â”€â”€ */
  /* Dashboard */
  .kpi-grid-4, .kpi-grid-5 { grid-template-columns: 1fr 1fr !important; gap: 8px !important; margin-bottom: 12px !important; }
  .charts-grid, .charts-grid-3 { grid-template-columns: 1fr !important; gap: 12px !important; }
  /* Suivi CA */
  .kpi-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .charts-grid-2 { grid-template-columns: 1fr !important; gap: 12px !important; }
  /* CoÃ»t de revient */
  .fiche-kpis { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .prix-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  /* Marges */
  .decomp-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .cle-grid { grid-template-columns: 1fr !important; gap: 8px !important; }
  .cle-inputs { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .sim-levers { grid-template-columns: 1fr !important; gap: 8px !important; }
  .sim-result-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .modal-row { grid-template-columns: 1fr !important; gap: 8px !important; }
  /* Pilotage */
  .summary-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; margin-bottom: 12px !important; }
  .sections-grid { grid-template-columns: 1fr !important; gap: 12px !important; }
  .tva-result { grid-template-columns: 1fr !important; gap: 8px !important; }
  .cashflow-grid { grid-template-columns: 1fr !important; gap: 8px !important; }
  /* Panier moyen */
  .fields-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .results-row { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .g2, .g3 { grid-template-columns: 1fr !important; gap: 12px !important; }
  .cats { grid-template-columns: 1fr !important; gap: 10px !important; }
  .sim-g { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .sim-rg { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  /* Dettes */
  .detail-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .mgrid2 { grid-template-columns: 1fr !important; gap: 10px !important; }
  /* Profil */
  .plan-grid { grid-template-columns: 1fr !important; gap: 12px !important; }
  /* Universels */
  .kpi-row { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .type-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .fact-kpis { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .calendar-grid { grid-template-columns: repeat(4, 1fr) !important; gap: 5px !important; }

  /* â”€â”€ KPI CARDS â€” texte lisible â”€â”€ */
  .kpi-card, .kpi, .summary-card, .fkpi {
    padding: 12px 10px !important;
    overflow: hidden !important;
    min-width: 0 !important;
  }
  .kpi-value, .kpi-val, .summary-value { font-size: 16px !important; letter-spacing: -0.3px !important; }
  .kpi-label, .kpi-lbl, .summary-label { font-size: 9px !important; line-height: 1.3 !important; }
  .kpi-sub { font-size: 10px !important; }

  /* â”€â”€ TABLEAUX â€” scroll interne propre â”€â”€ */
  .echeancier-wrap,
  div[style*="overflow-x"],
  .section-body, .section-content,
  .table-wrap, .table-card, .table-container,
  .card > div { overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; }
  table { min-width: 460px !important; font-size: 11px !important; }
  
  /* â”€â”€ INPUTS TOUCH (Ã©vite zoom iOS) â”€â”€ */
  input[type=text], input[type=number], input[type=email],
  input[type=date], input[type=tel], input[type=password],
  select, textarea {
    font-size: 16px !important;
    -webkit-appearance: none !important;
  }
  .field-wrap, .mfield-wrap, .sim-fw {
    min-height: 46px !important;
    padding: 10px 12px !important;
  }

  /* â”€â”€ BOUTONS â”€â”€ */
  .btn { min-height: 40px !important; }
  .btn-xs, .btn-sm { min-height: 34px !important; }

  /* â”€â”€ PILOTAGE SUMMARY CARDS â”€â”€ */
  .summary-card .kpi-value,
  .summary-card .summary-value { white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }
  .summary-card .kpi-sub,
  .summary-card .summary-sub { white-space: normal !important; font-size: 10px !important; }

  /* â”€â”€ SECTION HEAD â”€â”€ */
  .section-head { flex-wrap: wrap !important; gap: 6px !important; padding: 10px 12px !important; }
  .section-head .btn, .section-head button { font-size: 10px !important; padding: 4px 8px !important; }

  /* â”€â”€ MONTH STRIP (panier moyen) â”€â”€ */
  .month-strip { overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; flex-wrap: nowrap !important; padding-bottom: 6px !important; }
  .mbtn { flex-shrink: 0 !important; }

  /* â”€â”€ YEAR BAR â”€â”€ */
  .yr-bar { overflow-x: auto !important; flex-wrap: nowrap !important; -webkit-overflow-scrolling: touch !important; }
  .yr { flex-shrink: 0 !important; }

  /* â”€â”€ TABS â”€â”€ */
  .tabs { overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; flex-wrap: nowrap !important; width: 100% !important; }
  .tab { flex-shrink: 0 !important; white-space: nowrap !important; }

  /* â”€â”€ DETTE CARDS â”€â”€ */
  .dette-head { flex-wrap: wrap !important; gap: 8px !important; }
  .dette-stats { flex-direction: column !important; align-items: flex-start !important; gap: 4px !important; }

  /* â”€â”€ SAISIE (panier) â”€â”€ */
  .saisie-head { flex-direction: column !important; gap: 8px !important; align-items: flex-start !important; }

  /* â”€â”€ HERO (profil) â”€â”€ */
  .hero { flex-direction: column !important; text-align: center !important; padding: 16px !important; gap: 12px !important; }
  .hero-right { text-align: center !important; }
  .hero-tags { justify-content: center !important; }
  .hero-name { font-size: 17px !important; }

  /* â”€â”€ MODAL â†’ bottom sheet â”€â”€ */
  .overlay, .modal-overlay { align-items: flex-end !important; padding: 0 !important; }
  .modal {
    width: 100% !important; max-width: 100% !important;
    margin: 0 !important;
    border-radius: 18px 18px 0 0 !important;
    max-height: 92vh !important;
  }

  /* â”€â”€ CANVAS â”€â”€ */
  canvas { max-width: 100% !important; }

  /* â”€â”€ CONTEXT BAR (dashboard) â”€â”€ */
  .context-bar { flex-wrap: wrap !important; gap: 8px !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PETIT MOBILE â‰¤420px â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 420px) {
  .kpi-grid-4, .kpi-grid-5, .kpi-grid, .kpi-row,
  .fiche-kpis, .summary-grid, .fact-kpis,
  .type-grid, .results-row, .sim-g { grid-template-columns: 1fr !important; }
  .sim-rg, .sim-result-grid, .cle-inputs { grid-template-columns: 1fr !important; }
  .calendar-grid { grid-template-columns: repeat(3, 1fr) !important; }
}


    .nav-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 20px 4px}
</style>
</head>
<body>
  <button class="hamburger" id="hamburger" onclick="toggleSidebar()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
  <div class="nav-overlay" id="navOverlay" onclick="closeSidebar()"></div>
<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo"><div class="sidebar-logo-icon">ğŸ“Š</div><div class="sidebar-logo-text">ALTEORE</div></div>
  <div class="sidebar-section-label">Principal</div>
  <div class="nav-item" onclick="window.location.href='dashboard.html'"><span class="nav-icon">ğŸ </span><span class="nav-label">Tableau de bord</span></div>
  <div class="nav-item" onclick="window.location.href='suivi-ca.html'"><span class="nav-icon">ğŸ“ˆ</span><span class="nav-label">Suivi CA & RÃ©sultats</span></div>
  <div class="nav-item active" id="kpis-nav" onclick="toggleMenu('kpis-menu',this)"><span class="nav-icon">ğŸ¯</span><span class="nav-label">KPIs ClÃ©s</span><span class="nav-chevron">â€º</span></div>
  <div class="submenu open" id="kpis-menu">
    <div class="sub-item active"><span class="sub-dot"></span>CoÃ»t de revient</div>
    <div class="sub-item" onclick="window.location.href='marges.html'"><span class="sub-dot"></span>Marge brute & nette</div>
    <div class="sub-item" onclick="window.location.href='panier-moyen.html'"><span class="sub-dot"></span>Panier moyen</div>
  </div>
  <div class="nav-item" onclick="toggleMenu('pilotage-menu',this)"><span class="nav-icon">ğŸ§­</span><span class="nav-label">Pilotage</span><span class="nav-chevron">â€º</span></div>
  <div class="submenu" id="pilotage-menu">
    <div class="sub-item" onclick="window.location.href='pilotage.html?year=2025'"><span class="sub-dot"></span>Pilotage 2025<span class="sub-year-badge">2025</span></div>
    <div class="sub-item" onclick="window.location.href='pilotage.html?year=2026'"><span class="sub-dot"></span>Pilotage 2026<span class="sub-year-badge">2026</span></div>
    <div class="sub-item" onclick="window.location.href='pilotage.html?year=2027'"><span class="sub-dot"></span>Pilotage 2027<span class="sub-year-badge">2027</span></div>
    <div class="sub-item" onclick="location.href='cashflow.html'" style="border-top:1px solid rgba(255,255,255,.06);margin-top:4px;padding-top:8px"><span class="sub-dot" style="background:#0d9488"></span>ğŸ’§ Cashflow</div>
  </div>
  <div class="nav-item" onclick="location.href='dettes.html'"><span class="nav-icon">ğŸ¦</span><span class="nav-label">Dettes &amp; Emprunts</span></div>
  <div class="nav-section-label">Intelligence IA</div>
  <div class="nav-item" onclick="location.href='bilan.html'"><span class="nav-icon">ğŸ¤–</span><span class="nav-label">Analyse de Bilan</span><span class="nav-badge">IA</span></div>

  <div class="nav-section-label">FidÃ©lisation</div>
  <div class="nav-item" onclick="toggleFidNav(this)" style="justify-content:space-between">
    <span style="display:flex;align-items:center;gap:8px"><span class="nav-icon">ğŸ’</span><span class="nav-label">FidÃ©lisation</span></span>
    <span class="nav-chev" style="font-size:11px;color:rgba(255,255,255,.3);transition:transform .25s">â€º</span>
  </div>
  <div class="nav-fid-sub" style="overflow:hidden;max-height:0;transition:max-height .35s ease">
    <div class="nav-sub-item" onclick="location.href='fidelisation.html'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Dashboard fidÃ©litÃ©</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#clients'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Clients</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#carte'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Carte fidÃ©litÃ©</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#points'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Points & RÃ©compenses</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#coupons'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Coupons & Offres</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#campagnes'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Campagnes</div>
  </div>
  <div class="nav-item" onclick="location.href='import.html'" style="border-top:1px solid rgba(255,255,255,.08);padding-top:10px"><span class="nav-icon">ğŸ“¥</span><span class="nav-label">Import de donnÃ©es</span></div>
  <div class="sidebar-footer">
    <div class="user-card" onclick="location.href='profil.html'" style="cursor:pointer;transition:.15s" title="Mon compte">
      <div class="user-avatar" id="userAvatar">A</div>
      <div><div class="user-name" id="userName">Utilisateur</div><div class="user-plan">Plan gratuit</div></div>
      <button class="logout-btn" onclick="handleLogout()">â‹</button>
    </div>

    <div style="display:flex;justify-content:center;gap:14px;padding:10px 0 2px">
      <a href="mentions-legales.html" style="font-size:10px;color:rgba(255,255,255,.22);text-decoration:none;transition:color .2s" onmouseover="this.style.color='rgba(255,255,255,.6)'" onmouseout="this.style.color='rgba(255,255,255,.22)'">Mentions</a>
      <a href="cgv.html" style="font-size:10px;color:rgba(255,255,255,.22);text-decoration:none;transition:color .2s" onmouseover="this.style.color='rgba(255,255,255,.6)'" onmouseout="this.style.color='rgba(255,255,255,.22)'">CGV</a>
      <a href="confidentialite.html" style="font-size:10px;color:rgba(255,255,255,.22);text-decoration:none;transition:color .2s" onmouseover="this.style.color='rgba(255,255,255,.6)'" onmouseout="this.style.color='rgba(255,255,255,.22)'">ConfidentialitÃ©</a>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>CoÃ»t de revient</h1>
      <p>Calculez prÃ©cisÃ©ment le coÃ»t de revient de chaque produit, recette ou service</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="window.location.href='marges.html'">ğŸ“Š Voir les marges â†’</button>
      <button class="btn btn-primary" onclick="openNewProduct()">+ Nouveau produit</button>
    </div>
  </div>

  <div class="content">
    <!-- LEFT : Catalogue -->
    <div class="left-panel">
      <div class="catalogue-card" style="flex:1">
        <div class="catalogue-head">
          <div class="catalogue-title">ğŸ“¦ Catalogue</div>
          <button class="btn btn-primary btn-xs" onclick="openNewProduct()">+ Nouveau</button>
        </div>
        <input class="search-input" placeholder="ğŸ” Rechercher un produit..." oninput="filterProducts(this.value)"/>
        <div id="catalogueList"><div class="loader"><div class="spin"></div></div></div>
      </div>
    </div>

    <!-- RIGHT : Fiche produit -->
    <div class="right-panel" id="rightPanel">
      <div class="fiche-empty">
        <div class="fiche-empty-icon">ğŸ§®</div>
        <h3>SÃ©lectionnez un produit</h3>
        <p>Choisissez un produit dans le catalogue ou crÃ©ez-en un nouveau pour calculer son coÃ»t de revient.</p>
        <button class="btn btn-primary" style="margin-top:16px" onclick="openNewProduct()">+ CrÃ©er mon premier produit</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL NOUVEAU PRODUIT -->
<div class="modal-overlay" id="newProductModal">
  <div class="modal">
    <div class="modal-head">
      <h3>Nouveau produit / service</h3>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="modal-field">
        <label class="modal-label">Nom du produit *</label>
        <input class="modal-input" id="newName" placeholder="Ex: Tarte au citron, Prestation conseil..."/>
      </div>
      <div class="modal-field">
        <label class="modal-label">CatÃ©gorie</label>
        <input class="modal-input" id="newCat" placeholder="Ex: PÃ¢tisseries, Services, Boissons..." list="catList"/>
        <datalist id="catList"></datalist>
      </div>
      <div class="modal-field">
        <label class="modal-label">Type de produit *</label>
        <div class="type-grid" id="typeGrid">
          <div class="type-card selected" onclick="selectType('recette',this)"><div class="type-card-icon">ğŸ°</div><div class="type-card-label">Recette / CrÃ©ation</div></div>
          <div class="type-card" onclick="selectType('physique',this)"><div class="type-card-icon">ğŸ“¦</div><div class="type-card-label">Produit physique</div></div>
          <div class="type-card" onclick="selectType('service',this)"><div class="type-card-icon">ğŸ› ï¸</div><div class="type-card-label">Prestation service</div></div>
          <div class="type-card" onclick="selectType('revente',this)"><div class="type-card-icon">ğŸ·ï¸</div><div class="type-card-label">Revente</div></div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" onclick="createProduct()">CrÃ©er â†’</button>
    </div>
  </div>
</div>

<!-- EMOJI PICKER -->
<div class="emoji-picker" id="emojiPicker">
  ğŸ°ğŸ‚ğŸ§ğŸ©ğŸªğŸ¥ğŸ¥–ğŸğŸ¥—ğŸ•ğŸ”ğŸŸğŸŒ®ğŸ£ğŸ±ğŸ¥©ğŸ—ğŸ¥šğŸ§€ğŸ·ğŸºğŸ¥¤â˜•ğŸ«–ğŸ“¦ğŸ·ï¸ğŸ› ï¸âš™ï¸ğŸ”§ğŸ’¼ğŸ“‹ğŸ¯ğŸŒ¿ğŸŒ¸ğŸ“ğŸ‹ğŸ‡ğŸ«ğŸ¯ğŸ§‚ğŸ«™
</div>

<div class="toast" id="toast"></div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth=getAuth(app);
  const db=getFirestore(app);
  window._auth=auth;window._db=db;
  window._doc=doc;window._setDoc=setDoc;window._getDoc=getDoc;
  window._collection=collection;window._getDocs=getDocs;window._deleteDoc=deleteDoc;
  window._signOut=signOut;
  onAuthStateChanged(auth,user=>{
    if(!user){window.location.href='index.html';return;}
    window._uid=user.uid;
    const name=user.displayName||user.email.split('@')[0];
    document.getElementById('userName').textContent=name;
    document.getElementById('userAvatar').textContent=name.charAt(0).toUpperCase();
    window._firebaseReady = true;
    window.loadCatalogue();
  });
</script>

<script>
// â”€â”€ STATE â”€â”€
let _products={}; // id â†’ product
let _currentId=null;
let _selectedType='recette';
const TYPE_LABELS={recette:'Recette',physique:'Produit physique',service:'Service',revente:'Revente'};
const TYPE_ICONS={recette:'ğŸ°',physique:'ğŸ“¦',service:'ğŸ› ï¸',revente:'ğŸ·ï¸'};
const UNITS=['g','kg','ml','l','piÃ¨ce','portion','heure','forfait','unitÃ©'];

function toggleMenu(id,el){document.getElementById(id).classList.toggle('open');el.classList.toggle('open');}
async function handleLogout(){await window._signOut(window._auth);window.location.href='index.html';}

// â”€â”€ LOAD â”€â”€
async function loadCatalogue(){
  if(!window._uid){setTimeout(loadCatalogue,500);return;}
  try{
    const snap=await window._getDocs(window._collection(window._db,'produits',window._uid,'items'));
    _products={};
    snap.forEach(d=>_products[d.id]=d.data());
  }catch(e){console.warn(e);}
  renderCatalogue();
  // Update datalist
  const cats=[...new Set(Object.values(_products).map(p=>p.categorie).filter(Boolean))];
  const dl=document.getElementById('catList');
  dl.innerHTML=cats.map(c=>`<option value="${c}">`).join('');
}

function renderCatalogue(filter=''){
  const list=document.getElementById('catalogueList');
  const products=Object.entries(_products).filter(([id,p])=>
    !filter||p.nom.toLowerCase().includes(filter.toLowerCase())||
    (p.categorie||'').toLowerCase().includes(filter.toLowerCase())
  );

  if(products.length===0){
    list.innerHTML=`<div style="padding:24px;text-align:center;color:var(--muted);font-size:12px;">
      <div style="font-size:32px;margin-bottom:8px;">ğŸ“¦</div>
      Aucun produit encore.<br>CrÃ©ez votre premier produit !
    </div>`;
    return;
  }

  // Group by category
  const grouped={};
  products.forEach(([id,p])=>{
    const cat=p.categorie||'Sans catÃ©gorie';
    if(!grouped[cat])grouped[cat]=[];
    grouped[cat].push([id,p]);
  });

  list.innerHTML=Object.entries(grouped).map(([cat,items])=>`
    <div class="cat-group open" id="cat-${cat.replace(/\s/g,'_')}">
      <div class="cat-header" onclick="toggleCat('cat-${cat.replace(/\s/g,'_')}')">
        <div class="cat-name">ğŸ“ ${cat} <span class="cat-count">${items.length}</span></div>
        <span class="cat-chevron">â€º</span>
      </div>
      <div class="cat-products">
        ${items.map(([id,p])=>{
          const cr=calcCoutRevient(p);
          return `<div class="product-item ${_currentId===id?'active':''}" onclick="openProduct('${id}')">
            <span class="product-emoji">${p.emoji||TYPE_ICONS[p.type]||'ğŸ“¦'}</span>
            <div class="product-info">
              <div class="product-name">${p.nom}</div>
              <div class="product-type-badge">${TYPE_LABELS[p.type]||p.type}</div>
            </div>
            <div class="product-cr">${cr>0?fmtE(cr):''}</div>
          </div>`;
        }).join('')}
      </div>
    </div>
  `).join('');
}

function toggleCat(id){document.getElementById(id).classList.toggle('open');}
function filterProducts(v){renderCatalogue(v);}

// â”€â”€ PRODUCT CRUD â”€â”€
function defaultProduct(type){
  return{
    nom:'',categorie:'',type,emoji:TYPE_ICONS[type]||'ğŸ“¦',
    quantiteProduites:1,uniteProduction:'piÃ¨ce',
    ingredients:[{nom:'',qte:'',unite:'g',prixUnitaire:'',cout:0}],
    mainOeuvre:[{description:'',heures:'',tauxHoraire:'',cout:0}],
    chargesFixes:[{description:'',montant:'',repartition:'',cout:0}],
    emballages:[{description:'',qte:'',prixUnit:'',cout:0}],
    livraison:[{description:'',montant:'',cout:0}],
    prixVente:'',tvaRate:20,notes:''
  };
}

// â”€â”€ CALC â”€â”€
function calcCoutRevient(p){
  const qte=parseFloat(p.quantiteProduites)||1;
  const ingr=(p.ingredients||[]).reduce((s,r)=>{const q=parseFloat(r.qte)||0,pu=parseFloat(r.prixUnitaire)||0;return s+q*pu;},0);
  const mo=(p.mainOeuvre||[]).reduce((s,r)=>{const h=parseFloat(r.heures)||0,t=parseFloat(r.tauxHoraire)||0;return s+h*t;},0);
  const cf=(p.chargesFixes||[]).reduce((s,r)=>{const m=parseFloat(r.montant)||0,rep=parseFloat(r.repartition)||0;return s+(rep>0?m*rep/100:m);},0);
  const emb=(p.emballages||[]).reduce((s,r)=>{const q=parseFloat(r.qte)||0,pu=parseFloat(r.prixUnit)||0;return s+q*pu;},0);
  const liv=(p.livraison||[]).reduce((s,r)=>s+(parseFloat(r.montant)||0),0);
  return (ingr+mo+cf+emb+liv)/qte;
}

function calcDetails(p){
  const qte=parseFloat(p.quantiteProduites)||1;
  const ingr=(p.ingredients||[]).reduce((s,r)=>{const q=parseFloat(r.qte)||0,pu=parseFloat(r.prixUnitaire)||0;return s+q*pu;},0);
  const mo=(p.mainOeuvre||[]).reduce((s,r)=>{const h=parseFloat(r.heures)||0,t=parseFloat(r.tauxHoraire)||0;return s+h*t;},0);
  const cf=(p.chargesFixes||[]).reduce((s,r)=>{const m=parseFloat(r.montant)||0,rep=parseFloat(r.repartition)||0;return s+(rep>0?m*rep/100:m);},0);
  const emb=(p.emballages||[]).reduce((s,r)=>{const q=parseFloat(r.qte)||0,pu=parseFloat(r.prixUnit)||0;return s+q*pu;},0);
  const liv=(p.livraison||[]).reduce((s,r)=>s+(parseFloat(r.montant)||0),0);
  const total=ingr+mo+cf+emb+liv;
  const cr=total/qte;
  const pv=parseFloat(p.prixVente)||0;
  const margeHT=pv-cr;
  const txMarge=pv>0?(margeHT/pv*100):0;
  const pvTTC=pv*(1+(parseFloat(p.tvaRate)||0)/100);
  return{ingr,mo,cf,emb,liv,total,cr,pv,margeHT,txMarge,pvTTC,qte};
}

// â”€â”€ OPEN / RENDER FICHE â”€â”€
function openProduct(id){
  _currentId=id;
  renderCatalogue();
  renderFiche(_products[id],id);
}

function renderFiche(p,id){
  const d=calcDetails(p);
  const right=document.getElementById('rightPanel');

  right.innerHTML=`
  <div class="fiche">
    <!-- HEAD -->
    <div class="fiche-head">
      <div class="fiche-head-left">
        <div style="position:relative">
          <button class="fiche-emoji-btn" onclick="toggleEmojiPicker('${id}')">${p.emoji||'ğŸ“¦'}</button>
        </div>
        <div>
          <input class="fiche-name-input" placeholder="Nom du produit" value="${p.nom}" oninput="updateField('${id}','nom',this.value)"/>
          <div style="display:flex;gap:8px;margin-top:4px;align-items:center;">
            <select class="fiche-type-select" onchange="updateField('${id}','type',this.value)">
              ${Object.entries(TYPE_LABELS).map(([k,v])=>`<option value="${k}" ${p.type===k?'selected':''}>${TYPE_ICONS[k]} ${v}</option>`).join('')}
            </select>
            <input class="fiche-cat-input" placeholder="CatÃ©gorie" value="${p.categorie||''}" oninput="updateField('${id}','categorie',this.value)" list="catList"/>
          </div>
        </div>
      </div>
      <div class="fiche-head-actions">
        <button class="btn btn-danger btn-sm" onclick="deleteProduct('${id}')">ğŸ—‘ Supprimer</button>
        <button class="btn btn-success btn-sm" onclick="saveProduct('${id}')">ğŸ’¾ Sauvegarder</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="fiche-kpis">
      <div class="fiche-kpi">
        <div class="fk-label">CoÃ»t de revient</div>
        <div class="fk-value blue" id="fk-cr">${fmtE(d.cr)}</div>
        <div class="fk-sub">Par ${p.uniteProduction||'piÃ¨ce'}</div>
      </div>
      <div class="fiche-kpi">
        <div class="fk-label">Prix de vente HT</div>
        <div class="fk-value" id="fk-pv">${d.pv>0?fmtE(d.pv):'â€”'}</div>
        <div class="fk-sub">TTC : <span id="fk-pvttc">${d.pv>0?fmtE(d.pvTTC):'â€”'}</span></div>
      </div>
      <div class="fiche-kpi">
        <div class="fk-label">Marge brute</div>
        <div class="fk-value ${d.margeHT>=0?'positive':'negative'}" id="fk-marge">${d.pv>0?fmtE(d.margeHT):'â€”'}</div>
        <div class="fk-sub">PV âˆ’ CoÃ»t de revient</div>
      </div>
      <div class="fiche-kpi">
        <div class="fk-label">Taux de marge</div>
        <div class="fk-value ${d.txMarge>=30?'positive':d.txMarge>=10?'':'negative'}" id="fk-tx">${d.pv>0?d.txMarge.toFixed(1)+'%':'â€”'}</div>
        <div class="fk-sub" id="fk-tx-sub">${d.pv>0?(d.txMarge>=30?'âœ“ Bonne marge':d.txMarge>=10?'âš  Marge correcte':'âš  Marge faible'):'Saisissez un prix'}</div>
      </div>
    </div>

    ${d.pv>0?`
    <div style="padding:12px 22px;background:#f8faff;border-bottom:1px solid var(--border)">
      <div class="marge-bar-label"><span>CoÃ»t ${fmtE(d.cr)}</span><span>Marge ${fmtE(d.margeHT)}</span><span>PV ${fmtE(d.pv)}</span></div>
      <div class="marge-bar"><div class="marge-bar-fill" style="width:${Math.max(0,Math.min(d.cr/d.pv*100,100)).toFixed(1)}%;background:${d.txMarge>=30?'var(--green)':d.txMarge>=10?'var(--orange)':'var(--red)'}"></div></div>
    </div>`:''}

    <div class="fiche-body">
      <!-- PRODUCTION -->
      <div class="fiche-section">
        <div class="fiche-section-head" onclick="toggleSection('sec-prod')">
          <div class="fiche-section-title">âš™ï¸ ParamÃ¨tres de production <span class="section-badge sb-blue">Base de calcul</span></div>
          <span style="font-size:11px;color:var(--muted)">â€º</span>
        </div>
        <div class="fiche-section-body" id="sec-prod">
          <div style="display:flex;gap:12px;align-items:center">
            <div style="flex:1">
              <label style="font-size:11px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">QuantitÃ© produite</label>
              <input class="cell-in" style="max-width:120px;border:1.5px solid var(--border);border-radius:8px;padding:7px 10px" type="number" min="1" value="${p.quantiteProduites||1}" oninput="updateField('${id}','quantiteProduites',this.value)" onchange="updateField('${id}','quantiteProduites',this.value)"/>
            </div>
            <div style="flex:1">
              <label style="font-size:11px;font-weight:600;color:var(--muted);display:block;margin-bottom:4px">UnitÃ©</label>
              <input class="cell-in" style="max-width:120px;border:1.5px solid var(--border);border-radius:8px;padding:7px 10px" value="${p.uniteProduction||'piÃ¨ce'}" placeholder="piÃ¨ce, portion..." oninput="updateField('${id}','uniteProduction',this.value)"/>
            </div>
            <div style="flex:1;font-size:12px;color:var(--muted);background:var(--blue-ghost);padding:10px;border-radius:8px;">
              ğŸ’¡ Le coÃ»t est calculÃ© <strong>par unitÃ© produite</strong>. Si votre recette fait 12 tartes, mettez 12.
            </div>
          </div>
        </div>
      </div>

      <!-- INGRÃ‰DIENTS / MATIÃˆRES PREMIÃˆRES -->
      <div class="fiche-section">
        <div class="fiche-section-head" onclick="toggleSection('sec-ingr')">
          <div class="fiche-section-title">ğŸ§ª ${p.type==='service'?'Fournitures / Consommables':'MatiÃ¨res premiÃ¨res / IngrÃ©dients'} <span class="section-badge sb-green">${fmtE(d.ingr/d.qte)} / unitÃ©</span></div>
          <span class="section-total" id="tot-ingr">${fmtE(d.ingr)}</span>
        </div>
        <div class="fiche-section-body" id="sec-ingr">
          <table class="ingr-table">
            <thead><tr><th>DÃ©signation</th><th>QtÃ©</th><th>UnitÃ©</th><th>Prix/unitÃ©</th><th>CoÃ»t</th><th></th></tr></thead>
            <tbody id="ingr-tbody">${renderIngredients(p.ingredients||[],id)}</tbody>
          </table>
          <button class="btn btn-outline btn-xs" style="margin-top:8px" onclick="addIngredient('${id}')">+ Ajouter un ingrÃ©dient</button>
        </div>
      </div>

      <!-- MAIN D'Å’UVRE -->
      <div class="fiche-section">
        <div class="fiche-section-head" onclick="toggleSection('sec-mo')">
          <div class="fiche-section-title">ğŸ‘· Main d'Å“uvre <span class="section-badge sb-orange">${fmtE(d.mo/d.qte)} / unitÃ©</span></div>
          <span class="section-total" id="tot-mo">${fmtE(d.mo)}</span>
        </div>
        <div class="fiche-section-body" id="sec-mo" style="display:none">
          <table class="ingr-table">
            <thead><tr><th>Description</th><th>Heures</th><th>Taux horaire</th><th>CoÃ»t</th><th></th></tr></thead>
            <tbody id="mo-tbody">${renderMO(p.mainOeuvre||[],id)}</tbody>
          </table>
          <button class="btn btn-outline btn-xs" style="margin-top:8px" onclick="addMO('${id}')">+ Ajouter</button>
        </div>
      </div>

      <!-- CHARGES FIXES -->
      <div class="fiche-section">
        <div class="fiche-section-head" onclick="toggleSection('sec-cf')">
          <div class="fiche-section-title">ğŸ—ï¸ Charges fixes rÃ©parties <span class="section-badge sb-purple">${fmtE(d.cf/d.qte)} / unitÃ©</span></div>
          <span class="section-total" id="tot-cf">${fmtE(d.cf)}</span>
        </div>
        <div class="fiche-section-body" id="sec-cf" style="display:none">
          <div style="font-size:11px;color:var(--muted);background:var(--blue-ghost);padding:8px 12px;border-radius:6px;margin-bottom:10px">
            ğŸ’¡ RÃ©partissez une part de vos charges fixes sur ce produit. Ex: loyer 2 000â‚¬/mois, ce produit reprÃ©sente 10% â†’ 200â‚¬
          </div>
          <table class="ingr-table">
            <thead><tr><th>Charge</th><th>Montant total</th><th>RÃ©partition %</th><th>CoÃ»t imputÃ©</th><th></th></tr></thead>
            <tbody id="cf-tbody">${renderCF(p.chargesFixes||[],id)}</tbody>
          </table>
          <button class="btn btn-outline btn-xs" style="margin-top:8px" onclick="addCF('${id}')">+ Ajouter une charge</button>
        </div>
      </div>

      <!-- EMBALLAGES -->
      <div class="fiche-section">
        <div class="fiche-section-head" onclick="toggleSection('sec-emb')">
          <div class="fiche-section-title">ğŸ“¦ Emballages / Conditionnement <span class="section-badge sb-teal">${fmtE(d.emb/d.qte)} / unitÃ©</span></div>
          <span class="section-total" id="tot-emb">${fmtE(d.emb)}</span>
        </div>
        <div class="fiche-section-body" id="sec-emb" style="display:none">
          <table class="ingr-table">
            <thead><tr><th>DÃ©signation</th><th>QuantitÃ©</th><th>Prix unitaire</th><th>CoÃ»t</th><th></th></tr></thead>
            <tbody id="emb-tbody">${renderEmb(p.emballages||[],id)}</tbody>
          </table>
          <button class="btn btn-outline btn-xs" style="margin-top:8px" onclick="addEmb('${id}')">+ Ajouter</button>
        </div>
      </div>

      <!-- LIVRAISON -->
      <div class="fiche-section">
        <div class="fiche-section-head" onclick="toggleSection('sec-liv')">
          <div class="fiche-section-title">ğŸšš Frais de livraison / Transport <span class="section-badge sb-red">${fmtE(d.liv/d.qte)} / unitÃ©</span></div>
          <span class="section-total" id="tot-liv">${fmtE(d.liv)}</span>
        </div>
        <div class="fiche-section-body" id="sec-liv" style="display:none">
          <table class="ingr-table">
            <thead><tr><th>Description</th><th>Montant</th><th>CoÃ»t/unitÃ©</th><th></th></tr></thead>
            <tbody id="liv-tbody">${renderLiv(p.livraison||[],id)}</tbody>
          </table>
          <button class="btn btn-outline btn-xs" style="margin-top:8px" onclick="addLiv('${id}')">+ Ajouter</button>
        </div>
      </div>

      <!-- PRIX DE VENTE -->
      <div class="fiche-section">
        <div class="fiche-section-head" onclick="toggleSection('sec-pv')">
          <div class="fiche-section-title">ğŸ’° Prix de vente & Marge <span class="section-badge ${d.txMarge>=30?'sb-green':d.txMarge>=10?'sb-orange':'sb-red'}">${d.pv>0?d.txMarge.toFixed(1)+'% marge':'Ã€ dÃ©finir'}</span></div>
        </div>
        <div class="fiche-section-body" id="sec-pv">
          <div class="prix-grid">
            <div class="prix-box">
              <div class="prix-label">ğŸ’¡ CoÃ»t de revient (calculÃ©)</div>
              <div style="font-size:22px;font-weight:800;color:var(--blue-main);padding:8px 0">${fmtE(d.cr)}</div>
              <div style="font-size:11px;color:var(--muted)">Par ${p.uniteProduction||'unitÃ©'}</div>
            </div>
            <div class="prix-box green-box">
              <div class="prix-label">ğŸ·ï¸ Prix de vente HT</div>
              <input class="prix-input" type="number" placeholder="0.00" value="${p.prixVente||''}" oninput="updatePrixVente('${id}',this.value)" id="pv-input"/>
              <div class="prix-calc ${d.pv>0?(d.margeHT>=0?'positive':'negative'):''}" id="pv-marge-calc">
                ${d.pv>0?`Marge : ${fmtE(d.margeHT)} (${d.txMarge.toFixed(1)}%)`:'Saisissez votre prix de vente'}
              </div>
            </div>
            <div class="prix-box orange-box">
              <div class="prix-label">ğŸ“Š TVA sur vente</div>
              <select class="prix-input" style="font-size:14px" onchange="updateField('${id}','tvaRate',this.value)">
                ${[0,5.5,10,20].map(t=>`<option value="${t}" ${(p.tvaRate||20)==t?'selected':''}>${t}%</option>`).join('')}
              </select>
              <div class="prix-calc blue" id="pv-ttc-calc">${d.pv>0?`Prix TTC : ${fmtE(d.pvTTC)}`:'â€”'}</div>
            </div>
          </div>
          ${d.pv>0?`
          <div style="margin-top:14px;padding:14px;background:#f8faff;border-radius:10px;border:1px solid var(--border)">
            <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:10px">ğŸ“Š Simulation de marge</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;font-size:12px;">
              <div><span style="color:var(--muted)">Pour 10 unitÃ©s :</span><br><b>${fmtE(d.margeHT*10)}</b> de marge</div>
              <div><span style="color:var(--muted)">Pour 50 unitÃ©s :</span><br><b>${fmtE(d.margeHT*50)}</b> de marge</div>
              <div><span style="color:var(--muted)">Pour 100 unitÃ©s :</span><br><b>${fmtE(d.margeHT*100)}</b> de marge</div>
            </div>
          </div>`:''}
        </div>
      </div>

      <!-- NOTES -->
      <div class="fiche-section">
        <div class="fiche-section-head" onclick="toggleSection('sec-notes')">
          <div class="fiche-section-title">ğŸ“ Notes</div>
        </div>
        <div class="fiche-section-body" id="sec-notes" style="display:none">
          <textarea class="cell-in" style="width:100%;height:80px;border:1.5px solid var(--border);border-radius:8px;resize:vertical;padding:8px 10px" placeholder="Remarques, variantes, fournisseurs prÃ©fÃ©rÃ©s..." oninput="updateField('${id}','notes',this.value)">${p.notes||''}</textarea>
        </div>
      </div>
    </div>
  </div>`;
}

function toggleSection(id){
  const el=document.getElementById(id);
  if(!el)return;
  el.style.display=el.style.display==='none'?'block':'none';
}

// â”€â”€ RENDERERS â”€â”€
function renderIngredients(rows,id){
  return rows.map((r,i)=>{
    const cout=(parseFloat(r.qte)||0)*(parseFloat(r.prixUnitaire)||0);
    return `<tr data-idx="${i}">
      <td><input class="cell-in" placeholder="Beurre, farine..." value="${r.nom}" oninput="_products['${id}'].ingredients[${i}].nom=this.value"/></td>
      <td><input class="cell-in" type="number" style="width:65px" placeholder="0" value="${r.qte}" oninput="_products['${id}'].ingredients[${i}].qte=this.value;updateRowCost('ingr',${i},'${id}');refreshFiche('${id}')" onchange="_products['${id}'].ingredients[${i}].qte=this.value;updateRowCost('ingr',${i},'${id}');refreshFiche('${id}')"/></td>
      <td><select class="cell-in" style="width:65px" onchange="_products['${id}'].ingredients[${i}].unite=this.value">${UNITS.map(u=>`<option ${r.unite===u?'selected':''}>${u}</option>`).join('')}</select></td>
      <td><input class="cell-in" type="number" style="width:75px" placeholder="0.00" value="${r.prixUnitaire}" oninput="_products['${id}'].ingredients[${i}].prixUnitaire=this.value;updateRowCost('ingr',${i},'${id}');refreshFiche('${id}')" onchange="_products['${id}'].ingredients[${i}].prixUnitaire=this.value;updateRowCost('ingr',${i},'${id}');refreshFiche('${id}')"/></td>
      <td><span class="cost-pill" id="pill-ingr-${i}">${fmtE(cout)}</span></td>
      <td><button class="btn btn-danger btn-xs" onclick="delRow('${id}','ingredients',${i})">âœ•</button></td>
    </tr>`;
  }).join('');
}

function renderMO(rows,id){
  return rows.map((r,i)=>{
    const cout=(parseFloat(r.heures)||0)*(parseFloat(r.tauxHoraire)||0);
    return `<tr data-idx="${i}">
      <td><input class="cell-in" placeholder="Fabrication, montage..." value="${r.description}" oninput="_products['${id}'].mainOeuvre[${i}].description=this.value"/></td>
      <td><input class="cell-in" type="number" style="width:70px" placeholder="h" value="${r.heures}" oninput="_products['${id}'].mainOeuvre[${i}].heures=this.value;updateRowCost('mo',${i},'${id}');refreshFiche('${id}')" onchange="_products['${id}'].mainOeuvre[${i}].heures=this.value;updateRowCost('mo',${i},'${id}');refreshFiche('${id}')"/></td>
      <td><input class="cell-in" type="number" style="width:80px" placeholder="â‚¬/h" value="${r.tauxHoraire}" oninput="_products['${id}'].mainOeuvre[${i}].tauxHoraire=this.value;updateRowCost('mo',${i},'${id}');refreshFiche('${id}')" onchange="_products['${id}'].mainOeuvre[${i}].tauxHoraire=this.value;updateRowCost('mo',${i},'${id}');refreshFiche('${id}')"/></td>
      <td><span class="cost-pill" id="pill-mo-${i}">${fmtE(cout)}</span></td>
      <td><button class="btn btn-danger btn-xs" onclick="delRow('${id}','mainOeuvre',${i})">âœ•</button></td>
    </tr>`;
  }).join('');
}

function renderCF(rows,id){
  return rows.map((r,i)=>{
    const cout=(parseFloat(r.repartition)||0)>0?(parseFloat(r.montant)||0)*(parseFloat(r.repartition)||0)/100:(parseFloat(r.montant)||0);
    return `<tr data-idx="${i}">
      <td><input class="cell-in" placeholder="Loyer, Ã©lectricitÃ©..." value="${r.description}" oninput="_products['${id}'].chargesFixes[${i}].description=this.value"/></td>
      <td><input class="cell-in" type="number" style="width:90px" placeholder="â‚¬" value="${r.montant}" oninput="_products['${id}'].chargesFixes[${i}].montant=this.value;updateRowCost('cf',${i},'${id}');refreshFiche('${id}')" onchange="_products['${id}'].chargesFixes[${i}].montant=this.value;updateRowCost('cf',${i},'${id}');refreshFiche('${id}')"/></td>
      <td><input class="cell-in" type="number" style="width:70px" placeholder="%" value="${r.repartition}" oninput="_products['${id}'].chargesFixes[${i}].repartition=this.value;updateRowCost('cf',${i},'${id}');refreshFiche('${id}')" onchange="_products['${id}'].chargesFixes[${i}].repartition=this.value;updateRowCost('cf',${i},'${id}');refreshFiche('${id}')"/></td>
      <td><span class="cost-pill" id="pill-cf-${i}">${fmtE(cout)}</span></td>
      <td><button class="btn btn-danger btn-xs" onclick="delRow('${id}','chargesFixes',${i})">âœ•</button></td>
    </tr>`;
  }).join('');
}

function renderEmb(rows,id){
  return rows.map((r,i)=>{
    const cout=(parseFloat(r.qte)||0)*(parseFloat(r.prixUnit)||0);
    return `<tr data-idx="${i}">
      <td><input class="cell-in" placeholder="BoÃ®te, sachet..." value="${r.description}" oninput="_products['${id}'].emballages[${i}].description=this.value"/></td>
      <td><input class="cell-in" type="number" style="width:70px" placeholder="0" value="${r.qte}" oninput="_products['${id}'].emballages[${i}].qte=this.value;updateRowCost('emb',${i},'${id}');refreshFiche('${id}')" onchange="_products['${id}'].emballages[${i}].qte=this.value;updateRowCost('emb',${i},'${id}');refreshFiche('${id}')"/></td>
      <td><input class="cell-in" type="number" style="width:80px" placeholder="â‚¬" value="${r.prixUnit}" oninput="_products['${id}'].emballages[${i}].prixUnit=this.value;updateRowCost('emb',${i},'${id}');refreshFiche('${id}')" onchange="_products['${id}'].emballages[${i}].prixUnit=this.value;updateRowCost('emb',${i},'${id}');refreshFiche('${id}')"/></td>
      <td><span class="cost-pill" id="pill-emb-${i}">${fmtE(cout)}</span></td>
      <td><button class="btn btn-danger btn-xs" onclick="delRow('${id}','emballages',${i})">âœ•</button></td>
    </tr>`;
  }).join('');
}

function renderLiv(rows,id){
  return rows.map((r,i)=>{
    const qte=parseFloat(_products[id].quantiteProduites)||1;
    const cout=(parseFloat(r.montant)||0)/qte;
    return `<tr data-idx="${i}">
      <td><input class="cell-in" placeholder="Transporteur, carburant..." value="${r.description}" oninput="_products['${id}'].livraison[${i}].description=this.value"/></td>
      <td><input class="cell-in" type="number" style="width:90px" placeholder="â‚¬" value="${r.montant}" oninput="_products['${id}'].livraison[${i}].montant=this.value;updateRowCost('liv',${i},'${id}');refreshFiche('${id}')" onchange="_products['${id}'].livraison[${i}].montant=this.value;updateRowCost('liv',${i},'${id}');refreshFiche('${id}')"/></td>
      <td><span class="cost-pill" id="pill-liv-${i}">${fmtE(cout)}/unitÃ©</span></td>
      <td><button class="btn btn-danger btn-xs" onclick="delRow('${id}','livraison',${i})">âœ•</button></td>
    </tr>`;
  }).join('');
}

// â”€â”€ REFRESH (recalcul sans re-render complet) â”€â”€
function updateRowCost(type, i, id){
  const p=_products[id];
  if(!p)return;
  let val=0;
  if(type==='ingr'){const r=p.ingredients[i]||{};val=(parseFloat(r.qte)||0)*(parseFloat(r.prixUnitaire)||0);}
  else if(type==='mo'){const r=p.mainOeuvre[i]||{};val=(parseFloat(r.heures)||0)*(parseFloat(r.tauxHoraire)||0);}
  else if(type==='cf'){const r=p.chargesFixes[i]||{};const m=parseFloat(r.montant)||0,rep=parseFloat(r.repartition)||0;val=rep>0?m*rep/100:m;}
  else if(type==='emb'){const r=p.emballages[i]||{};val=(parseFloat(r.qte)||0)*(parseFloat(r.prixUnit)||0);}
  else if(type==='liv'){const r=p.livraison[i]||{};val=(parseFloat(r.montant)||0)/(parseFloat(p.quantiteProduites)||1);}
  const pill=document.getElementById('pill-'+type+'-'+i);
  if(pill)pill.textContent=fmtE(val)+(type==='liv'?'/unitÃ©':'');
}

function refreshFiche(id){
  const p=_products[id];
  const d=calcDetails(p);
  const s=(eid,v)=>{const el=document.getElementById(eid);if(el)el.textContent=v;};
  const sc=(eid,v,cls)=>{const el=document.getElementById(eid);if(!el)return;el.textContent=v;el.className=`fk-value ${cls}`;};
  sc('fk-cr',fmtE(d.cr),'blue');
  sc('fk-pv',d.pv>0?fmtE(d.pv):'â€”','');
  sc('fk-marge',d.pv>0?fmtE(d.margeHT):'â€”',d.margeHT>=0?'positive':'negative');
  sc('fk-tx',d.pv>0?d.txMarge.toFixed(1)+'%':'â€”',d.txMarge>=30?'positive':d.txMarge>=10?'':'negative');
  s('tot-ingr',fmtE(d.ingr));s('tot-mo',fmtE(d.mo));s('tot-cf',fmtE(d.cf));s('tot-emb',fmtE(d.emb));s('tot-liv',fmtE(d.liv));
  const pmCalc=document.getElementById('pv-marge-calc');
  if(pmCalc)pmCalc.textContent=d.pv>0?`Marge : ${fmtE(d.margeHT)} (${d.txMarge.toFixed(1)}%)`:'Saisissez votre prix de vente';
  const pvTtc=document.getElementById('pv-ttc-calc');
  if(pvTtc)pvTtc.textContent=d.pv>0?`Prix TTC : ${fmtE(d.pvTTC)}`:'â€”';
  const pvttc=document.getElementById('fk-pvttc');
  if(pvttc)pvttc.textContent=d.pv>0?fmtE(d.pvTTC):'â€”';

  // Re-render les cost-pills dans chaque tableau (pour mettre Ã  jour les totaux par ligne)
  // On re-render seulement les spans .cost-pill sans dÃ©truire les inputs
  _refreshCostPills('ingr-tbody', p.ingredients, (r)=>(parseFloat(r.qte)||0)*(parseFloat(r.prixUnitaire)||0));
  _refreshCostPills('mo-tbody',   p.mainOeuvre,  (r)=>(parseFloat(r.heures)||0)*(parseFloat(r.tauxHoraire)||0));
  _refreshCostPills('cf-tbody',   p.chargesFixes,(r)=>{const m=parseFloat(r.montant)||0,rep=parseFloat(r.repartition)||0;return rep>0?m*rep/100:m;});
  _refreshCostPills('emb-tbody',  p.emballages,  (r)=>(parseFloat(r.qte)||0)*(parseFloat(r.prixUnit)||0));
  _refreshCostPills('liv-tbody',  p.livraison,   (r)=>(parseFloat(r.montant)||0)/(parseFloat(p.quantiteProduites)||1));

  renderCatalogueItem(id);
}

function _refreshCostPills(tbodyId, rows, calcFn){
  const tb=document.getElementById(tbodyId);
  if(!tb||!rows)return;
  const pills=tb.querySelectorAll('.cost-pill');
  rows.forEach((r,i)=>{
    if(pills[i])pills[i].textContent=fmtE(calcFn(r));
  });
}

function renderCatalogueItem(id){
  const p=_products[id];
  const cr=calcCoutRevient(p);
  const el=document.querySelector(`.product-item[onclick="openProduct('${id}')"] .product-cr`);
  if(el)el.textContent=cr>0?fmtE(cr):'';
}

function updateField(id,field,value){
  if(!_products[id])return;
  _products[id][field]=value;
  refreshFiche(id);
}

function updatePrixVente(id,value){
  _products[id].prixVente=value;
  refreshFiche(id);
}

// â”€â”€ ADD / DEL ROWS â”€â”€
function addIngredient(id){
  _products[id].ingredients.push({nom:'',qte:'',unite:'g',prixUnitaire:''});
  const tb=document.getElementById('ingr-tbody');
  tb.innerHTML=renderIngredients(_products[id].ingredients,id);
  refreshFiche(id);
  // Focus sur le nom de la derniÃ¨re ligne
  const inputs=tb.querySelectorAll('input[placeholder="Beurre, farine..."]');
  if(inputs.length)inputs[inputs.length-1].focus();
}
function addMO(id){
  _products[id].mainOeuvre.push({description:'',heures:'',tauxHoraire:''});
  const tb=document.getElementById('mo-tbody');
  tb.innerHTML=renderMO(_products[id].mainOeuvre,id);
  refreshFiche(id);
  const inputs=tb.querySelectorAll('input[placeholder="Fabrication, montage..."]');
  if(inputs.length)inputs[inputs.length-1].focus();
}
function addCF(id){
  _products[id].chargesFixes.push({description:'',montant:'',repartition:''});
  const tb=document.getElementById('cf-tbody');
  tb.innerHTML=renderCF(_products[id].chargesFixes,id);
  refreshFiche(id);
  const inputs=tb.querySelectorAll('input[placeholder="Loyer, Ã©lectricitÃ©..."]');
  if(inputs.length)inputs[inputs.length-1].focus();
}
function addEmb(id){
  _products[id].emballages.push({description:'',qte:'',prixUnit:''});
  const tb=document.getElementById('emb-tbody');
  tb.innerHTML=renderEmb(_products[id].emballages,id);
  refreshFiche(id);
  const inputs=tb.querySelectorAll('input[placeholder="BoÃ®te, sachet..."]');
  if(inputs.length)inputs[inputs.length-1].focus();
}
function addLiv(id){
  _products[id].livraison.push({description:'',montant:''});
  const tb=document.getElementById('liv-tbody');
  tb.innerHTML=renderLiv(_products[id].livraison,id);
  refreshFiche(id);
  const inputs=tb.querySelectorAll('input[placeholder="Transporteur, carburant..."]');
  if(inputs.length)inputs[inputs.length-1].focus();
}

function delRow(id,section,i){
  _products[id][section].splice(i,1);
  const tbodyMap={ingredients:'ingr-tbody',mainOeuvre:'mo-tbody',chargesFixes:'cf-tbody',emballages:'emb-tbody',livraison:'liv-tbody'};
  const renderers={ingredients:renderIngredients,mainOeuvre:renderMO,chargesFixes:renderCF,emballages:renderEmb,livraison:renderLiv};
  const tb=document.getElementById(tbodyMap[section]);
  if(tb)tb.innerHTML=renderers[section](_products[id][section],id);
  refreshFiche(id);
}

// â”€â”€ EMOJI â”€â”€
function toggleEmojiPicker(id){
  const ep=document.getElementById('emojiPicker');
  ep.classList.toggle('show');
  if(ep.classList.contains('show')){
    ep.style.top=(document.querySelector('.fiche-emoji-btn').getBoundingClientRect().bottom+window.scrollY+4)+'px';
    ep.style.left=(document.querySelector('.fiche-emoji-btn').getBoundingClientRect().left)+'px';
    ep.querySelectorAll('.ep-btn').forEach(btn=>{
      btn.onclick=()=>{
        _products[id].emoji=btn.textContent;
        document.querySelector('.fiche-emoji-btn').textContent=btn.textContent;
        ep.classList.remove('show');
      };
    });
  }
}
document.addEventListener('click',e=>{if(!e.target.closest('.fiche-emoji-btn')&&!e.target.closest('#emojiPicker'))document.getElementById('emojiPicker').classList.remove('show');});

// â”€â”€ SAVE / DELETE â”€â”€

async function saveProduct(id){
  if(!window._uid)return;
  try{
    await window._setDoc(window._doc(window._db,'produits',window._uid,'items',id),JSON.parse(JSON.stringify(_products[id])));
    showToast('âœ… Produit sauvegardÃ© !','success');
    renderCatalogue();
  }catch(e){showToast('Erreur de sauvegarde','warning');console.error(e);}
}

async function deleteProduct(id){
  if(!confirm('Supprimer ce produit ?'))return;
  try{
    await window._deleteDoc(window._doc(window._db,'produits',window._uid,'items',id));
    delete _products[id];
    _currentId=null;
    renderCatalogue();
    document.getElementById('rightPanel').innerHTML=`<div class="fiche-empty"><div class="fiche-empty-icon">ğŸ—‘</div><h3>Produit supprimÃ©</h3><p>SÃ©lectionnez ou crÃ©ez un nouveau produit.</p></div>`;
    showToast('Produit supprimÃ©','warning');
  }catch(e){console.error(e);}
}

// â”€â”€ NEW PRODUCT MODAL â”€â”€
let _newType='recette';
function openNewProduct(){document.getElementById('newProductModal').classList.add('show');}
function closeModal(){document.getElementById('newProductModal').classList.remove('show');}
function selectType(type,el){
  _newType=type;
  document.querySelectorAll('.type-card').forEach(c=>c.classList.remove('selected'));
  el.classList.add('selected');
}
function createProduct(){
  const name=document.getElementById('newName').value.trim();
  if(!name){document.getElementById('newName').focus();return;}
  const cat=document.getElementById('newCat').value.trim();
  const id='prod_'+Date.now();
  _products[id]={...defaultProduct(_newType),nom:name,categorie:cat};
  closeModal();
  document.getElementById('newName').value='';
  document.getElementById('newCat').value='';
  renderCatalogue();
  openProduct(id);
  showToast('Produit crÃ©Ã© â€” pensez Ã  sauvegarder !');
}

// â”€â”€ UTILS â”€â”€
function fmtE(n){return (parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' â‚¬';}
function showToast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(()=>t.className='toast',3200);}

// Expose globals
window.toggleMenu=toggleMenu;window.handleLogout=handleLogout;
window.openProduct=openProduct;window.openNewProduct=openNewProduct;
window.closeModal=closeModal;window.createProduct=createProduct;window.selectType=selectType;
window.filterProducts=filterProducts;window.toggleCat=toggleCat;window.toggleSection=toggleSection;
window.updateField=updateField;window.updatePrixVente=updatePrixVente;window.refreshFiche=refreshFiche;
window.updateRowCost=updateRowCost;window.addIngredient=addIngredient;window.addMO=addMO;window.addCF=addCF;window.addEmb=addEmb;window.addLiv=addLiv;
window.delRow=delRow;window.saveProduct=saveProduct;window.deleteProduct=deleteProduct;
window.toggleEmojiPicker=toggleEmojiPicker;
</script>

<script>
function toggleNav(subId, el) {
  const sub = document.getElementById(subId);
  const isOpen = sub.classList.contains('open');
  sub.classList.toggle('open');
  // rotate chevron
  const chevId = subId === 'kpis-sub' ? 'chev-kpis' : 'chev-pil';
  const chev = document.getElementById(chevId);
  if (chev) chev.style.transform = isOpen ? '' : 'rotate(90deg)';
}
function activatePage(pageId, openSub) {
  const el = document.getElementById(pageId);
  if (el) el.classList.add('on');
  if (openSub) {
    const sub = document.getElementById(openSub);
    if (sub) sub.classList.add('open');
    const chevId = openSub === 'kpis-sub' ? 'chev-kpis' : 'chev-pil';
    const chev = document.getElementById(chevId);
    if (chev) chev.style.transform = 'rotate(90deg)';
  }
}
</script>
<script>document.addEventListener('DOMContentLoaded',()=>activatePage('nav-cout','kpis-sub'));</script>



<script>
(function(){
  function toggleSidebar(){
    var nav = document.querySelector('nav, aside.sidebar, .sidebar');
    var btn = document.getElementById('hamburger');
    var overlay = document.getElementById('navOverlay');
    var isOpen = nav.classList.contains('open');
    if(isOpen){ closeSidebar(); return; }
    nav.classList.add('open');
    btn.classList.add('open');
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
  function closeSidebar(){
    var nav = document.querySelector('nav, aside.sidebar, .sidebar');
    var btn = document.getElementById('hamburger');
    var overlay = document.getElementById('navOverlay');
    nav.classList.remove('open');
    btn.classList.remove('open');
    overlay.classList.remove('show');
    document.body.style.overflow = '';
  }
  window.toggleSidebar = toggleSidebar;
  window.closeSidebar = closeSidebar;
  document.addEventListener('DOMContentLoaded', function(){
    var nav = document.querySelector('nav, aside.sidebar, .sidebar');
    if(!nav) return;
    nav.querySelectorAll('.ni, .si, .nav-item, .sub-item').forEach(function(el){
      el.addEventListener('click', function(){
        if(window.innerWidth <= 768) closeSidebar();
      });
    });
  });
})();
</script>
<script>
(function(){
  function getSidebar(){ return document.querySelector('nav, aside.sidebar, .sidebar'); }
  function toggleSidebar(){
    var s=getSidebar(), b=document.getElementById('hamburger'), o=document.getElementById('navOverlay');
    var open=s.classList.contains('open');
    s.classList.toggle('open',!open); b.classList.toggle('open',!open);
    o.classList.toggle('show',!open);
    document.body.style.overflow = open ? '' : 'hidden';
  }
  function closeSidebar(){
    var s=getSidebar(), b=document.getElementById('hamburger'), o=document.getElementById('navOverlay');
    s.classList.remove('open'); b.classList.remove('open'); o.classList.remove('show');
    document.body.style.overflow='';
  }
  window.toggleSidebar=toggleSidebar; window.closeSidebar=closeSidebar;
  document.addEventListener('DOMContentLoaded',function(){
    var s=getSidebar(); if(!s) return;
    s.querySelectorAll('.ni,.si,.nav-item,.sub-item').forEach(function(el){
      el.addEventListener('click',function(){ if(window.innerWidth<=768) closeSidebar(); });
    });
  });
})();
</script>
<script>
function toggleFidNav(el){
  var sub=el.nextElementSibling;
  var chev=el.querySelector('.nav-chev');
  var open=sub.style.maxHeight&&sub.style.maxHeight!=='0px';
  sub.style.maxHeight=open?'0px':'300px';
  if(chev)chev.style.transform=open?'':'rotate(90deg)';
}
</script>
<script src="nav.js"></script>

</body>
</html>
