<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE â€” ParamÃ¨tres RH</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --rh-dark:#052e16;--rh-main:#059669;--rh-mid:#10b981;--rh-bright:#34d399;
      --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f5f7ff;
      --sidebar-w:252px;--radius:12px;
      --red:#ef4444;--orange:#f59e0b;--blue:#3b82f6;--purple:#6366f1;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}

    /* SIDEBAR */
    .sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#052e16 0%,#064e23 50%,#065f2c 100%);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;overflow-y:auto;}
    .sidebar-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 22px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:10px;}
    .sidebar-logo-icon{width:36px;height:36px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .sidebar-logo-text{font-size:18px;font-weight:800;color:white;letter-spacing:1px;}
    .nav-item{display:flex;align-items:center;gap:11px;padding:10px 20px;color:rgba(255,255,255,0.6);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;}
    .nav-item:hover{color:white;background:rgba(255,255,255,0.06);}
    .nav-item.active{color:white;background:rgba(255,255,255,0.1);border-left-color:#34d399;}
    .nav-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0;}
    .sidebar-footer{margin-top:auto;padding:16px 20px 0;border-top:1px solid rgba(255,255,255,0.08);}
    .user-card{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.07);border-radius:10px;}
    .user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--rh-mid),#059669);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
    .user-name{font-size:12px;font-weight:600;color:white;}
    .user-plan{font-size:10px;color:rgba(255,255,255,0.4);}
    .logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:14px;padding:4px;}

    /* MAIN */
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:17px;font-weight:700;}
    .topbar-left p{font-size:12px;color:var(--muted);}
    .topbar-right{display:flex;align-items:center;gap:10px;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.18s;}
    .btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-mid));color:white;box-shadow:0 3px 10px rgba(5,150,105,.25);}
    .btn-rh:hover{opacity:.9;transform:translateY(-1px);}
    .btn-outline{background:white;color:var(--rh-main);border:1.5px solid var(--rh-border);}
    .btn-outline:hover{border-color:var(--rh-main);background:var(--rh-ghost);}
    .btn-sm{padding:5px 12px;font-size:12px;}
    .btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}

    /* CONTENT */
    .content{padding:24px 28px;flex:1;display:flex;flex-direction:column;gap:20px;max-width:900px;}

    /* SECTIONS */
    .params-section{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .ps-head{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:var(--rh-ghost);border-bottom:1px solid var(--rh-border);}
    .ps-title{font-size:13px;font-weight:700;color:var(--rh-dark);display:flex;align-items:center;gap:8px;}
    .ps-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;background:var(--rh-border);color:var(--rh-dark);}
    .ps-body{padding:20px;}

    /* FORM */
    .param-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;}
    .param-row.full{grid-template-columns:1fr;}
    .param-field{display:flex;flex-direction:column;gap:5px;}
    .param-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
    .param-hint{font-size:10px;color:var(--muted);margin-top:2px;line-height:1.4;}
    .pinput{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;background:white;transition:border-color .15s;}
    .pinput:focus{border-color:var(--rh-main);box-shadow:0 0 0 3px rgba(5,150,105,.08);}
    select.pinput{cursor:pointer;}

    /* CCN CARD */
    .ccn-card{border:2px solid var(--rh-border);border-radius:10px;padding:14px 16px;background:var(--rh-ghost);margin-top:10px;display:none;}
    .ccn-card.show{display:block;}
    .ccn-title{font-size:12px;font-weight:700;color:var(--rh-dark);margin-bottom:8px;display:flex;align-items:center;gap:6px;}
    .ccn-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:10px;}
    .ccn-kpi{background:white;border:1px solid var(--rh-border);border-radius:8px;padding:10px;text-align:center;}
    .ccn-kpi-val{font-size:18px;font-weight:800;color:var(--rh-main);}
    .ccn-kpi-lbl{font-size:10px;color:var(--muted);margin-top:2px;}
    .ccn-note{font-size:11px;color:var(--muted);line-height:1.5;padding:8px 10px;background:white;border-radius:6px;border:1px solid var(--rh-border);}

    /* HORAIRES */
    .horaires-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;}
    .jour-card{background:#f8faff;border:1.5px solid var(--border);border-radius:8px;padding:10px;text-align:center;transition:all .15s;}
    .jour-card.actif{border-color:var(--rh-main);background:var(--rh-ghost);}
    .jour-label{font-size:10px;font-weight:700;color:var(--muted);margin-bottom:6px;text-transform:uppercase;}
    .jour-toggle{width:32px;height:18px;border-radius:9px;border:none;cursor:pointer;transition:background .2s;margin-bottom:6px;}
    .jour-toggle.on{background:var(--rh-main);}
    .jour-toggle.off{background:#d1d5db;}
    .jour-time{font-size:11px;font-weight:600;color:var(--text);display:flex;flex-direction:column;gap:3px;}
    .time-input{width:100%;padding:3px 4px;border:1px solid var(--border);border-radius:4px;font-size:11px;font-family:inherit;text-align:center;color:var(--text);outline:none;}
    .time-input:focus{border-color:var(--rh-main);}
    .time-input:disabled{background:#f1f5f9;color:var(--muted);}

    /* ALERTES */
    .alert-list{display:flex;flex-direction:column;gap:10px;}
    .alert-item{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border:1.5px solid var(--border);border-radius:8px;background:#f8faff;}
    .alert-item.active{border-color:var(--rh-main);background:var(--rh-ghost);}
    .alert-left{display:flex;align-items:center;gap:10px;}
    .alert-icon{font-size:20px;flex-shrink:0;}
    .alert-info .alert-name{font-size:12px;font-weight:700;color:var(--text);}
    .alert-info .alert-desc{font-size:11px;color:var(--muted);margin-top:1px;}
    .toggle-switch{position:relative;width:40px;height:22px;flex-shrink:0;}
    .toggle-switch input{opacity:0;width:0;height:0;}
    .toggle-slider{position:absolute;inset:0;background:#d1d5db;border-radius:11px;cursor:pointer;transition:.2s;}
    .toggle-slider:before{content:'';position:absolute;width:16px;height:16px;left:3px;top:3px;background:white;border-radius:50%;transition:.2s;}
    .toggle-switch input:checked+.toggle-slider{background:var(--rh-main);}
    .toggle-switch input:checked+.toggle-slider:before{transform:translateX(18px);}

    /* SEUILS */
    .seuil-row{display:flex;align-items:center;gap:12px;padding:8px 0;border-bottom:1px solid #f1f5f9;}
    .seuil-row:last-child{border-bottom:none;}
    .seuil-label{flex:1;font-size:12px;color:var(--text);}
    .seuil-input{width:70px;padding:5px 8px;border:1.5px solid var(--border);border-radius:6px;font-family:inherit;font-size:12px;font-weight:700;text-align:center;outline:none;}
    .seuil-input:focus{border-color:var(--rh-main);}
    .seuil-unit{font-size:11px;color:var(--muted);width:40px;}

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.ok{background:var(--rh-main);}
    .toast.err{background:var(--red);}

    /* SAVE BAR */
    .save-bar{position:sticky;bottom:0;background:white;border-top:1px solid var(--border);padding:12px 28px;display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:auto;}
    .save-hint{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:6px;}
    .save-hint.modified{color:var(--orange);font-weight:600;}

    /* LOADER */
    .loader{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--muted);gap:10px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--rh-main);border-radius:50%;animation:spin .7s linear infinite;}

    /* HAMBURGER + MOBILE */
    .hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:#052e16;border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(5,46,22,.45);}
    .hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;}
    .nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;}
    .nav-overlay.show{display:block;}
    @media(max-width:768px){
      .hamburger{display:flex!important;}
      .sidebar{position:fixed!important;top:0!important;left:0!important;height:100vh!important;width:min(280px,84vw)!important;z-index:1001!important;transform:translateX(-105%)!important;transition:transform .3s cubic-bezier(.4,0,.2,1)!important;}
      .sidebar.open{transform:translateX(0)!important;box-shadow:8px 0 32px rgba(0,0,0,.3)!important;}
      .main{margin-left:0!important;}
      .topbar{padding:10px 10px 10px 62px!important;}
      .content{padding:14px 12px!important;}
      .param-row{grid-template-columns:1fr!important;}
      .horaires-grid{grid-template-columns:repeat(4,1fr)!important;}
      .ccn-grid{grid-template-columns:1fr 1fr!important;}
    }
  </style>
</head>
<body>

<button class="hamburger" id="hamburger-btn" onclick="toggleSidebar()">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="nav-overlay" onclick="closeSidebar()"></div>

<!-- SIDEBAR injectÃ©e par nav.js -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>âš™ï¸ ParamÃ¨tres RH</h1>
      <p>Configuration de votre entreprise â€” convention collective, horaires, alertes lÃ©gales</p>
    </div>
    <div class="topbar-right">
      <a href="rh-dashboard.html" class="btn btn-outline btn-sm">â† Tableau de bord RH</a>
    </div>
  </div>

  <div class="content" id="main-content">
    <div class="loader"><div class="spin"></div><span>Chargement des paramÃ¨tresâ€¦</span></div>
  </div>

  <!-- SAVE BAR -->
  <div class="save-bar">
    <div class="save-hint" id="save-hint">ğŸ’¾ Vos modifications seront sauvegardÃ©es dans Firebase</div>
    <div style="display:flex;gap:10px">
      <button class="btn btn-outline btn-sm" onclick="loadParams()">â†º RÃ©initialiser</button>
      <button class="btn btn-rh" onclick="saveParams()">ğŸ’¾ Enregistrer les paramÃ¨tres</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth=getAuth(app);
  const db=getFirestore(app);
  window._auth=auth;window._db=db;
  window._doc=doc;window._getDoc=getDoc;window._setDoc=setDoc;
  window._signOut=signOut;
  onAuthStateChanged(auth,user=>{
    if(!user){window.location.href='index.html';return;}
    window._uid=user.uid;
    const name=user.displayName||user.email.split('@')[0];
    ['uname','uname2'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=name;});
    ['av','av2'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=name.charAt(0).toUpperCase();});
    window._firebaseReady=true;
    window.initParams();
  });
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONVENTIONS COLLECTIVES â€” copie partagÃ©e de rh-planning.html
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CCN_RULES = {
  'droit_commun':       {label:'Code du travail',                    idcc:null,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'Art. L3121-18 : 10h/j max Â· Art. L3121-20 : 48h/sem Â· Art. L3121-33 : pause 20 min aprÃ¨s 6h'},
  'chr':                {label:'HÃ´tels-CafÃ©s-Restaurants (CHR)',      idcc:1979,  jourMax:11.5, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 1979 Â· Amplitude 13h max Â· Repos hebdo 2j consÃ©cutifs Â· HS majorÃ©es 10% dÃ¨s 36h'},
  'restauration_rapide':{label:'Restauration rapide',                 idcc:1501,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 1501 Â· Modulation annuelle possible Â· Temps partiel frÃ©quent'},
  'commerce':           {label:'Commerce de dÃ©tail non alimentaire',  idcc:1517,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 1517 Â· Modulation Â· Dimanche exceptionnel possible'},
  'commerce_alimentaire':{label:'Commerce alimentaire (supermarchÃ©s)',idcc:2216,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 2216 Â· Travail dominical frÃ©quent'},
  'grande_distribution':{label:'Grande distribution',                 idcc:2216,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 2216 Â· Amplitude max 12h'},
  'boulangerie':        {label:'Boulangerie-PÃ¢tisserie artisanale',   idcc:843,   jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 843 Â· Travail de nuit courant Â· Majoration nuit +25%'},
  'patisserie':         {label:'PÃ¢tisserie artisanale',               idcc:1267,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 1267 Â· Nuit possible Â· Dimanche majorÃ©'},
  'boucherie':          {label:'Boucherie-Charcuterie artisanale',    idcc:953,   jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 953 Â· Horaires tÃ´t le matin Â· Dimanche matin courant'},
  'btp':                {label:'BÃ¢timent (BTP ouvriers)',             idcc:1597,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 1597 Â· Modulation annuelle Â· IntempÃ©ries Â· Grand dÃ©placement'},
  'btp_etam':           {label:'BTP â€” ETAM',                         idcc:2609,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 2609 Â· Forfait jours possible pour cadres Â· RTT'},
  'coiffure':           {label:'Coiffure',                            idcc:2596,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 2596 Â· Repos dimanche + 1 autre jour'},
  'esthetique':         {label:'EsthÃ©tique-CosmÃ©tique-Parfumerie',    idcc:3032,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 3032 Â· Temps partiel frÃ©quent'},
  'sante':              {label:'SantÃ© (FEHAP / EHPAD)',               idcc:29,    jourMax:12,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 29 Â· Gardes 12h autorisÃ©es Â· Cycles de travail'},
  'cabinet_medical':    {label:'Cabinet mÃ©dical / Para-mÃ©dical',      idcc:1748,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 1748 Â· Fermeture mercredi AM souvent'},
  'pharmacie':          {label:"Pharmacie d'officine",                idcc:1996,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 1996 Â· Gardes dimanche/nuit par roulement'},
  'nettoyage':          {label:'Nettoyage et services associÃ©s',      idcc:3043,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 3043 Â· Horaires dÃ©calÃ©s Â· Multi-sites Â· Temps partiel trÃ¨s courant'},
  'transport_routier':  {label:'Transport routier (conducteurs)',     idcc:16,    jourMax:10,   hebdoMax:56, hebdoMoyMax:48, reposMin:11, pauseApres:4.5, pauseMin:45, note:'IDCC 16 Â· RÃ¨glement CE 561/2006 : pause 45 min aprÃ¨s 4h30 Â· 56h/sem max'},
  'transport_voyageurs':{label:'Transport en commun (conducteurs)',   idcc:1424,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 1424 Â· Amplitude journaliÃ¨re max 13h'},
  'automobile':         {label:"Services de l'automobile",            idcc:1090,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 1090 Â· Modulation Â· Samedi travaillÃ© courant'},
  'immobilier':         {label:'Immobilier / Agences',                idcc:1527,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 1527 Â· Forfait jours pour nÃ©gociateurs'},
  'securite':           {label:'PrÃ©vention-SÃ©curitÃ© privÃ©e',          idcc:1351,  jourMax:12,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 1351 Â· Vacation max 12h Â· Repos minimum 12h entre vacations'},
  'agriculture':        {label:'Agriculture / Exploitations agricoles',idcc:7024, jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 7024 Â· Modulation saisonniÃ¨re'},
  'viticulture':        {label:'Viticulture',                         idcc:9111,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 9111 Â· Vendanges : modulation spÃ©cifique'},
  'sap':                {label:'Services Ã  la personne (SAP)',        idcc:3127,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 3127 Â· Interventions courtes Â· DÃ©placements comptabilisÃ©s'},
  'aide_domicile':      {label:'Aide Ã  domicile (associations)',      idcc:2941,  jourMax:10,   hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6,   pauseMin:20, note:'IDCC 2941 Â· Astreintes Â· Amplitude 13h possible'},
};

const CCN_GROUPS = [
  {label:'ğŸ“„ Droit commun',             keys:['droit_commun']},
  {label:'ğŸ½ï¸ HÃ´tellerie / Restauration',keys:['chr','restauration_rapide']},
  {label:'ğŸ›’ Commerce / Distribution',  keys:['commerce','commerce_alimentaire','grande_distribution']},
  {label:'ğŸ¥– Alimentation artisanale',  keys:['boulangerie','patisserie','boucherie']},
  {label:'ğŸ—ï¸ BTP / Artisanat',          keys:['btp','btp_etam']},
  {label:'ğŸ’‡ Coiffure / EsthÃ©tique',    keys:['coiffure','esthetique']},
  {label:'ğŸ¥ SantÃ© / MÃ©dico-social',    keys:['sante','cabinet_medical','pharmacie']},
  {label:'ğŸ§¹ Nettoyage / PropretÃ©',     keys:['nettoyage']},
  {label:'ğŸš› Transport',                keys:['transport_routier','transport_voyageurs']},
  {label:'ğŸš— Automobile',               keys:['automobile']},
  {label:'ğŸ  Immobilier',               keys:['immobilier']},
  {label:'ğŸ”’ SÃ©curitÃ©',                 keys:['securite']},
  {label:'ğŸŒ¾ Agriculture',              keys:['agriculture','viticulture']},
  {label:'ğŸ¤ Services Ã  la personne',   keys:['sap','aide_domicile']},
];

// â•â• Ã‰TAT â•â•
let _params = {};
let _modified = false;

const JOURS = ['lundi','mardi','mercredi','jeudi','vendredi','samedi','dimanche'];
const JOURS_LABEL = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];

const DEFAULT_HORAIRES = {
  lundi:    {actif:true,  deb:'08:00',fin:'18:00'},
  mardi:    {actif:true,  deb:'08:00',fin:'18:00'},
  mercredi: {actif:true,  deb:'08:00',fin:'18:00'},
  jeudi:    {actif:true,  deb:'08:00',fin:'18:00'},
  vendredi: {actif:true,  deb:'08:00',fin:'18:00'},
  samedi:   {actif:false, deb:'09:00',fin:'13:00'},
  dimanche: {actif:false, deb:'',     fin:''},
};

window.initParams = async function() {
  await loadParams();
};

async function loadParams() {
  try {
    const snap = await window._getDoc(window._doc(window._db,'rh_params',window._uid));
    _params = snap.exists() ? snap.data() : {};
  } catch(e) {
    console.warn(e);
    _params = {};
  }
  renderParams();
  _modified = false;
  updateSaveHint();
}

function renderParams() {
  const c = document.getElementById('main-content');
  const ccnDefault = _params.ccnDefault||'droit_commun';
  const horaires = _params.horaires || DEFAULT_HORAIRES;
  const alertes = _params.alertes || {reposShift:true, jourMax:true, pause:true, hebdoMax:true, contratExpire:true, essaiExpire:true};
  const seuils = _params.seuils || {reposMin:11, jourMax:10, hebdoMax:48, pauseApres:6, pauseMin:20, joursAvantExpiration:30};

  c.innerHTML = `

    <!-- SECTION 1 : ENTREPRISE & CCN -->
    <div class="params-section">
      <div class="ps-head">
        <div class="ps-title">âš–ï¸ Convention collective par dÃ©faut <span class="ps-badge">Entreprise</span></div>
      </div>
      <div class="ps-body">
        <div class="param-row">
          <div class="param-field">
            <label class="param-label">Raison sociale</label>
            <input class="pinput" id="p-raison" placeholder="Ma Boutique SAS" value="${_params.raisonSociale||''}" oninput="markModified()"/>
            <div class="param-hint">Nom affichÃ© dans les exports PDF et les documents RH</div>
          </div>
          <div class="param-field">
            <label class="param-label">SIRET</label>
            <input class="pinput" id="p-siret" placeholder="123 456 789 00012" value="${_params.siret||''}" oninput="markModified()"/>
          </div>
        </div>
        <div class="param-row">
          <div class="param-field">
            <label class="param-label">Code APE / NAF</label>
            <input class="pinput" id="p-ape" placeholder="4711F" value="${_params.codeAPE||''}" oninput="markModified()"/>
            <div class="param-hint">UtilisÃ© pour dÃ©terminer automatiquement la CCN applicable</div>
          </div>
          <div class="param-field">
            <label class="param-label">Effectif</label>
            <select class="pinput" id="p-effectif" onchange="markModified()">
              <option value="">SÃ©lectionnerâ€¦</option>
              <option value="1-9" ${_params.effectif==='1-9'?'selected':''}>TPE : 1 Ã  9 salariÃ©s</option>
              <option value="10-49" ${_params.effectif==='10-49'?'selected':''}>PME : 10 Ã  49 salariÃ©s</option>
              <option value="50-249" ${_params.effectif==='50-249'?'selected':''}>ETI : 50 Ã  249 salariÃ©s</option>
              <option value="250+" ${_params.effectif==='250+'?'selected':''}>Grande entreprise : 250+</option>
            </select>
          </div>
        </div>

        <div style="border-top:1px solid var(--border);margin:16px 0 14px;padding-top:14px">
          <div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:12px">
            Convention collective applicable Ã  toute l'entreprise
            <span style="font-size:11px;font-weight:400;color:var(--muted);margin-left:6px">â€” peut Ãªtre surchargÃ©e par employÃ© dans sa fiche</span>
          </div>
          <div class="param-row full">
            <div class="param-field">
              <label class="param-label">Convention collective par dÃ©faut</label>
              <select class="pinput" id="p-ccn" onchange="onCCNPreview()" style="font-weight:600">
                ${buildCCNOptions(ccnDefault)}
              </select>
            </div>
          </div>
          <div class="ccn-card ${ccnDefault?'show':''}" id="ccn-preview-card">
            ${ccnDefault ? renderCCNPreview(ccnDefault) : ''}
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 2 : HORAIRES D'OUVERTURE -->
    <div class="params-section">
      <div class="ps-head">
        <div class="ps-title">ğŸ• Horaires d'ouverture de l'Ã©tablissement <span class="ps-badge">Planning</span></div>
      </div>
      <div class="ps-body">
        <div style="font-size:12px;color:var(--muted);margin-bottom:14px">Ces horaires servent de rÃ©fÃ©rence pour la gÃ©nÃ©ration automatique du planning par IA et pour la dÃ©tection d'anomalies.</div>
        <div class="horaires-grid" id="horaires-grid">
          ${JOURS.map((j,i) => {
            const h = horaires[j] || {actif:false,deb:'',fin:''};
            return `<div class="jour-card ${h.actif?'actif':''}" id="jcard-${j}">
              <div class="jour-label">${JOURS_LABEL[i]}</div>
              <button class="jour-toggle ${h.actif?'on':'off'}" id="jtog-${j}" onclick="toggleJour('${j}')"></button>
              <div class="jour-time" id="jtime-${j}" style="${h.actif?'':'opacity:.35;pointer-events:none'}">
                <input class="time-input" id="jdeb-${j}" type="time" value="${h.deb||''}" ${!h.actif?'disabled':''} oninput="markModified()"/>
                <input class="time-input" id="jfin-${j}" type="time" value="${h.fin||''}" ${!h.actif?'disabled':''} oninput="markModified()"/>
              </div>
            </div>`;
          }).join('')}
        </div>
        <div style="margin-top:12px;padding:10px 14px;background:#f8faff;border-radius:8px;font-size:11px;color:var(--muted)">
          ğŸ’¡ L'IA de gÃ©nÃ©ration de planning respectera ces plages horaires et n'affectera pas de crÃ©neaux en dehors.
        </div>
      </div>
    </div>

    <!-- SECTION 3 : SEUILS LÃ‰GAUX PERSONNALISÃ‰S -->
    <div class="params-section">
      <div class="ps-head">
        <div class="ps-title">ğŸ“ Seuils lÃ©gaux personnalisÃ©s <span class="ps-badge">ContrÃ´le</span></div>
      </div>
      <div class="ps-body">
        <div style="font-size:12px;color:var(--muted);margin-bottom:14px">Ces seuils s'appliquent en substitution de ceux de la CCN si vous les personnalisez (accords d'entreprise, dÃ©rogations, etc.).</div>
        <div class="seuil-row">
          <div class="seuil-label"><b>Repos minimum entre deux shifts</b><div style="font-size:10px;color:var(--muted)">Code du travail : 11h Â· Certaines CCN permettent 9h sur accord</div></div>
          <input class="seuil-input" id="s-repos" type="number" min="8" max="12" step="0.5" value="${seuils.reposMin||11}" oninput="markModified()"/>
          <div class="seuil-unit">heures</div>
        </div>
        <div class="seuil-row">
          <div class="seuil-label"><b>DurÃ©e maximale journaliÃ¨re</b><div style="font-size:10px;color:var(--muted)">Code du travail : 10h Â· DÃ©rogation possible jusqu'Ã  12h</div></div>
          <input class="seuil-input" id="s-jourmax" type="number" min="8" max="13" step="0.5" value="${seuils.jourMax||10}" oninput="markModified()"/>
          <div class="seuil-unit">heures</div>
        </div>
        <div class="seuil-row">
          <div class="seuil-label"><b>DurÃ©e maximale hebdomadaire absolue</b><div style="font-size:10px;color:var(--muted)">Code du travail : 48h Â· Transport routier : 56h</div></div>
          <input class="seuil-input" id="s-hebdomax" type="number" min="35" max="60" step="1" value="${seuils.hebdoMax||48}" oninput="markModified()"/>
          <div class="seuil-unit">heures</div>
        </div>
        <div class="seuil-row">
          <div class="seuil-label"><b>DÃ©clenchement de la pause obligatoire</b><div style="font-size:10px;color:var(--muted)">Code du travail : aprÃ¨s 6h continues de travail</div></div>
          <input class="seuil-input" id="s-pauseapres" type="number" min="3" max="8" step="0.5" value="${seuils.pauseApres||6}" oninput="markModified()"/>
          <div class="seuil-unit">heures</div>
        </div>
        <div class="seuil-row">
          <div class="seuil-label"><b>DurÃ©e minimale de la pause</b><div style="font-size:10px;color:var(--muted)">Code du travail : 20 min Â· Transport routier : 45 min</div></div>
          <input class="seuil-input" id="s-pausemin" type="number" min="10" max="60" step="5" value="${seuils.pauseMin||20}" oninput="markModified()"/>
          <div class="seuil-unit">min</div>
        </div>
        <div class="seuil-row">
          <div class="seuil-label"><b>Alerte expiration contrat/essai</b><div style="font-size:10px;color:var(--muted)">Nombre de jours avant la date de fin pour dÃ©clencher l'alerte</div></div>
          <input class="seuil-input" id="s-expir" type="number" min="7" max="90" step="1" value="${seuils.joursAvantExpiration||30}" oninput="markModified()"/>
          <div class="seuil-unit">jours</div>
        </div>
      </div>
    </div>

    <!-- SECTION 4 : ALERTES AUTOMATIQUES -->
    <div class="params-section">
      <div class="ps-head">
        <div class="ps-title">ğŸ”” Alertes automatiques <span class="ps-badge">Notifications</span></div>
      </div>
      <div class="ps-body">
        <div class="alert-list">
          ${renderAlertToggle('reposShift',  alertes, 'ğŸŒ™', 'Repos inter-shift insuffisant',     'Alerte si moins de ' + (seuils.reposMin||11) + 'h entre deux shifts d\'un mÃªme employÃ©')}
          ${renderAlertToggle('jourMax',     alertes, 'â°', 'DurÃ©e journaliÃ¨re dÃ©passÃ©e',        'Alerte si un employÃ© travaille plus de ' + (seuils.jourMax||10) + 'h dans la journÃ©e')}
          ${renderAlertToggle('pause',       alertes, 'â˜•', 'Pause obligatoire manquante',       'Alerte si aucune coupure de ' + (seuils.pauseMin||20) + ' min aprÃ¨s ' + (seuils.pauseApres||6) + 'h continues')}
          ${renderAlertToggle('hebdoMax',    alertes, 'ğŸ“…', 'DÃ©passement hebdomadaire',          'Alerte si un employÃ© dÃ©passe ' + (seuils.hebdoMax||48) + 'h planifiÃ©es dans la semaine')}
          ${renderAlertToggle('contratExpire',alertes,'ğŸ“„', 'Expiration de contrat CDD/Stage',  'Alerte ' + (seuils.joursAvantExpiration||30) + 'j avant la date de fin de contrat')}
          ${renderAlertToggle('essaiExpire', alertes, 'â³', "Fin de pÃ©riode d'essai",           'Alerte ' + (seuils.joursAvantExpiration||30) + 'j avant la fin de la pÃ©riode d\'essai')}
        </div>
      </div>
    </div>

    <!-- SECTION 5 : CONGÃ‰S & ABSENCES -->
    <div class="params-section">
      <div class="ps-head">
        <div class="ps-title">ğŸ–ï¸ CongÃ©s & absences <span class="ps-badge">Droits</span></div>
      </div>
      <div class="ps-body">
        <div class="param-row">
          <div class="param-field">
            <label class="param-label">Jours de CP lÃ©gaux / an</label>
            <input class="pinput" id="p-cpan" type="number" min="25" max="35" value="${_params.cpAnnuels||25}" oninput="markModified()"/>
            <div class="param-hint">Code du travail : 25 jours ouvrables (ou 30 jours ouvrÃ©s)</div>
          </div>
          <div class="param-field">
            <label class="param-label">Mode de dÃ©compte</label>
            <select class="pinput" id="p-cpmode" onchange="markModified()">
              <option value="ouvrables" ${(_params.cpMode||'ouvrables')==='ouvrables'?'selected':''}>Jours ouvrables (lun-sam, standard)</option>
              <option value="ouvres" ${_params.cpMode==='ouvres'?'selected':''}>Jours ouvrÃ©s (lun-ven)</option>
            </select>
          </div>
        </div>
        <div class="param-row">
          <div class="param-field">
            <label class="param-label">PÃ©riode de rÃ©fÃ©rence CP</label>
            <select class="pinput" id="p-cpperiode" onchange="markModified()">
              <option value="1juin" ${(_params.cpPeriode||'1juin')==='1juin'?'selected':''}>1er juin N â†’ 31 mai N+1 (standard)</option>
              <option value="1janv" ${_params.cpPeriode==='1janv'?'selected':''}>1er janvier â†’ 31 dÃ©cembre</option>
              <option value="exercice" ${_params.cpPeriode==='exercice'?'selected':''}>Exercice fiscal entreprise</option>
            </select>
          </div>
          <div class="param-field">
            <label class="param-label">RTT / an (si accord 35h)</label>
            <input class="pinput" id="p-rtt" type="number" min="0" max="25" value="${_params.rttAnnuels||0}" oninput="markModified()"/>
            <div class="param-hint">Laisser 0 si pas d'accord RTT dans votre entreprise</div>
          </div>
        </div>
      </div>
    </div>

  `;

  // Initialiser les previews CCN
  onCCNPreview();
}

function buildCCNOptions(currentVal) {
  return CCN_GROUPS.map(g =>
    `<optgroup label="${g.label}">${g.keys.map(k =>
      `<option value="${k}" ${k===currentVal?'selected':''}>${CCN_RULES[k]?.label||k}${CCN_RULES[k]?.idcc?' (IDCC '+CCN_RULES[k].idcc+')':''}</option>`
    ).join('')}</optgroup>`
  ).join('');
}

function renderCCNPreview(key) {
  const r = CCN_RULES[key];
  if(!r) return '';
  return `
    <div class="ccn-title">ğŸ“‹ ${r.label}${r.idcc?` <span style="font-size:10px;font-weight:400;color:var(--muted)">(IDCC ${r.idcc})</span>`:''}</div>
    <div class="ccn-grid">
      <div class="ccn-kpi"><div class="ccn-kpi-val">${r.jourMax}h</div><div class="ccn-kpi-lbl">Max journalier</div></div>
      <div class="ccn-kpi"><div class="ccn-kpi-val">${r.hebdoMax}h</div><div class="ccn-kpi-lbl">Max hebdo absolu</div></div>
      <div class="ccn-kpi"><div class="ccn-kpi-val">${r.pauseMin} min</div><div class="ccn-kpi-lbl">Pause aprÃ¨s ${r.pauseApres}h</div></div>
      <div class="ccn-kpi"><div class="ccn-kpi-val">${r.reposMin}h</div><div class="ccn-kpi-lbl">Repos inter-shift</div></div>
    </div>
    <div class="ccn-note">â„¹ï¸ ${r.note||''}</div>`;
}

function renderAlertToggle(key, alertes, icon, name, desc) {
  const checked = alertes[key] !== false;
  return `<div class="alert-item ${checked?'active':''}" id="alert-item-${key}">
    <div class="alert-left">
      <div class="alert-icon">${icon}</div>
      <div class="alert-info">
        <div class="alert-name">${name}</div>
        <div class="alert-desc">${desc}</div>
      </div>
    </div>
    <label class="toggle-switch">
      <input type="checkbox" ${checked?'checked':''} onchange="toggleAlert('${key}',this.checked)"/>
      <span class="toggle-slider"></span>
    </label>
  </div>`;
}

function onCCNPreview() {
  const sel = document.getElementById('p-ccn');
  const card = document.getElementById('ccn-preview-card');
  if(!sel || !card) return;
  const key = sel.value;
  if(key && CCN_RULES[key]) {
    card.classList.add('show');
    card.innerHTML = renderCCNPreview(key);
  } else {
    card.classList.remove('show');
  }
  markModified();
}

function toggleJour(j) {
  const tog = document.getElementById('jtog-'+j);
  const card = document.getElementById('jcard-'+j);
  const timeDiv = document.getElementById('jtime-'+j);
  const debInp = document.getElementById('jdeb-'+j);
  const finInp = document.getElementById('jfin-'+j);
  const isOn = tog.classList.contains('on');
  tog.classList.toggle('on', !isOn);
  tog.classList.toggle('off', isOn);
  card.classList.toggle('actif', !isOn);
  timeDiv.style.opacity = isOn ? '.35' : '1';
  timeDiv.style.pointerEvents = isOn ? 'none' : '';
  if(debInp) debInp.disabled = isOn;
  if(finInp) finInp.disabled = isOn;
  markModified();
}

function toggleAlert(key, checked) {
  const item = document.getElementById('alert-item-'+key);
  if(item) item.classList.toggle('active', checked);
  markModified();
}

function markModified() {
  _modified = true;
  updateSaveHint();
}

function updateSaveHint() {
  const el = document.getElementById('save-hint');
  if(!el) return;
  el.className = 'save-hint' + (_modified?' modified':'');
  el.textContent = _modified ? 'âš ï¸ Modifications non sauvegardÃ©es' : 'âœ… Tous les paramÃ¨tres sont Ã  jour';
}

async function saveParams() {
  if(!window._uid) return;
  // Collecter toutes les valeurs
  const ccnDefault = document.getElementById('p-ccn')?.value || 'droit_commun';

  // Horaires
  const horaires = {};
  JOURS.forEach(j => {
    const actif = document.getElementById('jtog-'+j)?.classList.contains('on') || false;
    horaires[j] = {
      actif,
      deb: document.getElementById('jdeb-'+j)?.value || '',
      fin: document.getElementById('jfin-'+j)?.value || '',
    };
  });

  // Seuils
  const seuils = {
    reposMin:              parseFloat(document.getElementById('s-repos')?.value) || 11,
    jourMax:               parseFloat(document.getElementById('s-jourmax')?.value) || 10,
    hebdoMax:              parseFloat(document.getElementById('s-hebdomax')?.value) || 48,
    pauseApres:            parseFloat(document.getElementById('s-pauseapres')?.value) || 6,
    pauseMin:              parseFloat(document.getElementById('s-pausemin')?.value) || 20,
    joursAvantExpiration:  parseInt(document.getElementById('s-expir')?.value) || 30,
  };

  // Alertes
  const alerteKeys = ['reposShift','jourMax','pause','hebdoMax','contratExpire','essaiExpire'];
  const alertes = {};
  alerteKeys.forEach(k => {
    const input = document.querySelector(`#alert-item-${k} input[type=checkbox]`);
    alertes[k] = input ? input.checked : true;
  });

  // CongÃ©s
  const data = {
    raisonSociale:  document.getElementById('p-raison')?.value.trim() || null,
    siret:          document.getElementById('p-siret')?.value.trim() || null,
    codeAPE:        document.getElementById('p-ape')?.value.trim() || null,
    effectif:       document.getElementById('p-effectif')?.value || null,
    ccnDefault,
    horaires,
    seuils,
    alertes,
    cpAnnuels:      parseInt(document.getElementById('p-cpan')?.value) || 25,
    cpMode:         document.getElementById('p-cpmode')?.value || 'ouvrables',
    cpPeriode:      document.getElementById('p-cpperiode')?.value || '1juin',
    rttAnnuels:     parseInt(document.getElementById('p-rtt')?.value) || 0,
    updatedAt:      new Date().toISOString(),
  };

  try {
    await window._setDoc(window._doc(window._db,'rh_params',window._uid), data, {merge:true});
    _params = data;
    _modified = false;
    updateSaveHint();
    showToast('âœ… ParamÃ¨tres enregistrÃ©s','ok');
  } catch(e) {
    console.error(e);
    showToast('Erreur : '+e.message,'err');
  }
}

function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.className='toast', 3200);
}

// â”€â”€ MOBILE NAV â”€â”€
function toggleSidebar() {
  document.querySelector('.sidebar')?.classList.toggle('open');
  document.getElementById('nav-overlay')?.classList.toggle('show');
  document.getElementById('hamburger-btn')?.classList.toggle('open');
}
function closeSidebar() {
  document.querySelector('.sidebar')?.classList.remove('open');
  document.getElementById('nav-overlay')?.classList.remove('show');
  document.getElementById('hamburger-btn')?.classList.remove('open');
}
window.initParams = window.initParams || function(){};
</script>

<script src="nav.js"></script>
<script>
(function openRhNav(){
  var tries=0;
  var t=setInterval(function(){
    var sub=document.getElementById('rh-nav-sub');
    var nav=document.getElementById('alteore-nav');
    if(sub&&nav){
      clearInterval(t);
      sub.style.maxHeight='2000px';
      nav.classList.add('rh-mode');
    }
    if(++tries>50)clearInterval(t);
  },50);
})();
</script>

</body>
</html>
