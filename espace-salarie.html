<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>Mon espace cong√©s ‚Äî ALTEORE</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --g1:#052e16;--g2:#064e23;--g3:#059669;--g4:#10b981;--g5:#34d399;
      --green-light:#d1fae5;--green-ghost:#f0fdf4;
      --text:#111827;--muted:#6b7280;--border:#e5e7eb;--bg:#f0fdf4;
      --red:#ef4444;--red-bg:#fef2f2;
      --orange:#f59e0b;--orange-bg:#fffbeb;
      --blue:#3b82f6;--blue-bg:#eff6ff;
      --purple:#7c3aed;
      --teal:#0891b2;
      --pink:#db2777;
      --r:14px;
    }
    html,body{overflow-x:hidden;max-width:100vw;}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:13px;}

    /* LOADING */
    #loading-wrap{position:fixed;inset:0;background:var(--g1);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;z-index:999;transition:opacity .4s;}
    #loading-wrap.fade{opacity:0;pointer-events:none;}
    .load-logo{font-size:26px;font-weight:800;color:white;letter-spacing:1px;opacity:.9;}
    .load-sub{font-size:11px;color:rgba(255,255,255,.35);font-weight:500;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:26px;height:26px;border:2.5px solid rgba(255,255,255,.12);border-top-color:#34d399;border-radius:50%;animation:spin .7s linear infinite;}

    /* NOT FOUND */
    #not-found{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;text-align:center;padding:32px;background:var(--g1);}
    #not-found.show{display:flex;}
    .nf-icon{font-size:52px;margin-bottom:14px;}
    .nf-title{font-size:20px;font-weight:800;color:white;margin-bottom:8px;}
    .nf-sub{font-size:12px;color:rgba(255,255,255,.45);max-width:290px;line-height:1.7;}

    /* HERO */
    .hero{background:linear-gradient(160deg,var(--g1) 0%,var(--g2) 55%,#0a5c30 100%);padding:22px 18px 78px;position:relative;overflow:hidden;}
    .hero::before{content:'';position:absolute;top:-70px;right:-70px;width:260px;height:260px;background:radial-gradient(circle,rgba(52,211,153,.18) 0%,transparent 70%);border-radius:50%;}
    .hero::after{content:'';position:absolute;bottom:-90px;left:25%;width:320px;height:320px;background:radial-gradient(circle,rgba(5,150,105,.12) 0%,transparent 70%);border-radius:50%;}
    .hero-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:26px;position:relative;z-index:1;}
    .hero-brand{display:flex;align-items:center;gap:8px;}
    .hero-brand-icon{width:28px;height:28px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;}
    .hero-brand-name{font-size:13px;font-weight:800;color:rgba(255,255,255,.9);letter-spacing:.5px;}
    .hero-tag{font-size:10px;font-weight:700;color:rgba(255,255,255,.4);background:rgba(255,255,255,.07);padding:3px 9px;border-radius:20px;border:1px solid rgba(255,255,255,.1);}
    .hero-body{position:relative;z-index:1;display:flex;align-items:flex-end;justify-content:space-between;}
    .hero-avatar{width:50px;height:50px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:19px;font-weight:800;color:white;margin-bottom:9px;border:2px solid rgba(255,255,255,.22);flex-shrink:0;}
    .hero-name{font-size:20px;font-weight:800;color:white;margin-bottom:3px;line-height:1.2;}
    .hero-sub{font-size:11.5px;color:rgba(255,255,255,.5);line-height:1.5;}
    .hero-year{font-size:11px;font-weight:700;color:rgba(255,255,255,.4);background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);padding:5px 11px;border-radius:20px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;flex-shrink:0;align-self:flex-start;font-family:'Plus Jakarta Sans',sans-serif;}
    .hero-year:hover{background:rgba(255,255,255,.13);}

    /* SOLDES */
    .soldes-wrap{padding:0 13px;margin-top:-54px;position:relative;z-index:10;}
    .soldes-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;}
    .sc{background:white;border-radius:11px;padding:12px 11px;box-shadow:0 4px 18px rgba(0,0,0,.1);border:1px solid var(--border);}
    .sc-icon{font-size:18px;margin-bottom:4px;}
    .sc-val{font-size:19px;font-weight:800;line-height:1;color:var(--text);}
    .sc-val.g{color:var(--g3);}.sc-val.o{color:var(--orange);}.sc-val.r{color:var(--red);}.sc-val.b{color:var(--blue);}
    .sc-unit{font-size:10px;font-weight:600;}
    .sc-lbl{font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-top:3px;}
    .sc-sub{font-size:9px;color:var(--muted);margin-top:2px;line-height:1.3;}
    .sc-bar{height:3px;background:#f3f4f6;border-radius:2px;overflow:hidden;margin-top:6px;}
    .sc-fill{height:100%;border-radius:2px;}

    /* PAGE */
    .page-body{padding:18px 13px 30px;display:flex;flex-direction:column;gap:14px;max-width:640px;margin:0 auto;}

    /* CARD */
    .card{background:white;border-radius:var(--r);border:1px solid var(--border);overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.04);}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;border-bottom:1px solid var(--border);}
    .card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;}
    .card-body{padding:15px;}

    /* STEPPER */
    .stepper{display:flex;align-items:center;gap:0;margin-bottom:18px;}
    .step-dot{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;border:2px solid var(--border);background:white;color:var(--muted);transition:all .3s;flex-shrink:0;}
    .step-dot.done{background:var(--g3);border-color:var(--g3);color:white;}
    .step-dot.active{background:var(--green-ghost);border-color:var(--g3);color:var(--g3);}
    .step-line{flex:1;height:2px;background:var(--border);transition:background .3s;}
    .step-line.done{background:var(--g3);}
    .form-step{display:none;animation:fin .2s ease;}
    .form-step.active{display:block;}
    @keyframes fin{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

    /* TYPE GRID */
    .type-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:7px;margin-bottom:12px;}
    .tb{padding:10px 9px;border:2px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;background:white;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
    .tb:hover{border-color:var(--g4);background:var(--green-ghost);}
    .tb.sel{border-color:var(--g3);background:var(--green-ghost);}
    .tb-icon{font-size:19px;margin-bottom:3px;}
    .tb-lbl{font-size:11px;font-weight:700;color:var(--text);display:block;}
    .tb-sub{font-size:9.5px;color:var(--muted);display:block;margin-top:1px;}

    /* FIELDS */
    .field{display:flex;flex-direction:column;gap:4px;margin-bottom:11px;}
    .field label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;}
    .finput{width:100%;padding:10px 11px;border:1.5px solid var(--border);border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;color:var(--text);outline:none;transition:border-color .15s;-webkit-appearance:none;background:white;}
    .finput:focus{border-color:var(--g3);box-shadow:0 0 0 3px rgba(5,150,105,.07);}
    .date-row{display:grid;grid-template-columns:1fr 1fr;gap:9px;}

    /* ALERTES */
    .alert{border-radius:8px;padding:9px 11px;font-size:12px;font-weight:600;margin-bottom:9px;display:none;line-height:1.5;}
    .alert.show{display:block;}
    .alert-green{background:var(--green-ghost);color:#065f46;border-left:3px solid var(--g3);}
    .alert-orange{background:var(--orange-bg);color:#92400e;border-left:3px solid var(--orange);}
    .alert-blue{background:var(--blue-bg);color:#1e40af;border-left:3px solid var(--blue);}
    .alert-red{background:var(--red-bg);color:#991b1b;border-left:3px solid var(--red);}

    /* R√âSUM√â */
    .resume{border:2px solid var(--green-light);border-radius:10px;padding:13px;background:var(--green-ghost);margin-bottom:11px;}
    .resume-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--green-light);font-size:12px;}
    .resume-row:last-child{border-bottom:none;font-weight:700;font-size:13px;padding-top:7px;}
    .resume-row span:first-child{color:var(--muted);}

    /* BOUTONS */
    .btn{padding:9px 16px;border:none;border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;justify-content:center;gap:5px;}
    .btn-green{background:linear-gradient(135deg,var(--g3),var(--g4));color:white;box-shadow:0 3px 10px rgba(5,150,105,.25);}
    .btn-green:hover{opacity:.9;transform:translateY(-1px);}
    .btn-green:active{transform:translateY(0);}
    .btn-green:disabled{opacity:.4;transform:none;cursor:not-allowed;}
    .btn-ghost{background:white;color:var(--g3);border:1.5px solid var(--green-light);}
    .btn-ghost:hover{background:var(--green-ghost);}
    .btn-row{display:flex;gap:7px;justify-content:flex-end;margin-top:12px;}

    /* SUCC√àS */
    .success-wrap{display:none;flex-direction:column;align-items:center;padding:28px 18px;text-align:center;}
    .success-wrap.show{display:flex;}
    .success-circle{width:60px;height:60px;background:var(--green-ghost);border:3px solid var(--green-light);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:12px;animation:pop .35s cubic-bezier(.34,1.56,.64,1);}
    @keyframes pop{from{transform:scale(0)}to{transform:scale(1)}}
    .success-title{font-size:16px;font-weight:800;margin-bottom:5px;}
    .success-sub{font-size:12px;color:var(--muted);max-width:270px;line-height:1.6;}

    /* DEMANDES */
    .filter-tabs{display:flex;gap:4px;overflow-x:auto;padding-bottom:2px;margin-bottom:11px;scrollbar-width:none;}
    .filter-tabs::-webkit-scrollbar{display:none;}
    .ftab{padding:4px 11px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:white;color:var(--muted);white-space:nowrap;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
    .ftab.active{background:var(--g3);color:white;border-color:var(--g3);}
    .dem-item{display:flex;align-items:flex-start;gap:10px;padding:11px 0;border-bottom:1px solid #f3f4f6;}
    .dem-item:last-child{border-bottom:none;}
    .dem-ico{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;margin-top:1px;}
    .dem-body{flex:1;min-width:0;}
    .dem-name{font-size:12px;font-weight:700;margin-bottom:2px;}
    .dem-dates{font-size:11px;color:var(--muted);}
    .dem-motif{font-size:11px;color:var(--muted);font-style:italic;margin-top:2px;}
    .dem-refus{font-size:10.5px;color:var(--red);margin-top:3px;}
    .badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700;flex-shrink:0;margin-top:3px;}
    .badge-pending{background:#fef3c7;color:#92400e;}
    .badge-approved{background:#dcfce7;color:#166534;}
    .badge-refused{background:#fee2e2;color:#991b1b;}
    .badge-cancelled{background:#f3f4f6;color:#6b7280;}

    /* CAL */
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;}
    .cal-hdr{font-size:9.5px;font-weight:700;color:var(--muted);padding:2px 0;}
    .cal-day{aspect-ratio:1;border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:500;}
    .cal-day.today{outline:2px solid var(--g3);font-weight:800;}
    .cal-day.abs{color:white;font-weight:700;}
    .cal-day.abs-pending{opacity:.6;}

    /* EMPTY */
    .empty{display:flex;flex-direction:column;align-items:center;padding:26px;text-align:center;color:var(--muted);}
    .empty-icon{font-size:30px;margin-bottom:7px;}

    /* TOAST */
    .toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(80px);background:#1a1f36;color:white;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:all .3s;white-space:nowrap;}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
    .toast.ok{background:var(--g3);}.toast.err{background:var(--red);}

    @media(max-width:480px){
      .soldes-grid{grid-template-columns:1fr 1fr;}
      .date-row{grid-template-columns:1fr;}
      .hero{padding:18px 13px 72px;}
      .page-body{padding:15px 11px 26px;}
    }
  </style>
</head>
<body>

<div id="loading-wrap">
  <div class="load-logo">üåø ALTEORE</div>
  <div class="spin"></div>
  <div class="load-sub">Chargement de votre espace‚Ä¶</div>
</div>

<div id="not-found">
  <div class="nf-icon">üîó</div>
  <div class="nf-title">Lien invalide</div>
  <div class="nf-sub">Ce lien n'est pas valide ou a expir√©.<br>Demandez √† votre employeur un nouveau lien d'acc√®s.</div>
</div>

<div id="main-wrap" style="display:none">

  <!-- HERO -->
  <div class="hero">
    <div class="hero-top">
      <div class="hero-brand">
        <div class="hero-brand-icon">üåø</div>
        <div class="hero-brand-name">ALTEORE</div>
      </div>
      <button class="hero-year" onclick="changeYear()" id="year-btn">üìÖ <span id="year-lbl"></span></button>
    </div>
    <div class="hero-body">
      <div>
        <div class="hero-avatar" id="hero-av">?</div>
        <div class="hero-name" id="hero-name">‚Äî</div>
        <div class="hero-sub" id="hero-sub">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- SOLDES FLOTTANTES -->
  <div class="soldes-wrap"><div class="soldes-grid" id="soldes-grid"></div></div>

  <div class="page-body" style="margin-top:16px">

    <!-- ‚ïê‚ïê NOUVELLE DEMANDE ‚ïê‚ïê -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">‚úâÔ∏è Faire une demande</div>
        <span id="step-lbl" style="font-size:11px;color:var(--muted)">√âtape 1 / 3</span>
      </div>
      <div class="card-body">

        <div class="stepper">
          <div class="step-dot active" id="s1">1</div>
          <div class="step-line" id="sl1"></div>
          <div class="step-dot" id="s2">2</div>
          <div class="step-line" id="sl2"></div>
          <div class="step-dot" id="s3">3</div>
        </div>

        <!-- STEP 1 : Type -->
        <div class="form-step active" id="st1">
          <div style="font-size:12px;font-weight:700;margin-bottom:10px">Quel type de cong√© ?</div>
          <div class="type-grid" id="type-grid"></div>
          <div class="alert alert-blue" id="evenement-loi">
            <strong>Dur√©es l√©gales :</strong><br>
            Mariage / PACS : 4j &nbsp;¬∑&nbsp; Naissance / Adoption : 3j<br>
            D√©c√®s conjoint ou enfant : 5j &nbsp;¬∑&nbsp; D√©c√®s parent : 3j &nbsp;¬∑&nbsp; D√©c√®s beau-parent : 3j
          </div>
          <div class="btn-row">
            <button class="btn btn-green" id="next1" onclick="goStep(2)" disabled>Suivant ‚Üí</button>
          </div>
        </div>

        <!-- STEP 2 : Dates -->
        <div class="form-step" id="st2">
          <div class="date-row">
            <div class="field">
              <label>Date de d√©but</label>
              <input class="finput" type="date" id="f-deb" oninput="onDateChg()"/>
            </div>
            <div class="field">
              <label>Date de fin</label>
              <input class="finput" type="date" id="f-fin" oninput="onDateChg()"/>
            </div>
          </div>
          <div class="alert alert-green" id="jours-alert"></div>
          <div class="alert alert-orange" id="solde-alert"></div>
          <div class="field">
            <label>Motif (facultatif)</label>
            <input class="finput" type="text" id="f-motif" placeholder="Ex : vacances, formation, √©v√©nement‚Ä¶"/>
          </div>
          <!-- JUSTIFICATIF visible si maladie ou formation -->
          <div id="justif-wrap" style="display:none;margin-bottom:11px">
            <div class="field" style="margin-bottom:0">
              <label>üìé Justificatif <span style="font-weight:400;text-transform:none;letter-spacing:0">(arr√™t maladie, ordonnance‚Ä¶)</span></label>
              <div id="justif-drop"
                onclick="document.getElementById('justif-input').click()"
                style="border:2px dashed var(--border);border-radius:10px;padding:18px 12px;text-align:center;cursor:pointer;background:white;transition:all .15s;"
                onmouseover="this.style.borderColor='var(--g3)';this.style.background='var(--green-ghost)'"
                onmouseout="this.style.borderColor='var(--border)';this.style.background='white'">
                <div style="font-size:26px;margin-bottom:4px">üìÑ</div>
                <div style="font-size:12px;font-weight:600;color:var(--muted)">Appuyez pour joindre un fichier</div>
                <div style="font-size:10px;color:var(--muted);margin-top:2px">PDF, JPG, PNG ¬∑ Max 5 Mo ¬∑ Facultatif</div>
              </div>
              <input type="file" id="justif-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="onJustifChange(this)"/>
              <div id="justif-preview" style="display:none;margin-top:7px;padding:8px 12px;background:var(--green-ghost);border:1px solid #6ee7b7;border-radius:8px;align-items:center;gap:8px;">
                <span style="font-size:16px">üìé</span>
                <span id="justif-name" style="flex:1;font-size:12px;font-weight:600;color:#065f46;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
                <span id="justif-size" style="font-size:11px;color:var(--muted);flex-shrink:0"></span>
                <button onclick="clearJustif(event)" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:15px;padding:0 2px;flex-shrink:0;line-height:1">‚úï</button>
              </div>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn btn-ghost" onclick="goStep(1)">‚Üê Retour</button>
            <button class="btn btn-green" id="next2" onclick="goStep(3)" disabled>V√©rifier ‚Üí</button>
          </div>
        </div>

        <!-- STEP 3 : R√©cap -->
        <div class="form-step" id="st3">
          <div style="font-size:12px;font-weight:700;margin-bottom:11px">R√©capitulatif</div>
          <div class="resume" id="recap"></div>
          <div class="alert alert-orange" id="recap-warn"></div>
          <div class="btn-row">
            <button class="btn btn-ghost" onclick="goStep(2)">‚Üê Modifier</button>
            <button class="btn btn-green" id="btn-submit" onclick="submitDemande()">‚úâÔ∏è Envoyer la demande</button>
          </div>
        </div>

        <!-- SUCC√àS -->
        <div class="success-wrap" id="success-wrap">
          <div class="success-circle">‚úÖ</div>
          <div class="success-title">Demande envoy√©e !</div>
          <div class="success-sub" id="success-sub">Votre demande a √©t√© transmise.</div>
          <button class="btn btn-green" style="margin-top:14px" onclick="resetForm()">+ Nouvelle demande</button>
        </div>

      </div>
    </div>

    <!-- ‚ïê‚ïê MES DEMANDES ‚ïê‚ïê -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">üìã Mes demandes</div>
        <span id="dem-count" style="font-size:11px;color:var(--muted)"></span>
      </div>
      <div class="card-body" style="padding-top:10px">
        <div class="filter-tabs">
          <button class="ftab active" onclick="setFilter(this,'all')">Toutes</button>
          <button class="ftab" onclick="setFilter(this,'pending')">‚è≥ Attente</button>
          <button class="ftab" onclick="setFilter(this,'approved')">‚úÖ Approuv√©es</button>
          <button class="ftab" onclick="setFilter(this,'refused')">‚ùå Refus√©es</button>
          <button class="ftab" onclick="setFilter(this,'cancelled')">üö´ Annul√©es</button>
        </div>
        <div id="dem-list"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê CALENDRIER ‚ïê‚ïê -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">üìÖ <span id="cal-title">Mon calendrier</span></div>
        <div style="display:flex;gap:5px">
          <button class="btn btn-ghost" style="padding:4px 9px;font-size:12px" onclick="prevM()">‚Äπ</button>
          <button class="btn btn-ghost" style="padding:4px 9px;font-size:12px" onclick="nextM()">‚Ä∫</button>
        </div>
      </div>
      <div class="card-body" style="padding:12px">
        <div class="cal-grid" id="cal-grid"></div>
        <div style="display:flex;flex-wrap:wrap;gap:7px;margin-top:9px" id="cal-legend"></div>
      </div>
    </div>

    <div style="text-align:center;padding:2px 0 8px;color:var(--muted);font-size:10.5px">
      Propuls√© par <strong>ALTEORE</strong> &middot; Portail salari√© s√©curis√©
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, addDoc, getDocs, collection, query, where }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com", projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746", appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const db = getFirestore(app);
  window._db  = db;
  window._getDoc   = (path, ...s) => getDoc(doc(db, path, ...s));
  window._addDoc   = (colPath, data) => addDoc(collection(db, ...colPath), data);
  window._getDocs  = (...colPath) => getDocs(collection(db, ...colPath));
  window._queryWhere = (colPath, field, val) =>
    getDocs(query(collection(db, ...colPath), where(field, '==', val)));
  window._dbReady  = true;
  window.startApp();
</script>

<script>
/* ‚îÄ‚îÄ CONSTANTES ‚îÄ‚îÄ */
var COLORS  = {cp:'#059669',rtt:'#3b82f6',css:'#f59e0b',evenement:'#7c3aed',maladie:'#ef4444',recuperation:'#0891b2',formation:'#db2777'};
var LABELS  = {cp:'Cong√©s pay√©s',rtt:'RTT',css:'Sans solde',evenement:'√âv√©nement familial',maladie:'Maladie / Arr√™t',recuperation:'R√©cup√©ration heures',formation:'Formation'};
var ICONS   = {cp:'üèñÔ∏è',rtt:'‚è∞',css:'üíº',evenement:'üéâ',maladie:'ü§í',recuperation:'üîÑ',formation:'üéì'};
var SOLDE_K = {cp:'cpRestant',rtt:'rttRestant',recuperation:'recupRestant'};

/* ‚îÄ‚îÄ √âTAT ‚îÄ‚îÄ */
var _uid='', _empId='', _emp={}, _params={}, _demandes=[];
var _soldes={};
var _selType='';
var _demFilter='all';
var _calMonth=new Date();
var _year=new Date().getFullYear();

/* ‚îÄ‚îÄ D√âMARRAGE ‚îÄ‚îÄ */
window.startApp = function() {
  var p = new URLSearchParams(window.location.search);
  var pid = p.get('id') || '';
  if (!pid) { showNotFound(); return; }
  var t = setInterval(function() {
    if (window._dbReady) { clearInterval(t); loadEmploye(pid); }
  }, 80);
};

async function loadEmploye(pid) {
  try {
    var snap = await window._getDoc('rh_employes_public', pid);
    if (!snap.exists()) { showNotFound(); return; }
    var data = snap.data();
    _uid = data.uid; _empId = data.empId; _emp = data;
    try {
      var ps = await window._getDoc('rh_params', _uid);
      _params = ps.exists() ? ps.data() : {};
    } catch(e) { _params = {}; }
    await loadDemandes();
    calcSoldes();
    renderPage();
    var lw = document.getElementById('loading-wrap');
    lw.classList.add('fade');
    setTimeout(function() { lw.style.display='none'; document.getElementById('main-wrap').style.display='block'; }, 400);
  } catch(e) { console.error(e); showNotFound(); }
}

async function loadDemandes() {
  _demandes = [];
  try {
    var snap = await window._queryWhere(['rh_conges', _uid, 'demandes'], 'empId', _empId);
    snap.forEach(function(d) { _demandes.push(Object.assign({id:d.id}, d.data())); });
    _demandes.sort(function(a,b) { return (b.createdAt||'').localeCompare(a.createdAt||''); });
  } catch(e) { console.warn('Demandes:', e.message); }
}

/* ‚îÄ‚îÄ CALCUL SOLDES ‚îÄ‚îÄ */
function calcSoldes() {
  var now = new Date();
  var y = _year;
  var cpAnnuels = parseFloat(_params.cpAnnuels) || 25;
  var cpPeriode = _params.cpPeriode || '1juin';
  var rttAnnuels = parseFloat(_params.rttAnnuels) || 0;

  var pDeb, pFin;
  if (cpPeriode === '1janv') { pDeb = new Date(y,0,1); pFin = new Date(y,11,31); }
  else { pDeb = new Date(y-1,5,1); pFin = new Date(y,4,31); }

  var entree = _emp.dateEntree ? new Date(_emp.dateEntree+'T12:00:00') : new Date(y-2,0,1);
  var debut  = entree > pDeb ? entree : pDeb;
  var fin    = now < pFin ? now : pFin;

  var mois = Math.max(0, (fin.getFullYear()-debut.getFullYear())*12 + (fin.getMonth()-debut.getMonth()));
  var ajust = parseFloat(_emp.cpAjustAcquis) || 0;
  var cpAcquis = Math.round(Math.max(0, mois*(cpAnnuels/12)+ajust)*10)/10;

  var cpPris = _demandes
    .filter(function(d) {
      if (!d.dateDebut || d.type !== 'cp' || d.statut !== 'approved') return false;
      var dt = new Date(d.dateDebut+'T12:00:00');
      return dt >= pDeb && dt <= pFin;
    })
    .reduce(function(s,d) { return s + (d.nbJours||0); }, 0);

  var rttBase  = (parseFloat(_emp.rttAjust) >= 0) ? parseFloat(_emp.rttAjust) : rttAnnuels;
  var rttPris  = _demandes
    .filter(function(d) { return d.type==='rtt' && d.statut==='approved' && new Date(d.dateDebut||0).getFullYear()===y; })
    .reduce(function(s,d) { return s+(d.nbJours||0); }, 0);

  _soldes = {
    cpAcquis: cpAcquis, cpPris: cpPris,
    cpRestant:  Math.max(0, cpAcquis-cpPris),
    rttBase: rttBase, rttPris: rttPris,
    rttRestant: Math.max(0, rttBase-rttPris),
    recupRestant: parseFloat(_emp.recupHeures) || 0,
    pending: _demandes.filter(function(d) { return d.statut==='pending'; }).length,
  };
}

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
function renderPage() {
  var col = _emp.couleur || '#059669';
  var av  = document.getElementById('hero-av');
  av.textContent  = (_emp.prenom||'?').charAt(0).toUpperCase();
  av.style.background = col;
  document.getElementById('hero-name').textContent = ((_emp.prenom||'')+' '+(_emp.nom||'')).trim();
  document.getElementById('hero-sub').textContent  = [_emp.poste,_emp.departement,_emp.typeContrat].filter(Boolean).join(' ¬∑ ');
  document.getElementById('year-lbl').textContent  = _year;
  renderSoldes(); renderTypeGrid(); renderDemandes(); renderCal();
}

function renderSoldes() {
  var s = _soldes;
  var cpPct  = s.cpAcquis>0  ? Math.min(s.cpPris/s.cpAcquis*100,100).toFixed(0)  : 0;
  var rttPct = s.rttBase>0   ? Math.min(s.rttPris/s.rttBase*100,100).toFixed(0)  : 0;
  document.getElementById('soldes-grid').innerHTML =
    '<div class="sc">'
      +'<div class="sc-icon">üèñÔ∏è</div>'
      +'<div class="sc-val '+(s.cpRestant>10?'g':s.cpRestant>5?'o':'r')+'">'+s.cpRestant.toFixed(1)+'<span class="sc-unit">j</span></div>'
      +'<div class="sc-lbl">CP restants</div>'
      +'<div class="sc-sub">'+s.cpAcquis.toFixed(1)+'j acquis ¬∑ '+s.cpPris.toFixed(1)+'j pris</div>'
      +'<div class="sc-bar"><div class="sc-fill" style="width:'+cpPct+'%;background:var(--orange)"></div></div>'
    +'</div>'
    +'<div class="sc">'
      +'<div class="sc-icon">‚è∞</div>'
      +'<div class="sc-val '+(s.rttRestant>0?'g':'r')+'">'+s.rttRestant.toFixed(1)+'<span class="sc-unit">j</span></div>'
      +'<div class="sc-lbl">RTT restants</div>'
      +'<div class="sc-sub">'+s.rttBase+'j allou√©s ¬∑ '+s.rttPris+'j pris</div>'
      +'<div class="sc-bar"><div class="sc-fill" style="width:'+rttPct+'%;background:var(--blue)"></div></div>'
    +'</div>'
    +'<div class="sc">'
      +'<div class="sc-icon">üîÑ</div>'
      +'<div class="sc-val '+(s.recupRestant>0?'g':'')+'">'+s.recupRestant.toFixed(1)+'<span class="sc-unit">h</span></div>'
      +'<div class="sc-lbl">R√©cup√©ration</div>'
      +'<div class="sc-sub">Heures √† prendre</div>'
    +'</div>'
    +'<div class="sc">'
      +'<div class="sc-icon">‚è≥</div>'
      +'<div class="sc-val '+(s.pending>0?'o':'')+'">'+s.pending+'</div>'
      +'<div class="sc-lbl">En attente</div>'
      +'<div class="sc-sub">demande'+(s.pending>1?'s':'')+' √† valider</div>'
    +'</div>';
}

function renderTypeGrid() {
  var types = [
    {k:'cp',         sub: _soldes.cpRestant.toFixed(1)+'j disponibles'},
    {k:'rtt',        sub: _soldes.rttRestant.toFixed(1)+'j disponibles'},
    {k:'recuperation',sub:(_soldes.recupRestant||0)+'h disponibles'},
    {k:'css',        sub:'Non d√©compt√© du solde'},
    {k:'evenement',  sub:'Dur√©es l√©gales'},
    {k:'maladie',    sub:'Arr√™t m√©dical'},
    {k:'formation',  sub:'Formation professionnelle'},
  ];
  document.getElementById('type-grid').innerHTML = types.map(function(t) {
    return '<button class="tb '+((_selType===t.k)?'sel':'')+'" onclick="selType(\''+t.k+'\')">'
      +'<div class="tb-icon">'+ICONS[t.k]+'</div>'
      +'<span class="tb-lbl">'+LABELS[t.k]+'</span>'
      +'<span class="tb-sub">'+t.sub+'</span>'
      +'</button>';
  }).join('');
}

function setFilter(btn, f) {
  _demFilter = f;
  document.querySelectorAll('.ftab').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  renderDemandes();
}
window.setFilter = setFilter;

function renderDemandes() {
  var el  = document.getElementById('dem-list');
  var cnt = document.getElementById('dem-count');
  var list = _demFilter === 'all' ? _demandes : _demandes.filter(function(d) { return d.statut === _demFilter; });
  cnt.textContent = _demandes.length+' demande'+(_demandes.length>1?'s':'');
  if (!list.length) { el.innerHTML='<div class="empty"><div class="empty-icon">üìã</div>Aucune demande.</div>'; return; }
  el.innerHTML = list.map(function(d) {
    var db = d.dateDebut ? new Date(d.dateDebut+'T12:00:00').toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'}) : '?';
    var de = (d.dateFin && d.dateFin!==d.dateDebut) ? ' ‚Üí '+new Date(d.dateFin+'T12:00:00').toLocaleDateString('fr-FR',{day:'numeric',month:'short'}) : '';
    var bTxt = {pending:'‚è≥ En attente',approved:'‚úÖ Approuv√©e',refused:'‚ùå Refus√©e',cancelled:'üö´ Annul√©e'}[d.statut] || d.statut;
    return '<div class="dem-item">'
      +'<div class="dem-ico" style="background:'+(COLORS[d.type]||'#6b7280')+'22">'+(ICONS[d.type]||'üìã')+'</div>'
      +'<div class="dem-body">'
        +'<div class="dem-name">'+(LABELS[d.type]||d.type)+' <strong style="color:'+(COLORS[d.type]||'var(--g3)')+'">'+(d.nbJours||0)+'j</strong></div>'
        +'<div class="dem-dates">'+db+de+'</div>'
        +(d.motif?'<div class="dem-motif">'+d.motif+'</div>':'')
        +(d.motifRefus?'<div class="dem-refus">Motif du refus : '+d.motifRefus+'</div>':'')
        +'<span class="badge badge-'+(d.statut||'pending')+'">'+bTxt+'</span>'
      +'</div>'
      +'</div>';
  }).join('');
}

function renderCal() {
  var y = _calMonth.getFullYear(), m = _calMonth.getMonth();
  var nb = new Date(y,m+1,0).getDate();
  var firstDow = (new Date(y,m,1).getDay()+6)%7;
  document.getElementById('cal-title').textContent = new Date(y,m,1).toLocaleDateString('fr-FR',{month:'long',year:'numeric'});

  var map = {};
  _demandes.filter(function(d) { return d.statut==='approved'||d.statut==='pending'; }).forEach(function(d) {
    if (!d.dateDebut) return;
    var cur = new Date(d.dateDebut+'T12:00:00');
    var fin = new Date((d.dateFin||d.dateDebut)+'T12:00:00');
    while (cur <= fin) {
      if (cur.getFullYear()===y && cur.getMonth()===m)
        map[cur.getDate()] = {type:d.type, pending:d.statut==='pending'};
      cur.setDate(cur.getDate()+1);
    }
  });

  var today = new Date();
  var hdrs = ['L','M','M','J','V','S','D'];
  var html = '';
  hdrs.forEach(function(h) { html += '<div class="cal-hdr">'+h+'</div>'; });
  for (var i=0; i<firstDow; i++) html += '<div></div>';
  for (var d=1; d<=nb; d++) {
    var dow = (firstDow+d-1)%7;
    var we  = dow >= 5;
    var abs = map[d];
    var isToday = d===today.getDate() && m===today.getMonth() && y===today.getFullYear();
    var bg  = abs ? COLORS[abs.type] : 'transparent';
    var cls = 'cal-day'+(isToday?' today':'')+(we?' we':'')+(abs?' abs':'')+(abs&&abs.pending?' abs-pending':'');
    var col = abs ? 'white' : (we ? '#d1d5db' : 'var(--text)');
    var ttl = abs ? LABELS[abs.type]+(abs.pending?' (en attente)':'') : '';
    html += '<div class="'+cls+'" style="background:'+bg+';color:'+col+'" title="'+ttl+'">'+d+'</div>';
  }
  document.getElementById('cal-grid').innerHTML = html;

  var usedTypes = {};
  _demandes.filter(function(d) {
    return d.dateDebut && new Date(d.dateDebut+'T12:00:00').getMonth()===m && new Date(d.dateDebut+'T12:00:00').getFullYear()===y;
  }).forEach(function(d) { usedTypes[d.type]=true; });
  document.getElementById('cal-legend').innerHTML = Object.keys(usedTypes).map(function(t) {
    return '<div style="display:flex;align-items:center;gap:5px;font-size:10px;color:var(--muted)">'
      +'<div style="width:9px;height:9px;border-radius:2px;background:'+(COLORS[t]||'#6b7280')+'"></div>'+(LABELS[t]||t)
      +'</div>';
  }).join('');
}

function prevM() { _calMonth.setMonth(_calMonth.getMonth()-1); renderCal(); }
function nextM() { _calMonth.setMonth(_calMonth.getMonth()+1); renderCal(); }
window.prevM=prevM; window.nextM=nextM;

function changeYear() {
  var v = prompt('Ann√©e √† afficher :', _year);
  var n = parseInt(v)||0;
  if (n>=2020 && n<=2030) {
    _year = n;
    document.getElementById('year-lbl').textContent = _year;
    calcSoldes(); renderSoldes(); renderDemandes();
  }
}
window.changeYear = changeYear;

/* ‚îÄ‚îÄ FORMULAIRE ‚îÄ‚îÄ */
var _curStep = 1;

var _justifB64 = null;
var _justifMeta = null;

function onJustifChange(input) {
  var file = input.files[0];
  if (!file) return;
  if (file.size > 5*1024*1024) { showToast('Fichier trop lourd (max 5 Mo)','err'); return; }
  var reader = new FileReader();
  reader.onload = function(e) {
    _justifB64 = e.target.result;
    _justifMeta = { name: file.name, size: file.size, type: file.type };
    document.getElementById('justif-name').textContent = file.name;
    document.getElementById('justif-size').textContent = (file.size/1024).toFixed(0)+'Ko';
    var prev = document.getElementById('justif-preview');
    prev.style.display = 'flex';
    document.getElementById('justif-drop').style.display = 'none';
  };
  reader.readAsDataURL(file);
}
window.onJustifChange = onJustifChange;

function clearJustif(e) {
  if (e) e.stopPropagation();
  _justifB64 = null; _justifMeta = null;
  var inp = document.getElementById('justif-input');
  if (inp) inp.value = '';
  document.getElementById('justif-preview').style.display = 'none';
  document.getElementById('justif-drop').style.display = '';
}
window.clearJustif = clearJustif;

function selType(k) {
  _selType = k;
  renderTypeGrid();
  document.getElementById('next1').disabled = false;
  document.getElementById('evenement-loi').className = 'alert alert-blue'+(k==='evenement'?' show':'');
  // Afficher la zone justificatif si maladie ou formation
  var jw = document.getElementById('justif-wrap');
  if (jw) jw.style.display = (k==='maladie' || k==='formation') ? '' : 'none';
  clearJustif();
}
window.selType = selType;

function goStep(n) {
  if (n===2 && !_selType) return;
  if (n===3) {
    var deb = document.getElementById('f-deb').value;
    if (!deb) { showToast('S√©lectionnez une date de d√©but','err'); return; }
    buildRecap();
  }
  _curStep = n;
  document.querySelectorAll('.form-step').forEach(function(e) { e.classList.remove('active'); });
  var st = document.getElementById('st'+n);
  if (st) st.classList.add('active');
  for (var i=1; i<=3; i++) {
    var dd = document.getElementById('s'+i);
    var ll = document.getElementById('sl'+i);
    if (dd) dd.className = 'step-dot'+(i<n?' done':i===n?' active':'');
    if (ll && i<3) ll.className = 'step-line'+(i<n?' done':'');
  }
  document.getElementById('step-lbl').textContent = '√âtape '+n+' / 3';
}
window.goStep = goStep;

function joursOuvres(deb, fin) {
  if (!deb || !fin) return 0;
  var d = new Date(deb+'T12:00:00'), f = new Date(fin+'T12:00:00'), c = 0;
  while (d <= f) { var dw = d.getDay(); if (dw!==0 && dw!==6) c++; d.setDate(d.getDate()+1); }
  return c;
}

function onDateChg() {
  var deb = document.getElementById('f-deb').value;
  var fin = document.getElementById('f-fin').value;
  if (fin && fin < deb) { document.getElementById('f-fin').value = deb; fin = deb; }
  var ja = document.getElementById('jours-alert');
  var sa = document.getElementById('solde-alert');
  if (!deb) { ja.className='alert alert-green'; sa.className='alert alert-orange'; document.getElementById('next2').disabled=true; return; }
  var jours = joursOuvres(deb, fin||deb);
  ja.textContent = 'üìÖ '+jours+' jour'+(jours>1?'s':'')+' ouvr√©'+(jours>1?'s':'');
  ja.className = 'alert alert-green show';
  document.getElementById('next2').disabled = false;
  var sk = SOLDE_K[_selType];
  if (sk && _soldes[sk] !== undefined) {
    var solde = parseFloat(_soldes[sk]) || 0;
    if (jours > solde) {
      sa.textContent = '‚ö†Ô∏è Solde insuffisant : '+solde.toFixed(1)+(_selType==='recuperation'?'h':'j')+' disponibles, '+jours+'j demand√©s';
      sa.className = 'alert alert-orange show';
    } else sa.className = 'alert alert-orange';
  } else sa.className = 'alert alert-orange';
}
window.onDateChg = onDateChg;

function buildRecap() {
  var deb    = document.getElementById('f-deb').value;
  var fin    = document.getElementById('f-fin').value || deb;
  var motif  = document.getElementById('f-motif').value.trim();
  var jours  = joursOuvres(deb, fin);
  var debFmt = new Date(deb+'T12:00:00').toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  var finFmt = new Date(fin+'T12:00:00').toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});
  var sk     = SOLDE_K[_selType];
  var solde  = (sk !== undefined) ? (parseFloat(_soldes[sk])||0) : null;
  var apres  = solde !== null ? Math.max(0, solde-jours) : null;
  var rw     = document.getElementById('recap-warn');
  if (solde !== null && jours > solde) {
    rw.textContent = '‚ö†Ô∏è Solde insuffisant ('+solde.toFixed(1)+'j dispo). Votre employeur en sera inform√©.';
    rw.className = 'alert alert-orange show';
  } else rw.className = 'alert alert-orange';
  document.getElementById('recap').innerHTML =
    '<div class="resume-row"><span>Type</span><span>'+ICONS[_selType]+' '+LABELS[_selType]+'</span></div>'
    +'<div class="resume-row"><span>Du</span><span>'+debFmt+'</span></div>'
    +'<div class="resume-row"><span>Au</span><span>'+finFmt+'</span></div>'
    +(motif?'<div class="resume-row"><span>Motif</span><span>'+motif+'</span></div>':'')
    +'<div class="resume-row"><span>Total</span><span style="color:var(--g3)">'+jours+' jour'+(jours>1?'s':'')+' ouvr√©'+(jours>1?'s':'')+'</span></div>'
    +(apres!==null?'<div class="resume-row"><span>Solde restant apr√®s</span><span style="color:'+(apres>5?'var(--g3)':'var(--orange)')+'">'+apres.toFixed(1)+'j</span></div>':'')
    +(_justifB64?'<div class="resume-row"><span>Justificatif</span><span style="color:var(--g3)">üìé '+(_justifMeta?_justifMeta.name:'Fichier joint')+'</span></div>':'');
}

async function submitDemande() {
  var deb   = document.getElementById('f-deb').value;
  var fin   = document.getElementById('f-fin').value || deb;
  var motif = document.getElementById('f-motif').value.trim();
  var jours = joursOuvres(deb, fin);
  var btn = document.getElementById('btn-submit');
  btn.disabled = true; btn.textContent = 'Envoi‚Ä¶';
  var demandeData = {
    empId:_empId, uid:_uid, type:_selType, dateDebut:deb, dateFin:fin, nbJours:jours,
    statut:'pending', motif:motif||null,
    createdAt:new Date().toISOString(), source:'salarie',
  };
  if (_justifB64 && _justifMeta) {
    demandeData.justificatif = { data:_justifB64, name:_justifMeta.name, size:_justifMeta.size, type:_justifMeta.type };
  }
  try {
    await window._addDoc(['rh_conges', _uid, 'demandes'], demandeData);
    _demandes.unshift({id:'tmp_'+Date.now(),empId:_empId,type:_selType,dateDebut:deb,dateFin:fin,nbJours:jours,statut:'pending',motif:motif||null,createdAt:new Date().toISOString()});
    calcSoldes(); renderSoldes(); renderDemandes(); renderCal();
    document.getElementById('st3').classList.remove('active');
    var sw = document.getElementById('success-wrap');
    sw.style.display = 'flex'; sw.classList.add('show');
    document.getElementById('success-sub').textContent = 'Votre demande de '+jours+'j ('+LABELS[_selType]+') a √©t√© transmise. Votre employeur la traitera prochainement.';
  } catch(e) {
    console.error(e); showToast('Erreur : '+e.message, 'err');
    btn.disabled = false; btn.textContent = '‚úâÔ∏è Envoyer la demande';
  }
}
window.submitDemande = submitDemande;

function resetForm() {
  _selType = ''; _curStep = 1;
  var sw = document.getElementById('success-wrap');
  sw.style.display = 'none'; sw.classList.remove('show');
  document.getElementById('f-deb').value = '';
  document.getElementById('f-fin').value = '';
  document.getElementById('f-motif').value = '';
  document.getElementById('jours-alert').className = 'alert alert-green';
  document.getElementById('solde-alert').className = 'alert alert-orange';
  document.getElementById('next1').disabled = true;
  document.getElementById('next2').disabled = true;
  clearJustif();
  var jw = document.getElementById('justif-wrap');
  if (jw) jw.style.display = 'none';
  goStep(1); renderTypeGrid();
}
window.resetForm = resetForm;

/* ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ */
function showNotFound() {
  document.getElementById('loading-wrap').style.display = 'none';
  document.getElementById('not-found').classList.add('show');
}
function showToast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show '+(type||'');
  setTimeout(function() { t.className='toast'; }, 3200);
}
</script>
</body>
</html>
