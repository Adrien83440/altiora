<!-- ALTEORE espace-salarie v20260227-enrichi -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>Mon espace ‚Äî ALTEORE</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --g1:#052e16;--g2:#064e23;--g3:#059669;--g4:#10b981;--g5:#34d399;
      --green-light:#d1fae5;--green-ghost:#f0fdf4;
      --text:#111827;--muted:#6b7280;--border:#e5e7eb;--bg:#f0fdf4;
      --red:#ef4444;--red-bg:#fef2f2;
      --orange:#f59e0b;--orange-bg:#fffbeb;
      --blue:#3b82f6;--blue-bg:#eff6ff;
      --purple:#7c3aed;--purple-bg:#faf5ff;
      --teal:#0891b2;--teal-bg:#ecfeff;
      --pink:#db2777;
      --r:14px;
    }
    html,body{overflow-x:hidden;max-width:100vw;}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:13px;}

    /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
    #loading-wrap{position:fixed;inset:0;background:var(--g1);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;z-index:999;transition:opacity .4s;}
    #loading-wrap.fade{opacity:0;pointer-events:none;}
    .load-logo{font-size:26px;font-weight:800;color:white;letter-spacing:1px;opacity:.9;}
    .load-sub{font-size:11px;color:rgba(255,255,255,.35);font-weight:500;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:26px;height:26px;border:2.5px solid rgba(255,255,255,.12);border-top-color:#34d399;border-radius:50%;animation:spin .7s linear infinite;}

    /* ‚îÄ‚îÄ NOT FOUND ‚îÄ‚îÄ */
    #not-found{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;text-align:center;padding:32px;background:var(--g1);}
    #not-found.show{display:flex;}
    .nf-icon{font-size:52px;margin-bottom:14px;}
    .nf-title{font-size:20px;font-weight:800;color:white;margin-bottom:8px;}
    .nf-sub{font-size:12px;color:rgba(255,255,255,.45);max-width:290px;line-height:1.7;}

    /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
    .hero{background:linear-gradient(160deg,var(--g1) 0%,var(--g2) 55%,#0a5c30 100%);padding:22px 18px 88px;position:relative;overflow:hidden;}
    .hero::before{content:'';position:absolute;top:-70px;right:-70px;width:260px;height:260px;background:radial-gradient(circle,rgba(52,211,153,.18) 0%,transparent 70%);border-radius:50%;}
    .hero::after{content:'';position:absolute;bottom:-90px;left:25%;width:320px;height:320px;background:radial-gradient(circle,rgba(5,150,105,.12) 0%,transparent 70%);border-radius:50%;}
    .hero-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;position:relative;z-index:1;}
    .hero-brand{display:flex;align-items:center;gap:8px;}
    .hero-brand-icon{width:28px;height:28px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;}
    .hero-brand-name{font-size:13px;font-weight:800;color:rgba(255,255,255,.9);letter-spacing:.5px;}
    .hero-tag{font-size:10px;font-weight:700;color:rgba(255,255,255,.4);background:rgba(255,255,255,.07);padding:3px 9px;border-radius:20px;border:1px solid rgba(255,255,255,.1);}
    .hero-body{position:relative;z-index:1;display:flex;align-items:flex-end;gap:14px;}
    .hero-avatar{width:52px;height:52px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;color:white;border:2px solid rgba(255,255,255,.22);flex-shrink:0;}
    .hero-info{flex:1;min-width:0;}
    .hero-name{font-size:19px;font-weight:800;color:white;margin-bottom:2px;line-height:1.2;}
    .hero-sub{font-size:11.5px;color:rgba(255,255,255,.5);line-height:1.5;}
    .hero-chips{display:flex;gap:5px;margin-top:6px;flex-wrap:wrap;}
    .hero-chip{font-size:9.5px;font-weight:700;color:rgba(255,255,255,.65);background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);padding:2px 8px;border-radius:20px;}

    /* ‚îÄ‚îÄ ONGLETS NAVIGATION ‚îÄ‚îÄ */
    .tabs-nav{background:white;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;overflow-x:auto;scrollbar-width:none;}
    .tabs-nav::-webkit-scrollbar{display:none;}
    .tabs-inner{display:flex;min-width:max-content;padding:0 14px;}
    .tnav{padding:12px 14px;font-size:12px;font-weight:700;color:var(--muted);border:none;background:none;cursor:pointer;border-bottom:2.5px solid transparent;transition:all .18s;display:flex;align-items:center;gap:5px;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif;}
    .tnav:hover{color:var(--g3);}
    .tnav.active{color:var(--g3);border-bottom-color:var(--g3);}
    .tnav .notif{background:var(--red);color:white;border-radius:20px;padding:1px 5px;font-size:9px;font-weight:800;}

    /* ‚îÄ‚îÄ SOLDES FLOTTANTS ‚îÄ‚îÄ */
    .soldes-wrap{padding:0 13px;margin-top:-66px;position:relative;z-index:10;}
    .soldes-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;}
    .sc{background:white;border-radius:11px;padding:12px 11px;box-shadow:0 4px 18px rgba(0,0,0,.1);border:1px solid var(--border);}
    .sc-icon{font-size:18px;margin-bottom:4px;}
    .sc-val{font-size:18px;font-weight:800;line-height:1;color:var(--text);}
    .sc-val.g{color:var(--g3);}.sc-val.o{color:var(--orange);}.sc-val.r{color:var(--red);}.sc-val.b{color:var(--blue);}
    .sc-unit{font-size:9px;font-weight:600;}
    .sc-lbl{font-size:8.5px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-top:3px;}
    .sc-sub{font-size:9px;color:var(--muted);margin-top:2px;line-height:1.3;}
    .sc-bar{height:3px;background:#f3f4f6;border-radius:2px;overflow:hidden;margin-top:6px;}
    .sc-fill{height:100%;border-radius:2px;}

    /* ‚îÄ‚îÄ PAGE TABS ‚îÄ‚îÄ */
    .tab-section{display:none;padding:14px 13px 30px;max-width:640px;margin:0 auto;flex-direction:column;gap:14px;}
    .tab-section.active{display:flex;}

    /* ‚îÄ‚îÄ CARD ‚îÄ‚îÄ */
    .card{background:white;border-radius:var(--r);border:1px solid var(--border);overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.04);}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;border-bottom:1px solid var(--border);}
    .card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;}
    .card-body{padding:15px;}

    /* ‚îÄ‚îÄ PROFIL ‚îÄ‚îÄ */
    .profil-section-title{font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin:14px 0 8px;padding-bottom:5px;border-bottom:1px solid var(--border);}
    .profil-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
    .profil-field{display:flex;flex-direction:column;gap:3px;}
    .profil-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;}
    .profil-val{font-size:13px;font-weight:600;color:var(--text);padding:8px 10px;background:#f9fafb;border-radius:8px;border:1.5px solid var(--border);}
    .profil-val.editable{cursor:pointer;transition:all .15s;}
    .profil-val.editable:hover{border-color:var(--g3);background:var(--green-ghost);}
    .profil-input{width:100%;padding:8px 10px;border:1.5px solid var(--g3);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;color:var(--text);outline:none;background:white;box-shadow:0 0 0 3px rgba(5,150,105,.07);}
    .profil-input:focus{box-shadow:0 0 0 3px rgba(5,150,105,.12);}
    .profil-full{grid-column:1/-1;}
    .contrat-card{background:linear-gradient(135deg,var(--g1),var(--g2));border-radius:12px;padding:16px 18px;display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;}
    .contrat-left .contrat-type{font-size:15px;font-weight:800;color:white;margin-bottom:4px;}
    .contrat-left .contrat-sub{font-size:11px;color:rgba(255,255,255,.55);line-height:1.5;}
    .contrat-stat{text-align:right;}
    .contrat-stat .cs-val{font-size:18px;font-weight:800;color:#34d399;}
    .contrat-stat .cs-lbl{font-size:9.5px;color:rgba(255,255,255,.45);text-transform:uppercase;letter-spacing:.5px;}
    .btn-save-profil{width:100%;padding:11px;background:linear-gradient(135deg,var(--g3),var(--g4));color:white;border:none;border-radius:10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;margin-top:14px;display:none;}
    .btn-save-profil.show{display:block;}
    .btn-save-profil:hover{opacity:.9;}
    .urgence-card{background:var(--orange-bg);border:1.5px solid #fde68a;border-radius:10px;padding:12px 14px;display:flex;align-items:center;gap:10px;}
    .urgence-ico{font-size:22px;flex-shrink:0;}
    .urgence-body{flex:1;min-width:0;}
    .urgence-name{font-size:13px;font-weight:700;margin-bottom:1px;}
    .urgence-lien{font-size:11px;color:var(--muted);}
    .urgence-tel{font-size:12px;font-weight:700;color:var(--orange);margin-top:2px;}

    /* ‚îÄ‚îÄ DOCUMENTS ‚îÄ‚îÄ */
    .doc-section-lbl{font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin:14px 0 8px;padding-bottom:5px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
    .doc-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:1.5px solid var(--border);background:white;margin-bottom:7px;transition:all .15s;cursor:pointer;}
    .doc-item:hover{border-color:#6ee7b7;background:var(--green-ghost);}
    .doc-item.uploaded{border-color:#86efac;background:#f0fdf4;}
    .doc-item.required{border-color:#fca5a5;background:#fff5f5;}
    .doc-item.employer{border-color:#bfdbfe;background:#eff6ff;}
    .doc-ico{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
    .doc-ico.g{background:#dcfce7;}
    .doc-ico.r{background:#fee2e2;}
    .doc-ico.b{background:#dbeafe;}
    .doc-ico.o{background:#fef3c7;}
    .doc-info{flex:1;min-width:0;}
    .doc-name{font-size:12px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .doc-meta{font-size:10px;color:var(--muted);margin-top:1px;}
    .doc-action{flex-shrink:0;}
    .btn-view{padding:5px 11px;background:#dbeafe;color:#1e40af;border:none;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;}
    .badge-req{background:#fee2e2;color:#991b1b;font-size:9px;font-weight:800;padding:2px 6px;border-radius:20px;}
    .badge-ok{background:#dcfce7;color:#166534;font-size:9px;font-weight:800;padding:2px 6px;border-radius:20px;}
    .badge-emp{background:#dbeafe;color:#1e40af;font-size:9px;font-weight:800;padding:2px 6px;border-radius:20px;}
    .doc-progress-bar{height:6px;background:#f3f4f6;border-radius:99px;overflow:hidden;margin:8px 0 2px;}
    .doc-progress-fill{height:100%;background:linear-gradient(90deg,var(--g3),var(--g4));border-radius:99px;transition:width .5s ease;}
    .upload-zone{border:2px dashed var(--border);border-radius:10px;padding:20px 14px;text-align:center;cursor:pointer;background:white;transition:all .15s;margin-top:8px;}
    .upload-zone:hover{border-color:var(--g3);background:var(--green-ghost);}
    .upload-zone-icon{font-size:28px;margin-bottom:6px;}
    .upload-zone-txt{font-size:12px;font-weight:600;color:var(--muted);}
    .upload-zone-sub{font-size:10px;color:var(--muted);margin-top:2px;}

    /* ‚îÄ‚îÄ CONG√âS ‚îÄ‚îÄ */
    .stepper{display:flex;align-items:center;gap:0;margin-bottom:18px;}
    .step-dot{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;border:2px solid var(--border);background:white;color:var(--muted);transition:all .3s;flex-shrink:0;}
    .step-dot.done{background:var(--g3);border-color:var(--g3);color:white;}
    .step-dot.active{background:var(--green-ghost);border-color:var(--g3);color:var(--g3);}
    .step-line{flex:1;height:2px;background:var(--border);transition:background .3s;}
    .step-line.done{background:var(--g3);}
    .form-step{display:none;animation:fin .2s ease;}
    .form-step.active{display:block;}
    @keyframes fin{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
    .type-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:7px;margin-bottom:12px;}
    .tb{padding:10px 9px;border:2px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;background:white;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
    .tb:hover{border-color:var(--g4);background:var(--green-ghost);}
    .tb.sel{border-color:var(--g3);background:var(--green-ghost);}
    .tb-icon{font-size:19px;margin-bottom:3px;}
    .tb-lbl{font-size:11px;font-weight:700;color:var(--text);display:block;}
    .tb-sub{font-size:9.5px;color:var(--muted);display:block;margin-top:1px;}
    .field{display:flex;flex-direction:column;gap:4px;margin-bottom:11px;}
    .field label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;}
    .finput{width:100%;padding:10px 11px;border:1.5px solid var(--border);border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;color:var(--text);outline:none;transition:border-color .15s;-webkit-appearance:none;background:white;}
    .finput:focus{border-color:var(--g3);box-shadow:0 0 0 3px rgba(5,150,105,.07);}
    .date-row{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
    .alert{border-radius:8px;padding:9px 11px;font-size:12px;font-weight:600;margin-bottom:9px;display:none;line-height:1.5;}
    .alert.show{display:block;}
    .alert-green{background:var(--green-ghost);color:#065f46;border-left:3px solid var(--g3);}
    .alert-orange{background:var(--orange-bg);color:#92400e;border-left:3px solid var(--orange);}
    .alert-blue{background:var(--blue-bg);color:#1e40af;border-left:3px solid var(--blue);}
    .alert-red{background:var(--red-bg);color:#991b1b;border-left:3px solid var(--red);}
    .resume{border:2px solid var(--green-light);border-radius:10px;padding:13px;background:var(--green-ghost);margin-bottom:11px;}
    .resume-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--green-light);font-size:12px;}
    .resume-row:last-child{border-bottom:none;font-weight:700;font-size:13px;padding-top:7px;}
    .resume-row span:first-child{color:var(--muted);}
    .btn{padding:9px 16px;border:none;border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;justify-content:center;gap:5px;}
    .btn-green{background:linear-gradient(135deg,var(--g3),var(--g4));color:white;box-shadow:0 3px 10px rgba(5,150,105,.25);}
    .btn-green:hover{opacity:.9;transform:translateY(-1px);}
    .btn-green:active{transform:translateY(0);}
    .btn-green:disabled{opacity:.4;transform:none;cursor:not-allowed;}
    .btn-ghost{background:white;color:var(--g3);border:1.5px solid var(--green-light);}
    .btn-ghost:hover{background:var(--green-ghost);}
    .btn-row{display:flex;gap:7px;justify-content:flex-end;margin-top:12px;}
    .success-wrap{display:none;flex-direction:column;align-items:center;padding:28px 18px;text-align:center;}
    .success-wrap.show{display:flex;}
    .success-circle{width:60px;height:60px;background:var(--green-ghost);border:3px solid var(--green-light);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:12px;animation:pop .35s cubic-bezier(.34,1.56,.64,1);}
    @keyframes pop{from{transform:scale(0)}to{transform:scale(1)}}
    .success-title{font-size:16px;font-weight:800;margin-bottom:5px;}
    .success-sub{font-size:12px;color:var(--muted);max-width:270px;line-height:1.6;}
    .filter-tabs{display:flex;gap:4px;overflow-x:auto;padding-bottom:2px;margin-bottom:11px;scrollbar-width:none;}
    .filter-tabs::-webkit-scrollbar{display:none;}
    .ftab{padding:4px 11px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:white;color:var(--muted);white-space:nowrap;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
    .ftab.active{background:var(--g3);color:white;border-color:var(--g3);}
    .dem-item{display:flex;align-items:flex-start;gap:10px;padding:11px 0;border-bottom:1px solid #f3f4f6;}
    .dem-item:last-child{border-bottom:none;}
    .dem-ico{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;margin-top:1px;}
    .dem-body{flex:1;min-width:0;}
    .dem-name{font-size:12px;font-weight:700;margin-bottom:2px;}
    .dem-dates{font-size:11px;color:var(--muted);}
    .dem-motif{font-size:11px;color:var(--muted);font-style:italic;margin-top:2px;}
    .dem-refus{font-size:10.5px;color:var(--red);margin-top:3px;}
    .badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700;flex-shrink:0;margin-top:3px;}
    .badge-pending{background:#fef3c7;color:#92400e;}
    .badge-approved{background:#dcfce7;color:#166534;}
    .badge-refused{background:#fee2e2;color:#991b1b;}
    .badge-cancelled{background:#f3f4f6;color:#6b7280;}
    .year-btn{font-size:11px;font-weight:700;color:rgba(255,255,255,.4);background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);padding:5px 11px;border-radius:20px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;font-family:'Plus Jakarta Sans',sans-serif;}
    .year-btn:hover{background:rgba(255,255,255,.13);}

    /* ‚îÄ‚îÄ PLANNING ‚îÄ‚îÄ */
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;}
    .cal-hdr{font-size:9.5px;font-weight:700;color:var(--muted);padding:2px 0;}
    .cal-day{aspect-ratio:1;border-radius:5px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;font-weight:500;line-height:1.2;}
    .cal-day.work{font-weight:700;}
    .cal-day.off{opacity:0.4;}
    .cal-day.work-generic{font-weight:500;}
    .cal-day.today{outline:2px solid var(--g3);font-weight:800;}
    .cal-day.abs{color:white;font-weight:700;}
    .cal-day.abs-pending{opacity:.6;}

    /* ‚îÄ‚îÄ JUSTIFICATIF ‚îÄ‚îÄ */
    #justif-wrap{display:none;}
    #justif-preview{display:none;margin-top:7px;padding:8px 12px;background:var(--green-ghost);border:1px solid #6ee7b7;border-radius:8px;align-items:center;gap:8px;}

    /* ‚îÄ‚îÄ INFOS LINE ‚îÄ‚îÄ */
    .info-line{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #f3f4f6;font-size:12px;}
    .info-line:last-child{border-bottom:none;}
    .info-line-icon{font-size:15px;flex-shrink:0;width:20px;text-align:center;}
    .info-line-label{color:var(--muted);width:110px;flex-shrink:0;font-size:11px;}
    .info-line-val{font-weight:600;flex:1;color:var(--text);}

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    .toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(80px);background:#1a1f36;color:white;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:all .3s;white-space:nowrap;}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
    .toast.ok{background:var(--g3);}.toast.err{background:var(--red);}.toast.warn{background:var(--orange);}

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
    .modal-overlay{position:fixed;inset:0;background:rgba(5,46,22,.5);backdrop-filter:blur(4px);z-index:200;display:none;align-items:flex-end;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:18px 18px 0 0;width:100%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 -8px 40px rgba(0,0,0,.15);}
    .modal-head{padding:16px 18px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:white;z-index:1;}
    .modal-head h3{font-size:14px;font-weight:800;}
    .modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);}
    .modal-body{padding:16px 18px 20px;}

    /* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
    .empty{display:flex;flex-direction:column;align-items:center;padding:26px;text-align:center;color:var(--muted);}
    .empty-icon{font-size:30px;margin-bottom:7px;}

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media(max-width:480px){
      .soldes-grid{grid-template-columns:1fr 1fr;}
      .date-row{grid-template-columns:1fr;}
      .hero{padding:18px 13px 82px;}
      .profil-row{grid-template-columns:1fr;}
      .tnav{padding:12px 11px;font-size:11px;}
    }
  </style>
</head>
<body>

<div id="loading-wrap">
  <div class="load-logo">üåø ALTEORE</div>
  <div class="spin"></div>
  <div class="load-sub">Chargement de votre espace‚Ä¶</div>
</div>

<div id="not-found">
  <div class="nf-icon">üîó</div>
  <div class="nf-title">Lien invalide</div>
  <div class="nf-sub">Ce lien n'est pas valide ou a expir√©.<br>Demandez √† votre employeur un nouveau lien d'acc√®s.</div>
</div>

<div id="main-wrap" style="display:none">

  <!-- ‚ïê‚ïê HERO ‚ïê‚ïê -->
  <div class="hero">
    <div class="hero-top">
      <div class="hero-brand">
        <div class="hero-brand-icon">üåø</div>
        <div class="hero-brand-name">ALTEORE</div>
      </div>
      <button class="year-btn" onclick="changeYear()" id="year-btn">üìÖ <span id="year-lbl"></span></button>
    </div>
    <div class="hero-body">
      <div class="hero-avatar" id="hero-av">?</div>
      <div class="hero-info">
        <div class="hero-name" id="hero-name">‚Äî</div>
        <div class="hero-sub" id="hero-sub">‚Äî</div>
        <div class="hero-chips" id="hero-chips"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê SOLDES ‚ïê‚ïê -->
  <div class="soldes-wrap"><div class="soldes-grid" id="soldes-grid"></div></div>

  <!-- ‚ïê‚ïê NAVIGATION ONGLETS ‚ïê‚ïê -->
  <div class="tabs-nav" style="margin-top:14px">
    <div class="tabs-inner">
      <button class="tnav active" onclick="showTab('accueil',this)">üè† Accueil</button>
      <button class="tnav" onclick="showTab('profil',this)">üë§ Mon profil</button>
      
      <button class="tnav" onclick="showTab('conges',this)" id="tab-conges-btn">üèñÔ∏è Cong√©s</button>
      <button class="tnav" onclick="showTab('planning',this)">üìÖ Planning</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê ONGLET ACCUEIL ‚ïê‚ïê -->
  <div class="tab-section active" id="tab-accueil" style="margin-top:16px">

    <!-- Bienvenue -->
    <div class="card">
      <div class="card-body" style="padding:18px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
          <div style="font-size:32px">üëã</div>
          <div>
            <div style="font-size:15px;font-weight:800;color:var(--text)" id="welcome-name">Bienvenue !</div>
            <div style="font-size:11px;color:var(--muted)" id="welcome-date"></div>
          </div>
        </div>
        <div id="accueil-infos" style="display:flex;flex-direction:column;gap:0"></div>
      </div>
    </div>

    <!-- Solde rapide -->
    <div class="card">
      <div class="card-head"><div class="card-title">üìä Mes soldes <span style="font-size:10px;font-weight:400;color:var(--muted)" id="accueil-annee-lbl"></span></div></div>
      <div class="card-body" style="padding:10px 14px">
        <div id="accueil-soldes"></div>
      </div>
    </div>

    <!-- Demandes r√©centes -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">üìã Derni√®res demandes</div>
        <button class="btn-ghost btn" style="font-size:11px;padding:4px 10px" onclick="showTab('conges',document.querySelector('.tnav:nth-child(4))'))">Voir tout</button>
      </div>
      <div class="card-body" style="padding-top:8px" id="accueil-demandes"></div>
    </div>

    <!-- Actions rapides -->
    <div class="card">
      <div class="card-head"><div class="card-title">‚ö° Actions rapides</div></div>
      <div class="card-body" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <button class="btn btn-green" onclick="showTab('conges',document.querySelectorAll('.tnav')[3])">‚úâÔ∏è Demander un cong√©</button>
        <button class="btn btn-ghost" onclick="showTab('profil',document.querySelectorAll('.tnav')[1])">‚úèÔ∏è Modifier mon profil</button>
        <button class="btn btn-ghost" onclick="showTab('planning',document.querySelectorAll('.tnav')[4])">üìÖ Voir mon planning</button>
      </div>
    </div>

  </div>

  <!-- ‚ïê‚ïê ONGLET PROFIL ‚ïê‚ïê -->
  <div class="tab-section" id="tab-profil" style="margin-top:16px">

    <!-- Carte contrat -->
    <div id="contrat-card-wrap"></div>

    <!-- Infos personnelles modifiables -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">üë§ Informations personnelles</div>
        <span style="font-size:10px;color:var(--muted)">‚úèÔ∏è Modifiable</span>
      </div>
      <div class="card-body">
        <div class="profil-section-title">Coordonn√©es</div>
        <div class="profil-row">
          <div class="profil-field">
            <div class="profil-label">Pr√©nom</div>
            <div class="profil-val" id="pf-prenom"></div>
          </div>
          <div class="profil-field">
            <div class="profil-label">Nom</div>
            <div class="profil-val" id="pf-nom"></div>
          </div>
        </div>
        <div class="profil-row">
          <div class="profil-field">
            <div class="profil-label">Email personnel</div>
            <div class="profil-val editable" id="pf-email-perso" onclick="editField(this,'emailPerso')" title="Cliquer pour modifier">‚Äî</div>
          </div>
          <div class="profil-field">
            <div class="profil-label">T√©l√©phone</div>
            <div class="profil-val editable" id="pf-tel" onclick="editField(this,'telephone')" title="Cliquer pour modifier">‚Äî</div>
          </div>
        </div>
        <div class="profil-row profil-full">
          <div class="profil-field">
            <div class="profil-label">Adresse</div>
            <div class="profil-val editable" id="pf-adresse" onclick="editField(this,'adresse')" title="Cliquer pour modifier">‚Äî</div>
          </div>
        </div>
        <div class="profil-row">
          <div class="profil-field">
            <div class="profil-label">Date de naissance</div>
            <div class="profil-val editable" id="pf-ddn" onclick="editField(this,'dateNaissance')" title="Cliquer pour modifier">‚Äî</div>
          </div>
          <div class="profil-field">
            <div class="profil-label">Nationalit√©</div>
            <div class="profil-val editable" id="pf-nat" onclick="editField(this,'nationalite')" title="Cliquer pour modifier">‚Äî</div>
          </div>
        </div>

        <div class="profil-section-title">Informations bancaires</div>
        <div class="profil-row">
          <div class="profil-field">
            <div class="profil-label">IBAN</div>
            <div class="profil-val editable" id="pf-iban" onclick="editField(this,'iban')" title="Cliquer pour modifier">‚Äî</div>
          </div>
          <div class="profil-field">
            <div class="profil-label">Titulaire du compte</div>
            <div class="profil-val editable" id="pf-titulaire" onclick="editField(this,'ibanTitulaire')" title="Cliquer pour modifier">‚Äî</div>
          </div>
        </div>
        <div style="font-size:10px;color:var(--muted);background:#fafafa;padding:8px 10px;border-radius:8px;border:1px solid var(--border)">
          üîí Vos informations bancaires sont stock√©es de fa√ßon s√©curis√©e et uniquement accessibles par votre employeur pour le versement de votre salaire.
        </div>

        <div class="profil-section-title">Contact d'urgence</div>
        <div id="urgence-wrap"></div>
        <div class="profil-row" style="margin-top:8px">
          <div class="profil-field">
            <div class="profil-label">Nom & pr√©nom</div>
            <div class="profil-val editable" id="pf-urgence-nom" onclick="editField(this,'contactUrgenceNom')" title="Cliquer pour modifier">‚Äî</div>
          </div>
          <div class="profil-field">
            <div class="profil-label">Lien (ex : conjoint)</div>
            <div class="profil-val editable" id="pf-urgence-lien" onclick="editField(this,'contactUrgenceLien')" title="Cliquer pour modifier">‚Äî</div>
          </div>
        </div>
        <div class="profil-row">
          <div class="profil-field">
            <div class="profil-label">T√©l√©phone urgence</div>
            <div class="profil-val editable" id="pf-urgence-tel" onclick="editField(this,'contactUrgenceTel')" title="Cliquer pour modifier">‚Äî</div>
          </div>
        </div>

        <button class="btn-save-profil" id="btn-save-profil" onclick="saveProfil()">üíæ Enregistrer les modifications</button>
      </div>
    </div>

    <!-- Informations contrat (lecture seule) -->
    <div class="card">
      <div class="card-head"><div class="card-title">üìÑ Mon contrat <span style="font-size:10px;color:var(--muted);font-weight:400">‚Äî g√©r√© par votre employeur</span></div></div>
      <div class="card-body" id="contrat-body"></div>
    </div>

  </div>

  <!-- ‚ïê‚ïê ONGLET DOCUMENTS ‚ïê‚ïê -->
  <div class="tab-section" id="tab-conges" style="margin-top:16px">

    <!-- Soldes d√©taill√©s -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">üìä Mes soldes <span id="conges-annee-lbl" style="font-size:10px;font-weight:400;color:var(--muted)"></span></div>
      </div>
      <div class="card-body" style="padding:10px 14px" id="soldes-detail"></div>
    </div>

    <!-- Nouvelle demande -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">‚úâÔ∏è Faire une demande</div>
        <span id="step-lbl" style="font-size:11px;color:var(--muted)">√âtape 1 / 3</span>
      </div>
      <div class="card-body">
        <div class="stepper">
          <div class="step-dot active" id="s1">1</div>
          <div class="step-line" id="sl1"></div>
          <div class="step-dot" id="s2">2</div>
          <div class="step-line" id="sl2"></div>
          <div class="step-dot" id="s3">3</div>
        </div>
        <div class="form-step active" id="st1">
          <div style="font-size:12px;font-weight:700;margin-bottom:10px">Quel type de cong√© ?</div>
          <div class="type-grid" id="type-grid"></div>
          <div class="alert alert-blue" id="evenement-loi">
            <strong>Dur√©es l√©gales :</strong><br>
            Mariage / PACS : 4j &nbsp;¬∑&nbsp; Naissance / Adoption : 3j<br>
            D√©c√®s conjoint ou enfant : 5j &nbsp;¬∑&nbsp; D√©c√®s parent : 3j &nbsp;¬∑&nbsp; D√©c√®s beau-parent : 3j
          </div>
          <div class="btn-row"><button class="btn btn-green" id="next1" onclick="goStep(2)" disabled>Suivant ‚Üí</button></div>
        </div>
        <div class="form-step" id="st2">
          <div class="date-row">
            <div class="field"><label>Date de d√©but</label><input class="finput" type="date" id="f-deb" oninput="onDateChg()"/></div>
            <div class="field"><label>Date de fin</label><input class="finput" type="date" id="f-fin" oninput="onDateChg()"/></div>
          </div>
          <div class="alert alert-green" id="jours-alert"></div>
          <div class="alert alert-orange" id="solde-alert"></div>
          <div class="field"><label>Motif (facultatif)</label><input class="finput" type="text" id="f-motif" placeholder="Ex : vacances, formation, √©v√©nement‚Ä¶"/></div>
          <div id="justif-wrap" style="margin-bottom:11px">
            <div class="field" style="margin-bottom:0">
              <label>üìé Justificatif <span style="font-weight:400;text-transform:none;letter-spacing:0">(arr√™t maladie, ordonnance‚Ä¶)</span></label>
              <div id="justif-drop" onclick="document.getElementById('justif-input').click()" style="border:2px dashed var(--border);border-radius:10px;padding:18px 12px;text-align:center;cursor:pointer;background:white;transition:all .15s;" onmouseover="this.style.borderColor='var(--g3)';this.style.background='var(--green-ghost)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='white'">
                <div style="font-size:26px;margin-bottom:4px">üìÑ</div>
                <div style="font-size:12px;font-weight:600;color:var(--muted)">Appuyez pour joindre un fichier</div>
                <div style="font-size:10px;color:var(--muted);margin-top:2px">PDF, JPG, PNG ¬∑ Max 5 Mo ¬∑ Facultatif</div>
              </div>
              <input type="file" id="justif-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="onJustifChange(this)"/>
              <div id="justif-preview" style="margin-top:7px;padding:8px 12px;background:var(--green-ghost);border:1px solid #6ee7b7;border-radius:8px;align-items:center;gap:8px;">
                <span style="font-size:16px">üìé</span>
                <span id="justif-name" style="flex:1;font-size:12px;font-weight:600;color:#065f46;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
                <span id="justif-size" style="font-size:11px;color:var(--muted);flex-shrink:0"></span>
                <button onclick="clearJustif(event)" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:15px;padding:0 2px;flex-shrink:0;line-height:1">‚úï</button>
              </div>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn btn-ghost" onclick="goStep(1)">‚Üê Retour</button>
            <button class="btn btn-green" id="next2" onclick="goStep(3)" disabled>V√©rifier ‚Üí</button>
          </div>
        </div>
        <div class="form-step" id="st3">
          <div style="font-size:12px;font-weight:700;margin-bottom:11px">R√©capitulatif</div>
          <div class="resume" id="recap"></div>
          <div class="alert alert-orange" id="recap-warn"></div>
          <div class="btn-row">
            <button class="btn btn-ghost" onclick="goStep(2)">‚Üê Modifier</button>
            <button class="btn btn-green" id="btn-submit" onclick="submitDemande()">‚úâÔ∏è Envoyer la demande</button>
          </div>
        </div>
        <div class="success-wrap" id="success-wrap">
          <div class="success-circle">‚úÖ</div>
          <div class="success-title">Demande envoy√©e !</div>
          <div class="success-sub" id="success-sub">Votre demande a √©t√© transmise.</div>
          <button class="btn btn-green" style="margin-top:14px" onclick="resetForm()">+ Nouvelle demande</button>
        </div>
      </div>
    </div>

    <!-- Historique demandes -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">üìã Mes demandes</div>
        <span id="dem-count" style="font-size:11px;color:var(--muted)"></span>
      </div>
      <div class="card-body" style="padding-top:10px">
        <div class="filter-tabs">
          <button class="ftab active" onclick="setFilter(this,'all')">Toutes</button>
          <button class="ftab" onclick="setFilter(this,'pending')">‚è≥ Attente</button>
          <button class="ftab" onclick="setFilter(this,'approved')">‚úÖ Approuv√©es</button>
          <button class="ftab" onclick="setFilter(this,'refused')">‚ùå Refus√©es</button>
          <button class="ftab" onclick="setFilter(this,'cancelled')">üö´ Annul√©es</button>
        </div>
        <div id="dem-list"></div>
      </div>
    </div>

  </div>

  <!-- ‚ïê‚ïê ONGLET PLANNING ‚ïê‚ïê -->
  <div class="tab-section" id="tab-planning" style="margin-top:16px">
    <div class="card">
      <div class="card-head">
        <div class="card-title">üìÖ <span id="cal-title">Mon calendrier</span></div>
        <div style="display:flex;gap:5px">
          <button class="btn btn-ghost" style="padding:4px 9px;font-size:12px" onclick="prevM()">‚Äπ</button>
          <button class="btn btn-ghost" style="padding:4px 9px;font-size:12px" onclick="nextM()">‚Ä∫</button>
        </div>
      </div>
      <div class="card-body" style="padding:12px">
        <div class="cal-grid" id="cal-grid"></div>
        <div style="display:flex;flex-wrap:wrap;gap:7px;margin-top:9px" id="cal-legend"></div>
      </div>
    </div>
    <!-- Horaires habituels -->
    <div class="card" id="horaires-card">
      <div class="card-head"><div class="card-title">‚è∞ Mes horaires habituels</div></div>
      <div class="card-body" id="horaires-body"></div>
    </div>
  </div>

  <div style="text-align:center;padding:8px 0 16px;color:var(--muted);font-size:10.5px">
    Propuls√© par <strong>ALTEORE</strong> ¬∑ Portail salari√© s√©curis√©
  </div>
</div>



<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê FIREBASE ‚ïê‚ïê -->
<script type="module">  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, addDoc, getDocs, collection, query, where }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com", projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746", appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const db = getFirestore(app);
  window._db = db;
  window._getDoc   = (path, ...s) => getDoc(doc(db, path, ...s));
  window._setDocFs = (path, id, data, opts) => setDoc(doc(db, path, id), data, opts||{});
  window._setDocPath = (segments, data, opts) => {
    const ref2 = doc(db, ...segments);
    return setDoc(ref2, data, opts||{});
  };
  window._addDoc   = (colPath, data) => addDoc(collection(db, ...colPath), data);
  window._getDocs  = (...colPath) => getDocs(collection(db, ...colPath));
  window._queryWhere = (colPath, field, val) =>
    getDocs(query(collection(db, ...colPath), where(field, '==', val)));
  window._dbReady = true;
  // Attendre que startApp soit d\u00e9fini par le script inline
  function tryStart() {
    if(typeof window.startApp === 'function') { window.startApp(); }
    else { setTimeout(tryStart, 30); }
  }
  tryStart();
</script>

<script>
(function(){
var b="Lyog4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCiAgIENPTlNUQU5URVMK4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQICovCnZhciBDT0xPUlMgPSB7Y3A6JyMwNTk2NjknLHJ0dDonIzNiODJmNicsY3NzOicjZjU5ZTBiJyxldmVuZW1lbnQ6JyM3YzNhZWQnLG1hbGFkaWU6JyNlZjQ0NDQnLHJlY3VwZXJhdGlvbjonIzA4OTFiMicsZm9ybWF0aW9uOicjZGIyNzc3J307CnZhciBMQUJFTFMgID0ge2NwOidDb25nXHUwMGU5cyBwYXlcdTAwZTlzJyxydHQ6J1JUVCcsY3NzOidTYW5zIHNvbGRlJyxldmVuZW1lbnQ6J1x1MDBjOXZcdTAwZTluZW1lbnQgZmFtaWxpYWwnLG1hbGFkaWU6J01hbGFkaWUgLyBBcnJcdTAwZWF0JyxyZWN1cGVyYXRpb246J1JcdTAwZTljdXBcdTAwZTlyYXRpb24gaGV1cmVzJyxmb3JtYXRpb246J0Zvcm1hdGlvbid9Owp2YXIgSUNPTlMgICA9IHtjcDonXHVkODNjXHVkZmQ2XHVmZTBmJyxydHQ6J1x1MjNmMCcsY3NzOidcdWQ4M2RcdWRjYmMnLGV2ZW5lbWVudDonXHVkODNjXHVkZjg5JyxtYWxhZGllOidcdWQ4M2VcdWRkMTInLHJlY3VwZXJhdGlvbjonXHVkODNkXHVkZDA0Jyxmb3JtYXRpb246J1x1ZDgzY1x1ZGY5Myd9Owp2YXIgU09MREVfSyA9IHtjcDonY3BSZXN0YW50JyxydHQ6J3J0dFJlc3RhbnQnLHJlY3VwZXJhdGlvbjoncmVjdXBSZXN0YW50J307CnZhciBET1dfS0VZID0gWydsdW5kaScsJ21hcmRpJywnbWVyY3JlZGknLCdqZXVkaScsJ3ZlbmRyZWRpJywnc2FtZWRpJywnZGltYW5jaGUnXTsKCi8vIERvY3VtZW50cyByZXF1aXMgLSBsYWJlbHMgZW4gdW5pY29kZSBwdXIgcG91ciBjb21wYXRpYmlsaXRlIFNhZmFyaQpmdW5jdGlvbiBlc2NIdG1sKHMpeyByZXR1cm4gKHN8fCIiKS5yZXBsYWNlKC8mL2csIiZhbXA7IikucmVwbGFjZSgvIi9nLCImcXVvdDsiKS5yZXBsYWNlKC88L2csIiZsdDsiKS5yZXBsYWNlKC8+L2csIiZndDsiKTsgfQovLyBFY2hhcHBlciBsZXMgbGFiZWxzIHBvdXIgdXNhZ2UgZGFucyBvbmNsaWNrIEhUTUwKZnVuY3Rpb24gZXNjSHRtbChzKXsgcmV0dXJuIChzfHwnJykucmVwbGFjZSgvJi9nLCcmYW1wOycpLnJlcGxhY2UoLyIvZywnJnF1b3Q7JykucmVwbGFjZSgvJy9nLCcmIzM5OycpLnJlcGxhY2UoLzwvZywnJmx0OycpLnJlcGxhY2UoLz4vZywnJmd0OycpOyB9CgovKiDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKICAgw4lUQVQgR0xPQkFMCuKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkCAqLwp2YXIgX3VpZD0nJywgX2VtcElkPScnLCBfZW1wPXt9LCBfcGFyYW1zPXt9LCBfZGVtYW5kZXM9W107CnZhciBfc29sZGVzPXt9Owp2YXIgX3NlbFR5cGU9Jyc7CnZhciBfZGVtRmlsdGVyPSdhbGwnOwp2YXIgX2NhbE1vbnRoPW5ldyBEYXRlKCk7CnZhciBfeWVhcj1uZXcgRGF0ZSgpLmdldEZ1bGxZZWFyKCk7CnZhciBfcGxhbm5pbmdDYWNoZT17fTsKdmFyIF9wcm9maWxFZGl0cz17fTsgICAgICAgLy8gbW9kaWZpY2F0aW9ucyBlbiBhdHRlbnRlCnZhciBfcHJvZmlsRmllbGRzPXt9OyAgICAgIC8vIHZhbGV1cnMgYWN0dWVsbGVzIGR1IHByb2ZpbCDDqXRlbmR1CnZhciBfZG9jc0VtcGxveWVyPVtdOyAgICAgIC8vIFt7bGFiZWwsIG5hbWUsIHVwbG9hZGVkQXQsIGRhdGF9XQoKLyog4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCiAgIETDiU1BUlJBR0UK4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQICovCndpbmRvdy5zdGFydEFwcCA9IGZ1bmN0aW9uKCkgewogIHZhciBwID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKTsKICB2YXIgcGlkID0gcC5nZXQoJ2lkJykgfHwgJyc7CiAgaWYgKCFwaWQpIHsgc2hvd05vdEZvdW5kKCk7IHJldHVybjsgfQogIHZhciB0ID0gc2V0SW50ZXJ2YWwoZnVuY3Rpb24oKSB7CiAgICBpZiAod2luZG93Ll9kYlJlYWR5KSB7IGNsZWFySW50ZXJ2YWwodCk7IGxvYWRFbXBsb3llKHBpZCk7IH0KICB9LCA4MCk7Cn07Cgphc3luYyBmdW5jdGlvbiBsb2FkRW1wbG95ZShwaWQpIHsKICB0cnkgewogICAgdmFyIHNuYXAgPSBhd2FpdCB3aW5kb3cuX2dldERvYygncmhfZW1wbG95ZXNfcHVibGljJywgcGlkKTsKICAgIGlmICghc25hcC5leGlzdHMoKSkgeyBzaG93Tm90Rm91bmQoKTsgcmV0dXJuOyB9CiAgICB2YXIgZGF0YSA9IHNuYXAuZGF0YSgpOwogICAgX3VpZCA9IGRhdGEudWlkOyBfZW1wSWQgPSBkYXRhLmVtcElkOyBfZW1wID0gZGF0YTsKCiAgICAvLyBDaGFyZ2VyIGxlIHByb2ZpbCDDqXRlbmR1IChkb25uw6llcyBzYWlzaWVzIHBhciBsZSBzYWxhcmnDqSkKICAgIHRyeSB7CiAgICAgIHZhciBwcm9mU25hcCA9IGF3YWl0IHdpbmRvdy5fZ2V0RG9jKCdyaF9lbXBsb3llc19wdWJsaWNfcHJvZmlsJywgcGlkKTsKICAgICAgaWYgKHByb2ZTbmFwLmV4aXN0cygpKSB7CiAgICAgICAgX3Byb2ZpbEZpZWxkcyA9IHByb2ZTbmFwLmRhdGEoKTsKICAgICAgfQogICAgfSBjYXRjaChlKSB7IF9wcm9maWxGaWVsZHMgPSB7fTsgfQoKICAgIC8vIENoYXJnZXIgcGFyYW1zIFJICiAgICB0cnkgewogICAgICB2YXIgcHMgPSBhd2FpdCB3aW5kb3cuX2dldERvYygncmhfcGFyYW1zJywgX3VpZCk7CiAgICAgIF9wYXJhbXMgPSBwcy5leGlzdHMoKSA/IHBzLmRhdGEoKSA6IHt9OwogICAgfSBjYXRjaChlKSB7IF9wYXJhbXMgPSB7fTsgfQoKICAgIC8vIENoYXJnZXIgZG9ubsOpZXMgZW1wbG95w6kgcHJpdsOpZXMgKGxlY3R1cmUgc2V1bGUpCiAgICB0cnkgewogICAgICB2YXIgZW1wU25hcCA9IGF3YWl0IHdpbmRvdy5fZ2V0RG9jKCdyaCcsIF91aWQsICdlbXBsb3llcycsIF9lbXBJZCk7CiAgICAgIGlmIChlbXBTbmFwLmV4aXN0cygpKSB7CiAgICAgICAgdmFyIGVkID0gZW1wU25hcC5kYXRhKCk7CiAgICAgICAgLy8gRnVzaW9uIHPDqWN1cmlzw6llIGRlcyBkb25uw6llcyBSTwogICAgICAgIFsnc2FsYWlyZUJydXQnLCdzYWxhaXJlTmV0JywnaGV1cmVzSGViZG8nLCdmcmVxdWVuY2UnLCdjYXRlZ29yaWVQb3N0ZScsJ2NjbicsCiAgICAgICAgICdkYXRlTmFpc3NhbmNlJywnbmF0aW9uYWxpdGUnLCdwZXJpb2RlRXNzYWknLCdub3RlTW95ZW5uZSddLmZvckVhY2goZnVuY3Rpb24oayl7CiAgICAgICAgICBpZihlZFtrXSAhPT0gdW5kZWZpbmVkICYmIF9lbXBba10gPT09IHVuZGVmaW5lZCkgX2VtcFtrXSA9IGVkW2tdOwogICAgICAgIH0pOwogICAgICAgIC8vIERvY3VtZW50cyBkw6lwb3PDqXMgcGFyIGwnZW1wbG95ZXVyCiAgICAgICAgaWYoZWQuZG9jdW1lbnRzRW1wbG95ZXVyKSBfZG9jc0VtcGxveWVyID0gZWQuZG9jdW1lbnRzRW1wbG95ZXVyOwogICAgICAgIC8vIERvY3VtZW50cyBkdSBzYWxhcmnDqSBkw6lqw6Agc3RvY2vDqXMKICAgICAgfQogICAgfSBjYXRjaChlKSB7fQoKICAgIGF3YWl0IGxvYWREZW1hbmRlcygpOwogICAgYXdhaXQgbG9hZFBsYW5uaW5nTW9udGgoX2NhbE1vbnRoLmdldEZ1bGxZZWFyKCksIF9jYWxNb250aC5nZXRNb250aCgpKTsKICAgIGNhbGNTb2xkZXMoKTsKICAgIHJlbmRlckFsbCgpOwoKICAgIHZhciBsdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2FkaW5nLXdyYXAnKTsKICAgIGx3LmNsYXNzTGlzdC5hZGQoJ2ZhZGUnKTsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IGx3LnN0eWxlLmRpc3BsYXk9J25vbmUnOyBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFpbi13cmFwJykuc3R5bGUuZGlzcGxheT0nYmxvY2snOyB9LCA0MDApOwogIH0gY2F0Y2goZSkgeyBjb25zb2xlLmVycm9yKGUpOyBzaG93Tm90Rm91bmQoKTsgfQp9CgovKiDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKICAgQ0hBUkdFTUVOVCBET05Ow4lFUwrilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAgKi8KYXN5bmMgZnVuY3Rpb24gbG9hZERlbWFuZGVzKCkgewogIF9kZW1hbmRlcyA9IFtdOwogIHRyeSB7CiAgICB2YXIgc25hcCA9IGF3YWl0IHdpbmRvdy5fcXVlcnlXaGVyZShbJ3JoX2NvbmdlcycsIF91aWQsICdkZW1hbmRlcyddLCAnZW1wSWQnLCBfZW1wSWQpOwogICAgc25hcC5mb3JFYWNoKGZ1bmN0aW9uKGQpIHsgX2RlbWFuZGVzLnB1c2goT2JqZWN0LmFzc2lnbih7aWQ6ZC5pZH0sIGQuZGF0YSgpKSk7IH0pOwogICAgX2RlbWFuZGVzLnNvcnQoZnVuY3Rpb24oYSxiKSB7IHJldHVybiAoYi5jcmVhdGVkQXR8fCcnKS5sb2NhbGVDb21wYXJlKGEuY3JlYXRlZEF0fHwnJyk7IH0pOwogIH0gY2F0Y2goZSkgeyBjb25zb2xlLndhcm4oJ0RlbWFuZGVzOicsIGUubWVzc2FnZSk7IH0KfQoKYXN5bmMgZnVuY3Rpb24gbG9hZFBsYW5uaW5nTW9udGgoeSwgbSkgewogIF9wbGFubmluZ0NhY2hlID0ge307CiAgaWYgKCFfdWlkIHx8ICFfZW1wSWQpIHJldHVybjsKICB2YXIgd2Vla0tleXMgPSB7fTsKICB2YXIgbmIgPSBuZXcgRGF0ZSh5LCBtKzEsIDApLmdldERhdGUoKTsKICBmb3IgKHZhciBkID0gMTsgZCA8PSBuYjsgZCsrKSB7CiAgICB2YXIgZHQgPSBuZXcgRGF0ZSh5LCBtLCBkKTsKICAgIHZhciBtb24gPSBuZXcgRGF0ZShkdCk7CiAgICB2YXIgZGF5ID0gbW9uLmdldERheSgpLCBkaWZmID0gKGRheSA9PT0gMCkgPyAtNiA6IDEgLSBkYXk7CiAgICBtb24uc2V0RGF0ZShtb24uZ2V0RGF0ZSgpICsgZGlmZik7CiAgICBtb24uc2V0SG91cnMoMCwwLDAsMCk7CiAgICB2YXIgd2sgPSBtb24udG9JU09TdHJpbmcoKS5zbGljZSgwLDEwKS5yZXBsYWNlKC8tL2csJycpOwogICAgd2Vla0tleXNbd2tdID0gdHJ1ZTsKICB9CiAgZm9yICh2YXIgd2sgaW4gd2Vla0tleXMpIHsKICAgIHRyeSB7CiAgICAgIHZhciBzbmFwID0gYXdhaXQgd2luZG93Ll9nZXREb2NzKCdyaCcsIF91aWQsICdwbGFuXycrd2spOwogICAgICBzbmFwLmZvckVhY2goZnVuY3Rpb24oZG9jKSB7CiAgICAgICAgaWYgKGRvYy5pZC5lbmRzV2l0aCgnXycrX2VtcElkKSkgewogICAgICAgICAgdmFyIGRhdGVTdHIgPSBkb2MuaWQucmVwbGFjZSgnXycrX2VtcElkLCAnJyk7CiAgICAgICAgICB2YXIgZGF0YSA9IGRvYy5kYXRhKCk7CiAgICAgICAgICBfcGxhbm5pbmdDYWNoZVtkYXRlU3RyXSA9IChkYXRhLml0ZW1zIHx8IFtdKS5maWx0ZXIoZnVuY3Rpb24oaXQpIHsKICAgICAgICAgICAgcmV0dXJuIGl0LnR5cGUgPT09ICd0cmF2YWlsJyB8fCBpdC50eXBlID09PSAnZm9ybWF0aW9uJyB8fCBpdC50eXBlID09PSAnYXN0cmVpbnRlJzsKICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgfSk7CiAgICB9IGNhdGNoKGUpIHt9CiAgfQp9CgovKiDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKICAgQ0FMQ1VMIFNPTERFUwrilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAgKi8KZnVuY3Rpb24gY2FsY1NvbGRlcygpIHsKICB2YXIgbm93ID0gbmV3IERhdGUoKTsKICB2YXIgeSA9IF95ZWFyOwogIHZhciBjcEFubnVlbHMgPSBwYXJzZUZsb2F0KF9wYXJhbXMuY3BBbm51ZWxzKSB8fCAyNTsKICB2YXIgY3BQZXJpb2RlID0gX3BhcmFtcy5jcFBlcmlvZGUgfHwgJzFqdWluJzsKICB2YXIgcnR0QW5udWVscyA9IHBhcnNlRmxvYXQoX3BhcmFtcy5ydHRBbm51ZWxzKSB8fCAwOwogIHZhciBwRGViLCBwRmluOwogIGlmIChjcFBlcmlvZGUgPT09ICcxamFudicpIHsgcERlYiA9IG5ldyBEYXRlKHksMCwxKTsgcEZpbiA9IG5ldyBEYXRlKHksMTEsMzEpOyB9CiAgZWxzZSB7IHBEZWIgPSBuZXcgRGF0ZSh5LTEsNSwxKTsgcEZpbiA9IG5ldyBEYXRlKHksNCwzMSk7IH0KICB2YXIgZW50cmVlID0gX2VtcC5kYXRlRW50cmVlID8gbmV3IERhdGUoX2VtcC5kYXRlRW50cmVlKydUMTI6MDA6MDAnKSA6IG5ldyBEYXRlKHktMiwwLDEpOwogIHZhciBkZWJ1dCA9IGVudHJlZSA+IHBEZWIgPyBlbnRyZWUgOiBwRGViOwogIHZhciBmaW4gPSBub3cgPCBwRmluID8gbm93IDogcEZpbjsKICB2YXIgbW9pcyA9IE1hdGgubWF4KDAsIChmaW4uZ2V0RnVsbFllYXIoKS1kZWJ1dC5nZXRGdWxsWWVhcigpKSoxMiArIChmaW4uZ2V0TW9udGgoKS1kZWJ1dC5nZXRNb250aCgpKSk7CiAgdmFyIGFqdXN0ID0gcGFyc2VGbG9hdChfZW1wLmNwQWp1c3RBY3F1aXMpIHx8IDA7CiAgdmFyIGNwQWNxdWlzID0gTWF0aC5yb3VuZChNYXRoLm1heCgwLCBtb2lzKihjcEFubnVlbHMvMTIpK2FqdXN0KSoxMCkvMTA7CiAgdmFyIGNwUHJpcyA9IF9kZW1hbmRlcy5maWx0ZXIoZnVuY3Rpb24oZCkgewogICAgaWYgKCFkLmRhdGVEZWJ1dCB8fCBkLnR5cGUgIT09ICdjcCcgfHwgZC5zdGF0dXQgIT09ICdhcHByb3ZlZCcpIHJldHVybiBmYWxzZTsKICAgIHZhciBkdCA9IG5ldyBEYXRlKGQuZGF0ZURlYnV0KydUMTI6MDA6MDAnKTsKICAgIHJldHVybiBkdCA+PSBwRGViICYmIGR0IDw9IHBGaW47CiAgfSkucmVkdWNlKGZ1bmN0aW9uKHMsZCkgeyByZXR1cm4gcyArIChkLm5iSm91cnN8fDApOyB9LCAwKTsKICB2YXIgcnR0QmFzZSA9IChwYXJzZUZsb2F0KF9lbXAucnR0QWp1c3QpID49IDApID8gcGFyc2VGbG9hdChfZW1wLnJ0dEFqdXN0KSA6IHJ0dEFubnVlbHM7CiAgdmFyIHJ0dFByaXMgPSBfZGVtYW5kZXMuZmlsdGVyKGZ1bmN0aW9uKGQpIHsgcmV0dXJuIGQudHlwZT09PSdydHQnICYmIGQuc3RhdHV0PT09J2FwcHJvdmVkJyAmJiBuZXcgRGF0ZShkLmRhdGVEZWJ1dHx8MCkuZ2V0RnVsbFllYXIoKT09PXk7IH0pLnJlZHVjZShmdW5jdGlvbihzLGQpIHsgcmV0dXJuIHMrKGQubmJKb3Vyc3x8MCk7IH0sIDApOwogIF9zb2xkZXMgPSB7CiAgICBjcEFjcXVpczogY3BBY3F1aXMsIGNwUHJpczogY3BQcmlzLAogICAgY3BSZXN0YW50OiBNYXRoLm1heCgwLCBjcEFjcXVpcy1jcFByaXMpLAogICAgcnR0QmFzZTogcnR0QmFzZSwgcnR0UHJpczogcnR0UHJpcywKICAgIHJ0dFJlc3RhbnQ6IE1hdGgubWF4KDAsIHJ0dEJhc2UtcnR0UHJpcyksCiAgICByZWN1cFJlc3RhbnQ6IHBhcnNlRmxvYXQoX2VtcC5yZWN1cEhldXJlcykgfHwgMCwKICAgIHBlbmRpbmc6IF9kZW1hbmRlcy5maWx0ZXIoZnVuY3Rpb24oZCkgeyByZXR1cm4gZC5zdGF0dXQ9PT0ncGVuZGluZyc7IH0pLmxlbmd0aCwKICB9Owp9CgovKiDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKICAgUkVOREVSIEdMT0JBTArilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAgKi8KZnVuY3Rpb24gcmVuZGVyQWxsKCkgewogIHZhciBjb2wgPSBfZW1wLmNvdWxldXIgfHwgJyMwNTk2NjknOwogIHZhciBhdiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdoZXJvLWF2Jyk7CiAgYXYudGV4dENvbnRlbnQgPSAoX2VtcC5wcmVub218fCc/JykuY2hhckF0KDApLnRvVXBwZXJDYXNlKCk7CiAgYXYuc3R5bGUuYmFja2dyb3VuZCA9IGNvbDsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaGVyby1uYW1lJykudGV4dENvbnRlbnQgPSAoKF9lbXAucHJlbm9tfHwnJykrJyAnKyhfZW1wLm5vbXx8JycpKS50cmltKCk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlcm8tc3ViJykudGV4dENvbnRlbnQgID0gW19lbXAucG9zdGUsX2VtcC5kZXBhcnRlbWVudCxfZW1wLnR5cGVDb250cmF0XS5maWx0ZXIoQm9vbGVhbikuam9pbignIFx1MDBiNyAnKTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgneWVhci1sYmwnKS50ZXh0Q29udGVudCAgPSBfeWVhcjsKCiAgLy8gQ2hpcHMgaGVybwogIHZhciBjaGlwcyA9IFtdOwogIGlmIChfZW1wLnR5cGVDb250cmF0KSBjaGlwcy5wdXNoKF9lbXAudHlwZUNvbnRyYXQpOwogIGlmIChfZW1wLmRlcGFydGVtZW50KSBjaGlwcy5wdXNoKF9lbXAuZGVwYXJ0ZW1lbnQpOwogIGlmIChfZW1wLmhldXJlc0hlYmRvKSBjaGlwcy5wdXNoKF9lbXAuaGV1cmVzSGViZG8rJ2gvc2VtJyk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2hlcm8tY2hpcHMnKS5pbm5lckhUTUwgPSBjaGlwcy5tYXAoZnVuY3Rpb24oYyl7IHJldHVybiAnPHNwYW4gY2xhc3M9Imhlcm8tY2hpcCI+JytjKyc8L3NwYW4+JzsgfSkuam9pbignJyk7CgogIHJlbmRlclNvbGRlc0Zsb3R0YW50cygpOwogIHJlbmRlckFjY3VlaWwoKTsKICByZW5kZXJQcm9maWwoKTsKICByZW5kZXJTb2xkZXNEZXRhaWwoKTsKICByZW5kZXJUeXBlR3JpZCgpOwogIHJlbmRlckRlbWFuZGVzKCk7CiAgcmVuZGVyQ2FsKCk7CiAgcmVuZGVySG9yYWlyZXMoKTsKfQoKLyog4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCiAgIFNPTERFUyBGTE9UVEFOVFMK4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQICovCmZ1bmN0aW9uIHJlbmRlclNvbGRlc0Zsb3R0YW50cygpIHsKICB2YXIgcyA9IF9zb2xkZXM7CiAgdmFyIGNwUGN0ID0gcy5jcEFjcXVpcz4wID8gTWF0aC5taW4ocy5jcFByaXMvcy5jcEFjcXVpcyoxMDAsMTAwKS50b0ZpeGVkKDApIDogMDsKICB2YXIgcnR0UGN0ID0gcy5ydHRCYXNlPjAgPyBNYXRoLm1pbihzLnJ0dFByaXMvcy5ydHRCYXNlKjEwMCwxMDApLnRvRml4ZWQoMCkgOiAwOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb2xkZXMtZ3JpZCcpLmlubmVySFRNTCA9CiAgICBzYygnXHVkODNjXHVkZmQ2XHVmZTBmJywgcy5jcFJlc3RhbnQudG9GaXhlZCgxKSwgJ2onLCAnQ1AgcmVzdGFudHMnLCBzLmNwQWNxdWlzLnRvRml4ZWQoMSkrJ2ogYWNxdWlzJywgcy5jcFJlc3RhbnQ+MTA/J2cnOnMuY3BSZXN0YW50PjU/J28nOidyJywgY3BQY3QsICd2YXIoLS1vcmFuZ2UpJykKICAgK3NjKCdcdTIzZjAnLCBzLnJ0dFJlc3RhbnQudG9GaXhlZCgxKSwgJ2onLCAnUlRUIHJlc3RhbnRzJywgcy5ydHRCYXNlKydqIGFsbG91XHUwMGU5cycsIHMucnR0UmVzdGFudD4wPydnJzoncicsIHJ0dFBjdCwgJ3ZhcigtLWJsdWUpJykKICAgK3NjKCdcdWQ4M2RcdWRkMDQnLCBzLnJlY3VwUmVzdGFudC50b0ZpeGVkKDEpLCAnaCcsICdSXHUwMGU5Y3VwXHUwMGU5cmF0aW9uJywgJ0hldXJlcyBcdTAwZTAgcHJlbmRyZScsIHMucmVjdXBSZXN0YW50PjA/J2cnOicnLCAwLCAnJykKICAgK3NjKCdcdTIzZjMnLCBzLnBlbmRpbmcsICcnLCAnRW4gYXR0ZW50ZScsICdkZW1hbmRlJysocy5wZW5kaW5nPjE/J3MnOicnKSsnIFx1MDBlMCB2YWxpZGVyJywgcy5wZW5kaW5nPjA/J28nOicnLCAwLCAnJyk7Cn0KZnVuY3Rpb24gc2MoaWNvbiwgdmFsLCB1bml0LCBsYmwsIHN1YiwgY2xzLCBwY3QsIGZpbGxDb2xvcikgewogIHJldHVybiAnPGRpdiBjbGFzcz0ic2MiPicKICAgICsnPGRpdiBjbGFzcz0ic2MtaWNvbiI+JytpY29uKyc8L2Rpdj4nCiAgICArJzxkaXYgY2xhc3M9InNjLXZhbCAnK2NscysnIj4nK3ZhbCsnPHNwYW4gY2xhc3M9InNjLXVuaXQiPicrdW5pdCsnPC9zcGFuPjwvZGl2PicKICAgICsnPGRpdiBjbGFzcz0ic2MtbGJsIj4nK2xibCsnPC9kaXY+JwogICAgKyc8ZGl2IGNsYXNzPSJzYy1zdWIiPicrc3ViKyc8L2Rpdj4nCiAgICArKHBjdD4wPyc8ZGl2IGNsYXNzPSJzYy1iYXIiPjxkaXYgY2xhc3M9InNjLWZpbGwiIHN0eWxlPSJ3aWR0aDonK3BjdCsnJTtiYWNrZ3JvdW5kOicrZmlsbENvbG9yKyciPjwvZGl2PjwvZGl2Pic6JycpCiAgICArJzwvZGl2Pic7Cn0KCi8qIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkAogICBBQ0NVRUlMCuKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkCAqLwpmdW5jdGlvbiByZW5kZXJBY2N1ZWlsKCkgewogIHZhciBub3cgPSBuZXcgRGF0ZSgpOwogIHZhciBqb3VycyA9IFsnZGltYW5jaGUnLCdsdW5kaScsJ21hcmRpJywnbWVyY3JlZGknLCdqZXVkaScsJ3ZlbmRyZWRpJywnc2FtZWRpJ107CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtbmFtZScpLnRleHRDb250ZW50ID0gJ0JvbmpvdXIgJysoX2VtcC5wcmVub218fCcnKSArJyAhIFx1ZDgzZFx1ZGM0Yic7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3dlbGNvbWUtZGF0ZScpLnRleHRDb250ZW50ID0gam91cnNbbm93LmdldERheSgpXSsnICcrbm93LnRvTG9jYWxlRGF0ZVN0cmluZygnZnItRlInLHtkYXk6J251bWVyaWMnLG1vbnRoOidsb25nJyx5ZWFyOidudW1lcmljJ30pOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY2N1ZWlsLWFubmVlLWxibCcpLnRleHRDb250ZW50ID0gJ1x1MjAxNCAnK195ZWFyOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25nZXMtYW5uZWUtbGJsJykudGV4dENvbnRlbnQgPSAnXHUyMDE0ICcrX3llYXI7CgogIC8vIEluZm9zIGNvbnRyYXQKICB2YXIgaW5mb3MgPSBbXTsKICBpZihfZW1wLnBvc3RlKSBpbmZvcy5wdXNoKHtpY29uOidcdWQ4M2RcdWRjYmMnLCBsYWJlbDonUG9zdGUnLCB2YWw6X2VtcC5wb3N0ZX0pOwogIGlmKF9lbXAuZGF0ZUVudHJlZSkgaW5mb3MucHVzaCh7aWNvbjonXHVkODNkXHVkY2M1JywgbGFiZWw6J0VudHJcdTAwZTllJywgdmFsOmZtdERhdGUoX2VtcC5kYXRlRW50cmVlKX0pOwogIGlmKF9lbXAudHlwZUNvbnRyYXQpIGluZm9zLnB1c2goe2ljb246J1x1ZDgzZFx1ZGNjNCcsIGxhYmVsOidDb250cmF0JywgdmFsOl9lbXAudHlwZUNvbnRyYXR9KTsKICBpZihfZW1wLmRlcGFydGVtZW50KSBpbmZvcy5wdXNoKHtpY29uOidcdWQ4M2NcdWRmZTInLCBsYWJlbDonXHUwMGM5cXVpcGUnLCB2YWw6X2VtcC5kZXBhcnRlbWVudH0pOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY2N1ZWlsLWluZm9zJykuaW5uZXJIVE1MID0gaW5mb3MubWFwKGZ1bmN0aW9uKGkpewogICAgcmV0dXJuICc8ZGl2IGNsYXNzPSJpbmZvLWxpbmUiPjxzcGFuIGNsYXNzPSJpbmZvLWxpbmUtaWNvbiI+JytpLmljb24rJzwvc3Bhbj48c3BhbiBjbGFzcz0iaW5mby1saW5lLWxhYmVsIj4nK2kubGFiZWwrJzwvc3Bhbj48c3BhbiBjbGFzcz0iaW5mby1saW5lLXZhbCI+JytpLnZhbCsnPC9zcGFuPjwvZGl2Pic7CiAgfSkuam9pbignJyk7CgogIC8vIFNvbGRlcyBhY2N1ZWlsCiAgdmFyIHMgPSBfc29sZGVzOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhY2N1ZWlsLXNvbGRlcycpLmlubmVySFRNTCA9CiAgICBzb2xkZUJhcignXHVkODNjXHVkZmQ2XHVmZTBmIENQIHJlc3RhbnRzJywgcy5jcFJlc3RhbnQsIHMuY3BBY3F1aXMsICdqJywgcy5jcFJlc3RhbnQ+MTA/J3ZhcigtLWczKSc6cy5jcFJlc3RhbnQ+NT8ndmFyKC0tb3JhbmdlKSc6J3ZhcigtLXJlZCknKQogICArc29sZGVCYXIoJ1x1MjNmMCBSVFQgcmVzdGFudHMnLCBzLnJ0dFJlc3RhbnQsIHMucnR0QmFzZSwgJ2onLCBzLnJ0dFJlc3RhbnQ+MD8ndmFyKC0tYmx1ZSknOid2YXIoLS1yZWQpJykKICAgKyhzLnJlY3VwUmVzdGFudD4wP3NvbGRlQmFyKCdcdWQ4M2RcdWRkMDQgUlx1MDBlOWN1cFx1MDBlOXJhdGlvbicsIHMucmVjdXBSZXN0YW50LCBzLnJlY3VwUmVzdGFudCwgJ2gnLCAndmFyKC0tdGVhbCknKTonJyk7CgogIC8vIDMgZGVybmnDqHJlcyBkZW1hbmRlcwogIHZhciByZWNlbnQgPSBfZGVtYW5kZXMuc2xpY2UoMCwzKTsKICB2YXIgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWNjdWVpbC1kZW1hbmRlcycpOwogIGlmKCFyZWNlbnQubGVuZ3RoKXsgZWwuaW5uZXJIVE1MPSc8ZGl2IGNsYXNzPSJlbXB0eSI+PGRpdiBjbGFzcz0iZW1wdHktaWNvbiI+XHVkODNkXHVkY2NiPC9kaXY+QXVjdW5lIGRlbWFuZGUuPC9kaXY+JzsgcmV0dXJuOyB9CiAgZWwuaW5uZXJIVE1MID0gcmVjZW50Lm1hcChmdW5jdGlvbihkKXsKICAgIHJldHVybiBkZW1JdGVtSHRtbChkKTsKICB9KS5qb2luKCcnKTsKCiAgLy8gQmFkZ2UgY29uZ8OpcyBlbiBhdHRlbnRlCiAgdmFyIHBlbmRpbmdDb3VudCA9IF9zb2xkZXMucGVuZGluZzsKICB2YXIgdGFiQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhYi1jb25nZXMtYnRuJyk7CiAgaWYocGVuZGluZ0NvdW50PjAgJiYgdGFiQnRuKXsKICAgIHRhYkJ0bi5pbm5lckhUTUwgPSAnXHVkODNjXHVkZmQ2XHVmZTBmIENvbmdcdTAwZTlzIDxzcGFuIGNsYXNzPSJub3RpZiI+JytwZW5kaW5nQ291bnQrJzwvc3Bhbj4nOwogIH0KCn0KCmZ1bmN0aW9uIHNvbGRlQmFyKGxhYmVsLCB2YWwsIG1heCwgdW5pdCwgY29sb3IpIHsKICB2YXIgcGN0ID0gbWF4PjAgPyBNYXRoLm1pbih2YWwvbWF4KjEwMCwxMDApLnRvRml4ZWQoMCkgOiAwOwogIHJldHVybiAnPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbToxMnB4Ij4nCiAgICArJzxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjthbGlnbi1pdGVtczpiYXNlbGluZTttYXJnaW4tYm90dG9tOjRweCI+JwogICAgICArJzxzcGFuIHN0eWxlPSJmb250LXNpemU6MTJweDtmb250LXdlaWdodDo3MDAiPicrbGFiZWwrJzwvc3Bhbj4nCiAgICAgICsnPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZToxNHB4O2ZvbnQtd2VpZ2h0OjgwMDtjb2xvcjonK2NvbG9yKyciPicrdmFsLnRvRml4ZWQoMSkrJzxzcGFuIHN0eWxlPSJmb250LXNpemU6MTBweDtmb250LXdlaWdodDo2MDAiPiAnK3VuaXQrJzwvc3Bhbj48L3NwYW4+JwogICAgKyc8L2Rpdj4nCiAgICArJzxkaXYgc3R5bGU9ImhlaWdodDo2cHg7YmFja2dyb3VuZDojZjNmNGY2O2JvcmRlci1yYWRpdXM6OTlweDtvdmVyZmxvdzpoaWRkZW4iPicKICAgICAgKyc8ZGl2IHN0eWxlPSJoZWlnaHQ6MTAwJTt3aWR0aDonK3BjdCsnJTtiYWNrZ3JvdW5kOicrY29sb3IrJztib3JkZXItcmFkaXVzOjk5cHg7dHJhbnNpdGlvbjp3aWR0aCAuNXMgZWFzZSI+PC9kaXY+JwogICAgKyc8L2Rpdj4nCiAgICArJzxkaXYgc3R5bGU9ImZvbnQtc2l6ZToxMHB4O2NvbG9yOnZhcigtLW11dGVkKTttYXJnaW4tdG9wOjJweCI+Jyt2YWwudG9GaXhlZCgxKSsnIC8gJyttYXgudG9GaXhlZCgxKSsnICcrdW5pdCsnICgnK3BjdCsnJSB1dGlsaXNcdTAwZTlzKTwvZGl2PicKICArJzwvZGl2Pic7Cn0KCi8qIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkAogICBQUk9GSUwK4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQICovCmZ1bmN0aW9uIHJlbmRlclByb2ZpbCgpIHsKICAvLyBDb250cmF0IGNhcmQKICB2YXIgZGF0ZUVudHJlZSA9IF9lbXAuZGF0ZUVudHJlZSA/IGZtdERhdGUoX2VtcC5kYXRlRW50cmVlKSA6ICdcdTIwMTQnOwogIHZhciBhbmNpZW5uZXRlID0gX2VtcC5kYXRlRW50cmVlID8gY2FsY0FuY2llbm5ldGUoX2VtcC5kYXRlRW50cmVlKSA6ICcnOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb250cmF0LWNhcmQtd3JhcCcpLmlubmVySFRNTCA9CiAgICAnPGRpdiBjbGFzcz0iY29udHJhdC1jYXJkIj4nCiAgICAgICsnPGRpdiBjbGFzcz0iY29udHJhdC1sZWZ0Ij4nCiAgICAgICAgKyc8ZGl2IGNsYXNzPSJjb250cmF0LXR5cGUiPicrKChfZW1wLnR5cGVDb250cmF0fHwnQ29udHJhdCcpKSsnIFx1MDBiNyAnKyhfZW1wLnBvc3RlfHwnXHUyMDE0JykrJzwvZGl2PicKICAgICAgICArJzxkaXYgY2xhc3M9ImNvbnRyYXQtc3ViIj4nCiAgICAgICAgICArKF9lbXAuZGVwYXJ0ZW1lbnQ/X2VtcC5kZXBhcnRlbWVudCsnIFx1MDBiNyAnOicnKQogICAgICAgICAgKyhfZW1wLmhldXJlc0hlYmRvP19lbXAuaGV1cmVzSGViZG8rJ2gvc2VtYWluZSBcdTAwYjcgJzonJykKICAgICAgICAgICsoX2VtcC5mcmVxdWVuY2U/X2VtcC5mcmVxdWVuY2UuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkrX2VtcC5mcmVxdWVuY2Uuc2xpY2UoMSkrJyc6JycpCiAgICAgICAgKyc8L2Rpdj4nCiAgICAgICAgKyc8ZGl2IGNsYXNzPSJjb250cmF0LXN1YiIgc3R5bGU9Im1hcmdpbi10b3A6NHB4Ij5FbnRyXHUwMGU5ZSA6ICcrZGF0ZUVudHJlZSsnPC9kaXY+JwogICAgICArJzwvZGl2PicKICAgICAgKyhhbmNpZW5uZXRlPyc8ZGl2IGNsYXNzPSJjb250cmF0LXN0YXQiPjxkaXYgY2xhc3M9ImNzLXZhbCI+JythbmNpZW5uZXRlKyc8L2Rpdj48ZGl2IGNsYXNzPSJjcy1sYmwiPkFuY2llbm5ldFx1MDBlOTwvZGl2PjwvZGl2Pic6JycpCiAgICArJzwvZGl2Pic7CgogIC8vIEluZm9zIHBlcnNvbm5lbGxlcwogIHZhciBwZiA9IF9wcm9maWxGaWVsZHM7CiAgc2V0VmFsKCdwZi1wcmVub20nLCBfZW1wLnByZW5vbXx8J1x1MjAxNCcpOwogIHNldFZhbCgncGYtbm9tJywgX2VtcC5ub218fCdcdTIwMTQnKTsKICBzZXRFZGl0VmFsKCdwZi1lbWFpbC1wZXJzbycsIHBmLmVtYWlsUGVyc28sICdBam91dGVyIGVtYWlsIHBlcnNvbm5lbCcpOwogIHNldEVkaXRWYWwoJ3BmLXRlbCcsIHBmLnRlbGVwaG9uZSwgJ0Fqb3V0ZXIgdFx1MDBlOWxcdTAwZTlwaG9uZScpOwogIHNldEVkaXRWYWwoJ3BmLWFkcmVzc2UnLCBwZi5hZHJlc3NlLCAnQWpvdXRlciBhZHJlc3NlJyk7CiAgc2V0RWRpdFZhbCgncGYtZGRuJywgcGYuZGF0ZU5haXNzYW5jZSwgJ0Fqb3V0ZXIgZGF0ZSBkZSBuYWlzc2FuY2UnKTsKICBzZXRFZGl0VmFsKCdwZi1uYXQnLCBwZi5uYXRpb25hbGl0ZSwgJ0Fqb3V0ZXIgbmF0aW9uYWxpdFx1MDBlOScpOwogIHNldEVkaXRWYWwoJ3BmLWliYW4nLCBwZi5pYmFuID8gbWFza0liYW4ocGYuaWJhbikgOiAnJywgJ0Fqb3V0ZXIgSUJBTicpOwogIHNldEVkaXRWYWwoJ3BmLXRpdHVsYWlyZScsIHBmLmliYW5UaXR1bGFpcmUsICdBam91dGVyIHRpdHVsYWlyZScpOwogIHNldEVkaXRWYWwoJ3BmLXVyZ2VuY2Utbm9tJywgcGYuY29udGFjdFVyZ2VuY2VOb20sICdBam91dGVyIGNvbnRhY3QgdXJnZW5jZScpOwogIHNldEVkaXRWYWwoJ3BmLXVyZ2VuY2UtbGllbicsIHBmLmNvbnRhY3RVcmdlbmNlTGllbiwgJ0V4IDogY29uam9pbnQsIHBhcmVudC4uLicpOwogIHNldEVkaXRWYWwoJ3BmLXVyZ2VuY2UtdGVsJywgcGYuY29udGFjdFVyZ2VuY2VUZWwsICdUXHUwMGU5bFx1MDBlOXBob25lIHVyZ2VuY2UnKTsKCiAgLy8gVXJnZW5jZSBjYXJkCiAgdmFyIHV3ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VyZ2VuY2Utd3JhcCcpOwogIGlmKHBmLmNvbnRhY3RVcmdlbmNlTm9tICYmIHBmLmNvbnRhY3RVcmdlbmNlVGVsKXsKICAgIHV3LmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPSJ1cmdlbmNlLWNhcmQiPicKICAgICAgKyc8ZGl2IGNsYXNzPSJ1cmdlbmNlLWljbyI+XHVkODNkXHVkZWE4PC9kaXY+JwogICAgICArJzxkaXYgY2xhc3M9InVyZ2VuY2UtYm9keSI+JwogICAgICAgICsnPGRpdiBjbGFzcz0idXJnZW5jZS1uYW1lIj4nK3BmLmNvbnRhY3RVcmdlbmNlTm9tKyc8L2Rpdj4nCiAgICAgICAgKyhwZi5jb250YWN0VXJnZW5jZUxpZW4/JzxkaXYgY2xhc3M9InVyZ2VuY2UtbGllbiI+JytwZi5jb250YWN0VXJnZW5jZUxpZW4rJzwvZGl2Pic6JycpCiAgICAgICAgKyc8ZGl2IGNsYXNzPSJ1cmdlbmNlLXRlbCI+XHVkODNkXHVkY2RlICcrcGYuY29udGFjdFVyZ2VuY2VUZWwrJzwvZGl2PicKICAgICAgKyc8L2Rpdj4nCiAgICArJzwvZGl2Pic7CiAgfSBlbHNlIHsgdXcuaW5uZXJIVE1MID0gJyc7IH0KCiAgLy8gQ29udHJhdCBSTwogIHZhciBjb250cmF0Um93cyA9IFtdOwogIGlmKF9lbXAudHlwZUNvbnRyYXQpIGNvbnRyYXRSb3dzLnB1c2goe2ljb246J1x1ZDgzZFx1ZGNjNCcsIGxhYmVsOidUeXBlJywgdmFsOl9lbXAudHlwZUNvbnRyYXR9KTsKICBpZihfZW1wLmRhdGVFbnRyZWUpIGNvbnRyYXRSb3dzLnB1c2goe2ljb246J1x1ZDgzZFx1ZGNjNScsIGxhYmVsOidEYXRlIGVudHJcdTAwZTllJywgdmFsOmZtdERhdGUoX2VtcC5kYXRlRW50cmVlKX0pOwogIGlmKF9lbXAuaGV1cmVzSGViZG8pIGNvbnRyYXRSb3dzLnB1c2goe2ljb246J1x1MjNmMCcsIGxhYmVsOidIb3JhaXJlJywgdmFsOl9lbXAuaGV1cmVzSGViZG8rJ2ggLyBzZW1haW5lJ30pOwogIGlmKF9lbXAuY2F0ZWdvcmllUG9zdGUpIGNvbnRyYXRSb3dzLnB1c2goe2ljb246J1x1ZDgzZFx1ZGNiYycsIGxhYmVsOidDYXRcdTAwZTlnb3JpZScsIHZhbDpjYXBpdGFsaXplKF9lbXAuY2F0ZWdvcmllUG9zdGUpfSk7CiAgaWYoX2VtcC5jY24pIGNvbnRyYXRSb3dzLnB1c2goe2ljb246J1x1ZDgzZFx1ZGNjYicsIGxhYmVsOidDb252ZW50aW9uJywgdmFsOl9lbXAuY2NufSk7CiAgaWYoX2VtcC5wZXJpb2RlRXNzYWkgJiYgX2VtcC5wZXJpb2RlRXNzYWkuYWN0aXZlKSBjb250cmF0Um93cy5wdXNoKHtpY29uOidcdTI2YTBcdWZlMGYnLCBsYWJlbDonUFx1MDBlOXJpb2RlIGVzc2FpJywgdmFsOidFbiBjb3Vycyd9KTsKICB2YXIgY2IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29udHJhdC1ib2R5Jyk7CiAgaWYoY29udHJhdFJvd3MubGVuZ3RoKXsKICAgIGNiLmlubmVySFRNTCA9IGNvbnRyYXRSb3dzLm1hcChmdW5jdGlvbihyKXsKICAgICAgcmV0dXJuICc8ZGl2IGNsYXNzPSJpbmZvLWxpbmUiPjxzcGFuIGNsYXNzPSJpbmZvLWxpbmUtaWNvbiI+JytyLmljb24rJzwvc3Bhbj48c3BhbiBjbGFzcz0iaW5mby1saW5lLWxhYmVsIj4nK3IubGFiZWwrJzwvc3Bhbj48c3BhbiBjbGFzcz0iaW5mby1saW5lLXZhbCI+JytyLnZhbCsnPC9zcGFuPjwvZGl2Pic7CiAgICB9KS5qb2luKCcnKTsKICB9IGVsc2UgewogICAgY2IuaW5uZXJIVE1MID0gJzxkaXYgY2xhc3M9ImVtcHR5Ij48ZGl2IGNsYXNzPSJlbXB0eS1pY29uIj5cdWQ4M2RcdWRjY2I8L2Rpdj48c3Bhbj5JbmZvcyBkZSBjb250cmF0IFx1MDBlMCByZW5zZWlnbmVyIHBhciB2b3RyZSBlbXBsb3lldXIuPC9zcGFuPjwvZGl2Pic7CiAgfQp9CgpmdW5jdGlvbiBzZXRWYWwoaWQsIHZhbCkgeyB2YXIgZWw9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOyBpZihlbCkgZWwudGV4dENvbnRlbnQ9dmFsOyB9CmZ1bmN0aW9uIHNldEVkaXRWYWwoaWQsIHZhbCwgcGxhY2Vob2xkZXIpIHsKICB2YXIgZWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgaWYoIWVsKSByZXR1cm47CiAgaWYodmFsKSB7CiAgICBlbC50ZXh0Q29udGVudCA9IHZhbDsKICAgIGVsLnN0eWxlLmNvbG9yID0gJ3ZhcigtLXRleHQpJzsKICB9IGVsc2UgewogICAgZWwudGV4dENvbnRlbnQgPSBwbGFjZWhvbGRlcnx8J1x1MjAxNCc7CiAgICBlbC5zdHlsZS5jb2xvciA9ICd2YXIoLS1tdXRlZCknOwogIH0KfQoKZnVuY3Rpb24gZWRpdEZpZWxkKGVsLCBmaWVsZEtleSkgewogIHZhciBjdXJyZW50VmFsID0gX3Byb2ZpbEZpZWxkc1tmaWVsZEtleV0gfHwgJyc7CiAgdmFyIGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTsKICBpbnB1dC5jbGFzc05hbWUgPSAncHJvZmlsLWlucHV0JzsKICBpbnB1dC52YWx1ZSA9IGN1cnJlbnRWYWw7CiAgaW5wdXQucGxhY2Vob2xkZXIgPSBlbC5nZXRBdHRyaWJ1dGUoJ3RpdGxlJykgfHwgJ1NhaXNpci4uLic7CiAgZWwucmVwbGFjZVdpdGgoaW5wdXQpOwogIGlucHV0LmZvY3VzKCk7CiAgaW5wdXQuc2VsZWN0KCk7CgogIGZ1bmN0aW9uIHNhdmUoKSB7CiAgICB2YXIgbmV3VmFsID0gaW5wdXQudmFsdWUudHJpbSgpOwogICAgX3Byb2ZpbEVkaXRzW2ZpZWxkS2V5XSA9IG5ld1ZhbDsKICAgIF9wcm9maWxGaWVsZHNbZmllbGRLZXldID0gbmV3VmFsOwogICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgZGl2LmlkID0gZWwuaWQ7CiAgICBkaXYuY2xhc3NOYW1lID0gZWwuY2xhc3NOYW1lOwogICAgZGl2LnNldEF0dHJpYnV0ZSgnb25jbGljaycsIGVsLmdldEF0dHJpYnV0ZSgnb25jbGljaycpKTsKICAgIGRpdi5zZXRBdHRyaWJ1dGUoJ3RpdGxlJywgZWwuZ2V0QXR0cmlidXRlKCd0aXRsZScpKTsKICAgIGRpdi5zdHlsZS5jb2xvciA9IG5ld1ZhbCA/ICd2YXIoLS10ZXh0KScgOiAndmFyKC0tbXV0ZWQpJzsKICAgIGlmKGZpZWxkS2V5PT09J2liYW4nICYmIG5ld1ZhbCkgZGl2LnRleHRDb250ZW50ID0gbWFza0liYW4obmV3VmFsKTsKICAgIGVsc2UgZGl2LnRleHRDb250ZW50ID0gbmV3VmFsIHx8IChlbC5nZXRBdHRyaWJ1dGUoJ3RpdGxlJyl8fCdcdTIwMTQnKTsKICAgIGlucHV0LnJlcGxhY2VXaXRoKGRpdik7CiAgICAvLyBSw6lhdHRhY2hlciBsZSBldmVudCBvbmNsaWNrCiAgICBkaXYuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbigpeyBlZGl0RmllbGQoZGl2LCBmaWVsZEtleSk7IH0pOwogICAgLy8gQWZmaWNoZXIgYm91dG9uIHNhdmUKICAgIGlmKE9iamVjdC5rZXlzKF9wcm9maWxFZGl0cykubGVuZ3RoID4gMCl7CiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG4tc2F2ZS1wcm9maWwnKS5jbGFzc0xpc3QuYWRkKCdzaG93Jyk7CiAgICB9CiAgfQogIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIoJ2JsdXInLCBzYXZlKTsKICBpbnB1dC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgZnVuY3Rpb24oZSl7IGlmKGUua2V5PT09J0VudGVyJykgaW5wdXQuYmx1cigpOyBpZihlLmtleT09PSdFc2NhcGUnKXsgaW5wdXQudmFsdWU9Y3VycmVudFZhbDsgaW5wdXQuYmx1cigpOyB9IH0pOwp9CndpbmRvdy5lZGl0RmllbGQgPSBlZGl0RmllbGQ7Cgphc3luYyBmdW5jdGlvbiBzYXZlUHJvZmlsKCkgewogIGlmKCFPYmplY3Qua2V5cyhfcHJvZmlsRWRpdHMpLmxlbmd0aCkgcmV0dXJuOwogIHZhciBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLXNhdmUtcHJvZmlsJyk7CiAgYnRuLnRleHRDb250ZW50ID0gJ1x1MjNmMyBFbnJlZ2lzdHJlbWVudC4uLic7CiAgYnRuLmRpc2FibGVkID0gdHJ1ZTsKICB0cnkgewogICAgLy8gRnVzaW9ubmVyIGF2ZWMgZG9ubsOpZXMgZXhpc3RhbnRlcwogICAgdmFyIHRvU2F2ZSA9IE9iamVjdC5hc3NpZ24oe30sIF9wcm9maWxGaWVsZHMsIF9wcm9maWxFZGl0cywgewogICAgICBlbXBJZDogX2VtcElkLAogICAgICB1aWQ6IF91aWQsCiAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoKS50b0lTT1N0cmluZygpCiAgICB9KTsKICAgIGF3YWl0IHdpbmRvdy5fc2V0RG9jRnMoJ3JoX2VtcGxveWVzX3B1YmxpY19wcm9maWwnLCBfdWlkKydfJytfZW1wSWQsIHRvU2F2ZSwge21lcmdlOnRydWV9KTsKICAgIC8vIEF1c3NpIG1ldHRyZSDDoCBqb3VyIGxlcyBjaGFtcHMgbm9uLXNlbnNpYmxlcyBzdXIgbGUgZG9jIHB1YmxpYwogICAgdmFyIHB1YmxpY1VwZGF0ZSA9IHt9OwogICAgaWYoX3Byb2ZpbEVkaXRzLnRlbGVwaG9uZSkgcHVibGljVXBkYXRlLnRlbGVwaG9uZSA9IF9wcm9maWxFZGl0cy50ZWxlcGhvbmU7CiAgICBpZihfcHJvZmlsRWRpdHMuY29udGFjdFVyZ2VuY2VOb20pIHB1YmxpY1VwZGF0ZS5jb250YWN0VXJnZW5jZU5vbSA9IF9wcm9maWxFZGl0cy5jb250YWN0VXJnZW5jZU5vbTsKICAgIGlmKF9wcm9maWxFZGl0cy5jb250YWN0VXJnZW5jZVRlbCkgcHVibGljVXBkYXRlLmNvbnRhY3RVcmdlbmNlVGVsID0gX3Byb2ZpbEVkaXRzLmNvbnRhY3RVcmdlbmNlVGVsOwogICAgaWYoX3Byb2ZpbEVkaXRzLmNvbnRhY3RVcmdlbmNlTGllbikgcHVibGljVXBkYXRlLmNvbnRhY3RVcmdlbmNlTGllbiA9IF9wcm9maWxFZGl0cy5jb250YWN0VXJnZW5jZUxpZW47CiAgICBpZihPYmplY3Qua2V5cyhwdWJsaWNVcGRhdGUpLmxlbmd0aCl7CiAgICAgIE9iamVjdC5hc3NpZ24oX2VtcCwgcHVibGljVXBkYXRlKTsKICAgIH0KICAgIF9wcm9maWxFZGl0cyA9IHt9OwogICAgYnRuLmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTsKICAgIGJ0bi50ZXh0Q29udGVudCA9ICdcdWQ4M2RcdWRjYmUgRW5yZWdpc3RyZXIgbGVzIG1vZGlmaWNhdGlvbnMnOwogICAgYnRuLmRpc2FibGVkID0gZmFsc2U7CiAgICBzaG93VG9hc3QoJ1x1MjcwNSBQcm9maWwgZW5yZWdpc3RyXHUwMGU5Jywnb2snKTsKICAgIHJlbmRlclByb2ZpbCgpOyAvLyByZS1yZW5kZXIgdXJnZW5jZSBjYXJkCiAgfSBjYXRjaChlKSB7CiAgICBjb25zb2xlLmVycm9yKGUpOwogICAgc2hvd1RvYXN0KCdFcnJldXIgOiAnK2UubWVzc2FnZSwnZXJyJyk7CiAgICBidG4udGV4dENvbnRlbnQgPSAnXHVkODNkXHVkY2JlIEVucmVnaXN0cmVyIGxlcyBtb2RpZmljYXRpb25zJzsKICAgIGJ0bi5kaXNhYmxlZCA9IGZhbHNlOwogIH0KfQp3aW5kb3cuc2F2ZVByb2ZpbCA9IHNhdmVQcm9maWw7CgovKiDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAKICAgRE9DVU1FTlRTCuKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkCAqLwoKLy8gT3V2cmUgbGEgbW9kYWwgdmlhIGluZGV4IChwYXMgZGUgc3RyaW5nIGRhbnMgb25jbGljaykKZnVuY3Rpb24gY2xvc2VVcGxvYWRNb2RhbCgpIHsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndXBsb2FkLW1vZGFsJykuY2xhc3NMaXN0LnJlbW92ZSgnc2hvdycpOwogIF91cGxvYWRCNjQgPSBudWxsOyBfdXBsb2FkTWV0YSA9IG51bGw7Cn0Kd2luZG93LmNsb3NlVXBsb2FkTW9kYWwgPSBjbG9zZVVwbG9hZE1vZGFsOwoKZnVuY3Rpb24gb25VcGxvYWRDaGFuZ2UoaW5wdXQpIHsKICB2YXIgZmlsZSA9IGlucHV0LmZpbGVzWzBdOwogIGlmICghZmlsZSkgcmV0dXJuOwogIGlmIChmaWxlLnNpemUgPiA1KjEwMjQqMTAyNCkgeyBzaG93VG9hc3QoJ0ZpY2hpZXIgdHJvcCBsb3VyZCAobWF4IDUgTW8pJywnZXJyJyk7IHJldHVybjsgfQogIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwogIHJlYWRlci5vbmxvYWQgPSBmdW5jdGlvbihlKSB7CiAgICBfdXBsb2FkQjY0ID0gZS50YXJnZXQucmVzdWx0OwogICAgX3VwbG9hZE1ldGEgPSB7IG5hbWU6IGZpbGUubmFtZSwgc2l6ZTogZmlsZS5zaXplLCB0eXBlOiBmaWxlLnR5cGUgfTsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1cGxvYWQtcHJldmlldy1uYW1lJykudGV4dENvbnRlbnQgPSBmaWxlLm5hbWU7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndXBsb2FkLXByZXZpZXctc2l6ZScpLnRleHRDb250ZW50ID0gKGZpbGUuc2l6ZS8xMDI0KS50b0ZpeGVkKDApKydLbyc7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndXBsb2FkLXByZXZpZXcnKS5zdHlsZS5kaXNwbGF5ID0gJ2ZsZXgnOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VwbG9hZC1zdWJtaXQtYnRuJykuZGlzYWJsZWQgPSBmYWxzZTsKICB9OwogIHJlYWRlci5yZWFkQXNEYXRhVVJMKGZpbGUpOwp9CndpbmRvdy5vblVwbG9hZENoYW5nZSA9IG9uVXBsb2FkQ2hhbmdlOwoKZnVuY3Rpb24gY2xlYXJVcGxvYWQoKSB7CiAgX3VwbG9hZEI2NCA9IG51bGw7IF91cGxvYWRNZXRhID0gbnVsbDsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndXBsb2FkLWlucHV0JykudmFsdWUgPSAnJzsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndXBsb2FkLXByZXZpZXcnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd1cGxvYWQtc3VibWl0LWJ0bicpLmRpc2FibGVkID0gdHJ1ZTsKfQp3aW5kb3cuY2xlYXJVcGxvYWQgPSBjbGVhclVwbG9hZDsKCmZ1bmN0aW9uIHZpZXdFbXBsb3llckRvYyhpKSB7CiAgdmFyIGRvYyA9IF9kb2NzRW1wbG95ZXJbaV07CiAgaWYoIWRvYyB8fCAhZG9jLmRhdGEpIHsgc2hvd1RvYXN0KCdEb2N1bWVudCBub24gZGlzcG9uaWJsZScsJ2VycicpOyByZXR1cm47IH0KICB2YXIgd2luID0gd2luZG93Lm9wZW4oJycsJ19ibGFuaycpOwogIGlmKGRvYy50eXBlICYmIGRvYy50eXBlLnN0YXJ0c1dpdGgoJ2ltYWdlLycpKXsKICAgIHdpbi5kb2N1bWVudC53cml0ZSgnPGh0bWw+PGJvZHkgc3R5bGU9Im1hcmdpbjowO2JhY2tncm91bmQ6IzExMSI+PGltZyBzcmM9IicrZG9jLmRhdGErJyIgc3R5bGU9Im1heC13aWR0aDoxMDAlO2Rpc3BsYXk6YmxvY2s7bWFyZ2luOmF1dG8iLz48L2JvZHk+PC9odG1sPicpOwogIH0gZWxzZSB7CiAgICB3aW4ubG9jYXRpb24uaHJlZiA9IGRvYy5kYXRhOwogIH0KfQp3aW5kb3cudmlld0VtcGxveWVyRG9jID0gdmlld0VtcGxveWVyRG9jOwoKLyog4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCiAgIFNPTERFUyBEw4lUQUlMTMOJUyAob25nbGV0IGNvbmfDqXMpCuKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkCAqLwpmdW5jdGlvbiByZW5kZXJTb2xkZXNEZXRhaWwoKSB7CiAgdmFyIHMgPSBfc29sZGVzOwogIHZhciBpdGVtcyA9IFsKICAgIHtpY29uOidcdWQ4M2NcdWRmZDZcdWZlMGYnLCBsYWJlbDonQ29uZ1x1MDBlOXMgcGF5XHUwMGU5cycsIGFjcXVpczpzLmNwQWNxdWlzLCBwcmlzOnMuY3BQcmlzLCByZXN0YW50OnMuY3BSZXN0YW50LCB1bml0OidqJywgY29sb3I6J3ZhcigtLWczKSd9LAogICAge2ljb246J1x1MjNmMCcsIGxhYmVsOidSVFQnLCBhY3F1aXM6cy5ydHRCYXNlLCBwcmlzOnMucnR0UHJpcywgcmVzdGFudDpzLnJ0dFJlc3RhbnQsIHVuaXQ6J2onLCBjb2xvcjondmFyKC0tYmx1ZSknfSwKICAgIHtpY29uOidcdWQ4M2RcdWRkMDQnLCBsYWJlbDonUlx1MDBlOWN1cFx1MDBlOXJhdGlvbicsIGFjcXVpczpzLnJlY3VwUmVzdGFudCwgcHJpczowLCByZXN0YW50OnMucmVjdXBSZXN0YW50LCB1bml0OidoJywgY29sb3I6J3ZhcigtLXRlYWwpJ30sCiAgXTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc29sZGVzLWRldGFpbCcpLmlubmVySFRNTCA9IGl0ZW1zLm1hcChmdW5jdGlvbihpdCl7CiAgICB2YXIgcGN0ID0gaXQuYWNxdWlzPjAgPyBNYXRoLm1pbihpdC5wcmlzL2l0LmFjcXVpcyoxMDAsMTAwKS50b0ZpeGVkKDApIDogMDsKICAgIHJldHVybiAnPGRpdiBzdHlsZT0ibWFyZ2luLWJvdHRvbToxMnB4O3BhZGRpbmc6MTBweCAxMnB4O2JhY2tncm91bmQ6I2Y5ZmFmYjtib3JkZXItcmFkaXVzOjEwcHg7Ym9yZGVyOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIpIj4nCiAgICAgICsnPGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4O2p1c3RpZnktY29udGVudDpzcGFjZS1iZXR3ZWVuO2FsaWduLWl0ZW1zOmNlbnRlcjttYXJnaW4tYm90dG9tOjZweCI+JwogICAgICAgICsnPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZToxMnB4O2ZvbnQtd2VpZ2h0OjcwMCI+JytpdC5pY29uKycgJytpdC5sYWJlbCsnPC9zcGFuPicKICAgICAgICArJzxzcGFuIHN0eWxlPSJmb250LXNpemU6MTZweDtmb250LXdlaWdodDo4MDA7Y29sb3I6JytpdC5jb2xvcisnIj4nK2l0LnJlc3RhbnQudG9GaXhlZCgxKSsnPHNwYW4gc3R5bGU9ImZvbnQtc2l6ZToxMHB4O2ZvbnQtd2VpZ2h0OjYwMCI+ICcraXQudW5pdCsnPC9zcGFuPjwvc3Bhbj4nCiAgICAgICsnPC9kaXY+JwogICAgICArJzxkaXYgc3R5bGU9ImhlaWdodDo2cHg7YmFja2dyb3VuZDojZTVlN2ViO2JvcmRlci1yYWRpdXM6OTlweDtvdmVyZmxvdzpoaWRkZW47bWFyZ2luLWJvdHRvbTo1cHgiPicKICAgICAgICArJzxkaXYgc3R5bGU9ImhlaWdodDoxMDAlO3dpZHRoOicrcGN0KyclO2JhY2tncm91bmQ6JytpdC5jb2xvcisnO2JvcmRlci1yYWRpdXM6OTlweDt0cmFuc2l0aW9uOndpZHRoIC41cyBlYXNlIj48L2Rpdj4nCiAgICAgICsnPC9kaXY+JwogICAgICArJzxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2Vlbjtmb250LXNpemU6MTBweDtjb2xvcjp2YXIoLS1tdXRlZCkiPicKICAgICAgICArJzxzcGFuPicraXQucHJpcy50b0ZpeGVkKDEpKycgJytpdC51bml0KycgcHJpczwvc3Bhbj4nCiAgICAgICAgKyc8c3Bhbj4nK2l0LmFjcXVpcy50b0ZpeGVkKDEpKycgJytpdC51bml0KycgYWxsb3VcdTAwZTlzPC9zcGFuPicKICAgICAgKyc8L2Rpdj4nCiAgICArJzwvZGl2Pic7CiAgfSkuam9pbignJyk7Cn0KCi8qIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkAogICBUWVBFIEdSSUQgKGNvbmfDqXMpCuKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkCAqLwpmdW5jdGlvbiByZW5kZXJUeXBlR3JpZCgpIHsKICB2YXIgdHlwZXMgPSBbCiAgICB7azonY3AnLCAgICAgICAgICBzdWI6IF9zb2xkZXMuY3BSZXN0YW50LnRvRml4ZWQoMSkrJ2ogZGlzcG9uaWJsZXMnfSwKICAgIHtrOidydHQnLCAgICAgICAgIHN1YjogX3NvbGRlcy5ydHRSZXN0YW50LnRvRml4ZWQoMSkrJ2ogZGlzcG9uaWJsZXMnfSwKICAgIHtrOidyZWN1cGVyYXRpb24nLHN1YjooX3NvbGRlcy5yZWN1cFJlc3RhbnR8fDApKydoIGRpc3BvbmlibGVzJ30sCiAgICB7azonY3NzJywgICAgICAgICBzdWI6J05vbiBkXHUwMGU5Y29tcHRcdTAwZTkgZHUgc29sZGUnfSwKICAgIHtrOidldmVuZW1lbnQnLCAgIHN1YjonRHVyXHUwMGU5ZXMgbFx1MDBlOWdhbGVzJ30sCiAgICB7azonbWFsYWRpZScsICAgICBzdWI6J0Fyclx1MDBlYXQgbVx1MDBlOWRpY2FsJ30sCiAgICB7azonZm9ybWF0aW9uJywgICBzdWI6J0Zvcm1hdGlvbiBwcm9mZXNzaW9ubmVsbGUnfSwKICBdOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0eXBlLWdyaWQnKS5pbm5lckhUTUwgPSB0eXBlcy5tYXAoZnVuY3Rpb24odCkgewogICAgcmV0dXJuICc8YnV0dG9uIGNsYXNzPSJ0YiAnKygoX3NlbFR5cGU9PT10LmspPydzZWwnOicnKSsnIiBvbmNsaWNrPSJzZWxUeXBlKFwnJyt0LmsrJ1wnKSI+JwogICAgICArJzxkaXYgY2xhc3M9InRiLWljb24iPicrSUNPTlNbdC5rXSsnPC9kaXY+JwogICAgICArJzxzcGFuIGNsYXNzPSJ0Yi1sYmwiPicrTEFCRUxTW3Qua10rJzwvc3Bhbj4nCiAgICAgICsnPHNwYW4gY2xhc3M9InRiLXN1YiI+Jyt0LnN1YisnPC9zcGFuPicKICAgICAgKyc8L2J1dHRvbj4nOwogIH0pLmpvaW4oJycpOwp9CgpmdW5jdGlvbiBzZXRGaWx0ZXIoYnRuLCBmKSB7CiAgX2RlbUZpbHRlciA9IGY7CiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmZ0YWInKS5mb3JFYWNoKGZ1bmN0aW9uKGIpIHsgYi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsgfSk7CiAgYnRuLmNsYXNzTGlzdC5hZGQoJ2FjdGl2ZScpOwogIHJlbmRlckRlbWFuZGVzKCk7Cn0Kd2luZG93LnNldEZpbHRlciA9IHNldEZpbHRlcjsKCmZ1bmN0aW9uIHJlbmRlckRlbWFuZGVzKCkgewogIHZhciBlbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkZW0tbGlzdCcpOwogIHZhciBjbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGVtLWNvdW50Jyk7CiAgdmFyIGxpc3QgPSBfZGVtRmlsdGVyID09PSAnYWxsJyA/IF9kZW1hbmRlcyA6IF9kZW1hbmRlcy5maWx0ZXIoZnVuY3Rpb24oZCkgeyByZXR1cm4gZC5zdGF0dXQgPT09IF9kZW1GaWx0ZXI7IH0pOwogIGNudC50ZXh0Q29udGVudCA9IF9kZW1hbmRlcy5sZW5ndGgrJyBkZW1hbmRlJysoX2RlbWFuZGVzLmxlbmd0aD4xPydzJzonJyk7CiAgaWYgKCFsaXN0Lmxlbmd0aCkgeyBlbC5pbm5lckhUTUw9JzxkaXYgY2xhc3M9ImVtcHR5Ij48ZGl2IGNsYXNzPSJlbXB0eS1pY29uIj5cdWQ4M2RcdWRjY2I8L2Rpdj5BdWN1bmUgZGVtYW5kZS48L2Rpdj4nOyByZXR1cm47IH0KICBlbC5pbm5lckhUTUwgPSBsaXN0Lm1hcChmdW5jdGlvbihkKXsgcmV0dXJuIGRlbUl0ZW1IdG1sKGQpOyB9KS5qb2luKCcnKTsKfQoKZnVuY3Rpb24gZGVtSXRlbUh0bWwoZCkgewogIHZhciBkYiA9IGQuZGF0ZURlYnV0ID8gbmV3IERhdGUoZC5kYXRlRGVidXQrJ1QxMjowMDowMCcpLnRvTG9jYWxlRGF0ZVN0cmluZygnZnItRlInLHtkYXk6J251bWVyaWMnLG1vbnRoOidzaG9ydCcseWVhcjonbnVtZXJpYyd9KSA6ICc/JzsKICB2YXIgZGUgPSAoZC5kYXRlRmluICYmIGQuZGF0ZUZpbiE9PWQuZGF0ZURlYnV0KSA/ICcgXHUyMTkyICcrbmV3IERhdGUoZC5kYXRlRmluKydUMTI6MDA6MDAnKS50b0xvY2FsZURhdGVTdHJpbmcoJ2ZyLUZSJyx7ZGF5OidudW1lcmljJyxtb250aDonc2hvcnQnfSkgOiAnJzsKICB2YXIgYlR4dCA9IHtwZW5kaW5nOidcdTIzZjMgRW4gYXR0ZW50ZScsYXBwcm92ZWQ6J1x1MjcwNSBBcHByb3V2XHUwMGU5ZScscmVmdXNlZDonXHUyNzRjIFJlZnVzXHUwMGU5ZScsY2FuY2VsbGVkOidcdWQ4M2RcdWRlYWIgQW5udWxcdTAwZTllJ31bZC5zdGF0dXRdIHx8IGQuc3RhdHV0OwogIHJldHVybiAnPGRpdiBjbGFzcz0iZGVtLWl0ZW0iPicKICAgICsnPGRpdiBjbGFzcz0iZGVtLWljbyIgc3R5bGU9ImJhY2tncm91bmQ6JysoQ09MT1JTW2QudHlwZV18fCcjNmI3MjgwJykrJzIyIj4nKyhJQ09OU1tkLnR5cGVdfHwnXHVkODNkXHVkY2NiJykrJzwvZGl2PicKICAgICsnPGRpdiBjbGFzcz0iZGVtLWJvZHkiPicKICAgICAgKyc8ZGl2IGNsYXNzPSJkZW0tbmFtZSI+JysoTEFCRUxTW2QudHlwZV18fGQudHlwZSkrJyA8c3Ryb25nIHN0eWxlPSJjb2xvcjonKyhDT0xPUlNbZC50eXBlXXx8J3ZhcigtLWczKScpKyciPicrKGQubmJKb3Vyc3x8MCkrJ2o8L3N0cm9uZz48L2Rpdj4nCiAgICAgICsnPGRpdiBjbGFzcz0iZGVtLWRhdGVzIj4nK2RiK2RlKyc8L2Rpdj4nCiAgICAgICsoZC5tb3RpZj8nPGRpdiBjbGFzcz0iZGVtLW1vdGlmIj4nK2QubW90aWYrJzwvZGl2Pic6JycpCiAgICAgICsoZC5tb3RpZlJlZnVzPyc8ZGl2IGNsYXNzPSJkZW0tcmVmdXMiPk1vdGlmIGR1IHJlZnVzIDogJytkLm1vdGlmUmVmdXMrJzwvZGl2Pic6JycpCiAgICAgICsnPHNwYW4gY2xhc3M9ImJhZGdlIGJhZGdlLScrKGQuc3RhdHV0fHwncGVuZGluZycpKyciPicrYlR4dCsnPC9zcGFuPicKICAgICsnPC9kaXY+JwogICsnPC9kaXY+JzsKfQoKLyog4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCiAgIFBMQU5OSU5HICYgSE9SQUlSRVMK4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQICovCmZ1bmN0aW9uIHJlbmRlckNhbCgpIHsKICB2YXIgeSA9IF9jYWxNb250aC5nZXRGdWxsWWVhcigpLCBtID0gX2NhbE1vbnRoLmdldE1vbnRoKCk7CiAgdmFyIG5iID0gbmV3IERhdGUoeSxtKzEsMCkuZ2V0RGF0ZSgpOwogIHZhciBmaXJzdERvdyA9IChuZXcgRGF0ZSh5LG0sMSkuZ2V0RGF5KCkrNiklNzsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY2FsLXRpdGxlJykudGV4dENvbnRlbnQgPSBuZXcgRGF0ZSh5LG0sMSkudG9Mb2NhbGVEYXRlU3RyaW5nKCdmci1GUicse21vbnRoOidsb25nJyx5ZWFyOidudW1lcmljJ30pOwogIHZhciBob3JhaXJlcyA9IChfcGFyYW1zICYmIF9wYXJhbXMuaG9yYWlyZXMpIHx8IHsKICAgIGx1bmRpOnthY3RpZjp0cnVlfSxtYXJkaTp7YWN0aWY6dHJ1ZX0sbWVyY3JlZGk6e2FjdGlmOnRydWV9LAogICAgamV1ZGk6e2FjdGlmOnRydWV9LHZlbmRyZWRpOnthY3RpZjp0cnVlfSxzYW1lZGk6e2FjdGlmOmZhbHNlfSxkaW1hbmNoZTp7YWN0aWY6ZmFsc2V9CiAgfTsKICB2YXIgYWJzTWFwID0ge307CiAgX2RlbWFuZGVzLmZpbHRlcihmdW5jdGlvbihkKSB7IHJldHVybiBkLnN0YXR1dD09PSdhcHByb3ZlZCd8fGQuc3RhdHV0PT09J3BlbmRpbmcnOyB9KS5mb3JFYWNoKGZ1bmN0aW9uKGQpIHsKICAgIGlmICghZC5kYXRlRGVidXQpIHJldHVybjsKICAgIHZhciBjdXIgPSBuZXcgRGF0ZShkLmRhdGVEZWJ1dCsnVDEyOjAwOjAwJyk7CiAgICB2YXIgZmluID0gbmV3IERhdGUoKGQuZGF0ZUZpbnx8ZC5kYXRlRGVidXQpKydUMTI6MDA6MDAnKTsKICAgIHdoaWxlIChjdXIgPD0gZmluKSB7CiAgICAgIGlmIChjdXIuZ2V0RnVsbFllYXIoKT09PXkgJiYgY3VyLmdldE1vbnRoKCk9PT1tKQogICAgICAgIGFic01hcFtjdXIuZ2V0RGF0ZSgpXSA9IHt0eXBlOmQudHlwZSwgcGVuZGluZzpkLnN0YXR1dD09PSdwZW5kaW5nJ307CiAgICAgIGN1ci5zZXREYXRlKGN1ci5nZXREYXRlKCkrMSk7CiAgICB9CiAgfSk7CiAgdmFyIHRvZGF5ID0gbmV3IERhdGUoKTsKICB2YXIgaGRycyA9IFsnTCcsJ00nLCdNJywnSicsJ1YnLCdTJywnRCddOwogIHZhciBjYWxIdG1sID0gJyc7CiAgaGRycy5mb3JFYWNoKGZ1bmN0aW9uKGgpIHsgY2FsSHRtbCArPSAnPGRpdiBjbGFzcz0iY2FsLWhkciI+JytoKyc8L2Rpdj4nOyB9KTsKICBmb3IgKHZhciBpPTA7IGk8Zmlyc3REb3c7IGkrKykgY2FsSHRtbCArPSAnPGRpdj48L2Rpdj4nOwogIHZhciB1c2VkVHlwZXMgPSB7fTsKICBmb3IgKHZhciBkPTE7IGQ8PW5iOyBkKyspIHsKICAgIHZhciBkb3cgPSAoZmlyc3REb3crZC0xKSU3OwogICAgdmFyIGpvdXJLZXkgPSBET1dfS0VZW2Rvd107CiAgICB2YXIgZGF0ZVN0ciA9IHkrJy0nK1N0cmluZyhtKzEpLnBhZFN0YXJ0KDIsJzAnKSsnLScrU3RyaW5nKGQpLnBhZFN0YXJ0KDIsJzAnKTsKICAgIHZhciBpdGVtcyA9IF9wbGFubmluZ0NhY2hlW2RhdGVTdHJdIHx8IG51bGw7CiAgICB2YXIgaGFzUGxhbiA9IGl0ZW1zICYmIGl0ZW1zLmxlbmd0aCA+IDA7CiAgICB2YXIgYWJzID0gYWJzTWFwW2RdOwogICAgdmFyIGlzVG9kYXkgPSBkPT09dG9kYXkuZ2V0RGF0ZSgpICYmIG09PT10b2RheS5nZXRNb250aCgpICYmIHk9PT10b2RheS5nZXRGdWxsWWVhcigpOwogICAgdmFyIGJnPScnLCBjb2w9JycsIHR0bD0nJywgY2xzPSdjYWwtZGF5JywgZXh0cmE9Jyc7CiAgICBpZiAoaXNUb2RheSkgY2xzICs9ICcgdG9kYXknOwogICAgaWYgKGFicykgewogICAgICBiZyA9IGFicy5wZW5kaW5nID8gKENPTE9SU1thYnMudHlwZV0rJ2NjJykgOiBDT0xPUlNbYWJzLnR5cGVdOwogICAgICBjb2wgPSAnd2hpdGUnOwogICAgICB0dGwgPSBMQUJFTFNbYWJzLnR5cGVdKyhhYnMucGVuZGluZz8nIChlbiBhdHRlbnRlKSc6JycpOwogICAgICBjbHMgKz0gJyBhYnMnKyhhYnMucGVuZGluZz8nIGFicy1wZW5kaW5nJzonJyk7CiAgICAgIHVzZWRUeXBlc1thYnMudHlwZV0gPSB0cnVlOwogICAgICBpZiAoaGFzUGxhbikgZXh0cmEgPSAnPGRpdiBzdHlsZT0iZm9udC1zaXplOjdweDtvcGFjaXR5OjAuNztsaW5lLWhlaWdodDoxO21hcmdpbi10b3A6MnB4Ij4nK2dldFBsYWdlc1N0cihpdGVtc1swXSkrJzwvZGl2Pic7CiAgICB9IGVsc2UgaWYgKGhhc1BsYW4pIHsKICAgICAgdmFyIHRvdGFsSCA9IGl0ZW1zLnJlZHVjZShmdW5jdGlvbihzLGl0KSB7IHJldHVybiBzICsgaXRlbUgoaXQpOyB9LCAwKTsKICAgICAgYmcgPSAncmdiYSg1LDE1MCwxMDUsMC4xMiknOyBjb2wgPSAnIzA0Nzg1Nyc7IGNscyArPSAnIHdvcmsnOwogICAgICB0dGwgPSBnZXRQbGFnZXNTdHIoaXRlbXNbMF0pICsgJyAoJyArIHRvdGFsSC50b0ZpeGVkKDEpICsgJ2gpJzsKICAgICAgZXh0cmEgPSAnPGRpdiBzdHlsZT0iZm9udC1zaXplOjcuNXB4O2ZvbnQtd2VpZ2h0OjcwMDtsaW5lLWhlaWdodDoxLjI7bWFyZ2luLXRvcDoycHg7b3BhY2l0eTowLjg1Ij4nK2dldFBsYWdlc1N0cihpdGVtc1swXSkrJzwvZGl2Pic7CiAgICAgIHVzZWRUeXBlc1snX190cmF2YWlsJ10gPSB0cnVlOwogICAgfSBlbHNlIGlmIChob3JhaXJlc1tqb3VyS2V5XSAmJiBob3JhaXJlc1tqb3VyS2V5XS5hY3RpZikgewogICAgICBiZyA9ICdyZ2JhKDUsMTUwLDEwNSwwLjA2KSc7IGNvbCA9ICcjNmVlN2I3JzsgY2xzICs9ICcgd29yayB3b3JrLWdlbmVyaWMnOwogICAgICB2YXIgaCA9IGhvcmFpcmVzW2pvdXJLZXldOwogICAgICB0dGwgPSAnSG9yYWlyZSBoYWJpdHVlbCcrKGguZGViJiZoLmZpbj8nIFx1MDBiNyAnK2guZGViKycgXHUyMDEzICcraC5maW46JycpOwogICAgfSBlbHNlIHsKICAgICAgYmcgPSAndHJhbnNwYXJlbnQnOyBjb2wgPSAnI2QxZDVkYic7IGNscyArPSAnIG9mZic7CiAgICB9CiAgICB2YXIgc3R5bGUgPSAnYmFja2dyb3VuZDonK2JnKyc7Y29sb3I6Jytjb2wrJzsnOwogICAgaWYgKGlzVG9kYXkpIHN0eWxlICs9ICdvdXRsaW5lOjJweCBzb2xpZCAjMDU5NjY5O291dGxpbmUtb2Zmc2V0Oi0ycHg7JzsKICAgIGNhbEh0bWwgKz0gJzxkaXYgY2xhc3M9IicrY2xzKyciIHN0eWxlPSInK3N0eWxlKyciIHRpdGxlPSInK3R0bCsnIj4nK2QrZXh0cmErJzwvZGl2Pic7CiAgfQogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjYWwtZ3JpZCcpLmlubmVySFRNTCA9IGNhbEh0bWw7CiAgdmFyIGxlZ0h0bWwgPSAnJzsKICBpZiAoT2JqZWN0LmtleXMoX3BsYW5uaW5nQ2FjaGUpLmxlbmd0aCA+IDApCiAgICBsZWdIdG1sICs9ICc8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2dhcDo1cHg7Zm9udC1zaXplOjEwcHg7Y29sb3I6dmFyKC0tbXV0ZWQpIj48ZGl2IHN0eWxlPSJ3aWR0aDo5cHg7aGVpZ2h0OjlweDtib3JkZXItcmFkaXVzOjJweDtiYWNrZ3JvdW5kOnJnYmEoNSwxNTAsMTA1LDAuNCkiPjwvZGl2PlBsYW5pZmlcdTAwZTk8L2Rpdj4nOwogIGVsc2UKICAgIGxlZ0h0bWwgKz0gJzxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7Z2FwOjVweDtmb250LXNpemU6MTBweDtjb2xvcjp2YXIoLS1tdXRlZCkiPjxkaXYgc3R5bGU9IndpZHRoOjlweDtoZWlnaHQ6OXB4O2JvcmRlci1yYWRpdXM6MnB4O2JhY2tncm91bmQ6cmdiYSg1LDE1MCwxMDUsMC4xNSkiPjwvZGl2PkhvcmFpcmUgaGFiaXR1ZWw8L2Rpdj4nOwogIGxlZ0h0bWwgKz0gT2JqZWN0LmtleXModXNlZFR5cGVzKS5maWx0ZXIoZnVuY3Rpb24odCl7IHJldHVybiB0IT09J19fdHJhdmFpbCc7IH0pLm1hcChmdW5jdGlvbih0KSB7CiAgICByZXR1cm4gJzxkaXYgc3R5bGU9ImRpc3BsYXk6ZmxleDthbGlnbi1pdGVtczpjZW50ZXI7Z2FwOjVweDtmb250LXNpemU6MTBweDtjb2xvcjp2YXIoLS1tdXRlZCkiPjxkaXYgc3R5bGU9IndpZHRoOjlweDtoZWlnaHQ6OXB4O2JvcmRlci1yYWRpdXM6MnB4O2JhY2tncm91bmQ6JysoQ09MT1JTW3RdfHwnIzZiNzI4MCcpKyciPjwvZGl2PicrKExBQkVMU1t0XXx8dCkrJzwvZGl2Pic7CiAgfSkuam9pbignJyk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NhbC1sZWdlbmQnKS5pbm5lckhUTUwgPSBsZWdIdG1sOwp9CgpmdW5jdGlvbiByZW5kZXJIb3JhaXJlcygpIHsKICB2YXIgaG9yYWlyZXMgPSAoX3BhcmFtcyAmJiBfcGFyYW1zLmhvcmFpcmVzKSB8fCB7fTsKICB2YXIgam91cnNBY3RpZnMgPSBET1dfS0VZLmZpbHRlcihmdW5jdGlvbihqKXsgcmV0dXJuIGhvcmFpcmVzW2pdICYmIGhvcmFpcmVzW2pdLmFjdGlmOyB9KTsKICB2YXIgY2FyZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdob3JhaXJlcy1jYXJkJyk7CiAgaWYoIWpvdXJzQWN0aWZzLmxlbmd0aCl7IGNhcmQuc3R5bGUuZGlzcGxheT0nbm9uZSc7IHJldHVybjsgfQogIGNhcmQuc3R5bGUuZGlzcGxheT0nJzsKICB2YXIgakxhYmVscyA9IHtsdW5kaTonTHVuZGknLG1hcmRpOidNYXJkaScsbWVyY3JlZGk6J01lcmNyZWRpJyxqZXVkaTonSmV1ZGknLHZlbmRyZWRpOidWZW5kcmVkaScsc2FtZWRpOidTYW1lZGknLGRpbWFuY2hlOidEaW1hbmNoZSd9OwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdob3JhaXJlcy1ib2R5JykuaW5uZXJIVE1MID0gam91cnNBY3RpZnMubWFwKGZ1bmN0aW9uKGopewogICAgdmFyIGggPSBob3JhaXJlc1tqXTsKICAgIHJldHVybiAnPGRpdiBjbGFzcz0iaW5mby1saW5lIj4nCiAgICAgICsnPHNwYW4gY2xhc3M9ImluZm8tbGluZS1pY29uIj5cdWQ4M2RcdWRjYzY8L3NwYW4+JwogICAgICArJzxzcGFuIGNsYXNzPSJpbmZvLWxpbmUtbGFiZWwiPicrakxhYmVsc1tqXSsnPC9zcGFuPicKICAgICAgKyc8c3BhbiBjbGFzcz0iaW5mby1saW5lLXZhbCIgc3R5bGU9ImZvbnQtc2l6ZToxMnB4Ij4nKyhoLmRlYiYmaC5maW4/aC5kZWIrJyBcdTIwMTMgJytoLmZpbjonQWN0aWYnKSsnPC9zcGFuPicKICAgICsnPC9kaXY+JzsKICB9KS5qb2luKCcnKTsKfQoKLyog4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQCiAgIEZPUk1VTEFJUkUgQ09OR8OJUwrilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAgKi8KdmFyIF9jdXJTdGVwID0gMTsKdmFyIF9qdXN0aWZCNjQgPSBudWxsOwp2YXIgX2p1c3RpZk1ldGEgPSBudWxsOwoKZnVuY3Rpb24gb25KdXN0aWZDaGFuZ2UoaW5wdXQpIHsKICB2YXIgZmlsZSA9IGlucHV0LmZpbGVzWzBdOwogIGlmICghZmlsZSkgcmV0dXJuOwogIGlmIChmaWxlLnNpemUgPiA1KjEwMjQqMTAyNCkgeyBzaG93VG9hc3QoJ0ZpY2hpZXIgdHJvcCBsb3VyZCAobWF4IDUgTW8pJywnZXJyJyk7IHJldHVybjsgfQogIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpOwogIHJlYWRlci5vbmxvYWQgPSBmdW5jdGlvbihlKSB7CiAgICBfanVzdGlmQjY0ID0gZS50YXJnZXQucmVzdWx0OwogICAgX2p1c3RpZk1ldGEgPSB7IG5hbWU6IGZpbGUubmFtZSwgc2l6ZTogZmlsZS5zaXplLCB0eXBlOiBmaWxlLnR5cGUgfTsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqdXN0aWYtbmFtZScpLnRleHRDb250ZW50ID0gZmlsZS5uYW1lOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2p1c3RpZi1zaXplJykudGV4dENvbnRlbnQgPSAoZmlsZS5zaXplLzEwMjQpLnRvRml4ZWQoMCkrJ0tvJzsKICAgIHZhciBwcmV2ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2p1c3RpZi1wcmV2aWV3Jyk7CiAgICBwcmV2LnN0eWxlLmRpc3BsYXkgPSAnZmxleCc7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnanVzdGlmLWRyb3AnKS5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogIH07CiAgcmVhZGVyLnJlYWRBc0RhdGFVUkwoZmlsZSk7Cn0Kd2luZG93Lm9uSnVzdGlmQ2hhbmdlID0gb25KdXN0aWZDaGFuZ2U7CgpmdW5jdGlvbiBjbGVhckp1c3RpZihlKSB7CiAgaWYgKGUpIGUuc3RvcFByb3BhZ2F0aW9uKCk7CiAgX2p1c3RpZkI2NCA9IG51bGw7IF9qdXN0aWZNZXRhID0gbnVsbDsKICB2YXIgaW5wID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2p1c3RpZi1pbnB1dCcpOwogIGlmIChpbnApIGlucC52YWx1ZSA9ICcnOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqdXN0aWYtcHJldmlldycpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2p1c3RpZi1kcm9wJykuc3R5bGUuZGlzcGxheSA9ICcnOwp9CndpbmRvdy5jbGVhckp1c3RpZiA9IGNsZWFySnVzdGlmOwoKZnVuY3Rpb24gc2VsVHlwZShrKSB7CiAgX3NlbFR5cGUgPSBrOwogIHJlbmRlclR5cGVHcmlkKCk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25leHQxJykuZGlzYWJsZWQgPSBmYWxzZTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZXZlbmVtZW50LWxvaScpLmNsYXNzTmFtZSA9ICdhbGVydCBhbGVydC1ibHVlJysoaz09PSdldmVuZW1lbnQnPycgc2hvdyc6JycpOwogIHZhciBqdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqdXN0aWYtd3JhcCcpOwogIGlmIChqdykgancuc3R5bGUuZGlzcGxheSA9IChrPT09J21hbGFkaWUnIHx8IGs9PT0nZm9ybWF0aW9uJykgPyAnJyA6ICdub25lJzsKICBjbGVhckp1c3RpZigpOwp9CndpbmRvdy5zZWxUeXBlID0gc2VsVHlwZTsKCmZ1bmN0aW9uIGdvU3RlcChuKSB7CiAgaWYgKG49PT0yICYmICFfc2VsVHlwZSkgcmV0dXJuOwogIGlmIChuPT09MykgewogICAgdmFyIGRlYiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmLWRlYicpLnZhbHVlOwogICAgaWYgKCFkZWIpIHsgc2hvd1RvYXN0KCdTXHUwMGU5bGVjdGlvbm5leiB1bmUgZGF0ZSBkZSBkXHUwMGU5YnV0JywnZXJyJyk7IHJldHVybjsgfQogICAgYnVpbGRSZWNhcCgpOwogIH0KICBfY3VyU3RlcCA9IG47CiAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnLmZvcm0tc3RlcCcpLmZvckVhY2goZnVuY3Rpb24oZSkgeyBlLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOyB9KTsKICB2YXIgc3QgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3QnK24pOwogIGlmIChzdCkgc3QuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgZm9yICh2YXIgaT0xOyBpPD0zOyBpKyspIHsKICAgIHZhciBkZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzJytpKTsKICAgIHZhciBsbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzbCcraSk7CiAgICBpZiAoZGQpIGRkLmNsYXNzTmFtZSA9ICdzdGVwLWRvdCcrKGk8bj8nIGRvbmUnOmk9PT1uPycgYWN0aXZlJzonJyk7CiAgICBpZiAobGwgJiYgaTwzKSBsbC5jbGFzc05hbWUgPSAnc3RlcC1saW5lJysoaTxuPycgZG9uZSc6JycpOwogIH0KICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RlcC1sYmwnKS50ZXh0Q29udGVudCA9ICdcdTAwYzl0YXBlICcrbisnIC8gMyc7Cn0Kd2luZG93LmdvU3RlcCA9IGdvU3RlcDsKCmZ1bmN0aW9uIGpvdXJzT3V2cmVzKGRlYiwgZmluKSB7CiAgaWYgKCFkZWIgfHwgIWZpbikgcmV0dXJuIDA7CiAgdmFyIGQgPSBuZXcgRGF0ZShkZWIrJ1QxMjowMDowMCcpLCBmID0gbmV3IERhdGUoZmluKydUMTI6MDA6MDAnKSwgYyA9IDA7CiAgd2hpbGUgKGQgPD0gZikgeyB2YXIgZHcgPSBkLmdldERheSgpOyBpZiAoZHchPT0wICYmIGR3IT09NikgYysrOyBkLnNldERhdGUoZC5nZXREYXRlKCkrMSk7IH0KICByZXR1cm4gYzsKfQoKZnVuY3Rpb24gb25EYXRlQ2hnKCkgewogIHZhciBkZWIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZi1kZWInKS52YWx1ZTsKICB2YXIgZmluID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2YtZmluJykudmFsdWU7CiAgaWYgKGZpbiAmJiBmaW4gPCBkZWIpIHsgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2YtZmluJykudmFsdWUgPSBkZWI7IGZpbiA9IGRlYjsgfQogIHZhciBqYSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3Vycy1hbGVydCcpOwogIHZhciBzYSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzb2xkZS1hbGVydCcpOwogIGlmICghZGViKSB7IGphLmNsYXNzTmFtZT0nYWxlcnQgYWxlcnQtZ3JlZW4nOyBzYS5jbGFzc05hbWU9J2FsZXJ0IGFsZXJ0LW9yYW5nZSc7IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduZXh0MicpLmRpc2FibGVkPXRydWU7IHJldHVybjsgfQogIHZhciBqb3VycyA9IGpvdXJzT3V2cmVzKGRlYiwgZmlufHxkZWIpOwogIGphLnRleHRDb250ZW50ID0gJ1x1ZDgzZFx1ZGNjNSAnK2pvdXJzKycgam91cicrKGpvdXJzPjE/J3MnOicnKSsnIG91dnJcdTAwZTknKyhqb3Vycz4xPydzJzonJyk7CiAgamEuY2xhc3NOYW1lID0gJ2FsZXJ0IGFsZXJ0LWdyZWVuIHNob3cnOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduZXh0MicpLmRpc2FibGVkID0gZmFsc2U7CiAgdmFyIHNrID0gU09MREVfS1tfc2VsVHlwZV07CiAgaWYgKHNrICYmIF9zb2xkZXNbc2tdICE9PSB1bmRlZmluZWQpIHsKICAgIHZhciBzb2xkZSA9IHBhcnNlRmxvYXQoX3NvbGRlc1tza10pIHx8IDA7CiAgICBpZiAoam91cnMgPiBzb2xkZSkgewogICAgICBzYS50ZXh0Q29udGVudCA9ICdcdTI2YTBcdWZlMGYgU29sZGUgaW5zdWZmaXNhbnQgOiAnK3NvbGRlLnRvRml4ZWQoMSkrKF9zZWxUeXBlPT09J3JlY3VwZXJhdGlvbic/J2gnOidqJykrJyBkaXNwb25pYmxlcywgJytqb3VycysnaiBkZW1hbmRcdTAwZTlzJzsKICAgICAgc2EuY2xhc3NOYW1lID0gJ2FsZXJ0IGFsZXJ0LW9yYW5nZSBzaG93JzsKICAgIH0gZWxzZSBzYS5jbGFzc05hbWUgPSAnYWxlcnQgYWxlcnQtb3JhbmdlJzsKICB9IGVsc2Ugc2EuY2xhc3NOYW1lID0gJ2FsZXJ0IGFsZXJ0LW9yYW5nZSc7Cn0Kd2luZG93Lm9uRGF0ZUNoZyA9IG9uRGF0ZUNoZzsKCmZ1bmN0aW9uIGJ1aWxkUmVjYXAoKSB7CiAgdmFyIGRlYiAgICA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmLWRlYicpLnZhbHVlOwogIHZhciBmaW4gICAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZi1maW4nKS52YWx1ZSB8fCBkZWI7CiAgdmFyIG1vdGlmICA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmLW1vdGlmJykudmFsdWUudHJpbSgpOwogIHZhciBqb3VycyAgPSBqb3Vyc091dnJlcyhkZWIsIGZpbik7CiAgdmFyIGRlYkZtdCA9IG5ldyBEYXRlKGRlYisnVDEyOjAwOjAwJykudG9Mb2NhbGVEYXRlU3RyaW5nKCdmci1GUicse3dlZWtkYXk6J2xvbmcnLGRheTonbnVtZXJpYycsbW9udGg6J2xvbmcnLHllYXI6J251bWVyaWMnfSk7CiAgdmFyIGZpbkZtdCA9IG5ldyBEYXRlKGZpbisnVDEyOjAwOjAwJykudG9Mb2NhbGVEYXRlU3RyaW5nKCdmci1GUicse3dlZWtkYXk6J2xvbmcnLGRheTonbnVtZXJpYycsbW9udGg6J2xvbmcnfSk7CiAgdmFyIHNrICAgICA9IFNPTERFX0tbX3NlbFR5cGVdOwogIHZhciBzb2xkZSAgPSAoc2sgIT09IHVuZGVmaW5lZCkgPyAocGFyc2VGbG9hdChfc29sZGVzW3NrXSl8fDApIDogbnVsbDsKICB2YXIgYXByZXMgID0gc29sZGUgIT09IG51bGwgPyBNYXRoLm1heCgwLCBzb2xkZS1qb3VycykgOiBudWxsOwogIHZhciBydyAgICAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmVjYXAtd2FybicpOwogIGlmIChzb2xkZSAhPT0gbnVsbCAmJiBqb3VycyA+IHNvbGRlKSB7CiAgICBydy50ZXh0Q29udGVudCA9ICdcdTI2YTBcdWZlMGYgU29sZGUgaW5zdWZmaXNhbnQgKCcrc29sZGUudG9GaXhlZCgxKSsnaiBkaXNwbykuIFZvdHJlIGVtcGxveWV1ciBlbiBzZXJhIGluZm9ybVx1MDBlOS4nOwogICAgcncuY2xhc3NOYW1lID0gJ2FsZXJ0IGFsZXJ0LW9yYW5nZSBzaG93JzsKICB9IGVsc2UgcncuY2xhc3NOYW1lID0gJ2FsZXJ0IGFsZXJ0LW9yYW5nZSc7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JlY2FwJykuaW5uZXJIVE1MID0KICAgICc8ZGl2IGNsYXNzPSJyZXN1bWUtcm93Ij48c3Bhbj5UeXBlPC9zcGFuPjxzcGFuPicrSUNPTlNbX3NlbFR5cGVdKycgJytMQUJFTFNbX3NlbFR5cGVdKyc8L3NwYW4+PC9kaXY+JwogICAgKyc8ZGl2IGNsYXNzPSJyZXN1bWUtcm93Ij48c3Bhbj5EdTwvc3Bhbj48c3Bhbj4nK2RlYkZtdCsnPC9zcGFuPjwvZGl2PicKICAgICsnPGRpdiBjbGFzcz0icmVzdW1lLXJvdyI+PHNwYW4+QXU8L3NwYW4+PHNwYW4+JytmaW5GbXQrJzwvc3Bhbj48L2Rpdj4nCiAgICArKG1vdGlmPyc8ZGl2IGNsYXNzPSJyZXN1bWUtcm93Ij48c3Bhbj5Nb3RpZjwvc3Bhbj48c3Bhbj4nK21vdGlmKyc8L3NwYW4+PC9kaXY+JzonJykKICAgICsnPGRpdiBjbGFzcz0icmVzdW1lLXJvdyI+PHNwYW4+VG90YWw8L3NwYW4+PHNwYW4gc3R5bGU9ImNvbG9yOnZhcigtLWczKSI+Jytqb3VycysnIGpvdXInKyhqb3Vycz4xPydzJzonJykrJyBvdXZyXHUwMGU5Jysoam91cnM+MT8ncyc6JycpKyc8L3NwYW4+PC9kaXY+JwogICAgKyhhcHJlcyE9PW51bGw/JzxkaXYgY2xhc3M9InJlc3VtZS1yb3ciPjxzcGFuPlNvbGRlIGFwclx1MDBlOHM8L3NwYW4+PHNwYW4gc3R5bGU9ImNvbG9yOicrKGFwcmVzPjU/J3ZhcigtLWczKSc6J3ZhcigtLW9yYW5nZSknKSsnIj4nK2FwcmVzLnRvRml4ZWQoMSkrJ2o8L3NwYW4+PC9kaXY+JzonJykKICAgICsoX2p1c3RpZkI2ND8nPGRpdiBjbGFzcz0icmVzdW1lLXJvdyI+PHNwYW4+SnVzdGlmaWNhdGlmPC9zcGFuPjxzcGFuIHN0eWxlPSJjb2xvcjp2YXIoLS1nMykiPlx1ZDgzZFx1ZGNjZSAnKyhfanVzdGlmTWV0YT9fanVzdGlmTWV0YS5uYW1lOidGaWNoaWVyIGpvaW50JykrJzwvc3Bhbj48L2Rpdj4nOicnKTsKfQoKYXN5bmMgZnVuY3Rpb24gc3VibWl0RGVtYW5kZSgpIHsKICB2YXIgZGViICAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZi1kZWInKS52YWx1ZTsKICB2YXIgZmluICAgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZi1maW4nKS52YWx1ZSB8fCBkZWI7CiAgdmFyIG1vdGlmID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2YtbW90aWYnKS52YWx1ZS50cmltKCk7CiAgdmFyIGpvdXJzID0gam91cnNPdXZyZXMoZGViLCBmaW4pOwogIHZhciBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuLXN1Ym1pdCcpOwogIGJ0bi5kaXNhYmxlZCA9IHRydWU7IGJ0bi50ZXh0Q29udGVudCA9ICdFbnZvaVx1MjAyNic7CiAgdmFyIGRlbWFuZGVEYXRhID0gewogICAgZW1wSWQ6X2VtcElkLCB1aWQ6X3VpZCwgdHlwZTpfc2VsVHlwZSwgZGF0ZURlYnV0OmRlYiwgZGF0ZUZpbjpmaW4sIG5iSm91cnM6am91cnMsCiAgICBzdGF0dXQ6J3BlbmRpbmcnLCBtb3RpZjptb3RpZnx8bnVsbCwKICAgIGNyZWF0ZWRBdDpuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksIHNvdXJjZTonc2FsYXJpZScsCiAgfTsKICBpZiAoX2p1c3RpZkI2NCAmJiBfanVzdGlmTWV0YSkgewogICAgZGVtYW5kZURhdGEuanVzdGlmaWNhdGlmID0geyBkYXRhOl9qdXN0aWZCNjQsIG5hbWU6X2p1c3RpZk1ldGEubmFtZSwgc2l6ZTpfanVzdGlmTWV0YS5zaXplLCB0eXBlOl9qdXN0aWZNZXRhLnR5cGUgfTsKICB9CiAgdHJ5IHsKICAgIGF3YWl0IHdpbmRvdy5fYWRkRG9jKFsncmhfY29uZ2VzJywgX3VpZCwgJ2RlbWFuZGVzJ10sIGRlbWFuZGVEYXRhKTsKICAgIF9kZW1hbmRlcy51bnNoaWZ0KHtpZDondG1wXycrRGF0ZS5ub3coKSxlbXBJZDpfZW1wSWQsdHlwZTpfc2VsVHlwZSxkYXRlRGVidXQ6ZGViLGRhdGVGaW46ZmluLG5iSm91cnM6am91cnMsc3RhdHV0OidwZW5kaW5nJyxtb3RpZjptb3RpZnx8bnVsbCxjcmVhdGVkQXQ6bmV3IERhdGUoKS50b0lTT1N0cmluZygpfSk7CiAgICBjYWxjU29sZGVzKCk7IHJlbmRlclNvbGRlc0Zsb3R0YW50cygpOyByZW5kZXJEZW1hbmRlcygpOyByZW5kZXJDYWwoKTsgcmVuZGVyQWNjdWVpbCgpOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0MycpLmNsYXNzTGlzdC5yZW1vdmUoJ2FjdGl2ZScpOwogICAgdmFyIHN3ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1Y2Nlc3Mtd3JhcCcpOwogICAgc3cuc3R5bGUuZGlzcGxheSA9ICdmbGV4Jzsgc3cuY2xhc3NMaXN0LmFkZCgnc2hvdycpOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1Y2Nlc3Mtc3ViJykudGV4dENvbnRlbnQgPSAnVm90cmUgZGVtYW5kZSBkZSAnK2pvdXJzKydqICgnK0xBQkVMU1tfc2VsVHlwZV0rJykgYSBcdTAwZTl0XHUwMGU5IHRyYW5zbWlzZS4gVm90cmUgZW1wbG95ZXVyIGxhIHRyYWl0ZXJhIHByb2NoYWluZW1lbnQuJzsKICB9IGNhdGNoKGUpIHsKICAgIGNvbnNvbGUuZXJyb3IoZSk7IHNob3dUb2FzdCgnRXJyZXVyIDogJytlLm1lc3NhZ2UsICdlcnInKTsKICAgIGJ0bi5kaXNhYmxlZCA9IGZhbHNlOyBidG4udGV4dENvbnRlbnQgPSAnXHUyNzA5XHVmZTBmIEVudm95ZXIgbGEgZGVtYW5kZSc7CiAgfQp9CndpbmRvdy5zdWJtaXREZW1hbmRlID0gc3VibWl0RGVtYW5kZTsKCmZ1bmN0aW9uIHJlc2V0Rm9ybSgpIHsKICBfc2VsVHlwZSA9ICcnOyBfY3VyU3RlcCA9IDE7CiAgdmFyIHN3ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1Y2Nlc3Mtd3JhcCcpOwogIHN3LnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IHN3LmNsYXNzTGlzdC5yZW1vdmUoJ3Nob3cnKTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZi1kZWInKS52YWx1ZSA9ICcnOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmLWZpbicpLnZhbHVlID0gJyc7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2YtbW90aWYnKS52YWx1ZSA9ICcnOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqb3Vycy1hbGVydCcpLmNsYXNzTmFtZSA9ICdhbGVydCBhbGVydC1ncmVlbic7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NvbGRlLWFsZXJ0JykuY2xhc3NOYW1lID0gJ2FsZXJ0IGFsZXJ0LW9yYW5nZSc7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ25leHQxJykuZGlzYWJsZWQgPSB0cnVlOwogIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCduZXh0MicpLmRpc2FibGVkID0gdHJ1ZTsKICBjbGVhckp1c3RpZigpOwogIHZhciBqdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqdXN0aWYtd3JhcCcpOwogIGlmIChqdykgancuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICBnb1N0ZXAoMSk7IHJlbmRlclR5cGVHcmlkKCk7Cn0Kd2luZG93LnJlc2V0Rm9ybSA9IHJlc2V0Rm9ybTsKCi8qIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkAogICBOQVZJR0FUSU9OIE9OR0xFVFMK4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQ4pWQICovCmZ1bmN0aW9uIHNob3dUYWIoaWQsIGJ0bikgewogIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy50YWItc2VjdGlvbicpLmZvckVhY2goZnVuY3Rpb24ocyl7IHMuY2xhc3NMaXN0LnJlbW92ZSgnYWN0aXZlJyk7IH0pOwogIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy50bmF2JykuZm9yRWFjaChmdW5jdGlvbihiKXsgYi5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKTsgfSk7CiAgdmFyIHNlYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YWItJytpZCk7CiAgaWYoc2VjKSBzZWMuY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7CiAgaWYoYnRuKSBidG4uY2xhc3NMaXN0LmFkZCgnYWN0aXZlJyk7Cn0Kd2luZG93LnNob3dUYWIgPSBzaG93VGFiOwoKZnVuY3Rpb24gZ29UYWIoYnRuKSB7CiAgdmFyIHRhYiA9IGJ0bi5nZXRBdHRyaWJ1dGUoJ2RhdGEtdGFiJyk7CiAgdmFyIGVsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnRuYXZbb25jbGljayo9IicgKyB0YWIgKyAnIl0nKTsKICBzaG93VGFiKHRhYiwgZWwpOwp9CndpbmRvdy5nb1RhYiA9IGdvVGFiOwoKCi8qIOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkOKVkAogICBVVElMUwrilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZDilZAgKi8KZnVuY3Rpb24gY2hhbmdlWWVhcigpIHsKICB2YXIgdiA9IHByb21wdCgnQW5uXHUwMGU5ZSBcdTAwZTAgYWZmaWNoZXIgOicsIF95ZWFyKTsKICB2YXIgbiA9IHBhcnNlSW50KHYpfHwwOwogIGlmIChuPj0yMDIwICYmIG48PTIwMzApIHsKICAgIF95ZWFyID0gbjsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd5ZWFyLWxibCcpLnRleHRDb250ZW50ID0gX3llYXI7CiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWNjdWVpbC1hbm5lZS1sYmwnKS50ZXh0Q29udGVudCA9ICdcdTIwMTQgJytfeWVhcjsKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb25nZXMtYW5uZWUtbGJsJykudGV4dENvbnRlbnQgPSAnXHUyMDE0ICcrX3llYXI7CiAgICBjYWxjU29sZGVzKCk7IHJlbmRlclNvbGRlc0Zsb3R0YW50cygpOyByZW5kZXJBY2N1ZWlsKCk7IHJlbmRlclNvbGRlc0RldGFpbCgpOyByZW5kZXJEZW1hbmRlcygpOwogIH0KfQp3aW5kb3cuY2hhbmdlWWVhciA9IGNoYW5nZVllYXI7CgpmdW5jdGlvbiBwcmV2TSgpIHsKICBfY2FsTW9udGguc2V0TW9udGgoX2NhbE1vbnRoLmdldE1vbnRoKCktMSk7CiAgbG9hZFBsYW5uaW5nTW9udGgoX2NhbE1vbnRoLmdldEZ1bGxZZWFyKCksIF9jYWxNb250aC5nZXRNb250aCgpKS50aGVuKHJlbmRlckNhbCk7Cn0KZnVuY3Rpb24gbmV4dE0oKSB7CiAgX2NhbE1vbnRoLnNldE1vbnRoKF9jYWxNb250aC5nZXRNb250aCgpKzEpOwogIGxvYWRQbGFubmluZ01vbnRoKF9jYWxNb250aC5nZXRGdWxsWWVhcigpLCBfY2FsTW9udGguZ2V0TW9udGgoKSkudGhlbihyZW5kZXJDYWwpOwp9CndpbmRvdy5wcmV2TSA9IHByZXZNOyB3aW5kb3cubmV4dE0gPSBuZXh0TTsKCmZ1bmN0aW9uIGZtdERhdGUocykgewogIGlmKCFzKSByZXR1cm4gJ1x1MjAxNCc7CiAgdHJ5IHsgcmV0dXJuIG5ldyBEYXRlKHMrJ1QxMjowMDowMCcpLnRvTG9jYWxlRGF0ZVN0cmluZygnZnItRlInLHtkYXk6JzItZGlnaXQnLG1vbnRoOicyLWRpZ2l0Jyx5ZWFyOidudW1lcmljJ30pOyB9IGNhdGNoKGUpeyByZXR1cm4gczsgfQp9CgpmdW5jdGlvbiBjYWxjQW5jaWVubmV0ZShkYXRlU3RyKSB7CiAgaWYoIWRhdGVTdHIpIHJldHVybiAnJzsKICB2YXIgZCA9IG5ldyBEYXRlKGRhdGVTdHIrJ1QxMjowMDowMCcpOwogIHZhciBub3cgPSBuZXcgRGF0ZSgpOwogIHZhciBtb2lzID0gKG5vdy5nZXRGdWxsWWVhcigpLWQuZ2V0RnVsbFllYXIoKSkqMTIgKyAobm93LmdldE1vbnRoKCktZC5nZXRNb250aCgpKTsKICBpZihtb2lzPDEpIHJldHVybiAnTm91dmVhdSc7CiAgaWYobW9pczwxMikgcmV0dXJuIG1vaXMrJyBtb2lzJzsKICB2YXIgYW5zID0gTWF0aC5mbG9vcihtb2lzLzEyKTsKICB2YXIgcm0gPSBtb2lzJTEyOwogIHJldHVybiBhbnMrJ2FuJysoYW5zPjE/J3MnOicnKSsocm0+MD8nICcrcm0rJ20nOicnKTsKfQoKZnVuY3Rpb24gbWFza0liYW4oaWJhbikgewogIGlmKCFpYmFuIHx8IGliYW4ubGVuZ3RoPDgpIHJldHVybiBpYmFuOwogIHJldHVybiBpYmFuLnNsaWNlKDAsNCkgKyAnICoqKiogKioqKiAnICsgaWJhbi5zbGljZSgtNCk7Cn0KCmZ1bmN0aW9uIGNhcGl0YWxpemUocykgeyByZXR1cm4gcyA/IHMuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkrcy5zbGljZSgxKSA6IHM7IH0KCmZ1bmN0aW9uIGdldFBsYWdlc1N0cihpdCkgewogIGlmICghaXQpIHJldHVybiAnJzsKICBpZiAoaXQucGxhZ2VzICYmIGl0LnBsYWdlcy5sZW5ndGggPiAwKSByZXR1cm4gaXQucGxhZ2VzLm1hcChmdW5jdGlvbihwKXsgcmV0dXJuIHAuZGViKydcdTIwMTMnK3AuZmluOyB9KS5qb2luKCcgfCAnKTsKICByZXR1cm4gKGl0LmRlYnx8JycpICsgKGl0LmZpbiA/ICdcdTIwMTMnK2l0LmZpbiA6ICcnKTsKfQoKZnVuY3Rpb24gaXRlbUgoaXQpIHsKICBpZiAoaXQucGxhZ2VzICYmIGl0LnBsYWdlcy5sZW5ndGggPiAwKSB7CiAgICByZXR1cm4gaXQucGxhZ2VzLnJlZHVjZShmdW5jdGlvbihzLHApIHsKICAgICAgaWYgKCFwLmRlYnx8IXAuZmluKSByZXR1cm4gczsKICAgICAgdmFyIGE9cC5kZWIuc3BsaXQoJzonKS5tYXAoTnVtYmVyKSwgYj1wLmZpbi5zcGxpdCgnOicpLm1hcChOdW1iZXIpOwogICAgICByZXR1cm4gcyArIE1hdGgubWF4KDAsICgoYlswXSo2MCtiWzFdKS0oYVswXSo2MCthWzFdKSkvNjApOwogICAgfSwgMCk7CiAgfQogIGlmICghaXQuZGVifHwhaXQuZmluKSByZXR1cm4gMDsKICB2YXIgYT1pdC5kZWIuc3BsaXQoJzonKS5tYXAoTnVtYmVyKSwgYj1pdC5maW4uc3BsaXQoJzonKS5tYXAoTnVtYmVyKTsKICByZXR1cm4gTWF0aC5tYXgoMCwgKChiWzBdKjYwK2JbMV0pLShhWzBdKjYwK2FbMV0pKS82MCk7Cn0KCmZ1bmN0aW9uIHNob3dOb3RGb3VuZCgpIHsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZy13cmFwJykuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbm90LWZvdW5kJykuY2xhc3NMaXN0LmFkZCgnc2hvdycpOwp9CgpmdW5jdGlvbiBzaG93VG9hc3QobXNnLCB0eXBlKSB7CiAgdmFyIHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndG9hc3QnKTsKICB0LnRleHRDb250ZW50ID0gbXNnOyB0LmNsYXNzTmFtZSA9ICd0b2FzdCBzaG93ICcrKHR5cGV8fCcnKTsKICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyB0LmNsYXNzTmFtZT0ndG9hc3QnOyB9LCAzMjAwKTsKfQ==";
var bn=atob(b);var by=new Uint8Array(bn.length);
for(var i=0;i<bn.length;i++)by[i]=bn.charCodeAt(i);
var js=new TextDecoder('utf-8').decode(by);
var s=document.createElement('script');s.textContent=js;document.head.appendChild(s);
})();
</script>

<!-- ‚ïê‚ïê PATCH v2 : Fix filtre planning + Timeline ‚ïê‚ïê -->
<script>
(function() {
'use strict';

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PATCH 1 : Override loadPlanningMonth
   Lit depuis rh_planning_public/{uid}/plan_{wk}/{docId}
   Collection publique (allow read: true) aliment√©e par
   le module admin rh-planning.html via saveKey()
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
window.loadPlanningMonth = async function(y, m) {
  window._planningCache = {};
  var uid   = window._uid   || '';
  var empId = window._empId || '';
  if (!uid || !empId) return;

  var weekKeys = {};
  var nb = new Date(y, m + 1, 0).getDate();
  for (var d = 1; d <= nb; d++) {
    var dt = new Date(y, m, d);
    var mon = new Date(dt);
    var dow = mon.getDay();
    var diff = (dow === 0) ? -6 : 1 - dow;
    mon.setDate(mon.getDate() + diff);
    mon.setHours(0, 0, 0, 0);
    var wk = mon.toISOString().slice(0, 10).replace(/-/g, '');
    weekKeys[wk] = true;
  }

  var suffix = '_' + empId;
  for (var wk in weekKeys) {
    try {
      var snap = await window._getDocs('rh_planning_public', uid, 'plan_' + wk);
      snap.forEach(function(docSnap) {
        if (!docSnap.id.endsWith(suffix)) return;
        var idx = docSnap.id.lastIndexOf(suffix);
        var dateStr = docSnap.id.slice(0, idx);
        window._planningCache[dateStr] = docSnap.data().items || [];
      });
    } catch(e) {
      console.warn('[PATCH] loadPlanningMonth wk=' + wk, e.message);
    }
  }
  console.log('[PATCH] planningCache charg√© :', Object.keys(window._planningCache).length, 'jours');
};

// Patcher ensureWeekLoaded pour la vue Timeline
window._ensureWeekLoadedViaAPI = async function(mondayDate) {
  var uid   = window._uid   || '';
  var empId = window._empId || '';
  if (!uid || !empId) return;
  for (var i = 0; i < 7; i++) {
    var d = new Date(mondayDate);
    d.setDate(d.getDate() + i);
    var ds = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
    if (window._planningCache[ds] !== undefined) return;
  }
  var wk = mondayDate.toISOString().slice(0, 10).replace(/-/g, '');
  var suffix = '_' + empId;
  try {
    var snap = await window._getDocs('rh_planning_public', uid, 'plan_' + wk);
    snap.forEach(function(docSnap) {
      if (!docSnap.id.endsWith(suffix)) return;
      var idx = docSnap.id.lastIndexOf(suffix);
      var dateStr = docSnap.id.slice(0, idx);
      window._planningCache[dateStr] = docSnap.data().items || [];
    });
    console.log('[PATCH] timeline week charg√©e, cache total:', Object.keys(window._planningCache).length);
  } catch(e) {
    console.warn('[PATCH] ensureWeekLoaded error:', e.message);
  }
};


/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PATCH 3 : Vue Timeline
   Remplace le contenu de l'onglet planning par
   Calendrier + Timeline (vue semaine d√©taill√©e)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// Couleurs pour les types de planning (align√©es avec le code encod√©)
var PLAN_COLORS = {
  travail:    '#059669',
  repos:      '#6b7280',
  conge:      '#3b82f6',
  maladie:    '#ef4444',
  partiel:    '#f59e0b',
  formation:  '#db2777',
  astreinte:  '#7c3aed'
};
var PLAN_LABELS = {
  travail:   'Travail',
  repos:     'Repos',
  conge:     'Cong√©',
  maladie:   'Maladie',
  partiel:   'Temps partiel',
  formation: 'Formation',
  astreinte: 'Astreinte'
};
var PLAN_ICONS = {
  travail:   'üíº',
  repos:     'üò¥',
  conge:     'üèñÔ∏è',
  maladie:   'ü§í',
  partiel:   '‚è±Ô∏è',
  formation: 'üéì',
  astreinte: 'üìü'
};

// Variable pour l'onglet actif timeline/calendrier
window._planView = 'cal'; // 'cal' | 'timeline'
window._timelineWeek = null; // Date du lundi de la semaine affich√©e

// Injecter CSS Timeline
var styleEl = document.createElement('style');
styleEl.textContent = `
  .plan-view-toggle {
    display: flex; gap: 4px; background: #f3f4f6;
    border-radius: 8px; padding: 3px;
  }
  .pvt-btn {
    padding: 5px 12px; border: none; border-radius: 6px;
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 11px; font-weight: 700; cursor: pointer;
    color: var(--muted); background: transparent;
    transition: all .15s;
  }
  .pvt-btn.active {
    background: white; color: var(--g3);
    box-shadow: 0 1px 4px rgba(0,0,0,.1);
  }

  /* Timeline */
  .timeline-wrap { padding: 0; }
  .tl-week-nav {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 14px; border-bottom: 1px solid var(--border);
  }
  .tl-week-label {
    font-size: 12px; font-weight: 700; color: var(--text);
  }
  .tl-nav-btn {
    border: 1px solid var(--border); background: white;
    border-radius: 6px; width: 28px; height: 28px;
    cursor: pointer; font-size: 14px; display: flex;
    align-items: center; justify-content: center;
    color: var(--muted); transition: all .15s;
  }
  .tl-nav-btn:hover { border-color: var(--g3); color: var(--g3); }

  .tl-day {
    border-bottom: 1px solid #f3f4f6;
    overflow: hidden;
  }
  .tl-day:last-child { border-bottom: none; }
  .tl-day-head {
    display: flex; align-items: center;
    padding: 8px 14px 6px;
    gap: 8px;
  }
  .tl-day-num {
    width: 28px; height: 28px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 800; flex-shrink: 0;
    color: var(--muted); background: #f9fafb;
  }
  .tl-day-num.today {
    background: var(--g3); color: white;
  }
  .tl-day-name {
    font-size: 11px; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: .5px; flex: 1;
  }
  .tl-day-total {
    font-size: 11px; font-weight: 700; color: var(--g3);
  }
  .tl-day.off .tl-day-head { opacity: .45; }

  .tl-items { padding: 0 14px 8px 50px; display: flex; flex-direction: column; gap: 5px; }
  .tl-item {
    display: flex; align-items: center; gap: 8px;
    padding: 7px 10px; border-radius: 8px;
    border-left: 3px solid;
  }
  .tl-item-icon { font-size: 14px; flex-shrink: 0; }
  .tl-item-body { flex: 1; min-width: 0; }
  .tl-item-label {
    font-size: 12px; font-weight: 700; color: var(--text);
  }
  .tl-item-hours {
    font-size: 10px; color: var(--muted); margin-top: 1px;
  }
  .tl-item-dur {
    font-size: 11px; font-weight: 800; flex-shrink: 0;
  }

  .tl-empty {
    padding: 4px 14px 8px 50px;
    font-size: 11px; color: #d1d5db; font-style: italic;
  }

  .tl-week-summary {
    margin: 10px 14px 0; padding: 10px 12px;
    background: var(--green-ghost); border-radius: 10px;
    border: 1px solid #a7f3d0;
    display: flex; gap: 16px; flex-wrap: wrap;
  }
  .tl-sum-item {
    display: flex; flex-direction: column; gap: 1px;
  }
  .tl-sum-val {
    font-size: 15px; font-weight: 800; color: var(--g3);
  }
  .tl-sum-lbl {
    font-size: 9px; font-weight: 700; color: var(--muted);
    text-transform: uppercase; letter-spacing: .4px;
  }
`;
document.head.appendChild(styleEl);

/* Injecter les boutons Calendrier / Timeline dans le card-head du planning */
function injectPlanHeader() {
  var calTitle = document.getElementById('cal-title');
  if (!calTitle) return;
  var head = calTitle.closest('.card-head');
  if (!head || head.dataset.patched) return;
  head.dataset.patched = '1';

  // Remplacer les boutons prev/next + ajouter toggle
  head.innerHTML =
    '<div class="card-title">üìÖ <span id="cal-title">Mon planning</span></div>' +
    '<div style="display:flex;align-items:center;gap:8px">' +
      '<div class="plan-view-toggle">' +
        '<button class="pvt-btn active" id="pvt-cal" onclick="setPlanView(\'cal\')">üìÜ Calendrier</button>' +
        '<button class="pvt-btn" id="pvt-tl" onclick="setPlanView(\'timeline\')">üìã Timeline</button>' +
      '</div>' +
      '<div id="cal-nav-btns" style="display:flex;gap:5px">' +
        '<button class="btn btn-ghost" style="padding:4px 9px;font-size:12px" onclick="prevM()">‚Äπ</button>' +
        '<button class="btn btn-ghost" style="padding:4px 9px;font-size:12px" onclick="nextM()">‚Ä∫</button>' +
      '</div>' +
    '</div>';
}

/* Changer de vue */
window.setPlanView = function(v) {
  window._planView = v;
  document.querySelectorAll('.pvt-btn').forEach(function(b) { b.classList.remove('active'); });
  var btn = document.getElementById('pvt-' + v);
  if (btn) btn.classList.add('active');

  var calNav = document.getElementById('cal-nav-btns');
  var calGrid = document.getElementById('cal-grid');
  var calLeg  = document.getElementById('cal-legend');
  var tlWrap  = document.getElementById('tl-wrap');

  if (v === 'cal') {
    if (calNav)  calNav.style.display = 'flex';
    if (calGrid) calGrid.style.display = '';
    if (calLeg)  calLeg.style.display = '';
    if (tlWrap)  tlWrap.style.display = 'none';
  } else {
    if (calNav)  calNav.style.display = 'none';
    if (calGrid) calGrid.style.display = 'none';
    if (calLeg)  calLeg.style.display = 'none';
    // Cr√©er ou afficher le wrapper timeline
    if (!tlWrap) {
      var wrap = document.createElement('div');
      wrap.id = 'tl-wrap';
      wrap.className = 'timeline-wrap';
      var parent = calGrid ? calGrid.parentNode : null;
      if (parent) parent.appendChild(wrap);
    } else {
      tlWrap.style.display = '';
    }
    // Initialiser la semaine sur la semaine courante
    if (!window._timelineWeek) {
      window._timelineWeek = getMondayOf(new Date());
    }
    renderTimeline();
  }
};

/* Obtenir le lundi d'une semaine */
function getMondayOf(date) {
  var d = new Date(date);
  var day = d.getDay();
  var diff = (day === 0) ? -6 : 1 - day;
  d.setDate(d.getDate() + diff);
  d.setHours(0, 0, 0, 0);
  return d;
}

/* Formater une dur√©e en heures */
function fmtH(h) {
  if (h <= 0) return '‚Äî';
  var hh = Math.floor(h);
  var mm = Math.round((h - hh) * 60);
  if (mm === 0) return hh + 'h';
  return hh + 'h' + String(mm).padStart(2, '0');
}

/* Calculer la dur√©e d'un item planning */
function itemDuration(it) {
  if (it.plages && it.plages.length > 0) {
    return it.plages.reduce(function(s, p) {
      if (!p.deb || !p.fin) return s;
      var a = p.deb.split(':').map(Number);
      var b = p.fin.split(':').map(Number);
      return s + Math.max(0, ((b[0] * 60 + b[1]) - (a[0] * 60 + a[1])) / 60);
    }, 0);
  }
  if (!it.deb || !it.fin) return 0;
  var a = it.deb.split(':').map(Number);
  var b = it.fin.split(':').map(Number);
  return Math.max(0, ((b[0] * 60 + b[1]) - (a[0] * 60 + a[1])) / 60);
}

/* Obtenir les plages horaires d'un item */
function itemHours(it) {
  if (it.plages && it.plages.length > 0) {
    return it.plages.map(function(p) { return (p.deb || '') + '‚Äì' + (p.fin || ''); }).join(' | ');
  }
  if (it.deb && it.fin) return it.deb + '‚Äì' + it.fin;
  return '';
}

/* Navigation Timeline */
window.tlPrev = function() {
  if (!window._timelineWeek) window._timelineWeek = getMondayOf(new Date());
  var d = new Date(window._timelineWeek);
  d.setDate(d.getDate() - 7);
  window._timelineWeek = d;
  // Charger les donn√©es si pas en cache
  ensureWeekLoaded(d).then(renderTimeline);
};
window.tlNext = function() {
  if (!window._timelineWeek) window._timelineWeek = getMondayOf(new Date());
  var d = new Date(window._timelineWeek);
  d.setDate(d.getDate() + 7);
  window._timelineWeek = d;
  ensureWeekLoaded(d).then(renderTimeline);
};

/* Charger les donn√©es planning pour une semaine si pas encore charg√© */
async function ensureWeekLoaded(mondayDate) {
  // D√©l√©guer √† la version API (d√©finie dans PATCH 1)
  if (typeof window._ensureWeekLoadedViaAPI === 'function') {
    return window._ensureWeekLoadedViaAPI(mondayDate);
  }
}

/* Rendre la vue Timeline */
function renderTimeline() {
  var wrap = document.getElementById('tl-wrap');
  if (!wrap) return;
  if (!window._timelineWeek) window._timelineWeek = getMondayOf(new Date());

  var monday = window._timelineWeek;
  var today = new Date();
  today.setHours(0, 0, 0, 0);

  // Label de semaine
  var sundayDate = new Date(monday);
  sundayDate.setDate(sundayDate.getDate() + 6);
  var opts = { day: 'numeric', month: 'short' };
  var wLabel = monday.toLocaleDateString('fr-FR', opts) +
               ' ‚Äî ' + sundayDate.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' });

  var jours = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
  var totalH = 0, nbJoursTravail = 0;

  var daysHtml = '';
  for (var i = 0; i < 7; i++) {
    var cur = new Date(monday);
    cur.setDate(monday.getDate() + i);
    var ds = cur.getFullYear() + '-' +
             String(cur.getMonth() + 1).padStart(2, '0') + '-' +
             String(cur.getDate()).padStart(2, '0');
    var items = window._planningCache[ds] || [];
    var isToday = (cur.getTime() === today.getTime());
    var isOff = (i >= 5 && items.length === 0); // Sam/Dim sans planning = off

    var dayH = items.reduce(function(s, it) { return s + itemDuration(it); }, 0);
    if (dayH > 0) { totalH += dayH; nbJoursTravail++; }

    var numCls = 'tl-day-num' + (isToday ? ' today' : '');
    var dayCls = 'tl-day' + (isOff ? ' off' : '');

    var itemsHtml = '';
    if (items.length > 0) {
      items.forEach(function(it) {
        var type = it.type || 'travail';
        var col  = PLAN_COLORS[type] || '#6b7280';
        var lbl  = PLAN_LABELS[type] || type;
        var ico  = PLAN_ICONS[type]  || 'üìã';
        var hrs  = itemHours(it);
        var dur  = itemDuration(it);
        var note = it.note || '';
        itemsHtml +=
          '<div class="tl-item" style="background:' + col + '11;border-left-color:' + col + '">' +
            '<span class="tl-item-icon">' + ico + '</span>' +
            '<div class="tl-item-body">' +
              '<div class="tl-item-label">' + lbl + (note ? ' ¬∑ ' + note : '') + '</div>' +
              (hrs ? '<div class="tl-item-hours">‚è∞ ' + hrs + '</div>' : '') +
            '</div>' +
            (dur > 0 ? '<span class="tl-item-dur" style="color:' + col + '">' + fmtH(dur) + '</span>' : '') +
          '</div>';
      });
    } else if (!isOff) {
      // Jour ouvr√© sans planning : v√©rifier horaires habituels
      var horaires = (window._params && window._params.horaires) || {};
      var dowKeys = ['lundi','mardi','mercredi','jeudi','vendredi','samedi','dimanche'];
      var jourKey = dowKeys[i];
      var h = horaires[jourKey];
      if (h && h.actif) {
        itemsHtml =
          '<div class="tl-item" style="background:rgba(5,150,105,0.06);border-left-color:#a7f3d0">' +
            '<span class="tl-item-icon">üíº</span>' +
            '<div class="tl-item-body">' +
              '<div class="tl-item-label" style="color:#047857">Horaire habituel</div>' +
              (h.deb && h.fin ? '<div class="tl-item-hours">‚è∞ ' + h.deb + '‚Äì' + h.fin + '</div>' : '') +
            '</div>' +
          '</div>';
      } else {
        itemsHtml = '<div class="tl-empty">Aucun planning saisi</div>';
      }
    }

    daysHtml +=
      '<div class="' + dayCls + '">' +
        '<div class="tl-day-head">' +
          '<div class="' + numCls + '">' + cur.getDate() + '</div>' +
          '<div class="tl-day-name">' + jours[i] + ' ' + cur.toLocaleDateString('fr-FR', {month:'short'}) + '</div>' +
          (dayH > 0 ? '<div class="tl-day-total">' + fmtH(dayH) + '</div>' : '') +
        '</div>' +
        (itemsHtml ? '<div class="tl-items">' + itemsHtml + '</div>' : '') +
      '</div>';
  }

  wrap.innerHTML =
    '<div class="tl-week-nav">' +
      '<button class="tl-nav-btn" onclick="tlPrev()">‚Äπ</button>' +
      '<span class="tl-week-label">üìÖ ' + wLabel + '</span>' +
      '<button class="tl-nav-btn" onclick="tlNext()">‚Ä∫</button>' +
    '</div>' +
    (totalH > 0 ?
      '<div class="tl-week-summary">' +
        '<div class="tl-sum-item"><div class="tl-sum-val">' + fmtH(totalH) + '</div><div class="tl-sum-lbl">Total semaine</div></div>' +
        '<div class="tl-sum-item"><div class="tl-sum-val">' + nbJoursTravail + 'j</div><div class="tl-sum-lbl">Jours planifi√©s</div></div>' +
        (nbJoursTravail > 0 ? '<div class="tl-sum-item"><div class="tl-sum-val">' + fmtH(totalH / nbJoursTravail) + '</div><div class="tl-sum-lbl">Moy. / jour</div></div>' : '') +
      '</div>' : '') +
    daysHtml;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   PATCH 4+5 : Hook renderCal (fusionn√©)
   - Injecte le toggle Calendrier/Timeline
   - Corrige l‚Äôaffichage des types sp√©ciaux (repos, partiel‚Ä¶)
   - Synchronise la vue Timeline si active
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var _origRenderCal = window.renderCal;
window.renderCal = function() {
  if (typeof _origRenderCal === 'function') _origRenderCal();
  setTimeout(injectPlanHeader, 50);
  setTimeout(patchCalDays, 80);
  if (window._planView === 'timeline') {
    setTimeout(renderTimeline, 100);
  }
};

function getItemHours(it) {
  if (it.plages && it.plages.length > 0) return it.plages.map(function(p){ return p.deb+'‚Äì'+p.fin; }).join(' | ');
  if (it.deb && it.fin) return it.deb+'‚Äì'+it.fin;
  return '';
}

function patchCalDays() {
  var cache = window._planningCache || {};
  var calGrid = document.getElementById('cal-grid');
  if (!calGrid) return;
  var days = calGrid.querySelectorAll('.cal-day');
  if (!days.length) return;

  var y = window._calMonth ? window._calMonth.getFullYear() : new Date().getFullYear();
  var m = window._calMonth ? window._calMonth.getMonth() : new Date().getMonth();

  days.forEach(function(cell, idx) {
    var d = idx + 1;
    var ds = y + '-' + String(m + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
    var items = cache[ds];
    if (!items || items.length === 0) return;
    if (cell.classList.contains('abs')) return;

    // Calculer total heures
    var totalH = items.reduce(function(s, it) { return s + itemDuration(it); }, 0);
    var hLabel = totalH > 0 ? fmtH(totalH) : '';

    // Construire le contenu extra : tous les cr√©neaux
    var linesHtml = items.map(function(it) {
      var hrs = getItemHours(it);
      var col = PLAN_COLORS[it.type] || '#047857';
      var note = it.note ? ' ¬∑ ' + it.note : '';
      return '<div style="font-size:7px;font-weight:700;line-height:1.4;color:' + col + ';white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'
        + (hrs || PLAN_ICONS[it.type] || '') + note
        + '</div>';
    }).join('');

    // Mettre √† jour : remplacer l'extra existant
    var existing = cell.querySelector('div');
    if (existing) {
      existing.innerHTML = linesHtml + (hLabel ? '<div style="font-size:7px;color:#6b7280;margin-top:1px">‚è± ' + hLabel + '</div>' : '');
    } else {
      var extra = document.createElement('div');
      extra.innerHTML = linesHtml + (hLabel ? '<div style="font-size:7px;color:#6b7280;margin-top:1px">‚è± ' + hLabel + '</div>' : '');
      cell.appendChild(extra);
    }

    // Tooltip avec tous les cr√©neaux
    cell.title = items.map(function(it) {
      return (PLAN_LABELS[it.type] || it.type) + (getItemHours(it) ? ' ' + getItemHours(it) : '') + (it.note ? ' ¬∑ ' + it.note : '');
    }).join('\n') + (hLabel ? '\nTotal : ' + hLabel : '');
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INIT : attendre que renderAll soit appel√©
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
var _origRenderAll = window.renderAll;
window.renderAll = function() {
  if (typeof _origRenderAll === 'function') _origRenderAll();
  setTimeout(injectPlanHeader, 100);
};

console.log('[PATCH v2] Planning fixes + Timeline charg√©s ‚úì');
})();
</script>
</body>
</html>
