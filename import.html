<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>ALTEORE â€” Import de donnÃ©es</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --blue:#1a3dce;--blue2:#4f7ef8;--bg:#f4f6fb;--white:#fff;
  --border:#e2e8f0;--text:#1a1f36;--muted:#6b7280;
  --green:#10b981;--red:#ef4444;--orange:#f59e0b;--purple:#6366f1;
  --radius:14px;--sw:250px;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px}
nav{width:var(--sw);min-height:100vh;background:linear-gradient(180deg,#0f1f5c,#162366);position:fixed;top:0;left:0;display:flex;flex-direction:column;padding-bottom:20px;overflow-y:auto;z-index:99}
.logo{display:flex;align-items:center;gap:10px;padding:22px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
.logo-i{width:33px;height:33px;background:rgba(255,255,255,.14);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
.logo-t{font-size:17px;font-weight:800;color:#fff;letter-spacing:1px}
.ns{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 18px 4px}
.ni{display:flex;align-items:center;gap:9px;padding:9px 18px;color:rgba(255,255,255,.55);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.ni:hover{color:#fff;background:rgba(255,255,255,.06)}
.ni.on{color:#fff;background:rgba(255,255,255,.1);border-left-color:#4f7ef8}
.sub{overflow:hidden;max-height:0;transition:max-height .3s}.sub.open{max-height:200px}
.si{display:flex;align-items:center;gap:7px;padding:7px 18px 7px 40px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.si:hover{color:rgba(255,255,255,.75);background:rgba(255,255,255,.04)}
.si.on{color:#fff;background:rgba(79,126,248,.15);border-left-color:rgba(79,126,248,.6)}
.dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25)}.si.on .dot{background:#4f7ef8}
.chev{font-size:11px;color:rgba(255,255,255,.3);transition:transform .25s;margin-left:auto}
.nav-footer{margin-top:auto;padding:12px 18px 0;border-top:1px solid rgba(255,255,255,.08)}
.ucard{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,.07);border-radius:8px;cursor:pointer;transition:.15s}
.ucard:hover{background:rgba(255,255,255,.12)}
.uav{width:29px;height:29px;background:linear-gradient(135deg,#4f7ef8,#6366f1);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
.un{font-size:11.5px;font-weight:600;color:#fff}.upl{font-size:10px;color:rgba(255,255,255,.3)}
.lbtn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,.3);cursor:pointer;font-size:13px}
main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.topbar h1{font-size:16px;font-weight:700}.topbar p{font-size:11px;color:var(--muted)}
.tb-r{display:flex;gap:8px;align-items:center}
.btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:5px}
.btn-p{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;box-shadow:0 3px 10px rgba(26,61,206,.2)}
.btn-o{background:#fff;color:var(--blue);border:1.5px solid var(--border)}
.btn-o:hover{border-color:var(--blue2)}
.btn-xs{padding:4px 10px;font-size:11px}
.page{padding:20px 24px;display:flex;flex-direction:column;gap:18px}
.steps{display:flex;align-items:center;gap:0;margin-bottom:4px}
.step{display:flex;align-items:center;gap:8px;flex:1}
.step-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;flex-shrink:0;border:2px solid var(--border);color:var(--muted);background:#fff;transition:.3s}
.step-num.done{background:var(--green);border-color:var(--green);color:#fff}
.step-num.active{background:var(--blue);border-color:var(--blue);color:#fff}
.step-label{font-size:11px;font-weight:600;color:var(--muted)}
.step-label.active{color:var(--blue);font-weight:700}
.step-label.done{color:var(--green)}
.step-line{flex:1;height:2px;background:var(--border);margin:0 8px;transition:.3s}
.step-line.done{background:var(--green)}
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius)}
.card-head{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:#f8faff}
.card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px}
.card-body{padding:20px}
.format-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.fmt-btn{border:2px solid var(--border);border-radius:12px;padding:18px 14px;cursor:pointer;text-align:center;background:#fff;transition:.2s;position:relative}
.fmt-btn:hover{border-color:var(--blue2);background:#f8faff;transform:translateY(-2px);box-shadow:0 4px 16px rgba(79,126,248,.1)}
.fmt-btn.on{border-color:var(--blue);background:#eff6ff;box-shadow:0 0 0 3px rgba(79,126,248,.12)}
.fmt-icon{font-size:28px;margin-bottom:8px}
.fmt-name{font-size:13px;font-weight:700;margin-bottom:3px}
.fmt-desc{font-size:11px;color:var(--muted)}
.fmt-badge{position:absolute;top:-8px;right:10px;background:var(--green);color:#fff;font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px}
.dropzone{border:2px dashed var(--border);border-radius:12px;padding:40px 20px;text-align:center;cursor:pointer;transition:.2s;background:#fafbff}
.dropzone:hover,.dropzone.drag{border-color:var(--blue2);background:#eff6ff}
.dropzone-icon{font-size:40px;margin-bottom:10px}
.dropzone-title{font-size:14px;font-weight:700;margin-bottom:4px}
.dropzone-sub{font-size:12px;color:var(--muted)}
.dropzone-btn{margin-top:14px;display:inline-flex;align-items:center;gap:6px;padding:8px 18px;background:var(--blue);color:#fff;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Plus Jakarta Sans',sans-serif}
input[type=file]{display:none}
.gs-input{display:flex;gap:10px;align-items:center}
.gs-field{flex:1;padding:10px 14px;border:2px solid var(--border);border-radius:10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;outline:none;transition:.15s}
.gs-field:focus{border-color:var(--blue2);box-shadow:0 0 0 3px rgba(79,126,248,.1)}
.preview-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:10px;max-height:220px;overflow-y:auto}
.preview-table{width:100%;border-collapse:collapse;font-size:11px}
.preview-table th{padding:7px 12px;background:#f8faff;border-bottom:1px solid var(--border);font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;white-space:nowrap;position:sticky;top:0}
.preview-table td{padding:7px 12px;border-bottom:1px solid #f8faff;white-space:nowrap}
.preview-table tr:hover td{background:#f8faff}
.map-row{display:grid;grid-template-columns:1fr 40px 1fr 80px;align-items:center;gap:10px;padding:10px 14px;background:#f8faff;border:1px solid var(--border);border-radius:10px;transition:.15s}
.map-row:hover{background:#eff6ff;border-color:#c7d2fe}
.map-row.mapped{background:#f0fdf4;border-color:#86efac}
.map-row.ignored{opacity:.45}
.map-dest{font-size:12px;font-weight:700;color:var(--text)}
.map-dest-sub{font-size:10px;color:var(--muted);margin-top:1px}
.map-arrow{font-size:16px;color:var(--muted);text-align:center}
.map-sel{width:100%;padding:6px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;color:var(--text);background:#fff;outline:none;cursor:pointer;transition:.15s}
.map-sel:focus{border-color:var(--blue2)}
.map-sel.has-val{border-color:var(--green);background:#f0fdf4}
.map-ignore{padding:4px 8px;border:1.5px solid var(--border);border-radius:6px;background:#fff;font-size:10px;font-weight:600;cursor:pointer;color:var(--muted);font-family:'Plus Jakarta Sans',sans-serif;transition:.15s}
.map-ignore:hover{background:#fef2f2;color:var(--red);border-color:#fecaca}
.map-ignore.active{background:#fef2f2;color:var(--red);border-color:#fecaca}
.auto-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700;background:#d1fae5;color:#065f46;margin-left:6px}
.import-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.is-box{background:#f8faff;border:1.5px solid var(--border);border-radius:10px;padding:14px;text-align:center}
.is-box.ok{background:#f0fdf4;border-color:#86efac}
.is-box.warn{background:#fffbeb;border-color:#fde68a}
.is-val{font-size:20px;font-weight:800;margin-bottom:3px}
.is-lbl{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase}
.progress-bar-wrap{background:#e2e8f0;border-radius:99px;height:8px;overflow:hidden;margin:10px 0}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--blue2));border-radius:99px;transition:width .5s ease}
.toast{position:fixed;bottom:18px;right:18px;padding:10px 16px;border-radius:9px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(60px);opacity:0;transition:.3s}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{background:#10b981;color:#fff}
.toast.err{background:#ef4444;color:#fff}
.toast.info{background:#1a3dce;color:#fff}
.panel{display:none}.panel.on{display:block}
.hidden{display:none}
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:#0f1f5c;border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(15,31,92,.45);-webkit-tap-highlight-color:transparent}
.hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;pointer-events:none}
.hamburger.open span:nth-child(1){transform:translateY(7.5px) rotate(45deg)}
.hamburger.open span:nth-child(2){opacity:0;transform:scaleX(0)}
.hamburger.open span:nth-child(3){transform:translateY(-7.5px) rotate(-45deg)}
.nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000}
.nav-overlay.show{display:block}
@media(max-width:768px){
  .hamburger{display:flex!important}
  nav{position:fixed!important;top:0!important;left:0!important;height:100vh!important;height:-webkit-fill-available!important;width:min(280px,84vw)!important;z-index:1001!important;transform:translateX(-105%)!important;transition:transform .3s cubic-bezier(.4,0,.2,1)!important;overflow-y:auto!important;-webkit-overflow-scrolling:touch!important;margin:0!important}
  nav.open{transform:translateX(0)!important;box-shadow:8px 0 32px rgba(0,0,0,.3)!important}
  main{margin-left:0!important;width:100vw!important;overflow-x:hidden!important}
  .topbar{padding:10px 10px 10px 62px!important;flex-wrap:wrap!important;gap:6px!important}
  .topbar h1{font-size:14px!important}
  .tb-r{width:100%!important;flex-wrap:wrap!important}
  .page{padding:12px 10px!important;overflow-x:hidden!important}
  .format-grid{grid-template-columns:1fr!important;gap:10px!important}
  .import-summary{grid-template-columns:1fr 1fr 1fr!important;gap:8px!important}
  .map-row{grid-template-columns:1fr 30px 1fr 60px!important;gap:6px!important}
  .steps{overflow-x:auto}
  .gs-input{flex-direction:column!important}
  .gs-field{width:100%}
}

/* â”€â”€ Multi-tab review screen â”€â”€ */
.review-panel{background:#fff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden;margin-top:16px}
.review-panel-header{padding:14px 18px;background:#f8fafc;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;gap:12px}
.review-panel-title{font-size:15px;font-weight:700;color:#1e293b}
.review-tab-row{padding:14px 18px;border-bottom:1px solid #f1f5f9;transition:background .15s}
.review-tab-row:last-child{border-bottom:none}
.review-tab-row.disabled{opacity:.45}
.review-tab-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.review-tab-name{font-size:13px;font-weight:700;color:#1e293b;flex:1}
.review-tab-toggle{width:36px;height:20px;border-radius:10px;border:none;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0}
.review-tab-toggle.on{background:#3b82f6}
.review-tab-toggle.off{background:#d1d5db}
.review-tab-toggle::after{content:'';position:absolute;top:3px;width:14px;height:14px;border-radius:50%;background:#fff;transition:left .2s}
.review-tab-toggle.on::after{left:19px}
.review-tab-toggle.off::after{left:3px}
.review-mapping-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px}
.review-field-row{background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px}
.review-field-label{font-size:11px;font-weight:600;color:#64748b;margin-bottom:4px;display:flex;align-items:center;gap:4px}
.review-field-label .req{color:#ef4444}
.review-field-sel{width:100%;font-size:12px;padding:4px 6px;border:1px solid #d1d5db;border-radius:6px;background:#fff;color:#1e293b}
.review-field-sel.mapped{border-color:#3b82f6;background:#eff6ff}
.review-module-sel{font-size:12px;padding:5px 8px;border:1px solid #d1d5db;border-radius:6px;background:#fff;color:#1e293b;font-weight:600}
.review-month-inp{font-size:12px;padding:5px 8px;border:1px solid #d1d5db;border-radius:6px;width:90px}
.review-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600}
.review-badge.mod{background:#eff6ff;color:#3b82f6}
.review-badge.month{background:#f0fdf4;color:#16a34a}
.review-badge.warn{background:#fff7ed;color:#ea580c}
.review-confirm-bar{padding:14px 18px;background:#f8fafc;border-top:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;gap:12px}
</style>
</head>
<body>
<button class="hamburger" id="hamburger" onclick="toggleSidebar()" aria-label="Menu">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="navOverlay" onclick="closeSidebar()"></div>
<nav>
  <div class="logo"><div class="logo-i">&#128202;</div><div class="logo-t">ALTEORE</div></div>
  <div class="ns">Principal</div>
  <div class="ni" onclick="location.href='dashboard.html'"><span>&#127968;</span><span>Tableau de bord</span></div>
  <div class="ni" onclick="location.href='suivi-ca.html'"><span>&#128200;</span><span>Suivi CA &amp; R&#233;sultats</span></div>
  <div class="ni" onclick="toggleNav('kpis-sub',this)"><span>&#127919;</span><span style="flex:1">KPIs Cl&#233;s</span><span class="chev" id="chev-kpis">&#x203A;</span></div>
  <div class="sub" id="kpis-sub">
    <div class="si" onclick="location.href='cout-revient.html'"><span class="dot"></span>Co&#251;t de revient</div>
    <div class="si" onclick="location.href='marges.html'"><span class="dot"></span>Marge brute &amp; nette</div>
    <div class="si" onclick="location.href='panier-moyen.html'"><span class="dot"></span>Panier moyen</div>
  </div>
  <div class="ni" onclick="toggleNav('pil-sub',this)"><span>&#129517;</span><span style="flex:1">Pilotage</span><span class="chev" id="chev-pil">&#x203A;</span></div>
  <div class="sub" id="pil-sub">
    <div class="si" onclick="location.href='pilotage.html?year=2025'"><span class="dot"></span>Pilotage 2025</div>
    <div class="si" onclick="location.href='pilotage.html?year=2026'"><span class="dot"></span>Pilotage 2026</div>
    <div class="si" onclick="location.href='pilotage.html?year=2027'"><span class="dot"></span>Pilotage 2027</div>
  </div>
  <div class="ni" onclick="location.href='dettes.html'"><span>&#127970;</span><span>Dettes &amp; Emprunts</span></div>
  <div class="ns">Intelligence IA</div>
  <div class="ni" onclick="location.href='bilan.html'"><span>&#129302;</span><span style="flex:1">Analyse de Bilan</span><span style="font-size:10px;font-weight:700;background:rgba(79,126,248,0.3);color:#a5b4fc;padding:2px 7px;border-radius:20px">IA</span></div>
  <div class="ns">Outils</div>
  <div class="ni on"><span>&#128229;</span><span>Import de donn&#233;es</span></div>
  <div class="nav-footer">
    <div class="ucard" onclick="location.href='profil.html'">
      <div class="uav" id="av">A</div>
      <div><div class="un" id="uname">Utilisateur</div><div class="upl">Plan gratuit</div></div>
      <button class="lbtn" onclick="event.stopPropagation();doLogout()">&#x238B;</button>
    </div>
  </div>
</nav>
<main>
  <div class="topbar">
    <div>
      <h1>&#128229; Import de donn&#233;es</h1>
      <p>Importez vos fichiers Excel, CSV ou Google Sheets et mappez les colonnes vers Alteore</p>
    </div>
    <div class="tb-r">
      <button class="btn btn-o btn-xs" onclick="location.href='dashboard.html'">&#8592; Dashboard</button>
    </div>
  </div>
  <div class="page">
    <div class="steps" id="stepsBar">
      <div class="step"><div class="step-num active" id="sn1">1</div><div class="step-label active" id="sl1">Format &amp; fichier</div></div>
      <div class="step-line" id="line1"></div>
      <div class="step"><div class="step-num" id="sn2">2</div><div class="step-label" id="sl2">Mapping colonnes</div></div>
      <div class="step-line" id="line2"></div>
      <div class="step"><div class="step-num" id="sn3">3</div><div class="step-label" id="sl3">V&#233;rification</div></div>
      <div class="step-line" id="line3"></div>
      <div class="step"><div class="step-num" id="sn4">4</div><div class="step-label" id="sl4">Import &#x2713;</div></div>
    </div>
    <div class="panel on" id="step1">
      <div class="card">
        <div class="card-head"><div class="card-title">&#128194; Choisissez votre format</div></div>
        <div class="card-body">
          <div class="format-grid">
            <div class="fmt-btn on" id="fmt-xlsx" onclick="selectFmt('xlsx')">
              <div class="fmt-badge">Recommand&#233;</div>
              <div class="fmt-icon">&#128202;</div><div class="fmt-name">Excel (.xlsx)</div>
              <div class="fmt-desc">Fichiers Microsoft Excel ou LibreOffice</div>
            </div>
            <div class="fmt-btn" id="fmt-csv" onclick="selectFmt('csv')">
              <div class="fmt-icon">&#128196;</div><div class="fmt-name">CSV (.csv)</div>
              <div class="fmt-desc">Fichiers texte s&#233;par&#233;s par virgule ou point-virgule</div>
            </div>
            <div class="fmt-btn" id="fmt-gsheets" onclick="selectFmt('gsheets')">
              <div class="fmt-icon">&#x1F7E2;</div><div class="fmt-name">Google Sheets</div>
              <div class="fmt-desc">Collez le lien de partage de votre feuille</div>
            </div>
          </div>
        </div>
      </div>
      <div class="card" id="uploadCard">
        <div class="card-head"><div class="card-title" id="uploadTitle">&#128202; Importer votre fichier Excel</div></div>
        <div class="card-body">
          <div id="dropArea">
            <div class="dropzone" id="dropzone" ondragover="ev(event,'drag',true)" ondragleave="ev(event,'drag',false)" ondrop="onDrop(event)">
              <div class="dropzone-icon" id="dzIcon">&#128202;</div>
              <div class="dropzone-title" id="dzTitle">Glissez votre fichier ici</div>
              <div class="dropzone-sub" id="dzSub">ou cliquez pour s&#233;lectionner</div>
              <button class="dropzone-btn" onclick="document.getElementById('fileInput').click()">&#128193; Choisir un fichier</button>
              <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="onFile(this.files[0])"/>
            </div>
          </div>
          <div id="gsArea" class="hidden">
            <div style="margin-bottom:12px;padding:10px 14px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;font-size:12px;color:#065f46">
              &#x2705; Partagez votre feuille en <strong>"Tout le monde avec le lien peut consulter"</strong><br>
              <span style="color:var(--muted);font-size:11px">Fichier &#8594; Partager &#8594; Obtenir le lien &#8594; "Tout le monde"</span>
            </div>
            <div id="gs-step-url">
              <div class="gs-input">
                <input class="gs-field" id="gsUrl" placeholder="https://docs.google.com/spreadsheets/d/..." />
                <button class="btn btn-p" id="gs-detect-btn" onclick="detectSheetTabs()">&#128269; D&#233;tecter les onglets</button>
              </div>
            </div>
            <div id="gs-step-tabs" style="display:none;margin-top:14px">
              <div id="gs-tabs-grid" style="margin-bottom:14px"></div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <button class="btn btn-p" id="gs-load-btn" onclick="loadSelectedTab()" style="display:none">&#128229; Charger les onglets</button>
                <button class="btn btn-o btn-xs" onclick="resetGsSteps()">&#8592; Changer de lien</button>
              </div>
            </div>
            <div id="gs-loading" style="display:none;margin-top:12px;font-size:12px;color:#6366f1;font-weight:600">
              &#x23F3; <span id="gs-loading-text">Chargement...</span>
            </div>
          </div>
        </div>
      </div>
      <div class="card hidden" id="previewCard">
        <div class="card-head">
          <div class="card-title">&#128065;&#65039; Aper&#231;u du fichier <span id="previewFilename" style="font-size:11px;color:var(--muted);font-weight:500;margin-left:8px"></span></div>
          <div style="display:flex;gap:8px;align-items:center">
            <span id="previewStats" style="font-size:11px;color:var(--muted)"></span>

            <button class="btn btn-o btn-xs" onclick="resetFile()">&#x2715; Changer</button>
          </div>
        </div>
        <div class="card-body" style="padding:0">
          <div id="sheetSelector" class="hidden" style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:16px;flex-wrap:wrap">
            <div style="display:flex;align-items:center;gap:8px">
              <span style="font-size:12px;font-weight:600">Feuille :</span>
              <select id="sheetSelect" class="map-sel" style="width:200px" onchange="selectSheet()"></select>
            </div>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <span style="font-size:12px;font-weight:600">Ligne d'en-tÃªte :</span>
              <input type="number" id="headerRowInput" value="1" min="1" max="20" style="width:50px;padding:5px 8px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-weight:700;text-align:center" onchange="applyHeaderRow()" title="Ligne des en-tÃªtes (1=premiÃ¨re ligne)"/>
              <span style="font-size:12px;font-weight:600;margin-left:4px">Colonnes :</span>
              <input type="number" id="colStartInput" value="1" min="1" placeholder="De" style="width:44px;padding:5px 6px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-weight:700;text-align:center" title="1Ã¨re colonne (1=A)" onchange="applyHeaderRow()"/>
              <span style="font-size:11px;color:var(--muted)">Ã </span>
              <input type="number" id="colEndInput" value="" min="1" placeholder="fin" style="width:44px;padding:5px 6px;border:1.5px solid var(--border);border-radius:7px;font-size:13px;font-weight:700;text-align:center" title="DerniÃ¨re colonne (vide=toutes)" onchange="applyHeaderRow()"/>
              <button class="btn btn-xs btn-outline" onclick="applyHeaderRow()" style="font-size:11px;padding:4px 10px">â†º Appliquer</button>
            </div>
          </div>
          <div class="preview-wrap"><table class="preview-table" id="previewTable"></table></div>
        </div>
        <div style="padding:14px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end">
          <button class="btn btn-p" onclick="goStep(2)">Suivant &#8594; Mapper les colonnes</button>
        </div>
      </div>
    </div>
    <div class="panel" id="step2">
      <div class="card">
        <div class="card-head">
          <div class="card-title">&#128506;&#65039; Mapper les colonnes</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-o btn-xs" onclick="autoDetect()">&#x2728; D&#233;tection auto</button>
            <button class="btn btn-o btn-xs" onclick="goStep(1)">&#8592; Retour</button>
          </div>
        </div>
        <div class="card-body">
          <div style="margin-bottom:16px">
            <div style="font-size:12px;font-weight:700;margin-bottom:8px">&#128205; O&#249; importer ces donn&#233;es ?</div>
            <div style="margin-bottom:6px">
              <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px">ðŸ“Š Pilotage mensuel</div>
              <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px">
                <button class="btn btn-xs" id="dest-pilotage_ca" onclick="setDest('pilotage_ca',this)" style="border:2px solid var(--blue);background:#eff6ff;color:var(--blue);font-weight:700">ðŸ“ˆ Pilotage â€” CA journalier</button>
                <button class="btn btn-xs" id="dest-pilotage_chargesFixe" onclick="setDest('pilotage_chargesFixe',this)" style="border:2px solid var(--border)">ðŸ“‹ Pilotage â€” Charges fixes</button>
                <button class="btn btn-xs" id="dest-pilotage_chargesVar" onclick="setDest('pilotage_chargesVar',this)" style="border:2px solid var(--border)">ðŸ“‹ Pilotage â€” Charges variables</button>
              </div>
              <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px">Autres modules</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-xs" id="dest-ca" onclick="setDest('ca',this)" style="border:2px solid var(--border)">&#128200; CA journalier</button>
              <button class="btn btn-xs" id="dest-charges" onclick="setDest('charges',this)" style="border:2px solid var(--border)">&#128184; Charges</button>
              <button class="btn btn-xs" id="dest-dettes" onclick="setDest('dettes',this)" style="border:2px solid var(--border)">&#127970; Dettes</button>
              <button class="btn btn-xs" id="dest-stock" onclick="setDest('stock',this)" style="border:2px solid var(--border)">&#128230; Stock produits</button>
              <button class="btn btn-xs" id="dest-mouvements" onclick="setDest('mouvements',this)" style="border:2px solid var(--border)">&#128260; Mouvements stock</button>
              <button class="btn btn-xs" id="dest-fidelite" onclick="setDest('fidelite',this)" style="border:2px solid var(--border)">&#127873; Clients fid&#233;lit&#233;</button>
              <button class="btn btn-xs" id="dest-marges" onclick="setDest('marges',this)" style="border:2px solid var(--border)">&#128202; Marges / Co&#251;t de revient</button>
            </div>
          </div>
          <div id="ai-analysis-block" style="display:none;margin-bottom:14px;padding:12px 16px;border-radius:12px;border:2px solid #a5b4fc;background:#f5f3ff">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
              <span style="font-size:18px">&#129302;</span>
              <div>
                <div style="font-size:12px;font-weight:700;color:#4338ca" id="ai-module-label">Analyse IA</div>
                <div style="font-size:11px;color:#6b7280" id="ai-reason-label"></div>
              </div>
              <div style="margin-left:auto"><span id="ai-confidence-badge" style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:99px;background:#e0e7ff;color:#4338ca"></span></div>
            </div>
            <div style="font-size:11px;color:#4338ca;font-style:italic" id="ai-mapping-applied"></div>
          </div>
          <div id="ai-loading-block" style="display:none;padding:10px 14px;background:#f5f3ff;border-radius:10px;font-size:12px;color:#6366f1;font-weight:600;margin-bottom:14px">&#129302; Analyse IA en cours...</div>
          <div style="display:grid;grid-template-columns:1fr 40px 1fr 80px;gap:10px;padding:8px 14px;background:#f1f5f9;border-radius:8px;margin-bottom:10px;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">
            <div>Champ Alteore</div><div></div><div>Colonne de votre fichier</div><div>Action</div>
          </div>
          <div id="mappingRows"></div>
          <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
            <button class="btn btn-o" onclick="goStep(1)">&#8592; Retour</button>
            <button class="btn btn-p" onclick="goStep(3)">V&#233;rifier &#8594; Pr&#233;visualiser l'import</button>
          </div>
        </div>
      </div>
    </div>
    <div class="panel" id="step3">
      <div class="card">
        <div class="card-head">
          <div class="card-title">&#x2705; V&#233;rification avant import</div>
          <button class="btn btn-o btn-xs" onclick="goStep(2)">&#8592; Retour</button>
        </div>
        <div class="card-body">
          <div class="import-summary" id="importSummary"></div>
          <div id="verifyTable"></div>
          <div style="margin-top:16px;padding:12px 14px;background:#fffbeb;border:1px solid #fde68a;border-radius:10px;font-size:12px;color:#92400e" id="warningBox"></div>
          <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
            <button class="btn btn-o" onclick="goStep(2)">&#8592; Modifier</button>
            <button class="btn btn-p" id="importBtn" onclick="doImport()">&#128640; Importer les donn&#233;es</button>
          </div>
        </div>
      </div>
    </div>
    <div class="panel" id="step4">
      <div class="card" style="text-align:center;padding:40px 20px">
        <div style="font-size:56px;margin-bottom:16px">&#127881;</div>
        <div style="font-size:20px;font-weight:800;margin-bottom:8px;color:var(--green)">Import r&#233;ussi !</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:24px" id="successMsg"></div>
        <div class="progress-bar-wrap" style="max-width:400px;margin:0 auto 24px">
          <div class="progress-bar-fill" id="successBar" style="width:0%"></div>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
          <button class="btn btn-p" onclick="location.href='dashboard.html'">&#127968; Voir le dashboard</button>
          <button class="btn btn-o" onclick="location.href='suivi-ca.html'">&#128200; Voir le CA</button>
          <button class="btn btn-o" onclick="resetAll()">&#128229; Nouvel import</button>
        </div>
      </div>
    </div>
  </div>
</main>
<div class="toast" id="toast"></div>

<script>
// â”€â”€ DÃ‰FINITION DES CHAMPS PAR DESTINATION â”€â”€
const DEST_FIELDS = {
  pilotage_ca: [
    {key:'date',      label:'Date',               sub:'JJ/MM/AAAA',              required:true,  hint:['date','jour','day','timestamp','datetime']},
    {key:'ht055',     label:'CA HT 5,5%',         sub:'Ventes taux rÃ©duit',      required:false, hint:['5.5','5,5','ht055','ht5','taux rÃ©duit','alimentaire']},
    {key:'ht10',      label:'CA HT 10%',          sub:'Ventes taux intermÃ©diaire',required:false, hint:['10','ht10','taux intermediaire','restauration']},
    {key:'ht20',      label:'CA HT 20%',          sub:'Ventes taux normal',      required:false, hint:['20','ht20','taux normal','standard','montant','ca','ventes','recettes','total']},
    {key:'montantHT', label:'CA HT Total',        sub:'Si pas de multi-TVA',     required:false, hint:['ca ht','total ht','chiffre']},
  ],
  pilotage_chargesFixe: [
    {key:'fournisseur',label:'Fournisseur',       sub:'Nom du fournisseur',      required:true,  hint:['fournisseur','supplier','vendor','nom','libellÃ©','description','charge']},
    {key:'type',       label:'Type / CatÃ©gorie',  sub:'Ex: Loyer, Assuranceâ€¦',   required:false, hint:['type','catÃ©gorie','nature','libellÃ©']},
    {key:'montantHT',  label:'Montant HT (â‚¬)',    sub:'Montant hors taxe',       required:true,  hint:['montant','amount','ht','prix','coÃ»t','valeur']},
    {key:'tvaRate',    label:'Taux TVA (%)',       sub:'5.5, 10 ou 20',          required:false, hint:['tva','taux','rate','taxe']},
    {key:'deductible', label:'DÃ©ductible',        sub:'Oui ou Non',              required:false, hint:['deductible','dÃ©ductible']},
  ],
  pilotage_chargesVar: [
    {key:'fournisseur',label:'Fournisseur',       sub:'Nom du fournisseur',      required:true,  hint:['fournisseur','supplier','vendor','nom','libellÃ©','description','charge']},
    {key:'type',       label:'Type / CatÃ©gorie',  sub:'Ex: Marchandises, Emballagesâ€¦', required:false, hint:['type','catÃ©gorie','nature','libellÃ©']},
    {key:'montantHT',  label:'Montant HT (â‚¬)',    sub:'Montant hors taxe',       required:true,  hint:['montant','amount','ht','prix','coÃ»t','valeur']},
    {key:'tvaRate',    label:'Taux TVA (%)',       sub:'5.5, 10 ou 20',          required:false, hint:['tva','taux','rate','taxe']},
    {key:'deductible', label:'DÃ©ductible',        sub:'Oui ou Non',              required:false, hint:['deductible','dÃ©ductible']},
  ],
  ca: [
    {key:'date',      label:'Date',               sub:'JJ/MM/AAAA ou timestamp', required:true,  hint:['date','jour','day','timestamp','datetime']},
    {key:'ht055',     label:'CA HT 5,5%',         sub:'Ventes taux rÃ©duit',      required:false, hint:['5.5','5,5','ht055','ht5','taux rÃ©duit','alimentaire']},
    {key:'ht10',      label:'CA HT 10%',          sub:'Ventes taux intermÃ©diaire',required:false, hint:['10','ht10','taux intermediaire','restauration']},
    {key:'ht20',      label:'CA HT 20%',          sub:'Ventes taux normal',      required:false, hint:['20','ht20','taux normal','standard']},
    {key:'montantHT', label:'CA HT Total',        sub:'Si pas de multi-TVA',     required:false, hint:['ca','ca ht','montant','ht','total ht','chiffre','ventes','recettes','revenu','total']},
  ],
  charges: [
    {key:'fournisseur',label:'Fournisseur',       sub:'Nom du fournisseur',      required:true,  hint:['fournisseur','supplier','vendor','nom','libellÃ©','description','charge']},
    {key:'type',       label:'Type',              sub:'Fixe ou Variable',        required:false, hint:['type','catÃ©gorie','nature','fixe','variable']},
    {key:'montantHT',  label:'Montant HT (â‚¬)',    sub:'Montant hors taxe',       required:true,  hint:['montant','amount','ht','prix','coÃ»t','valeur']},
    {key:'tvaRate',    label:'Taux TVA (%)',       sub:'5.5, 10 ou 20',          required:false, hint:['tva','taux','rate','taxe']},
  ],
  dettes: [
    {key:'nom',      label:'Nom / Description',   sub:'IntitulÃ© de la dette',    required:true,  hint:['nom','libellÃ©','description','objet','dette']},
    {key:'montant',  label:'Montant initial (â‚¬)', sub:'Capital empruntÃ©',        required:true,  hint:['montant','capital','principal','amount']},
    {key:'taux',     label:'Taux (%)',            sub:"Taux d'intÃ©rÃªt annuel",   required:false, hint:['taux','rate','intÃ©rÃªt']},
    {key:'duree',    label:'DurÃ©e (mois)',         sub:'DurÃ©e de remboursement', required:false, hint:['durÃ©e','duree','mois','months','terme']},
    {key:'debut',    label:'Date de dÃ©but',       sub:'Date de dÃ©part',          required:false, hint:['dÃ©but','date','start','origine']},
    {key:'type',     label:'Type',                sub:'emprunt/fournisseur/leasing',required:false,hint:['type','nature','catÃ©gorie']},
  ],
  stock: [
    {key:'ref',         label:'RÃ©fÃ©rence (SKU)',    sub:'Code produit unique',   required:true,  hint:['ref','sku','rÃ©fÃ©rence','reference','code','article','id','codeart']},
    {key:'name',        label:'Nom du produit',     sub:'DÃ©signation',           required:true,  hint:['nom','name','produit','dÃ©signation','designation','libellÃ©','description']},
    {key:'cat',         label:'CatÃ©gorie',          sub:'Famille / rayon',       required:false, hint:['cat','categorie','catÃ©gorie','famille','rayon','type','gamme']},
    {key:'fournisseur', label:'Fournisseur',        sub:'Nom du fournisseur',    required:false, hint:['fournisseur','supplier','vendor','fourn','frs']},
    {key:'pa',          label:'Prix achat HT (PA)', sub:"CoÃ»t d'achat",         required:false, hint:['pa','pa ht','puht','pu ht','prix achat','achat','cout','cost']},
    {key:'pv',          label:'Prix vente HT (PV)', sub:'Tarif de vente',       required:false, hint:['pv','pv ht','pvht','prix vente','vente','tarif','price']},
    {key:'stockBase',   label:'Stock initial (qtÃ©)',sub:'QuantitÃ© en stock',     required:false, hint:['stock','qte','qtÃ©','quantite','quantitÃ©','qty','inventory']},
    {key:'min',         label:'Seuil alerte',       sub:'Stock minimum',         required:false, hint:['min','seuil','alerte','stock min','minimum','reorder']},
    {key:'unite',       label:'UnitÃ©',              sub:'unitÃ©, kg, L...',       required:false, hint:['unite','unitÃ©','unit','um','conditionnement']},
    {key:'notes',       label:'Notes',              sub:'Commentaires',          required:false, hint:['notes','note','commentaire','obs','remarque']},
  ],
  mouvements: [
    {key:'date',  label:'Date',              sub:'JJ/MM/AAAA',            required:true,  hint:['date','jour','day','timestamp']},
    {key:'type',  label:'Type',              sub:'entrÃ©e ou sortie',      required:true,  hint:['type','mouvement','sens','direction','in','out','entrÃ©e','sortie']},
    {key:'ref',   label:'RÃ©fÃ©rence (SKU)',   sub:'RÃ©f. du produit',       required:true,  hint:['ref','sku','rÃ©fÃ©rence','code','article']},
    {key:'qty',   label:'QuantitÃ©',          sub:'Nombre de piÃ¨ces',      required:true,  hint:['qte','qtÃ©','quantite','quantitÃ©','qty','nb','nombre','quantity']},
    {key:'note',  label:'Commentaire',       sub:'Motif du mouvement',    required:false, hint:['note','commentaire','obs','motif','raison','reason']},
  ],
  fidelite: [
    {key:'prenom',        label:'PrÃ©nom',           sub:'PrÃ©nom du client',      required:false, hint:['prenom','prÃ©nom','first','firstname']},
    {key:'nom',           label:'Nom',              sub:'Nom de famille',        required:false, hint:['nom','name','lastname','famille']},
    {key:'email',         label:'Email',            sub:'Adresse email',         required:false, hint:['email','mail','courriel','e-mail']},
    {key:'telephone',     label:'TÃ©lÃ©phone',        sub:'NÂ° de tÃ©lÃ©phone',      required:false, hint:['telephone','tÃ©lÃ©phone','tel','phone','mobile','portable']},
    {key:'points',        label:'Points fidÃ©litÃ©',  sub:'Solde de points',      required:false, hint:['points','point','solde','score','fidelite','fidÃ©litÃ©']},
    {key:'dateInscription',label:'Date inscription',sub:'Date de crÃ©ation',     required:false, hint:['date','inscription','crÃ©ation','creation','since','depuis']},
  ],
  marges: [
    {key:'nom',         label:'Nom / Produit',      sub:'DÃ©signation',           required:true,  hint:['nom','name','produit','dÃ©signation','libellÃ©']},
    {key:'prixVente',   label:'Prix de vente HT',   sub:'Tarif HT',              required:false, hint:['pv','prix vente','vente','tarif','pvht','price']},
    {key:'coutMP',      label:'CoÃ»t matiÃ¨res premiÃ¨res',sub:'IngrÃ©dients / MP',  required:false, hint:['mp','matiÃ¨res','ingredient','cout matiere','coutmp','raw']},
    {key:'coutMain',    label:"CoÃ»t main d'oeuvre", sub:'Salaires directs',      required:false, hint:['main','oeuvre','salaire','labour','labor','mdo']},
    {key:'coutIndirect',label:'Charges indirectes', sub:'Frais gÃ©nÃ©raux',        required:false, hint:['indirect','frais','gÃ©nÃ©ral','overhead','fixe']},
    {key:'tvaRate',     label:'Taux TVA (%)',        sub:'5.5, 10 ou 20',        required:false, hint:['tva','taux','rate','taxe']},
  ],
};

// â”€â”€ Ã‰TAT GLOBAL â”€â”€
let _wb=null, _headers=[], _rows=[], _mapping={}, _ignored=new Set(), _dest='ca', _fmt='xlsx', _currentStep=1, _gsRawData=null, _gsLastUrl=null, _gsLastGid=null, _gsLastName=null;

// â”€â”€ NAVIGATION SIDEBAR â”€â”€
function toggleNav(id,el){document.getElementById(id).classList.toggle('open');el.classList.toggle('on')}
async function doLogout(){try{if(window._signOut&&window._auth)await window._signOut(window._auth)}catch(e){}location.href='index.html'}
function toggleSidebar(){var n=document.querySelector('nav'),b=document.getElementById('hamburger'),o=document.getElementById('navOverlay');n.classList.toggle('open');b.classList.toggle('open');o.classList.toggle('show');document.body.style.overflow=n.classList.contains('open')?'hidden':''}
function closeSidebar(){var n=document.querySelector('nav'),b=document.getElementById('hamburger'),o=document.getElementById('navOverlay');n.classList.remove('open');b.classList.remove('open');o.classList.remove('show');document.body.style.overflow=''}

// â”€â”€ UTILS â”€â”€
function showToast(msg,type){var t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(()=>t.className='toast',3000)}
function pf(v){return parseFloat(String(v||0).replace(',','.'))||0}
function uid(){return Date.now()+'_'+Math.random().toString(36).slice(2,8)}

// â”€â”€ Ã‰TAPES â”€â”€
function goStep(n){
  if(n===2&&!_rows.length){showToast("Chargez d'abord un fichier",'err');return}
  if(n===3){buildVerify();if(!validateMapping())return}
  _currentStep=n;
  for(let i=1;i<=4;i++){
    document.getElementById('step'+i).className='panel'+(i===n?' on':'');
    const sn=document.getElementById('sn'+i), sl=document.getElementById('sl'+i);
    if(i<n){sn.className='step-num done';sl.className='step-label done'}
    else if(i===n){sn.className='step-num active';sl.className='step-label active'}
    else{sn.className='step-num';sl.className='step-label'}
    if(i<4){const l=document.getElementById('line'+i);l.className='step-line'+(i<n?' done':'')}
  }
  if(n===2) buildMapping();
  window.scrollTo({top:0,behavior:'smooth'});
}

// â”€â”€ FORMAT â”€â”€
function selectFmt(f){
  _fmt=f;
  ['xlsx','csv','gsheets'].forEach(k=>{document.getElementById('fmt-'+k).classList.toggle('on',k===f)});
  document.getElementById('dropArea').classList.toggle('hidden',f==='gsheets');
  document.getElementById('gsArea').classList.toggle('hidden',f!=='gsheets');
  const icons={'xlsx':'ðŸ“Š','csv':'ðŸ“„','gsheets':'ðŸŸ¢'};
  const titles={'xlsx':'Importer votre fichier Excel','csv':'Importer votre fichier CSV','gsheets':'Charger depuis Google Sheets'};
  document.getElementById('uploadTitle').textContent=titles[f];
  document.getElementById('dzIcon').textContent=icons[f]||'ðŸ“';
  document.getElementById('fileInput').accept=f==='csv'?'.csv':'.xlsx,.xls';
}

// â”€â”€ DROP ZONE â”€â”€
function ev(e,cls,add){e.preventDefault();document.getElementById('dropzone').classList.toggle(cls,add)}
function onDrop(e){e.preventDefault();document.getElementById('dropzone').classList.remove('drag');const f=e.dataTransfer.files[0];if(f)onFile(f)}

// â”€â”€ LECTURE FICHIER â”€â”€
function onFile(file){
  if(!file)return;
  const ext=file.name.split('.').pop().toLowerCase();
  if(ext==='csv'||_fmt==='csv'){readCSV(file)}
  else{readXLSX(file)}
}
function readXLSX(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      _wb=XLSX.read(e.target.result,{type:'binary'});
      const sheets=_wb.SheetNames;
      const sel=document.getElementById('sheetSelect');
      sel.innerHTML=sheets.map((s,i)=>`<option value="${i}">${s}</option>`).join('');
      document.getElementById('sheetSelector').classList.toggle('hidden',sheets.length<=1);
      parseSheet(0,file.name);
    }catch(err){showToast('Erreur lecture Excel','err')}
  };
  reader.readAsBinaryString(file);
}
function getColRange(){
  const start = Math.max(1, parseInt(document.getElementById('colStartInput')?.value)||1) - 1;
  const endVal = document.getElementById('colEndInput')?.value;
  const end = endVal ? Math.max(start+1, parseInt(endVal)) : null;
  return {start, end};
}

function applyColFilter(headers, rows){
  const {start, end} = getColRange();
  if(start === 0 && !end) return {headers, rows}; // pas de filtre
  const filteredH = end ? headers.slice(start, end) : headers.slice(start);
  // Filtrer les en-tÃªtes vides
  const validH = filteredH.filter(h=>h && h.trim());
  const filteredR = rows.map(r=>{
    const obj={};
    validH.forEach(h=>{ obj[h] = r[h]??''; });
    return obj;
  }).filter(r=>Object.values(r).some(v=>String(v).trim()));
  return {headers: validH, rows: filteredR};
}

async function applyHeaderRow(){
  const btn = document.querySelector('[onclick="applyHeaderRow()"]');
  if(btn){btn.textContent='â³';btn.disabled=true;}
  try{
    if(_wb){
      const idx = parseInt(document.getElementById('sheetSelect')?.value)||0;
      parseSheet(idx, '');
    } else if(_gsLastUrl) {
      const headerRow = Math.max(1, parseInt(document.getElementById('headerRowInput')?.value)||1);
      const r = await fetch('/api/fetch-sheet', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({url:_gsLastUrl, gid:_gsLastGid, analyze:false, headerRow})
      });
      const data = await r.json();
      if(!r.ok||!data.success) throw new Error(data.error||'Erreur');
      // Appliquer le filtre de colonnes
      const filtered = applyColFilter(data.headers, data.rows);
      _headers = filtered.headers;
      _rows = filtered.rows;
      showPreview('Google Sheets â€” ' + (_gsLastName||''));
    }
  }catch(e){ showToast('Erreur : '+e.message,'err'); }
  finally{ if(btn){btn.textContent='â†º Appliquer';btn.disabled=false;} }
}

function selectSheet(){const idx=parseInt(document.getElementById('sheetSelect').value);parseSheet(idx,'')}
function parseSheet(idx,filename){
  const ws=_wb.Sheets[_wb.SheetNames[idx]];
  const data=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
  if(!data.length){showToast('Feuille vide','err');return}
  // Ligne d'en-tÃªte configurable (1-based)
  const headerRowNum = Math.max(1, parseInt(document.getElementById('headerRowInput')?.value)||1);
  const headerRowIdx = headerRowNum - 1;
  // Construire les headers en combinant plusieurs lignes si besoin (ignore lignes vides avant)
  const rawHeaders = data[headerRowIdx] || data[0];
  let allHeaders = rawHeaders.map(h=>String(h).trim());
  const allRows = data.slice(headerRowIdx+1).filter(r=>r.some(c=>c!==''&&c!==0)).map(r=>{
    const obj={};
    allHeaders.forEach((h,i)=>obj[h]=r[i]===undefined?'':r[i]);
    return obj;
  });
  // Appliquer filtre colonnes
  const {start, end} = getColRange();
  const slicedH = end ? allHeaders.slice(start,end) : allHeaders.slice(start);
  _headers = slicedH.filter(h=>h);
  _rows = allRows.map(r=>{const o={};_headers.forEach(h=>o[h]=r[h]??'');return o;}).filter(r=>Object.values(r).some(v=>String(v).trim()));
  showPreview(filename||_wb.SheetNames[idx]||'');
}
function readCSV(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const text=e.target.result;
      const sep=text.indexOf(';')>text.indexOf(',')?';':',';
      const lines=text.trim().split('\n');
      _headers=lines[0].split(sep).map(h=>h.trim().replace(/^"|"$/g,''));
      _rows=lines.slice(1).filter(l=>l.trim()).map(l=>{
        const vals=l.split(sep).map(v=>v.trim().replace(/^"|"$/g,''));
        const obj={};_headers.forEach((h,i)=>obj[h]=vals[i]||'');return obj;
      });
      showPreview(file.name);
    }catch(err){showToast('Erreur lecture CSV','err')}
  };
  reader.readAsText(file,'UTF-8');
}

var _gsSelectedTabs = new Set(); // { gid -> { gid, name } }
var _gsTabsData = {};            // gid -> { gid, name }
var _gsSheetUrl = '';            // URL courante

// â”€â”€ DÃ©tecter le mois/annÃ©e depuis le nom de l'onglet â”€â”€
// Ex: "Mai 2026" â†’ "2026-05", "Juin 2026" â†’ "2026-06", "2025-08" â†’ "2025-08"
function detectMonthFromTabName(name) {
  const s = String(name || '').trim();
  const MOIS = {
    'janvier':'01','jan':'01','january':'01',
    'fÃ©vrier':'02','fevrier':'02','feb':'02','february':'02',
    'mars':'03','mar':'03','march':'03',
    'avril':'04','apr':'04','april':'04',
    'mai':'05','may':'05',
    'juin':'06','jun':'06','june':'06',
    'juillet':'07','jul':'07','july':'07',
    'aoÃ»t':'08','aout':'08','aug':'08','august':'08',
    'septembre':'09','sep':'09','sept':'09','september':'09',
    'octobre':'10','oct':'10','october':'10',
    'novembre':'11','nov':'11','november':'11',
    'dÃ©cembre':'12','decembre':'12','dec':'12','december':'12',
  };

  // Format "Mois AAAA" ou "Mois AAAA - ..."
  const mMatch = s.match(/([a-zÃ©Ã»Ã´Ã Ã¨Ã¹Ã¢Ãª]+)\s+(\d{4})/i);
  if (mMatch) {
    const key = mMatch[1].toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const year = mMatch[2];
    // Chercher dans MOIS avec/sans accents
    const monthNum = MOIS[mMatch[1].toLowerCase()] || MOIS[key];
    if (monthNum) return `${year}-${monthNum}`;
  }

  // Format AAAA-MM
  const ym = s.match(/(\d{4})[-\/](\d{2})/);
  if (ym) return `${ym[1]}-${ym[2]}`;

  // Format MM/AAAA
  const my = s.match(/(\d{2})\/(\d{4})/);
  if (my) return `${my[2]}-${my[1]}`;

  return null; // Pas dÃ©tectÃ©
}

// â”€â”€ Rendre la grille d'onglets avec checkboxes â”€â”€
function renderTabsGrid(tabs) {
  const grid = document.getElementById('gs-tabs-grid');
  _gsSelectedTabs.clear();
  _gsTabsData = {};
  tabs.forEach(t => { _gsTabsData[t.gid] = t; });

  document.getElementById('gs-load-btn').style.display = 'none';

  grid.innerHTML = `
    <div style="margin-bottom:10px;font-size:11px;color:var(--muted)">
      Cochez les onglets Ã  importer â€” l'IA dÃ©tectera automatiquement le module et le mois/annÃ©e.
    </div>
    <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
      <button class="btn btn-xs btn-o" onclick="gsSelectAll()">âœ… Tout sÃ©lectionner</button>
      <button class="btn btn-xs btn-o" onclick="gsDeselectAll()">â˜ Tout dÃ©sÃ©lectionner</button>
    </div>
    <div id="gs-tabs-list" style="display:flex;flex-direction:column;gap:6px">
      ${tabs.map(t => {
        const month = detectMonthFromTabName(t.name);
        const monthBadge = month
          ? `<span style="font-size:10px;font-weight:700;background:#dbeafe;color:#1d4ed8;padding:2px 7px;border-radius:99px;margin-left:6px">${month}</span>`
          : `<span style="font-size:10px;color:var(--muted);margin-left:6px">mois non dÃ©tectÃ©</span>`;
        return `
          <label style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:#f8faff;border:2px solid var(--border);border-radius:10px;cursor:pointer;transition:.15s" 
                 id="gstab-label-${t.gid}"
                 onmouseenter="this.style.borderColor='#93c5fd'"
                 onmouseleave="if(!document.getElementById('gstab-${t.gid}').checked)this.style.borderColor='var(--border)'">
            <input type="checkbox" id="gstab-${t.gid}" value="${t.gid}" 
                   onchange="onGsTabToggle('${t.gid}')"
                   style="width:16px;height:16px;cursor:pointer;accent-color:var(--blue)">
            <span style="font-size:13px">ðŸ“„</span>
            <span style="font-size:13px;font-weight:600;flex:1">${t.name}</span>
            ${monthBadge}
          </label>`;
      }).join('')}
    </div>`;
}

function onGsTabToggle(gid) {
  const cb = document.getElementById('gstab-' + gid);
  const label = document.getElementById('gstab-label-' + gid);
  if (cb.checked) {
    _gsSelectedTabs.add(gid);
    label.style.borderColor = 'var(--blue)';
    label.style.background = '#eff6ff';
  } else {
    _gsSelectedTabs.delete(gid);
    label.style.borderColor = 'var(--border)';
    label.style.background = '#f8faff';
  }
  const count = _gsSelectedTabs.size;
  const btn = document.getElementById('gs-load-btn');
  if (count > 0) {
    btn.style.display = '';
    btn.textContent = count === 1
      ? `ðŸ“¥ Charger 1 onglet`
      : `ðŸ“¥ Charger ${count} onglets`;
  } else {
    btn.style.display = 'none';
  }
}

function gsSelectAll() {
  Object.keys(_gsTabsData).forEach(gid => {
    const cb = document.getElementById('gstab-' + gid);
    if (cb) { cb.checked = true; onGsTabToggle(gid); }
  });
}

function gsDeselectAll() {
  Object.keys(_gsTabsData).forEach(gid => {
    const cb = document.getElementById('gstab-' + gid);
    if (cb) { cb.checked = false; onGsTabToggle(gid); }
  });
}

// â”€â”€ Charger tous les onglets sÃ©lectionnÃ©s en sÃ©quence â”€â”€
async function loadSelectedTab() {
  if (_gsSelectedTabs.size === 0) { showToast('SÃ©lectionnez au moins un onglet', 'err'); return; }

  const url = document.getElementById('gsUrl').value.trim();
  const btn = document.getElementById('gs-load-btn');
  btn.disabled = true;

  const gids = [..._gsSelectedTabs];
  const total = gids.length;

  // Si un seul onglet â†’ comportement classique (mapping manuel)
  if (total === 1) {
    const { gid, name } = _gsTabsData[gids[0]];
    btn.textContent = 'â³ Chargement...';
    gsLoading('Chargement de l\'onglet : ' + name);
    try {
      const r = await fetch('/api/fetch-sheet', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url, gid, analyze: true, headerRow: Math.max(1, parseInt(document.getElementById('headerRowInput')?.value)||1) })
      });
      const data = await r.json();
      if (!r.ok || !data.success) throw new Error(data.error || 'Erreur serveur');
      // Appliquer la ligne d'en-tÃªte configurÃ©e
      const gsHeaderRow = Math.max(1, parseInt(document.getElementById('headerRowInput')?.value)||1) - 1;
      if(gsHeaderRow > 0 && data.allRows) {
        // Si l'API renvoie allRows, recalculer depuis la bonne ligne
        const rawH = data.allRows[gsHeaderRow] || data.allRows[0];
        _headers = rawH.map(h=>String(h).trim()).filter(h=>h);
        _rows = data.allRows.slice(gsHeaderRow+1).filter(r=>Object.values(r).some(c=>c!==''&&c!==null)).map(r=>{
          const obj={};_headers.forEach((h,i)=>obj[h]=Array.isArray(r)?r[i]:r[h]);return obj;
        });
      } else {
        _headers = data.headers;
        _rows = data.rows;
      }
      showPreview('Google Sheets â€” ' + name);
      if (data.aiAnalysis) applyAiAnalysis(data.aiAnalysis);
    } catch (e) {
      showToast('Erreur : ' + e.message, 'err');
    } finally {
      btn.textContent = 'ðŸ“¥ Charger 1 onglet';
      btn.disabled = false;
      gsLoading(null);
    }
    return;
  }

  // â”€â”€ Multi-onglets : analyse IA puis Ã©cran de review â”€â”€
  const area = document.getElementById('gsArea');
  
  // Panneau d'analyse en cours
  area.innerHTML = `
    <div style="padding:24px;text-align:center;color:#64748b">
      <div style="font-size:28px;margin-bottom:12px">ðŸ”</div>
      <div style="font-weight:700;font-size:15px;color:#1e293b;margin-bottom:6px">Analyse en coursâ€¦</div>
      <div id="review-analysis-status" style="font-size:13px">RÃ©cupÃ©ration des donnÃ©es IAâ€¦</div>
      <div style="margin-top:16px;height:4px;background:#e5e7eb;border-radius:2px;overflow:hidden">
        <div id="review-analysis-bar" style="height:100%;background:#3b82f6;border-radius:2px;width:0%;transition:width .3s"></div>
      </div>
    </div>`;

  const MODULE_MAP = {
    'pilotage_ca':'pilotage_ca','pilotage_charges':'pilotage_chargesFixe',
    'pilotage_charges_fixe':'pilotage_chargesFixe','pilotage_charges_var':'pilotage_chargesVar',
    'ca':'ca','charges':'charges','stock':'stock',
    'dettes':'dettes','fidelite_clients':'fidelite','mouvements_stock':'mouvements','marges':'marges'
  };
  const MODULE_LABELS = {
    pilotage_ca:'ðŸ“ˆ Pilotage â€” CA journalier', pilotage_chargesFixe:'ðŸ“‹ Pilotage â€” Charges fixes', pilotage_chargesVar:'ðŸ“‹ Pilotage â€” Charges variables',
    ca:'ðŸ“ˆ CA & Ventes', charges:'ðŸ’¸ Charges', dettes:'ðŸ¦ Dettes/Emprunts',
    stock:'ðŸ“¦ Stock', mouvements:'ðŸ”„ Mouvements stock', fidelite:'â¤ï¸ FidÃ©litÃ© clients', marges:'ðŸ“Š Marges produits'
  };

  // Analyser tous les onglets en parallÃ¨le
  const analysisData = {};
  let done = 0;
  await Promise.all(gids.map(async gid => {
    const tab = _gsTabsData[gid];
    try {
      const r = await fetch('/api/fetch-sheet', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({url, gid, analyze:true})
      });
      const data = await r.json();
      if(!r.ok || !data.success) throw new Error(data.error||'Erreur');
      const ai = data.aiAnalysis;
      const destKey = ai ? (MODULE_MAP[ai.module]||ai.module) : null;
      const detectedMonth = detectMonthFromTabName(tab.name);
      const localMapping = {};
      if(ai && ai.mapping){
        Object.entries(ai.mapping).forEach(([k,v])=>{
          if(v && data.headers.includes(v)) localMapping[k]=v;
        });
      }
      analysisData[gid] = {tab, data, destKey, detectedMonth, mapping:localMapping, enabled:true, error:null};
    } catch(e) {
      analysisData[gid] = {tab, data:null, destKey:null, detectedMonth:null, mapping:{}, enabled:false, error:e.message};
    }
    done++;
    document.getElementById('review-analysis-status').textContent = `Analyse de "${tab.name}"â€¦ (${done}/${total})`;
    document.getElementById('review-analysis-bar').style.width = (done/total*100)+'%';
  }));

  // Afficher l'Ã©cran de review
  showReviewScreen(gids, analysisData, MODULE_LABELS, url);
  btn.disabled = false;
  btn.textContent = 'ðŸ“¥ Charger ' + total + ' onglets';
  gsLoading(null);
}

// â”€â”€ Afficher le panneau de progression multi-import â”€â”€
function showMultiImportProgress(tabs) {
  const area = document.getElementById('gsArea');
  // Supprimer ancien panneau si existe
  document.getElementById('multi-progress-panel')?.remove();
  const div = document.createElement('div');
  div.id = 'multi-progress-panel';
  div.style = 'margin-top:14px;border:1px solid var(--border);border-radius:12px;overflow:hidden';
  div.innerHTML = `
    <div style="padding:10px 14px;background:#f8faff;border-bottom:1px solid var(--border);font-size:12px;font-weight:700">
      â³ Import en cours â€” ${tabs.length} onglet(s)
    </div>
    <div id="multi-progress-list" style="padding:10px 14px;display:flex;flex-direction:column;gap:6px">
      ${tabs.map(t => `
        <div id="mpi-${t.gid}" style="display:flex;align-items:center;gap:8px;font-size:12px;padding:6px 10px;background:#fff;border:1px solid var(--border);border-radius:8px">
          <span id="mpi-icon-${t.gid}">â¸ï¸</span>
          <span style="flex:1;font-weight:600">${t.name}</span>
          <span id="mpi-badge-${t.gid}" style="font-size:11px;color:var(--muted)">En attente...</span>
        </div>`).join('')}
    </div>`;
  area.appendChild(div);
  gsLoading('Import en cours...');
}

function updateMultiProgress(gid, status, detail) {
  const icons = { loading:'â³', ok:'âœ…', err:'âŒ', skip:'âš ï¸' };
  const texts = { loading:'Chargementâ€¦', ok:'ImportÃ© !', err:'Erreur', skip:'IgnorÃ© (module inconnu)' };
  const colors = { loading:'#4f46e5', ok:'#059669', err:'#dc2626', skip:'#d97706' };
  const bgs = { loading:'#f0f4ff', ok:'#f0fdf4', err:'#fef2f2', skip:'#fffbeb' };
  const borders = { loading:'#a5b4fc', ok:'#86efac', err:'#fca5a5', skip:'#fde68a' };
  const row = document.getElementById('mpi-' + gid);
  if (row) { row.style.background = bgs[status]; row.style.borderColor = borders[status]; }
  const icon = document.getElementById('mpi-icon-' + gid);
  const badge = document.getElementById('mpi-badge-' + gid);
  if (icon) icon.textContent = icons[status];
  if (badge) { badge.textContent = detail ? texts[status] + ' â€” ' + detail : texts[status]; badge.style.color = colors[status]; }
}

function showMultiImportSummary(results, successCount, skipCount) {
  const errCount = results.filter(r => r.status === 'err').length;
  const panel = document.getElementById('multi-progress-panel');
  if (panel) {
    const head = panel.querySelector('div');
    if (head) {
      head.innerHTML = `âœ… Import terminÃ© â€” ${successCount} rÃ©ussi(s), ${skipCount} ignorÃ©(s)${errCount ? ', ' + errCount + ' erreur(s)' : ''}`;
      head.style.background = successCount > 0 ? '#f0fdf4' : '#fef2f2';
    }
  }
  gsLoading(null);
  showToast(`âœ… ${successCount} onglet(s) importÃ©(s) !`, 'ok');
}

// â”€â”€ Import direct (sans UI mapping) utilisÃ© pour le multi-onglets â”€â”€
async function importDataDirect(destKey, rows, headers, mapping, forcedMonth) {
  if (!window._uid || !window._setDoc) throw new Error('Non connectÃ©');

  const localPf = v => parseFloat(String(v || 0).replace(',', '.')) || 0;
  const get = (r, key) => mapping[key] ? String(r[mapping[key]] || '') : '';
  const getN = (r, key) => localPf(mapping[key] ? r[mapping[key]] : 0);

  // â”€â”€ Pilotage â€” CA journalier â”€â”€
  if (destKey === 'pilotage_ca') {
    const byMonth = {};
    rows.forEach(r => {
      const dateVal = get(r, 'date');
      if (!dateVal && !forcedMonth) return;
      const ym = forcedMonth || parseDateToYYYYMM(dateVal) || new Date().toISOString().slice(0, 7);
      if (!byMonth[ym]) byMonth[ym] = [];
      const entry = { date: parseDateFull(dateVal) || `${ym}-01` };
      const h055 = localPf(mapping['ht055'] ? r[mapping['ht055']] : 0);
      const h10  = localPf(mapping['ht10']  ? r[mapping['ht10']]  : 0);
      const h20  = localPf(mapping['ht20']  ? r[mapping['ht20']]  : 0);
      const total = localPf(mapping['montantHT'] ? r[mapping['montantHT']] : 0);
      if (h055) entry.ht055 = String(h055);
      if (h10)  entry.ht10  = String(h10);
      if (h20)  entry.ht20  = String(h20);
      // Si seulement montantHT mappÃ© â†’ mettre en ht20
      if (!h055 && !h10 && !h20 && total) entry.ht20 = String(total);
      byMonth[ym].push(entry);
    });
    for (const [ym, entries] of Object.entries(byMonth)) {
      const ref = window._doc(window._db, 'pilotage', window._uid, 'months', ym);
      const snap = await window._getDoc(ref);
      const existing = snap.exists() ? snap.data() : {};
      const caMap = {};
      (existing.ca || []).forEach(e => caMap[e.date] = e);
      entries.forEach(e => caMap[e.date] = e);
      await window._setDoc(ref, { ...existing, ca: Object.values(caMap) }, { merge: true });
    }
  }

  // â”€â”€ Pilotage â€” Charges fixes â”€â”€
  else if (destKey === 'pilotage_chargesFixe') {
    const ym = forcedMonth || new Date().toISOString().slice(0, 7);
    const ref = window._doc(window._db, 'pilotage', window._uid, 'months', ym);
    const snap = await window._getDoc(ref);
    const existing = snap.exists() ? snap.data() : {};
    const newCharges = rows
      .map(r => ({
        fournisseur: get(r, 'fournisseur') || '',
        type:        get(r, 'type') || '',
        montantHT:   String(getN(r, 'montantHT') || ''),
        tvaRate:     getN(r, 'tvaRate') || 20,
        deductible:  get(r, 'deductible') || 'Oui',
        pointe:      'Non',
      }))
      .filter(r => r.fournisseur || parseFloat(r.montantHT) > 0);
    const merged = [...(existing.chargesFixe || []), ...newCharges];
    await window._setDoc(ref, { ...existing, chargesFixe: merged }, { merge: true });
  }

  // â”€â”€ Pilotage â€” Charges variables â”€â”€
  else if (destKey === 'pilotage_chargesVar') {
    const ym = forcedMonth || new Date().toISOString().slice(0, 7);
    const ref = window._doc(window._db, 'pilotage', window._uid, 'months', ym);
    const snap = await window._getDoc(ref);
    const existing = snap.exists() ? snap.data() : {};
    const newCharges = rows
      .map(r => ({
        fournisseur: get(r, 'fournisseur') || '',
        type:        get(r, 'type') || '',
        montantHT:   String(getN(r, 'montantHT') || ''),
        tvaRate:     getN(r, 'tvaRate') || 20,
        deductible:  get(r, 'deductible') || 'Oui',
        pointe:      'Non',
        exceptionnel: false,
      }))
      .filter(r => r.fournisseur || parseFloat(r.montantHT) > 0);
    const merged = [...(existing.chargesVar || []), ...newCharges];
    await window._setDoc(ref, { ...existing, chargesVar: merged }, { merge: true });
  }

  else   if (destKey === 'ca') {
    const byMonth = {};
    rows.forEach(r => {
      const dateVal = get(r, 'date');
      if (!dateVal && !forcedMonth) return; // skip empty rows without date
      // PrioritÃ© au mois forcÃ© depuis le nom de l'onglet
      const ym = forcedMonth || parseDateToYYYYMM(dateVal) || new Date().toISOString().slice(0, 7);
      if (!byMonth[ym]) byMonth[ym] = [];
      const entry = { date: parseDateFull(dateVal) || `${ym}-01` };
      if (mapping['ht055']) entry.ht055 = String(getN(r, 'ht055'));
      if (mapping['ht10']) entry.ht10 = String(getN(r, 'ht10'));
      if (mapping['ht20']) entry.ht20 = String(getN(r, 'ht20'));
      if (mapping['montantHT']) entry.montantHT = String(getN(r, 'montantHT'));
      if (!mapping['ht055'] && !mapping['ht10'] && !mapping['ht20'] && mapping['montantHT']) {
        entry.ht20 = entry.montantHT; delete entry.montantHT;
      }
      byMonth[ym].push(entry);
    });
    for (const [ym, entries] of Object.entries(byMonth)) {
      const ref = window._doc(window._db, 'pilotage', window._uid, 'months', ym);
      const snap = await window._getDoc(ref);
      const existing = snap.exists() ? snap.data() : { ca: [] };
      const caMap = {};
      (existing.ca || []).forEach(e => caMap[e.date] = e);
      entries.forEach(e => caMap[e.date] = e);
      await window._setDoc(ref, { ...existing, ca: Object.values(caMap) }, { merge: true });
    }
  }

  else if (destKey === 'charges') {
    const ym = forcedMonth || new Date().toISOString().slice(0, 7);
    const ref = window._doc(window._db, 'pilotage', window._uid, 'months', ym);
    const snap = await window._getDoc(ref);
    const existing = snap.exists() ? snap.data() : {};
    const chargesFixe = existing.chargesFixe || [];
    const chargesVar = existing.chargesVar || [];
    rows.forEach(r => {
      const typeRaw = String(get(r, 'type')).toLowerCase();
      const isVar = typeRaw.includes('var');
      const entry = {
        fournisseur: get(r, 'fournisseur'),
        type: '',
        montantHT: String(getN(r, 'montantHT')),
        tvaRate: getN(r, 'tvaRate') || 20,
        deductible: 'Oui', pointe: 'Non'
      };
      if (isVar) chargesVar.push(entry); else chargesFixe.push(entry);
    });
    await window._setDoc(ref, { ...existing, chargesFixe, chargesVar }, { merge: true });
  }

  else if (destKey === 'stock') {
    const snap = await window._getDoc(window._doc(window._db, 'stock', window._uid, 'data', 'all'));
    const state = snap.exists() ? snap.data() : { products: [], movements: [] };
    const products = state.products || [];
    rows.forEach(r => {
      const ref2 = String(get(r, 'ref')).trim();
      if (!ref2) return;
      const prod = {
        id: uid(), ref: ref2,
        name: get(r, 'name'), cat: get(r, 'cat'),
        fournisseur: get(r, 'fournisseur'),
        pa: String(getN(r, 'pa')), pv: String(getN(r, 'pv')),
        stockBase: String(getN(r, 'stockBase')), min: String(getN(r, 'min')),
        unite: get(r, 'unite') || 'unitÃ©', notes: get(r, 'notes'),
        createdAt: new Date().toISOString()
      };
      const idx = products.findIndex(p => (p.ref || '').trim() === ref2);
      if (idx >= 0) Object.assign(products[idx], prod); else products.push(prod);
    });
    await window._setDoc(window._doc(window._db, 'stock', window._uid, 'data', 'all'), { ...state, products, updatedAt: new Date().toISOString() });
  }

  else if (destKey === 'dettes') {
    const snap = await window._getDoc(window._doc(window._db, 'dettes', window._uid, 'data', 'all'));
    const dettes = snap.exists() ? (snap.data().list || []) : [];
    rows.forEach(r => {
      const nom = get(r, 'nom') || 'Import';
      const montant = getN(r, 'montant');
      if (!montant) return;
      const typeRaw = String(get(r, 'type')).toLowerCase();
      const type = typeRaw.includes('fournisseur') ? 'fournisseur' : typeRaw.includes('leasing') ? 'leasing' : 'emprunt';
      dettes.push({ id: uid(), nom, montant, taux: getN(r, 'taux'), duree: parseInt(get(r, 'duree')) || 60, debut: parseDateFull(get(r, 'debut')), type, amort: 'constant', paiements: [], active: true });
    });
    await window._setDoc(window._doc(window._db, 'dettes', window._uid, 'data', 'all'), { list: dettes });
  }

  else if (destKey === 'marges') {
    for (const r of rows) {
      const nom = (get(r, 'nom') || '').trim();
      if (!nom) continue; // ignorer les lignes sans nom
      const item = { id: uid(), nom, prixVente: getN(r, 'prixVente'), coutMP: getN(r, 'coutMP'), coutMain: getN(r, 'coutMain'), coutIndirect: getN(r, 'coutIndirect'), tvaRate: getN(r, 'tvaRate') || 20, updatedAt: new Date().toISOString() };
      await window._setDoc(window._doc(window._db, 'marges', window._uid, 'produits', item.id), item);
    }
  }

  else if (destKey === 'fidelite') {
    const snap = await window._getDoc(window._doc(window._db, 'fidelite', window._uid, 'clients', 'all'));
    const clients = snap.exists() ? (snap.data().list || []) : [];
    rows.forEach(r => {
      const email = String(get(r, 'email')).trim().toLowerCase();
      const tel = String(get(r, 'telephone')).trim();
      const prenom = String(get(r, 'prenom')).trim();
      const nom2 = String(get(r, 'nom')).trim();
      if (!email && !tel && !prenom && !nom2) return;
      const client = { id: uid(), prenom, nom: nom2, email, telephone: tel, points: getN(r, 'points'), dateInscription: parseDateFull(get(r, 'dateInscription')), actif: true };
      const idx = email ? clients.findIndex(c => c.email === email) : tel ? clients.findIndex(c => c.telephone === tel) : -1;
      if (idx >= 0) Object.assign(clients[idx], client); else clients.push(client);
    });
    await window._setDoc(window._doc(window._db, 'fidelite', window._uid, 'clients', 'all'), { list: clients, updatedAt: new Date().toISOString() });
  }
}

function resetGsSteps() {
  document.getElementById('gs-step-tabs').style.display = 'none';
  document.getElementById('gs-load-btn').style.display = 'none';
  document.getElementById('multi-progress-panel')?.remove();
  _gsSelectedTabs.clear();
  _gsTabsData = {};
  gsLoading(null);
}


function gsLoading(msg){
  const el=document.getElementById('gs-loading');
  const txt=document.getElementById('gs-loading-text');
  if(msg){el.style.display='';txt.textContent=msg;}
  else{el.style.display='none';}
}

async function detectSheetTabs(){
  const url=document.getElementById('gsUrl').value.trim();
  if(!url){showToast('Collez un lien Google Sheets','err');return}
  const btn=document.getElementById('gs-detect-btn');
  btn.textContent='â³...';btn.disabled=true;
  gsLoading('DÃ©tection des onglets...');
  try{
    const r=await fetch('/api/fetch-sheet',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({url})
    });
    const data=await r.json();
    if(!r.ok||!data.success) throw new Error(data.error||'Erreur serveur');
    renderTabsGrid(data.tabs||[{gid:'0',name:'Feuille 1'}]);
    document.getElementById('gs-step-tabs').style.display='';
  }catch(e){
    showToast('Erreur : '+e.message,'err');
  }finally{
    btn.textContent='ðŸ” DÃ©tecter les onglets';btn.disabled=false;
    gsLoading(null);
  }
}

// â”€â”€ Appliquer l'analyse IA (onglet unique) â”€â”€
function applyAiAnalysis(ai){
  if(!ai||!ai.module||ai.module==='inconnu') return;
  const moduleMap={'pilotage_ca':'ca','pilotage_charges':'charges','stock':'stock','dettes':'dettes','fidelite_clients':'fidelite','mouvements_stock':'mouvements','marges':'marges'};
  const destKey=moduleMap[ai.module]||ai.module;
  const btn=document.getElementById('dest-'+destKey);
  if(btn) setDest(destKey, btn);
  let mappedCount=0;
  if(ai.mapping){
    Object.entries(ai.mapping).forEach(([fieldKey, colName])=>{
      if(colName && _headers.includes(colName) && DEST_FIELDS[destKey]?.find(f=>f.key===fieldKey)){
        _mapping[fieldKey]=colName;_ignored.delete(fieldKey);mappedCount++;
      }
    });
  }
  const moduleLabels={ca:'ðŸ“ˆ CA journalier (Pilotage)',charges:'ðŸ’¸ Charges',dettes:'ðŸ¦ Dettes & Emprunts',stock:'ðŸ“¦ Stock produits',mouvements:'ðŸ”„ Mouvements stock',fidelite:'ðŸŽ Clients fidÃ©litÃ©',marges:'ðŸ“Š Marges / CoÃ»t de revient'};
  document.getElementById('ai-module-label').textContent='Module dÃ©tectÃ© : '+(moduleLabels[destKey]||destKey);
  document.getElementById('ai-reason-label').textContent=ai.reason||'';
  document.getElementById('ai-confidence-badge').textContent=Math.round((ai.confidence||0)*100)+'% confiance';
  document.getElementById('ai-mapping-applied').textContent=mappedCount?`âœ¨ ${mappedCount} colonne(s) prÃ©-mappÃ©e(s) automatiquement`:'Aucun mapping automatique possible â€” vÃ©rifiez manuellement.';
  document.getElementById('ai-analysis-block').style.display='';
}

// â”€â”€ PRÃ‰VISUALISATION â”€â”€
function showPreview(filename){
  document.getElementById('previewFilename').textContent=filename;
  document.getElementById('previewStats').textContent=`${_rows.length} lignes Â· ${_headers.length} colonnes`;
  const t=document.getElementById('previewTable');
  const maxRows=Math.min(_rows.length,8);
  t.innerHTML=`<thead><tr>${_headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
    <tbody>${Array.from({length:maxRows},(_,i)=>`<tr>${_headers.map(h=>`<td>${_rows[i][h]??''}</td>`).join('')}</tr>`).join('')}</tbody>`;
  document.getElementById('previewCard').classList.remove('hidden');
  document.getElementById('uploadCard').classList.add('hidden');
  showToast(`âœ… ${_rows.length} lignes chargÃ©es !`,'ok');
}
function resetFile(){
  _wb=null;_headers=[];_rows=[];_mapping={};_ignored.clear();
  document.getElementById('previewCard').classList.add('hidden');
  document.getElementById('uploadCard').classList.remove('hidden');
  document.getElementById('fileInput').value='';
  document.getElementById('ai-analysis-block').style.display='none';
}

// â”€â”€ DESTINATION â”€â”€
function setDest(d,btn){
  _dest=d;
  const allDests=['pilotage_ca','pilotage_chargesFixe','pilotage_chargesVar','ca','charges','dettes','stock','mouvements','fidelite','marges'];
  allDests.forEach(k=>{
    const b=document.getElementById('dest-'+k);
    if(b){b.style.borderColor=k===d?'var(--blue)':'var(--border)';b.style.background=k===d?'#eff6ff':'';b.style.color=k===d?'var(--blue)':''}
  });
  buildMapping();
}

// â”€â”€ DÃ‰TECTION AUTO â”€â”€
function autoDetect(){
  const fields=DEST_FIELDS[_dest];
  let matched=0;
  fields.forEach(f=>{
    const col=_headers.find(h=>{
      const hl=h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[_\-]/g,' ');
      return f.hint.some(hint=>{
        const hn=hint.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        return hl===hn||hl.includes(hn)||hn.includes(hl);
      });
    });
    if(col){_mapping[f.key]=col;_ignored.delete(f.key);matched++}
  });
  buildMapping();
  showToast(`âœ¨ ${matched} colonne${matched>1?'s':''} dÃ©tectÃ©e${matched>1?'s':''} automatiquement !`,matched>0?'ok':'info');
}

// â”€â”€ MAPPING UI â”€â”€
function buildMapping(){
  const fields=DEST_FIELDS[_dest];
  const opts=`<option value="">â€” Ne pas importer â€”</option>`+_headers.map(h=>`<option value="${h}">${h}</option>`).join('');
  document.getElementById('mappingRows').innerHTML=fields.map(f=>{
    const isIgnored=_ignored.has(f.key);
    const cur=_mapping[f.key]||'';
    const hasMapped=!!cur;
    const autoTag=hasMapped?`<span class="auto-badge">âœ¨ Auto</span>`:'';
    return`<div class="map-row ${hasMapped?'mapped':''} ${isIgnored?'ignored':''}" id="mr-${f.key}">
      <div>
        <div class="map-dest">${f.label} ${f.required?'<span style="color:var(--red)">*</span>':''} ${autoTag}</div>
        <div class="map-dest-sub">${f.sub}</div>
      </div>
      <div class="map-arrow">â†’</div>
      <select class="map-sel ${hasMapped?'has-val':''}" id="ms-${f.key}" onchange="onMapChange('${f.key}',this)">
        ${opts}
      </select>
      <button class="map-ignore ${isIgnored?'active':''}" onclick="toggleIgnore('${f.key}')">${isIgnored?'â†º Restaurer':'âœ• Ignorer'}</button>
    </div>`;
  }).join('');
  fields.forEach(f=>{const sel=document.getElementById('ms-'+f.key);if(sel&&_mapping[f.key])sel.value=_mapping[f.key];});
}
function onMapChange(key,sel){
  if(sel.value){_mapping[key]=sel.value;_ignored.delete(key)}
  else delete _mapping[key];
  const row=document.getElementById('mr-'+key);
  row.classList.toggle('mapped',!!sel.value);
  sel.classList.toggle('has-val',!!sel.value);
  row.querySelector('.auto-badge')?.remove();
}
function toggleIgnore(key){
  if(_ignored.has(key)){_ignored.delete(key)}
  else{_ignored.add(key);delete _mapping[key];document.getElementById('ms-'+key).value=''}
  buildMapping();
}
function validateMapping(){
  const required=DEST_FIELDS[_dest].filter(f=>f.required&&!_ignored.has(f.key));
  const missing=required.filter(f=>!_mapping[f.key]);
  if(missing.length){showToast(`Mappez d'abord : ${missing.map(f=>f.label).join(', ')}`,'err');return false}
  return true;
}

// â”€â”€ VÃ‰RIFICATION â”€â”€
function buildVerify(){
  const fields=DEST_FIELDS[_dest].filter(f=>_mapping[f.key]&&!_ignored.has(f.key));
  document.getElementById('importSummary').innerHTML=`
    <div class="is-box ok"><div class="is-val" style="color:var(--green)">${_rows.length}</div><div class="is-lbl">Lignes Ã  importer</div></div>
    <div class="is-box ok"><div class="is-val" style="color:var(--blue)">${fields.length}</div><div class="is-lbl">Champs mappÃ©s</div></div>
    <div class="is-box ${_ignored.size?'warn':''}"><div class="is-val" style="color:${_ignored.size?'var(--orange)':'var(--muted)'}">${_ignored.size}</div><div class="is-lbl">Champs ignorÃ©s</div></div>`;
  const previewRows=_rows.slice(0,5);
  document.getElementById('verifyTable').innerHTML=`
    <div style="overflow-x:auto;border:1px solid var(--border);border-radius:10px;margin-bottom:12px">
      <table class="preview-table">
        <thead><tr>${fields.map(f=>`<th>${f.label}</th>`).join('')}</tr></thead>
        <tbody>${previewRows.map(r=>`<tr>${fields.map(f=>`<td>${r[_mapping[f.key]]??'â€”'}</td>`).join('')}</tr>`).join('')}</tbody>
      </table>
    </div>
    ${_rows.length>5?`<div style="font-size:11px;color:var(--muted);margin-bottom:8px">+ ${_rows.length-5} autres lignesâ€¦</div>`:''}`;
  document.getElementById('warningBox').innerHTML="âœ… Tout est prÃªt pour l'import !";
  document.getElementById('warningBox').style.background='#f0fdf4';
  document.getElementById('warningBox').style.borderColor='#bbf7d0';
  document.getElementById('warningBox').style.color='#065f46';
}

// â”€â”€ IMPORT FINAL â”€â”€
const MONTHS_FR=['janvier','fÃ©vrier','mars','avril','mai','juin','juillet','aoÃ»t','septembre','octobre','novembre','dÃ©cembre'];

function parseDateToYYYYMM(v){
  if(!v)return null;
  const s=String(v).trim();
  const m1=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m1)return `${m1[3]}-${m1[2].padStart(2,'0')}`;
  const m2=s.match(/^(\d{4})[\/\-](\d{2})/);
  if(m2)return `${m2[1]}-${m2[2]}`;
  const idx=MONTHS_FR.findIndex(m=>s.toLowerCase().startsWith(m.slice(0,3)));
  if(idx>=0)return `${new Date().getFullYear()}-${String(idx+1).padStart(2,'0')}`;
  try{const d=new Date(v);if(!isNaN(d))return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}catch(e){}
  return null;
}
function parseDateFull(v){
  if(!v)return new Date().toISOString().slice(0,10);
  const s=String(v).trim();
  const m1=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m1)return `${m1[3]}-${m1[2].padStart(2,'0')}-${m1[1].padStart(2,'0')}`;
  const m2=s.match(/^(\d{4}[\/\-]\d{2}[\/\-]\d{2})/);
  if(m2)return m2[1].replace(/\//g,'-');
  try{const d=new Date(v);if(!isNaN(d))return d.toISOString().slice(0,10)}catch(e){}
  return new Date().toISOString().slice(0,10);
}

async function doImport(){
  const btn=document.getElementById('importBtn');
  btn.textContent='â³ Import en cours...';btn.disabled=true;
  try{
    if(_dest==='pilotage_ca'||_dest==='pilotage_chargesFixe'||_dest==='pilotage_chargesVar')
      await importDataDirect(_dest,_rows,_headers,_mapping,null);
    else if(_dest==='ca') await importCA();
    else if(_dest==='charges') await importCharges();
    else if(_dest==='dettes') await importDettes();
    else if(_dest==='stock') await importStock();
    else if(_dest==='mouvements') await importMouvements();
    else if(_dest==='fidelite') await importFidelite();
    else if(_dest==='marges') await importMarges();
  }catch(e){
    showToast('Erreur import : '+e.message,'err');
    btn.textContent="ðŸš€ Lancer l'import";btn.disabled=false;
    return;
  }
  setTimeout(()=>{
    document.getElementById('successMsg').textContent=`Import terminÃ© â€” ${_rows.length} lignes traitÃ©es vers ${_dest}`;
    goStep(4);
    setTimeout(()=>{document.getElementById('successBar').style.width='100%'},100);
    showToast('ðŸŽ‰ Import rÃ©ussi !','ok');
  },400);
}

async function importCA(){
  if(!window._uid||!window._setDoc) throw new Error('Non connectÃ©');
  const byMonth={};
  _rows.forEach(r=>{
    const dateVal=_mapping['date']?r[_mapping['date']]:'';
    const ym=parseDateToYYYYMM(dateVal)||`${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
    if(!byMonth[ym])byMonth[ym]=[];
    const entry={date:parseDateFull(dateVal)};
    if(_mapping['ht055'])entry.ht055=String(pf(r[_mapping['ht055']]));
    if(_mapping['ht10']) entry.ht10 =String(pf(r[_mapping['ht10']]));
    if(_mapping['ht20']) entry.ht20 =String(pf(r[_mapping['ht20']]));
    if(_mapping['montantHT']) entry.montantHT=String(pf(r[_mapping['montantHT']]));
    if(!_mapping['ht055']&&!_mapping['ht10']&&!_mapping['ht20']&&_mapping['montantHT']){entry.ht20=entry.montantHT;delete entry.montantHT;}
    byMonth[ym].push(entry);
  });
  for(const [ym,entries] of Object.entries(byMonth)){
    const ref=window._doc(window._db,'pilotage',window._uid,'months',ym);
    const snap=await window._getDoc(ref);
    const existing=snap.exists()?snap.data():{ca:[]};
    const caMap={};
    (existing.ca||[]).forEach(e=>caMap[e.date]=e);
    entries.forEach(e=>caMap[e.date]=e);
    await window._setDoc(ref,{...existing,ca:Object.values(caMap)},{merge:true});
  }
}

async function importCharges(){
  if(!window._uid||!window._setDoc) throw new Error('Non connectÃ©');
  const ym=`${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
  const ref=window._doc(window._db,'pilotage',window._uid,'months',ym);
  const snap=await window._getDoc(ref);
  const existing=snap.exists()?snap.data():{};
  const chargesFixe=existing.chargesFixe||[];
  const chargesVar=existing.chargesVar||[];
  _rows.forEach(r=>{
    const typeRaw=String(_mapping['type']?r[_mapping['type']]:'fixe').toLowerCase();
    const entry={fournisseur:_mapping['fournisseur']?String(r[_mapping['fournisseur']]||''):'',type:'',montantHT:String(pf(_mapping['montantHT']?r[_mapping['montantHT']]:0)),tvaRate:pf(_mapping['tvaRate']?r[_mapping['tvaRate']]:20)||20,deductible:'Oui',pointe:'Non'};
    if(typeRaw.includes('var'))chargesVar.push(entry); else chargesFixe.push(entry);
  });
  await window._setDoc(ref,{...existing,chargesFixe,chargesVar},{merge:true});
}

async function importDettes(){
  if(!window._uid||!window._setDoc) throw new Error('Non connectÃ©');
  const snap=await window._getDoc(window._doc(window._db,'dettes',window._uid,'data','all'));
  const dettes=snap.exists()?(snap.data().list||[]):[];
  _rows.forEach(r=>{
    const nom=String(_mapping['nom']?r[_mapping['nom']]||'Import':'Import');
    const montant=pf(_mapping['montant']?r[_mapping['montant']]:0);
    if(!montant)return;
    const typeRaw=String(_mapping['type']?r[_mapping['type']]:'emprunt').toLowerCase();
    const type=typeRaw.includes('fournisseur')?'fournisseur':typeRaw.includes('leasing')?'leasing':'emprunt';
    dettes.push({id:uid(),nom,montant,taux:pf(_mapping['taux']?r[_mapping['taux']]:0),duree:parseInt(_mapping['duree']?r[_mapping['duree']]:0)||60,debut:_mapping['debut']?parseDateFull(r[_mapping['debut']]):new Date().toISOString().slice(0,10),type,amort:'constant',paiements:[],active:true});
  });
  await window._setDoc(window._doc(window._db,'dettes',window._uid,'data','all'),{list:dettes});
}

async function importStock(){
  if(!window._uid||!window._setDoc) throw new Error('Non connectÃ©');
  const snap=await window._getDoc(window._doc(window._db,'stock',window._uid,'data','all'));
  const state=snap.exists()?snap.data():{products:[],movements:[]};
  const products=state.products||[];
  _rows.forEach(r=>{
    const ref=String(_mapping['ref']?r[_mapping['ref']]||'':'').trim();
    if(!ref)return;
    const prod={id:uid(),ref,name:String(_mapping['name']?r[_mapping['name']]||'':''),cat:String(_mapping['cat']?r[_mapping['cat']]||'':''),fournisseur:String(_mapping['fournisseur']?r[_mapping['fournisseur']]||'':''),pa:String(pf(_mapping['pa']?r[_mapping['pa']]:0)),pv:String(pf(_mapping['pv']?r[_mapping['pv']]:0)),stockBase:String(pf(_mapping['stockBase']?r[_mapping['stockBase']]:0)),min:String(pf(_mapping['min']?r[_mapping['min']]:0)),unite:String(_mapping['unite']?r[_mapping['unite']]||'unitÃ©':'unitÃ©'),notes:String(_mapping['notes']?r[_mapping['notes']]||'':''),createdAt:new Date().toISOString()};
    const idx=products.findIndex(p=>(p.ref||'').trim()===ref);
    if(idx>=0)Object.assign(products[idx],prod); else products.push(prod);
  });
  await window._setDoc(window._doc(window._db,'stock',window._uid,'data','all'),{...state,products,updatedAt:new Date().toISOString()});
}

async function importMouvements(){
  if(!window._uid||!window._setDoc) throw new Error('Non connectÃ©');
  const snap=await window._getDoc(window._doc(window._db,'stock',window._uid,'data','all'));
  const state=snap.exists()?snap.data():{products:[],movements:[]};
  const movements=state.movements||[];
  _rows.forEach(r=>{
    const ref=String(_mapping['ref']?r[_mapping['ref']]||'':'').trim();
    if(!ref)return;
    const typeRaw=String(_mapping['type']?r[_mapping['type']]||'in':'').toLowerCase();
    movements.push({id:uid(),date:parseDateFull(_mapping['date']?r[_mapping['date']]:''),type:typeRaw.includes('sort')||typeRaw==='out'?'OUT':'IN',ref,qty:pf(_mapping['qty']?r[_mapping['qty']]:0),note:String(_mapping['note']?r[_mapping['note']]||'':'')});
  });
  await window._setDoc(window._doc(window._db,'stock',window._uid,'data','all'),{...state,movements,updatedAt:new Date().toISOString()});
}

async function importFidelite(){
  if(!window._uid||!window._setDoc) throw new Error('Non connectÃ©');
  const snap=await window._getDoc(window._doc(window._db,'fidelite',window._uid,'clients','all'));
  const clients=snap.exists()?(snap.data().list||[]):[];
  _rows.forEach(r=>{
    const email=String(_mapping['email']?r[_mapping['email']]||'':'').trim().toLowerCase();
    const tel=String(_mapping['telephone']?r[_mapping['telephone']]||'':'').trim();
    const prenom=String(_mapping['prenom']?r[_mapping['prenom']]||'':'').trim();
    const nom=String(_mapping['nom']?r[_mapping['nom']]||'':'').trim();
    if(!email&&!tel&&!prenom&&!nom)return;
    const client={id:uid(),prenom,nom,email,telephone:tel,points:pf(_mapping['points']?r[_mapping['points']]:0),dateInscription:parseDateFull(_mapping['dateInscription']?r[_mapping['dateInscription']]:''),actif:true};
    const idx=email?clients.findIndex(c=>c.email===email):tel?clients.findIndex(c=>c.telephone===tel):-1;
    if(idx>=0)Object.assign(clients[idx],client); else clients.push(client);
  });
  await window._setDoc(window._doc(window._db,'fidelite',window._uid,'clients','all'),{list:clients,updatedAt:new Date().toISOString()});
}

async function importMarges(){
  if(!window._uid||!window._setDoc) throw new Error('Non connectÃ©');
  _rows.forEach(async r=>{
    const nom=String(_mapping['nom']?r[_mapping['nom']]||'':'').trim();
    if(!nom) return; // ignorer les lignes sans nom
    const item={id:uid(),nom,prixVente:pf(_mapping['prixVente']?r[_mapping['prixVente']]:0),coutMP:pf(_mapping['coutMP']?r[_mapping['coutMP']]:0),coutMain:pf(_mapping['coutMain']?r[_mapping['coutMain']]:0),coutIndirect:pf(_mapping['coutIndirect']?r[_mapping['coutIndirect']]:0),tvaRate:pf(_mapping['tvaRate']?r[_mapping['tvaRate']]:20)||20,updatedAt:new Date().toISOString()};
    await window._setDoc(window._doc(window._db,'marges',window._uid,'produits',item.id),item);
  });
}

// â”€â”€ Ã‰cran de review multi-onglets â”€â”€
function showReviewScreen(gids, analysisData, MODULE_LABELS, url) {
  const area = document.getElementById('gsArea');
  const ALL_MODULES = Object.keys(DEST_FIELDS);

  function buildTabRow(gid) {
    const d = analysisData[gid];
    const {tab, data, destKey, detectedMonth, mapping, enabled, error} = d;
    const headers = data ? data.headers : [];
    const fields = destKey && DEST_FIELDS[destKey] ? DEST_FIELDS[destKey] : [];
    const monthVal = detectedMonth || '';

    const moduleOpts = ALL_MODULES.map(m =>
      `<option value="${m}" ${destKey===m?'selected':''}>${MODULE_LABELS[m]||m}</option>`
    ).join('');

    const mappingGrid = fields.length ? `
      <div class="review-mapping-grid" id="mapping-grid-${gid}">
        ${fields.map(f => {
          const cur = mapping[f.key]||'';
          const opts = `<option value="">â€” Ne pas importer â€”</option>` +
            headers.map(h=>`<option value="${h}" ${cur===h?'selected':''}>${h}</option>`).join('');
          return `<div class="review-field-row">
            <div class="review-field-label">${f.label} ${f.required?'<span class="req">*</span>':''}</div>
            <select class="review-field-sel ${cur?'mapped':''}" 
              onchange="reviewUpdateMapping('${gid}','${f.key}',this.value)">
              ${opts}
            </select>
          </div>`;
        }).join('')}
      </div>` : `<div style="font-size:12px;color:#94a3b8;padding:4px 0">SÃ©lectionnez un module pour voir le mapping</div>`;

    const statusBadge = error
      ? `<span class="review-badge warn">âš ï¸ ${error}</span>`
      : destKey && DEST_FIELDS[destKey]
        ? `<span class="review-badge mod">${MODULE_LABELS[destKey]||destKey}</span>`
        : `<span class="review-badge warn">â“ Module inconnu</span>`;

    return `
      <div class="review-tab-row ${enabled?'':'disabled'}" id="review-row-${gid}">
        <div class="review-tab-header">
          <button class="review-tab-toggle ${enabled?'on':'off'}" 
            title="${enabled?'DÃ©sactiver':'Activer'} cet onglet"
            onclick="reviewToggleTab('${gid}')"></button>
          <div class="review-tab-name">ðŸ“‹ ${tab.name}</div>
          ${statusBadge}
          ${detectedMonth?`<span class="review-badge month">ðŸ“… ${detectedMonth}</span>`:''}
          ${data?`<span style="font-size:11px;color:#94a3b8">${data.rows.length} ligne${data.rows.length>1?'s':''}</span>`:''}
        </div>
        <div class="review-tab-meta" style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap">
          <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:#64748b">
            <span>Module :</span>
            <select class="review-module-sel" onchange="reviewUpdateModule('${gid}',this.value)">
              <option value="">â€” SÃ©lectionner â€”</option>
              ${moduleOpts}
            </select>
          </div>
          <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:#64748b">
            <span>Mois :</span>
            <input class="review-month-inp" type="text" placeholder="AAAA-MM" value="${monthVal}"
              oninput="reviewUpdateMonth('${gid}',this.value)">
          </div>
        </div>
        <div id="mapping-container-${gid}">${mappingGrid}</div>
      </div>`;
  }

  const rowsHtml = gids.map(g => buildTabRow(g)).join('');
  const enabledCount = gids.filter(g => analysisData[g].enabled).length;

  area.innerHTML = `
    <div class="review-panel">
      <div class="review-panel-header">
        <div>
          <div class="review-panel-title">ðŸ” VÃ©rification avant import</div>
          <div style="font-size:12px;color:#64748b;margin-top:2px">
            VÃ©rifiez le module et le mapping de chaque onglet. DÃ©sactivez ceux Ã  ignorer.
          </div>
        </div>
        <button class="btn btn-outline btn-sm" onclick="reviewSelectAll()">Tout activer</button>
      </div>
      ${rowsHtml}
      <div class="review-confirm-bar">
        <div style="font-size:13px;color:#64748b" id="review-count-label">
          <b id="review-enabled-count">${enabledCount}</b> onglet(s) Ã  importer
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-outline btn-sm" onclick="resetGsSteps()">â† Retour</button>
          <button class="btn btn-p" id="review-confirm-btn" onclick="confirmMultiImport()">
            ðŸš€ Confirmer et importer
          </button>
        </div>
      </div>
    </div>`;

  // Stocker les donnÃ©es d'analyse pour confirmMultiImport
  window._reviewAnalysisData = analysisData;
  window._reviewGids = gids;
  window._reviewUrl = url;
}

// Callbacks review
function reviewToggleTab(gid) {
  const d = window._reviewAnalysisData[gid];
  d.enabled = !d.enabled;
  const row = document.getElementById('review-row-'+gid);
  row.classList.toggle('disabled', !d.enabled);
  const btn = row.querySelector('.review-tab-toggle');
  btn.classList.toggle('on', d.enabled);
  btn.classList.toggle('off', !d.enabled);
  btn.title = (d.enabled?'DÃ©sactiver':'Activer') + ' cet onglet';
  // Mettre Ã  jour le compteur
  const count = window._reviewGids.filter(g=>window._reviewAnalysisData[g].enabled).length;
  document.getElementById('review-enabled-count').textContent = count;
}

function reviewSelectAll() {
  window._reviewGids.forEach(g => {
    const d = window._reviewAnalysisData[g];
    if(!d.enabled) reviewToggleTab(g);
  });
}

function reviewUpdateModule(gid, newModule) {
  const d = window._reviewAnalysisData[gid];
  d.destKey = newModule;
  // Rebuild le mapping grid
  const fields = newModule && DEST_FIELDS[newModule] ? DEST_FIELDS[newModule] : [];
  const headers = d.data ? d.data.headers : [];
  const container = document.getElementById('mapping-container-'+gid);
  if(!fields.length){ container.innerHTML = '<div style="font-size:12px;color:#94a3b8">Aucun mapping disponible</div>'; return; }
  
  // Auto-mapping basique par correspondance
  const newMapping = {};
  fields.forEach(f => {
    const found = headers.find(h => f.hint && f.hint.some(hint => h.toLowerCase().includes(hint)));
    if(found) newMapping[f.key] = found;
  });
  d.mapping = newMapping;

  container.innerHTML = `<div class="review-mapping-grid">` +
    fields.map(f => {
      const cur = newMapping[f.key]||'';
      const opts = `<option value="">â€” Ne pas importer â€”</option>` +
        headers.map(h=>`<option value="${h}" ${cur===h?'selected':''}>${h}</option>`).join('');
      return `<div class="review-field-row">
        <div class="review-field-label">${f.label}${f.required?' <span class="req">*</span>':''}</div>
        <select class="review-field-sel ${cur?'mapped':''}" 
          onchange="reviewUpdateMapping('${gid}','${f.key}',this.value)">${opts}</select>
      </div>`;
    }).join('') + `</div>`;
}

function reviewUpdateMapping(gid, fieldKey, colName) {
  window._reviewAnalysisData[gid].mapping[fieldKey] = colName;
  const sel = document.querySelector(`#mapping-container-${gid} select[onchange*="'${fieldKey}'"]`);
  if(sel) sel.classList.toggle('mapped', !!colName);
}

function reviewUpdateMonth(gid, val) {
  window._reviewAnalysisData[gid].detectedMonth = val.trim() || null;
}

// â”€â”€ Lancer l'import aprÃ¨s review â”€â”€
async function confirmMultiImport() {
  const gids = window._reviewGids;
  const analysisData = window._reviewAnalysisData;
  const toImport = gids.filter(g => analysisData[g].enabled && analysisData[g].destKey && DEST_FIELDS[analysisData[g].destKey]);

  if(!toImport.length){ showToast('Aucun onglet Ã  importer','err'); return; }

  const btn = document.getElementById('review-confirm-btn');
  btn.disabled = true; btn.textContent = 'â³ Import en coursâ€¦';

  showMultiImportProgress(toImport.map(g => analysisData[g].tab));

  let successCount=0, skipCount=0;
  const results=[];

  for(const gid of toImport){
    const {tab, data, destKey, detectedMonth, mapping} = analysisData[gid];
    updateMultiProgress(gid, 'loading');
    try{
      await importDataDirect(destKey, data.rows, data.headers, mapping, detectedMonth);
      successCount++;
      results.push({name:tab.name, status:'ok', module:destKey, month:detectedMonth, rows:data.rows.length});
      updateMultiProgress(gid, 'ok');
    }catch(e){
      results.push({name:tab.name, status:'err', reason:e.message});
      updateMultiProgress(gid, 'err', e.message);
    }
  }

  showMultiImportSummary(results, successCount, 0);
}

function resetAll(){
  _wb=null;_headers=[];_rows=[];_mapping={};_ignored.clear();_dest='ca';
  resetFile();setDest('ca',document.getElementById('dest-ca'));
  goStep(1);
}
</script>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import{getFirestore,doc,setDoc,getDoc}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const app=initializeApp({apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",storageBucket:"altiora-70599.firebasestorage.app",messagingSenderId:"120905555746",appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"});
const auth=getAuth(app),db=getFirestore(app);
window._auth=auth;window._db=db;window._doc=doc;window._setDoc=setDoc;window._getDoc=getDoc;window._signOut=signOut;
onAuthStateChanged(auth,user=>{
  if(!user){location.href='index.html';return}
  window._uid=user.uid;
  const n=user.displayName||user.email?.split('@')[0]||'';
  document.getElementById('uname').textContent=n;
  document.getElementById('av').textContent=n[0]?.toUpperCase()||'A';
});
</script>
<script src="nav.js"></script>
</body>
</html>
