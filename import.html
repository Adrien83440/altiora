<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>ALTEORE ‚Äî Import de donn√©es</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<!-- SheetJS pour lire Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --blue:#1a3dce;--blue2:#4f7ef8;--bg:#f4f6fb;--white:#fff;
  --border:#e2e8f0;--text:#1a1f36;--muted:#6b7280;
  --green:#10b981;--red:#ef4444;--orange:#f59e0b;--purple:#6366f1;
  --radius:14px;--sw:250px;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px}

nav{width:var(--sw);min-height:100vh;background:linear-gradient(180deg,#0f1f5c,#162366);position:fixed;top:0;left:0;display:flex;flex-direction:column;padding-bottom:20px;overflow-y:auto;z-index:99}
.logo{display:flex;align-items:center;gap:10px;padding:22px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
.logo-i{width:33px;height:33px;background:rgba(255,255,255,.14);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
.logo-t{font-size:17px;font-weight:800;color:#fff;letter-spacing:1px}
.ns{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 18px 4px}
.ni{display:flex;align-items:center;gap:9px;padding:9px 18px;color:rgba(255,255,255,.55);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.ni:hover{color:#fff;background:rgba(255,255,255,.06)}
.ni.on{color:#fff;background:rgba(255,255,255,.1);border-left-color:#4f7ef8}
.sub{overflow:hidden;max-height:0;transition:max-height .3s}.sub.open{max-height:200px}
.si{display:flex;align-items:center;gap:7px;padding:7px 18px 7px 40px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.si:hover{color:rgba(255,255,255,.75);background:rgba(255,255,255,.04)}
.si.on{color:#fff;background:rgba(79,126,248,.15);border-left-color:rgba(79,126,248,.6)}
.dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25)}.si.on .dot{background:#4f7ef8}
.chev{font-size:11px;color:rgba(255,255,255,.3);transition:transform .25s;margin-left:auto}
.nav-footer{margin-top:auto;padding:12px 18px 0;border-top:1px solid rgba(255,255,255,.08)}
.ucard{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,.07);border-radius:8px;cursor:pointer;transition:.15s}
.ucard:hover{background:rgba(255,255,255,.12)}
.uav{width:29px;height:29px;background:linear-gradient(135deg,#4f7ef8,#6366f1);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
.un{font-size:11.5px;font-weight:600;color:#fff}.upl{font-size:10px;color:rgba(255,255,255,.3)}
.lbtn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,.3);cursor:pointer;font-size:13px}

main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.topbar h1{font-size:16px;font-weight:700}.topbar p{font-size:11px;color:var(--muted)}
.tb-r{display:flex;gap:8px;align-items:center}
.btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:5px}
.btn-p{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;box-shadow:0 3px 10px rgba(26,61,206,.2)}
.btn-o{background:#fff;color:var(--blue);border:1.5px solid var(--border)}
.btn-o:hover{border-color:var(--blue2)}
.btn-xs{padding:4px 10px;font-size:11px}
.btn-g{background:#f0fdf4;color:var(--green);border:1.5px solid #bbf7d0}
.btn-d{background:#fef2f2;color:var(--red);border:1.5px solid #fecaca}

.page{padding:20px 24px;display:flex;flex-direction:column;gap:18px}

/* STEPS */
.steps{display:flex;align-items:center;gap:0;margin-bottom:4px}
.step{display:flex;align-items:center;gap:8px;flex:1}
.step-num{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;flex-shrink:0;border:2px solid var(--border);color:var(--muted);background:#fff;transition:.3s}
.step-num.done{background:var(--green);border-color:var(--green);color:#fff}
.step-num.active{background:var(--blue);border-color:var(--blue);color:#fff}
.step-label{font-size:11px;font-weight:600;color:var(--muted)}
.step-label.active{color:var(--blue);font-weight:700}
.step-label.done{color:var(--green)}
.step-line{flex:1;height:2px;background:var(--border);margin:0 8px;transition:.3s}
.step-line.done{background:var(--green)}

/* CARDS */
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius)}
.card-head{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:#f8faff}
.card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px}
.card-body{padding:20px}

/* FORMAT SELECTOR */
.format-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.fmt-btn{border:2px solid var(--border);border-radius:12px;padding:18px 14px;cursor:pointer;text-align:center;background:#fff;transition:.2s;position:relative}
.fmt-btn:hover{border-color:var(--blue2);background:#f8faff;transform:translateY(-2px);box-shadow:0 4px 16px rgba(79,126,248,.1)}
.fmt-btn.on{border-color:var(--blue);background:#eff6ff;box-shadow:0 0 0 3px rgba(79,126,248,.12)}
.fmt-icon{font-size:28px;margin-bottom:8px}
.fmt-name{font-size:13px;font-weight:700;margin-bottom:3px}
.fmt-desc{font-size:11px;color:var(--muted)}
.fmt-badge{position:absolute;top:-8px;right:10px;background:var(--green);color:#fff;font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px}

/* DROP ZONE */
.dropzone{border:2px dashed var(--border);border-radius:12px;padding:40px 20px;text-align:center;cursor:pointer;transition:.2s;background:#fafbff}
.dropzone:hover,.dropzone.drag{border-color:var(--blue2);background:#eff6ff}
.dropzone-icon{font-size:40px;margin-bottom:10px}
.dropzone-title{font-size:14px;font-weight:700;margin-bottom:4px}
.dropzone-sub{font-size:12px;color:var(--muted)}
.dropzone-btn{margin-top:14px;display:inline-flex;align-items:center;gap:6px;padding:8px 18px;background:var(--blue);color:#fff;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Plus Jakarta Sans',sans-serif}
input[type=file]{display:none}

/* GOOGLE SHEETS */
.gs-input{display:flex;gap:10px;align-items:center}
.gs-field{flex:1;padding:10px 14px;border:2px solid var(--border);border-radius:10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;outline:none;transition:.15s}
.gs-field:focus{border-color:var(--blue2);box-shadow:0 0 0 3px rgba(79,126,248,.1)}

/* PREVIEW TABLE */
.preview-wrap{overflow-x:auto;border:1px solid var(--border);border-radius:10px;max-height:220px;overflow-y:auto}
.preview-table{width:100%;border-collapse:collapse;font-size:11px}
.preview-table th{padding:7px 12px;background:#f8faff;border-bottom:1px solid var(--border);font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;white-space:nowrap;position:sticky;top:0}
.preview-table td{padding:7px 12px;border-bottom:1px solid #f8faff;white-space:nowrap}
.preview-table tr:hover td{background:#f8faff}

/* MAPPING */
.mapping-grid{display:flex;flex-direction:column;gap:0}
.dest-section{margin-bottom:16px}
.dest-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.map-rows{display:flex;flex-direction:column;gap:6px}
.map-row{display:grid;grid-template-columns:1fr 40px 1fr 80px;align-items:center;gap:10px;padding:10px 14px;background:#f8faff;border:1px solid var(--border);border-radius:10px;transition:.15s}
.map-row:hover{background:#eff6ff;border-color:#c7d2fe}
.map-row.mapped{background:#f0fdf4;border-color:#86efac}
.map-row.ignored{opacity:.45}
.map-dest{font-size:12px;font-weight:700;color:var(--text)}
.map-dest-sub{font-size:10px;color:var(--muted);margin-top:1px}
.map-arrow{font-size:16px;color:var(--muted);text-align:center}
.map-sel{width:100%;padding:6px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;color:var(--text);background:#fff;outline:none;cursor:pointer;transition:.15s}
.map-sel:focus{border-color:var(--blue2)}
.map-sel.has-val{border-color:var(--green);background:#f0fdf4}
.map-ignore{padding:4px 8px;border:1.5px solid var(--border);border-radius:6px;background:#fff;font-size:10px;font-weight:600;cursor:pointer;color:var(--muted);font-family:'Plus Jakarta Sans',sans-serif;transition:.15s}
.map-ignore:hover{background:#fef2f2;color:var(--red);border-color:#fecaca}
.map-ignore.active{background:#fef2f2;color:var(--red);border-color:#fecaca}

/* AUTO DETECT BADGES */
.auto-badge{display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700;background:#d1fae5;color:#065f46;margin-left:6px}

/* R√âSUM√â IMPORT */
.import-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.is-box{background:#f8faff;border:1.5px solid var(--border);border-radius:10px;padding:14px;text-align:center}
.is-box.ok{background:#f0fdf4;border-color:#86efac}
.is-box.warn{background:#fffbeb;border-color:#fde68a}
.is-val{font-size:20px;font-weight:800;margin-bottom:3px}
.is-lbl{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase}

/* PROGRESS */
.progress-bar-wrap{background:#e2e8f0;border-radius:99px;height:8px;overflow:hidden;margin:10px 0}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,var(--blue),var(--blue2));border-radius:99px;transition:width .5s ease}

/* TOAST */
.toast{position:fixed;bottom:18px;right:18px;padding:10px 16px;border-radius:9px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(60px);opacity:0;transition:.3s}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{background:#10b981;color:#fff}
.toast.err{background:#ef4444;color:#fff}
.toast.info{background:#1a3dce;color:#fff}

/* PANEL VISIBILITY */
.panel{display:none}.panel.on{display:block}
.hidden{display:none}

/* HAMBURGER */
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:#0f1f5c;border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(15,31,92,.45);-webkit-tap-highlight-color:transparent}
.hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;pointer-events:none}
.hamburger.open span:nth-child(1){transform:translateY(7.5px) rotate(45deg)}
.hamburger.open span:nth-child(2){opacity:0;transform:scaleX(0)}
.hamburger.open span:nth-child(3){transform:translateY(-7.5px) rotate(-45deg)}
.nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000}
.nav-overlay.show{display:block}

@media(max-width:768px){
  .hamburger{display:flex!important}
  nav{position:fixed!important;top:0!important;left:0!important;height:100vh!important;height:-webkit-fill-available!important;width:min(280px,84vw)!important;z-index:1001!important;transform:translateX(-105%)!important;transition:transform .3s cubic-bezier(.4,0,.2,1)!important;overflow-y:auto!important;-webkit-overflow-scrolling:touch!important;margin:0!important}
  nav.open{transform:translateX(0)!important;box-shadow:8px 0 32px rgba(0,0,0,.3)!important}
  main{margin-left:0!important;width:100vw!important;overflow-x:hidden!important}
  .topbar{padding:10px 10px 10px 62px!important;flex-wrap:wrap!important;gap:6px!important}
  .topbar h1{font-size:14px!important}
  .tb-r{width:100%!important;flex-wrap:wrap!important}
  .page{padding:12px 10px!important;overflow-x:hidden!important}
  .format-grid{grid-template-columns:1fr!important;gap:10px!important}
  .import-summary{grid-template-columns:1fr 1fr 1fr!important;gap:8px!important}
  .map-row{grid-template-columns:1fr 30px 1fr 60px!important;gap:6px!important}
  .steps{overflow-x:auto}
  .gs-input{flex-direction:column!important}
  .gs-field{width:100%}
}
</style>
</head>
<body>

<button class="hamburger" id="hamburger" onclick="toggleSidebar()" aria-label="Menu">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="navOverlay" onclick="closeSidebar()"></div>

<nav>
  <div class="logo"><div class="logo-i">üìä</div><div class="logo-t">ALTEORE</div></div>
  <div class="ns">Principal</div>
  <div class="ni" onclick="location.href='dashboard.html'"><span>üè†</span><span>Tableau de bord</span></div>
  <div class="ni" onclick="location.href='suivi-ca.html'"><span>üìà</span><span>Suivi CA & R√©sultats</span></div>
  <div class="ni" onclick="toggleNav('kpis-sub',this)"><span>üéØ</span><span style="flex:1">KPIs Cl√©s</span><span class="chev" id="chev-kpis">‚Ä∫</span></div>
  <div class="sub" id="kpis-sub">
    <div class="si" onclick="location.href='cout-revient.html'"><span class="dot"></span>Co√ªt de revient</div>
    <div class="si" onclick="location.href='marges.html'"><span class="dot"></span>Marge brute &amp; nette</div>
    <div class="si" onclick="location.href='panier-moyen.html'"><span class="dot"></span>Panier moyen</div>
  </div>
  <div class="ni" onclick="toggleNav('pil-sub',this)"><span>üß≠</span><span style="flex:1">Pilotage</span><span class="chev" id="chev-pil">‚Ä∫</span></div>
  <div class="sub" id="pil-sub">
    <div class="si" onclick="location.href='pilotage.html?year=2025'"><span class="dot"></span>Pilotage 2025</div>
    <div class="si" onclick="location.href='pilotage.html?year=2026'"><span class="dot"></span>Pilotage 2026</div>
    <div class="si" onclick="location.href='pilotage.html?year=2027'"><span class="dot"></span>Pilotage 2027</div>
  </div>
  <div class="ni" onclick="location.href='dettes.html'"><span>üè¶</span><span>Dettes &amp; Emprunts</span></div>
  <div class="ns">Intelligence IA</div>
  <div class="ni" onclick="location.href='bilan.html'"><span>ü§ñ</span><span style="flex:1">Analyse de Bilan</span><span style="font-size:10px;font-weight:700;background:rgba(79,126,248,0.3);color:#a5b4fc;padding:2px 7px;border-radius:20px">IA</span></div>
  <div class="ns">Outils</div>
  <div class="ni on"><span>üì•</span><span>Import de donn√©es</span></div>
  <div class="nav-footer">
    <div class="ucard" onclick="location.href='profil.html'">
      <div class="uav" id="av">A</div>
      <div><div class="un" id="uname">Utilisateur</div><div class="upl">Plan gratuit</div></div>
      <button class="lbtn" onclick="event.stopPropagation();doLogout()">‚éã</button>
    </div>
  </div>
</nav>

<main>
  <div class="topbar">
    <div>
      <h1>üì• Import de donn√©es</h1>
      <p>Importez vos fichiers Excel, CSV ou Google Sheets et mappez les colonnes vers Altiora</p>
    </div>
    <div class="tb-r">
      <button class="btn btn-o btn-xs" onclick="location.href='dashboard.html'">‚Üê Dashboard</button>
    </div>
  </div>

  <div class="page">

    <!-- √âTAPES -->
    <div class="steps" id="stepsBar">
      <div class="step">
        <div class="step-num active" id="sn1">1</div>
        <div class="step-label active" id="sl1">Format &amp; fichier</div>
      </div>
      <div class="step-line" id="line1"></div>
      <div class="step">
        <div class="step-num" id="sn2">2</div>
        <div class="step-label" id="sl2">Mapping colonnes</div>
      </div>
      <div class="step-line" id="line2"></div>
      <div class="step">
        <div class="step-num" id="sn3">3</div>
        <div class="step-label" id="sl3">V√©rification</div>
      </div>
      <div class="step-line" id="line3"></div>
      <div class="step">
        <div class="step-num" id="sn4">4</div>
        <div class="step-label" id="sl4">Import ‚úì</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê √âTAPE 1 : FORMAT + UPLOAD ‚ïê‚ïê‚ïê -->
    <div class="panel on" id="step1">

      <!-- Choix format -->
      <div class="card">
        <div class="card-head"><div class="card-title">üìÇ Choisissez votre format</div></div>
        <div class="card-body">
          <div class="format-grid">
            <div class="fmt-btn on" id="fmt-xlsx" onclick="selectFmt('xlsx')">
              <div class="fmt-badge">Recommand√©</div>
              <div class="fmt-icon">üìä</div>
              <div class="fmt-name">Excel (.xlsx)</div>
              <div class="fmt-desc">Fichiers Microsoft Excel ou LibreOffice</div>
            </div>
            <div class="fmt-btn" id="fmt-csv" onclick="selectFmt('csv')">
              <div class="fmt-icon">üìÑ</div>
              <div class="fmt-name">CSV (.csv)</div>
              <div class="fmt-desc">Fichiers texte s√©par√©s par virgule ou point-virgule</div>
            </div>
            <div class="fmt-btn" id="fmt-gsheets" onclick="selectFmt('gsheets')">
              <div class="fmt-icon">üü¢</div>
              <div class="fmt-name">Google Sheets</div>
              <div class="fmt-desc">Collez le lien de partage de votre feuille</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Upload zone -->
      <div class="card" id="uploadCard">
        <div class="card-head"><div class="card-title" id="uploadTitle">üìä Importer votre fichier Excel</div></div>
        <div class="card-body">
          <!-- XLSX / CSV -->
          <div id="dropArea">
            <div class="dropzone" id="dropzone"
              ondragover="ev(event,'drag',true)"
              ondragleave="ev(event,'drag',false)"
              ondrop="onDrop(event)">
              <div class="dropzone-icon" id="dzIcon">üìä</div>
              <div class="dropzone-title" id="dzTitle">Glissez votre fichier ici</div>
              <div class="dropzone-sub" id="dzSub">ou cliquez pour s√©lectionner</div>
              <button class="dropzone-btn" onclick="document.getElementById('fileInput').click()">
                üìÅ Choisir un fichier
              </button>
              <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="onFile(this.files[0])"/>
            </div>
          </div>
          <!-- Google Sheets -->
          <div id="gsArea" class="hidden">
            <div style="margin-bottom:12px;padding:10px 14px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;font-size:12px;color:#065f46">
              ‚úÖ Partagez votre feuille en <strong>"Tout le monde avec le lien peut consulter"</strong><br>
              <span style="color:var(--muted);font-size:11px">Fichier ‚Üí Partager ‚Üí Obtenir le lien ‚Üí "Tout le monde"</span>
            </div>

            <!-- √âtape 1 : Coller le lien -->
            <div id="gs-step-url">
              <div class="gs-input">
                <input class="gs-field" id="gsUrl" placeholder="https://docs.google.com/spreadsheets/d/..." />
                <button class="btn btn-p" id="gs-detect-btn" onclick="detectSheetTabs()">üîç D√©tecter les onglets</button>
              </div>
            </div>

            <!-- √âtape 2 : Choisir l'onglet (affich√© apr√®s d√©tection) -->
            <div id="gs-step-tabs" style="display:none;margin-top:14px">
              <div style="font-size:12px;font-weight:700;margin-bottom:10px">üìã Choisissez l'onglet √† importer :</div>
              <div id="gs-tabs-grid" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px"></div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <button class="btn btn-p" id="gs-load-btn" onclick="loadSelectedTab()" style="display:none">üì• Charger cet onglet</button>
                <button class="btn btn-o btn-xs" onclick="resetGsSteps()">‚Üê Changer de lien</button>
              </div>
            </div>

            <!-- Loader -->
            <div id="gs-loading" style="display:none;margin-top:12px;font-size:12px;color:#6366f1;font-weight:600">
              ‚è≥ <span id="gs-loading-text">Chargement...</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Aper√ßu fichier -->
      <div class="card hidden" id="previewCard">
        <div class="card-head">
          <div class="card-title">üëÅÔ∏è Aper√ßu du fichier <span id="previewFilename" style="font-size:11px;color:var(--muted);font-weight:500;margin-left:8px"></span></div>
          <div style="display:flex;gap:8px;align-items:center">
            <span id="previewStats" style="font-size:11px;color:var(--muted)"></span>
            <button class="btn btn-o btn-xs" onclick="resetFile()">‚úï Changer</button>
          </div>
        </div>
        <div class="card-body" style="padding:0">
          <!-- S√©lection feuille Excel -->
          <div id="sheetSelector" class="hidden" style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px">
            <span style="font-size:12px;font-weight:600">Feuille :</span>
            <select id="sheetSelect" class="map-sel" style="width:200px" onchange="selectSheet()"></select>
          </div>
          <div class="preview-wrap">
            <table class="preview-table" id="previewTable"></table>
          </div>
        </div>
        <div style="padding:14px 20px;border-top:1px solid var(--border);display:flex;justify-content:flex-end">
          <button class="btn btn-p" onclick="goStep(2)">Suivant ‚Üí Mapper les colonnes</button>
        </div>
      </div>

    </div>

    <!-- ‚ïê‚ïê‚ïê √âTAPE 2 : MAPPING ‚ïê‚ïê‚ïê -->
    <div class="panel" id="step2">
      <div class="card">
        <div class="card-head">
          <div class="card-title">üó∫Ô∏è Mapper les colonnes</div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-o btn-xs" onclick="autoDetect()">‚ú® D√©tection auto</button>
            <button class="btn btn-o btn-xs" onclick="goStep(1)">‚Üê Retour</button>
          </div>
        </div>
        <div class="card-body">

          <!-- Destination Altiora -->
          <div style="margin-bottom:16px">
            <div style="font-size:12px;font-weight:700;margin-bottom:8px">üìç O√π importer ces donn√©es ?</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-xs" id="dest-ca" onclick="setDest('ca',this)" style="border:2px solid var(--border)">üìà CA journalier</button>
              <button class="btn btn-xs" id="dest-charges" onclick="setDest('charges',this)" style="border:2px solid var(--border)">üí∏ Charges</button>
              <button class="btn btn-xs" id="dest-dettes" onclick="setDest('dettes',this)" style="border:2px solid var(--border)">üè¶ Dettes</button>
              <button class="btn btn-xs" id="dest-stock" onclick="setDest('stock',this)" style="border:2px solid var(--border)">üì¶ Stock produits</button>
              <button class="btn btn-xs" id="dest-mouvements" onclick="setDest('mouvements',this)" style="border:2px solid var(--border)">üîÑ Mouvements stock</button>
              <button class="btn btn-xs" id="dest-fidelite" onclick="setDest('fidelite',this)" style="border:2px solid var(--border)">üéÅ Clients fid√©lit√©</button>
              <button class="btn btn-xs" id="dest-marges" onclick="setDest('marges',this)" style="border:2px solid var(--border)">üìä Marges / Co√ªt de revient</button>
            </div>
          </div>

          <!-- Analyse IA -->
          <div id="ai-analysis-block" style="display:none;margin-bottom:14px;padding:12px 16px;border-radius:12px;border:2px solid #a5b4fc;background:#f5f3ff">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
              <span style="font-size:18px">üß†</span>
              <div>
                <div style="font-size:12px;font-weight:700;color:#4338ca" id="ai-module-label">Analyse IA</div>
                <div style="font-size:11px;color:#6b7280" id="ai-reason-label"></div>
              </div>
              <div style="margin-left:auto">
                <span id="ai-confidence-badge" style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:99px;background:#e0e7ff;color:#4338ca"></span>
              </div>
            </div>
            <div style="font-size:11px;color:#4338ca;font-style:italic" id="ai-mapping-applied"></div>
          </div>
          <div id="ai-loading-block" style="display:none;padding:10px 14px;background:#f5f3ff;border-radius:10px;font-size:12px;color:#6366f1;font-weight:600;margin-bottom:14px">
            üß† Analyse IA en cours...
          </div>

          <!-- L√©gende -->
          <div style="display:grid;grid-template-columns:1fr 40px 1fr 80px;gap:10px;padding:8px 14px;background:#f1f5f9;border-radius:8px;margin-bottom:10px;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">
            <div>Champ Alteore</div><div></div><div>Colonne de votre fichier</div><div>Action</div>
          </div>

          <!-- Lignes de mapping g√©n√©r√©es dynamiquement -->
          <div id="mappingRows"></div>

          <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
            <button class="btn btn-o" onclick="goStep(1)">‚Üê Retour</button>
            <button class="btn btn-p" onclick="goStep(3)">V√©rifier ‚Üí Pr√©visualiser l'import</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê √âTAPE 3 : V√âRIFICATION ‚ïê‚ïê‚ïê -->
    <div class="panel" id="step3">
      <div class="card">
        <div class="card-head">
          <div class="card-title">‚úÖ V√©rification avant import</div>
          <button class="btn btn-o btn-xs" onclick="goStep(2)">‚Üê Retour</button>
        </div>
        <div class="card-body">
          <div class="import-summary" id="importSummary"></div>
          <div id="verifyTable"></div>
          <div style="margin-top:16px;padding:12px 14px;background:#fffbeb;border:1px solid #fde68a;border-radius:10px;font-size:12px;color:#92400e" id="warningBox"></div>
          <div style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px">
            <button class="btn btn-o" onclick="goStep(2)">‚Üê Modifier</button>
            <button class="btn btn-p" id="importBtn" onclick="doImport()">üöÄ Importer les donn√©es</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê √âTAPE 4 : SUCC√àS ‚ïê‚ïê‚ïê -->
    <div class="panel" id="step4">
      <div class="card" style="text-align:center;padding:40px 20px">
        <div style="font-size:56px;margin-bottom:16px">üéâ</div>
        <div style="font-size:20px;font-weight:800;margin-bottom:8px;color:var(--green)">Import r√©ussi !</div>
        <div style="font-size:13px;color:var(--muted);margin-bottom:24px" id="successMsg"></div>
        <div class="progress-bar-wrap" style="max-width:400px;margin:0 auto 24px">
          <div class="progress-bar-fill" id="successBar" style="width:0%"></div>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
          <button class="btn btn-p" onclick="location.href='dashboard.html'">üè† Voir le dashboard</button>
          <button class="btn btn-o" onclick="location.href='suivi-ca.html'">üìà Voir le CA</button>
          <button class="btn btn-o" onclick="resetAll()">üì• Nouvel import</button>
        </div>
      </div>
    </div>

  </div>
</main>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ D√âFINITION DES CHAMPS PAR DESTINATION ‚îÄ‚îÄ
const DEST_FIELDS = {
  ca: [
    {key:'date',      label:'Date',               sub:'JJ/MM/AAAA ou timestamp', required:true,  hint:['date','jour','day','timestamp','datetime']},
    {key:'ht055',     label:'CA HT 5,5%',         sub:'Ventes taux r√©duit',      required:false, hint:['5.5','5,5','ht055','ht5','taux r√©duit','alimentaire']},
    {key:'ht10',      label:'CA HT 10%',          sub:'Ventes taux interm√©diaire',required:false, hint:['10','ht10','taux intermediaire','restauration']},
    {key:'ht20',      label:'CA HT 20%',          sub:'Ventes taux normal',      required:false, hint:['20','ht20','taux normal','standard']},
    {key:'montantHT', label:'CA HT Total',        sub:'Si pas de multi-TVA',     required:false, hint:['ca','ca ht','montant','ht','total ht','chiffre','ventes','recettes','revenu','total']},
  ],
  charges: [
    {key:'fournisseur',label:'Fournisseur',       sub:'Nom du fournisseur',      required:true,  hint:['fournisseur','supplier','vendor','nom','libell√©','description','charge']},
    {key:'type',       label:'Type',              sub:'Fixe ou Variable',        required:false, hint:['type','cat√©gorie','nature','fixe','variable']},
    {key:'montantHT',  label:'Montant HT (‚Ç¨)',    sub:'Montant hors taxe',       required:true,  hint:['montant','amount','ht','prix','co√ªt','valeur']},
    {key:'tvaRate',    label:'Taux TVA (%)',       sub:'5.5, 10 ou 20',          required:false, hint:['tva','taux','rate','taxe']},
  ],
  dettes: [
    {key:'nom',      label:'Nom / Description',   sub:'Intitul√© de la dette',    required:true,  hint:['nom','libell√©','description','objet','dette']},
    {key:'montant',  label:'Montant initial (‚Ç¨)', sub:'Capital emprunt√©',        required:true,  hint:['montant','capital','principal','amount']},
    {key:'taux',     label:'Taux (%)',            sub:'Taux d\'int√©r√™t annuel',  required:false, hint:['taux','rate','int√©r√™t']},
    {key:'duree',    label:'Dur√©e (mois)',         sub:'Dur√©e de remboursement', required:false, hint:['dur√©e','duree','mois','months','terme']},
    {key:'debut',    label:'Date de d√©but',       sub:'Date de d√©part',          required:false, hint:['d√©but','date','start','origine']},
    {key:'type',     label:'Type',                sub:'emprunt/fournisseur/leasing',required:false,hint:['type','nature','cat√©gorie']},
  ],
  stock: [
    {key:'ref',         label:'R√©f√©rence (SKU)',    sub:'Code produit unique',   required:true,  hint:['ref','sku','r√©f√©rence','reference','code','article','id','codeart']},
    {key:'name',        label:'Nom du produit',     sub:'D√©signation',           required:true,  hint:['nom','name','produit','d√©signation','designation','libell√©','description']},
    {key:'cat',         label:'Cat√©gorie',          sub:'Famille / rayon',       required:false, hint:['cat','categorie','cat√©gorie','famille','rayon','type','gamme']},
    {key:'fournisseur', label:'Fournisseur',        sub:'Nom du fournisseur',    required:false, hint:['fournisseur','supplier','vendor','fourn','frs']},
    {key:'pa',          label:'Prix achat HT (PA)', sub:'Co√ªt d\'achat',        required:false, hint:['pa','pa ht','puht','pu ht','prix achat','achat','cout','cost']},
    {key:'pv',          label:'Prix vente HT (PV)', sub:'Tarif de vente',       required:false, hint:['pv','pv ht','pvht','prix vente','vente','tarif','price']},
    {key:'stockBase',   label:'Stock initial (qt√©)','sub':'Quantit√© en stock',  required:false, hint:['stock','qte','qt√©','quantite','quantit√©','qty','inventory']},
    {key:'min',         label:'Seuil alerte',       sub:'Stock minimum',         required:false, hint:['min','seuil','alerte','stock min','minimum','reorder']},
    {key:'unite',       label:'Unit√©',              sub:'unit√©, kg, L...',       required:false, hint:['unite','unit√©','unit','um','conditionnement']},
    {key:'notes',       label:'Notes',              sub:'Commentaires',          required:false, hint:['notes','note','commentaire','obs','remarque']},
  ],
  mouvements: [
    {key:'date',  label:'Date',              sub:'JJ/MM/AAAA',            required:true,  hint:['date','jour','day','timestamp']},
    {key:'type',  label:'Type',              sub:'entr√©e ou sortie',      required:true,  hint:['type','mouvement','sens','direction','in','out','entr√©e','sortie']},
    {key:'ref',   label:'R√©f√©rence (SKU)',   sub:'R√©f. du produit',       required:true,  hint:['ref','sku','r√©f√©rence','code','article']},
    {key:'qty',   label:'Quantit√©',          sub:'Nombre de pi√®ces',      required:true,  hint:['qte','qt√©','quantite','quantit√©','qty','nb','nombre','quantity']},
    {key:'note',  label:'Commentaire',       sub:'Motif du mouvement',    required:false, hint:['note','commentaire','obs','motif','raison','reason']},
  ],
  fidelite: [
    {key:'prenom',        label:'Pr√©nom',           sub:'Pr√©nom du client',      required:false, hint:['prenom','pr√©nom','first','firstname']},
    {key:'nom',           label:'Nom',              sub:'Nom de famille',        required:false, hint:['nom','name','lastname','famille']},
    {key:'email',         label:'Email',            sub:'Adresse email',         required:false, hint:['email','mail','courriel','e-mail']},
    {key:'telephone',     label:'T√©l√©phone',        sub:'N¬∞ de t√©l√©phone',      required:false, hint:['telephone','t√©l√©phone','tel','phone','mobile','portable']},
    {key:'points',        label:'Points fid√©lit√©',  sub:'Solde de points',      required:false, hint:['points','point','solde','score','fidelite','fid√©lit√©']},
    {key:'dateInscription',label:'Date inscription',sub:'Date de cr√©ation',     required:false, hint:['date','inscription','cr√©ation','creation','since','depuis']},
  ],
  marges: [
    {key:'nom',         label:'Nom / Produit',      sub:'D√©signation',           required:true,  hint:['nom','name','produit','d√©signation','libell√©']},
    {key:'prixVente',   label:'Prix de vente HT',   sub:'Tarif HT',              required:false, hint:['pv','prix vente','vente','tarif','pvht','price']},
    {key:'coutMP',      label:'Co√ªt mati√®res premi√®res',sub:'Ingr√©dients / MP',  required:false, hint:['mp','mati√®res','ingredient','cout matiere','coutmp','raw']},
    {key:'coutMain',    label:'Co√ªt main d\'oeuvre', sub:'Salaires directs',     required:false, hint:['main','oeuvre','salaire','labour','labor','mdo']},
    {key:'coutIndirect',label:'Charges indirectes', sub:'Frais g√©n√©raux',        required:false, hint:['indirect','frais','g√©n√©ral','overhead','fixe']},
    {key:'tvaRate',     label:'Taux TVA (%)',        sub:'5.5, 10 ou 20',        required:false, hint:['tva','taux','rate','taxe']},
  ],
};

// ‚îÄ‚îÄ √âTAT GLOBAL ‚îÄ‚îÄ
let _wb=null, _headers=[], _rows=[], _mapping={}, _ignored=new Set(), _dest='ca', _fmt='xlsx', _currentStep=1;

// ‚îÄ‚îÄ NAVIGATION SIDEBAR ‚îÄ‚îÄ
function toggleNav(id,el){document.getElementById(id).classList.toggle('open');el.classList.toggle('on')}
async function doLogout(){try{if(window._signOut&&window._auth)await window._signOut(window._auth)}catch(e){}location.href='index.html'}
function toggleSidebar(){var n=document.querySelector('nav'),b=document.getElementById('hamburger'),o=document.getElementById('navOverlay');n.classList.toggle('open');b.classList.toggle('open');o.classList.toggle('show');document.body.style.overflow=n.classList.contains('open')?'hidden':''}
function closeSidebar(){var n=document.querySelector('nav'),b=document.getElementById('hamburger'),o=document.getElementById('navOverlay');n.classList.remove('open');b.classList.remove('open');o.classList.remove('show');document.body.style.overflow=''}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function showToast(msg,type){var t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(()=>t.className='toast',3000)}
function pf(v){return parseFloat(String(v||0).replace(',','.'))||0}
function uid(){return Date.now()+'_'+Math.random().toString(36).slice(2,8)}

// ‚îÄ‚îÄ √âTAPES ‚îÄ‚îÄ
function goStep(n){
  if(n===2&&!_rows.length){showToast('Chargez d\'abord un fichier','err');return}
  if(n===3){buildVerify();if(!validateMapping())return}
  _currentStep=n;
  for(let i=1;i<=4;i++){
    document.getElementById('step'+i).className='panel'+(i===n?' on':'');
    const sn=document.getElementById('sn'+i), sl=document.getElementById('sl'+i);
    if(i<n){sn.className='step-num done';sl.className='step-label done'}
    else if(i===n){sn.className='step-num active';sl.className='step-label active'}
    else{sn.className='step-num';sl.className='step-label'}
    if(i<4){const l=document.getElementById('line'+i);l.className='step-line'+(i<n?' done':'')}
  }
  if(n===2) buildMapping();
  window.scrollTo({top:0,behavior:'smooth'});
}

// ‚îÄ‚îÄ FORMAT ‚îÄ‚îÄ
function selectFmt(f){
  _fmt=f;
  ['xlsx','csv','gsheets'].forEach(k=>{
    document.getElementById('fmt-'+k).classList.toggle('on',k===f)
  });
  document.getElementById('dropArea').classList.toggle('hidden',f==='gsheets');
  document.getElementById('gsArea').classList.toggle('hidden',f!=='gsheets');
  const icons={'xlsx':'üìä','csv':'üìÑ','gsheets':'üü¢'};
  const titles={'xlsx':'Importer votre fichier Excel','csv':'Importer votre fichier CSV','gsheets':'Charger depuis Google Sheets'};
  document.getElementById('uploadTitle').textContent=titles[f];
  document.getElementById('dzIcon').textContent=icons[f]||'üìÅ';
  document.getElementById('fileInput').accept=f==='csv'?'.csv':'.xlsx,.xls';
}

// ‚îÄ‚îÄ DROP ZONE ‚îÄ‚îÄ
function ev(e,cls,add){e.preventDefault();document.getElementById('dropzone').classList.toggle(cls,add)}
function onDrop(e){e.preventDefault();document.getElementById('dropzone').classList.remove('drag');const f=e.dataTransfer.files[0];if(f)onFile(f)}

// ‚îÄ‚îÄ LECTURE FICHIER ‚îÄ‚îÄ
function onFile(file){
  if(!file)return;
  const ext=file.name.split('.').pop().toLowerCase();
  if(ext==='csv'||_fmt==='csv'){readCSV(file)}
  else{readXLSX(file)}
}

function readXLSX(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      _wb=XLSX.read(e.target.result,{type:'binary'});
      const sheets=_wb.SheetNames;
      const sel=document.getElementById('sheetSelect');
      sel.innerHTML=sheets.map((s,i)=>`<option value="${i}">${s}</option>`).join('');
      document.getElementById('sheetSelector').classList.toggle('hidden',sheets.length<=1);
      parseSheet(0,file.name);
    }catch(err){showToast('Erreur lecture Excel','err')}
  };
  reader.readAsBinaryString(file);
}

function selectSheet(){
  const idx=parseInt(document.getElementById('sheetSelect').value);
  parseSheet(idx,'');
}

function parseSheet(idx,filename){
  const ws=_wb.Sheets[_wb.SheetNames[idx]];
  const data=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
  if(!data.length){showToast('Feuille vide','err');return}
  _headers=data[0].map(h=>String(h).trim()).filter(h=>h);
  _rows=data.slice(1).filter(r=>r.some(c=>c!=='')).map(r=>{
    const obj={};_headers.forEach((h,i)=>obj[h]=r[i]);return obj;
  });
  showPreview(filename||_wb.SheetNames[document.getElementById('sheetSelect').value||0]);
}

function readCSV(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const text=e.target.result;
      const sep=text.indexOf(';')>text.indexOf(',')?';':',';
      const lines=text.trim().split('\n');
      _headers=lines[0].split(sep).map(h=>h.trim().replace(/^"|"$/g,''));
      _rows=lines.slice(1).filter(l=>l.trim()).map(l=>{
        const vals=l.split(sep).map(v=>v.trim().replace(/^"|"$/g,''));
        const obj={};_headers.forEach((h,i)=>obj[h]=vals[i]||'');return obj;
      });
      showPreview(file.name);
    }catch(err){showToast('Erreur lecture CSV','err')}
  };
  reader.readAsText(file,'UTF-8');
}

// ‚îÄ‚îÄ GOOGLE SHEETS (via API Vercel proxy) ‚îÄ‚îÄ
var _gsSelectedTab = null; // { gid, name }

async function detectSheetTabs(){
  const url=document.getElementById('gsUrl').value.trim();
  if(!url){showToast('Collez un lien Google Sheets','err');return}

  const btn=document.getElementById('gs-detect-btn');
  btn.textContent='‚è≥...';btn.disabled=true;
  gsLoading('D√©tection des onglets...');

  try{
    const r=await fetch('/api/fetch-sheet',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({url}) // pas de gid ‚Üí mode liste onglets
    });
    const data=await r.json();
    if(!r.ok||!data.success) throw new Error(data.error||'Erreur serveur');

    renderTabsGrid(data.tabs||[{gid:'0',name:'Feuille 1'}]);
    document.getElementById('gs-step-tabs').style.display='';
  }catch(e){
    showToast('Erreur : '+e.message,'err');
  }finally{
    btn.textContent='üîç D√©tecter les onglets';btn.disabled=false;
    gsLoading(null);
  }
}

function renderTabsGrid(tabs){
  const grid=document.getElementById('gs-tabs-grid');
  _gsSelectedTab=null;
  document.getElementById('gs-load-btn').style.display='none';

  grid.innerHTML=tabs.map((t,i)=>{
    return`<button class="btn btn-o btn-xs gs-tab-btn" data-gid="${t.gid}" data-name="${t.name.replace(/"/g,'&quot;')}"
      onclick="selectTab(this,'${t.gid}','${t.name.replace(/'/g,"\\'")}')">
      üìÑ ${t.name}
    </button>`;
  }).join('');
}

function selectTab(el,gid,name){
  // Highlight
  document.querySelectorAll('.gs-tab-btn').forEach(b=>{
    b.style.borderColor='var(--border)';b.style.background='';b.style.color='';b.style.fontWeight='';
  });
  el.style.borderColor='var(--blue)';el.style.background='#eff6ff';
  el.style.color='var(--blue)';el.style.fontWeight='700';

  _gsSelectedTab={gid,name};
  document.getElementById('gs-load-btn').style.display='';
  document.getElementById('gs-load-btn').textContent='üì• Charger "'+name+'"';
}

async function loadSelectedTab(){
  if(!_gsSelectedTab){showToast('S√©lectionnez un onglet','err');return}
  const url=document.getElementById('gsUrl').value.trim();
  const {gid,name}=_gsSelectedTab;

  const btn=document.getElementById('gs-load-btn');
  btn.textContent='‚è≥ Chargement...';btn.disabled=true;
  gsLoading("Chargement de l'onglet : "+name);
  document.getElementById('ai-analysis-block').style.display='none';

  try{
    const r=await fetch('/api/fetch-sheet',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({url, gid, analyze:true})
    });
    const data=await r.json();
    if(!r.ok||!data.success) throw new Error(data.error||'Erreur serveur');

    _headers=data.headers;
    _rows=data.rows;
    showPreview('Google Sheets ‚Äî '+name);

    if(data.aiAnalysis) applyAiAnalysis(data.aiAnalysis);
  }catch(e){
    showToast('Erreur : '+e.message,'err');
  }finally{
    btn.textContent='üì• Charger "'+name+'"';btn.disabled=false;
    gsLoading(null);
  }
}

function gsLoading(msg){
  const el=document.getElementById('gs-loading');
  const txt=document.getElementById('gs-loading-text');
  if(msg){el.style.display='';txt.textContent=msg;}
  else{el.style.display='none';}
}

function resetGsSteps(){
  document.getElementById('gs-step-tabs').style.display='none';
  document.getElementById('gs-load-btn').style.display='none';
  _gsSelectedTab=null;
  gsLoading(null);
}

// Conserver loadGSheets comme alias pour compatibilit√©
async function loadGSheets(){ detectSheetTabs(); }

function applyAiAnalysis(ai){
  if(!ai||!ai.module||ai.module==='inconnu') return;

  // Switcher vers le module d√©tect√©
  const moduleMap={
    'pilotage_ca':'ca','pilotage_charges':'charges','stock':'stock',
    'dettes':'dettes','fidelite_clients':'fidelite',
    'mouvements_stock':'mouvements','marges':'marges'
  };
  const destKey=moduleMap[ai.module]||ai.module;
  const btn=document.getElementById('dest-'+destKey);
  if(btn) setDest(destKey, btn);

  // Appliquer le mapping sugg√©r√©
  let mappedCount=0;
  if(ai.mapping){
    Object.entries(ai.mapping).forEach(([fieldKey, colName])=>{
      if(colName && _headers.includes(colName) && DEST_FIELDS[destKey]?.find(f=>f.key===fieldKey)){
        _mapping[fieldKey]=colName;
        _ignored.delete(fieldKey);
        mappedCount++;
      }
    });
  }

  // Afficher le bloc IA dans step2
  const moduleLabels={
    ca:'üìà CA journalier (Pilotage)',charges:'üí∏ Charges',dettes:'üè¶ Dettes & Emprunts',
    stock:'üì¶ Stock produits',mouvements:'üîÑ Mouvements stock',
    fidelite:'üéÅ Clients fid√©lit√©',marges:'üìä Marges / Co√ªt de revient'
  };
  document.getElementById('ai-module-label').textContent='Module d√©tect√© : '+(moduleLabels[destKey]||destKey);
  document.getElementById('ai-reason-label').textContent=ai.reason||'';
  document.getElementById('ai-confidence-badge').textContent=Math.round((ai.confidence||0)*100)+'% confiance';
  document.getElementById('ai-mapping-applied').textContent=mappedCount
    ?`‚ú® ${mappedCount} colonne(s) pr√©-mapp√©e(s) automatiquement`
    :'Aucun mapping automatique possible ‚Äî v√©rifiez manuellement.';
  document.getElementById('ai-analysis-block').style.display='';
}

// ‚îÄ‚îÄ PR√âVISUALISATION ‚îÄ‚îÄ
function showPreview(filename){
  document.getElementById('previewFilename').textContent=filename;
  document.getElementById('previewStats').textContent=`${_rows.length} lignes ¬∑ ${_headers.length} colonnes`;
  const t=document.getElementById('previewTable');
  const maxRows=Math.min(_rows.length,8);
  t.innerHTML=`<thead><tr>${_headers.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
    <tbody>${Array.from({length:maxRows},(_,i)=>`<tr>${_headers.map(h=>`<td>${_rows[i][h]??''}</td>`).join('')}</tr>`).join('')}</tbody>`;
  document.getElementById('previewCard').classList.remove('hidden');
  document.getElementById('uploadCard').classList.add('hidden');
  showToast(`‚úÖ ${_rows.length} lignes charg√©es !`,'ok');
}

function resetFile(){
  _wb=null;_headers=[];_rows=[];_mapping={};_ignored.clear();
  document.getElementById('previewCard').classList.add('hidden');
  document.getElementById('uploadCard').classList.remove('hidden');
  document.getElementById('fileInput').value='';
  document.getElementById('ai-analysis-block').style.display='none';
}

// ‚îÄ‚îÄ DESTINATION ‚îÄ‚îÄ
function setDest(d,btn){
  _dest=d;
  const allDests=['ca','charges','dettes','stock','mouvements','fidelite','marges'];
  allDests.forEach(k=>{
    const b=document.getElementById('dest-'+k);
    if(b){b.style.borderColor=k===d?'var(--blue)':'var(--border)';b.style.background=k===d?'#eff6ff':'';b.style.color=k===d?'var(--blue)':''}
  });
  buildMapping();
}

// ‚îÄ‚îÄ D√âTECTION AUTO ‚îÄ‚îÄ
function autoDetect(){
  const fields=DEST_FIELDS[_dest];
  let matched=0;
  fields.forEach(f=>{
    const col=_headers.find(h=>{
      const hl=h.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[_\-]/g,' ');
      return f.hint.some(hint=>{
        const hn=hint.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
        return hl===hn||hl.includes(hn)||hn.includes(hl);
      });
    });
    if(col){_mapping[f.key]=col;_ignored.delete(f.key);matched++}
  });
  buildMapping();
  showToast(`‚ú® ${matched} colonne${matched>1?'s':''} d√©tect√©e${matched>1?'s':''} automatiquement !`,matched>0?'ok':'info');
}

// ‚îÄ‚îÄ MAPPING UI ‚îÄ‚îÄ
function buildMapping(){
  const fields=DEST_FIELDS[_dest];
  const opts=`<option value="">‚Äî Ne pas importer ‚Äî</option>`+_headers.map(h=>`<option value="${h}">${h}</option>`).join('');
  document.getElementById('mappingRows').innerHTML=fields.map(f=>{
    const isIgnored=_ignored.has(f.key);
    const cur=_mapping[f.key]||'';
    const hasMapped=!!cur;
    const autoTag=hasMapped?`<span class="auto-badge">‚ú® Auto</span>`:'';
    return`<div class="map-row ${hasMapped?'mapped':''} ${isIgnored?'ignored':''}" id="mr-${f.key}">
      <div>
        <div class="map-dest">${f.label} ${f.required?'<span style="color:var(--red)">*</span>':''} ${autoTag}</div>
        <div class="map-dest-sub">${f.sub}</div>
      </div>
      <div class="map-arrow">‚Üí</div>
      <select class="map-sel ${hasMapped?'has-val':''}" id="ms-${f.key}" onchange="onMapChange('${f.key}',this)">
        ${opts}
      </select>
      <button class="map-ignore ${isIgnored?'active':''}" onclick="toggleIgnore('${f.key}')">${isIgnored?'‚Ü∫ Restaurer':'‚úï Ignorer'}</button>
    </div>`;
  }).join('');
  fields.forEach(f=>{
    const sel=document.getElementById('ms-'+f.key);
    if(sel&&_mapping[f.key])sel.value=_mapping[f.key];
  });
}

function onMapChange(key,sel){
  if(sel.value){_mapping[key]=sel.value;_ignored.delete(key)}
  else delete _mapping[key];
  const row=document.getElementById('mr-'+key);
  row.classList.toggle('mapped',!!sel.value);
  sel.classList.toggle('has-val',!!sel.value);
  row.querySelector('.auto-badge')?.remove();
}

function toggleIgnore(key){
  if(_ignored.has(key)){_ignored.delete(key)}
  else{_ignored.add(key);delete _mapping[key];document.getElementById('ms-'+key).value=''}
  buildMapping();
}

function validateMapping(){
  const required=DEST_FIELDS[_dest].filter(f=>f.required&&!_ignored.has(f.key));
  const missing=required.filter(f=>!_mapping[f.key]);
  if(missing.length){showToast(`Mappez d'abord : ${missing.map(f=>f.label).join(', ')}`,'err');return false}
  return true;
}

// ‚îÄ‚îÄ V√âRIFICATION ‚îÄ‚îÄ
function buildVerify(){
  const fields=DEST_FIELDS[_dest].filter(f=>_mapping[f.key]&&!_ignored.has(f.key));
  document.getElementById('importSummary').innerHTML=`
    <div class="is-box ok"><div class="is-val" style="color:var(--green)">${_rows.length}</div><div class="is-lbl">Lignes √† importer</div></div>
    <div class="is-box ok"><div class="is-val" style="color:var(--blue)">${fields.length}</div><div class="is-lbl">Champs mapp√©s</div></div>
    <div class="is-box ${_ignored.size?'warn':''}"><div class="is-val" style="color:${_ignored.size?'var(--orange)':'var(--muted)'}">${_ignored.size}</div><div class="is-lbl">Champs ignor√©s</div></div>`;
  const previewRows=_rows.slice(0,5);
  document.getElementById('verifyTable').innerHTML=`
    <div style="overflow-x:auto;border:1px solid var(--border);border-radius:10px;margin-bottom:12px">
      <table class="preview-table">
        <thead><tr>${fields.map(f=>`<th>${f.label}</th>`).join('')}</tr></thead>
        <tbody>${previewRows.map(r=>`<tr>${fields.map(f=>`<td>${r[_mapping[f.key]]??'‚Äî'}</td>`).join('')}</tr>`).join('')}</tbody>
      </table>
    </div>
    ${_rows.length>5?`<div style="font-size:11px;color:var(--muted);margin-bottom:8px">+ ${_rows.length-5} autres lignes‚Ä¶</div>`:''}`;
  const warns=[];
  document.getElementById('warningBox').innerHTML=warns.length?warns.join('<br/>'):'‚úÖ Tout est pr√™t pour l\'import !';
  document.getElementById('warningBox').style.background=warns.length?'#fffbeb':'#f0fdf4';
  document.getElementById('warningBox').style.borderColor=warns.length?'#fde68a':'#bbf7d0';
  document.getElementById('warningBox').style.color=warns.length?'#92400e':'#065f46';
}

// ‚îÄ‚îÄ IMPORT FINAL ‚îÄ‚îÄ
const MONTHS_FR=['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];

function parseDateToYYYYMM(v){
  if(!v)return null;
  const s=String(v).trim();
  // JJ/MM/AAAA ou JJ-MM-AAAA
  const m1=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m1)return `${m1[3]}-${m1[2].padStart(2,'0')}`;
  // AAAA-MM-DD
  const m2=s.match(/^(\d{4})[\/\-](\d{2})/);
  if(m2)return `${m2[1]}-${m2[2]}`;
  // Nom de mois
  const idx=MONTHS_FR.findIndex(m=>s.toLowerCase().startsWith(m.slice(0,3)));
  if(idx>=0)return `${new Date().getFullYear()}-${String(idx+1).padStart(2,'0')}`;
  // Date Excel num√©rique
  try{const d=new Date(v);if(!isNaN(d))return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}catch(e){}
  return null;
}

function parseDateFull(v){
  // Retourne AAAA-MM-JJ
  if(!v)return new Date().toISOString().slice(0,10);
  const s=String(v).trim();
  const m1=s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if(m1)return `${m1[3]}-${m1[2].padStart(2,'0')}-${m1[1].padStart(2,'0')}`;
  const m2=s.match(/^(\d{4}[\/\-]\d{2}[\/\-]\d{2})/);
  if(m2)return m2[1].replace(/\//g,'-');
  try{const d=new Date(v);if(!isNaN(d))return d.toISOString().slice(0,10)}catch(e){}
  return new Date().toISOString().slice(0,10);
}

async function doImport(){
  const btn=document.getElementById('importBtn');
  btn.textContent='‚è≥ Import en cours...';btn.disabled=true;
  let count=0, errors=0;

  try{
    if(_dest==='ca') await importCA();
    else if(_dest==='charges') await importCharges();
    else if(_dest==='dettes') await importDettes();
    else if(_dest==='stock') await importStock();
    else if(_dest==='mouvements') await importMouvements();
    else if(_dest==='fidelite') await importFidelite();
    else if(_dest==='marges') await importMarges();
  }catch(e){
    showToast('Erreur import : '+e.message,'err');
    btn.textContent='üöÄ Lancer l\'import';btn.disabled=false;
    return;
  }

  setTimeout(()=>{
    document.getElementById('successMsg').textContent=`Import termin√© ‚Äî ${_rows.length} lignes trait√©es vers ${_dest}`;
    goStep(4);
    setTimeout(()=>{document.getElementById('successBar').style.width='100%'},100);
    showToast('üéâ Import r√©ussi !','ok');
  },400);
}

// ‚îÄ‚îÄ IMPORT CA JOURNALIER (pilotage/{uid}/months/{YYYY-MM}) ‚îÄ‚îÄ
async function importCA(){
  if(!window._uid||!window._setDoc) throw new Error('Non connect√©');
  // Grouper par mois
  const byMonth={};
  _rows.forEach(r=>{
    const dateVal=_mapping['date']?r[_mapping['date']]:'';
    const ym=parseDateToYYYYMM(dateVal)||`${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
    if(!byMonth[ym])byMonth[ym]=[];

    const entry={date:parseDateFull(dateVal)};
    if(_mapping['ht055'])entry.ht055=String(pf(r[_mapping['ht055']]));
    if(_mapping['ht10']) entry.ht10 =String(pf(r[_mapping['ht10']]));
    if(_mapping['ht20']) entry.ht20 =String(pf(r[_mapping['ht20']]));
    if(_mapping['montantHT']) entry.montantHT=String(pf(r[_mapping['montantHT']]));
    // Si multi-TVA non renseign√© mais montantHT dispo ‚Üí mapper en ht20 par d√©faut
    if(!_mapping['ht055']&&!_mapping['ht10']&&!_mapping['ht20']&&_mapping['montantHT']){
      entry.ht20=entry.montantHT; delete entry.montantHT;
    }
    byMonth[ym].push(entry);
  });

  for(const [ym,entries] of Object.entries(byMonth)){
    const ref=window._doc(window._db,'pilotage',window._uid,'months',ym);
    const snap=await window._getDoc(ref);
    const existing=snap.exists()?snap.data():{ca:[]};
    // Fusionner : remplacer les dates existantes
    const caMap={};
    (existing.ca||[]).forEach(e=>caMap[e.date]=e);
    entries.forEach(e=>caMap[e.date]=e);
    await window._setDoc(ref,{...existing,ca:Object.values(caMap)},{merge:true});
  }
}

// ‚îÄ‚îÄ IMPORT CHARGES (pilotage/{uid}/months/{YYYY-MM}) ‚îÄ‚îÄ
async function importCharges(){
  if(!window._uid||!window._setDoc) throw new Error('Non connect√©');
  // Pas de date ‚Üí on met dans le mois courant
  const ym=`${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}`;
  const ref=window._doc(window._db,'pilotage',window._uid,'months',ym);
  const snap=await window._getDoc(ref);
  const existing=snap.exists()?snap.data():{};
  const chargesFixe=existing.chargesFixe||[{fournisseur:'',type:'',montantHT:'',tvaRate:20,deductible:'Oui',pointe:'Non'}];
  const chargesVar=existing.chargesVar||[{fournisseur:'',type:'',montantHT:'',tvaRate:20,deductible:'Oui',pointe:'Non'}];

  _rows.forEach(r=>{
    const typeRaw=String(_mapping['type']?r[_mapping['type']]:'fixe').toLowerCase();
    const isVar=typeRaw.includes('var');
    const entry={
      fournisseur:_mapping['fournisseur']?String(r[_mapping['fournisseur']]||''):'',
      type:'',
      montantHT:String(pf(_mapping['montantHT']?r[_mapping['montantHT']]:0)),
      tvaRate:pf(_mapping['tvaRate']?r[_mapping['tvaRate']]:20)||20,
      deductible:'Oui',pointe:'Non'
    };
    if(isVar)chargesVar.push(entry);
    else chargesFixe.push(entry);
  });
  await window._setDoc(ref,{...existing,chargesFixe,chargesVar},{merge:true});
}

// ‚îÄ‚îÄ IMPORT DETTES ‚îÄ‚îÄ
async function importDettes(){
  if(!window._uid||!window._setDoc) throw new Error('Non connect√©');
  const snap=await window._getDoc(window._doc(window._db,'dettes',window._uid,'data','all'));
  const dettes=snap.exists()?(snap.data().list||[]):[];
  _rows.forEach(r=>{
    const nom=String(_mapping['nom']?r[_mapping['nom']]||'Import':'Import');
    const montant=pf(_mapping['montant']?r[_mapping['montant']]:0);
    if(!montant)return;
    const taux=pf(_mapping['taux']?r[_mapping['taux']]:0);
    const duree=parseInt(_mapping['duree']?r[_mapping['duree']]:0)||60;
    const debut=_mapping['debut']?parseDateFull(r[_mapping['debut']]):new Date().toISOString().slice(0,10);
    const typeRaw=String(_mapping['type']?r[_mapping['type']]:'emprunt').toLowerCase();
    const type=typeRaw.includes('fournisseur')?'fournisseur':typeRaw.includes('leasing')?'leasing':typeRaw.includes('d√©couvert')?'decouvert':'emprunt';
    dettes.push({id:uid(),nom,montant,taux,duree,debut,type,amort:'constant',paiements:[],active:true});
  });
  await window._setDoc(window._doc(window._db,'dettes',window._uid,'data','all'),{list:dettes});
}

// ‚îÄ‚îÄ IMPORT STOCK ‚îÄ‚îÄ
async function importStock(){
  if(!window._uid||!window._setDoc) throw new Error('Non connect√©');
  const snap=await window._getDoc(window._doc(window._db,'stock',window._uid,'data','all'));
  const state=snap.exists()?snap.data():{products:[],movements:[]};
  const products=state.products||[];

  _rows.forEach(r=>{
    const ref=String(_mapping['ref']?r[_mapping['ref']]||'':'').trim();
    if(!ref)return;
    const prod={
      id:uid(), ref,
      name:  String(_mapping['name']?r[_mapping['name']]||'':''),
      cat:   String(_mapping['cat']?r[_mapping['cat']]||'':''),
      fournisseur:String(_mapping['fournisseur']?r[_mapping['fournisseur']]||'':''),
      pa:    String(pf(_mapping['pa']?r[_mapping['pa']]:0)),
      pv:    String(pf(_mapping['pv']?r[_mapping['pv']]:0)),
      stockBase:String(pf(_mapping['stockBase']?r[_mapping['stockBase']]:0)),
      min:   String(pf(_mapping['min']?r[_mapping['min']]:0)),
      unite: String(_mapping['unite']?r[_mapping['unite']]||'unit√©':'unit√©'),
      notes: String(_mapping['notes']?r[_mapping['notes']]||'':''),
      createdAt:new Date().toISOString()
    };
    const idx=products.findIndex(p=>(p.ref||'').trim()===ref);
    if(idx>=0)Object.assign(products[idx],prod);
    else products.push(prod);
  });
  await window._setDoc(window._doc(window._db,'stock',window._uid,'data','all'),{...state,products,updatedAt:new Date().toISOString()});
}

// ‚îÄ‚îÄ IMPORT MOUVEMENTS STOCK ‚îÄ‚îÄ
async function importMouvements(){
  if(!window._uid||!window._setDoc) throw new Error('Non connect√©');
  const snap=await window._getDoc(window._doc(window._db,'stock',window._uid,'data','all'));
  const state=snap.exists()?snap.data():{products:[],movements:[]};
  const movements=state.movements||[];

  _rows.forEach(r=>{
    const ref=String(_mapping['ref']?r[_mapping['ref']]||'':'').trim();
    if(!ref)return;
    const typeRaw=String(_mapping['type']?r[_mapping['type']]||'in':'').toLowerCase();
    const type=typeRaw.includes('sort')||typeRaw==='out'?'OUT':'IN';
    movements.push({
      id:uid(),
      date:parseDateFull(_mapping['date']?r[_mapping['date']]:''),
      type, ref,
      qty:pf(_mapping['qty']?r[_mapping['qty']]:0),
      note:String(_mapping['note']?r[_mapping['note']]||'':''),
    });
  });
  await window._setDoc(window._doc(window._db,'stock',window._uid,'data','all'),{...state,movements,updatedAt:new Date().toISOString()});
}

// ‚îÄ‚îÄ IMPORT CLIENTS FID√âLIT√â ‚îÄ‚îÄ
async function importFidelite(){
  if(!window._uid||!window._setDoc) throw new Error('Non connect√©');
  const snap=await window._getDoc(window._doc(window._db,'fidelite',window._uid,'clients','all'));
  const clients=snap.exists()?(snap.data().list||[]):[];

  _rows.forEach(r=>{
    const email=String(_mapping['email']?r[_mapping['email']]||'':'').trim().toLowerCase();
    const tel=String(_mapping['telephone']?r[_mapping['telephone']]||'':'').trim();
    const prenom=String(_mapping['prenom']?r[_mapping['prenom']]||'':'').trim();
    const nom=String(_mapping['nom']?r[_mapping['nom']]||'':'').trim();
    if(!email&&!tel&&!prenom&&!nom)return;

    const client={
      id:uid(),
      prenom,nom,email,telephone:tel,
      points:pf(_mapping['points']?r[_mapping['points']]:0),
      dateInscription:parseDateFull(_mapping['dateInscription']?r[_mapping['dateInscription']]:''),
      actif:true,
    };
    // D√©doublonner par email ou t√©l√©phone
    const idx=email?clients.findIndex(c=>c.email===email)
               :tel?clients.findIndex(c=>c.telephone===tel):-1;
    if(idx>=0)Object.assign(clients[idx],client);
    else clients.push(client);
  });
  await window._setDoc(window._doc(window._db,'fidelite',window._uid,'clients','all'),{list:clients,updatedAt:new Date().toISOString()});
}

// ‚îÄ‚îÄ IMPORT MARGES / CO√õT DE REVIENT ‚îÄ‚îÄ
async function importMarges(){
  if(!window._uid||!window._setDoc) throw new Error('Non connect√©');
  _rows.forEach(async r=>{
    const nom=String(_mapping['nom']?r[_mapping['nom']]||'Import':'Import');
    const item={
      id:uid(), nom,
      prixVente:pf(_mapping['prixVente']?r[_mapping['prixVente']]:0),
      coutMP:   pf(_mapping['coutMP']?r[_mapping['coutMP']]:0),
      coutMain: pf(_mapping['coutMain']?r[_mapping['coutMain']]:0),
      coutIndirect:pf(_mapping['coutIndirect']?r[_mapping['coutIndirect']]:0),
      tvaRate:  pf(_mapping['tvaRate']?r[_mapping['tvaRate']]:20)||20,
      updatedAt:new Date().toISOString(),
    };
    await window._setDoc(
      window._doc(window._db,'marges',window._uid,'produits',item.id),
      item
    );
  });
}

// ‚îÄ‚îÄ RESET ‚îÄ‚îÄ
function resetAll(){
  _wb=null;_headers=[];_rows=[];_mapping={};_ignored.clear();_dest='ca';
  resetFile();setDest('ca',document.getElementById('dest-ca'));
  goStep(1);
}
</script>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import{getFirestore,doc,setDoc,getDoc}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const app=initializeApp({apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",storageBucket:"altiora-70599.firebasestorage.app",messagingSenderId:"120905555746",appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"});
const auth=getAuth(app),db=getFirestore(app);
window._auth=auth;window._db=db;window._doc=doc;window._setDoc=setDoc;window._getDoc=getDoc;window._signOut=signOut;
onAuthStateChanged(auth,user=>{
  if(!user){location.href='index.html';return}
  window._uid=user.uid;
  const n=user.displayName||user.email?.split('@')[0]||'';
  document.getElementById('uname').textContent=n;
  document.getElementById('av').textContent=n[0]?.toUpperCase()||'A';
});
</script>
<script src="nav.js"></script>
</body>
</html>
