<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE â€” Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --blue-dark:#0f1f5c;--blue-main:#1a3dce;--blue-light:#4f7ef8;
      --blue-ghost:#f0f4ff;--white:#fff;--text:#1a1f36;--muted:#6b7280;
      --border:#e2e8f0;--bg:#f5f7ff;--sidebar-w:252px;--radius:14px;
      --green:#10b981;--orange:#f59e0b;--red:#ef4444;--purple:#6366f1;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;}

    /* SIDEBAR */
    .sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#0f1f5c 0%,#162366 100%);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;overflow-y:auto;}
    .sidebar-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 22px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:10px;}
    .sidebar-logo-icon{width:36px;height:36px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .sidebar-logo-text{font-size:18px;font-weight:800;color:white;letter-spacing:1px;}
    .sidebar-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,0.3);letter-spacing:1.2px;text-transform:uppercase;padding:14px 20px 5px;}
    .nav-item{display:flex;align-items:center;gap:11px;padding:10px 20px;color:rgba(255,255,255,0.6);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;user-select:none;}
    .nav-item:hover{color:white;background:rgba(255,255,255,0.06);}
    .nav-item.active{color:white;background:rgba(255,255,255,0.1);border-left-color:#4f7ef8;}
    .nav-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0;}
    .nav-label{flex:1;}
    .nav-badge{background:rgba(79,126,248,0.3);color:#a5b4fc;font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px;}
    .nav-chevron{font-size:11px;color:rgba(255,255,255,0.3);transition:transform 0.25s;margin-left:auto;}
    .nav-item.open .nav-chevron{transform:rotate(90deg);}
    .submenu{overflow:hidden;max-height:0;transition:max-height 0.3s ease;}
    .submenu.open{max-height:300px;}
    .sub-item{display:flex;align-items:center;gap:9px;padding:8px 20px 8px 44px;color:rgba(255,255,255,0.45);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;}
    .sub-item:hover{color:rgba(255,255,255,0.8);background:rgba(255,255,255,0.05);}
    .sub-item.active{color:white;background:rgba(79,126,248,0.15);border-left-color:rgba(79,126,248,0.6);}
    .sub-dot{width:5px;height:5px;background:rgba(255,255,255,0.3);border-radius:50%;flex-shrink:0;}
    .sub-item.active .sub-dot{background:#4f7ef8;}
    .sub-year-badge{margin-left:auto;font-size:10px;color:rgba(255,255,255,0.25);font-weight:600;}
    .sidebar-footer{margin-top:auto;padding:16px 20px 0;border-top:1px solid rgba(255,255,255,0.08);}
    .user-card{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.07);border-radius:10px;}
    .user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--blue-light),#6366f1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
    .user-name{font-size:12px;font-weight:600;color:white;}
    .user-plan{font-size:10px;color:rgba(255,255,255,0.4);}
    .logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:14px;padding:4px;}
    .logout-btn:hover{color:rgba(255,255,255,0.7);}

    /* MAIN */
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:18px;font-weight:700;}
    .topbar-left p{font-size:12px;color:var(--muted);margin-top:1px;}
    .topbar-right{display:flex;align-items:center;gap:12px;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;}
    .btn-primary{background:linear-gradient(135deg,var(--blue-main),var(--blue-light));color:white;box-shadow:0 3px 10px rgba(26,61,206,0.3);}
    .btn-outline{background:white;color:var(--blue-main);border:1.5px solid var(--border);}
    .btn-outline:hover{border-color:var(--blue-main);background:var(--blue-ghost);}

    .content{padding:28px 32px;flex:1;}

    /* CONTEXT BAR */
    .context-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;}
    .context-month{display:flex;align-items:center;gap:10px;}
    .context-pill{display:inline-flex;align-items:center;gap:6px;background:white;border:1px solid var(--border);border-radius:20px;padding:6px 14px;font-size:12px;font-weight:600;color:var(--text);}
    .context-pill .dot{width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite;}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
    .last-update{font-size:11px;color:var(--muted);}

    /* KPI MOIS */
    .section-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
    .section-label::after{content:'';flex:1;height:1px;background:var(--border);}
    .kpi-grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px;}
    .kpi-grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:28px;}
    .kpi-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;overflow:hidden;transition:box-shadow 0.2s,transform 0.2s;}
    .kpi-card:hover{box-shadow:0 6px 24px rgba(26,61,206,0.08);transform:translateY(-1px);}
    .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
    .kpi-card.blue::before{background:linear-gradient(90deg,var(--blue-main),var(--blue-light));}
    .kpi-card.green::before{background:linear-gradient(90deg,#10b981,#34d399);}
    .kpi-card.orange::before{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
    .kpi-card.purple::before{background:linear-gradient(90deg,#6366f1,#a5b4fc);}
    .kpi-card.red::before{background:linear-gradient(90deg,#ef4444,#f87171);}
    .kpi-card.teal::before{background:linear-gradient(90deg,#14b8a6,#2dd4bf);}
    .kpi-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;margin-bottom:12px;}
    .kpi-card.blue .kpi-icon{background:#eff6ff;}
    .kpi-card.green .kpi-icon{background:#f0fdf4;}
    .kpi-card.orange .kpi-icon{background:#fffbeb;}
    .kpi-card.purple .kpi-icon{background:#eef2ff;}
    .kpi-card.red .kpi-icon{background:#fef2f2;}
    .kpi-card.teal .kpi-icon{background:#f0fdfa;}
    .kpi-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:5px;}
    .kpi-value{font-size:21px;font-weight:800;color:var(--text);margin-bottom:6px;letter-spacing:-0.5px;}
    .kpi-value.positive{color:var(--green);}
    .kpi-value.negative{color:var(--red);}
    .kpi-value.empty{color:#d1d5db;}
    .kpi-sub{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px;}
    .kpi-sub .up{color:var(--green);}
    .kpi-sub .down{color:var(--red);}
    .kpi-sub .neutral{color:var(--muted);}

    /* PROGRESS BAR */
    .kpi-progress{margin-top:10px;}
    .kpi-progress-bar{height:4px;background:#e2e8f0;border-radius:99px;overflow:hidden;}
    .kpi-progress-fill{height:100%;border-radius:99px;transition:width 1s ease;}
    .kpi-progress-label{font-size:10px;color:var(--muted);margin-top:4px;}

    /* CHARTS */
    .charts-grid{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-bottom:24px;}
    .charts-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;margin-bottom:24px;}
    .chart-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:22px;}
    .chart-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;}
    .chart-title{font-size:14px;font-weight:700;color:var(--text);}
    .chart-sub{font-size:11px;color:var(--muted);margin-top:2px;}
    .chart-tag{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;}
    .tag-blue{background:var(--blue-ghost);color:var(--blue-main);}
    .tag-live{background:#f0fdf4;color:#10b981;}
    .tag-orange{background:#fffbeb;color:#f59e0b;}
    .chart-wrap{position:relative;}
    .chart-wrap.h200{height:200px;}
    .chart-wrap.h220{height:220px;}

    /* TABLE */
    .table-card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .table-head{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
    .table-title{font-size:13px;font-weight:700;}
    table{width:100%;border-collapse:collapse;}
    th{padding:9px 18px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;background:#f8faff;border-bottom:1px solid var(--border);}
    td{padding:11px 18px;font-size:12px;border-bottom:1px solid #f8f9fa;}
    tr:last-child td{border-bottom:none;}
    .td-pos{color:var(--green);font-weight:700;}
    .td-neg{color:var(--red);font-weight:700;}
    .td-muted{color:var(--muted);}
    .status-pill{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:600;padding:3px 9px;border-radius:20px;}
    .sp-empty{background:#f3f4f6;color:var(--muted);}
    .sp-ok{background:#f0fdf4;color:#10b981;}
    .sp-warn{background:#fffbeb;color:#f59e0b;}
    .sp-bad{background:#fef2f2;color:#ef4444;}

    /* LOADER */
    .loader{display:flex;align-items:center;justify-content:center;min-height:400px;color:var(--muted);gap:10px;font-size:13px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--blue-main);border-radius:50%;animation:spin .7s linear infinite;}

    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .content{animation:fadeIn 0.3s ease both;}
  .ucard:hover{background:rgba(255,255,255,.12);transform:translateY(-1px);transition:.15s}


/* â”€â”€ MOBILE UNIQUEMENT â”€â”€ */






/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘   ALTEORE â€” RESPONSIVE MOBILE (iPhone/Android)  â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* 1. RESET global overflow */
html, body { overflow-x: hidden; max-width: 100vw; }

/* 2. HAMBURGER â€” masquÃ© par dÃ©faut */
.hamburger {
  display: none;
  position: fixed;
  top: 14px; left: 14px;
  z-index: 1001;
  width: 44px; height: 44px;
  background: #0f1f5c;
  border: none; border-radius: 12px;
  cursor: pointer;
  flex-direction: column;
  align-items: center; justify-content: center;
  gap: 5px;
  box-shadow: 0 4px 16px rgba(15,31,92,.45);
  -webkit-tap-highlight-color: transparent;
  transition: background .2s;
}
.hamburger:active { background: #1a3dce; }
.hamburger span {
  display: block; width: 20px; height: 2.5px;
  background: #fff; border-radius: 2px;
  transition: all .25s ease;
  pointer-events: none;
}
.hamburger.open span:nth-child(1) { transform: translateY(7.5px) rotate(45deg); }
.hamburger.open span:nth-child(2) { opacity: 0; transform: scaleX(0); }
.hamburger.open span:nth-child(3) { transform: translateY(-7.5px) rotate(-45deg); }

/* 3. OVERLAY */
.nav-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.5); z-index: 1000;
  -webkit-tap-highlight-color: transparent;
}
.nav-overlay.show { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MOBILE â‰¤768px â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {

  /* HAMBURGER visible */
  .hamburger { display: flex !important; }

  /* SIDEBAR / NAV â†’ drawer */
  nav, aside.sidebar, .sidebar {
    position: fixed !important;
    top: 0 !important; left: 0 !important;
    height: 100vh !important;
    height: -webkit-fill-available !important;
    width: min(280px, 84vw) !important;
    z-index: 1001 !important;
    transform: translateX(-105%) !important;
    transition: transform .3s cubic-bezier(.4,0,.2,1) !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
    margin: 0 !important;
    box-sizing: border-box !important;
  }
  nav.open, aside.sidebar.open, .sidebar.open {
    transform: translateX(0) !important;
    box-shadow: 8px 0 32px rgba(0,0,0,.3) !important;
  }

  /* MAIN CONTENT â†’ pleine largeur */
  .main, main, div.main, .main-content {
    margin-left: 0 !important;
    width: 100vw !important;
    overflow-x: hidden !important;
    box-sizing: border-box !important;
  }

  /* TOPBAR */
  .topbar {
    padding: 10px 10px 10px 62px !important;
    flex-wrap: wrap !important;
    gap: 6px !important;
    position: sticky !important;
    top: 0 !important; z-index: 50 !important;
    background: #fff !important;
    box-shadow: 0 1px 6px rgba(0,0,0,.08) !important;
    box-sizing: border-box !important;
    width: 100% !important;
  }
  .topbar h1, .topbar-left h1, .topbar-left h2 { font-size: 14px !important; }
  .topbar p, .topbar-left p { font-size: 10px !important; }
  .topbar-right, .tb-r {
    width: 100% !important;
    flex-wrap: wrap !important;
    gap: 6px !important;
  }
  .topbar-right .btn, .tb-r .btn,
  .topbar-right button, .tb-r button {
    flex: 1 1 auto !important;
    font-size: 11px !important;
    padding: 7px 8px !important;
    min-height: 36px !important;
    white-space: nowrap !important;
    min-width: 0 !important;
  }

  /* PAGE / CONTENT */
  .content, .page {
    padding: 12px 10px !important;
    overflow-x: hidden !important;
    width: 100% !important;
    box-sizing: border-box !important;
    gap: 12px !important;
  }
  .content > *, .page > * {
    box-sizing: border-box !important;
    max-width: 100% !important;
  }

  /* â”€â”€ TOUTES LES GRILLES â†’ 1 COLONNE â”€â”€ */
  /* Dashboard */
  .kpi-grid-4, .kpi-grid-5 { grid-template-columns: 1fr 1fr !important; gap: 8px !important; margin-bottom: 12px !important; }
  .charts-grid, .charts-grid-3 { grid-template-columns: 1fr !important; gap: 12px !important; }
  /* Suivi CA */
  .kpi-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .charts-grid-2 { grid-template-columns: 1fr !important; gap: 12px !important; }
  /* CoÃ»t de revient */
  .fiche-kpis { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .prix-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  /* Marges */
  .decomp-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .cle-grid { grid-template-columns: 1fr !important; gap: 8px !important; }
  .cle-inputs { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .sim-levers { grid-template-columns: 1fr !important; gap: 8px !important; }
  .sim-result-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .modal-row { grid-template-columns: 1fr !important; gap: 8px !important; }
  /* Pilotage */
  .summary-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; margin-bottom: 12px !important; }
  .sections-grid { grid-template-columns: 1fr !important; gap: 12px !important; }
  .tva-result { grid-template-columns: 1fr !important; gap: 8px !important; }
  .cashflow-grid { grid-template-columns: 1fr !important; gap: 8px !important; }
  /* Panier moyen */
  .fields-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .results-row { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .g2, .g3 { grid-template-columns: 1fr !important; gap: 12px !important; }
  .cats { grid-template-columns: 1fr !important; gap: 10px !important; }
  .sim-g { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .sim-rg { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  /* Dettes */
  .detail-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .mgrid2 { grid-template-columns: 1fr !important; gap: 10px !important; }
  /* Profil */
  .plan-grid { grid-template-columns: 1fr !important; gap: 12px !important; }
  /* Universels */
  .kpi-row { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .type-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .fact-kpis { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .calendar-grid { grid-template-columns: repeat(4, 1fr) !important; gap: 5px !important; }

  /* â”€â”€ KPI CARDS â€” texte lisible â”€â”€ */
  .kpi-card, .kpi, .summary-card, .fkpi {
    padding: 12px 10px !important;
    overflow: hidden !important;
    min-width: 0 !important;
  }
  .kpi-value, .kpi-val, .summary-value { font-size: 16px !important; letter-spacing: -0.3px !important; }
  .kpi-label, .kpi-lbl, .summary-label { font-size: 9px !important; line-height: 1.3 !important; }
  .kpi-sub { font-size: 10px !important; }

  /* â”€â”€ TABLEAUX â€” scroll interne propre â”€â”€ */
  .echeancier-wrap,
  div[style*="overflow-x"],
  .section-body, .section-content,
  .table-wrap, .table-card, .table-container,
  .card > div { overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; }
  table { min-width: 460px !important; font-size: 11px !important; }
  
  /* â”€â”€ INPUTS TOUCH (Ã©vite zoom iOS) â”€â”€ */
  input[type=text], input[type=number], input[type=email],
  input[type=date], input[type=tel], input[type=password],
  select, textarea {
    font-size: 16px !important;
    -webkit-appearance: none !important;
  }
  .field-wrap, .mfield-wrap, .sim-fw {
    min-height: 46px !important;
    padding: 10px 12px !important;
  }

  /* â”€â”€ BOUTONS â”€â”€ */
  .btn { min-height: 40px !important; }
  .btn-xs, .btn-sm { min-height: 34px !important; }

  /* â”€â”€ PILOTAGE SUMMARY CARDS â”€â”€ */
  .summary-card .kpi-value,
  .summary-card .summary-value { white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }
  .summary-card .kpi-sub,
  .summary-card .summary-sub { white-space: normal !important; font-size: 10px !important; }

  /* â”€â”€ SECTION HEAD â”€â”€ */
  .section-head { flex-wrap: wrap !important; gap: 6px !important; padding: 10px 12px !important; }
  .section-head .btn, .section-head button { font-size: 10px !important; padding: 4px 8px !important; }

  /* â”€â”€ MONTH STRIP (panier moyen) â”€â”€ */
  .month-strip { overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; flex-wrap: nowrap !important; padding-bottom: 6px !important; }
  .mbtn { flex-shrink: 0 !important; }

  /* â”€â”€ YEAR BAR â”€â”€ */
  .yr-bar { overflow-x: auto !important; flex-wrap: nowrap !important; -webkit-overflow-scrolling: touch !important; }
  .yr { flex-shrink: 0 !important; }

  /* â”€â”€ TABS â”€â”€ */
  .tabs { overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; flex-wrap: nowrap !important; width: 100% !important; }
  .tab { flex-shrink: 0 !important; white-space: nowrap !important; }

  /* â”€â”€ DETTE CARDS â”€â”€ */
  .dette-head { flex-wrap: wrap !important; gap: 8px !important; }
  .dette-stats { flex-direction: column !important; align-items: flex-start !important; gap: 4px !important; }

  /* â”€â”€ SAISIE (panier) â”€â”€ */
  .saisie-head { flex-direction: column !important; gap: 8px !important; align-items: flex-start !important; }

  /* â”€â”€ HERO (profil) â”€â”€ */
  .hero { flex-direction: column !important; text-align: center !important; padding: 16px !important; gap: 12px !important; }
  .hero-right { text-align: center !important; }
  .hero-tags { justify-content: center !important; }
  .hero-name { font-size: 17px !important; }

  /* â”€â”€ MODAL â†’ bottom sheet â”€â”€ */
  .overlay, .modal-overlay { align-items: flex-end !important; padding: 0 !important; }
  .modal {
    width: 100% !important; max-width: 100% !important;
    margin: 0 !important;
    border-radius: 18px 18px 0 0 !important;
    max-height: 92vh !important;
  }

  /* â”€â”€ CANVAS â”€â”€ */
  canvas { max-width: 100% !important; }

  /* â”€â”€ CONTEXT BAR (dashboard) â”€â”€ */
  .context-bar { flex-wrap: wrap !important; gap: 8px !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PETIT MOBILE â‰¤420px â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 420px) {
  .kpi-grid-4, .kpi-grid-5, .kpi-grid, .kpi-row,
  .fiche-kpis, .summary-grid, .fact-kpis,
  .type-grid, .results-row, .sim-g { grid-template-columns: 1fr !important; }
  .sim-rg, .sim-result-grid, .cle-inputs { grid-template-columns: 1fr !important; }
  .calendar-grid { grid-template-columns: repeat(3, 1fr) !important; }
}


    .nav-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 20px 4px}
</style>
</head>
<body>
  <button class="hamburger" id="hamburger" onclick="toggleSidebar()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
  <div class="nav-overlay" id="navOverlay" onclick="closeSidebar()"></div>
<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon">ğŸ“Š</div>
    <div class="sidebar-logo-text">ALTEORE</div>
  </div>
  <div class="sidebar-section-label">Principal</div>
  <div class="nav-item active"><span class="nav-icon">ğŸ </span><span class="nav-label">Tableau de bord</span><span class="nav-badge">Live</span></div>
  <div class="nav-item" onclick="window.location.href='suivi-ca.html'"><span class="nav-icon">ğŸ“ˆ</span><span class="nav-label">Suivi CA & RÃ©sultats</span></div>
  <div class="nav-item" id="kpis-nav"><span class="nav-icon">ğŸ¯</span><span class="nav-label" onclick="toggleMenu('kpis-menu',document.getElementById('kpis-nav'))">KPIs ClÃ©s</span><span class="nav-chevron" onclick="toggleMenu('kpis-menu',document.getElementById('kpis-nav'))">â€º</span></div>
  <div class="submenu open" id="kpis-menu">
    <div class="sub-item" onclick="window.location.href='cout-revient.html'"><span class="sub-dot"></span>CoÃ»t de revient</div>
    <div class="sub-item" onclick="window.location.href='marges.html'"><span class="sub-dot"></span>Marge brute & nette</div>
    <div class="sub-item" onclick="window.location.href='panier-moyen.html'"><span class="sub-dot"></span>Panier moyen</div>
  </div>
  <div class="nav-item" onclick="toggleMenu('pilotage-menu',this)"><span class="nav-icon">ğŸ§­</span><span class="nav-label">Pilotage</span><span class="nav-chevron">â€º</span></div>
  <div class="submenu" id="pilotage-menu">
    <div class="sub-item" onclick="window.location.href='pilotage.html?year=2025'"><span class="sub-dot"></span>Pilotage 2025<span class="sub-year-badge">2025</span></div>
    <div class="sub-item" onclick="window.location.href='pilotage.html?year=2026'"><span class="sub-dot"></span>Pilotage 2026<span class="sub-year-badge">2026</span></div>
    <div class="sub-item" onclick="window.location.href='pilotage.html?year=2027'"><span class="sub-dot"></span>Pilotage 2027<span class="sub-year-badge">2027</span></div>
  </div>
  <div class="nav-item" onclick="location.href='dettes.html'"><span class="nav-icon">ğŸ¦</span><span class="nav-label">Dettes &amp; Emprunts</span></div>
  <div class="nav-section-label">FidÃ©lisation</div>
  <div class="nav-item" onclick="toggleFidNav(this)" style="justify-content:space-between">
    <span style="display:flex;align-items:center;gap:8px"><span class="nav-icon">ğŸ’</span><span class="nav-label">FidÃ©lisation</span></span>
    <span class="nav-chev" style="font-size:11px;color:rgba(255,255,255,.3);transition:transform .25s">â€º</span>
  </div>
  <div class="nav-fid-sub" style="overflow:hidden;max-height:0;transition:max-height .35s ease">
    <div class="nav-sub-item" onclick="location.href='fidelisation.html'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Dashboard fidÃ©litÃ©</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#clients'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Clients</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#carte'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Carte fidÃ©litÃ©</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#points'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Points & RÃ©compenses</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#coupons'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Coupons & Offres</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#campagnes'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Campagnes</div>
  </div>
  <div class="nav-item" onclick="location.href='import.html'" style="border-top:1px solid rgba(255,255,255,.08);padding-top:10px"><span class="nav-icon">ğŸ“¥</span><span class="nav-label">Import de donnÃ©es</span></div>
  <div class="sidebar-footer">
    <div class="user-card" onclick="location.href='profil.html'" style="cursor:pointer;transition:.15s" title="Mon compte">
      <div class="user-avatar" id="userAvatar">A</div>
      <div><div class="user-name" id="userName">Utilisateur</div><div class="user-plan">Plan gratuit</div></div>
      <button class="logout-btn" onclick="handleLogout()">â‹</button>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1 id="pageTitle">Tableau de bord</h1>
      <p id="pageDate"></p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline" onclick="loadData()">ğŸ”„ Actualiser</button>
      <button class="btn btn-primary" onclick="window.location.href='pilotage.html'">+ Saisir des donnÃ©es</button>
    </div>
  </div>
  <div class="content" id="mainContent">
    <div class="loader"><div class="spin"></div>Chargement des donnÃ©es...</div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"alteore-70599.firebaseapp.com",
    projectId:"alteore-70599",
    storageBucket:"alteore-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth=getAuth(app);
  const db=getFirestore(app);
  window._auth=auth;window._db=db;window._doc=doc;window._getDoc=getDoc;window._signOut=signOut;
  onAuthStateChanged(auth,user=>{
    if(!user){window.location.href='index.html';return;}
    window._uid=user.uid;
    const name=user.displayName||user.email.split('@')[0];
    document.getElementById('userName').textContent=name;
    document.getElementById('userAvatar').textContent=name.charAt(0).toUpperCase();
    window._firebaseReady = true;
    window.loadData();
  });
</script>

<script>
const MONTHS=['Janvier','FÃ©vrier','Mars','Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'];
const MONTHS_SHORT=['Jan','FÃ©v','Mar','Avr','Mai','Jun','Jul','AoÃ»','Sep','Oct','Nov','DÃ©c'];
let _charts=[];

document.getElementById('pageDate').textContent=new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

function toggleMenu(id,el){document.getElementById(id).classList.toggle('open');el.classList.toggle('open');}
async function handleLogout(){await window._signOut(window._auth);window.location.href='index.html';}

function extractMonthData(d){
  if(!d)return{caHT:0,caTTC:0,tvaCollectee:0,rentrees:0,prevCA:0,fixesHT:0,varHT:0,creditsHT:0,leasingHT:0,chargesHT:0,resultat:0,cashflow:0};
  const caHT=d.ca?d.ca.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0):0;
  const caTTC=d.ca?d.ca.reduce((s,r)=>{const h=parseFloat(r.montantHT)||0;return s+h*(1+(r.tvaRate||0)/100);},0):0;
  const tvaCollectee=d.ca?d.ca.reduce((s,r)=>{const h=parseFloat(r.montantHT)||0;return s+h*(r.tvaRate||0)/100;},0):0;
  const rentrees=d.rentreesSupp?d.rentreesSupp.reduce((s,r)=>s+(parseFloat(r.montant)||0),0):0;
  const prevCA=d.previsionCA?d.previsionCA.reduce((s,r)=>s+(parseFloat(r.montant)||0),0):0;
  const fixesHT=d.chargesFixe?d.chargesFixe.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0):0;
  const varHT=d.chargesVar?d.chargesVar.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0):0;
  const leasingHT=d.leasing?d.leasing.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0):0;
  let creditsHT=0;
  if(d.credits)d.credits.forEach((r,i)=>{
    if(r.ligneType==='principal')creditsHT+=parseFloat(r.montant)||0;
    else{let mt=parseFloat(r.montant)||0;if(r.tvaAuto&&parseFloat(r.tauxInteret)>0){const p=d.credits.slice(0,i).reverse().find(c=>c.fournisseur===r.fournisseur&&c.ligneType==='principal');if(p)mt=(parseFloat(p.montant)||0)*parseFloat(r.tauxInteret)/100/12;}creditsHT+=mt;}
  });
  const chargesHT=fixesHT+varHT+creditsHT+leasingHT;
  const resultat=caHT+rentrees-chargesHT;
  const cashflow=caTTC+rentrees-(fixesHT*(1+0.2)+varHT*(1+0.2)+creditsHT+leasingHT*(1+0.2));
  return{caHT,caTTC,tvaCollectee,rentrees,prevCA,fixesHT,varHT,creditsHT,leasingHT,chargesHT,resultat,cashflow};
}

async function loadData(){
  if(!window._uid){setTimeout(loadData,500);return;}
  const now=new Date();
  const year=now.getFullYear();
  const currentM=now.getMonth();

  // Load current month + all year
  const allMonths=[];
  for(let m=0;m<12;m++){
    const key=`${year}-${String(m+1).padStart(2,'0')}`;
    try{
      const snap=await window._getDoc(window._doc(window._db,'pilotage',window._uid,'months',key));
      allMonths.push(snap.exists()?snap.data():null);
    }catch(e){allMonths.push(null);}
  }

  const monthsData=allMonths.map(d=>extractMonthData(d));
  const current=monthsData[currentM];
  const prevMonthData=currentM>0?monthsData[currentM-1]:{caHT:0,chargesHT:0,resultat:0};

  // Annual totals
  const annualCA=monthsData.reduce((s,d)=>s+d.caHT,0);
  const annualCharges=monthsData.reduce((s,d)=>s+d.chargesHT,0);
  const annualResultat=monthsData.reduce((s,d)=>s+d.resultat,0);
  const annualCashflow=monthsData.reduce((s,d)=>s+d.cashflow,0);

  // Destroy old charts
  _charts.forEach(c=>{try{c.destroy();}catch(e){}});
  _charts=[];

  const hasCurrentData=current.caHT>0||current.chargesHT>0;
  const hasAnnualData=annualCA>0||annualCharges>0;

  // Variation vs mois prÃ©cÃ©dent
  const varCA=prevMonthData.caHT>0?((current.caHT-prevMonthData.caHT)/prevMonthData.caHT*100):null;
  const varCharges=prevMonthData.chargesHT>0?((current.chargesHT-prevMonthData.chargesHT)/prevMonthData.chargesHT*100):null;

  // Taux marge brute
  const txMarge=current.caHT>0?((current.caHT-current.chargesHT)/current.caHT*100):null;
  const txMargeAnnuel=annualCA>0?((annualCA-annualCharges)/annualCA*100):null;

  // Point mort
  const pointMort=current.caHT>0?(current.chargesHT):null;

  document.getElementById('mainContent').innerHTML=`

    <!-- CONTEXT BAR -->
    <div class="context-bar">
      <div class="context-month">
        <span class="context-pill"><span class="dot"></span>DonnÃ©es en direct Â· ${MONTHS[currentM]} ${year}</span>
        ${!hasCurrentData?'<span class="last-update" style="color:#f59e0b;margin-left:8px;">âš ï¸ Aucune donnÃ©e saisie pour ce mois â€” <a href="pilotage.html" style="color:var(--blue-main);font-weight:600;">Saisir dans le Pilotage</a></span>':''}
      </div>
      <span class="last-update">AnnÃ©e ${year} Â· ${monthsData.filter(d=>d.caHT>0||d.chargesHT>0).length} mois renseignÃ©s</span>
    </div>

    <!-- KPIs MOIS EN COURS -->
    <div class="section-label">ğŸ“… Mois en cours â€” ${MONTHS[currentM]} ${year}</div>
    <div class="kpi-grid-4">
      <div class="kpi-card blue">
        <div class="kpi-icon">ğŸ’°</div>
        <div class="kpi-label">CA HT</div>
        <div class="kpi-value ${!hasCurrentData?'empty':''}">${hasCurrentData?fmtE(current.caHT):'â€” â‚¬'}</div>
        <div class="kpi-sub">
          ${varCA!==null?`<span class="${varCA>=0?'up':'down'}">${varCA>=0?'â–²':'â–¼'} ${Math.abs(varCA).toFixed(1)}% vs mois prÃ©c.</span>`:'<span class="neutral">TTC : '+fmtE(current.caTTC)+'</span>'}
        </div>
        ${current.prevCA>0?`<div class="kpi-progress"><div class="kpi-progress-bar"><div class="kpi-progress-fill" style="width:${Math.min(current.caHT/current.prevCA*100,100).toFixed(0)}%;background:var(--blue-main)"></div></div><div class="kpi-progress-label">${(current.caHT/current.prevCA*100).toFixed(0)}% de l'objectif (${fmtE(current.prevCA)})</div></div>`:''}
      </div>
      <div class="kpi-card orange">
        <div class="kpi-icon">ğŸ§¾</div>
        <div class="kpi-label">Charges totales HT</div>
        <div class="kpi-value ${!hasCurrentData?'empty':''}">${hasCurrentData?fmtE(current.chargesHT):'â€” â‚¬'}</div>
        <div class="kpi-sub">
          ${varCharges!==null?`<span class="${varCharges<=0?'up':'down'}">${varCharges<=0?'â–¼':'â–²'} ${Math.abs(varCharges).toFixed(1)}% vs mois prÃ©c.</span>`:`<span class="neutral">Fixes ${fmtE(current.fixesHT)} Â· Var. ${fmtE(current.varHT)}</span>`}
        </div>
      </div>
      <div class="kpi-card ${!hasCurrentData?'green':current.resultat>=0?'green':'red'}">
        <div class="kpi-icon">ğŸ“Š</div>
        <div class="kpi-label">RÃ©sultat HT</div>
        <div class="kpi-value ${!hasCurrentData?'empty':current.resultat>=0?'positive':'negative'}">${hasCurrentData?fmtE(current.resultat):'â€” â‚¬'}</div>
        <div class="kpi-sub"><span class="neutral">CA âˆ’ DÃ©penses du mois</span></div>
      </div>
      <div class="kpi-card purple">
        <div class="kpi-icon">ğŸ¦</div>
        <div class="kpi-label">TVA Ã  dÃ©clarer</div>
        <div class="kpi-value ${!hasCurrentData?'empty':''}">${hasCurrentData?fmtE(current.tvaCollectee):'â€” â‚¬'}</div>
        <div class="kpi-sub"><span class="neutral">TVA collectÃ©e sur ventes</span></div>
      </div>
    </div>

    <!-- KPIs ANNUELS -->
    <div class="section-label">ğŸ“† Cumul annuel â€” ${year}</div>
    <div class="kpi-grid-5">
      <div class="kpi-card blue">
        <div class="kpi-icon">ğŸ’¼</div>
        <div class="kpi-label">CA Annuel HT</div>
        <div class="kpi-value ${!hasAnnualData?'empty':''}">${hasAnnualData?fmtE(annualCA):'â€” â‚¬'}</div>
        <div class="kpi-sub"><span class="neutral">Cumul ${year}</span></div>
      </div>
      <div class="kpi-card orange">
        <div class="kpi-icon">ğŸ“‰</div>
        <div class="kpi-label">Charges annuelles HT</div>
        <div class="kpi-value ${!hasAnnualData?'empty':''}">${hasAnnualData?fmtE(annualCharges):'â€” â‚¬'}</div>
        <div class="kpi-sub"><span class="neutral">Fixes + Var + CrÃ©dits + Leasing</span></div>
      </div>
      <div class="kpi-card ${!hasAnnualData?'green':annualResultat>=0?'green':'red'}">
        <div class="kpi-icon">ğŸ¯</div>
        <div class="kpi-label">RÃ©sultat annuel HT</div>
        <div class="kpi-value ${!hasAnnualData?'empty':annualResultat>=0?'positive':'negative'}">${hasAnnualData?fmtE(annualResultat):'â€” â‚¬'}</div>
        <div class="kpi-sub"><span class="neutral">CA âˆ’ Total Charges</span></div>
      </div>
      <div class="kpi-card teal">
        <div class="kpi-icon">ğŸ’¸</div>
        <div class="kpi-label">Cashflow annuel</div>
        <div class="kpi-value ${!hasAnnualData?'empty':annualCashflow>=0?'positive':'negative'}">${hasAnnualData?fmtE(annualCashflow):'â€” â‚¬'}</div>
        <div class="kpi-sub"><span class="neutral">Flux de trÃ©sorerie</span></div>
      </div>
      <div class="kpi-card ${txMargeAnnuel===null?'green':txMargeAnnuel>=30?'green':txMargeAnnuel>=10?'orange':'red'}">
        <div class="kpi-icon">ğŸ“</div>
        <div class="kpi-label">Taux de rÃ©sultat</div>
        <div class="kpi-value ${txMargeAnnuel===null?'empty':txMargeAnnuel>=0?'positive':'negative'}">${txMargeAnnuel!==null?txMargeAnnuel.toFixed(1)+'%':'â€” %'}</div>
        <div class="kpi-sub"><span class="neutral">RÃ©sultat / CA HT</span></div>
      </div>
    </div>

    <!-- GRAPHIQUES -->
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div><div class="chart-title">Ã‰volution CA & Charges â€” ${year}</div><div class="chart-sub">Comparaison mensuelle HT</div></div>
          <span class="chart-tag ${hasAnnualData?'tag-live':'tag-blue'}">${hasAnnualData?'â— Live':'Placeholder'}</span>
        </div>
        <div class="chart-wrap h220"><canvas id="caChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div><div class="chart-title">RÃ©partition des charges</div><div class="chart-sub">${MONTHS[currentM]} ${year}</div></div>
          <span class="chart-tag tag-orange">Mois</span>
        </div>
        <div class="chart-wrap h220"><canvas id="coutChart"></canvas></div>
      </div>
    </div>

    <div class="charts-grid-3">
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">RÃ©sultat mensuel HT</div><div class="chart-sub">Positif / NÃ©gatif par mois</div></div></div>
        <div class="chart-wrap h200"><canvas id="resultatChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">Cashflow mensuel</div><div class="chart-sub">Flux de trÃ©sorerie ${year}</div></div></div>
        <div class="chart-wrap h200"><canvas id="cashflowChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">Cumul CA vs DÃ©penses</div><div class="chart-sub">Ã‰volution cumulÃ©e ${year}</div></div></div>
        <div class="chart-wrap h200"><canvas id="cumulChart"></canvas></div>
      </div>
    </div>

    <!-- TABLE INDICATEURS -->
    <div class="table-card">
      <div class="table-head">
        <div class="table-title">ğŸ“‹ Indicateurs clÃ©s â€” ${MONTHS[currentM]} ${year}</div>
        <a href="pilotage.html" style="font-size:12px;color:var(--blue-main);font-weight:600;text-decoration:none;">âœï¸ Modifier dans le Pilotage â†’</a>
      </div>
      <table>
        <thead><tr><th>Indicateur</th><th>Valeur</th><th>DÃ©tail</th><th>Statut</th></tr></thead>
        <tbody>
          <tr>
            <td><b>CA HT</b></td>
            <td class="${current.caHT>0?'':'td-muted'}">${current.caHT>0?fmtE(current.caHT):'â€”'}</td>
            <td class="td-muted">TTC : ${fmtE(current.caTTC)}</td>
            <td><span class="status-pill ${current.caHT>0?'sp-ok':'sp-empty'}">${current.caHT>0?'âœ“ RenseignÃ©':'En attente'}</span></td>
          </tr>
          <tr>
            <td><b>Charges fixes</b></td>
            <td class="${current.fixesHT>0?'':'td-muted'}">${current.fixesHT>0?fmtE(current.fixesHT):'â€”'}</td>
            <td class="td-muted">PrÃ©visionnel mensuel</td>
            <td><span class="status-pill ${current.fixesHT>0?'sp-ok':'sp-empty'}">${current.fixesHT>0?'âœ“ RenseignÃ©':'En attente'}</span></td>
          </tr>
          <tr>
            <td><b>Charges variables</b></td>
            <td class="${current.varHT>0?'':'td-muted'}">${current.varHT>0?fmtE(current.varHT):'â€”'}</td>
            <td class="td-muted">Au fil de l'eau</td>
            <td><span class="status-pill ${current.varHT>0?'sp-ok':'sp-empty'}">${current.varHT>0?'âœ“ RenseignÃ©':'En attente'}</span></td>
          </tr>
          <tr>
            <td><b>Emprunts / CrÃ©dits</b></td>
            <td class="${current.creditsHT>0?'':'td-muted'}">${current.creditsHT>0?fmtE(current.creditsHT):'â€”'}</td>
            <td class="td-muted">Principal + IntÃ©rÃªts</td>
            <td><span class="status-pill ${current.creditsHT>0?'sp-ok':'sp-empty'}">${current.creditsHT>0?'âœ“ RenseignÃ©':'En attente'}</span></td>
          </tr>
          <tr>
            <td><b>RÃ©sultat HT</b></td>
            <td class="${current.caHT>0||current.chargesHT>0?(current.resultat>=0?'td-pos':'td-neg'):'td-muted'}">${current.caHT>0||current.chargesHT>0?fmtE(current.resultat):'â€”'}</td>
            <td class="td-muted">CA âˆ’ Total dÃ©penses</td>
            <td><span class="status-pill ${current.caHT>0||current.chargesHT>0?(current.resultat>=0?'sp-ok':'sp-bad'):'sp-empty'}">${current.caHT>0||current.chargesHT>0?(current.resultat>=0?'âœ“ Positif':'âš  NÃ©gatif'):'En attente'}</span></td>
          </tr>
          <tr>
            <td><b>Taux de rÃ©sultat</b></td>
            <td class="${txMarge!==null?(txMarge>=0?'td-pos':'td-neg'):'td-muted'}">${txMarge!==null?txMarge.toFixed(1)+'%':'â€”'}</td>
            <td class="td-muted">RÃ©sultat / CA HT</td>
            <td><span class="status-pill ${txMarge===null?'sp-empty':txMarge>=20?'sp-ok':txMarge>=5?'sp-warn':'sp-bad'}">${txMarge===null?'En attente':txMarge>=20?'âœ“ Bon':txMarge>=5?'âš  Moyen':'âš  Faible'}</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  `;

  buildCharts(monthsData,currentM,year,hasAnnualData);
}

function buildCharts(monthsData,currentM,year,hasAnnualData){
  const labels=MONTHS_SHORT;
  const caHT=monthsData.map(d=>d.caHT);
  const chargesHT=monthsData.map(d=>d.chargesHT);
  const resultats=monthsData.map(d=>d.resultat);
  const cashflows=monthsData.map(d=>d.cashflow);
  const current=monthsData[currentM];

  // Cumuls
  let cumCA=0,cumCh=0;
  const cumulDiff=monthsData.map(d=>{cumCA+=d.caHT;cumCh+=d.chargesHT;return cumCA-cumCh;});

  const font={size:11,family:'Plus Jakarta Sans'};
  const tick='#9ca3af';
  const grid='#f1f5f9';
  const baseScales={x:{grid:{display:false},ticks:{font,color:tick}},y:{grid:{color:grid},ticks:{font,color:tick,callback:v=>fmtK(v)}}};

  // CA vs Charges
  const c1ctx=document.getElementById('caChart').getContext('2d');
  const gCA=c1ctx.createLinearGradient(0,0,0,220);gCA.addColorStop(0,'rgba(26,61,206,0.15)');gCA.addColorStop(1,'rgba(26,61,206,0)');
  const c1=new Chart(c1ctx,{type:'bar',data:{labels,datasets:[
    {label:'CA HT',data:caHT,backgroundColor:'rgba(26,61,206,0.8)',borderRadius:5,order:2},
    {label:'Charges HT',data:chargesHT,backgroundColor:'rgba(245,158,11,0.7)',borderRadius:5,order:2},
    {label:'RÃ©sultat',data:resultats,type:'line',borderColor:resultats.map(v=>v>=0?'#10b981':'#ef4444'),borderWidth:0,pointRadius:4,pointBackgroundColor:resultats.map(v=>v>=0?'#10b981':'#ef4444'),fill:false,tension:0.4,order:1}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font,color:'#6b7280',padding:10,boxWidth:10}}},scales:baseScales}});
  _charts.push(c1);

  // Doughnut charges
  const hasCharges=current.fixesHT>0||current.varHT>0||current.creditsHT>0||current.leasingHT>0;
  const c2=new Chart(document.getElementById('coutChart'),{type:'doughnut',data:{
    labels:['Charges fixes','Charges var.','Emprunts','Leasing'],
    datasets:[{data:hasCharges?[current.fixesHT,current.varHT,current.creditsHT,current.leasingHT]:[1,1,1,1],backgroundColor:['#1a3dce','#4f7ef8','#f59e0b','#10b981'],borderWidth:0,hoverOffset:6}]
  },options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{font,color:'#6b7280',padding:10,boxWidth:10}}}}});
  _charts.push(c2);

  // RÃ©sultat mensuel
  const c3=new Chart(document.getElementById('resultatChart'),{type:'bar',data:{labels,datasets:[{label:'RÃ©sultat HT',data:resultats,backgroundColor:resultats.map(v=>v>0?'rgba(16,185,129,0.8)':v<0?'rgba(239,68,68,0.8)':'rgba(209,213,219,0.5)'),borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:baseScales}});
  _charts.push(c3);

  // Cashflow
  const c4=new Chart(document.getElementById('cashflowChart'),{type:'bar',data:{labels,datasets:[{label:'Cashflow',data:cashflows,backgroundColor:cashflows.map(v=>v>0?'rgba(99,102,241,0.8)':v<0?'rgba(239,68,68,0.7)':'rgba(209,213,219,0.5)'),borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:baseScales}});
  _charts.push(c4);

  // Cumul
  const c5ctx=document.getElementById('cumulChart').getContext('2d');
  const gC=c5ctx.createLinearGradient(0,0,0,200);gC.addColorStop(0,'rgba(99,102,241,0.2)');gC.addColorStop(1,'rgba(99,102,241,0)');
  const c5=new Chart(c5ctx,{type:'line',data:{labels,datasets:[{label:'Cumul CAâˆ’Charges',data:cumulDiff,borderColor:'#6366f1',borderWidth:2.5,backgroundColor:gC,fill:true,tension:0.4,pointRadius:3,pointBackgroundColor:cumulDiff.map(v=>v>=0?'#10b981':'#ef4444')}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:baseScales}});
  _charts.push(c5);
}

function fmtE(n){return (parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' â‚¬';}
function fmtK(v){const n=parseFloat(v)||0;return Math.abs(n)>=1000?(n/1000).toFixed(1)+'kâ‚¬':n.toFixed(0)+'â‚¬';}

window.loadData=loadData;
// Auto-open menus based on current page
(function(){
  const page = window.location.pathname.split('/').pop();
  if(['cout-revient.html','marges.html'].includes(page)){
    document.getElementById('kpis-menu').classList.add('open');
    document.getElementById('kpis-nav').classList.add('open');
  }
  if(['pilotage.html'].includes(page)){
    document.getElementById('pilotage-menu').classList.add('open');
  }
  // Always open kpis menu so sub-items are reachable
  document.getElementById('kpis-menu').classList.add('open');
  document.getElementById('kpis-nav').classList.add('open');
})();
window.toggleMenu=toggleMenu;
window.handleLogout=handleLogout;
</script>

<script>
function toggleNav(subId, el) {
  const sub = document.getElementById(subId);
  const isOpen = sub.classList.contains('open');
  sub.classList.toggle('open');
  // rotate chevron
  const chevId = subId === 'kpis-sub' ? 'chev-kpis' : 'chev-pil';
  const chev = document.getElementById(chevId);
  if (chev) chev.style.transform = isOpen ? '' : 'rotate(90deg)';
}
function activatePage(pageId, openSub) {
  const el = document.getElementById(pageId);
  if (el) el.classList.add('on');
  if (openSub) {
    const sub = document.getElementById(openSub);
    if (sub) sub.classList.add('open');
    const chevId = openSub === 'kpis-sub' ? 'chev-kpis' : 'chev-pil';
    const chev = document.getElementById(chevId);
    if (chev) chev.style.transform = 'rotate(90deg)';
  }
}
</script>
<script>document.addEventListener('DOMContentLoaded',()=>activatePage('nav-dashboard',null));</script>



<script>
(function(){
  function toggleSidebar(){
    var nav = document.querySelector('nav, aside.sidebar, .sidebar');
    var btn = document.getElementById('hamburger');
    var overlay = document.getElementById('navOverlay');
    var isOpen = nav.classList.contains('open');
    if(isOpen){ closeSidebar(); return; }
    nav.classList.add('open');
    btn.classList.add('open');
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
  function closeSidebar(){
    var nav = document.querySelector('nav, aside.sidebar, .sidebar');
    var btn = document.getElementById('hamburger');
    var overlay = document.getElementById('navOverlay');
    nav.classList.remove('open');
    btn.classList.remove('open');
    overlay.classList.remove('show');
    document.body.style.overflow = '';
  }
  window.toggleSidebar = toggleSidebar;
  window.closeSidebar = closeSidebar;
  document.addEventListener('DOMContentLoaded', function(){
    var nav = document.querySelector('nav, aside.sidebar, .sidebar');
    if(!nav) return;
    nav.querySelectorAll('.ni, .si, .nav-item, .sub-item').forEach(function(el){
      el.addEventListener('click', function(){
        if(window.innerWidth <= 768) closeSidebar();
      });
    });
  });
})();
</script>
<script>
(function(){
  function getSidebar(){ return document.querySelector('nav, aside.sidebar, .sidebar'); }
  function toggleSidebar(){
    var s=getSidebar(), b=document.getElementById('hamburger'), o=document.getElementById('navOverlay');
    var open=s.classList.contains('open');
    s.classList.toggle('open',!open); b.classList.toggle('open',!open);
    o.classList.toggle('show',!open);
    document.body.style.overflow = open ? '' : 'hidden';
  }
  function closeSidebar(){
    var s=getSidebar(), b=document.getElementById('hamburger'), o=document.getElementById('navOverlay');
    s.classList.remove('open'); b.classList.remove('open'); o.classList.remove('show');
    document.body.style.overflow='';
  }
  window.toggleSidebar=toggleSidebar; window.closeSidebar=closeSidebar;
  document.addEventListener('DOMContentLoaded',function(){
    var s=getSidebar(); if(!s) return;
    s.querySelectorAll('.ni,.si,.nav-item,.sub-item').forEach(function(el){
      el.addEventListener('click',function(){ if(window.innerWidth<=768) closeSidebar(); });
    });
  });
})();
</script>
<script>
function toggleFidNav(el){
  var sub=el.nextElementSibling;
  var chev=el.querySelector('.nav-chev');
  var open=sub.style.maxHeight&&sub.style.maxHeight!=='0px';
  sub.style.maxHeight=open?'0px':'300px';
  if(chev)chev.style.transform=open?'':'rotate(90deg)';
}
</script>
</body>
</html>
