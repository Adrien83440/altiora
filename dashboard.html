<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE ‚Äî Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --blue-dark:#0f1f5c;--blue-main:#1a3dce;--blue-light:#4f7ef8;
      --blue-ghost:#f0f4ff;--white:#fff;--text:#1a1f36;--muted:#6b7280;
      --border:#e2e8f0;--bg:#f5f7ff;--sidebar-w:252px;--radius:14px;
      --green:#10b981;--orange:#f59e0b;--red:#ef4444;--purple:#6366f1;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;}

    /* SIDEBAR */
    .sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#0f1f5c 0%,#162366 100%);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;overflow-y:auto;}
    .sidebar-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 22px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:10px;}
    .sidebar-logo-icon{width:36px;height:36px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .sidebar-logo-text{font-size:18px;font-weight:800;color:white;letter-spacing:1px;}
    .sidebar-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,0.3);letter-spacing:1.2px;text-transform:uppercase;padding:14px 20px 5px;}
    .nav-item{display:flex;align-items:center;gap:11px;padding:10px 20px;color:rgba(255,255,255,0.6);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;user-select:none;}
    .nav-item:hover{color:white;background:rgba(255,255,255,0.06);}
    .nav-item.active{color:white;background:rgba(255,255,255,0.1);border-left-color:#4f7ef8;}
    .nav-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0;}
    .nav-label{flex:1;}
    .nav-badge{background:rgba(79,126,248,0.3);color:#a5b4fc;font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px;}
    .nav-chevron{font-size:11px;color:rgba(255,255,255,0.3);transition:transform 0.25s;margin-left:auto;}
    .nav-item.open .nav-chevron{transform:rotate(90deg);}
    .submenu{overflow:hidden;max-height:0;transition:max-height 0.3s ease;}
    .submenu.open{max-height:300px;}
    .sub-item{display:flex;align-items:center;gap:9px;padding:8px 20px 8px 44px;color:rgba(255,255,255,0.45);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;}
    .sub-item:hover{color:rgba(255,255,255,0.8);background:rgba(255,255,255,0.05);}
    .sub-item.active{color:white;background:rgba(79,126,248,0.15);border-left-color:rgba(79,126,248,0.6);}
    .sub-dot{width:5px;height:5px;background:rgba(255,255,255,0.3);border-radius:50%;flex-shrink:0;}
    .sub-item.active .sub-dot{background:#4f7ef8;}
    .sub-year-badge{margin-left:auto;font-size:10px;color:rgba(255,255,255,0.25);font-weight:600;}
    .sidebar-footer{margin-top:auto;padding:16px 20px 0;border-top:1px solid rgba(255,255,255,0.08);}
    .user-card{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.07);border-radius:10px;}
    .user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--blue-light),#6366f1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
    .user-name{font-size:12px;font-weight:600;color:white;}
    .user-plan{font-size:10px;color:rgba(255,255,255,0.4);}
    .logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:14px;padding:4px;}
    .logout-btn:hover{color:rgba(255,255,255,0.7);}

    /* MAIN */
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:18px;font-weight:700;}
    .topbar-left p{font-size:12px;color:var(--muted);margin-top:1px;}
    .topbar-right{display:flex;align-items:center;gap:12px;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;}
    .btn-primary{background:linear-gradient(135deg,var(--blue-main),var(--blue-light));color:white;box-shadow:0 3px 10px rgba(26,61,206,0.3);}
    .btn-outline{background:white;color:var(--blue-main);border:1.5px solid var(--border);}
    .btn-outline:hover{border-color:var(--blue-main);background:var(--blue-ghost);}
    .content{padding:24px 32px;flex:1;}

    /* CONTEXT BAR */
    .context-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
    .context-month{display:flex;align-items:center;gap:10px;}
    .context-pill{display:inline-flex;align-items:center;gap:6px;background:white;border:1px solid var(--border);border-radius:20px;padding:6px 14px;font-size:12px;font-weight:600;color:var(--text);}
    .context-pill .dot{width:8px;height:8px;background:var(--green);border-radius:50%;animation:pulse 2s infinite;}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
    .last-update{font-size:11px;color:var(--muted);}

    /* SECTION LABEL */
    .section-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
    .section-label::after{content:'';flex:1;height:1px;background:var(--border);}

    /* KPI GRIDS */
    .kpi-grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;}
    .kpi-grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:24px;}
    .kpi-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px;}
    .kpi-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;overflow:hidden;transition:box-shadow 0.2s,transform 0.2s;}
    .kpi-card:hover{box-shadow:0 6px 24px rgba(26,61,206,0.08);transform:translateY(-1px);}
    .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
    .kpi-card.blue::before{background:linear-gradient(90deg,var(--blue-main),var(--blue-light));}
    .kpi-card.green::before{background:linear-gradient(90deg,#10b981,#34d399);}
    .kpi-card.orange::before{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
    .kpi-card.purple::before{background:linear-gradient(90deg,#6366f1,#a5b4fc);}
    .kpi-card.red::before{background:linear-gradient(90deg,#ef4444,#f87171);}
    .kpi-card.teal::before{background:linear-gradient(90deg,#14b8a6,#2dd4bf);}
    .kpi-card.pink::before{background:linear-gradient(90deg,#ec4899,#f9a8d4);}
    .kpi-card.indigo::before{background:linear-gradient(90deg,#6366f1,#818cf8);}
    .kpi-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;margin-bottom:12px;}
    .kpi-card.blue .kpi-icon{background:#eff6ff;}
    .kpi-card.green .kpi-icon{background:#f0fdf4;}
    .kpi-card.orange .kpi-icon{background:#fffbeb;}
    .kpi-card.purple .kpi-icon{background:#eef2ff;}
    .kpi-card.red .kpi-icon{background:#fef2f2;}
    .kpi-card.teal .kpi-icon{background:#f0fdfa;}
    .kpi-card.pink .kpi-icon{background:#fdf2f8;}
    .kpi-card.indigo .kpi-icon{background:#eef2ff;}
    .kpi-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:5px;}
    .kpi-value{font-size:21px;font-weight:800;color:var(--text);margin-bottom:6px;letter-spacing:-0.5px;}
    .kpi-value.positive{color:var(--green);}
    .kpi-value.negative{color:var(--red);}
    .kpi-value.empty{color:#d1d5db;}
    .kpi-sub{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px;}
    .kpi-sub .up{color:var(--green);}
    .kpi-sub .down{color:var(--red);}
    .kpi-sub .neutral{color:var(--muted);}
    .kpi-progress{margin-top:10px;}
    .kpi-progress-bar{height:4px;background:#e2e8f0;border-radius:99px;overflow:hidden;}
    .kpi-progress-fill{height:100%;border-radius:99px;transition:width 1s ease;}
    .kpi-progress-label{font-size:10px;color:var(--muted);margin-top:4px;}

    /* WIDGET ROW */
    .widget-row{display:grid;grid-template-columns:1fr 1fr 1.6fr;gap:10px;margin-bottom:18px;align-items:stretch;}

    /* WEATHER CARD ‚Äî compact */
    .weather-card{background:linear-gradient(135deg,#1a3dce 0%,#3b5de8 100%);border-radius:var(--radius);padding:12px 14px;color:white;position:relative;overflow:hidden;display:flex;align-items:center;gap:12px;}
    .weather-card::before{content:'';position:absolute;top:-20px;right:-20px;width:90px;height:90px;background:rgba(255,255,255,0.07);border-radius:50%;}
    .w-icon{font-size:30px;line-height:1;flex-shrink:0;position:relative;z-index:1;}
    .w-info{flex:1;min-width:0;position:relative;z-index:1;}
    .w-city{font-size:10px;font-weight:600;opacity:0.7;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px;}
    .w-temprow{display:flex;align-items:baseline;gap:7px;}
    .w-temp{font-size:26px;font-weight:800;letter-spacing:-1px;line-height:1;}
    .w-feel{font-size:11px;opacity:0.65;}
    .w-bottom{display:flex;gap:10px;margin-top:4px;}
    .w-detail{font-size:10px;opacity:0.7;}

    /* QUOTE CARD ‚Äî compact */
    .quote-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;display:flex;flex-direction:column;justify-content:space-between;}
    .quote-header{display:flex;align-items:center;gap:6px;margin-bottom:7px;}
    .quote-tag{font-size:9px;font-weight:700;color:var(--blue-main);background:var(--blue-ghost);padding:2px 7px;border-radius:20px;text-transform:uppercase;letter-spacing:0.5px;}
    .quote-text{font-size:11.5px;font-weight:500;color:var(--text);line-height:1.5;font-style:italic;flex:1;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;}
    .quote-text::before{content:'"';font-size:18px;color:#c7d2fe;font-style:normal;line-height:0;vertical-align:-5px;margin-right:2px;}
    .quote-author{font-size:10px;font-weight:700;color:var(--muted);}

    /* NEWS CARD ‚Äî compact, 2 items */
    .news-card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .news-header{padding:9px 13px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
    .news-title{font-size:11.5px;font-weight:700;}
    .news-source{font-size:10px;color:var(--muted);}
    .news-list{padding:3px 0;}
    .news-item{padding:7px 13px;border-bottom:1px solid #f8faff;cursor:pointer;transition:background 0.15s;}
    .news-item:last-child{border-bottom:none;}
    .news-item:hover{background:#f9fbff;}
    .news-item-title{font-size:11px;font-weight:600;color:var(--text);margin-bottom:2px;line-height:1.35;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
    .news-item-meta{font-size:10px;color:var(--muted);}
    .news-loading{padding:14px;text-align:center;color:var(--muted);font-size:11px;}

    /* CHARTS */
    .charts-grid{display:grid;grid-template-columns:2fr 1fr;gap:18px;margin-bottom:20px;}
    .charts-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;margin-bottom:20px;}
    .chart-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:22px;}
    .chart-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px;}
    .chart-title{font-size:14px;font-weight:700;color:var(--text);}
    .chart-sub{font-size:11px;color:var(--muted);margin-top:2px;}
    .chart-tag{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;}
    .tag-blue{background:var(--blue-ghost);color:var(--blue-main);}
    .tag-live{background:#f0fdf4;color:#10b981;}
    .tag-orange{background:#fffbeb;color:#f59e0b;}
    .tag-purple{background:#eef2ff;color:#6366f1;}
    .chart-wrap{position:relative;}
    .chart-wrap.h200{height:200px;}
    .chart-wrap.h220{height:220px;}
    .chart-wrap.h160{height:160px;}

    /* PREVISION ANNUELLE */
    .prev-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:20px;}
    .prev-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:22px;}
    .prev-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .prev-title{font-size:14px;font-weight:700;}
    .prev-badge{font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;background:#fffbeb;color:#f59e0b;}
    .month-progress-list{display:flex;flex-direction:column;gap:8px;}
    .month-row{display:flex;align-items:center;gap:10px;}
    .month-name{font-size:11px;font-weight:600;width:32px;color:var(--muted);}
    .month-bar-wrap{flex:1;height:8px;background:#f1f5f9;border-radius:99px;overflow:hidden;}
    .month-bar-fill{height:100%;border-radius:99px;transition:width 0.8s ease;}
    .month-val{font-size:11px;font-weight:700;width:68px;text-align:right;}
    .month-val.pos{color:var(--green);}
    .month-val.neg{color:var(--red);}
    .month-val.fut{color:var(--orange);}

    /* DAILY SALES MINI */
    .daily-wrap{margin-top:14px;}
    .daily-label{font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:600;}
    .daily-scroll{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;}
    .daily-scroll::-webkit-scrollbar{height:3px;}
    .daily-scroll::-webkit-scrollbar-track{background:#f1f5f9;border-radius:99px;}
    .daily-scroll::-webkit-scrollbar-thumb{background:#c7d2fe;border-radius:99px;}
    .daily-item{flex-shrink:0;text-align:center;min-width:36px;}
    .daily-bar-wrap{height:40px;display:flex;align-items:flex-end;justify-content:center;margin-bottom:3px;}
    .daily-bar{width:22px;border-radius:4px 4px 0 0;background:var(--blue-main);opacity:0.7;transition:height 0.5s ease;}
    .daily-item.today .daily-bar{background:var(--green);opacity:1;}
    .daily-day{font-size:9px;color:var(--muted);}
    .daily-amt{font-size:9px;font-weight:700;color:var(--text);}

    /* FIDELISATION CARD */
    .fid-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px;}
    .fid-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
    .fid-title{font-size:13px;font-weight:700;}
    .fid-badge{background:#eef2ff;color:#6366f1;font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;}
    .fid-stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .fid-stat{text-align:center;padding:10px;background:#f8faff;border-radius:10px;}
    .fid-stat-val{font-size:20px;font-weight:800;color:var(--blue-main);}
    .fid-stat-lbl{font-size:10px;color:var(--muted);margin-top:2px;}
    .fid-locked{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:20px;text-align:center;color:var(--muted);}
    .fid-locked-icon{font-size:28px;opacity:0.5;}
    .fid-locked-text{font-size:12px;line-height:1.5;}
    .fid-locked-btn{font-size:11px;font-weight:700;color:var(--blue-main);background:var(--blue-ghost);border:none;padding:6px 14px;border-radius:8px;cursor:pointer;}

    /* TABLE */
    .table-card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:20px;}
    .table-head{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
    .table-title{font-size:13px;font-weight:700;}
    table{width:100%;border-collapse:collapse;}
    th{padding:9px 18px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;background:#f8faff;border-bottom:1px solid var(--border);}
    td{padding:11px 18px;font-size:12px;border-bottom:1px solid #f8f9fa;}
    tr:last-child td{border-bottom:none;}
    .td-pos{color:var(--green);font-weight:700;}
    .td-neg{color:var(--red);font-weight:700;}
    .td-muted{color:var(--muted);}
    .td-fut{color:var(--orange);font-weight:600;}
    .status-pill{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:600;padding:3px 9px;border-radius:20px;}
    .sp-empty{background:#f3f4f6;color:var(--muted);}
    .sp-ok{background:#f0fdf4;color:#10b981;}
    .sp-warn{background:#fffbeb;color:#f59e0b;}
    .sp-bad{background:#fef2f2;color:#ef4444;}
    .sp-fut{background:#fffbeb;color:#f59e0b;}

    /* LOADER */
    .loader{display:flex;align-items:center;justify-content:center;min-height:400px;color:var(--muted);gap:10px;font-size:13px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--blue-main);border-radius:50%;animation:spin .7s linear infinite;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .content{animation:fadeIn 0.3s ease both;}

    /* TOGGLE */
    .view-toggle{display:flex;align-items:center;gap:6px;background:#f1f3f9;border-radius:10px;padding:3px}
    .view-toggle button{border:none;background:none;padding:5px 12px;border-radius:7px;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;transition:.2s}
    .view-toggle button.active{background:#fff;color:#1a2f6e;box-shadow:0 1px 4px rgba(0,0,0,.12)}
    .exercice-config{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .exercice-config select{padding:4px 8px;border-radius:6px;border:1px solid var(--border);font-size:12px;background:#fff}

    /* NAV FIDELITE */
    .nav-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 20px 4px}

    /* HAMBURGER */
    .hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:#0f1f5c;border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(15,31,92,.45);-webkit-tap-highlight-color:transparent;transition:background .2s;}
    .hamburger:active{background:#1a3dce;}
    .hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;pointer-events:none;}
    .hamburger.open span:nth-child(1){transform:translateY(7.5px) rotate(45deg);}
    .hamburger.open span:nth-child(2){opacity:0;transform:scaleX(0);}
    .hamburger.open span:nth-child(3){transform:translateY(-7.5px) rotate(-45deg);}
    .nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;}
    .nav-overlay.show{display:block;}

    /* MOBILE */
    html,body{overflow-x:hidden;max-width:100vw;}
    @media(max-width:768px){
      .hamburger{display:flex!important;}
      nav,aside.sidebar,.sidebar{position:fixed!important;top:0!important;left:0!important;height:100vh!important;width:min(280px,84vw)!important;z-index:1001!important;transform:translateX(-105%)!important;transition:transform .3s cubic-bezier(.4,0,.2,1)!important;overflow-y:auto!important;margin:0!important;}
      nav.open,aside.sidebar.open,.sidebar.open{transform:translateX(0)!important;box-shadow:8px 0 32px rgba(0,0,0,.3)!important;}
      .main,main,div.main{margin-left:0!important;width:100vw!important;overflow-x:hidden!important;}
      .topbar{padding:10px 10px 10px 62px!important;flex-wrap:wrap!important;gap:6px!important;width:100%!important;}
      .topbar h1,.topbar-left h1{font-size:14px!important;}
      .topbar-right{width:100%!important;flex-wrap:wrap!important;gap:6px!important;}
      .topbar-right .btn{flex:1 1 auto!important;font-size:11px!important;padding:7px 8px!important;}
      .content{padding:12px 10px!important;}
      .kpi-grid-4,.kpi-grid-5,.kpi-grid-3{grid-template-columns:1fr 1fr!important;gap:8px!important;margin-bottom:12px!important;}
      .charts-grid,.charts-grid-3,.widget-row,.prev-grid{grid-template-columns:1fr!important;gap:12px!important;}
      .kpi-value{font-size:16px!important;}
      .kpi-label{font-size:9px!important;}
      canvas{max-width:100%!important;}
      .context-bar{flex-wrap:wrap!important;gap:8px!important;}
      table{min-width:460px!important;font-size:11px!important;}
      .table-card{overflow-x:auto!important;}
    }
    @media(max-width:420px){
      .kpi-grid-4,.kpi-grid-5,.kpi-grid-3{grid-template-columns:1fr!important;}
    }
  </style>
</head>
<body>
<!-- SIDEBAR -->
<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1 id="pageTitle">Tableau de bord</h1>
      <p id="pageDate"></p>
    </div>
    <div class="topbar-right">
      <div class="view-toggle" style="margin-right:4px">
        <button data-mode="civil" onclick="setViewMode('civil')">üìÖ Ann√©e civile</button>
        <button data-mode="exercice" onclick="setViewMode('exercice')">üìä Exercice</button>
      </div>
      <div class="exercice-config" id="exercice-config" style="display:none;margin-right:4px">
        <span>D√©but :</span>
        <select onchange="setFiscalStart(this.value)">
          <option value="0">Janvier</option><option value="1">F√©vrier</option><option value="2">Mars</option><option value="3">Avril</option><option value="4">Mai</option><option value="5">Juin</option><option value="6">Juillet</option><option value="7">Ao√ªt</option><option value="8">Septembre</option><option value="9">Octobre</option><option value="10">Novembre</option><option value="11">D√©cembre</option>
        </select>
      </div>
      <button class="btn btn-outline" onclick="loadData()">üîÑ Actualiser</button>
      <button class="btn btn-outline" onclick="location.href='rapport-annuel.html'" style="border-color:#10b981;color:#059669">üìÑ Rapport PDF</button>
      <button class="btn btn-primary" onclick="window.location.href='pilotage.html'">+ Saisir des donn√©es</button>
    </div>
  </div>
  <div class="content" id="mainContent">
    <div class="loader"><div class="spin"></div>Chargement des donn√©es...</div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth=getAuth(app);
  const db=getFirestore(app);
  window._auth=auth;window._db=db;window._doc=doc;window._getDoc=getDoc;window._setDoc=setDoc;
  window._collection=collection;window._getDocs=getDocs;window._signOut=signOut;
  onAuthStateChanged(auth,async user=>{
    if(!user){window.location.href='index.html';return;}
    window._uid=user.uid;
    const name=user.displayName||user.email.split('@')[0];
    document.getElementById('uname').textContent=name;
    document.getElementById('av').textContent=name.charAt(0).toUpperCase();
    window._firebaseReady=true;
    try {
      const snap=await getDoc(doc(db,'users',user.uid));
      if(snap.exists()){
        const d=snap.data();
        if(d.viewMode)_viewMode=d.viewMode;
        if(d.fiscalStart!==undefined)_fiscalStart=parseInt(d.fiscalStart);
        if(d.plan){
          document.getElementById('uplan').textContent='Plan '+d.plan.charAt(0).toUpperCase()+d.plan.slice(1);
          window._userPlanDirect=d.plan;
        }
        // Banni√®re trial
        if(d.plan==='trial' && d.trialEnd) showTrialBanner(d.trialEnd, d.pendingPlan||'pro');
      }
    }catch(e){}
    window.loadData();
    setTimeout(function(){
      setViewMode(_viewMode);
      var sel=document.querySelector('#exercice-config select');
      if(sel)sel.value=_fiscalStart;
    },100);
  });

  // ‚îÄ‚îÄ Banni√®re trial expiration ‚îÄ‚îÄ
  window.showTrialBanner = function(trialEndStr, pendingPlan) {
    const trialEnd = new Date(trialEndStr);
    const now = new Date();
    const diffMs = trialEnd - now;
    const diffH = diffMs / (1000 * 60 * 60);
    const diffJ = Math.ceil(diffMs / (1000 * 60 * 60 * 24));

    // Afficher seulement si < 24h ou d√©j√† expir√©
    if (diffH > 24) return;

    const isExpired = diffMs <= 0;
    const planNames = { pro: 'Pro (69‚Ç¨/mois)', max: 'Max (99‚Ç¨/mois)', master: 'Master (169‚Ç¨/mois)' };
    const planLabel = planNames[pendingPlan] || 'Pro';

    // Injecter le CSS si pas d√©j√† l√†
    if (!document.getElementById('trial-banner-style')) {
      const s = document.createElement('style');
      s.id = 'trial-banner-style';
      s.textContent = `
        #trial-banner{position:fixed;top:0;left:0;right:0;z-index:99998;padding:12px 20px;display:flex;align-items:center;justify-content:center;gap:16px;font-family:inherit;font-size:13px;font-weight:600;box-shadow:0 2px 12px rgba(0,0,0,.15);animation:trialSlide .4s ease}
        #trial-banner.warning{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#1a1f36}
        #trial-banner.expired{background:linear-gradient(135deg,#ef4444,#f87171);color:#fff}
        #trial-banner a{color:inherit;text-decoration:underline;cursor:pointer;font-weight:800}
        #trial-banner .trial-close{background:rgba(0,0,0,.15);border:none;border-radius:50%;width:22px;height:22px;cursor:pointer;font-size:12px;color:inherit;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-left:8px}
        @keyframes trialSlide{from{transform:translateY(-100%)}to{transform:translateY(0)}}
        body.has-trial-banner main, body.has-trial-banner .sidebar{padding-top:48px !important}
      `;
      document.head.appendChild(s);
    }

    // Cr√©er la banni√®re
    const banner = document.createElement('div');
    banner.id = 'trial-banner';
    banner.className = isExpired ? 'expired' : 'warning';

    if (isExpired) {
      banner.innerHTML = `
        <span>‚ö†Ô∏è Votre essai gratuit est termin√© ‚Äî Ajoutez un moyen de paiement pour continuer avec le plan <strong>${planLabel}</strong></span>
        <a onclick="location.href='profil.html?tab=abonnement'">Ajouter ma CB ‚Üí</a>
        <button class="trial-close" onclick="document.getElementById('trial-banner').remove();document.body.classList.remove('has-trial-banner')">‚úï</button>
      `;
    } else {
      const heures = Math.round(diffH);
      banner.innerHTML = `
        <span>‚è≥ Votre essai gratuit se termine dans <strong>${heures < 2 ? 'moins de 2h' : 'moins de 24h'}</strong> ‚Äî Ajoutez un moyen de paiement pour ne pas perdre l'acc√®s</span>
        <a onclick="location.href='profil.html?tab=abonnement'">Ajouter ma CB ‚Üí</a>
        <button class="trial-close" onclick="document.getElementById('trial-banner').remove();document.body.classList.remove('has-trial-banner')">‚úï</button>
      `;
    }

    document.body.prepend(banner);
    document.body.classList.add('has-trial-banner');
  };

</script>

<script>
const MONTHS=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
const MONTHS_SHORT=['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];
let _charts=[];
var _viewMode='civil';
var _fiscalStart=0;

document.getElementById('pageDate').textContent=new Date().toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});

function toggleMenu(id,el){document.getElementById(id).classList.toggle('open');if(el)el.classList.toggle('open');}
async function handleLogout(){await window._signOut(window._auth);window.location.href='index.html';}
function toggleFidNav(el){var sub=el.nextElementSibling;var chev=el.querySelector('.nav-chev');var open=sub.style.maxHeight&&sub.style.maxHeight!=='0px';sub.style.maxHeight=open?'0px':'300px';if(chev)chev.style.transform=open?'':'rotate(90deg)';}

/* ‚îÄ‚îÄ‚îÄ EXERCICE COMPTABLE ‚îÄ‚îÄ‚îÄ */
function saveViewPrefs(){
  if(window._uid&&window._setDoc){window._setDoc(window._doc(window._db,'users',window._uid),{viewMode:_viewMode,fiscalStart:_fiscalStart},{merge:true}).catch(()=>{});}
}
function setViewMode(mode){
  _viewMode=mode;saveViewPrefs();
  document.querySelectorAll('.view-toggle button').forEach(function(b){b.classList.toggle('active',b.dataset.mode===mode);});
  document.getElementById('exercice-config').style.display=mode==='exercice'?'flex':'none';
  if(typeof reloadView==='function')reloadView();
}
function setFiscalStart(val){_fiscalStart=parseInt(val);saveViewPrefs();if(typeof reloadView==='function')reloadView();}
function getFiscalMonths(baseYear){
  var months=[];
  for(var i=0;i<12;i++){var absMonth=_fiscalStart+i;var y=baseYear+Math.floor(absMonth/12);var m=absMonth%12;months.push({year:y,month:m});}
  return months;
}
function getFiscalLabel(baseYear){
  if(_fiscalStart===0)return String(baseYear);
  var endMonth=(_fiscalStart+11)%12;var endYear=baseYear+(_fiscalStart+11>=12?1:0);
  return MONTHS_SHORT[_fiscalStart]+' '+baseYear+' ‚Äì '+MONTHS_SHORT[endMonth]+' '+endYear;
}

/* ‚îÄ‚îÄ‚îÄ QUOTES ‚îÄ‚îÄ‚îÄ */
const QUOTES=[
  {text:"Le succ√®s n'est pas final, l'√©chec n'est pas fatal. C'est le courage de continuer qui compte.",author:"Winston Churchill"},
  {text:"La seule fa√ßon de faire du bon travail est d'aimer ce que vous faites.",author:"Steve Jobs"},
  {text:"Votre temps est limit√©, ne le g√¢chez pas en vivant la vie de quelqu'un d'autre.",author:"Steve Jobs"},
  {text:"Le secret du succ√®s est de commencer.",author:"Mark Twain"},
  {text:"Les opportunit√©s ne se produisent pas, vous les cr√©ez.",author:"Chris Grosser"},
  {text:"Un client satisfait est la meilleure strat√©gie commerciale qui soit.",author:"Michael LeBoeuf"},
  {text:"Ne comptez pas les gens que vous atteignez, atteignez les gens qui comptent.",author:"David Ogilvy"},
  {text:"La plupart des gens surestiment ce qu'ils peuvent accomplir en un an et sous-estiment ce qu'ils peuvent accomplir en dix ans.",author:"Bill Gates"},
  {text:"Votre attitude, pas votre aptitude, d√©terminera votre altitude.",author:"Zig Ziglar"},
  {text:"Le plus grand risque est de ne prendre aucun risque.",author:"Mark Zuckerberg"},
  {text:"Travaillez dur en silence. Laissez le succ√®s faire du bruit.",author:"Frank Ocean"},
  {text:"L'innovation distingue un leader d'un suiveur.",author:"Steve Jobs"},
  {text:"Si vous ne construisez pas votre r√™ve, quelqu'un d'autre vous embauchera pour construire le sien.",author:"Tony Gaskins"},
  {text:"La pers√©v√©rance est le travail acharn√© que vous faites apr√®s que vous soyez fatigu√© du travail acharn√© que vous avez d√©j√† fait.",author:"Newt Gingrich"},
  {text:"Le commerce, c'est 1% inspiration et 99% transpiration.",author:"Thomas Edison (adapt√©)"},
  {text:"Chaque matin, vous avez deux choix : continuer √† dormir avec vos r√™ves ou vous lever et les vivre.",author:"Anonyme"},
  {text:"Le succ√®s en affaires n√©cessite formation, discipline et travail acharn√©.",author:"David Rockefeller"},
  {text:"Si vous pensez que vos clients ne sont pas importants, essayez de vous en passer.",author:"Anonyme"},
  {text:"La meilleure publicit√© est un client satisfait qui en parle √† son entourage.",author:"Philip Kotler"},
  {text:"Dans les moments de crise, seule l'imagination est plus importante que le savoir.",author:"Albert Einstein"},
  {text:"Le succ√®s n'est pas la cl√© du bonheur. C'est le bonheur qui est la cl√© du succ√®s.",author:"Albert Schweitzer"},
  {text:"Chaque vente a cinq obstacles de base : pas besoin, pas d'argent, pas de h√¢te, pas de d√©sir, pas de confiance.",author:"Zig Ziglar"},
  {text:"Faire du commerce, c'est anticiper, pas r√©agir.",author:"Anonyme"},
  {text:"Un commerce prosp√®re ne se construit pas en cherchant ce qui est facile, mais en cherchant ce qui est utile.",author:"Anonyme"},
  {text:"La meilleure strat√©gie commerciale : √©couter ses clients, innover, et √™tre constant.",author:"Anonyme"},
  {text:"Les chiffres ne mentent pas. Apprenez √† les lire avant qu'ils ne vous racontent une mauvaise histoire.",author:"Anonyme"},
  {text:"Le tr√©sorier qui dort est un commer√ßant qui r√™ve. Restez vigilant.",author:"Anonyme"},
  {text:"G√©rer, c'est pr√©voir. Pr√©voir, c'est mesurer. Mesurer, c'est progresser.",author:"Anonyme"},
  {text:"Une bonne gestion aujourd'hui, c'est une libert√© demain.",author:"Anonyme"},
  {text:"Le prix que vous demandez doit refl√©ter la valeur que vous apportez.",author:"Anonyme"}
];
function getDailyQuote(){
  const now=new Date();
  const start=new Date(now.getFullYear(),0,0);
  const diff=now-start;
  const oneDay=1000*60*60*24;
  const dayOfYear=Math.floor(diff/oneDay);
  return QUOTES[dayOfYear%QUOTES.length];
}

/* ‚îÄ‚îÄ‚îÄ M√âT√âO (Open-Meteo, sans cl√©) ‚îÄ‚îÄ‚îÄ */
async function fetchWeatherFromCoords(lat, lon, cityHint){
  try{
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,apparent_temperature,precipitation,weather_code,wind_speed_10m&wind_speed_unit=kmh&timezone=auto`,{signal:AbortSignal.timeout(5000)});
    const j=await r.json();
    return{city:cityHint||'Ma position',data:j.current};
  }catch(e){return null;}
}
async function fetchWeather(){
  // Priorit√© 1 : code postal du profil utilisateur (Firestore)
  try{
    if(window._uid && window._getDoc && window._doc && window._db){
      const snap=await window._getDoc(window._doc(window._db,'profil',window._uid,'data','profil'));
      if(snap.exists()){
        const cp=(snap.data().cp||'').trim();
        if(cp && /^\d{4,5}$/.test(cp)){
          const geo=await fetch(`/api/geocode-cp?cp=${encodeURIComponent(cp)}`,{signal:AbortSignal.timeout(5000)});
          const gj=await geo.json();
          if(gj&&gj.lat&&gj.lon){
            const w=await fetchWeatherFromCoords(gj.lat,gj.lon,gj.city);
            if(w)return w;
          }
        }
      }
    }
  }catch(e){}
  // Priorit√© 2 : GPS navigateur
  try{
    const pos=await new Promise((res,rej)=>navigator.geolocation
      ?navigator.geolocation.getCurrentPosition(res,rej,{timeout:4000})
      :rej());
    const w=await fetchWeatherFromCoords(pos.coords.latitude.toFixed(4),pos.coords.longitude.toFixed(4),'Ma position');
    if(w)return w;
  }catch(e){}
  // Fallback : France centre (Paris)
  return await fetchWeatherFromCoords('46.2276','2.2137','France');
}
function getWeatherIcon(code){
  if(code===0)return'‚òÄÔ∏è';
  if(code<=2)return'üå§Ô∏è';
  if(code<=3)return'‚òÅÔ∏è';
  if(code<=48)return'üå´Ô∏è';
  if(code<=55)return'üå¶Ô∏è';
  if(code<=65)return'üåßÔ∏è';
  if(code<=75)return'‚ùÑÔ∏è';
  if(code<=82)return'üåßÔ∏è';
  if(code<=86)return'üå®Ô∏è';
  if(code<=99)return'‚õàÔ∏è';
  return'üå°Ô∏è';
}
function getWeatherDesc(code){
  if(code===0)return'Ciel d√©gag√©';
  if(code<=2)return'Partiellement nuageux';
  if(code<=3)return'Couvert';
  if(code<=48)return'Brouillard';
  if(code<=55)return'Bruine';
  if(code<=65)return'Pluie';
  if(code<=75)return'Neige';
  if(code<=82)return'Averses';
  if(code<=86)return'Averses de neige';
  if(code<=99)return'Orage';
  return'Variable';
}

/* ‚îÄ‚îÄ‚îÄ ACTUALIT√âS (RSS via AllOrigins proxy) ‚îÄ‚îÄ‚îÄ */
async function fetchNews(){
  try{
    // Appel serveur Vercel ‚Üí pas de restriction CORS/HTTPS
    const res=await fetch('/api/news',{signal:AbortSignal.timeout(8000)});
    const data=await res.json();
    if(!data.ok||!data.items?.length)return null;
    return data.items.map(item=>{
      const dateStr=item.pubDate?new Date(item.pubDate).toLocaleDateString('fr-FR',{day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}):'';
      return{title:item.title,link:item.link,dateStr};
    });
  }catch(e){return null;}
}

/* ‚îÄ‚îÄ‚îÄ EXTRACTION DONN√âES MOIS ‚îÄ‚îÄ‚îÄ */
function extractMonthData(d,isFuture){
  if(!d)return{caHT:0,caTTC:0,tvaCollectee:0,rentrees:0,prevCA:0,fixesHT:0,varHT:0,creditsHT:0,leasingHT:0,chargesHT:0,resultat:0,cashflow:0,prevCharges:0,isFuture:false,caJournalier:[]};
  const caHT_j=d.ca?d.ca.reduce((s,r)=>{const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;const multi=h055+h10+h20;return s+(multi>0?multi:(parseFloat(r.montantHT)||0));},0):0;
  const caTTC_j=d.ca?d.ca.reduce((s,r)=>{const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;const multi=h055*1.055+h10*1.10+h20*1.20;if(multi>0)return s+multi;const h=parseFloat(r.montantHT)||0;return s+h*(1+(r.tvaRate||0)/100);},0):0;
  const tva_j=d.ca?d.ca.reduce((s,r)=>{const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;const multi=h055*0.055+h10*0.10+h20*0.20;if(multi>0)return s+multi;const h=parseFloat(r.montantHT)||0;return s+h*(r.tvaRate||0)/100;},0):0;
  const fp=d.facturesPro||[];
  const caHT_fp=fp.reduce((s,r)=>{const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;return s+h055+h10+h20;},0);
  const caTTC_fp=fp.reduce((s,r)=>{const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;return s+h055*1.055+h10*1.10+h20*1.20;},0);
  const tva_fp=fp.reduce((s,r)=>{const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;return s+h055*0.055+h10*0.10+h20*0.20;},0);
  const caHT=caHT_j+caHT_fp;
  const caTTC=caTTC_j+caTTC_fp;
  const tvaCollectee=tva_j+tva_fp;
  const rentrees=d.rentreesSupp?d.rentreesSupp.reduce((s,r)=>s+(parseFloat(r.montant)||0),0):0;
  const prevCA=d.previsionCA?d.previsionCA.reduce((s,r)=>s+(parseFloat(r.montant)||0),0):0;
  const fixesHT=d.chargesFixe?d.chargesFixe.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0):0;
  const varHT=d.chargesVar?d.chargesVar.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0):0;
  const leasingHT=d.leasing?d.leasing.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0):0;
  let creditsHT=0;
  if(d.credits)d.credits.forEach((r,i)=>{
    if(r.ligneType==='principal')creditsHT+=parseFloat(r.montant)||0;
    else{let mt=parseFloat(r.montant)||0;if(r.tvaAuto&&parseFloat(r.tauxInteret)>0){const p=d.credits.slice(0,i).reverse().find(c=>c.fournisseur===r.fournisseur&&c.ligneType==='principal');if(p)mt=(parseFloat(p.montant)||0)*parseFloat(r.tauxInteret)/100/12;}creditsHT+=mt;}
  });
  const chargesHT=fixesHT+varHT+creditsHT+leasingHT;
  const prevCharges=isFuture?chargesHT:0;
  const prevCAFutur=isFuture?(caHT||0):0;
  const caHTReel=isFuture?0:caHT;
  const chargesReel=isFuture?0:chargesHT;
  const resultat=isFuture?0:(caHT+rentrees-chargesHT);
  const cashflow=isFuture?0:(caTTC+rentrees-(fixesHT*(1+0.2)+varHT*(1+0.2)+creditsHT+leasingHT*(1+0.2)));
  const prevCAFinal=isFuture?(prevCA||prevCAFutur):prevCA;
  // Extraire les ventes journali√®res du mois
  const caJournalier=d.ca||[];
  return{caHT:caHTReel,caTTC:isFuture?0:caTTC,tvaCollectee:isFuture?0:tvaCollectee,
    rentrees:isFuture?0:rentrees,prevCA:prevCAFinal,
    fixesHT:isFuture?0:fixesHT,varHT:isFuture?0:varHT,creditsHT:isFuture?0:creditsHT,
    leasingHT:isFuture?0:leasingHT,chargesHT:chargesReel,resultat,cashflow,
    prevCharges,isFuture:!!isFuture,caJournalier};
}

/* ‚îÄ‚îÄ‚îÄ FID√âLISATION ‚îÄ‚îÄ‚îÄ */
async function loadFidStats(){
  if(!window._uid||!window._getDocs||!window._collection||!window._db)return null;
  try{
    const snap=await window._getDocs(window._collection(window._db,'fidelite',window._uid,'clients'));
    if(!snap)return null;
    let total=0,actifs=0,pointsTotal=0;
    snap.forEach(doc=>{
      total++;
      const d=doc.data();
      const pts=d.points||0;
      pointsTotal+=pts;
      if(pts>0)actifs++;
    });
    return{total,actifs,pointsTotal};
  }catch(e){return null;}
}

/* ‚îÄ‚îÄ‚îÄ CHARGE PRINCIPALE ‚îÄ‚îÄ‚îÄ */
async function loadData(_tries){
  _tries=_tries||0;
  if(!window._uid){if(_tries<20){setTimeout(()=>loadData(_tries+1),300);}return;}
  if(window._userPlan===undefined&&window._userPlanDirect===undefined){
    if(_tries<30){setTimeout(()=>loadData(_tries+1),100);}
    else{window._userPlanDirect='pro';loadData(31);}
    return;
  }
  const plan=window._userPlan||window._userPlanDirect||'free';
  const CAN=['trial','pro','max','master','dev'];
  if(!CAN.includes(plan)){console.log('Acc√®s refus√© plan:',plan);return;}

  const now=new Date();
  const civilYear=now.getFullYear();
  const currentM=now.getMonth();
  const today=now.getDate();

  // En mode exercice, d√©tecter la bonne ann√©e de base.
  // Ex : exercice mai(4)‚Üíavril, en f√©vrier 2026 ‚Üí year = 2025
  let year = civilYear;
  if (_viewMode === 'exercice' && _fiscalStart > 0) {
    // Si le mois courant est AVANT le mois de d√©but d'exercice ‚Üí exercice a commenc√© l'ann√©e pass√©e
    if (currentM < _fiscalStart) year = civilYear - 1;
  }

  const fiscalMonths=(_viewMode==='exercice')?getFiscalMonths(year):
    Array.from({length:12},function(_,m){return{year:year,month:m};});

  // Charger les 12 mois
  const allMonths=[];
  for(let i=0;i<12;i++){
    const ym=fiscalMonths[i];
    const key=`${ym.year}-${String(ym.month+1).padStart(2,'0')}`;
    try{
      const snap=await window._getDoc(window._doc(window._db,'pilotage',window._uid,'months',key));
      allMonths.push(snap.exists()?snap.data():null);
    }catch(e){allMonths.push(null);}
  }

  const nowKey2=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  const monthsData=allMonths.map((d,i)=>{
    const ym=fiscalMonths[i];
    const key=`${ym.year}-${String(ym.month+1).padStart(2,'0')}`;
    return extractMonthData(d,key>nowKey2);
  });

  // Donn√©es mois courant ‚Äî trouver l'index du mois courant dans fiscalMonths
  let currentIdx = 0;
  const nowYear = now.getFullYear();
  for (let i = 0; i < 12; i++) {
    if (fiscalMonths[i].month === currentM && fiscalMonths[i].year === nowYear) {
      currentIdx = i; break;
    }
  }
  const current=monthsData[currentIdx]||monthsData[currentM];
  const prevMonthData=currentIdx>0?monthsData[currentIdx-1]:{caHT:0,chargesHT:0,resultat:0};

  // Totaux annuels
  const annualCA=monthsData.reduce((s,d)=>s+d.caHT,0);
  const annualCharges=monthsData.reduce((s,d)=>s+d.chargesHT,0);
  const annualResultat=monthsData.reduce((s,d)=>s+d.resultat,0);
  const annualCashflow=monthsData.reduce((s,d)=>s+d.cashflow,0);
  const annualPrevCharges=monthsData.reduce((s,d)=>s+d.prevCharges,0);
  const annualPrevCA=monthsData.reduce((s,d)=>s+d.prevCA,0);
  const annualPrevResultat=annualPrevCA-annualPrevCharges;
  const annualTotalResultat=annualResultat+annualPrevResultat;
  const annualTVA=monthsData.reduce((s,d)=>s+d.tvaCollectee,0);

  // Variation vs mois pr√©c√©dent
  const varCA=prevMonthData.caHT>0?((current.caHT-prevMonthData.caHT)/prevMonthData.caHT*100):null;
  const varCharges=prevMonthData.chargesHT>0?((current.chargesHT-prevMonthData.chargesHT)/prevMonthData.chargesHT*100):null;
  const txMarge=current.caHT>0?((current.caHT-current.chargesHT)/current.caHT*100):null;
  const txMargeAnnuel=annualCA>0?((annualCA-annualCharges)/annualCA*100):null;

  // Projection fin d'ann√©e
  const moisPassesAvecCA=monthsData.filter((d,i)=>!d.isFuture&&d.caHT>0);
  const nbMoisReel=moisPassesAvecCA.length;
  const projCA=nbMoisReel>0?(annualCA/nbMoisReel*12):0;
  const projResultat=nbMoisReel>0?(annualResultat/nbMoisReel*12):0;

  // Ventes journali√®res du mois courant
  const caJour=current.caJournalier||[];

  const hasCurrentData=current.caHT>0||current.chargesHT>0;
  const hasAnnualData=annualCA>0||annualCharges>0;

  // Fetch async: m√©t√©o, actu, fid√©lisation
  const [weather,news,fidStats]=await Promise.all([
    fetchWeather(),
    fetchNews(),
    (['max','master','trial','dev'].includes(plan))?loadFidStats():Promise.resolve(null)
  ]);

  // Quote du jour
  const quote=getDailyQuote();

  // Destroy old charts
  _charts.forEach(c=>{try{c.destroy();}catch(e){}});
  _charts=[];

  // Construire le HTML des ventes journali√®res
  const maxCA=caJour.length>0?Math.max(...caJour.map(r=>{const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;const m=h055+h10+h20;return m>0?m:(parseFloat(r.montantHT)||0);})):0;

  function buildDailyBars(){
    if(!caJour.length)return '<div style="color:var(--muted);font-size:11px;padding:8px 0;">Aucune vente enregistr√©e ce mois.</div>';
    // Grouper par jour
    const byDay={};
    caJour.forEach(r=>{
      const parts=r.date?r.date.split('/'):[];
      if(parts.length<1)return;
      const d=parseInt(parts[0]);
      const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;
      const m=h055+h10+h20;const val=m>0?m:(parseFloat(r.montantHT)||0);
      byDay[d]=(byDay[d]||0)+val;
    });
    const days=Object.keys(byDay).map(Number).sort((a,b)=>a-b);
    const max=Math.max(...days.map(d=>byDay[d]),1);
    return days.map(d=>{
      const v=byDay[d];
      const pct=Math.round(v/max*38);
      const isToday=d===today;
      return `<div class="daily-item${isToday?' today':''}">
        <div class="daily-bar-wrap"><div class="daily-bar" style="height:${pct}px"></div></div>
        <div class="daily-day">${d}</div>
        <div class="daily-amt">${fmtK(v)}</div>
      </div>`;
    }).join('');
  }

  // M√©t√©o HTML
  function buildWeather(){
    if(!weather||!weather.data){
      return`<div class="weather-card">
        <div class="w-icon">üå°Ô∏è</div>
        <div class="w-info">
          <div class="w-city">üìç Position indisponible</div>
          <div class="w-temprow"><span class="w-temp">‚Äî¬∞</span></div>
          <div class="w-bottom"><span class="w-detail">Donn√©es m√©t√©o non disponibles</span></div>
        </div>
      </div>`;
    }
    const d=weather.data;
    const temp=Math.round(d.temperature_2m||0);
    const feel=Math.round(d.apparent_temperature||0);
    const wind=Math.round(d.wind_speed_10m||0);
    const rain=d.precipitation>0?`üåßÔ∏è ${d.precipitation}mm`:'‚òÄÔ∏è Sec';
    return`<div class="weather-card">
      <div class="w-icon">${getWeatherIcon(d.weather_code||0)}</div>
      <div class="w-info">
        <div class="w-city">üìç ${weather.city}</div>
        <div class="w-temprow"><span class="w-temp">${temp}¬∞</span><span class="w-feel">Ressenti ${feel}¬∞</span></div>
        <div class="w-bottom"><span class="w-detail">üí® ${wind} km/h</span><span class="w-detail">${rain}</span></div>
      </div>
    </div>`;
  }

  // News HTML ‚Äî 2 actualit√©s max
  function buildNews(){
    if(!news||!news.length){
      return`<div class="news-card">
        <div class="news-header"><span class="news-title">üì∞ Actu √©co</span><span class="news-source">Le Monde</span></div>
        <div class="news-loading">Impossible de charger les actualit√©s</div>
      </div>`;
    }
    const items=news.slice(0,2).map(n=>`<div class="news-item" onclick="window.open('${n.link}','_blank')">
      <div class="news-item-title">${n.title}</div>
      <div class="news-item-meta">${n.dateStr}</div>
    </div>`).join('');
    return`<div class="news-card">
      <div class="news-header"><span class="news-title">üì∞ Actu √©co</span><span class="news-source">Le Monde √âconomie</span></div>
      <div class="news-list">${items}</div>
    </div>`;
  }

  // Fid√©lisation HTML
  function buildFidCard(){
    const hasFid=['max','master','trial','dev'].includes(plan);
    if(!hasFid){
      return`<div class="fid-card" style="min-height:160px">
        <div class="fid-header"><div class="fid-title">üíé Fid√©lisation</div></div>
        <div class="fid-locked">
          <div class="fid-locked-icon">üîí</div>
          <div class="fid-locked-text">La fid√©lisation est disponible<br>√† partir du plan <b>Max</b></div>
          <button class="fid-locked-btn" onclick="location.href='pricing.html'">Passer au plan Max ‚Üí</button>
        </div>
      </div>`;
    }
    if(!fidStats){
      return`<div class="fid-card" style="min-height:160px">
        <div class="fid-header"><div class="fid-title">üíé Fid√©lisation</div><div class="fid-badge">Chargement...</div></div>
        <div class="fid-locked"><div class="fid-locked-icon">‚è≥</div><div class="fid-locked-text">Chargement des donn√©es fid√©lisation...</div></div>
      </div>`;
    }
    const actifRate=fidStats.total>0?Math.round(fidStats.actifs/fidStats.total*100):0;
    return`<div class="fid-card">
      <div class="fid-header">
        <div class="fid-title">üíé Fid√©lisation clients</div>
        <div class="fid-badge">${plan.charAt(0).toUpperCase()+plan.slice(1)}</div>
      </div>
      <div class="fid-stats">
        <div class="fid-stat"><div class="fid-stat-val">${fidStats.total}</div><div class="fid-stat-lbl">Clients inscrits</div></div>
        <div class="fid-stat"><div class="fid-stat-val">${fidStats.actifs}</div><div class="fid-stat-lbl">Clients actifs</div></div>
        <div class="fid-stat"><div class="fid-stat-val">${fidStats.pointsTotal.toLocaleString('fr-FR')}</div><div class="fid-stat-lbl">Points distribu√©s</div></div>
        <div class="fid-stat"><div class="fid-stat-val">${actifRate}%</div><div class="fid-stat-lbl">Taux d'engagement</div></div>
      </div>
    </div>`;
  }

  // Pr√©vision fin d'ann√©e
  function buildPrevisionTable(){
    const yearLabel=_viewMode==='exercice'?getFiscalLabel(year):String(year);
    const rows=monthsData.map((d,i)=>{
      const ym=fiscalMonths[i];
      const mName=MONTHS_SHORT[ym.month];
      const isCurrent=(ym.month===currentM&&ym.year===year);
      const isFut=d.isFuture;
      let caDisp,chargesDisp,resDisp,resCls,rowCls='';
      if(isFut){
        caDisp=d.prevCA>0?`<span style="color:#f59e0b">${fmtE(d.prevCA)} ‚òÖ</span>`:'<span class="td-muted">‚Äî</span>';
        chargesDisp=d.prevCharges>0?`<span style="color:#f59e0b">${fmtE(d.prevCharges)}</span>`:'<span class="td-muted">‚Äî</span>';
        const prevRes=d.prevCA-d.prevCharges;
        resDisp=d.prevCA>0||d.prevCharges>0?`<span class="td-fut">${fmtE(prevRes)}</span>`:'<span class="td-muted">‚Äî</span>';
        rowCls='style="background:#fffdf5"';
      }else{
        caDisp=d.caHT>0?fmtE(d.caHT):'<span class="td-muted">‚Äî</span>';
        chargesDisp=d.chargesHT>0?fmtE(d.chargesHT):'<span class="td-muted">‚Äî</span>';
        resDisp=`<span class="${d.resultat>0?'td-pos':d.resultat<0?'td-neg':'td-muted'}">${d.caHT>0||d.chargesHT>0?fmtE(d.resultat):'‚Äî'}</span>`;
      }
      const isCurrentBadge=isCurrent?'<span style="background:#eff6ff;color:#1a3dce;font-size:9px;font-weight:700;padding:1px 6px;border-radius:10px;margin-left:4px">En cours</span>':'';
      const isFutBadge=isFut?'<span style="background:#fffbeb;color:#f59e0b;font-size:9px;font-weight:700;padding:1px 6px;border-radius:10px;margin-left:4px">Pr√©vi.</span>':'';
      return`<tr ${rowCls}>
        <td><b>${mName} ${ym.year!==year?ym.year:''}</b>${isCurrentBadge}${isFutBadge}</td>
        <td>${caDisp}</td><td>${chargesDisp}</td><td>${resDisp}</td>
        <td>${d.prevCA>0?`<span style="font-size:11px;color:#6b7280">${fmtE(d.prevCA)}</span>`:'<span class="td-muted">‚Äî</span>'}</td>
      </tr>`;
    }).join('');
    return`<div class="table-card">
      <div class="table-head">
        <div class="table-title">üìÜ Suivi mensuel & Pr√©visions ‚Äî ${yearLabel}</div>
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-size:11px;color:#f59e0b;font-weight:600">‚òÖ = Pr√©visionnel</span>
          <a href="pilotage.html" style="font-size:12px;color:var(--blue-main);font-weight:600;text-decoration:none;">‚úèÔ∏è Saisir des donn√©es ‚Üí</a>
        </div>
      </div>
      <div style="overflow-x:auto">
      <table>
        <thead><tr><th>Mois</th><th>CA HT r√©el</th><th>Charges HT</th><th>R√©sultat</th><th>Objectif CA</th></tr></thead>
        <tbody>${rows}</tbody>
        <tfoot>
          <tr style="background:#f8faff;font-weight:700">
            <td><b>Total / Proj.</b></td>
            <td class="${annualCA>0?'':'td-muted'}">${annualCA>0?fmtE(annualCA):'‚Äî'}</td>
            <td class="${annualCharges>0?'':'td-muted'}">${annualCharges>0?fmtE(annualCharges):'‚Äî'}</td>
            <td class="${annualTotalResultat>=0?'td-pos':'td-neg'}">${hasAnnualData?fmtE(annualTotalResultat):'‚Äî'}</td>
            <td class="td-muted">${annualPrevCA>0?fmtE(annualPrevCA):'‚Äî'}</td>
          </tr>
          ${projCA>0?`<tr style="background:#fffbeb">
            <td style="color:#f59e0b;font-size:11px">üìà Projection fin d'ann√©e</td>
            <td style="color:#f59e0b;font-weight:700">${fmtE(projCA)}</td>
            <td class="td-muted">‚Äî</td>
            <td style="color:${projResultat>=0?'#10b981':'#ef4444'};font-weight:700">${fmtE(projResultat)}</td>
            <td class="td-muted">Bas√© sur ${nbMoisReel} mois</td>
          </tr>`:''}
        </tfoot>
      </table>
      </div>
    </div>`;
  }

  // Progression mensuelle (mini chart en barres CSS)
  function buildMonthProgress(){
    const maxVal=Math.max(...monthsData.map(d=>Math.max(d.caHT,d.chargesHT,d.prevCA)),1);
    return monthsData.map((d,i)=>{
      const ym=fiscalMonths[i];
      const isCur=ym.month===currentM&&ym.year===year;
      if(d.isFuture&&d.prevCA===0&&d.prevCharges===0)return`<div class="month-row"><div class="month-name">${MONTHS_SHORT[ym.month]}</div><div class="month-bar-wrap"></div><div class="month-val">‚Äî</div></div>`;
      const val=d.isFuture?d.prevCA:d.caHT;
      const pct=val>0?Math.min(val/maxVal*100,100):0;
      const color=d.isFuture?'#f59e0b':(d.resultat>=0?'#10b981':'#ef4444');
      const cls=d.isFuture?'fut':d.resultat>=0?'pos':'neg';
      return`<div class="month-row">
        <div class="month-name" style="${isCur?'color:var(--blue-main);font-weight:700':''}">${MONTHS_SHORT[ym.month]}</div>
        <div class="month-bar-wrap"><div class="month-bar-fill" style="width:${pct}%;background:${color}"></div></div>
        <div class="month-val ${cls}">${val>0?fmtK(val):'‚Äî'}</div>
      </div>`;
    }).join('');
  }

  // Render complet
  document.getElementById('mainContent').innerHTML=`
    <!-- CONTEXT BAR -->
    <div class="context-bar">
      <div class="context-month">
        <span class="context-pill"><span class="dot"></span>Donn√©es en direct ¬∑ ${MONTHS[currentM]} ${year}</span>
        ${!hasCurrentData?'<span class="last-update" style="color:#f59e0b;margin-left:8px;">‚ö†Ô∏è Aucune donn√©e ce mois ‚Äî <a href="pilotage.html" style="color:var(--blue-main);font-weight:600;">Saisir dans le Pilotage</a></span>':''}
      </div>
      <span class="last-update">${_viewMode==='exercice'?'Exercice '+getFiscalLabel(year):'Ann√©e '+year} ¬∑ ${monthsData.filter(d=>d.caHT>0||d.chargesHT>0).length} mois renseign√©s</span>
    </div>

    <!-- WIDGETS : M√âT√âO + CITATION + ACTUALIT√âS -->
    <div class="widget-row">
      ${buildWeather()}
      <div class="quote-card">
        <div>
          <div class="quote-header">
            <span class="quote-tag">‚ú® Citation</span>
            <span style="font-size:10px;color:var(--muted)">${new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long'})}</span>
          </div>
          <div class="quote-text">${quote.text}"</div>
        </div>
        <div class="quote-author">‚Äî ${quote.author}</div>
      </div>
      ${buildNews()}
    </div>

    <!-- KPIs MOIS EN COURS -->
    <div class="section-label">üìÖ Mois en cours ‚Äî ${MONTHS[currentM]} ${year}</div>
    <div class="kpi-grid-5">
      <div class="kpi-card blue">
        <div class="kpi-icon">üí∞</div>
        <div class="kpi-label">CA HT</div>
        <div class="kpi-value ${!hasCurrentData?'empty':''}">${hasCurrentData?fmtE(current.caHT):'‚Äî ‚Ç¨'}</div>
        <div class="kpi-sub">
          ${varCA!==null?`<span class="${varCA>=0?'up':'down'}">${varCA>=0?'‚ñ≤':'‚ñº'} ${Math.abs(varCA).toFixed(1)}% vs mois pr√©c.</span>`:`<span class="neutral">TTC : ${fmtE(current.caTTC)}</span>`}
        </div>
        ${current.prevCA>0?`<div class="kpi-progress"><div class="kpi-progress-bar"><div class="kpi-progress-fill" style="width:${Math.min(current.caHT/current.prevCA*100,100).toFixed(0)}%;background:var(--blue-main)"></div></div><div class="kpi-progress-label">${(current.caHT/current.prevCA*100).toFixed(0)}% de l'objectif ${fmtE(current.prevCA)}</div></div>`:''}
      </div>
      <div class="kpi-card orange">
        <div class="kpi-icon">üßæ</div>
        <div class="kpi-label">Charges totales HT</div>
        <div class="kpi-value ${!hasCurrentData?'empty':''}">${hasCurrentData?fmtE(current.chargesHT):'‚Äî ‚Ç¨'}</div>
        <div class="kpi-sub">
          ${varCharges!==null?`<span class="${varCharges<=0?'up':'down'}">${varCharges<=0?'‚ñº':'‚ñ≤'} ${Math.abs(varCharges).toFixed(1)}% vs mois pr√©c.</span>`:`<span class="neutral">Fixes ${fmtE(current.fixesHT)} ¬∑ Var. ${fmtE(current.varHT)}</span>`}
        </div>
      </div>
      <div class="kpi-card ${!hasCurrentData?'green':current.resultat>=0?'green':'red'}">
        <div class="kpi-icon">üìä</div>
        <div class="kpi-label">R√©sultat HT</div>
        <div class="kpi-value ${!hasCurrentData?'empty':current.resultat>=0?'positive':'negative'}">${hasCurrentData?fmtE(current.resultat):'‚Äî ‚Ç¨'}</div>
        <div class="kpi-sub"><span class="neutral">CA ‚àí D√©penses du mois</span></div>
      </div>
      <div class="kpi-card teal">
        <div class="kpi-icon">üí∏</div>
        <div class="kpi-label">Cashflow</div>
        <div class="kpi-value ${!hasCurrentData?'empty':current.cashflow>=0?'positive':'negative'}">${hasCurrentData?fmtE(current.cashflow):'‚Äî ‚Ç¨'}</div>
        <div class="kpi-sub"><span class="neutral">Flux de tr√©sorerie</span></div>
      </div>
      <div class="kpi-card purple">
        <div class="kpi-icon">üè¶</div>
        <div class="kpi-label">TVA √† d√©clarer</div>
        <div class="kpi-value ${!hasCurrentData?'empty':''}">${hasCurrentData?fmtE(current.tvaCollectee):'‚Äî ‚Ç¨'}</div>
        <div class="kpi-sub"><span class="neutral">TVA collect√©e sur ventes</span></div>
      </div>
    </div>

    <!-- VENTES DU MOIS (journalier) -->
    ${caJour.length>0?`
    <div class="chart-card" style="margin-bottom:20px">
      <div class="chart-header">
        <div><div class="chart-title">üìà Ventes du mois ‚Äî ${MONTHS[currentM]} ${year}</div><div class="chart-sub">CA HT par jour (${caJour.length} entr√©e${caJour.length>1?'s':''})</div></div>
        <span class="chart-tag tag-live">‚óè Live</span>
      </div>
      <div class="daily-wrap">
        <div class="daily-label">Jour ¬∑ CA HT</div>
        <div class="daily-scroll">${buildDailyBars()}</div>
      </div>
    </div>`:''}

    <!-- KPIs ANNUELS -->
    <div class="section-label">üìÜ Cumul annuel ‚Äî ${_viewMode==='exercice'?getFiscalLabel(year):year}</div>
    <div class="kpi-grid-5">
      <div class="kpi-card blue">
        <div class="kpi-icon">üíº</div>
        <div class="kpi-label">CA Annuel HT</div>
        <div class="kpi-value ${!hasAnnualData?'empty':''}">${hasAnnualData?fmtE(annualCA):'‚Äî ‚Ç¨'}</div>
        <div class="kpi-sub"><span class="neutral">Cumul r√©el ${year}</span></div>
      </div>
      <div class="kpi-card orange">
        <div class="kpi-icon">üìâ</div>
        <div class="kpi-label">Charges annuelles HT</div>
        <div class="kpi-value ${!hasAnnualData?'empty':''}">${hasAnnualData?fmtE(annualCharges):'‚Äî ‚Ç¨'}</div>
        <div class="kpi-sub"><span class="neutral">Fixes + Var + Cr√©dits + Leasing</span></div>
      </div>
      <div class="kpi-card ${!hasAnnualData?'green':annualResultat>=0?'green':'red'}">
        <div class="kpi-icon">üéØ</div>
        <div class="kpi-label">R√©sultat r√©el HT</div>
        <div class="kpi-value ${!hasAnnualData?'empty':annualResultat>=0?'positive':'negative'}">${hasAnnualData?fmtE(annualResultat):'‚Äî ‚Ç¨'}</div>
        <div class="kpi-sub"><span class="neutral">${annualPrevResultat!==0?`Total pr√©vi : ${fmtE(annualTotalResultat)}`:'CA ‚àí Charges mois pass√©s'}</span></div>
      </div>
      <div class="kpi-card teal">
        <div class="kpi-icon">üí∏</div>
        <div class="kpi-label">Cashflow annuel</div>
        <div class="kpi-value ${!hasAnnualData?'empty':annualCashflow>=0?'positive':'negative'}">${hasAnnualData?fmtE(annualCashflow):'‚Äî ‚Ç¨'}</div>
        <div class="kpi-sub"><span class="neutral">Flux de tr√©sorerie</span></div>
      </div>
      <div class="kpi-card ${txMargeAnnuel===null?'green':txMargeAnnuel>=30?'green':txMargeAnnuel>=10?'orange':'red'}">
        <div class="kpi-icon">üìê</div>
        <div class="kpi-label">Taux de r√©sultat</div>
        <div class="kpi-value ${txMargeAnnuel===null?'empty':txMargeAnnuel>=0?'positive':'negative'}">${txMargeAnnuel!==null?txMargeAnnuel.toFixed(1)+'%':'‚Äî %'}</div>
        <div class="kpi-sub"><span class="neutral">R√©sultat / CA HT</span></div>
      </div>
    </div>

    <!-- PR√âVISIONS ANNUELLES + FID√âLISATION -->
    <div class="section-label">üîÆ Pr√©visions & Vue d'ensemble</div>
    <div style="display:grid;grid-template-columns:1.4fr 0.8fr 0.8fr;gap:18px;margin-bottom:20px" id="prev-fid-grid">
      <!-- Progression mensuelle CA -->
      <div class="prev-card">
        <div class="prev-header">
          <div class="prev-title">üìä CA mensuel</div>
          <span class="prev-badge">${_viewMode==='exercice'?'Exercice':'Ann√©e civile'}</span>
        </div>
        <div class="month-progress-list">${buildMonthProgress()}</div>
      </div>
      <!-- Projection fin d'ann√©e -->
      <div class="prev-card">
        <div class="prev-header"><div class="prev-title">üîÆ Projection ${year}</div></div>
        <div style="display:flex;flex-direction:column;gap:12px">
          <div class="kpi-card blue" style="margin-bottom:0;padding:14px">
            <div class="kpi-label">CA projet√©</div>
            <div class="kpi-value" style="font-size:18px">${projCA>0?fmtE(projCA):'‚Äî'}</div>
            <div class="kpi-sub"><span class="neutral">√† fin ${year}</span></div>
          </div>
          <div class="kpi-card ${projResultat>=0?'green':'red'}" style="margin-bottom:0;padding:14px">
            <div class="kpi-label">R√©sultat projet√©</div>
            <div class="kpi-value ${projResultat>=0?'positive':'negative'}" style="font-size:18px">${projResultat!==0?fmtE(projResultat):'‚Äî'}</div>
            <div class="kpi-sub"><span class="neutral">Tendance actuelle</span></div>
          </div>
          <div class="kpi-card purple" style="margin-bottom:0;padding:14px">
            <div class="kpi-label">TVA annuelle collect√©e</div>
            <div class="kpi-value" style="font-size:18px">${annualTVA>0?fmtE(annualTVA):'‚Äî'}</div>
            <div class="kpi-sub"><span class="neutral">Cumul ${year}</span></div>
          </div>
          ${nbMoisReel>0?`<div style="font-size:10px;color:var(--muted);text-align:center;margin-top:4px">Projection bas√©e sur ${nbMoisReel} mois de donn√©es r√©elles</div>`:''}
        </div>
      </div>
      <!-- Fid√©lisation -->
      ${buildFidCard()}
    </div>

    <!-- GRAPHIQUES -->
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-header">
          <div><div class="chart-title">√âvolution CA & Charges ‚Äî ${year}</div><div class="chart-sub">Comparaison mensuelle HT</div></div>
          <span class="chart-tag ${hasAnnualData?'tag-live':'tag-blue'}">${hasAnnualData?'‚óè Live':'Placeholder'}</span>
        </div>
        <div class="chart-wrap h220"><canvas id="caChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-header">
          <div><div class="chart-title">R√©partition des charges</div><div class="chart-sub">${MONTHS[currentM]} ${year}</div></div>
          <span class="chart-tag tag-orange">Mois</span>
        </div>
        <div class="chart-wrap h220"><canvas id="coutChart"></canvas></div>
      </div>
    </div>

    <div class="charts-grid-3">
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">R√©sultat mensuel HT</div><div class="chart-sub">Positif / N√©gatif par mois</div></div></div>
        <div class="chart-wrap h200"><canvas id="resultatChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">Cashflow mensuel</div><div class="chart-sub">Flux de tr√©sorerie ${year}</div></div></div>
        <div class="chart-wrap h200"><canvas id="cashflowChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-header"><div><div class="chart-title">Cumul CA vs D√©penses</div><div class="chart-sub">√âvolution cumul√©e ${year}</div></div></div>
        <div class="chart-wrap h200"><canvas id="cumulChart"></canvas></div>
      </div>
    </div>

    <!-- TABLE MENSUELLE COMPL√àTE -->
    ${buildPrevisionTable()}

    <!-- TABLE INDICATEURS MOIS -->
    <div class="table-card">
      <div class="table-head">
        <div class="table-title">üìã Indicateurs cl√©s ‚Äî ${MONTHS[currentM]} ${year}</div>
        <a href="pilotage.html" style="font-size:12px;color:var(--blue-main);font-weight:600;text-decoration:none;">‚úèÔ∏è Modifier dans le Pilotage ‚Üí</a>
      </div>
      <table>
        <thead><tr><th>Indicateur</th><th>Valeur</th><th>D√©tail</th><th>Statut</th></tr></thead>
        <tbody>
          <tr><td><b>CA HT</b></td><td class="${current.caHT>0?'':'td-muted'}">${current.caHT>0?fmtE(current.caHT):'‚Äî'}</td><td class="td-muted">TTC : ${fmtE(current.caTTC)}</td><td><span class="status-pill ${current.caHT>0?'sp-ok':'sp-empty'}">${current.caHT>0?'‚úì Renseign√©':'En attente'}</span></td></tr>
          <tr><td><b>Charges fixes</b></td><td class="${current.fixesHT>0?'':'td-muted'}">${current.fixesHT>0?fmtE(current.fixesHT):'‚Äî'}</td><td class="td-muted">Pr√©visionnel mensuel</td><td><span class="status-pill ${current.fixesHT>0?'sp-ok':'sp-empty'}">${current.fixesHT>0?'‚úì Renseign√©':'En attente'}</span></td></tr>
          <tr><td><b>Charges variables</b></td><td class="${current.varHT>0?'':'td-muted'}">${current.varHT>0?fmtE(current.varHT):'‚Äî'}</td><td class="td-muted">Au fil de l'eau</td><td><span class="status-pill ${current.varHT>0?'sp-ok':'sp-empty'}">${current.varHT>0?'‚úì Renseign√©':'En attente'}</span></td></tr>
          <tr><td><b>Emprunts / Cr√©dits</b></td><td class="${current.creditsHT>0?'':'td-muted'}">${current.creditsHT>0?fmtE(current.creditsHT):'‚Äî'}</td><td class="td-muted">Principal + Int√©r√™ts</td><td><span class="status-pill ${current.creditsHT>0?'sp-ok':'sp-empty'}">${current.creditsHT>0?'‚úì Renseign√©':'En attente'}</span></td></tr>
          <tr><td><b>R√©sultat HT</b></td><td class="${current.caHT>0||current.chargesHT>0?(current.resultat>=0?'td-pos':'td-neg'):'td-muted'}">${current.caHT>0||current.chargesHT>0?fmtE(current.resultat):'‚Äî'}</td><td class="td-muted">CA ‚àí Total d√©penses</td><td><span class="status-pill ${current.caHT>0||current.chargesHT>0?(current.resultat>=0?'sp-ok':'sp-bad'):'sp-empty'}">${current.caHT>0||current.chargesHT>0?(current.resultat>=0?'‚úì Positif':'‚ö† N√©gatif'):'En attente'}</span></td></tr>
          <tr><td><b>Taux de r√©sultat</b></td><td class="${txMarge!==null?(txMarge>=0?'td-pos':'td-neg'):'td-muted'}">${txMarge!==null?txMarge.toFixed(1)+'%':'‚Äî'}</td><td class="td-muted">R√©sultat / CA HT</td><td><span class="status-pill ${txMarge===null?'sp-empty':txMarge>=20?'sp-ok':txMarge>=5?'sp-warn':'sp-bad'}">${txMarge===null?'En attente':txMarge>=20?'‚úì Bon':txMarge>=5?'‚ö† Moyen':'‚ö† Faible'}</span></td></tr>
          <tr><td><b>Taux de r√©sultat annuel</b></td><td class="${txMargeAnnuel!==null?(txMargeAnnuel>=0?'td-pos':'td-neg'):'td-muted'}">${txMargeAnnuel!==null?txMargeAnnuel.toFixed(1)+'%':'‚Äî'}</td><td class="td-muted">R√©sultat annuel / CA annuel</td><td><span class="status-pill ${txMargeAnnuel===null?'sp-empty':txMargeAnnuel>=20?'sp-ok':txMargeAnnuel>=5?'sp-warn':'sp-bad'}">${txMargeAnnuel===null?'En attente':txMargeAnnuel>=20?'‚úì Bon':txMargeAnnuel>=5?'‚ö† Moyen':'‚ö† Faible'}</span></td></tr>
        </tbody>
      </table>
    </div>
  `;

  // Responsive grid pr√©visions sur mobile
  if(window.innerWidth<=768){
    const g=document.getElementById('prev-fid-grid');
    if(g)g.style.gridTemplateColumns='1fr';
  }

  buildCharts(monthsData,currentIdx,year,hasAnnualData,fiscalMonths);
}

function buildCharts(monthsData,currentIdx,year,hasAnnualData,fiscalMonths){
  const labels=(fiscalMonths||[]).map(fm=>MONTHS_SHORT[fm.month])||MONTHS_SHORT;
  const caHT=monthsData.map(d=>d.caHT);
  const chargesHT=monthsData.map(d=>d.chargesHT);
  const resultats=monthsData.map(d=>d.resultat);
  const cashflows=monthsData.map(d=>d.cashflow);
  const current=monthsData[currentIdx];
  // Pr√©visions en barres transparentes pour les mois futurs
  const caHTFut=monthsData.map(d=>d.isFuture&&d.prevCA>0?d.prevCA:null);

  let cumCA=0,cumCh=0;
  const cumulDiff=monthsData.map(d=>{cumCA+=d.caHT;cumCh+=d.chargesHT;return cumCA-cumCh;});

  const font={size:11,family:'Plus Jakarta Sans'};
  const tick='#9ca3af';
  const grid='#f1f5f9';
  const baseScales={x:{grid:{display:false},ticks:{font,color:tick}},y:{grid:{color:grid},ticks:{font,color:tick,callback:v=>fmtK(v)}}};

  // CA vs Charges
  const c1ctx=document.getElementById('caChart').getContext('2d');
  const c1=new Chart(c1ctx,{type:'bar',data:{labels,datasets:[
    {label:'CA HT',data:caHT,backgroundColor:'rgba(26,61,206,0.8)',borderRadius:5,order:2},
    {label:'CA pr√©vi.',data:caHTFut,backgroundColor:'rgba(245,158,11,0.35)',borderRadius:5,order:2,borderDash:[4,4]},
    {label:'Charges HT',data:chargesHT,backgroundColor:'rgba(245,158,11,0.6)',borderRadius:5,order:2},
    {label:'R√©sultat',data:resultats,type:'line',borderColor:resultats.map(v=>v>=0?'#10b981':'#ef4444'),borderWidth:0,pointRadius:4,pointBackgroundColor:resultats.map(v=>v>=0?'#10b981':'#ef4444'),fill:false,tension:0.4,order:1}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{font,color:'#6b7280',padding:10,boxWidth:10}}},scales:baseScales}});
  _charts.push(c1);

  const hasCharges=current.fixesHT>0||current.varHT>0||current.creditsHT>0||current.leasingHT>0;
  const c2=new Chart(document.getElementById('coutChart'),{type:'doughnut',data:{
    labels:['Charges fixes','Charges var.','Emprunts','Leasing'],
    datasets:[{data:hasCharges?[current.fixesHT,current.varHT,current.creditsHT,current.leasingHT]:[1,1,1,1],backgroundColor:['#1a3dce','#4f7ef8','#f59e0b','#10b981'],borderWidth:0,hoverOffset:6}]
  },options:{responsive:true,maintainAspectRatio:false,cutout:'65%',plugins:{legend:{position:'bottom',labels:{font,color:'#6b7280',padding:10,boxWidth:10}}}}});
  _charts.push(c2);

  const c3=new Chart(document.getElementById('resultatChart'),{type:'bar',data:{labels,datasets:[{label:'R√©sultat HT',data:resultats,backgroundColor:resultats.map(v=>v>0?'rgba(16,185,129,0.8)':v<0?'rgba(239,68,68,0.8)':'rgba(209,213,219,0.5)'),borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:baseScales}});
  _charts.push(c3);

  const c4=new Chart(document.getElementById('cashflowChart'),{type:'bar',data:{labels,datasets:[{label:'Cashflow',data:cashflows,backgroundColor:cashflows.map(v=>v>0?'rgba(99,102,241,0.8)':v<0?'rgba(239,68,68,0.7)':'rgba(209,213,219,0.5)'),borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:baseScales}});
  _charts.push(c4);

  const c5ctx=document.getElementById('cumulChart').getContext('2d');
  const gC=c5ctx.createLinearGradient(0,0,0,200);gC.addColorStop(0,'rgba(99,102,241,0.2)');gC.addColorStop(1,'rgba(99,102,241,0)');
  const c5=new Chart(c5ctx,{type:'line',data:{labels,datasets:[{label:'Cumul CA‚àíCharges',data:cumulDiff,borderColor:'#6366f1',borderWidth:2.5,backgroundColor:gC,fill:true,tension:0.4,pointRadius:3,pointBackgroundColor:cumulDiff.map(v=>v>=0?'#10b981':'#ef4444')}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:baseScales}});
  _charts.push(c5);
}

function fmtE(n){return (parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨';}
function fmtK(v){const n=parseFloat(v)||0;return Math.abs(n)>=1000?(n/1000).toFixed(1)+'k‚Ç¨':n.toFixed(0)+'‚Ç¨';}

window.loadData=loadData;
function reloadView(){loadData();}

/* ‚îÄ‚îÄ‚îÄ SIDEBAR MOBILE ‚îÄ‚îÄ‚îÄ */
(function(){
  function getSidebar(){return document.querySelector('nav,aside.sidebar,.sidebar');}
  document.addEventListener('DOMContentLoaded',function(){
    var s=getSidebar();if(!s)return;
    s.querySelectorAll('.ni,.si,.nav-item,.sub-item').forEach(function(el){
      el.addEventListener('click',function(){if(window.innerWidth<=768)window.alteoreCloseSidebar();});
    });
  });
})();

document.addEventListener('DOMContentLoaded',function(){
  // KPIs menu ferm√© par d√©faut
  // Marquer page active
  var nd=document.querySelector('.nav-item.active');
  // G√©rer la grille pr√©visions sur mobile
  window.addEventListener('resize',function(){
    var g=document.getElementById('prev-fid-grid');
    if(!g)return;
    g.style.gridTemplateColumns=window.innerWidth<=768?'1fr':'1.4fr 0.8fr 0.8fr';
  });
});
window.toggleMenu=toggleMenu;
window.handleLogout=handleLogout;
window.setViewMode=setViewMode;
window.setFiscalStart=setFiscalStart;
</script>
<script src="nav.js"></script>
</body>
</html>
