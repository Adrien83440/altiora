<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>ALTEORE ‚Äî Rapport Annuel</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --blue-dark:#0f1f5c;--blue-main:#1a3dce;--blue-light:#4f7ef8;
  --blue-ghost:#f0f4ff;--white:#fff;--text:#1a1f36;--muted:#6b7280;
  --border:#e2e8f0;--bg:#f5f7ff;--sidebar-w:252px;--radius:14px;
  --green:#10b981;--orange:#f59e0b;--red:#ef4444;--purple:#6366f1;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#0f1f5c 0%,#162366 100%);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;overflow-y:auto}
.sidebar-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 22px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:10px}
.sidebar-logo-icon{width:36px;height:36px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px}
.sidebar-logo-text{font-size:18px;font-weight:800;color:white;letter-spacing:1px}
.sidebar-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,0.3);letter-spacing:1.2px;text-transform:uppercase;padding:14px 20px 5px}
.nav-item{display:flex;align-items:center;gap:11px;padding:10px 20px;color:rgba(255,255,255,0.6);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;user-select:none}
.nav-item:hover{color:white;background:rgba(255,255,255,0.06)}
.nav-item.active{color:white;background:rgba(255,255,255,0.1);border-left-color:#4f7ef8}
.nav-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0}
.nav-label{flex:1}
.nav-badge{background:rgba(79,126,248,0.3);color:#a5b4fc;font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px}
.nav-chevron{font-size:11px;color:rgba(255,255,255,0.3);transition:transform 0.25s;margin-left:auto}
.nav-item.open .nav-chevron{transform:rotate(90deg)}
.submenu{overflow:hidden;max-height:0;transition:max-height 0.3s ease}
.submenu.open{max-height:300px}
.sub-item{display:flex;align-items:center;gap:9px;padding:8px 20px 8px 44px;color:rgba(255,255,255,0.45);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s}
.sub-item:hover{color:rgba(255,255,255,0.8);background:rgba(255,255,255,0.05)}
.sub-dot{width:5px;height:5px;background:rgba(255,255,255,0.3);border-radius:50%;flex-shrink:0}
.sub-year-badge{margin-left:auto;font-size:10px;color:rgba(255,255,255,0.25);font-weight:600}
.nav-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 20px 4px}
.sidebar-footer{margin-top:auto;padding:16px 20px 0;border-top:1px solid rgba(255,255,255,0.08)}
.user-card{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.07);border-radius:10px;cursor:pointer;transition:.15s}
.user-card:hover{background:rgba(255,255,255,.12)}
.user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--blue-light),#6366f1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0}
.user-name{font-size:12px;font-weight:600;color:white}
.user-plan{font-size:10px;color:rgba(255,255,255,0.4)}
.logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:14px;padding:4px}
.logout-btn:hover{color:rgba(255,255,255,0.7)}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{background:white;border-bottom:1px solid var(--border);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.topbar-left h1{font-size:18px;font-weight:700}
.topbar-left p{font-size:12px;color:var(--muted);margin-top:1px}
.topbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:.2s}
.btn-primary{background:linear-gradient(135deg,var(--blue-main),var(--blue-light));color:white;box-shadow:0 3px 10px rgba(26,61,206,0.3)}
.btn-primary:hover{opacity:.9;transform:translateY(-1px)}
.btn-outline{background:white;color:var(--blue-main);border:1.5px solid var(--border)}
.btn-outline:hover{border-color:var(--blue-main);background:var(--blue-ghost)}
.btn-green{background:linear-gradient(135deg,#10b981,#059669);color:white;box-shadow:0 3px 10px rgba(16,185,129,0.3)}
.btn-green:hover{opacity:.9}
.btn-orange{background:linear-gradient(135deg,#f59e0b,#d97706);color:white}

.content{padding:28px 32px;flex:1}

/* ‚îÄ‚îÄ CONFIG BAR ‚îÄ‚îÄ */
.config-bar{background:white;border-radius:var(--radius);border:1px solid var(--border);padding:20px 24px;margin-bottom:24px;display:flex;align-items:center;gap:20px;flex-wrap:wrap}
.config-group{display:flex;flex-direction:column;gap:5px}
.config-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.config-select{padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;color:var(--text);background:white;cursor:pointer;transition:.15s;outline:none}
.config-select:focus{border-color:var(--blue-main)}
.config-divider{width:1px;height:48px;background:var(--border);margin:0 4px}
.config-actions{margin-left:auto;display:flex;gap:10px}

/* ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ */
.loader-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;gap:16px;color:var(--muted)}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--blue-main);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ KPI GRID ‚îÄ‚îÄ */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
.kpi-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;overflow:hidden;transition:.2s}
.kpi-card:hover{box-shadow:0 6px 24px rgba(26,61,206,.08);transform:translateY(-1px)}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi-card.blue::before{background:linear-gradient(90deg,var(--blue-main),var(--blue-light))}
.kpi-card.green::before{background:linear-gradient(90deg,#10b981,#34d399)}
.kpi-card.orange::before{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.kpi-card.red::before{background:linear-gradient(90deg,#ef4444,#f87171)}
.kpi-card.purple::before{background:linear-gradient(90deg,#6366f1,#a5b4fc)}
.kpi-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;margin-bottom:12px}
.kpi-card.blue .kpi-icon{background:#eff6ff}
.kpi-card.green .kpi-icon{background:#f0fdf4}
.kpi-card.orange .kpi-icon{background:#fffbeb}
.kpi-card.red .kpi-icon{background:#fef2f2}
.kpi-card.purple .kpi-icon{background:#eef2ff}
.kpi-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.kpi-value{font-size:22px;font-weight:800;color:var(--text);margin-bottom:4px;letter-spacing:-.5px}
.kpi-value.positive{color:var(--green)}
.kpi-value.negative{color:var(--red)}
.kpi-sub{font-size:11px;color:var(--muted)}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.section-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:14px;display:flex;align-items:center;gap:8px}
.section-label::after{content:'';flex:1;height:1px;background:var(--border)}
.card{background:white;border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;margin-bottom:24px}
.card-header{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.card-title{font-size:14px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{background:var(--blue-ghost);color:var(--blue-main);font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.5px;padding:10px 16px;text-align:right}
thead th:first-child{text-align:left}
tbody tr{border-bottom:1px solid var(--border);transition:.15s}
tbody tr:hover{background:#fafbff}
tbody tr:last-child{border-bottom:none}
td{padding:11px 16px;text-align:right;color:var(--text)}
td:first-child{text-align:left;font-weight:600}
.total-row td{background:var(--blue-ghost);font-weight:800;color:var(--blue-dark);border-top:2px solid var(--border)}
.positive-cell{color:var(--green);font-weight:700}
.negative-cell{color:var(--red);font-weight:700}
.month-chip{display:inline-block;background:var(--blue-ghost);color:var(--blue-main);padding:3px 8px;border-radius:6px;font-size:12px;font-weight:700}

/* ‚îÄ‚îÄ R√âSUM√â EXERCICE ‚îÄ‚îÄ */
.summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.summary-box{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.summary-box h3{font-size:13px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:14px}
.summary-item{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);font-size:13px}
.summary-item:last-child{border-bottom:none}
.summary-item span:first-child{color:var(--muted)}
.summary-item span:last-child{font-weight:700;color:var(--text)}

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-state .big{font-size:48px;margin-bottom:12px}
.empty-state h3{font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px}

/* ‚îÄ‚îÄ MOBILE ‚îÄ‚îÄ */
@media(max-width:900px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .main{margin-left:0}
  .kpi-row{grid-template-columns:repeat(2,1fr)}
  .summary-grid{grid-template-columns:1fr}
  .config-bar{flex-direction:column;align-items:flex-start}
  .config-actions{width:100%;margin-left:0}
  .config-actions .btn{flex:1;text-align:center}
}
@media(max-width:480px){
  .kpi-row{grid-template-columns:1fr 1fr}
  .content{padding:16px}
  .topbar{padding:14px 16px}
}
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:200;background:var(--blue-dark);border:none;border-radius:8px;padding:8px;cursor:pointer;flex-direction:column;gap:4px}
.hamburger span{display:block;width:18px;height:2px;background:white;border-radius:2px}
@media(max-width:900px){.hamburger{display:flex}}
.nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:99}
.sidebar.open ~ .main .nav-overlay,.nav-overlay.open{display:block}
</style>
</head>
<body>

<button class="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
<div class="nav-overlay" id="navOverlay" onclick="closeSidebar()"></div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon">üìä</div>
    <div class="sidebar-logo-text">ALTEORE</div>
  </div>
  <div class="sidebar-section-label">Principal</div>
  <div class="nav-item" onclick="location.href='dashboard.html'"><span class="nav-icon">üè†</span><span class="nav-label">Tableau de bord</span></div>
  <div class="nav-item" onclick="location.href='suivi-ca.html'"><span class="nav-icon">üìà</span><span class="nav-label">Suivi CA & R√©sultats</span></div>
  <div class="nav-item" id="kpis-nav" onclick="toggleMenu('kpis-menu',this)"><span class="nav-icon">üéØ</span><span class="nav-label">KPIs Cl√©s</span><span class="nav-chevron">‚Ä∫</span></div>
  <div class="submenu" id="kpis-menu">
    <div class="sub-item" onclick="location.href='cout-revient.html'"><span class="sub-dot"></span>Co√ªt de revient</div>
    <div class="sub-item" onclick="location.href='marges.html'"><span class="sub-dot"></span>Marge brute & nette</div>
    <div class="sub-item" onclick="location.href='panier-moyen.html'"><span class="sub-dot"></span>Panier moyen</div>
  </div>
  <div class="nav-item" onclick="toggleMenu('pilotage-menu',this)"><span class="nav-icon">üß≠</span><span class="nav-label">Pilotage</span><span class="nav-chevron">‚Ä∫</span></div>
  <div class="submenu" id="pilotage-menu">
    <div class="sub-item" onclick="location.href='pilotage.html?year=2025'"><span class="sub-dot"></span>Pilotage 2025<span class="sub-year-badge">2025</span></div>
    <div class="sub-item" onclick="location.href='pilotage.html?year=2026'"><span class="sub-dot"></span>Pilotage 2026<span class="sub-year-badge">2026</span></div>
    <div class="sub-item" onclick="location.href='pilotage.html?year=2027'"><span class="sub-dot"></span>Pilotage 2027<span class="sub-year-badge">2027</span></div>
    <div class="sub-item" onclick="location.href='cashflow.html'" style="border-top:1px solid rgba(255,255,255,.06);margin-top:4px;padding-top:8px"><span class="sub-dot" style="background:#0d9488"></span>üíß Cashflow</div>
  </div>
  <div class="nav-item" onclick="location.href='dettes.html'"><span class="nav-icon">üè¶</span><span class="nav-label">Dettes & Emprunts</span></div>
  <div class="nav-section-label">Rapports</div>
  <div class="nav-item active"><span class="nav-icon">üìÑ</span><span class="nav-label">Rapport annuel PDF</span><span class="nav-badge">Nouveau</span></div>
  <div class="nav-section-label">Intelligence IA</div>
  <div class="nav-item" onclick="location.href='bilan.html'"><span class="nav-icon">ü§ñ</span><span class="nav-label">Analyse de Bilan</span><span class="nav-badge">IA</span></div>
  <div class="nav-section-label">Fid√©lisation</div>
  <div class="nav-item" onclick="toggleFidNav(this)" style="justify-content:space-between">
    <span style="display:flex;align-items:center;gap:8px"><span class="nav-icon">üíé</span><span class="nav-label">Fid√©lisation</span></span>
    <span class="nav-chev" style="font-size:11px;color:rgba(255,255,255,.3);transition:transform .25s">‚Ä∫</span>
  </div>
  <div class="nav-fid-sub" id="fid-nav-sub" style="overflow:hidden;max-height:0;transition:max-height .35s ease">
    <div class="sub-item" onclick="location.href='fidelisation.html'"><span class="sub-dot"></span>Dashboard fid√©lit√©</div>
    <div class="sub-item" onclick="location.href='fidelisation.html#clients'"><span class="sub-dot"></span>Clients</div>
  </div>
  <div class="nav-item" onclick="location.href='import.html'" style="border-top:1px solid rgba(255,255,255,.08);padding-top:10px"><span class="nav-icon">üì•</span><span class="nav-label">Import de donn√©es</span></div>
  <div class="sidebar-footer">
    <div class="user-card" onclick="location.href='profil.html'">
      <div class="user-avatar" id="userAvatar">A</div>
      <div><div class="user-name" id="userName">Utilisateur</div><div class="user-plan" id="uplan">‚Äî</div></div>
      <button class="logout-btn" onclick="handleLogout(event)">‚éã</button>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>üìÑ Rapport Annuel</h1>
      <p id="pageSubtitle">Situation financi√®re synth√©tique</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline" onclick="window.print()">üñ®Ô∏è Imprimer</button>
      <button class="btn btn-primary" id="btnPdf" onclick="exportPDF()">‚¨áÔ∏è T√©l√©charger le PDF</button>
    </div>
  </div>

  <div class="content" id="mainContent">
    <div class="loader-wrap"><div class="spinner"></div><span>Chargement...</span></div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
  authDomain:"altiora-70599.firebaseapp.com",
  projectId:"altiora-70599",
  storageBucket:"altiora-70599.firebasestorage.app",
  messagingSenderId:"120905555746",
  appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
});
const auth = getAuth(app);
const db   = getFirestore(app);

window._auth = auth; window._db = db; window._doc = doc;
window._getDoc = getDoc; window._getDocs = getDocs;
window._collection = collection; window._signOut = signOut;

onAuthStateChanged(auth, async user => {
  if (!user) { window.location.href = 'index.html'; return; }
  window._uid = user.uid;
  const name = user.displayName || user.email.split('@')[0];
  document.getElementById('userName').textContent = name;
  document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
  window._userEmail = user.email;
  window._userName  = name;
  window._firebaseReady = true;
  window.initRapport();
});
</script>

<script src="nav.js"></script>

<script>
const MONTHS_FR = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
const MONTHS_SHORT = ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];

// ‚îÄ‚îÄ utils
function fmt(n, decimals=0) {
  if (n === undefined || n === null || isNaN(n)) return '‚Äî';
  return n.toLocaleString('fr-FR', {minimumFractionDigits: decimals, maximumFractionDigits: decimals}) + ' ‚Ç¨';
}
function pct(n) {
  if (!n || isNaN(n)) return '‚Äî';
  return (n >= 0 ? '+' : '') + n.toFixed(1) + ' %';
}
function parseCA(r) {
  const h055 = parseFloat(r.ht055)||0, h10 = parseFloat(r.ht10)||0, h20 = parseFloat(r.ht20)||0;
  const multi = h055 + h10 + h20;
  return multi > 0 ? multi : (parseFloat(r.montantHT)||0);
}

// ‚îÄ‚îÄ global data
let _allData = {};      // {YYYY-MM: monthData}
let _dettesData = [];
let _selectedYear = new Date().getFullYear();
let _nomCommerce = '';

// ‚îÄ‚îÄ nav helpers
function toggleMenu(id, el) {
  document.getElementById(id).classList.toggle('open');
  el.classList.toggle('open');
}
function toggleFidNav(el) {
  const sub = document.getElementById('fid-nav-sub');
  const chev = el.querySelector('.nav-chev');
  const open = sub.style.maxHeight !== '0px' && sub.style.maxHeight !== '';
  sub.style.maxHeight = open ? '0px' : '300px';
  if (chev) chev.style.transform = open ? '' : 'rotate(90deg)';
}
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('navOverlay').classList.toggle('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('navOverlay').classList.remove('open');
}
async function handleLogout(e) {
  if (e) e.stopPropagation();
  await window._signOut(window._auth);
  window.location.href = 'index.html';
}

// ‚îÄ‚îÄ init
window.initRapport = async function() {
  await loadUserInfo();
  buildControls();
  await loadYear(_selectedYear);
};

async function loadUserInfo() {
  try {
    const snap = await window._getDoc(window._doc(window._db, 'users', window._uid));
    if (snap.exists()) {
      const d = snap.data();
      _nomCommerce = d.nomCommerce || d.nom || window._userName || '';
    }
  } catch(e) {}
}

function buildControls() {
  const curYear = new Date().getFullYear();
  const years = [curYear - 2, curYear - 1, curYear].filter(y => y >= 2023);

  let opts = years.map(y => `<option value="${y}" ${y === _selectedYear ? 'selected' : ''}>${y}</option>`).join('');

  document.getElementById('mainContent').innerHTML = `
    <div class="config-bar">
      <div class="config-group">
        <div class="config-label">Ann√©e / Exercice</div>
        <select class="config-select" id="yearSelect" onchange="changeYear(this.value)">
          ${opts}
        </select>
      </div>
      <div class="config-divider"></div>
      <div class="config-group">
        <div class="config-label">Nom du commerce</div>
        <input id="nomCommerce" type="text" class="config-select" style="width:200px"
          placeholder="Mon commerce" value="${_nomCommerce}"
          oninput="_nomCommerce=this.value">
      </div>
      <div class="config-actions">
        <button class="btn btn-outline" onclick="window.print()">üñ®Ô∏è Imprimer</button>
        <button class="btn btn-primary" onclick="exportPDF()">‚¨áÔ∏è T√©l√©charger le PDF</button>
      </div>
    </div>
    <div id="rapportBody">
      <div class="loader-wrap"><div class="spinner"></div><span>Chargement des donn√©es...</span></div>
    </div>
  `;
}

async function changeYear(y) {
  _selectedYear = parseInt(y);
  await loadYear(_selectedYear);
}

async function loadYear(year) {
  const el = document.getElementById('rapportBody');
  if (!el) return;
  el.innerHTML = `<div class="loader-wrap"><div class="spinner"></div><span>Chargement ${year}...</span></div>`;

  try {
    const monthsRef = window._collection(window._db, 'pilotage', window._uid, 'months');
    const snap = await window._getDocs(monthsRef);
    _allData = {};
    snap.forEach(d => { _allData[d.id] = d.data(); });

    // dettes
    try {
      const dSnap = await window._getDoc(window._doc(window._db, 'dettes', window._uid, 'data', 'all'));
      _dettesData = dSnap.exists() ? (dSnap.data().list || []) : [];
    } catch(e) { _dettesData = []; }

    renderRapport(year);
  } catch(e) {
    el.innerHTML = `<div class="empty-state"><div class="big">‚ö†Ô∏è</div><h3>Erreur de chargement</h3><p>${e.message}</p></div>`;
  }
}

function getMonthData(year, month) {
  const key = `${year}-${String(month + 1).padStart(2, '0')}`;
  return _allData[key] || null;
}

function computeMonth(d) {
  if (!d) return { caHT: 0, fixe: 0, variable: 0, credit: 0, leasing: 0, charges: 0, resultat: 0 };
  const caHT = (d.ca || []).reduce((s, r) => s + parseCA(r), 0);
  const fixe = (d.chargesFixe || []).reduce((s, r) => s + (parseFloat(r.montant)||0), 0);
  const variable = (d.chargesVar || []).reduce((s, r) => s + (parseFloat(r.montant)||0), 0);
  const credit = (d.credits || []).reduce((s, r) => s + (parseFloat(r.mensualite)||0), 0);
  const leasing = (d.leasing || []).reduce((s, r) => s + (parseFloat(r.loyer)||0), 0);
  const charges = fixe + variable + credit + leasing;
  const resultat = caHT - charges;
  return { caHT, fixe, variable, credit, leasing, charges, resultat };
}

function renderRapport(year) {
  const el = document.getElementById('rapportBody');
  if (!el) return;

  // Compute all months
  let months = [];
  let totCA = 0, totFixe = 0, totVar = 0, totCredit = 0, totLeasing = 0, totCharges = 0, totResultat = 0;
  let meilleurMois = null, pireResultat = null;

  for (let m = 0; m < 12; m++) {
    const d = getMonthData(year, m);
    const r = computeMonth(d);
    months.push({ m, ...r, hasData: !!d });
    totCA += r.caHT;
    totFixe += r.fixe;
    totVar += r.variable;
    totCredit += r.credit;
    totLeasing += r.leasing;
    totCharges += r.charges;
    totResultat += r.resultat;

    if (r.hasData || r.caHT > 0) {
      if (!meilleurMois || r.caHT > meilleurMois.caHT) meilleurMois = { ...r, m };
      if (!pireResultat || r.resultat < pireResultat.resultat) pireResultat = { ...r, m };
    }
  }

  const moisAvecDonnees = months.filter(m => m.hasData || m.caHT > 0).length;
  const tauxCharges = totCA > 0 ? (totCharges / totCA) * 100 : 0;
  const margeNette = totCA > 0 ? (totResultat / totCA) * 100 : 0;

  // Dettes actives
  const dettesActives = _dettesData.filter(d => d.statut !== 'soldee' && d.statut !== 'sold√©');
  const totalDettes = dettesActives.reduce((s, d) => s + (parseFloat(d.montantRestant || d.montant) || 0), 0);

  const nom = _nomCommerce || 'Mon Commerce';
  document.getElementById('pageSubtitle').textContent = `${nom} ¬∑ Exercice ${year}`;
  document.title = `Rapport ${year} ‚Äî ${nom} ‚Äî ALTEORE`;

  el.innerHTML = `
    <!-- En-t√™te rapport -->
    <div id="rapport-zone">
      <div style="background:linear-gradient(135deg,var(--blue-dark),var(--blue-main));border-radius:var(--radius);padding:28px 32px;margin-bottom:24px;color:white;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px">
        <div>
          <div style="font-size:11px;font-weight:700;opacity:.6;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">Rapport de situation financi√®re</div>
          <div style="font-size:26px;font-weight:900;margin-bottom:4px">${nom}</div>
          <div style="font-size:14px;opacity:.75">Exercice ${year} ‚Äî G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'})}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:11px;font-weight:700;opacity:.6;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px">G√©n√©r√© via</div>
          <div style="font-size:18px;font-weight:900;letter-spacing:1px">ALTEORE</div>
          <div style="font-size:11px;opacity:.5;margin-top:2px">alteore.com</div>
        </div>
      </div>

      <!-- KPIs annuels -->
      <div class="section-label">Indicateurs cl√©s de l'exercice ${year}</div>
      <div class="kpi-row">
        <div class="kpi-card blue">
          <div class="kpi-icon">üí∞</div>
          <div class="kpi-label">CA Total HT</div>
          <div class="kpi-value">${fmt(totCA)}</div>
          <div class="kpi-sub">${moisAvecDonnees} mois saisis</div>
        </div>
        <div class="kpi-card orange">
          <div class="kpi-icon">üì§</div>
          <div class="kpi-label">Charges Totales</div>
          <div class="kpi-value">${fmt(totCharges)}</div>
          <div class="kpi-sub">${tauxCharges.toFixed(1)}% du CA</div>
        </div>
        <div class="kpi-card ${totResultat >= 0 ? 'green' : 'red'}">
          <div class="kpi-icon">${totResultat >= 0 ? 'üìà' : 'üìâ'}</div>
          <div class="kpi-label">R√©sultat Net Estim√©</div>
          <div class="kpi-value ${totResultat >= 0 ? 'positive' : 'negative'}">${fmt(totResultat)}</div>
          <div class="kpi-sub">Marge nette : ${margeNette.toFixed(1)}%</div>
        </div>
        <div class="kpi-card purple">
          <div class="kpi-icon">üè¶</div>
          <div class="kpi-label">Dettes en cours</div>
          <div class="kpi-value">${fmt(totalDettes)}</div>
          <div class="kpi-sub">${dettesActives.length} emprunt(s) actif(s)</div>
        </div>
      </div>

      <!-- Tableau mensuel -->
      <div class="section-label">Compte de r√©sultat simplifi√© ‚Äî mois par mois</div>
      <div class="card" style="margin-bottom:24px">
        <div class="card-header">
          <div class="card-title">üìÖ D√©tail mensuel ${year}</div>
          <div style="font-size:11px;color:var(--muted)">Montants HT en ‚Ç¨</div>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead>
              <tr>
                <th>Mois</th>
                <th>CA HT</th>
                <th>Ch. Fixes</th>
                <th>Ch. Variables</th>
                <th>Cr√©dits / Leasing</th>
                <th>Total Charges</th>
                <th>R√©sultat</th>
              </tr>
            </thead>
            <tbody>
              ${months.map(r => {
                const empty = !r.hasData && r.caHT === 0;
                return `<tr>
                  <td><span class="month-chip">${MONTHS_SHORT[r.m]}</span></td>
                  <td>${empty ? '<span style="color:#d1d5db">‚Äî</span>' : fmt(r.caHT)}</td>
                  <td>${empty ? '<span style="color:#d1d5db">‚Äî</span>' : fmt(r.fixe)}</td>
                  <td>${empty ? '<span style="color:#d1d5db">‚Äî</span>' : fmt(r.variable)}</td>
                  <td>${empty ? '<span style="color:#d1d5db">‚Äî</span>' : fmt(r.credit + r.leasing)}</td>
                  <td>${empty ? '<span style="color:#d1d5db">‚Äî</span>' : fmt(r.charges)}</td>
                  <td class="${empty ? '' : (r.resultat >= 0 ? 'positive-cell' : 'negative-cell')}">${empty ? '<span style="color:#d1d5db">‚Äî</span>' : fmt(r.resultat)}</td>
                </tr>`;
              }).join('')}
            </tbody>
            <tfoot>
              <tr class="total-row">
                <td>TOTAL ${year}</td>
                <td>${fmt(totCA)}</td>
                <td>${fmt(totFixe)}</td>
                <td>${fmt(totVar)}</td>
                <td>${fmt(totCredit + totLeasing)}</td>
                <td>${fmt(totCharges)}</td>
                <td class="${totResultat >= 0 ? 'positive-cell' : 'negative-cell'}">${fmt(totResultat)}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>

      <!-- Synth√®se et dettes c√¥te √† c√¥te -->
      <div class="summary-grid">
        <!-- Analyse -->
        <div class="summary-box">
          <h3>üìä Analyse de l'exercice</h3>
          <div class="summary-item"><span>Chiffre d'affaires HT</span><span>${fmt(totCA)}</span></div>
          <div class="summary-item"><span>Dont charges fixes</span><span>${fmt(totFixe)}</span></div>
          <div class="summary-item"><span>Dont charges variables</span><span>${fmt(totVar)}</span></div>
          <div class="summary-item"><span>Dont cr√©dits & leasing</span><span>${fmt(totCredit + totLeasing)}</span></div>
          <div class="summary-item"><span>Total charges</span><span>${fmt(totCharges)}</span></div>
          <div class="summary-item" style="border-top:2px solid var(--border);padding-top:12px;margin-top:4px">
            <span style="font-weight:700;color:var(--text)">R√©sultat net estim√©</span>
            <span style="font-size:17px;color:${totResultat >= 0 ? 'var(--green)' : 'var(--red)'}">${fmt(totResultat)}</span>
          </div>
          <div class="summary-item"><span>Taux de charges / CA</span><span>${tauxCharges.toFixed(1)} %</span></div>
          <div class="summary-item"><span>Marge nette</span><span>${margeNette.toFixed(1)} %</span></div>
          ${meilleurMois ? `<div class="summary-item"><span>Meilleur mois (CA)</span><span>${MONTHS_FR[meilleurMois.m]} ‚Äî ${fmt(meilleurMois.caHT)}</span></div>` : ''}
          ${moisAvecDonnees > 0 ? `<div class="summary-item"><span>CA mensuel moyen</span><span>${fmt(totCA / moisAvecDonnees)}</span></div>` : ''}
        </div>

        <!-- Dettes -->
        <div class="summary-box">
          <h3>üè¶ Dettes & Emprunts en cours</h3>
          ${dettesActives.length === 0
            ? `<div style="text-align:center;padding:30px;color:var(--muted);font-size:13px">
                <div style="font-size:32px;margin-bottom:8px">‚úÖ</div>
                Aucune dette active enregistr√©e
               </div>`
            : dettesActives.slice(0, 8).map(d => `
                <div class="summary-item">
                  <span>${d.libelle || d.nom || 'Emprunt'}</span>
                  <span>${fmt(parseFloat(d.montantRestant || d.montant) || 0)}</span>
                </div>
              `).join('') + (dettesActives.length > 8 ? `<div class="summary-item"><span>... et ${dettesActives.length - 8} autres</span><span></span></div>` : '') +
              `<div class="summary-item" style="border-top:2px solid var(--border);padding-top:12px;margin-top:4px">
                <span style="font-weight:700;color:var(--text)">Total engagements</span>
                <span style="font-size:16px;font-weight:800;color:var(--orange)">${fmt(totalDettes)}</span>
              </div>`
          }
        </div>
      </div>

      <!-- Note l√©gale -->
      <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:14px 18px;font-size:12px;color:#92400e;margin-bottom:8px">
        <strong>‚ö†Ô∏è Document indicatif</strong> ‚Äî Ce rapport est g√©n√©r√© automatiquement √† partir des donn√©es saisies dans Alteore. Il ne constitue pas un bilan comptable officiel ni un document fiscal. Consultez votre expert-comptable pour tout document officiel.
      </div>
      <div style="text-align:center;font-size:11px;color:var(--muted);padding:8px">
        G√©n√©r√© par ALTEORE ¬∑ alteore.com ¬∑ ${new Date().toLocaleDateString('fr-FR')}
      </div>
    </div><!-- fin rapport-zone -->
  `;
}

// ‚îÄ‚îÄ PDF EXPORT
async function exportPDF() {
  const btn = document.getElementById('btnPdf');
  const btnInConfig = document.querySelector('.config-actions .btn-primary');
  if (btn) { btn.disabled = true; btn.textContent = '‚è≥ G√©n√©ration...'; }
  if (btnInConfig) { btnInConfig.disabled = true; btnInConfig.textContent = '‚è≥ G√©n√©ration...'; }

  try {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

    const pageW = 210;
    const pageH = 297;
    const margin = 18;
    const colW = pageW - margin * 2;
    let y = 0;

    const nom = _nomCommerce || 'Mon Commerce';
    const year = _selectedYear;

    // Colors
    const BLUE_DARK = [15, 31, 92];
    const BLUE_MID  = [26, 61, 206];
    const BLUE_LIGHT= [79, 126, 248];
    const GREEN     = [16, 185, 129];
    const RED       = [239, 68, 68];
    const ORANGE    = [245, 158, 11];
    const GRAY_BG   = [248, 250, 255];
    const BORDER_C  = [226, 232, 240];
    const WHITE     = [255, 255, 255];
    const TEXT      = [26, 31, 54];
    const MUTED     = [107, 114, 128];

    function setFont(style, size, color) {
      doc.setFont('helvetica', style);
      doc.setFontSize(size);
      doc.setTextColor(...(color || TEXT));
    }

    function checkNewPage(needed) {
      if (y + needed > pageH - 16) {
        doc.addPage();
        y = 18;
        // mini footer on each page
        doc.setFillColor(...BLUE_DARK);
        doc.rect(0, pageH - 10, pageW, 10, 'F');
        setFont('normal', 7, WHITE);
        doc.text(`ALTEORE ¬∑ alteore.com ¬∑ Rapport ${year} ‚Äî ${nom}`, margin, pageH - 4);
        doc.text(`Page ${doc.getCurrentPageInfo().pageNumber}`, pageW - margin, pageH - 4, { align: 'right' });
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAGE 1 ‚Äî EN-T√äTE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Header gradient simulation
    doc.setFillColor(...BLUE_DARK);
    doc.rect(0, 0, pageW, 52, 'F');
    doc.setFillColor(...BLUE_MID);
    doc.rect(pageW * 0.55, 0, pageW * 0.45, 52, 'F');

    setFont('bold', 9, [255, 255, 255, 0.5]);
    doc.setTextColor(180, 190, 220);
    doc.text('RAPPORT DE SITUATION FINANCI√àRE', margin, 14);

    setFont('bold', 22, WHITE);
    doc.text(nom.length > 35 ? nom.substring(0, 33) + '‚Ä¶' : nom, margin, 28);

    setFont('normal', 9, [180, 190, 220]);
    doc.text(`Exercice ${year}  ¬∑  G√©n√©r√© le ${new Date().toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}`, margin, 38);

    // Logo Alteore (right)
    setFont('bold', 16, WHITE);
    doc.text('ALTEORE', pageW - margin, 26, { align: 'right' });
    setFont('normal', 8, [160, 175, 200]);
    doc.text('alteore.com', pageW - margin, 34, { align: 'right' });

    y = 62;

    // ‚îÄ‚îÄ Compute data
    let months = [];
    let totCA = 0, totFixe = 0, totVar = 0, totCredit = 0, totLeasing = 0, totCharges = 0, totResultat = 0;
    let meilleurMois = null, moisAvecDonnees = 0;

    for (let m = 0; m < 12; m++) {
      const d = getMonthData(year, m);
      const r = computeMonth(d);
      months.push({ m, ...r, hasData: !!d });
      totCA += r.caHT; totFixe += r.fixe; totVar += r.variable;
      totCredit += r.credit; totLeasing += r.leasing;
      totCharges += r.charges; totResultat += r.resultat;
      if (r.hasData || r.caHT > 0) {
        moisAvecDonnees++;
        if (!meilleurMois || r.caHT > meilleurMois.caHT) meilleurMois = { ...r, m };
      }
    }
    const tauxCharges = totCA > 0 ? (totCharges / totCA) * 100 : 0;
    const margeNette  = totCA > 0 ? (totResultat / totCA) * 100 : 0;
    const dettesActives = _dettesData.filter(d => d.statut !== 'soldee' && d.statut !== 'sold√©');
    const totalDettes = dettesActives.reduce((s, d) => s + (parseFloat(d.montantRestant || d.montant) || 0), 0);

    // ‚îÄ‚îÄ KPI boxes (4 across)
    setFont('bold', 8, MUTED);
    doc.text('INDICATEURS CL√âS DE L\'EXERCICE', margin, y);
    doc.setDrawColor(...BORDER_C);
    doc.line(margin + 62, y - 1, pageW - margin, y - 1);
    y += 6;

    const kpiW = (colW - 9) / 4;
    const kpiH = 24;
    const kpis = [
      { label: 'CA Total HT', value: fmt(totCA), sub: `${moisAvecDonnees} mois`, color: BLUE_MID },
      { label: 'Charges Totales', value: fmt(totCharges), sub: `${tauxCharges.toFixed(1)}% du CA`, color: ORANGE },
      { label: 'R√©sultat Net Estim√©', value: fmt(totResultat), sub: `Marge ${margeNette.toFixed(1)}%`, color: totResultat >= 0 ? GREEN : RED },
      { label: 'Dettes en cours', value: fmt(totalDettes), sub: `${dettesActives.length} emprunt(s)`, color: [99, 102, 241] },
    ];

    kpis.forEach((k, i) => {
      const x = margin + i * (kpiW + 3);
      doc.setFillColor(...GRAY_BG);
      doc.roundedRect(x, y, kpiW, kpiH, 2, 2, 'F');
      doc.setFillColor(...k.color);
      doc.rect(x, y, kpiW, 2, 'F');
      setFont('bold', 7, MUTED);
      doc.text(k.label.toUpperCase(), x + 3, y + 8);
      setFont('bold', 10, k.color);
      doc.text(k.value, x + 3, y + 16);
      setFont('normal', 7, MUTED);
      doc.text(k.sub, x + 3, y + 21);
    });
    y += kpiH + 12;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TABLEAU MENSUEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    checkNewPage(10);
    setFont('bold', 8, MUTED);
    doc.text('COMPTE DE R√âSULTAT SIMPLIFI√â ‚Äî MOIS PAR MOIS', margin, y);
    doc.setDrawColor(...BORDER_C);
    doc.line(margin + 88, y - 1, pageW - margin, y - 1);
    y += 5;

    // Table header
    const cols = [
      { label: 'Mois',             x: margin,       w: 16, align: 'left' },
      { label: 'CA HT',            x: margin + 18,  w: 28, align: 'right' },
      { label: 'Ch. Fixes',        x: margin + 48,  w: 28, align: 'right' },
      { label: 'Ch. Var.',         x: margin + 78,  w: 26, align: 'right' },
      { label: 'Cr√©d./Leas.',      x: margin + 106, w: 26, align: 'right' },
      { label: 'Tot. Charges',     x: margin + 134, w: 28, align: 'right' },
      { label: 'R√©sultat',         x: margin + 162, w: 28, align: 'right' },
    ];

    const rowH = 7;
    const hdrH = 8;

    doc.setFillColor(...BLUE_DARK);
    doc.rect(margin, y, colW, hdrH, 'F');
    cols.forEach(c => {
      setFont('bold', 7, WHITE);
      const tx = c.align === 'right' ? c.x + c.w : c.x;
      doc.text(c.label, tx, y + 5.5, { align: c.align });
    });
    y += hdrH;

    months.forEach((r, idx) => {
      checkNewPage(rowH + 2);
      const empty = !r.hasData && r.caHT === 0;
      doc.setFillColor(idx % 2 === 0 ? 255 : ...GRAY_BG);
      doc.rect(margin, y, colW, rowH, 'F');

      setFont('bold', 7, BLUE_MID);
      doc.text(MONTHS_SHORT[r.m], cols[0].x, y + 5);

      if (empty) {
        setFont('normal', 7, [209, 213, 219]);
        for (let ci = 1; ci < cols.length; ci++) {
          doc.text('‚Äî', cols[ci].x + cols[ci].w, y + 5, { align: 'right' });
        }
      } else {
        const vals = [null, r.caHT, r.fixe, r.variable, r.credit + r.leasing, r.charges, r.resultat];
        vals.forEach((v, ci) => {
          if (ci === 0) return;
          const c = cols[ci];
          const isRes = ci === 6;
          setFont('normal', 7, isRes ? (v >= 0 ? GREEN : RED) : TEXT);
          doc.text(fmt(v).replace(' ‚Ç¨','‚Ç¨'), c.x + c.w, y + 5, { align: 'right' });
        });
      }
      y += rowH;
    });

    // Total row
    checkNewPage(rowH + 2);
    doc.setFillColor(...BLUE_DARK);
    doc.rect(margin, y, colW, rowH + 1, 'F');
    setFont('bold', 7, WHITE);
    doc.text(`TOTAL ${year}`, cols[0].x, y + 5.5);
    const totVals = [null, totCA, totFixe, totVar, totCredit + totLeasing, totCharges, totResultat];
    totVals.forEach((v, ci) => {
      if (ci === 0) return;
      const c = cols[ci];
      setFont('bold', 7, WHITE);
      doc.text(fmt(v).replace(' ‚Ç¨','‚Ç¨'), c.x + c.w, y + 5.5, { align: 'right' });
    });
    y += rowH + 8;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SYNTH√àSE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    checkNewPage(90);
    setFont('bold', 8, MUTED);
    doc.text('SYNTH√àSE DE L\'EXERCICE', margin, y);
    doc.setDrawColor(...BORDER_C);
    doc.line(margin + 48, y - 1, pageW - margin, y - 1);
    y += 6;

    const boxW = (colW - 6) / 2;
    const startY = y;

    // Left box ‚Äî analyse
    doc.setFillColor(...GRAY_BG);
    doc.roundedRect(margin, y, boxW, 80, 2, 2, 'F');
    doc.setDrawColor(...BORDER_C);
    doc.roundedRect(margin, y, boxW, 80, 2, 2, 'S');

    setFont('bold', 8, BLUE_DARK);
    doc.text('Analyse financi√®re', margin + 4, y + 7);

    const analyseRows = [
      ['Chiffre d\'affaires HT', fmt(totCA)],
      ['Charges fixes', fmt(totFixe)],
      ['Charges variables', fmt(totVar)],
      ['Cr√©dits & Leasing', fmt(totCredit + totLeasing)],
      ['Total charges', fmt(totCharges)],
      ['Taux de charges / CA', tauxCharges.toFixed(1) + ' %'],
      ['Marge nette', margeNette.toFixed(1) + ' %'],
      meilleurMois ? ['Meilleur mois (CA)', `${MONTHS_FR[meilleurMois.m]} ‚Äî ${fmt(meilleurMois.caHT)}`] : null,
      moisAvecDonnees > 0 ? ['CA mensuel moyen', fmt(totCA / moisAvecDonnees)] : null,
    ].filter(Boolean);

    let ry = y + 12;
    analyseRows.forEach((row, i) => {
      if (i > 0) {
        doc.setDrawColor(...BORDER_C);
        doc.line(margin + 3, ry - 2, margin + boxW - 3, ry - 2);
      }
      setFont('normal', 7, MUTED);
      doc.text(row[0], margin + 4, ry + 3);
      setFont('bold', 7, i === 4 ? BLUE_DARK : TEXT);
      doc.text(row[1], margin + boxW - 4, ry + 3, { align: 'right' });
      ry += 7.5;
    });

    // R√©sultat final highlight
    const resY = y + 73;
    doc.setFillColor(...(totResultat >= 0 ? GREEN : RED));
    doc.rect(margin, resY, boxW, 7, 'F');
    setFont('bold', 8, WHITE);
    doc.text('R√©sultat net estim√©', margin + 4, resY + 5);
    doc.text(fmt(totResultat), margin + boxW - 4, resY + 5, { align: 'right' });

    // Right box ‚Äî dettes
    const bx = margin + boxW + 6;
    doc.setFillColor(...GRAY_BG);
    doc.roundedRect(bx, startY, boxW, 80, 2, 2, 'F');
    doc.setDrawColor(...BORDER_C);
    doc.roundedRect(bx, startY, boxW, 80, 2, 2, 'S');

    setFont('bold', 8, BLUE_DARK);
    doc.text('Dettes & Emprunts en cours', bx + 4, startY + 7);

    if (dettesActives.length === 0) {
      setFont('normal', 8, MUTED);
      doc.text('Aucune dette active enregistr√©e', bx + boxW / 2, startY + 42, { align: 'center' });
    } else {
      let dy = startY + 14;
      const maxDettes = Math.min(dettesActives.length, 7);
      dettesActives.slice(0, maxDettes).forEach((d, i) => {
        if (i > 0) {
          doc.setDrawColor(...BORDER_C);
          doc.line(bx + 3, dy - 2, bx + boxW - 3, dy - 2);
        }
        const label = (d.libelle || d.nom || 'Emprunt').substring(0, 22);
        setFont('normal', 7, TEXT);
        doc.text(label, bx + 4, dy + 3);
        setFont('bold', 7, ORANGE);
        doc.text(fmt(parseFloat(d.montantRestant || d.montant) || 0), bx + boxW - 4, dy + 3, { align: 'right' });
        dy += 7.5;
      });
      if (dettesActives.length > maxDettes) {
        setFont('normal', 7, MUTED);
        doc.text(`... et ${dettesActives.length - maxDettes} autres`, bx + 4, dy + 3);
      }
      // Total dettes
      doc.setFillColor(...ORANGE);
      doc.rect(bx, startY + 73, boxW, 7, 'F');
      setFont('bold', 8, WHITE);
      doc.text('Total engagements', bx + 4, startY + 78);
      doc.text(fmt(totalDettes), bx + boxW - 4, startY + 78, { align: 'right' });
    }

    y = startY + 88;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTE L√âGALE + FOOTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    checkNewPage(20);
    doc.setFillColor(255, 251, 235);
    doc.setDrawColor(253, 230, 138);
    doc.roundedRect(margin, y, colW, 14, 2, 2, 'FD');
    setFont('bold', 7, [146, 64, 14]);
    doc.text('‚ö† Document indicatif', margin + 4, y + 5);
    setFont('normal', 7, [146, 64, 14]);
    doc.text('Ce rapport est g√©n√©r√© automatiquement. Il ne constitue pas un bilan officiel ni un document fiscal.', margin + 4, y + 10);
    y += 20;

    // Footer final
    doc.setFillColor(...BLUE_DARK);
    doc.rect(0, pageH - 10, pageW, 10, 'F');
    setFont('normal', 7, WHITE);
    doc.text(`ALTEORE ¬∑ alteore.com ¬∑ Rapport financier ${year} ‚Äî ${nom}`, margin, pageH - 4);
    doc.text(`Page ${doc.getCurrentPageInfo().pageNumber}`, pageW - margin, pageH - 4, { align: 'right' });

    // Save
    const filename = `rapport-alteore-${year}-${nom.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')}.pdf`;
    doc.save(filename);

  } catch(e) {
    console.error('PDF error:', e);
    alert('Erreur lors de la g√©n√©ration du PDF : ' + e.message);
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = '‚¨áÔ∏è T√©l√©charger le PDF'; }
    const btnC = document.querySelector('.config-actions .btn-primary');
    if (btnC) { btnC.disabled = false; btnC.textContent = '‚¨áÔ∏è T√©l√©charger le PDF'; }
  }
}

// R√©expose pour le bouton topbar
window.exportPDF = exportPDF;

// ‚îÄ‚îÄ CSS print
const printStyle = document.createElement('style');
printStyle.textContent = `
  @media print {
    .sidebar, .topbar, .config-bar { display: none !important; }
    .main { margin-left: 0 !important; }
    .content { padding: 0 !important; }
    #rapport-zone { padding: 10px; }
    .kpi-card { break-inside: avoid; }
    table { break-inside: auto; }
    tr { break-inside: avoid; }
  }
`;
document.head.appendChild(printStyle);
</script>
</body>
</html>
