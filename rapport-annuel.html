<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>ALTEORE ‚Äî Situation Interm√©diaire</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --blue-dark:#0f1f5c;--blue-main:#1a3dce;--blue-light:#4f7ef8;
  --blue-ghost:#f0f4ff;--white:#fff;--text:#1a1f36;--muted:#6b7280;
  --border:#e2e8f0;--bg:#f5f7ff;--sidebar-w:252px;--radius:14px;
  --green:#10b981;--orange:#f59e0b;--red:#ef4444;--purple:#6366f1;--teal:#0d9488;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh}
/* SIDEBAR */
.sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#0f1f5c 0%,#162366 100%);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;overflow-y:auto}
.sidebar-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 22px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:10px}
.sidebar-logo-icon{width:36px;height:36px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px}
.sidebar-logo-text{font-size:18px;font-weight:800;color:white;letter-spacing:1px}
.nav-item{display:flex;align-items:center;gap:11px;padding:10px 20px;color:rgba(255,255,255,0.6);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;user-select:none}
.nav-item:hover{color:white;background:rgba(255,255,255,0.06)}
.nav-item.active{color:white;background:rgba(255,255,255,0.1);border-left-color:#4f7ef8}
.nav-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0}
.nav-label{flex:1}
.nav-badge{background:rgba(79,126,248,0.3);color:#a5b4fc;font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px}
.nav-chevron{font-size:11px;color:rgba(255,255,255,0.3);transition:transform 0.25s;margin-left:auto}
.nav-item.open .nav-chevron{transform:rotate(90deg)}
.submenu{overflow:hidden;max-height:0;transition:max-height 0.3s ease}
.submenu.open{max-height:300px}
.sub-item{display:flex;align-items:center;gap:9px;padding:8px 20px 8px 44px;color:rgba(255,255,255,0.45);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s}
.sub-item:hover{color:rgba(255,255,255,0.8);background:rgba(255,255,255,0.05)}
.sub-dot{width:5px;height:5px;background:rgba(255,255,255,0.3);border-radius:50%;flex-shrink:0}
.sub-year-badge{margin-left:auto;font-size:10px;color:rgba(255,255,255,0.25);font-weight:600}
.nav-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 20px 4px}
.sidebar-footer{margin-top:auto;padding:16px 20px 0;border-top:1px solid rgba(255,255,255,0.08)}
.user-card{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.07);border-radius:10px;cursor:pointer;transition:.15s}
.user-card:hover{background:rgba(255,255,255,.12)}
.user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--blue-light),#6366f1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0}
.user-name{font-size:12px;font-weight:600;color:white}.user-plan{font-size:10px;color:rgba(255,255,255,0.4)}
.logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:14px;padding:4px}
.logout-btn:hover{color:rgba(255,255,255,0.7)}
/* MAIN */
.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{background:white;border-bottom:1px solid var(--border);padding:16px 32px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.topbar-left h1{font-size:18px;font-weight:700}
.topbar-left p{font-size:12px;color:var(--muted);margin-top:1px}
.topbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:.2s}
.btn-primary{background:linear-gradient(135deg,var(--blue-main),var(--blue-light));color:white;box-shadow:0 3px 10px rgba(26,61,206,0.3)}
.btn-primary:hover{opacity:.9;transform:translateY(-1px)}
.btn-outline{background:white;color:var(--blue-main);border:1.5px solid var(--border)}
.btn-outline:hover{border-color:var(--blue-main);background:var(--blue-ghost)}
.content{padding:28px 32px;flex:1}
/* CONFIG BAR */
.config-bar{background:white;border-radius:var(--radius);border:1px solid var(--border);padding:18px 24px;margin-bottom:24px;display:flex;align-items:center;gap:20px;flex-wrap:wrap}
.config-group{display:flex;flex-direction:column;gap:5px}
.config-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.config-select{padding:8px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;color:var(--text);background:white;cursor:pointer;transition:.15s;outline:none}
.config-select:focus{border-color:var(--blue-main)}
.config-divider{width:1px;height:48px;background:var(--border);margin:0 4px}
.config-actions{margin-left:auto;display:flex;gap:10px}
.seg{display:flex;background:var(--bg);border:1.5px solid var(--border);border-radius:9px;padding:3px;gap:2px}
.seg-btn{padding:6px 14px;border-radius:6px;font-size:12px;font-weight:700;border:none;background:transparent;color:var(--muted);cursor:pointer;transition:.15s;white-space:nowrap}
.seg-btn.active{background:white;color:var(--blue-main);box-shadow:0 1px 4px rgba(0,0,0,.1)}
/* TABS */
.tabs-bar{display:flex;gap:4px;background:white;border:1px solid var(--border);border-radius:var(--radius);padding:6px;margin-bottom:20px;flex-wrap:wrap}
.tab-btn{padding:8px 18px;border-radius:9px;font-size:13px;font-weight:600;border:none;cursor:pointer;transition:.15s;color:var(--muted);background:transparent}
.tab-btn.active{background:var(--blue-ghost);color:var(--blue-main);font-weight:700}
.tab-btn:hover:not(.active){background:var(--bg)}
.tab-pane{display:none}.tab-pane.active{display:block}
/* LOADER */
.loader-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;gap:16px;color:var(--muted)}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--blue-main);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
/* BILAN HEADER */
.bilan-header{background:linear-gradient(135deg,var(--blue-dark) 0%,#1a3dce 60%,#4f7ef8 100%);border-radius:var(--radius);padding:28px 32px;margin-bottom:24px;color:white;display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px}
.bilan-header-left h2{font-size:22px;font-weight:800;letter-spacing:-.3px;margin-bottom:4px}
.bilan-header-left p{font-size:13px;opacity:.7}
.bilan-header-right{text-align:right}
.bilan-period{font-size:13px;opacity:.6;margin-bottom:6px}
.bilan-date{font-size:11px;opacity:.45;margin-top:6px}
.bilan-status{display:inline-flex;align-items:center;gap:6px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);border-radius:20px;padding:5px 12px;font-size:12px;font-weight:700}
.bilan-status .dot{width:7px;height:7px;border-radius:50%;background:#10b981;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
/* KPI ROW */
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:24px}
.kpi-row-6{display:grid;grid-template-columns:repeat(6,1fr);gap:14px;margin-bottom:24px}
.kpi-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:18px;position:relative;overflow:hidden}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi-card.blue::before{background:linear-gradient(90deg,var(--blue-main),var(--blue-light))}
.kpi-card.green::before{background:linear-gradient(90deg,#10b981,#34d399)}
.kpi-card.orange::before{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.kpi-card.red::before{background:linear-gradient(90deg,#ef4444,#f87171)}
.kpi-card.purple::before{background:linear-gradient(90deg,#6366f1,#a5b4fc)}
.kpi-card.teal::before{background:linear-gradient(90deg,#0d9488,#14b8a6)}
.kpi-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;margin-bottom:10px}
.kpi-card.blue .kpi-icon{background:#eff6ff}.kpi-card.green .kpi-icon{background:#f0fdf4}
.kpi-card.orange .kpi-icon{background:#fffbeb}.kpi-card.red .kpi-icon{background:#fef2f2}
.kpi-card.purple .kpi-icon{background:#eef2ff}.kpi-card.teal .kpi-icon{background:#f0fdfa}
.kpi-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.kpi-value{font-size:19px;font-weight:800;color:var(--text);letter-spacing:-.4px;margin-bottom:3px}
.kpi-value.positive{color:var(--green)}.kpi-value.negative{color:var(--red)}
.kpi-sub{font-size:11px;color:var(--muted)}
.kpi-n1{font-size:11px;margin-top:4px;font-weight:600}
.kpi-n1.up{color:var(--green)}.kpi-n1.down{color:var(--red)}.kpi-n1.flat{color:var(--muted)}
/* BILAN GRID */
.bilan-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.bilan-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:24px}
.bilan-block{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.bilan-block.full{grid-column:1/-1}
.block-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.block-title{font-size:13px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px}
.block-badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:20px}
.badge-blue{background:var(--blue-ghost);color:var(--blue-main)}.badge-green{background:#dcfce7;color:#16a34a}
.badge-orange{background:#fef3c7;color:#b45309}.badge-red{background:#fee2e2;color:#dc2626}
.badge-purple{background:#ede9fe;color:#7c3aed}.badge-gray{background:#f1f5f9;color:var(--muted)}
.badge-teal{background:#f0fdfa;color:#0d9488}
/* TABLES */
.bilan-table{width:100%;border-collapse:collapse;font-size:13px}
.bilan-table thead th{background:var(--blue-ghost);color:var(--blue-main);font-weight:700;font-size:11px;text-transform:uppercase;letter-spacing:.4px;padding:9px 16px;text-align:right}
.bilan-table thead th:first-child{text-align:left}
.bilan-table tbody tr{border-bottom:1px solid var(--border)}
.bilan-table tbody tr:last-child{border-bottom:none}
.bilan-table tbody tr:hover{background:#fafbff}
.bilan-table td{padding:10px 16px;text-align:right;font-size:13px}
.bilan-table td:first-child{text-align:left;font-weight:500}
.bilan-table .row-sub td:first-child{padding-left:30px;font-weight:400;color:var(--muted);font-size:12px}
.bilan-table .row-total td{background:linear-gradient(90deg,#f8faff,var(--blue-ghost));font-weight:800;color:var(--blue-dark);border-top:2px solid var(--border)}
.bilan-table .row-result td{background:linear-gradient(90deg,#f0fdf4,#dcfce7);font-weight:800;color:#15803d;border-top:2px solid #bbf7d0}
.bilan-table .row-result.neg td{background:linear-gradient(90deg,#fff1f2,#fee2e2);color:#dc2626;border-top-color:#fca5a5}
.bilan-table .row-section td{background:var(--bg);font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--muted);padding:6px 16px;text-align:left}
.bilan-table .row-proj td{background:#fefce8;color:#92400e;font-style:italic}
.positive{color:var(--green);font-weight:700}.negative{color:var(--red);font-weight:700}
.neutral-tag{font-size:10px;padding:2px 7px;border-radius:20px;font-weight:700}
/* RATIOS */
.ratio-grid{display:grid;grid-template-columns:repeat(3,1fr)}
.ratio-cell{padding:16px 18px;border-right:1px solid var(--border);border-bottom:1px solid var(--border)}
.ratio-cell:nth-child(3n){border-right:none}
.ratio-cell:nth-last-child(-n+3){border-bottom:none}
.ratio-label{font-size:11px;font-weight:600;color:var(--muted);margin-bottom:4px}
.ratio-value{font-size:20px;font-weight:800;color:var(--text);margin-bottom:2px}
.ratio-value.good{color:var(--green)}.ratio-value.warn{color:var(--orange)}.ratio-value.bad{color:var(--red)}
.ratio-desc{font-size:11px;color:var(--muted)}
.ratio-bar{height:4px;background:var(--border);border-radius:2px;margin-top:6px;overflow:hidden}
.ratio-bar-fill{height:100%;border-radius:2px}
/* PROGRESS */
.progress-wrap{padding:16px 20px}
.progress-item{margin-bottom:14px}
.progress-item:last-child{margin-bottom:0}
.progress-head{display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px}
.progress-label{font-weight:600;color:var(--text)}
.progress-val{font-weight:700;color:var(--muted)}
.progress-bar{height:7px;background:var(--border);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;border-radius:4px;transition:width .8s ease}
/* DETTES */
.dette-prog-bar{height:5px;background:#f1f5f9;border-radius:3px;overflow:hidden;margin-top:3px}
.dette-prog-fill{height:100%;border-radius:3px;background:linear-gradient(90deg,var(--blue-main),var(--blue-light))}
/* TVA */
.tva-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0}
.tva-cell{padding:18px 20px;border-right:1px solid var(--border);text-align:center}
.tva-cell:last-child{border-right:none}
.tva-cell-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.tva-cell-val{font-size:22px;font-weight:800;margin-bottom:4px}
.tva-cell-sub{font-size:11px;color:var(--muted)}
/* ALERTES */
.alert-wrap{margin-bottom:20px;display:flex;flex-direction:column;gap:8px}
.alert-box{border-radius:10px;padding:12px 16px;font-size:13px;display:flex;align-items:flex-start;gap:10px}
.alert-box.info{background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af}
.alert-box.warn{background:#fffbeb;border:1px solid #fde68a;color:#92400e}
.alert-box.good{background:#f0fdf4;border:1px solid #bbf7d0;color:#166534}
.alert-box.bad{background:#fff1f2;border:1px solid #fca5a5;color:#991b1b}
/* DISCLAIMER */
.disclaimer{background:#fefce8;border:1px solid #fde68a;border-radius:10px;padding:14px 18px;font-size:12px;color:#92400e;display:flex;gap:10px;margin-bottom:24px}
/* EMPTY */
.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-state .big{font-size:48px;margin-bottom:12px}
.empty-state h3{font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px}
/* CHART MINI (bar sparkline) */
.spark-wrap{display:flex;align-items:flex-end;gap:3px;height:48px;padding:12px 20px 8px}
.spark-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px}
.spark-bar{width:100%;border-radius:3px 3px 0 0;transition:height .6s ease}
.spark-label{font-size:8px;color:var(--muted);font-weight:600}
/* PRINT */
@media print{
  .sidebar,.topbar,.config-bar,.hamburger,.nav-overlay,.disclaimer,.alert-wrap,.tabs-bar,.config-actions{display:none!important}
  .main{margin-left:0!important}.content{padding:0!important}
  .bilan-block,.kpi-card{break-inside:avoid}
  .tab-pane{display:block!important}
}
/* MOBILE */
@media(max-width:900px){
  .sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}
  .main{margin-left:0}.kpi-row{grid-template-columns:repeat(2,1fr)}.kpi-row-6{grid-template-columns:repeat(3,1fr)}
  .bilan-grid{grid-template-columns:1fr}.bilan-grid-3{grid-template-columns:1fr}.bilan-block.full{grid-column:1}
  .ratio-grid{grid-template-columns:repeat(2,1fr)}
  .config-bar{flex-direction:column;align-items:flex-start}
  .config-actions{width:100%;margin-left:0}
}
@media(max-width:480px){.kpi-row{grid-template-columns:1fr 1fr}.kpi-row-6{grid-template-columns:repeat(2,1fr)}.content{padding:16px}.topbar{padding:14px 16px}}
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:200;background:var(--blue-dark);border:none;border-radius:8px;padding:8px;cursor:pointer;flex-direction:column;gap:4px}
.hamburger span{display:block;width:18px;height:2px;background:white;border-radius:2px}
@media(max-width:900px){.hamburger{display:flex}}
.nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:99}
.nav-overlay.open{display:block}
</style>
</head>
<body>
<button class="hamburger" onclick="toggleSidebar()"><span></span><span></span><span></span></button>
<div class="nav-overlay" id="navOverlay" onclick="closeSidebar()"></div>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo"><div class="sidebar-logo-icon">üìä</div><div class="sidebar-logo-text">ALTEORE</div></div>
  <div class="nav-section-label">Principal</div>
  <div class="nav-item" onclick="location.href='dashboard.html'"><span class="nav-icon">üè†</span><span class="nav-label">Tableau de bord</span></div>
  <div class="nav-item" onclick="location.href='suivi-ca.html'"><span class="nav-icon">üìà</span><span class="nav-label">Suivi CA & R√©sultats</span></div>
  <div class="nav-item" onclick="toggleMenu('kpis-menu',this)"><span class="nav-icon">üéØ</span><span class="nav-label">KPIs Cl√©s</span><span class="nav-chevron">‚Ä∫</span></div>
  <div class="submenu" id="kpis-menu">
    <div class="sub-item" onclick="location.href='cout-revient.html'"><span class="sub-dot"></span>Co√ªt de revient</div>
    <div class="sub-item" onclick="location.href='marges.html'"><span class="sub-dot"></span>Marge brute & nette</div>
    <div class="sub-item" onclick="location.href='panier-moyen.html'"><span class="sub-dot"></span>Panier moyen</div>
  </div>
  <div class="nav-item" onclick="toggleMenu('pilotage-menu',this)"><span class="nav-icon">üß≠</span><span class="nav-label">Pilotage</span><span class="nav-chevron">‚Ä∫</span></div>
  <div class="submenu" id="pilotage-menu">
    <div class="sub-item" onclick="location.href='pilotage.html?year=2025'"><span class="sub-dot"></span>Pilotage 2025<span class="sub-year-badge">2025</span></div>
    <div class="sub-item" onclick="location.href='pilotage.html?year=2026'"><span class="sub-dot"></span>Pilotage 2026<span class="sub-year-badge">2026</span></div>
    <div class="sub-item" onclick="location.href='pilotage.html?year=2027'"><span class="sub-dot"></span>Pilotage 2027<span class="sub-year-badge">2027</span></div>
  </div>
  <div class="nav-item" onclick="location.href='dettes.html'"><span class="nav-icon">üè¶</span><span class="nav-label">Dettes & Emprunts</span></div>
  <div class="nav-section-label">Rapports</div>
  <div class="nav-item active"><span class="nav-icon">üìÑ</span><span class="nav-label">Situation interm√©diaire</span><span class="nav-badge">Nouveau</span></div>
  <div class="nav-section-label">Intelligence IA</div>
  <div class="nav-item" onclick="location.href='bilan.html'"><span class="nav-icon">ü§ñ</span><span class="nav-label">Analyse de Bilan</span><span class="nav-badge">IA</span></div>
  <div class="nav-section-label">Fid√©lisation</div>
  <div class="nav-item" onclick="toggleFidNav(this)">
    <span style="display:flex;align-items:center;gap:8px"><span class="nav-icon">üíé</span><span class="nav-label">Fid√©lisation</span></span>
    <span class="nav-chev" style="font-size:11px;color:rgba(255,255,255,.3);transition:transform .25s;margin-left:auto">‚Ä∫</span>
  </div>
  <div id="fid-nav-sub" style="overflow:hidden;max-height:0;transition:max-height .35s ease">
    <div class="sub-item" onclick="location.href='fidelisation.html'"><span class="sub-dot"></span>Dashboard fid√©lit√©</div>
  </div>
  <div class="nav-item" onclick="location.href='import.html'" style="border-top:1px solid rgba(255,255,255,.08);padding-top:10px"><span class="nav-icon">üì•</span><span class="nav-label">Import de donn√©es</span></div>
  <div class="sidebar-footer">
    <div class="user-card" onclick="location.href='profil.html'">
      <div class="user-avatar" id="userAvatar">A</div>
      <div><div class="user-name" id="userName">Utilisateur</div><div class="user-plan" id="uplan">‚Äî</div></div>
      <button class="logout-btn" onclick="handleLogout(event)">‚éã</button>
    </div>

    <div style="display:flex;justify-content:center;gap:14px;padding:10px 0 2px">
      <a href="mentions-legales.html" style="font-size:10px;color:rgba(255,255,255,.22);text-decoration:none;transition:color .2s" onmouseover="this.style.color='rgba(255,255,255,.6)'" onmouseout="this.style.color='rgba(255,255,255,.22)'">Mentions</a>
      <a href="cgv.html" style="font-size:10px;color:rgba(255,255,255,.22);text-decoration:none;transition:color .2s" onmouseover="this.style.color='rgba(255,255,255,.6)'" onmouseout="this.style.color='rgba(255,255,255,.22)'">CGV</a>
      <a href="confidentialite.html" style="font-size:10px;color:rgba(255,255,255,.22);text-decoration:none;transition:color .2s" onmouseover="this.style.color='rgba(255,255,255,.6)'" onmouseout="this.style.color='rgba(255,255,255,.22)'">Confidentialit√©</a>
    </div>
  </div>
</aside>

<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>üìÑ Situation Interm√©diaire</h1>
      <p id="pageSubtitle">Mini-bilan de situation financi√®re</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline" onclick="window.print()">üñ®Ô∏è Imprimer</button>
      <button class="btn btn-primary" id="btnPdf" onclick="exportPDF()">‚¨áÔ∏è T√©l√©charger PDF</button>
    </div>
  </div>
  <div class="content" id="mainContent">
    <div class="loader-wrap"><div class="spinner"></div><span>Chargement...</span></div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const app = initializeApp({
  apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
  authDomain:"altiora-70599.firebaseapp.com",
  projectId:"altiora-70599",
  storageBucket:"altiora-70599.firebasestorage.app",
  messagingSenderId:"120905555746",
  appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
});
const auth = getAuth(app); const db = getFirestore(app);
window._auth=auth; window._db=db; window._doc=doc;
window._getDoc=getDoc; window._getDocs=getDocs; window._collection=collection; window._signOut=signOut;
onAuthStateChanged(auth, async user => {
  if (!user) { window.location.href='index.html'; return; }
  window._uid=user.uid;
  const name=user.displayName||user.email.split('@')[0];
  document.getElementById('userName').textContent=name;
  document.getElementById('userAvatar').textContent=name.charAt(0).toUpperCase();
  window._firebaseReady=true;
  window.initRapport();
});
</script>
<script src="nav.js"></script>
<script>
var MONTHS_FR=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
var MONTHS_SHORT=['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];

// Globals
var _allData={}, _dettesData=[], _nomCommerce='', _selectedYear=new Date().getFullYear();
var _periodeType='civile', _exerciceMois=0;
var _activeTab='resume';
// Plage personnalis√©e
var _customRange=false;
var _rangeStart=null; // {year,month} 0-indexed month
var _rangeEnd=null;

// Nav helpers
function toggleMenu(id,el){document.getElementById(id).classList.toggle('open');el.classList.toggle('open');}
function toggleFidNav(el){
  var s=document.getElementById('fid-nav-sub');
  var open=s.style.maxHeight&&s.style.maxHeight!=='0px';
  s.style.maxHeight=open?'0px':'300px';
  var c=el.querySelector('.nav-chev');if(c)c.style.transform=open?'':'rotate(90deg)';
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('navOverlay').classList.toggle('open');}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('navOverlay').classList.remove('open');}
async function handleLogout(e){if(e)e.stopPropagation();await window._signOut(window._auth);window.location.href='index.html';}

// Formatters
function fmt(n,d){d=d||0;if(n===undefined||n===null||isNaN(n))return'‚Äî';return n.toLocaleString('fr-FR',{minimumFractionDigits:d,maximumFractionDigits:d})+' ‚Ç¨';}
function fmtPct(n,abs){if(n===undefined||n===null||isNaN(n))return'‚Äî';var s=abs?'':(n>=0?'+':'');return s+n.toFixed(1)+' %';}
// Version PDF sans espaces ins√©cables (jsPDF les affiche comme "/")
function fmtP(n,d){
  d=d||0;
  if(n===undefined||n===null||isNaN(n))return'-';
  var neg=n<0;var absN=Math.abs(n);
  var parts=absN.toFixed(d).split('.');
  var intPart=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,' ');
  var result=(neg?'- ':'')+intPart+(d>0?','+parts[1]:'');
  return result+' ‚Ç¨';
}
function fmtPP(n,d){
  d=d||0;
  if(n===undefined||n===null||isNaN(n))return'-';
  var neg=n<0;var absN=Math.abs(n);
  var parts=absN.toFixed(d).split('.');
  var intPart=parts[0].replace(/\B(?=(\d{3})+(?!\d))/g,' ');
  return (neg?'- ':'')+intPart+(d>0?','+parts[1]:'');
}
function fmtPctP(n,abs2){if(n===undefined||n===null||isNaN(n))return'-';var s=abs2?'':(n>=0?'+':'');return s+n.toFixed(1)+'%';}
function pf(v){return parseFloat((v||'').toString().replace(',','.'))||0;}

// Init
window.initRapport=async function(){
  var params=new URLSearchParams(window.location.search);
  if(params.get('year'))_selectedYear=parseInt(params.get('year'));
  buildControls();
  await loadData(_selectedYear);
};

function buildControls(){
  var cur=new Date().getFullYear();
  var years=[cur-3,cur-2,cur-1,cur].filter(function(y){return y>=2022;});
  var yOpts=years.map(function(y){return '<option value="'+y+'"'+(y===_selectedYear?' selected':'')+'>'+y+'</option>';}).join('');
  var mOpts=MONTHS_FR.map(function(m,i){return '<option value="'+i+'"'+(i===_exerciceMois?' selected':'')+'>'+m+'</option>';}).join('');
  // Valeurs par d√©faut plage
  var d=new Date();
  var defEnd=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
  var defStartM=d.getMonth()-5; var defStartY=d.getFullYear();
  if(defStartM<0){defStartM+=12;defStartY--;}
  var defStart=defStartY+'-'+String(defStartM+1).padStart(2,'0');
  var rsVal=(_rangeStart?_rangeStart.year+'-'+String(_rangeStart.month+1).padStart(2,'0'):defStart);
  var reVal=(_rangeEnd?_rangeEnd.year+'-'+String(_rangeEnd.month+1).padStart(2,'0'):defEnd);

  document.getElementById('mainContent').innerHTML=
    '<div class="config-bar">'+
      '<div class="config-group"><div class="config-label">Mode</div>'+
        '<div class="seg">'+
          '<button class="seg-btn'+(!_customRange?' active':'')+'" onclick="setCustomRange(false)">üìÖ P√©riode</button>'+
          '<button class="seg-btn'+(_customRange?' active':'')+'" onclick="setCustomRange(true)">üìÜ Plage libre</button>'+
        '</div></div>'+
      '<div class="config-divider"></div>'+
      '<div id="classic-cfg" style="'+(_customRange?'display:none':'display:flex')+';align-items:center;gap:12px;flex-wrap:wrap">'+
        '<div class="config-group"><div class="config-label">Ann√©e</div>'+
          '<select class="config-select" id="yearSel" onchange="changeYear(parseInt(this.value))">'+yOpts+'</select></div>'+
        '<div class="config-group"><div class="config-label">Type</div>'+
          '<div class="seg">'+
            '<button class="seg-btn'+(_periodeType==='civile'?' active':'')+'" onclick="setPeriode(\'civile\',this)">Civile</button>'+
            '<button class="seg-btn'+(_periodeType==='fiscale'?' active':'')+'" onclick="setPeriode(\'fiscale\',this)">Fiscal</button>'+
          '</div></div>'+
        '<div id="exo-cfg" class="config-group" style="'+(_periodeType==='fiscale'?'':'display:none')+'">'+
          '<div class="config-label">D√©but exercice</div>'+
          '<select class="config-select" id="exoMois" onchange="setExoMois(parseInt(this.value))">'+mOpts+'</select>'+
        '</div>'+
      '</div>'+
      '<div id="range-cfg" style="'+(_customRange?'display:flex':'display:none')+';align-items:flex-end;gap:8px;flex-wrap:wrap">'+
        '<div class="config-group"><div class="config-label">De</div>'+
          '<div style="display:flex;gap:4px">'+
            '<select id="rangeStartM" class="config-select" style="width:100px">'+
              MONTHS_FR.map(function(m,i){var rs=_rangeStart?_rangeStart.month:defStartM;return '<option value="'+i+'"'+(i===rs?' selected':'')+'>'+m+'</option>';}).join('')+
            '</select>'+
            '<select id="rangeStartY" class="config-select" style="width:76px">'+
              years.map(function(y){var rsy=_rangeStart?_rangeStart.year:defStartY;return '<option value="'+y+'"'+(y===rsy?' selected':'')+'>'+y+'</option>';}).join('')+
            '</select>'+
          '</div>'+
        '</div>'+
        '<div style="font-size:18px;color:var(--muted);padding-bottom:8px">‚Üí</div>'+
        '<div class="config-group"><div class="config-label">√Ä</div>'+
          '<div style="display:flex;gap:4px">'+
            '<select id="rangeEndM" class="config-select" style="width:100px">'+
              MONTHS_FR.map(function(m,i){var re=_rangeEnd?_rangeEnd.month:d.getMonth();return '<option value="'+i+'"'+(i===re?' selected':'')+'>'+m+'</option>';}).join('')+
            '</select>'+
            '<select id="rangeEndY" class="config-select" style="width:76px">'+
              years.map(function(y){var rey=_rangeEnd?_rangeEnd.year:d.getFullYear();return '<option value="'+y+'"'+(y===rey?' selected':'')+'>'+y+'</option>';}).join('')+
            '</select>'+
          '</div>'+
        '</div>'+
        '<button class="btn btn-primary" style="margin-bottom:2px" onclick="applyRange()">Analyser ‚Üí</button>'+
      '</div>'+
      '<div class="config-divider"></div>'+
      '<div class="config-group"><div class="config-label">Commerce</div>'+
        '<input id="nomCommerce" type="text" class="config-select" style="width:160px" placeholder="Mon commerce" value="'+_nomCommerce+'" oninput="_nomCommerce=this.value"></div>'+
      '<div class="config-actions">'+
        '<button class="btn btn-outline" onclick="window.print()" title="Imprimer">üñ®Ô∏è</button>'+
        '<button class="btn btn-primary" onclick="exportPDF()">‚¨áÔ∏è PDF</button>'+
      '</div>'+
    '</div>'+
    '<div id="rapportBody"><div class="loader-wrap"><div class="spinner"></div><span>Chargement des donn√©es...</span></div></div>';
}

function setPeriode(type,btn){
  _periodeType=type;
  document.querySelectorAll('.seg-btn').forEach(function(b){b.classList.remove('active');});
  btn.classList.add('active');
  var cfg=document.getElementById('exo-cfg');if(cfg)cfg.style.display=type==='fiscale'?'':'none';
  renderRapport();
}
function setExoMois(m){_exerciceMois=m;renderRapport();}
function changeYear(y){_selectedYear=y;loadData(y);}
function setCustomRange(v){
  _customRange=v;
  var bloc=document.getElementById('range-cfg');
  var classic=document.getElementById('classic-cfg');
  if(bloc)bloc.style.display=v?'':'none';
  if(classic)classic.style.display=v?'none':'';
  renderRapport();
}
function applyRange(){
  var sm=document.getElementById('rangeStartM'),sy=document.getElementById('rangeStartY');
  var em=document.getElementById('rangeEndM'),ey=document.getElementById('rangeEndY');
  if(!sm||!sy||!em||!ey)return;
  _rangeStart={year:parseInt(sy.value),month:parseInt(sm.value)};
  _rangeEnd={year:parseInt(ey.value),month:parseInt(em.value)};
  // Load all needed years
  var yearsNeeded={};
  var cy=_rangeStart.year,cm=_rangeStart.month;
  while(cy<_rangeEnd.year||(cy===_rangeEnd.year&&cm<=_rangeEnd.month)){
    yearsNeeded[cy]=true;cm++;if(cm>11){cm=0;cy++;}
  }
  _selectedYear=_rangeStart.year;
  var yKeys=Object.keys(yearsNeeded);
  var proms=[];
  yKeys.forEach(function(y){
    for(var m=1;m<=12;m++){
      var key=y+'-'+String(m).padStart(2,'0');
      proms.push(window._getDoc(window._doc(window._db,'pilotage',window._uid,'months',key))
        .then((function(k){return function(s){if(s.exists())_allData[k]=s.data();};})(key)).catch(function(){}));
    }
  });
  Promise.all(proms).then(function(){renderRapport();});
}
function switchTab(t){
  _activeTab=t;
  document.querySelectorAll('.tab-btn').forEach(function(b){b.classList.toggle('active',b.dataset.tab===t);});
  document.querySelectorAll('.tab-pane').forEach(function(p){p.classList.toggle('active',p.id==='tab-'+t);});
}

// P√©riode keys
function getPeriodKeys(year){
  if(_customRange&&_rangeStart&&_rangeEnd){
    var keys=[];
    var sy=_rangeStart.year,sm=_rangeStart.month;
    var ey=_rangeEnd.year,em=_rangeEnd.month;
    var cy=sy,cm=sm;
    while(cy<ey||(cy===ey&&cm<=em)){
      keys.push(cy+'-'+String(cm+1).padStart(2,'0'));
      cm++;if(cm>11){cm=0;cy++;}
      if(keys.length>36)break; // s√©curit√©
    }
    return keys;
  }
  var keys=[];
  if(_periodeType==='civile'){
    for(var m=1;m<=12;m++)keys.push(year+'-'+String(m).padStart(2,'0'));
  } else {
    for(var i=0;i<12;i++){
      var cm2=(_exerciceMois+i)%12;
      var cy2=year+Math.floor((_exerciceMois+i)/12);
      keys.push(cy2+'-'+String(cm2+1).padStart(2,'0'));
    }
  }
  return keys;
}
function getPeriodLabel(year){
  if(_customRange&&_rangeStart&&_rangeEnd){
    return MONTHS_SHORT[_rangeStart.month]+' '+_rangeStart.year+' ‚Üí '+MONTHS_SHORT[_rangeEnd.month]+' '+_rangeEnd.year;
  }
  if(_periodeType==='civile')return '01/01/'+year+' ‚Äî 31/12/'+year;
  var endMIdx=(_exerciceMois+11)%12;
  var endY=year+(_exerciceMois>0?1:0);
  return MONTHS_FR[_exerciceMois]+' '+year+' ‚Äî '+MONTHS_FR[endMIdx]+' '+endY;
}

// Chargement
async function loadData(year){
  var el=document.getElementById('rapportBody');
  if(!el)return;
  el.innerHTML='<div class="loader-wrap"><div class="spinner"></div><span>Chargement '+year+'...</span></div>';
  var keysSet={};
  [year-1,year,year+1].forEach(function(y){
    for(var m=1;m<=12;m++)keysSet[y+'-'+String(m).padStart(2,'0')]=true;
  });
  var promises=Object.keys(keysSet).map(function(key){
    return window._getDoc(window._doc(window._db,'pilotage',window._uid,'months',key))
      .then((function(k){return function(s){if(s.exists())_allData[k]=s.data();};})(key))
      .catch(function(){});
  });
  promises.push(
    window._getDoc(window._doc(window._db,'dettes',window._uid,'data','all'))
      .then(function(s){_dettesData=s.exists()?(s.data().list||[]):[];}).catch(function(){_dettesData=[];})
  );
  promises.push(
    window._getDoc(window._doc(window._db,'users',window._uid))
      .then(function(s){
        if(s.exists()&&s.data().nomCommerce){
          _nomCommerce=s.data().nomCommerce;
          var inp=document.getElementById('nomCommerce');if(inp)inp.value=_nomCommerce;
        }
      }).catch(function(){})
  );
  await Promise.all(promises);
  renderRapport();
}

// Calcul mois complet
function computeMonth(d,key,isFuture){
  if(!d)return{caHT:0,caJ:0,caFP:0,rentrees:0,fixe:0,variable:0,credit:0,leasing:0,charges:0,resultat:0,
    tvaCollectee:0,tvaDed:0,tvaDue:0,caHT055:0,caHT10:0,caHT20:0,
    prevCharges:0,prevCA:0,topCharges:[],hasData:false,isFuture:false};
  // CA journalier multi-TVA
  var h055=0,h10=0,h20=0;
  (d.ca||[]).forEach(function(r){
    var a=parseFloat(r.ht055)||0,b=parseFloat(r.ht10)||0,c=parseFloat(r.ht20)||0;
    var multi=a+b+c;
    if(multi>0){h055+=a;h10+=b;h20+=c;}else{h20+=parseFloat(r.montantHT)||0;}
  });
  var caJ=h055+h10+h20;
  // Factures Pro
  var fp055=0,fp10=0,fp20=0;
  (d.facturesPro||[]).forEach(function(r){fp055+=parseFloat(r.ht055)||0;fp10+=parseFloat(r.ht10)||0;fp20+=parseFloat(r.ht20)||0;});
  var caFP=fp055+fp10+fp20;
  var caHT=caJ+caFP;
  var caHT055=h055+fp055,caHT10=h10+fp10,caHT20=h20+fp20;
  // TVA collect√©e
  var tvaCollectee=caHT055*0.055+caHT10*0.10+caHT20*0.20;
  // Rentr√©es
  var rentrees=(d.rentreesSupp||[]).reduce(function(s,r){return s+(parseFloat(r.montant)||0);},0);
  // Charges fixes
  var fixe=0,tvaDedFix=0;
  (d.chargesFixe||[]).forEach(function(r){
    var h=pf(r.montantHT),t=pf(r.tvaRate);
    fixe+=h;
    if(r.deductible!=='Non')tvaDedFix+=h*t/100;
  });
  // Charges variables
  var variable=0,tvaDedVar=0;
  (d.chargesVar||[]).forEach(function(r){
    var h=pf(r.montantHT),t=pf(r.tvaRate);
    variable+=h;
    if(r.deductible!=='Non')tvaDedVar+=h*t/100;
  });
  // Cr√©dits
  var credit=0,tvaDedCred=0;
  (d.credits||[]).filter(function(r){return!r.ligneType||r.ligneType==='principal';}).forEach(function(r){
    if(key&&r.dateDebut&&r.dateFin){if(key<r.dateDebut.slice(0,7)||key>r.dateFin.slice(0,7))return;}
    var p=pf(r.montant),t=pf(r.tauxInteret);
    var inter=(p>0&&t>0?p*t/100/12:0);
    credit+=p+inter;
    tvaDedCred+=inter*(pf(r.tvaRate)||20)/100;
  });
  // Leasing
  var leasing=0,tvaDedLeas=0;
  (d.leasing||[]).forEach(function(r){
    if(key&&r.dateDebut&&r.dateFin){if(key<r.dateDebut||key>r.dateFin)return;}
    var h=pf(r.montantHT),t=pf(r.tvaRate);
    leasing+=h;
    if(r.deductible!=='Non')tvaDedLeas+=h*t/100;
  });
  var tvaDed=tvaDedFix+tvaDedVar+tvaDedCred+tvaDedLeas;
  var tvaDue=tvaCollectee-tvaDed;
  var charges=fixe+variable+credit+leasing;
  // Mois futur : charges et CA passent en pr√©visionnel, r√©sultat r√©el = 0
  var prevCharges = isFuture ? charges : 0;
  var prevCA      = isFuture ? caHT    : 0;
  if(isFuture){ charges=0; caHT=0; caJ=0; caFP=0; caHT055=0; caHT10=0; caHT20=0; tvaCollectee=0; tvaDed=0; tvaDue=0; }
  var resultat = caHT+rentrees-charges;
  // Top charges for details
  var topCharges=[];
  (d.chargesFixe||[]).concat(d.chargesVar||[]).concat(d.leasing||[]).forEach(function(r){
    if(pf(r.montantHT)>0)topCharges.push({fournisseur:r.fournisseur||'',type:r.type||'',montant:pf(r.montantHT),cat:r===((d.chargesFixe||[])[0])?'fixe':'variable'});
  });
  topCharges.sort(function(a,b){return b.montant-a.montant;});
  return{caHT,caJ,caFP,caHT055,caHT10,caHT20,rentrees,fixe,variable,credit,leasing,charges,resultat,
    tvaCollectee,tvaDed,tvaDue,prevCharges,prevCA,isFuture:!!isFuture,topCharges,hasData:true};
}

// Agr√©gation
function aggregateKeys(keys){
  // Cl√© du mois courant (ex: "2026-02") ‚Äî les cl√©s > nowKey sont futures
  var _now=new Date();
  var nowKey=_now.getFullYear()+'-'+String(_now.getMonth()+1).padStart(2,'0');

  var T={caHT:0,caJ:0,caFP:0,caHT055:0,caHT10:0,caHT20:0,rentrees:0,fixe:0,variable:0,credit:0,leasing:0,charges:0,resultat:0,tvaCollectee:0,tvaDed:0,tvaDue:0,moisData:0,prevCharges:0,prevCA:0};
  var monthly=[];
  var chargesMap={};
  keys.forEach(function(k){
    var d=_allData[k]||null;
    var isFuture = k > nowKey;
    var r=computeMonth(d,k,isFuture);
    monthly.push({key:k,lbl:MONTHS_SHORT[parseInt(k.slice(5,7))-1],yr:k.slice(0,4),m:parseInt(k.slice(5,7))-1,...r});
    if(d){
      T.moisData++;
      // Top charges : seulement les mois r√©els (pass√© + mois courant)
      if(!isFuture){
        (d.chargesFixe||[]).concat(d.chargesVar||[]).concat(d.leasing||[]).forEach(function(c){
          var h=pf(c.montantHT);if(h<=0)return;
          var k2=(c.fournisseur||'Inconnu')+'__'+(c.type||'');
          if(!chargesMap[k2])chargesMap[k2]={fournisseur:c.fournisseur||'Inconnu',type:c.type||'',total:0};
          chargesMap[k2].total+=h;
        });
      }
    }
    T.caHT+=r.caHT;T.caJ+=r.caJ;T.caFP+=r.caFP;
    T.caHT055+=r.caHT055;T.caHT10+=r.caHT10;T.caHT20+=r.caHT20;
    T.rentrees+=r.rentrees;T.fixe+=r.fixe;T.variable+=r.variable;
    T.credit+=r.credit;T.leasing+=r.leasing;T.charges+=r.charges;T.resultat+=r.resultat;
    T.tvaCollectee+=r.tvaCollectee;T.tvaDed+=r.tvaDed;T.tvaDue+=r.tvaDue;
    T.prevCharges+=r.prevCharges; T.prevCA+=r.prevCA;
  });
  var topChargesList=Object.values(chargesMap).sort(function(a,b){return b.total-a.total;}).slice(0,12);
  return{T,monthly,topChargesList};
}

// ‚îÄ‚îÄ RENDU PRINCIPAL
function renderRapport(){
  var el=document.getElementById('rapportBody');if(!el)return;
  var year=_selectedYear;
  var keys=getPeriodKeys(year);
  // N-1 : d√©caler la plage d'un an en arri√®re
  var keysN1=[];
  if(_customRange&&_rangeStart&&_rangeEnd){
    var rs1={year:_rangeStart.year-1,month:_rangeStart.month};
    var re1={year:_rangeEnd.year-1,month:_rangeEnd.month};
    var cy=rs1.year,cm=rs1.month;
    while(cy<re1.year||(cy===re1.year&&cm<=re1.month)){
      keysN1.push(cy+'-'+String(cm+1).padStart(2,'0'));
      cm++;if(cm>11){cm=0;cy++;}
      if(keysN1.length>36)break;
    }
  } else {
    keysN1=getPeriodKeys(year-1);
  }
  var agg=aggregateKeys(keys);
  var aggN1=aggregateKeys(keysN1);
  var T=agg.T, TN1=aggN1.T, monthly=agg.monthly, topCharges=agg.topChargesList;

  if(T.moisData===0){
    el.innerHTML='<div class="empty-state"><div class="big">üìä</div><h3>Aucune donn√©e pour cette p√©riode</h3><p>Saisissez vos donn√©es dans le module Pilotage pour g√©n√©rer votre situation interm√©diaire.</p></div>';
    return;
  }

  var txCharges=T.caHT>0?T.charges/T.caHT*100:0;
  var margeN=T.caHT>0?T.resultat/T.caHT*100:0;
  var caMens=T.moisData>0?T.caHT/T.moisData:0;
  var caJour=caMens/30;
  var resMens=T.moisData>0?T.resultat/T.moisData:0;
  var txFixe=T.caHT>0?T.fixe/T.caHT*100:0;
  var txVar=T.caHT>0?T.variable/T.caHT*100:0;
  var seuil=T.moisData>0?T.fixe/(1-txVar/100)||0:0; // seuil mensuel approximatif

  var dettesActives=_dettesData.filter(function(d){return d.statut!=='soldee'&&d.statut!=='sold√©';});
  var totDettes=dettesActives.reduce(function(s,d){return s+(parseFloat(d.montantRestant||d.montant)||0);},0);
  var totMensDettes=dettesActives.reduce(function(s,d){return s+(parseFloat(d.mensualite)||0);},0);
  var ratioEndett=T.caHT>0?totDettes/T.caHT*100:0;

  // N-1 comparaison
  // N-1 valide seulement si donn√©es significatives (au moins 20% du CA actuel, et au moins 1 mois)
  var evCA=(TN1.caHT>0&&TN1.moisData>0&&TN1.caHT>T.caHT*0.05)?(T.caHT-TN1.caHT)/TN1.caHT*100:null;
  var evRes=TN1.caHT>0?(T.resultat-TN1.resultat):null;
  var evCharges=TN1.charges>0?(T.charges-TN1.charges)/TN1.charges*100:null;

  // Projection fin d'ann√©e (mois manquants)
  var moisRestants=12-T.moisData;
  var projCA=T.caHT+(moisRestants>0?caMens*moisRestants:0);
  var projCharges=T.charges+(moisRestants>0?(T.moisData>0?T.charges/T.moisData:0)*moisRestants:0);
  var projResultat=projCA-projCharges+T.rentrees;

  var moisData=monthly.filter(function(m){return m.hasData;});
  var meillCA=moisData.length?moisData.reduce(function(a,b){return b.caHT>a.caHT?b:a;}):null;
  var moinsCA=moisData.length?moisData.reduce(function(a,b){return b.caHT<a.caHT?b:a;}):null;
  var meillRes=moisData.length?moisData.reduce(function(a,b){return b.resultat>a.resultat?b:a;}):null;
  var piresRes=moisData.length?moisData.reduce(function(a,b){return b.resultat<a.resultat?b:a;}):null;
  var moisBene=moisData.filter(function(m){return m.resultat>0;}).length;
  var periodLabel=getPeriodLabel(year);

  // Alertes
  var alertes=[];
  if(margeN<0)alertes.push({type:'bad',msg:'‚ùå R√©sultat net n√©gatif ‚Äî les charges d√©passent le CA sur la p√©riode analys√©e.'});
  else if(margeN<5)alertes.push({type:'warn',msg:'‚ö†Ô∏è Marge nette tr√®s faible ('+margeN.toFixed(1)+'%) ‚Äî situation fragile, peu de coussin financier.'});
  else if(margeN>15)alertes.push({type:'good',msg:'‚úÖ Bonne marge nette ('+margeN.toFixed(1)+'%) ‚Äî la structure financi√®re est saine.'});
  if(txCharges>90)alertes.push({type:'bad',msg:'üî¥ Taux de charges tr√®s √©lev√© ('+txCharges.toFixed(1)+'%) ‚Äî tr√®s peu de marge de man≈ìuvre.'});
  else if(txCharges>80)alertes.push({type:'warn',msg:'üü° Taux de charges √©lev√© ('+txCharges.toFixed(1)+'%) ‚Äî surveiller l\'√©volution.'});
  if(ratioEndett>150)alertes.push({type:'bad',msg:'üî¥ Endettement important : l\'encours dettes repr√©sente '+ratioEndett.toFixed(0)+'% du CA.'});
  else if(ratioEndett>80)alertes.push({type:'warn',msg:'‚ö†Ô∏è Endettement √† surveiller : '+ratioEndett.toFixed(0)+'% du CA en encours.'});
  if(moisBene<T.moisData/2)alertes.push({type:'warn',msg:'üìä Moins de la moiti√© des mois sont b√©n√©ficiaires ('+moisBene+'/'+T.moisData+').'});
  if(evCA!==null&&evCA<-10&&Math.abs(evCA)<500)alertes.push({type:'bad',msg:'üìâ CA en baisse de '+Math.abs(evCA).toFixed(1)+'% vs ann√©e pr√©c√©dente.'});
  if(evCA!==null&&evCA>10&&evCA<500)alertes.push({type:'good',msg:'üìà CA en hausse de '+evCA.toFixed(1)+'% vs ann√©e pr√©c√©dente ‚Äî belle progression !'});
  if(T.tvaCollectee>T.tvaDed*1.5&&T.tvaCollectee>500)alertes.push({type:'info',msg:'‚ÑπÔ∏è TVA due estim√©e : '+fmt(T.tvaDue)+' sur la p√©riode. Veillez √† la provisionner.'});

  var html='';

  // HEADER
  html+='<div class="bilan-header">'+
    '<div class="bilan-header-left">'+
      '<h2>'+(_nomCommerce||'Mon Commerce')+'</h2>'+
      '<p>Situation Interm√©diaire ¬∑ '+(_periodeType==='fiscale'?'Exercice fiscal':'Ann√©e civile')+' '+year+'</p>'+
    '</div>'+
    '<div class="bilan-header-right">'+
      '<div class="bilan-period">'+periodLabel+'</div>'+
      '<div class="bilan-status"><span class="dot"></span>'+T.moisData+' mois analys√©s</div>'+
      (TN1.moisData>0?'<div class="bilan-date">N-1 : '+fmt(TN1.caHT)+' de CA</div>':'')+
      '<div class="bilan-date">G√©n√©r√© le '+new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'})+'</div>'+
    '</div>'+
  '</div>';

  // ALERTES
  if(alertes.length)html+='<div class="alert-wrap">'+alertes.map(function(a){return'<div class="alert-box '+a.type+'">'+a.msg+'</div>';}).join('')+'</div>';

  // KPIs LIGNE 1
  html+='<div class="kpi-row">';
  html+=kpi('blue','üí∞','CA Total HT',fmt(T.caHT),'Moy. '+fmt(caMens)+'/mois',null,evCA);
  html+=kpi('orange','üí∏','Total Charges',fmt(T.charges),fmtPct(txCharges,true)+' du CA',null,evCharges);
  html+=kpi(T.resultat>=0?'green':'red',T.resultat>=0?'üìà':'üìâ','R√©sultat r√©el',fmt(T.resultat),fmtPct(margeN,true)+' de marge',T.resultat>=0?'positive':'negative',evRes!==null?evRes:null,true);
  if(T.prevCharges>0){var prevRes=T.prevCA-T.prevCharges;html+=kpi(prevRes>=0?'teal':'orange','üîÆ','Pr√©visionnel (mois futurs)',fmt(prevRes),fmt(T.prevCharges)+' de charges pr√©vi',prevRes>=0?'positive':'negative',null,false);}
  html+=kpi('purple','üè¶','Encours dettes',fmt(totDettes),totMensDettes>0?fmt(totMensDettes)+'/mois':'Aucune √©ch√©ance');
  html+=kpi('teal','üßæ','TVA due (estim√©e)',fmt(Math.max(0,T.tvaDue)),T.tvaDue<0?'üü¢ Cr√©dit TVA '+fmt(Math.abs(T.tvaDue)):'Collect√©e : '+fmt(T.tvaCollectee));
  html+='</div>';

  // KPIs LIGNE 2
  html+='<div class="kpi-row-6">';
  html+=kpi('blue','üìÖ','CA journalier moy.',fmt(caJour),'‚âà par jour ouvert');
  html+=kpi(resMens>=0?'green':'red','üìä','R√©sultat mensuel moy.',fmt(resMens),T.moisData+' mois de donn√©es',resMens>=0?'positive':'negative');
  html+=kpi('orange','üîí','Dont charges fixes',fmt(T.fixe),fmtPct(txFixe,true)+' du CA');
  html+=kpi('orange','üì¶','Dont charges var.',fmt(T.variable),fmtPct(txVar,true)+' du CA');
  if(moisRestants>0)html+=kpi('purple','üîÆ','Projection fin '+year,fmt(projResultat),projCA>0?'CA proj. '+fmt(projCA):moisRestants+' mois restants',projResultat>=0?'positive':'negative');
  else html+=kpi('teal','üèÜ','Mois b√©n√©ficiaires',moisBene+'/'+T.moisData,moisBene===T.moisData?'‚úÖ Tous les mois':moisBene<T.moisData/2?'‚ö†Ô∏è Moins de la moiti√©':'‚úÖ Majorit√© positive');
  html+=kpi('teal','üí°','Seuil de rentabilit√©',T.moisData>0&&txVar<100?fmt(seuil)+'/mois':'‚Äî','Point mort estim√© mensuel');
  html+='</div>';

  // TABS
  html+='<div class="tabs-bar">'+
    ['resume','detail','tva','dettes','projection'].map(function(t){
      var labels={resume:'üìä R√©sum√© ex√©cutif',detail:'üìÖ D√©tail mensuel',tva:'üßæ TVA & Fiscal',dettes:'üè¶ Dettes',projection:'üîÆ Projection'};
      return '<button class="tab-btn'+(t===_activeTab?' active':'')+'" data-tab="'+t+'" onclick="switchTab(\''+t+'\')">'+labels[t]+'</button>';
    }).join('')+
  '</div>';

  // ‚îÄ‚îÄ TAB RESUME
  var tabResume='';
  tabResume+='<div class="bilan-grid">';

  // Compte de r√©sultat
  tabResume+='<div class="bilan-block">'+
    '<div class="block-header"><div class="block-title">üìä Compte de r√©sultat simplifi√©</div>'+
    '<span class="block-badge badge-blue">'+periodLabel+'</span></div>'+
    '<table class="bilan-table"><thead><tr><th>Poste</th><th>Montant HT</th><th>% CA</th>'+(TN1.moisData>0?'<th>N-1</th>':'')+'</tr></thead><tbody>';
  tabResume+='<tr class="row-section"><td colspan="4">‚ñ∏ PRODUITS</td></tr>';
  tabResume+='<tr><td>CA journalier (caisse)</td><td>'+fmt(T.caJ)+'</td><td>'+(T.caHT>0?fmtPct(T.caJ/T.caHT*100,true):'‚Äî')+'</td>'+(TN1.moisData>0?'<td class="'+(T.caJ>TN1.caJ?'positive':'negative')+'">'+fmt(TN1.caJ)+'</td>':'')+'</tr>';
  if(T.caFP>0)tabResume+='<tr class="row-sub"><td>‚Ü≥ Factures Pro / B2B</td><td>'+fmt(T.caFP)+'</td><td>'+(T.caHT>0?fmtPct(T.caFP/T.caHT*100,true):'‚Äî')+'</td>'+(TN1.moisData>0?'<td>'+fmt(TN1.caFP)+'</td>':'')+'</tr>';
  if(T.rentrees>0)tabResume+='<tr><td>Rentr√©es suppl√©mentaires</td><td>'+fmt(T.rentrees)+'</td><td>'+(T.caHT>0?fmtPct(T.rentrees/(T.caHT+T.rentrees)*100,true):'‚Äî')+'</td>'+(TN1.moisData>0?'<td>'+fmt(TN1.rentrees)+'</td>':'')+'</tr>';
  tabResume+='<tr class="row-total"><td>Total Produits HT</td><td>'+fmt(T.caHT+T.rentrees)+'</td><td>100%</td>'+(TN1.moisData>0?'<td>'+fmt(TN1.caHT+TN1.rentrees)+'</td>':'')+'</tr>';
  tabResume+='<tr class="row-section"><td colspan="4">‚ñ∏ CHARGES</td></tr>';
  tabResume+='<tr><td>Charges fixes HT</td><td>'+fmt(T.fixe)+'</td><td><span class="'+(txFixe>50?'negative':'')+'">'+(T.caHT>0?fmtPct(txFixe,true):'‚Äî')+'</span></td>'+(TN1.moisData>0?'<td>'+fmt(TN1.fixe)+'</td>':'')+'</tr>';
  tabResume+='<tr><td>Charges variables HT</td><td>'+fmt(T.variable)+'</td><td><span class="'+(txVar>30?'negative':'')+'">'+(T.caHT>0?fmtPct(txVar,true):'‚Äî')+'</span></td>'+(TN1.moisData>0?'<td>'+fmt(TN1.variable)+'</td>':'')+'</tr>';
  if(T.credit>0)tabResume+='<tr><td>Cr√©dits & Emprunts HT</td><td>'+fmt(T.credit)+'</td><td>'+(T.caHT>0?fmtPct(T.credit/T.caHT*100,true):'‚Äî')+'</td>'+(TN1.moisData>0?'<td>'+fmt(TN1.credit)+'</td>':'')+'</tr>';
  if(T.leasing>0)tabResume+='<tr><td>Leasing / LOA / LLD</td><td>'+fmt(T.leasing)+'</td><td>'+(T.caHT>0?fmtPct(T.leasing/T.caHT*100,true):'‚Äî')+'</td>'+(TN1.moisData>0?'<td>'+fmt(TN1.leasing)+'</td>':'')+'</tr>';
  tabResume+='<tr class="row-total"><td>Total Charges HT</td><td>'+fmt(T.charges)+'</td><td>'+fmtPct(txCharges,true)+'</td>'+(TN1.moisData>0?'<td>'+fmt(TN1.charges)+'</td>':'')+'</tr>';
  var rcls=(T.resultat>=0?'row-result':'row-result neg');
  tabResume+='<tr class="'+rcls+'"><td>'+(T.resultat>=0?'‚úÖ R√©sultat r√©el (mois pass√©s)':'‚ùå R√©sultat r√©el (mois pass√©s)')+'</td><td>'+fmt(T.resultat)+'</td><td>'+fmtPct(Math.abs(margeN),true)+'</td>'+(TN1.moisData>0?'<td class="'+(T.resultat>TN1.resultat?'positive':'negative')+'">'+fmt(TN1.resultat)+'</td>':'')+'</tr>';
  if(T.prevCharges>0||T.prevCA>0){
    var prevRes=T.prevCA-T.prevCharges;
    var prevResTotal=T.resultat+prevRes;
    tabResume+='<tr class="row-section" style="background:#fef3c7"><td colspan="'+(TN1.moisData>0?'4':'3')+'" style="color:#92400e;font-weight:700;font-size:12px">‚ñ∏ PR√âVISIONNEL ‚Äî mois futurs ('+moisRestants+' mois)</td></tr>';
    if(T.prevCA>0)tabResume+='<tr style="color:#92400e"><td>üîÆ CA pr√©visionnel saisi</td><td style="font-weight:700">'+fmt(T.prevCA)+'</td><td>‚Äî</td>'+(TN1.moisData>0?'<td>‚Äî</td>':'')+'</tr>';
    else tabResume+='<tr style="color:#b45309"><td>‚ö†Ô∏è CA pr√©visionnel</td><td colspan="'+(TN1.moisData>0?'3':'2')+'" style="font-style:italic;color:#b45309">Aucun CA pr√©visionnel saisi ‚Äî ajoutez-le dans Pilotage</td></tr>';
    tabResume+='<tr style="color:#92400e"><td>üì¶ Charges pr√©visionnelles</td><td style="font-weight:700">'+fmt(T.prevCharges)+'</td><td>‚Äî</td>'+(TN1.moisData>0?'<td>‚Äî</td>':'')+'</tr>';
    var prevClr=prevRes>=0?'#059669':'#b45309';
    tabResume+='<tr style="background:#fef9c3"><td style="font-weight:700;color:'+prevClr+'">'+( prevRes>=0?'üìà':'üìâ')+' R√©sultat pr√©visionnel</td><td style="font-weight:700;color:'+prevClr+'">'+fmt(prevRes)+'</td><td style="color:'+prevClr+'">'+(T.prevCA>0?fmtPct(prevRes/T.prevCA*100,true):'‚Äî')+'</td>'+(TN1.moisData>0?'<td>‚Äî</td>':'')+'</tr>';
    var totalClr=prevResTotal>=0?'#059669':'#dc2626';
    tabResume+='<tr style="border-top:2px solid #d97706;background:#fff7ed"><td style="font-weight:800;color:'+totalClr+'">üî≠ Total projet√© (r√©el + pr√©vi)</td><td style="font-weight:800;color:'+totalClr+'">'+fmt(prevResTotal)+'</td><td style="color:'+totalClr+'">'+(T.caHT+T.prevCA>0?fmtPct(prevResTotal/(T.caHT+T.prevCA)*100,true):'‚Äî')+'</td>'+(TN1.moisData>0?'<td>‚Äî</td>':'')+'</tr>';
  }
  tabResume+='</tbody></table></div>';

  // Ratios
  tabResume+='<div class="bilan-block">'+
    '<div class="block-header"><div class="block-title">üìê Ratios & Indicateurs</div><span class="block-badge badge-gray">Analyse auto</span></div>'+
    '<div class="ratio-grid">'+
    rcell('Taux de charges',fmtPct(txCharges,true),txCharges>90?'bad':txCharges>75?'warn':'good','Charges / CA',txCharges,100)+
    rcell('Marge nette',fmtPct(margeN<0?0:margeN,true),margeN<0?'bad':margeN<5?'warn':'good','R√©sultat / CA',Math.max(margeN,0),30)+
    rcell('CA mensuel moy.',fmt(caMens),'','Sur '+T.moisData+' mois',0,0)+
    rcell('Seuil de rentabilit√©',T.moisData>0&&txVar<100?fmt(seuil)+'/mois':'‚Äî',seuil>0&&caMens>seuil?'good':'warn','CA min. pour couvrir fixes',0,0)+
    rcell('Mois b√©n√©ficiaires',moisBene+'/'+T.moisData,moisBene<T.moisData/2?'warn':'good','Sur les mois saisis',moisBene,T.moisData)+
    rcell('Endettement / CA',T.caHT>0?fmtPct(ratioEndett,true):'‚Äî',ratioEndett>150?'bad':ratioEndett>80?'warn':'good','Encours / CA annuel',Math.min(ratioEndett,200),200)+
    '</div></div>';
  tabResume+='</div>'; // fin bilan-grid

  // R√©partition + structure
  tabResume+='<div class="bilan-grid">';
  tabResume+='<div class="bilan-block"><div class="block-header"><div class="block-title">üìä R√©partition des charges</div></div><div class="progress-wrap">';
  if(T.fixe>0)tabResume+=pbar('Charges fixes',T.fixe,T.charges,'#1a3dce');
  if(T.variable>0)tabResume+=pbar('Charges variables',T.variable,T.charges,'#f59e0b');
  if(T.credit>0)tabResume+=pbar('Cr√©dits & Emprunts',T.credit,T.charges,'#6366f1');
  if(T.leasing>0)tabResume+=pbar('Leasing / LOA',T.leasing,T.charges,'#0d9488');
  tabResume+='</div></div>';

  tabResume+='<div class="bilan-block"><div class="block-header"><div class="block-title">üí∞ Structure CA & R√©sultat</div></div><div class="progress-wrap">';
  tabResume+=pbar('CA journalier',T.caJ,T.caHT,'#1a3dce');
  if(T.caFP>0)tabResume+=pbar('Factures Pro / B2B',T.caFP,T.caHT,'#6366f1');
  if(T.rentrees>0)tabResume+=pbar('Rentr√©es supp.',T.rentrees,T.caHT+T.rentrees,'#10b981');
  tabResume+=pbar('Charges totales',T.charges,T.caHT,'#ef4444');
  if(T.resultat>0)tabResume+=pbar('B√©n√©fice',T.resultat,T.caHT,'#10b981');
  tabResume+='</div></div>';
  tabResume+='</div>';

  // ‚îÄ‚îÄ FAITS MARQUANTS (enrichis)
  if(moisData.length>0){
    // Calculs compl√©mentaires
    var caMaxMois=meillCA?meillCA.caHT:0;
    var caMinMois=moinsCA?moinsCA.caHT:0;
    var ecartCAMois=caMaxMois>0&&caMinMois>=0?((caMaxMois-caMinMois)/caMaxMois*100):0;
    var caAccelere=monthly.length>=6&&moisData.length>=4?(function(){
      var firstHalf=moisData.filter(function(m){return m.m<6;});
      var secondHalf=moisData.filter(function(m){return m.m>=6;});
      if(!firstHalf.length||!secondHalf.length)return null;
      var avgFirst=firstHalf.reduce(function(s,m){return s+m.caHT;},0)/firstHalf.length;
      var avgSecond=secondHalf.reduce(function(s,m){return s+m.caHT;},0)/secondHalf.length;
      return {first:avgFirst,second:avgSecond,delta:avgSecond-avgFirst,pct:avgFirst>0?(avgSecond-avgFirst)/avgFirst*100:0};
    })():null;
    var moisDeficit=moisData.filter(function(m){return m.resultat<0;});
    var moisExcedent=moisData.filter(function(m){return m.resultat>0;});
    var totalDeficit=moisDeficit.reduce(function(s,m){return s+m.resultat;},0);
    var totalExcedent=moisExcedent.reduce(function(s,m){return s+m.resultat;},0);
    var chargesParCA=T.caHT>0?(T.fixe/T.caHT*100):0; // poids fixes seules
    var pointMort=chargesParCA<100&&T.variable<T.caHT?T.fixe/(1-T.variable/T.caHT)/1000:0; // en milliers

    tabResume+='<div class="bilan-block full" style="margin-bottom:24px">'+
      '<div class="block-header">'+
        '<div class="block-title">üèÜ Faits marquants de la p√©riode</div>'+
        '<span class="block-badge badge-gray">'+T.moisData+' mois analys√©s</span>'+
      '</div>'+
      '<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0;border-bottom:1px solid var(--border)">';

    tabResume+=factCard('ü•á','Meilleur mois CA',
      meillCA?meillCA.lbl+' '+meillCA.yr:'‚Äî',
      meillCA?fmt(meillCA.caHT):'‚Äî',
      'green',
      meillCA&&T.moisData>1?'R√©sultat : '+fmt(meillCA.resultat):'');

    tabResume+=factCard('üìâ','Mois CA le plus faible',
      moinsCA?moinsCA.lbl+' '+moinsCA.yr:'‚Äî',
      moinsCA?fmt(moinsCA.caHT):'‚Äî',
      'orange',
      caMaxMois>0?'√âcart max/min : '+ecartCAMois.toFixed(0)+'%':'');

    tabResume+=factCard('‚úÖ','Meilleur r√©sultat',
      meillRes?meillRes.lbl+' '+meillRes.yr:'‚Äî',
      meillRes?fmt(meillRes.resultat):'‚Äî',
      'green',
      meillRes?'CA ce mois : '+fmt(meillRes.caHT):'');

    tabResume+=factCard('‚ùå','Pire r√©sultat',
      piresRes?piresRes.lbl+' '+piresRes.yr:'‚Äî',
      piresRes?fmt(piresRes.resultat):'‚Äî',
      piresRes&&piresRes.resultat<0?'red':'orange',
      piresRes?'CA ce mois : '+fmt(piresRes.caHT):'');

    tabResume+='</div>';
    // Ligne 2 de faits
    tabResume+='<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0">';

    tabResume+=factCard('üìä','Mois b√©n√©ficiaires',
      moisExcedent.length+' / '+T.moisData,
      moisExcedent.length===T.moisData?'Tous positifs !':moisDeficit.length+' d√©ficitaire'+(moisDeficit.length>1?'s':''),
      moisExcedent.length>=T.moisData*0.75?'green':'orange',
      moisExcedent.length>0?'Exc√©dents : '+fmt(totalExcedent):'');

    tabResume+=factCard('üí∏','Total d√©ficits cumul√©s',
      moisDeficit.length>0?fmt(Math.abs(totalDeficit)):'Aucun d√©ficit',
      moisDeficit.length>0?moisDeficit.length+' mois dans le rouge':'‚úÖ Tous les mois couvrent leurs charges',
      moisDeficit.length>0?'red':'green',
      moisDeficit.length>0&&moisExcedent.length>0?'Exc√©dents compensateurs : '+fmt(totalExcedent):'');

    tabResume+=factCard(caAccelere&&caAccelere.pct>0?'üöÄ':'üìâ',
      'Dynamique S1 ‚Üí S2',
      caAccelere?fmt(caAccelere.second)+'/mois':'‚Äî',
      caAccelere?''+( caAccelere.pct>=0?'+':'')+caAccelere.pct.toFixed(1)+'% vs S1':'Donn√©es insuffisantes',
      caAccelere?( caAccelere.pct>5?'green': caAccelere.pct<-5?'red':'orange'):'gray',
      caAccelere?'S1 moy. : '+fmt(caAccelere.first)+'/mois':'Moins de 4 mois enregistr√©s');

    tabResume+=factCard('‚ö°','Seuil de rentabilit√©',
      T.moisData>0&&txVar<100?fmt(T.fixe/(1-txVar/100)/T.moisData)+'/mois':'‚Äî',
      caMens>0&&T.fixe/(1-txVar/100)/T.moisData>0?(caMens>T.fixe/(1-txVar/100)/T.moisData?'‚úÖ CA moy. au-dessus du seuil':'‚ö†Ô∏è CA moy. sous le seuil'):'',
      caMens>0&&T.moisData>0&&T.fixe/(1-txVar/100)/T.moisData>0?(caMens>T.fixe/(1-txVar/100)/T.moisData?'green':'red'):'gray',
      'Point mort mensuel estim√©');

    tabResume+='</div></div>';
  }

  // ‚îÄ‚îÄ MINI ANALYSE DE SITUATION
  (function(){
    var analyse=[];
    var scoreGlobal=0; // 0-100

    // CA & croissance
    if(evCA!==null&&Math.abs(evCA)<500){
      if(evCA>15){scoreGlobal+=20;analyse.push({type:'good',titre:'Croissance CA solide',texte:'Le chiffre d\'affaires progresse de <strong>+'+evCA.toFixed(1)+'%</strong> par rapport √† la m√™me p√©riode N-1 ('+fmt(TN1.caHT)+' ‚Üí '+fmt(T.caHT)+'). Cette dynamique est encourageante et t√©moigne d\'une activit√© en d√©veloppement.'});}
      else if(evCA>5){scoreGlobal+=12;analyse.push({type:'good',titre:'CA en l√©g√®re hausse',texte:'Le CA est en progression de <strong>+'+evCA.toFixed(1)+'%</strong> vs N-1. La croissance est mod√©r√©e mais positive ‚Äî √† maintenir.'});}
      else if(evCA<-10){scoreGlobal-=15;analyse.push({type:'bad',titre:'Baisse significative du CA',texte:'Le CA recule de <strong>'+evCA.toFixed(1)+'%</strong> par rapport √† N-1 ('+fmt(TN1.caHT)+' ‚Üí '+fmt(T.caHT)+'). Une analyse des causes s\'impose : perte de client√®le, baisse des prix, saisonnalit√© ?'});}
      else if(evCA<0){scoreGlobal-=5;analyse.push({type:'warn',titre:'CA en l√©g√®re baisse',texte:'L√©g√®re contraction du CA de '+evCA.toFixed(1)+'% vs N-1. √Ä surveiller mais pas encore alarmant.'});}
      else{scoreGlobal+=6;analyse.push({type:'info',titre:'CA stable vs N-1',texte:'Le CA est quasiment stable par rapport √† l\'an dernier ('+fmtPct(evCA)+').'});}
    } else {
      // Pas de N-1 ‚Äî analyser la tendance interne
      if(caMens>0) analyse.push({type:'info',titre:'Activit√© en cours',texte:'CA moyen mensuel de <strong>'+fmt(caMens)+'</strong> sur '+T.moisData+' mois enregistr√©s.'});
    }

    // Rentabilit√©
    if(margeN>15){scoreGlobal+=25;analyse.push({type:'good',titre:'Excellente rentabilit√©',texte:'Avec une marge nette de <strong>'+margeN.toFixed(1)+'%</strong>, la structure financi√®re est saine. Pour chaque euro encaiss√©, '+margeN.toFixed(0)+' centimes restent en b√©n√©fice apr√®s toutes les charges.'});}
    else if(margeN>8){scoreGlobal+=15;analyse.push({type:'good',titre:'Bonne rentabilit√©',texte:'La marge nette de <strong>'+margeN.toFixed(1)+'%</strong> est satisfaisante. L\'activit√© g√©n√®re un r√©sultat positif qui permet de couvrir toutes les charges et de d√©gager des b√©n√©fices.'});}
    else if(margeN>0){scoreGlobal+=5;analyse.push({type:'warn',titre:'Rentabilit√© fragile',texte:'La marge nette est positive mais faible (<strong>'+margeN.toFixed(1)+'%</strong>). Le moindre impr√©vu (baisse de CA, hausse de charges) peut faire basculer le r√©sultat dans le n√©gatif. Il est conseill√© de renforcer les marges.'});}
    else if(margeN>-5){scoreGlobal-=10;analyse.push({type:'bad',titre:'L√©ger d√©ficit',texte:'Le r√©sultat est l√©g√®rement n√©gatif (<strong>'+margeN.toFixed(1)+'%</strong>). Les charges d√©passent le CA de '+fmt(Math.abs(T.resultat))+'. Une action rapide sur les charges ou le CA est n√©cessaire pour redresser la situation.'});}
    else{scoreGlobal-=25;analyse.push({type:'bad',titre:'D√©ficit important',texte:'La situation est d√©ficitaire avec une perte de <strong>'+fmt(Math.abs(T.resultat))+'</strong> ('+Math.abs(margeN).toFixed(1)+'% du CA). Les charges structurelles sont trop √©lev√©es par rapport au CA g√©n√©r√©. Une restructuration est √† envisager.'});}

    // Structure des charges
    if(txFixe>60){scoreGlobal-=10;analyse.push({type:'warn',titre:'Charges fixes dominantes',texte:'Les charges fixes repr√©sentent <strong>'+txFixe.toFixed(1)+'% du CA</strong> ('+fmt(T.fixe)+'), ce qui est √©lev√©. Cette rigidit√© expose l\'activit√© aux fluctuations de CA : m√™me en cas de baisse d\'activit√©, ces charges restent dues.'});}
    else if(txFixe>40){analyse.push({type:'info',titre:'√âquilibre charges fixes/variables',texte:'Les charges fixes repr√©sentent '+txFixe.toFixed(1)+'% du CA. La structure est √©quilibr√©e mais le seuil de rentabilit√© reste √† surveiller.'});}

    // Endettement
    if(totDettes>0){
      if(ratioEndett>150){scoreGlobal-=15;analyse.push({type:'bad',titre:'Endettement pr√©occupant',texte:'L\'encours de dettes (<strong>'+fmt(totDettes)+'</strong>) repr√©sente '+ratioEndett.toFixed(0)+'% du CA annuel. Ce niveau d\'endettement laisse peu de marge de man≈ìuvre et p√®se lourd sur la tr√©sorerie ('+fmt(totMensDettes)+'/mois de mensualit√©s).'});}
      else if(ratioEndett>80){scoreGlobal-=5;analyse.push({type:'warn',titre:'Endettement √† surveiller',texte:'L\'encours de dettes de <strong>'+fmt(totDettes)+'</strong> repr√©sente '+ratioEndett.toFixed(0)+'% du CA. Les mensualit√©s de '+fmt(totMensDettes)+'/mois sont √† int√©grer dans le pilotage de tr√©sorerie.'});}
      else{analyse.push({type:'good',titre:'Endettement ma√Ætris√©',texte:'L\'encours de dettes (<strong>'+fmt(totDettes)+'</strong> ‚Äî '+ratioEndett.toFixed(0)+'% du CA) reste √† un niveau g√©rable. Les mensualit√©s de '+fmt(totMensDettes)+'/mois sont absorbables par l\'activit√©.'});}
    }

    // TVA
    if(T.tvaDue<0){analyse.push({type:'info',titre:'Cr√©dit de TVA',texte:'La TVA d√©ductible d√©passe la TVA collect√©e, g√©n√©rant un <strong>cr√©dit de '+fmt(Math.abs(T.tvaDue))+'</strong>. Ce montant est r√©cup√©rable aupr√®s des imp√¥ts ou reportable sur la prochaine d√©claration.'});}
    else if(T.tvaDue>2000){analyse.push({type:'warn',titre:'TVA √† provisionner',texte:'La TVA due estim√©e s\'√©l√®ve √† <strong>'+fmt(T.tvaDue)+'</strong>. Pensez √† provisionner ce montant pour √©viter une tension de tr√©sorerie lors de la d√©claration.'});}

    // Dynamique S1/S2
    if(caAccelere&&Math.abs(caAccelere.pct)>10){
      if(caAccelere.pct>10){scoreGlobal+=10;analyse.push({type:'good',titre:'Acc√©l√©ration en 2√®me partie d\'ann√©e',texte:'Le CA du 2√®me semestre (moy. '+fmt(caAccelere.second)+'/mois) est en hausse de <strong>+'+caAccelere.pct.toFixed(1)+'%</strong> par rapport au 1er semestre ('+fmt(caAccelere.first)+'/mois). L\'activit√© s\'acc√©l√®re, signe positif.'});}
      else if(caAccelere.pct<-10){scoreGlobal-=10;analyse.push({type:'warn',titre:'Ralentissement en 2√®me partie d\'ann√©e',texte:'Le CA du 2√®me semestre (moy. '+fmt(caAccelere.second)+'/mois) marque un recul de <strong>'+caAccelere.pct.toFixed(1)+'%</strong> vs le 1er semestre. √Ä analyser : saisonnalit√©, concurrence, √©v√©nements ?'});}
    }

    // Score global
    scoreGlobal=Math.max(0,Math.min(100,50+scoreGlobal));
    var scoreLabel=scoreGlobal>=70?'Situation saine':scoreGlobal>=50?'Situation correcte':scoreGlobal>=35?'Situation fragile':'Situation pr√©occupante';
    var scoreColor=scoreGlobal>=70?'var(--green)':scoreGlobal>=50?'var(--orange)':scoreGlobal>=35?'#f97316':'var(--red)';

    tabResume+='<div class="bilan-block full" style="margin-bottom:24px">'+
      '<div class="block-header">'+
        '<div class="block-title">üîç Analyse de la situation financi√®re</div>'+
        '<span class="block-badge badge-blue">G√©n√©r√© automatiquement</span>'+
      '</div>'+
      // Score g√©n√©ral
      '<div style="padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:24px;flex-wrap:wrap">'+
        '<div style="flex-shrink:0;text-align:center">'+
          '<div style="width:72px;height:72px;border-radius:50%;border:4px solid '+scoreColor+';display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto 6px">'+
            '<div style="font-size:20px;font-weight:800;color:'+scoreColor+'">'+scoreGlobal+'</div>'+
            '<div style="font-size:8px;color:var(--muted);font-weight:600">/100</div>'+
          '</div>'+
          '<div style="font-size:11px;font-weight:700;color:'+scoreColor+'">'+scoreLabel+'</div>'+
        '</div>'+
        '<div style="flex:1;min-width:200px">'+
          '<div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">Score de sant√© financi√®re</div>'+
          '<div style="height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-bottom:8px">'+
            '<div style="width:'+scoreGlobal+'%;height:100%;background:'+scoreColor+';border-radius:4px;transition:width 1s ease"></div>'+
          '</div>'+
          '<div style="font-size:12px;color:var(--muted)">Bas√© sur la marge nette, l\'√©volution du CA, la structure des charges et le niveau d\'endettement.</div>'+
        '</div>'+
        // R√©sum√© 3 chiffres cl√©s
        '<div style="display:flex;gap:16px;flex-wrap:wrap">'+
          '<div style="text-align:center;padding:0 16px;border-left:1px solid var(--border)">'+
            '<div style="font-size:18px;font-weight:800;color:'+(margeN>=0?'var(--green)':'var(--red)')+'">'+fmtPct(margeN,true)+'</div>'+
            '<div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase">Marge nette</div>'+
          '</div>'+
          '<div style="text-align:center;padding:0 16px;border-left:1px solid var(--border)">'+
            '<div style="font-size:18px;font-weight:800;color:var(--text)">'+fmtPct(txCharges,true)+'</div>'+
            '<div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase">Taux charges</div>'+
          '</div>'+
          (evCA!==null?'<div style="text-align:center;padding:0 16px;border-left:1px solid var(--border)">'+
            '<div style="font-size:18px;font-weight:800;color:'+(evCA>=0?'var(--green)':'var(--red)')+'">'+fmtPct(evCA)+'</div>'+
            '<div style="font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase">√âvolution CA</div>'+
          '</div>':'')+''+
        '</div>'+
      '</div>'+
      // Points d'analyse
      '<div style="padding:16px 24px;display:flex;flex-direction:column;gap:12px">';

    analyse.forEach(function(a){
      var bg={good:'#f0fdf4',warn:'#fffbeb',bad:'#fff1f2',info:'#eff6ff'};
      var border={good:'#bbf7d0',warn:'#fde68a',bad:'#fca5a5',info:'#bfdbfe'};
      var dot={good:'#10b981',warn:'#f59e0b',bad:'#ef4444',info:'#3b82f6'};
      tabResume+='<div style="background:'+bg[a.type]+';border:1px solid '+border[a.type]+';border-radius:10px;padding:12px 16px;display:flex;gap:12px;align-items:flex-start">'+
        '<div style="width:8px;height:8px;border-radius:50%;background:'+dot[a.type]+';margin-top:5px;flex-shrink:0"></div>'+
        '<div>'+
          '<div style="font-size:13px;font-weight:700;margin-bottom:3px">'+a.titre+'</div>'+
          '<div style="font-size:12px;line-height:1.6;color:#374151">'+a.texte+'</div>'+
        '</div>'+
      '</div>';
    });

    tabResume+='</div></div>';
  })();

  // Top charges
  if(topCharges.length>0){
    tabResume+='<div class="bilan-block full" style="margin-bottom:24px">'+
      '<div class="block-header"><div class="block-title">üí∏ Top fournisseurs & postes de charges</div><span class="block-badge badge-orange">Cumul√© sur la p√©riode</span></div>'+
      '<div style="overflow-x:auto"><table class="bilan-table"><thead><tr><th style="text-align:left">#</th><th style="text-align:left">Fournisseur</th><th style="text-align:left">Type</th><th>Total HT</th><th>% Charges</th><th>% CA</th></tr></thead><tbody>';
    topCharges.forEach(function(c,i){
      tabResume+='<tr>'+
        '<td style="color:var(--muted);font-size:12px">'+(i+1)+'</td>'+
        '<td style="font-weight:700">'+(c.fournisseur||'‚Äî')+'</td>'+
        '<td><span style="font-size:11px;color:var(--muted)">'+(c.type||'‚Äî')+'</span></td>'+
        '<td>'+fmt(c.total)+'</td>'+
        '<td><span class="'+(c.total/T.charges*100>20?'negative':'')+'">'+(T.charges>0?fmtPct(c.total/T.charges*100,true):'‚Äî')+'</span></td>'+
        '<td><span style="color:var(--muted)">'+(T.caHT>0?fmtPct(c.total/T.caHT*100,true):'‚Äî')+'</span></td>'+
      '</tr>';
    });
    tabResume+='<tr class="row-total"><td colspan="3">Total charges identifi√©es</td><td>'+fmt(T.charges)+'</td><td>100%</td><td>'+fmtPct(txCharges,true)+'</td></tr>';
    tabResume+='</tbody></table></div></div>';
  }

  // ‚îÄ‚îÄ TAB DETAIL MENSUEL
  var tabDetail='';
  tabDetail+='<div class="bilan-block full" style="margin-bottom:24px">'+
    '<div class="block-header"><div class="block-title">üìÖ D√©tail mensuel complet</div>'+
    '<span class="block-badge badge-blue">'+T.moisData+' mois</span></div>'+
    '<div style="overflow-x:auto"><table class="bilan-table">'+
    '<thead><tr>'+
      '<th style="text-align:left">Mois</th>'+
      '<th>CA journalier</th><th>Fact. Pro</th><th>Total CA HT</th>'+
      '<th>Fixes HT</th><th>Variables HT</th><th>Cr√©dits</th><th>Leasing</th>'+
      '<th>Total charges</th><th>R√©sultat HT</th><th>Marge %</th>'+
      (TN1.moisData>0?'<th>N-1 CA</th><th>Œî CA</th>':'')+
    '</tr></thead><tbody>';

  var tCA=0,tFP=0,tFx=0,tVr=0,tCr=0,tLs=0,tCh=0,tRs=0;
  monthly.forEach(function(m,idx){
    var n1key=(parseInt(m.yr)-1)+'-'+String(m.m+1).padStart(2,'0');
    var n1d=_allData[n1key]||null;
    var n1r=computeMonth(n1d,n1key);
    var empty=!m.hasData;
    if(!empty){tCA+=m.caHT;tFP+=m.caFP;tFx+=m.fixe;tVr+=m.variable;tCr+=m.credit;tLs+=m.leasing;tCh+=m.charges;tRs+=m.resultat;}
    var mg=m.caHT>0?m.resultat/m.caHT*100:0;
    var deltaCA=n1r.hasData&&m.hasData?(m.caHT-n1r.caHT):null;
    html+='';
    tabDetail+='<tr>';
    var futurStyle=m.isFuture?'background:#fffbeb;':'';
    var lbl_badge=m.isFuture
      ?'<span style="font-size:11px;font-weight:700;padding:3px 8px;background:#fef3c7;color:#92400e;border-radius:20px">'+m.lbl+'</span> <span style="font-size:10px;color:#b45309">üîÆ Pr√©vi</span>'
      :'<span style="font-size:11px;font-weight:700;padding:3px 8px;background:var(--blue-ghost);color:var(--blue-main);border-radius:20px">'+m.lbl+'</span> <span style="font-size:10px;color:var(--muted)">'+m.yr+'</span>';
    tabDetail+='<td style="white-space:nowrap;'+futurStyle+'">'+lbl_badge+'</td>';
    if(empty&&!m.isFuture){
      for(var ci=0;ci<(TN1.moisData>0?11:9);ci++)tabDetail+='<td style="color:#d1d5db">‚Äî</td>';
    } else if(m.isFuture){
      // Mois futur : afficher les charges pr√©vi, CA pr√©vi si saisi
      var caPreviStr=m.prevCA>0?'<span style="color:#92400e;font-weight:700">'+fmt(m.prevCA)+'</span>':'<span style="color:#d1d5db;font-style:italic">‚Äî</span>';
      var chargesStr=m.prevCharges>0?fmt(m.prevCharges):'<span style="color:#d1d5db">‚Äî</span>';
      var prevResM=m.prevCA-m.prevCharges;
      var prevResMStr=m.prevCharges>0?'<span style="color:'+(prevResM>=0?'#059669':'#b45309')+';font-weight:700">'+fmt(prevResM)+'</span>':'<span style="color:#d1d5db">‚Äî</span>';
      tabDetail+='<td style="'+futurStyle+'">'+caPreviStr+'</td>';
      tabDetail+='<td style="'+futurStyle+'">‚Äî</td>';
      tabDetail+='<td style="'+futurStyle+'">'+caPreviStr+'</td>';
      tabDetail+='<td style="color:#92400e;'+futurStyle+'">'+chargesStr+'</td>';
      tabDetail+='<td style="'+futurStyle+'">‚Äî</td>';
      tabDetail+='<td style="'+futurStyle+'">‚Äî</td>';
      tabDetail+='<td style="'+futurStyle+'">‚Äî</td>';
      tabDetail+='<td style="color:#92400e;font-weight:700;'+futurStyle+'">'+chargesStr+'</td>';
      tabDetail+='<td style="'+futurStyle+'">'+prevResMStr+'</td>';
      tabDetail+='<td style="'+futurStyle+'">‚Äî</td>';
      if(TN1.moisData>0)tabDetail+='<td style="'+futurStyle+'">‚Äî</td><td style="'+futurStyle+'">‚Äî</td>';
    } else {
      tabDetail+='<td>'+fmt(m.caJ)+'</td>';
      tabDetail+='<td>'+(m.caFP>0?'<span style="color:var(--purple)">'+fmt(m.caFP)+'</span>':'‚Äî')+'</td>';
      tabDetail+='<td style="font-weight:700">'+fmt(m.caHT)+'</td>';
      tabDetail+='<td>'+fmt(m.fixe)+'</td>';
      tabDetail+='<td>'+fmt(m.variable)+'</td>';
      tabDetail+='<td>'+(m.credit>0?fmt(m.credit):'‚Äî')+'</td>';
      tabDetail+='<td>'+(m.leasing>0?fmt(m.leasing):'‚Äî')+'</td>';
      tabDetail+='<td>'+fmt(m.charges)+'</td>';
      tabDetail+='<td class="'+(m.resultat>=0?'positive':'negative')+'">'+fmt(m.resultat)+'</td>';
      tabDetail+='<td class="'+(mg>=0?'positive':'negative')+'">'+fmtPct(mg,true)+'</td>';
      if(TN1.moisData>0){
        tabDetail+='<td style="color:var(--muted)">'+(n1r.hasData?fmt(n1r.caHT):'‚Äî')+'</td>';
        tabDetail+='<td class="'+(deltaCA===null?'':(deltaCA>=0?'positive':'negative'))+'">'+(deltaCA===null?'‚Äî':fmt(deltaCA))+'</td>';
      }
    }
    tabDetail+='</tr>';
  });
  var mgTot=tCA>0?tRs/tCA*100:0;
  tabDetail+='<tr class="row-total"><td>TOTAL</td><td>'+fmt(tCA-tFP)+'</td><td>'+fmt(tFP)+'</td><td>'+fmt(tCA)+'</td>'+
    '<td>'+fmt(tFx)+'</td><td>'+fmt(tVr)+'</td><td>'+fmt(tCr)+'</td><td>'+fmt(tLs)+'</td>'+
    '<td>'+fmt(tCh)+'</td>'+
    '<td class="'+(tRs>=0?'positive':'negative')+'">'+fmt(tRs)+'</td>'+
    '<td class="'+(mgTot>=0?'positive':'negative')+'">'+fmtPct(mgTot,true)+'</td>'+
    (TN1.moisData>0?'<td>'+fmt(TN1.caHT)+'</td><td class="'+(tCA-TN1.caHT>=0?'positive':'negative')+'">'+fmt(tCA-TN1.caHT)+'</td>':'')+
  '</tr>';
  tabDetail+='</tbody></table></div></div>';

  // Graphique sparkline CA
  if(moisData.length>1){
    var maxCA=Math.max.apply(null,moisData.map(function(m){return m.caHT;}));
    tabDetail+='<div class="bilan-block full" style="margin-bottom:24px">'+
      '<div class="block-header"><div class="block-title">üìà √âvolution CA mensuel</div></div>'+
      '<div style="display:flex;align-items:flex-end;gap:3px;height:80px;padding:12px 20px 4px">';
    monthly.forEach(function(m){
      var h=maxCA>0?Math.max(4,m.caHT/maxCA*56):4;
      var clr=m.hasData?(m.resultat>=0?'#10b981':'#ef4444'):'#e2e8f0';
      tabDetail+='<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px">'+
        '<div style="width:100%;height:'+h+'px;background:'+clr+';border-radius:3px 3px 0 0;transition:height .6s ease" title="'+m.lbl+' : '+fmt(m.caHT)+'"></div>'+
        '<span style="font-size:8px;color:var(--muted);font-weight:600">'+m.lbl+'</span>'+
      '</div>';
    });
    tabDetail+='</div></div>';
  }

  // ‚îÄ‚îÄ TAB TVA
  var tabTva='';
  tabTva+='<div class="bilan-block full" style="margin-bottom:20px">'+
    '<div class="block-header"><div class="block-title">üßæ Situation TVA de la p√©riode</div>'+
    '<span class="block-badge badge-'+(T.tvaDue<=0?'green':'red')+'">'+(T.tvaDue<=0?'üü¢ Cr√©dit TVA':'üî¥ TVA √† payer')+'</span></div>'+
    '<div class="tva-grid">'+
      '<div class="tva-cell">'+
        '<div class="tva-cell-label">TVA Collect√©e</div>'+
        '<div class="tva-cell-val" style="color:var(--orange)">'+fmt(T.tvaCollectee)+'</div>'+
        '<div class="tva-cell-sub">Sur ventes (CA HT + TVA)</div>'+
      '</div>'+
      '<div class="tva-cell">'+
        '<div class="tva-cell-label">TVA D√©ductible</div>'+
        '<div class="tva-cell-val" style="color:var(--green)">'+fmt(T.tvaDed)+'</div>'+
        '<div class="tva-cell-sub">Sur achats & charges</div>'+
      '</div>'+
      '<div class="tva-cell">'+
        '<div class="tva-cell-label">'+(T.tvaDue>=0?'TVA √† reverser':'Cr√©dit de TVA')+'</div>'+
        '<div class="tva-cell-val" style="color:'+(T.tvaDue>=0?'var(--red)':'var(--green)')+'">'+fmt(Math.abs(T.tvaDue))+'</div>'+
        '<div class="tva-cell-sub">'+(T.tvaDue>=0?'√Ä provisionner & payer':'Remboursable ou reportable')+'</div>'+
      '</div>'+
    '</div>'+
  '</div>';

  // D√©tail TVA par taux
  tabTva+='<div class="bilan-grid">';
  tabTva+='<div class="bilan-block">'+
    '<div class="block-header"><div class="block-title">üî¢ TVA collect√©e par taux</div></div>'+
    '<table class="bilan-table"><thead><tr><th>Taux TVA</th><th>Base HT</th><th>TVA</th><th>% base</th></tr></thead><tbody>';
  if(T.caHT055>0)tabTva+='<tr><td><span style="background:#dcfce7;color:#16a34a;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:700">5,5%</span></td><td>'+fmt(T.caHT055)+'</td><td>'+fmt(T.caHT055*0.055)+'</td><td>'+fmtPct(T.caHT>0?T.caHT055/T.caHT*100:0,true)+'</td></tr>';
  if(T.caHT10>0)tabTva+='<tr><td><span style="background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:700">10%</span></td><td>'+fmt(T.caHT10)+'</td><td>'+fmt(T.caHT10*0.10)+'</td><td>'+fmtPct(T.caHT>0?T.caHT10/T.caHT*100:0,true)+'</td></tr>';
  if(T.caHT20>0)tabTva+='<tr><td><span style="background:#eff6ff;color:#1e40af;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:700">20%</span></td><td>'+fmt(T.caHT20)+'</td><td>'+fmt(T.caHT20*0.20)+'</td><td>'+fmtPct(T.caHT>0?T.caHT20/T.caHT*100:0,true)+'</td></tr>';
  tabTva+='<tr class="row-total"><td>Total</td><td>'+fmt(T.caHT)+'</td><td>'+fmt(T.tvaCollectee)+'</td><td>100%</td></tr>';
  tabTva+='</tbody></table></div>';

  // TVA mensuelle
  tabTva+='<div class="bilan-block">'+
    '<div class="block-header"><div class="block-title">üìÖ TVA mensuelle</div></div>'+
    '<table class="bilan-table"><thead><tr><th style="text-align:left">Mois</th><th>Collect√©e</th><th>D√©ductible</th><th>Solde</th></tr></thead><tbody>';
  monthly.forEach(function(m){
    if(!m.hasData){tabTva+='<tr><td><span style="font-size:11px;font-weight:700;padding:2px 8px;background:var(--blue-ghost);color:var(--blue-main);border-radius:20px">'+m.lbl+'</span></td><td colspan="3" style="color:#d1d5db">‚Äî</td></tr>';return;}
    tabTva+='<tr>'+
      '<td><span style="font-size:11px;font-weight:700;padding:2px 8px;background:var(--blue-ghost);color:var(--blue-main);border-radius:20px">'+m.lbl+'</span></td>'+
      '<td>'+fmt(m.tvaCollectee)+'</td>'+
      '<td>'+fmt(m.tvaDed)+'</td>'+
      '<td class="'+(m.tvaDue<=0?'positive':'negative')+'">'+fmt(m.tvaDue)+'</td>'+
    '</tr>';
  });
  tabTva+='<tr class="row-total"><td>TOTAL</td><td>'+fmt(T.tvaCollectee)+'</td><td>'+fmt(T.tvaDed)+'</td><td class="'+(T.tvaDue<=0?'positive':'negative')+'">'+fmt(T.tvaDue)+'</td></tr>';
  tabTva+='</tbody></table></div>';
  tabTva+='</div>'; // fin bilan-grid TVA

  // ‚îÄ‚îÄ TAB DETTES
  var tabDettes='';
  if(dettesActives.length===0){
    tabDettes='<div class="empty-state"><div class="big">‚úÖ</div><h3>Aucune dette active</h3><p>Aucun emprunt ou cr√©dit actif enregistr√©.</p></div>';
  } else {
    tabDettes+='<div class="kpi-row">';
    tabDettes+=kpi('red','üè¶','Encours total',fmt(totDettes),'Dettes actives : '+dettesActives.length);
    tabDettes+=kpi('orange','üìÖ','Mensualit√©s totales',fmt(totMensDettes),'/mois √† rembourser');
    tabDettes+=kpi(ratioEndett>150?'red':ratioEndett>80?'orange':'green','üìä','Endettement / CA',fmtPct(ratioEndett,true),'Ratio encours / CA annuel',ratioEndett>150?'negative':ratioEndett>80?'':' positive');
    var capNeg=T.caHT>0?(totMensDettes/caMens*100):0;
    tabDettes+=kpi(capNeg>25?'red':capNeg>15?'orange':'green','üí≥','Poids mensualit√©s',fmtPct(capNeg,true),'% du CA mensuel moy.');
    tabDettes+=kpi('blue','üí°','CA pour couvrir dettes',fmt(totDettes),'Capital restant total');
    tabDettes+='</div>';

    tabDettes+='<div class="bilan-block full" style="margin-bottom:24px">'+
      '<div class="block-header"><div class="block-title">üè¶ D√©tail des dettes & emprunts</div>'+
      '<span class="block-badge badge-red">Encours total '+fmt(totDettes)+'</span></div>'+
      '<div style="overflow-x:auto"><table class="bilan-table">'+
      '<thead><tr>'+
        '<th style="text-align:left">Nom</th><th>Capital initial</th><th>Restant d√ª</th>'+
        '<th>Mensualit√©</th><th>Taux</th><th>Dur√©e</th><th>Rembours√©</th><th>Avancement</th><th>Statut</th>'+
      '</tr></thead><tbody>';
    dettesActives.forEach(function(d){
      var mt=parseFloat(d.montant)||0;
      var rst=parseFloat(d.montantRestant||d.montant)||0;
      var mens=parseFloat(d.mensualite)||0;
      var prog=mt>0?Math.max(0,Math.min(100,(mt-rst)/mt*100)):0;
      var remb=mt-rst;
      tabDettes+='<tr>'+
        '<td style="font-weight:700">'+(d.libelle||d.nom||'Emprunt')+'</td>'+
        '<td>'+fmt(mt)+'</td>'+
        '<td class="negative">'+fmt(rst)+'</td>'+
        '<td>'+(mens>0?fmt(mens)+'/mois':'‚Äî')+'</td>'+
        '<td>'+(d.taux?d.taux+'%':'‚Äî')+'</td>'+
        '<td>'+(d.duree?d.duree+' mois':'‚Äî')+'</td>'+
        '<td class="positive">'+fmt(remb)+'</td>'+
        '<td style="min-width:130px">'+
          '<div style="display:flex;align-items:center;gap:6px">'+
            '<div style="flex:1;height:6px;background:#f1f5f9;border-radius:3px;overflow:hidden"><div style="width:'+prog.toFixed(0)+'%;height:100%;background:linear-gradient(90deg,var(--blue-main),var(--blue-light));border-radius:3px"></div></div>'+
            '<span style="font-size:11px;font-weight:700;color:var(--muted);min-width:28px">'+prog.toFixed(0)+'%</span>'+
          '</div>'+
        '</td>'+
        '<td><span style="font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;background:#fef3c7;color:#92400e">'+(d.statut||'Actif')+'</span></td>'+
      '</tr>';
    });
    tabDettes+='<tr class="row-total"><td colspan="2">TOTAL ENCOURS</td><td>'+fmt(totDettes)+'</td><td>'+fmt(totMensDettes)+'/mois</td><td colspan="4">Ratio endettement : '+fmtPct(ratioEndett,true)+'</td><td></td></tr>';
    tabDettes+='</tbody></table></div></div>';
  }

  // ‚îÄ‚îÄ TAB PROJECTION
  var tabProj='';
  var moisRestantsProj=12-T.moisData;
  var caMensMoy=T.moisData>0?T.caHT/T.moisData:0;
  var chargesMensMoy=T.moisData>0?T.charges/T.moisData:0;

  tabProj+='<div class="alert-box info" style="margin-bottom:20px;border-radius:10px">‚ÑπÔ∏è La projection est bas√©e sur la moyenne des mois d√©j√† saisis. Elle est indicative et ne tient pas compte de la saisonnalit√©.</div>';

  tabProj+='<div class="kpi-row">';
  tabProj+=kpi('blue','üí∞','CA projet√© '+year,fmt(projCA),moisRestantsProj>0?moisRestantsProj+' mois extrapol√©s':'12 mois complets');
  tabProj+=kpi('orange','üí∏','Charges projet√©es',fmt(projCharges),moisRestantsProj+' mois extrapol√©s');
  tabProj+=kpi(projResultat>=0?'green':'red','üìä','R√©sultat projet√©',fmt(projResultat),projCA>0?'Marge : '+fmtPct(projResultat/projCA*100,true):'',projResultat>=0?'positive':'negative');
  tabProj+=kpi('purple','üìà','vs N-1 (CA)',TN1.caHT>0?fmt(projCA-TN1.caHT):'‚Äî',TN1.caHT>0?fmtPct((projCA-TN1.caHT)/TN1.caHT*100)+'':'');
  tabProj+=kpi('teal','‚ö°','Seuil rentabilit√© annuel',T.moisData>0&&txVar<100?fmt(seuil*12)+'':' ‚Äî ','CA annuel min. estim√©');
  tabProj+='</div>';

  // Tableau projection mois par mois
  tabProj+='<div class="bilan-block full" style="margin-bottom:24px">'+
    '<div class="block-header"><div class="block-title">üìÖ Tableau pr√©visionnel mensuel</div><span class="block-badge badge-orange">Extrapolation lin√©aire</span></div>'+
    '<div style="overflow-x:auto"><table class="bilan-table">'+
    '<thead><tr><th style="text-align:left">Mois</th><th>CA HT</th><th>Charges</th><th>R√©sultat</th><th>Marge</th><th>Type</th></tr></thead><tbody>';

  var cumCA=0,cumCh=0,cumRes=0;
  var allMonths=[];
  for(var pm=0;pm<12;pm++){
    var pKey=year+'-'+String(pm+1).padStart(2,'0');
    var pd=_allData[pKey]||null;
    var pr=computeMonth(pd,pKey);
    allMonths.push({m:pm,lbl:MONTHS_SHORT[pm],hasReal:!!pd,caHT:pr.hasData?pr.caHT:caMensMoy,charges:pr.hasData?pr.charges:chargesMensMoy,resultat:pr.hasData?pr.resultat:caMensMoy-chargesMensMoy,isProj:!pd});
  }
  allMonths.forEach(function(m){
    cumCA+=m.caHT;cumCh+=m.charges;cumRes+=m.resultat;
    var mg=m.caHT>0?m.resultat/m.caHT*100:0;
    tabProj+='<tr'+(m.isProj?' class="row-proj"':'')+'>'+
      '<td><span style="font-size:11px;font-weight:700;padding:2px 8px;background:var(--blue-ghost);color:var(--blue-main);border-radius:20px">'+m.lbl+'</span></td>'+
      '<td>'+fmt(m.caHT)+'</td>'+
      '<td>'+fmt(m.charges)+'</td>'+
      '<td class="'+(m.resultat>=0?'positive':'negative')+'">'+fmt(m.resultat)+'</td>'+
      '<td class="'+(mg>=0?'positive':'negative')+'">'+fmtPct(mg,true)+'</td>'+
      '<td><span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px;background:'+(m.isProj?'#fef3c7':'#dcfce7')+';color:'+(m.isProj?'#92400e':'#16a34a')+'">'+(m.isProj?'Estim√©':'R√©el')+'</span></td>'+
    '</tr>';
  });
  var mgProj=cumCA>0?cumRes/cumCA*100:0;
  tabProj+='<tr class="row-total"><td>TOTAL '+year+'</td><td>'+fmt(cumCA)+'</td><td>'+fmt(cumCh)+'</td>'+
    '<td class="'+(cumRes>=0?'positive':'negative')+'">'+fmt(cumRes)+'</td>'+
    '<td class="'+(mgProj>=0?'positive':'negative')+'">'+fmtPct(mgProj,true)+'</td><td></td></tr>';
  tabProj+='</tbody></table></div></div>';

  // Sc√©narios
  tabProj+='<div class="bilan-block full" style="margin-bottom:24px">'+
    '<div class="block-header"><div class="block-title">üéØ Sc√©narios de fin d\'ann√©e</div><span class="block-badge badge-purple">Simulation</span></div>'+
    '<table class="bilan-table"><thead><tr><th style="text-align:left">Sc√©nario</th><th>CA annuel</th><th>Charges</th><th>R√©sultat</th><th>Marge</th><th>Vs objectif N-1</th></tr></thead><tbody>';

  var scenarios=[
    {label:'üî¥ Pessimiste (‚àí10%)',mult:0.9},
    {label:'‚öñÔ∏è Tendanciel (base)',mult:1.0},
    {label:'üü° Optimiste (+10%)',mult:1.1},
    {label:'üü¢ Ambitieux (+20%)',mult:1.2},
  ];
  scenarios.forEach(function(sc){
    var sCA=cumCA*sc.mult;
    var sCh=cumCh; // charges suppos√©es constantes
    var sRes=sCA-sCh+T.rentrees;
    var sMg=sCA>0?sRes/sCA*100:0;
    var vs=TN1.caHT>0?sCA-TN1.caHT:null;
    tabProj+='<tr>'+
      '<td style="font-weight:700">'+sc.label+'</td>'+
      '<td>'+fmt(sCA)+'</td>'+
      '<td>'+fmt(sCh)+'</td>'+
      '<td class="'+(sRes>=0?'positive':'negative')+'">'+fmt(sRes)+'</td>'+
      '<td class="'+(sMg>=0?'positive':'negative')+'">'+fmtPct(sMg,true)+'</td>'+
      '<td>'+(vs!==null?'<span class="'+(vs>=0?'positive':'negative')+'">'+fmt(vs)+'</span>':'‚Äî')+'</td>'+
    '</tr>';
  });
  tabProj+='</tbody></table></div>';

  // Assemblage final
  html+='<div id="tab-resume" class="tab-pane'+(_activeTab==='resume'?' active':'')+'">'+tabResume+'</div>';
  html+='<div id="tab-detail" class="tab-pane'+(_activeTab==='detail'?' active':'')+'">'+tabDetail+'</div>';
  html+='<div id="tab-tva" class="tab-pane'+(_activeTab==='tva'?' active':'')+'">'+tabTva+'</div>';
  html+='<div id="tab-dettes" class="tab-pane'+(_activeTab==='dettes'?' active':'')+'">'+tabDettes+'</div>';
  html+='<div id="tab-projection" class="tab-pane'+(_activeTab==='projection'?' active':'')+'">'+tabProj+'</div>';

  // DISCLAIMER
  html+='<div class="disclaimer">‚ö†Ô∏è <div><strong>Document indicatif non officiel</strong> ‚Äî Cette situation interm√©diaire est g√©n√©r√©e automatiquement √† partir des donn√©es saisies dans ALTEORE. Elle ne constitue pas un bilan comptable certifi√©. Les montants sont des estimations hors taxes (HT). Pour un bilan officiel, consultez votre expert-comptable.</div></div>';

  el.innerHTML=html;

  // Animer les barres
  setTimeout(function(){
    document.querySelectorAll('.progress-fill,.ratio-bar-fill').forEach(function(el){
      var w=el.style.width;el.style.width='0';setTimeout(function(){el.style.width=w;},50);
    });
  },100);
  document.getElementById('pageSubtitle').textContent=(_nomCommerce||'Mon Commerce')+' ¬∑ '+periodLabel;
}

// ‚îÄ‚îÄ Helpers HTML
function kpi(color,icon,label,value,sub,valCls,evol,isAmount){
  var n1html='';
  if(evol!==null&&evol!==undefined){
    var cls=evol>0?'up':evol<0?'down':'flat';
    var pfx=evol>0?'‚ñ≤ +':'‚ñº ';
    if(isAmount){n1html='<div class="kpi-n1 '+cls+'">'+pfx+fmt(Math.abs(evol))+' vs N-1</div>';}
    else{n1html='<div class="kpi-n1 '+cls+'">'+pfx+evol.toFixed(1)+'% vs N-1</div>';}
  }
  return '<div class="kpi-card '+color+'">'+
    '<div class="kpi-icon">'+icon+'</div>'+
    '<div class="kpi-label">'+label+'</div>'+
    '<div class="kpi-value'+(valCls?' '+valCls:'')+'">'+(value||'‚Äî')+'</div>'+
    '<div class="kpi-sub">'+sub+'</div>'+
    n1html+
  '</div>';
}
function rcell(label,value,cls,desc,cur,max){
  var bar=max>0?'<div class="ratio-bar"><div class="ratio-bar-fill" style="width:'+Math.min(100,cur/max*100).toFixed(1)+'%;background:'+(cls==='bad'?'#ef4444':cls==='warn'?'#f59e0b':'#10b981')+'"></div></div>':'';
  return '<div class="ratio-cell">'+
    '<div class="ratio-label">'+label+'</div>'+
    '<div class="ratio-value'+(cls?' '+cls:'')+'">'+(value||'‚Äî')+'</div>'+
    '<div class="ratio-desc">'+desc+'</div>'+bar+
  '</div>';
}
function pbar(label,val,total,color){
  var p=total>0?Math.min(100,val/total*100):0;
  return '<div class="progress-item">'+
    '<div class="progress-head"><span class="progress-label">'+label+'</span><span class="progress-val">'+fmt(val)+' ¬∑ '+p.toFixed(1)+'%</span></div>'+
    '<div class="progress-bar"><div class="progress-fill" style="width:'+p.toFixed(1)+'%;background:'+color+'"></div></div>'+
  '</div>';
}
function factCard(icon,label,sub,value,color,extra){
  var bg={green:'#f0fdf4',orange:'#fffbeb',red:'#fff1f2',gray:'var(--bg)'};
  var tc={green:'#15803d',orange:'#92400e',red:'#dc2626',gray:'var(--muted)'};
  return '<div style="padding:18px 20px;border-right:1px solid var(--border);background:'+(bg[color]||'white')+';position:relative;overflow:hidden">'+
    '<div style="position:absolute;top:0;left:0;right:0;height:3px;background:'+(tc[color]||'var(--border)')+'"></div>'+
    '<div style="font-size:22px;margin-bottom:8px">'+icon+'</div>'+
    '<div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">'+label+'</div>'+
    '<div style="font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px">'+sub+'</div>'+
    '<div style="font-size:18px;font-weight:800;color:'+(tc[color]||'var(--text)')+'">'+value+'</div>'+
    (extra?'<div style="font-size:11px;color:var(--muted);margin-top:5px;font-weight:500">'+extra+'</div>':'')+
  '</div>';
}

// ‚îÄ‚îÄ PDF EXPORT
function exportPDF(){
  try{
    var jsPDF=window.jspdf?window.jspdf.jsPDF:null;
    if(!jsPDF){alert('Librairie PDF non chargee.');return;}
    var doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});

    // ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var W=210, H=297, MG=14, CW=182;
    var HFOOTER=10, HMARGIN_TOP=14;
    var pageBottom = H - HFOOTER - 4; // y max utilisable

    var year=_selectedYear;
    var keys=getPeriodKeys(year);
    var keysN1=[];
    if(_customRange&&_rangeStart&&_rangeEnd){
      var rs1={year:_rangeStart.year-1,month:_rangeStart.month};
      var re1={year:_rangeEnd.year-1,month:_rangeEnd.month};
      var cy2=rs1.year,cm2=rs1.month;
      while(cy2<re1.year||(cy2===re1.year&&cm2<=re1.month)){
        keysN1.push(cy2+'-'+String(cm2+1).padStart(2,'0'));
        cm2++;if(cm2>11){cm2=0;cy2++;}if(keysN1.length>36)break;
      }
    } else { keysN1=getPeriodKeys(year-1); }

    var agg=aggregateKeys(keys), aggN1=aggregateKeys(keysN1);
    var T=agg.T, TN1=aggN1.T, monthly=agg.monthly, topCharges=agg.topChargesList;
    var nom=_nomCommerce||'Mon Commerce';
    var periodLabel=getPeriodLabel(year);
    var txCh=T.caHT>0?T.charges/T.caHT*100:0;
    var mgN=T.caHT>0?T.resultat/T.caHT*100:0;
    var caMens=T.moisData>0?T.caHT/T.moisData:0;
    var chargesMens=T.moisData>0?T.charges/T.moisData:0;
    var txVar=T.caHT>0?T.variable/T.caHT*100:0;
    var txFixe=T.caHT>0?T.fixe/T.caHT*100:0;
    var dA=_dettesData.filter(function(d){return d.statut!=='soldee'&&d.statut!=='solde';});
    var totD=dA.reduce(function(s,d){return s+(parseFloat(d.montantRestant||d.montant)||0);},0);
    var totM=dA.reduce(function(s,d){return s+(parseFloat(d.mensualite)||0);},0);
    var evCA=(TN1.caHT>0&&TN1.moisData>0&&TN1.caHT>T.caHT*0.05)?(T.caHT-TN1.caHT)/TN1.caHT*100:null;
    var ratioEndett=T.caHT>0?totD/T.caHT*100:0;

    // ‚îÄ‚îÄ Couleurs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var cBD=[15,31,92], cBL=[26,61,206], cGR=[16,185,129], cRD=[239,68,68], cOR=[245,158,11];
    var cWH=[255,255,255], cTX=[26,31,54], cMT=[107,114,128], cGY=[248,250,252], cBR=[226,232,240];
    var cLGR=[240,253,244], cLRD=[255,241,242], cLBL=[239,246,255], cLOR=[255,251,235];
    var cPU=[99,102,241];

    // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var y = HMARGIN_TOP;
    var pageNum = 1;

    // ‚îÄ‚îÄ Fonctions utilitaires ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function sf(style,size,c){
      doc.setFont('helvetica',style||'normal');
      doc.setFontSize(size||9);
      c=c||cTX;doc.setTextColor(c[0],c[1],c[2]);
    }
    function fill(c){doc.setFillColor(c[0],c[1],c[2]);}
    function stroke(c,w){doc.setDrawColor(c[0],c[1],c[2]);doc.setLineWidth(w||0.3);}
    function txt(t,x,yy,opts){doc.text(String(t),x,yy,opts||{});}

    // ‚îÄ‚îÄ Footer (appel√© en fin de chaque page) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function drawFooter(){
      fill(cBD);doc.rect(0,H-HFOOTER,W,HFOOTER,'F');
      fill(cBL);doc.rect(W*0.7,H-HFOOTER,W*0.3,HFOOTER,'F');
      sf('normal',6,cWH);
      txt('ALTEORE  |  '+nom+'  |  '+periodLabel,MG,H-3.5);
      sf('bold',7,cWH);
      txt(''+pageNum,W-MG,H-3.5,{align:'right'});
    }

    // ‚îÄ‚îÄ Nouvelle page ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function newPage(){
      drawFooter();
      doc.addPage();
      pageNum++;
      y=HMARGIN_TOP;
    }

    // ‚îÄ‚îÄ V√©rification espace restant ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Retourne true si on peut dessiner 'needed' mm sans d√©border
    function fits(needed){ return y+needed <= pageBottom; }

    // ‚îÄ‚îÄ Saut de page si n√©cessaire (safe break) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function ensureFits(needed){
      if(!fits(needed)) newPage();
    }

    // ‚îÄ‚îÄ Titre de section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Prot√®ge: titre + au moins 20mm de contenu sur la m√™me page
    function sectionTitle(t, minContent){
      minContent = minContent||20;
      ensureFits(12 + minContent);
      y+=3;
      // Barre bleue gauche
      fill(cBL);doc.rect(MG,y,3.5,8,'F');
      // Fond titre l√©ger
      fill(cLBL);doc.rect(MG+3.5,y,CW-3.5,8,'F');
      sf('bold',9,cBD);txt(t,MG+8,y+5.6);
      // Ligne d√©corative
      stroke(cBR,0.5);
      var tw=doc.getTextWidth(t);
      doc.line(MG+11+tw,y+4,MG+CW,y+4);
      y+=12;
    }

    // ‚îÄ‚îÄ Rendu d'un tableau ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // cols: [{label,x,w,r?}]  ‚Äî x et w absolus depuis bord gauche
    // Calcul automatique de l'hauteur totale pour protection pagination
    var ROW_H = 6.5;
    var HEAD_H = 8;
    var TOTAL_H = 8;

    function tableHeader(cols){
      ensureFits(HEAD_H + ROW_H); // header + au moins une ligne
      fill(cBD);doc.rect(MG,y,CW,HEAD_H,'F');
      // D√©grad√© droite
      fill(cBL);doc.rect(MG+CW*0.55,y,CW*0.45,HEAD_H,'F');
      sf('bold',6.5,cWH);
      cols.forEach(function(c){
        var tx = c.r ? (c.x+c.w-1.5) : (c.x+2.5);
        txt(c.label, tx, y+5.5, {align:c.r?'right':'left'});
      });
      y+=HEAD_H;
    }

    function tableRow(cols, vals, ri, opts){
      opts=opts||{};
      // Ne jamais couper une ligne √† mi-chemin
      // Si plus de place, nouvelle page + re-draw header
      if(!fits(ROW_H)){
        newPage();
        // Re-draw header sur nouvelle page
        if(opts.reHead) opts.reHead();
      }
      var bg=opts.bg||(ri%2===0?cWH:cGY);
      fill(bg);doc.rect(MG,y,CW,ROW_H,'F');
      // Accent couleur gauche
      if(opts.accent){fill(opts.accent);doc.rect(MG,y,2,ROW_H,'F');}
      // Ligne s√©paratrice fine
      stroke(cBR,0.15);doc.line(MG,y+ROW_H,MG+CW,y+ROW_H);
      cols.forEach(function(c,i){
        var v=vals[i]; if(v===null||v===undefined)v='-';
        var cl=(opts.colors&&opts.colors[i])||cTX;
        sf(opts.bold?'bold':'normal',6.5,cl);
        var tx = c.r ? (c.x+c.w-1.5) : (c.x+2.5);
        txt(String(v), tx, y+4.5, {align:c.r?'right':'left'});
      });
      y+=ROW_H;
    }

    function tableTotal(cols, vals, opts){
      opts=opts||{};
      ensureFits(TOTAL_H);
      fill(opts.bg||cBD);doc.rect(MG,y,CW,TOTAL_H,'F');
      // Top accent line
      fill(cBL);doc.rect(MG,y,CW,1.5,'F');
      sf('bold',7,opts.tc||cWH);
      cols.forEach(function(c,i){
        var v=vals[i]; if(v===null||v===undefined)v='';
        var tx = c.r ? (c.x+c.w-1.5) : (c.x+2.5);
        txt(String(v), tx, y+5.5, {align:c.r?'right':'left'});
      });
      y+=TOTAL_H;
    }

    // ‚îÄ‚îÄ PAGE 1 ‚Äì COUVERTURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Fond en deux blocs
    fill(cBD);doc.rect(0,0,W,62,'F');
    fill(cBL);doc.rect(W*0.5,0,W*0.5,62,'F');
    // Bande d√©co droite
    fill([79,126,248]);doc.rect(W-3,0,3,62,'F');
    // Logo / Nom commerce
    sf('bold',22,cWH);txt(nom.length>26?nom.slice(0,24)+'..':nom, MG,22);
    sf('bold',8,[200,215,240]);txt('SITUATION INTERMEDIAIRE',MG,31);
    sf('normal',8,[170,190,225]);txt(periodLabel+'   |   '+T.moisData+' mois',MG,40);
    sf('normal',7,[150,175,215]);txt('Document indicatif ‚Äî non officiel',MG,49);
    // Branding droite
    sf('bold',15,cWH);txt('ALTEORE',W-MG,20,{align:'right'});
    sf('normal',7.5,[170,195,235]);txt('alteore.com',W-MG,29,{align:'right'});
    sf('normal',7,[140,165,205]);txt(new Date().toLocaleDateString('fr-FR'),W-MG,38,{align:'right'});

    // KPIs bloc sous le header (fond blanc, ombre simul√©e)
    var kpis=[
      {v:fmtP(T.caHT),  lbl:'CA Total HT',  sub:evCA!==null?(evCA>=0?'+':'')+evCA.toFixed(1)+'% vs N-1':T.moisData+' mois', cl:cBL},
      {v:fmtP(T.charges),lbl:'Charges HT',  sub:fmtPctP(txCh,true)+' du CA', cl:cOR},
      {v:fmtP(T.resultat),lbl:T.resultat>=0?'Benefice':'Perte', sub:fmtPctP(Math.abs(mgN),true)+' de marge', cl:T.resultat>=0?cGR:cRD},
      {v:fmtP(totD),     lbl:'Encours dettes',sub:totM>0?fmtP(totM)+'/mois':'Aucune', cl:cPU},
    ];
    var kw=(CW-9)/4;
    y=68;
    kpis.forEach(function(k,i){
      var kx=MG+i*(kw+3);
      fill(cWH);doc.roundedRect(kx,y,kw,24,2,2,'F');
      fill(k.cl);doc.rect(kx,y,kw,3,'F');
      stroke(cBR,0.3);doc.roundedRect(kx,y,kw,24,2,2,'S');
      sf('normal',5.5,cMT);txt(k.lbl,kx+3,y+8.5);
      sf('bold',10,k.cl);txt(k.v,kx+3,y+17);
      sf('normal',5.5,cMT);txt(k.sub,kx+3,y+22.5);
    });
    y+=30;

    // KPIs ligne 2 (6 blocs)
    var kpis2=[
      [fmtP(caMens),'CA moyen/mois'],
      [fmtP(caMens/30),'CA moyen/jour'],
      [fmtPctP(txFixe,true),'Charges fixes/CA'],
      [fmtPctP(txVar,true),'Charges var./CA'],
      [fmtP(T.tvaCollectee),'TVA collectee'],
      [T.tvaDue<=0?'Credit '+fmtP(Math.abs(T.tvaDue)):fmtP(T.tvaDue),'TVA due'],
    ];
    var kw2=(CW-10)/6;
    kpis2.forEach(function(k,i){
      var kx=MG+i*(kw2+2);
      fill(cGY);doc.roundedRect(kx,y,kw2,15,1.5,1.5,'F');
      stroke(cBR,0.2);doc.roundedRect(kx,y,kw2,15,1.5,1.5,'S');
      sf('normal',5,cMT);txt(k[1],kx+2.5,y+6);
      sf('bold',8,cBD);txt(k[0],kx+2.5,y+13);
    });
    y+=21;

    // ‚îÄ‚îÄ COMPTE DE R√âSULTAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Colonnes: Poste(90) | Montant(40) | %CA(28) | N-1(24) = 182 ‚úì
    var rC=[
      {label:'Poste',     x:MG,    w:88, r:false},
      {label:'Montant HT',x:MG+88, w:42, r:true},
      {label:'% CA',      x:MG+130,w:26, r:true},
      {label:'N-1',       x:MG+156,w:26, r:true},
    ];
    sectionTitle('COMPTE DE RESULTAT SIMPLIFIE', 60);
    // Header manuel (design sp√©cial)
    fill(cBD);doc.rect(MG,y,CW,HEAD_H,'F');
    fill(cBL);doc.rect(MG+CW*0.5,y,CW*0.5,HEAD_H,'F');
    sf('bold',6.5,cWH);
    txt('Poste',MG+2.5,y+5.5);
    txt('Montant HT',rC[1].x+rC[1].w-1.5,y+5.5,{align:'right'});
    txt('% CA',rC[2].x+rC[2].w-1.5,y+5.5,{align:'right'});
    if(TN1.moisData>0) txt('N-1',rC[3].x+rC[3].w-1.5,y+5.5,{align:'right'});
    y+=HEAD_H;

    function prowR(lbl,val,pct,n1,isBold,isRes){
      if(!fits(ROW_H)) newPage();
      var bg=isRes?(val>=0?cLGR:cLRD):(isBold?cLBL:cWH);
      fill(bg);doc.rect(MG,y,CW,ROW_H,'F');
      if(isBold){fill(cBL);doc.rect(MG,y,2.5,ROW_H,'F');}
      stroke(cBR,0.15);doc.line(MG,y+ROW_H,MG+CW,y+ROW_H);
      sf(isBold?'bold':'normal',isBold?7:6.5,cTX);
      txt(lbl,MG+(isBold?5.5:3),y+4.5);
      if(typeof val==='number'){
        var vc=isRes?(val>=0?cGR:cRD):(isBold?cBD:cTX);
        sf(isBold?'bold':'normal',isBold?7.5:7,vc);
        txt(fmtP(val),rC[1].x+rC[1].w-1.5,y+4.5,{align:'right'});
      }
      sf('normal',6,cMT);txt(pct||'',rC[2].x+rC[2].w-1.5,y+4.5,{align:'right'});
      if(TN1.moisData>0&&n1!==undefined){
        sf('normal',6,[185,190,205]);
        txt(typeof n1==='number'?fmtP(n1):'-',rC[3].x+rC[3].w-1.5,y+4.5,{align:'right'});
      }
      y+=ROW_H;
    }
    prowR('CA journalier (caisse)',T.caJ,T.caHT>0?fmtPctP(T.caJ/T.caHT*100,true):'',TN1.caJ);
    if(T.caFP>0)prowR('  + Factures Pro / B2B',T.caFP,T.caHT>0?fmtPctP(T.caFP/T.caHT*100,true):'',TN1.caFP);
    if(T.rentrees>0)prowR('  + Rentrees supplementaires',T.rentrees,'',TN1.rentrees);
    prowR('TOTAL PRODUITS HT',T.caHT,'100%',TN1.caHT,true);
    y+=2;
    prowR('Charges fixes HT',T.fixe,T.caHT>0?fmtPctP(T.fixe/T.caHT*100,true):'',TN1.fixe);
    prowR('Charges variables HT',T.variable,T.caHT>0?fmtPctP(T.variable/T.caHT*100,true):'',TN1.variable);
    if(T.credit>0)prowR('Credits & Emprunts',T.credit,T.caHT>0?fmtPctP(T.credit/T.caHT*100,true):'',TN1.credit);
    if(T.leasing>0)prowR('Leasing / LOA / LLD',T.leasing,'',TN1.leasing);
    prowR('TOTAL CHARGES HT',T.charges,fmtPctP(txCh,true),TN1.charges,true);
    y+=2;
    prowR(T.resultat>=0?'BENEFICE ESTIME':'PERTE ESTIMEE',T.resultat,fmtPctP(Math.abs(mgN),true),TN1.resultat,true,true);
    y+=10;

    // ‚îÄ‚îÄ TVA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 3 blocs + tableau: besoin ~65mm ‚Üí forcer nouvelle page si < 65mm
    sectionTitle('SITUATION TVA ESTIMEE', 65);
    var tw3=(CW-6)/3;
    var tvaB=[
      {v:fmtP(T.tvaCollectee), l1:'TVA Collectee',    l2:'Sur ventes CA',           cl:cOR},
      {v:fmtP(T.tvaDed),       l1:'TVA Deductible',   l2:'Sur achats & charges',    cl:cGR},
      {v:T.tvaDue<=0?fmtP(Math.abs(T.tvaDue)):fmtP(T.tvaDue),
       l1:T.tvaDue<=0?'Credit de TVA':'TVA a reverser',
       l2:T.tvaDue<=0?'Remboursable':'A provisionner', cl:T.tvaDue<=0?cGR:cRD},
    ];
    tvaB.forEach(function(b,i){
      var bx=MG+i*(tw3+3);
      fill(cWH);doc.roundedRect(bx,y,tw3,20,2,2,'F');
      fill(b.cl);doc.rect(bx,y,tw3,3,'F');
      stroke(cBR,0.25);doc.roundedRect(bx,y,tw3,20,2,2,'S');
      sf('normal',6,cMT);txt(b.l1,bx+3.5,y+8);
      sf('bold',11,b.cl);txt(b.v,bx+3.5,y+16);
      sf('normal',5.5,cMT);txt(b.l2,bx+3.5,y+19.5);
    });
    y+=24;
    // Tableau TVA par taux: 82+42+38+20 = 182 ‚úì
    var tCols=[
      {label:'Taux',   x:MG,     w:82, r:false},
      {label:'Base HT',x:MG+82,  w:42, r:true},
      {label:'TVA',    x:MG+124, w:38, r:true},
      {label:'% base', x:MG+162, w:20, r:true},
    ];
    var trows=[];
    if(T.caHT055>0)trows.push(['5,5%',fmtP(T.caHT055),fmtP(T.caHT055*0.055),fmtPctP(T.caHT>0?T.caHT055/T.caHT*100:0,true)]);
    if(T.caHT10>0) trows.push(['10%', fmtP(T.caHT10), fmtP(T.caHT10*0.10), fmtPctP(T.caHT>0?T.caHT10/T.caHT*100:0,true)]);
    if(T.caHT20>0) trows.push(['20%', fmtP(T.caHT20), fmtP(T.caHT20*0.20), fmtPctP(T.caHT>0?T.caHT20/T.caHT*100:0,true)]);
    if(!trows.length)trows.push(['Aucun CA TVA enregistre','-','-','-']);
    tableHeader(tCols);
    trows.forEach(function(r,i){tableRow(tCols,r,i,{reHead:function(){tableHeader(tCols);}});});
    tableTotal(tCols,['TOTAL',fmtP(T.caHT),fmtP(T.tvaCollectee),'100%']);
    y+=10;

    // ‚îÄ‚îÄ DETAIL MENSUEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // 8 cols: 16+26+26+25+18+25+24+22 = 182 ‚úì
    var mCols=[
      {label:'Mois',    x:MG,     w:16, r:false},
      {label:'CA HT',   x:MG+16,  w:26, r:true},
      {label:'Charges', x:MG+42,  w:26, r:true},
      {label:'Resultat',x:MG+68,  w:25, r:true},
      {label:'Marge',   x:MG+93,  w:18, r:true},
      {label:'Fixes',   x:MG+111, w:25, r:true},
      {label:'Var.',    x:MG+136, w:24, r:true},
      {label:'N-1 CA',  x:MG+160, w:22, r:true},
    ];
    // Detail mensuel: header + rows + total. Si ‚â§ 15 mois: tenter de tenir ensemble
    var detailH = 12 + HEAD_H + ROW_H*monthly.length + TOTAL_H;
    if(detailH < 190) ensureFits(detailH);
    else ensureFits(12 + HEAD_H + ROW_H*4);
    y+=3; fill(cBL);doc.rect(MG,y,3.5,8,'F'); fill(cLBL);doc.rect(MG+3.5,y,CW-3.5,8,'F');
    sf('bold',9,cBD);txt('DETAIL MENSUEL',MG+8,y+5.6);
    stroke(cBR,0.5);var tw4d=doc.getTextWidth('DETAIL MENSUEL');
    doc.line(MG+11+tw4d,y+4,MG+CW,y+4); y+=12;
    tableHeader(mCols);
    var totCA=0,totCH=0,totRS=0,totFX=0,totVR=0;
    monthly.forEach(function(m,idx){
      var n1key=(m.yr-1)+'-'+String(m.m+1).padStart(2,'0');
      var n1r=computeMonth(_allData[n1key]||null,n1key);
      var mg2=m.caHT>0?m.resultat/m.caHT*100:0;
      if(m.hasData){totCA+=m.caHT;totCH+=m.charges;totRS+=m.resultat;totFX+=m.fixe;totVR+=m.variable;}
      var clrs=[cBL,cTX,cTX,
        m.hasData?(m.resultat>=0?cGR:cRD):cMT,
        m.hasData?(mg2>=0?cGR:cRD):cMT,
        cTX,cTX,[170,180,200]];
      tableRow(mCols,[
        m.lbl,
        m.hasData?fmtP(m.caHT):'-',
        m.hasData?fmtP(m.charges):'-',
        m.hasData?fmtP(m.resultat):'-',
        m.hasData?fmtPctP(mg2,true):'-',
        m.hasData?fmtP(m.fixe):'-',
        m.hasData?fmtP(m.variable):'-',
        n1r.hasData?fmtP(n1r.caHT):'-',
      ],idx,{colors:clrs,reHead:function(){tableHeader(mCols);}});
    });
    var mgTot=totCA>0?totRS/totCA*100:0;
    tableTotal(mCols,['TOTAL',fmtP(totCA),fmtP(totCH),fmtP(totRS),
      fmtPctP(mgTot,true),fmtP(totFX),fmtP(totVR),TN1.moisData>0?fmtP(TN1.caHT):'-']);
    y+=10;

    // ‚îÄ‚îÄ FAITS MARQUANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var moisData2=monthly.filter(function(m){return m.hasData;});
    if(moisData2.length>0){
      var meillCA2 =moisData2.reduce(function(a,b){return b.caHT>a.caHT?b:a;},moisData2[0]);
      var moinsCA2 =moisData2.reduce(function(a,b){return b.caHT<a.caHT?b:a;},moisData2[0]);
      var meillRes2=moisData2.reduce(function(a,b){return b.resultat>a.resultat?b:a;},moisData2[0]);
      var piresRes2=moisData2.reduce(function(a,b){return b.resultat<a.resultat?b:a;},moisData2[0]);
      var moisDef  =moisData2.filter(function(m){return m.resultat<0;});
      var moisExc  =moisData2.filter(function(m){return m.resultat>0;});
      var seuil    =txVar<100?T.fixe/(1-txVar/100)/moisData2.length:0;

      var facts=[
        {ic:'Meilleur mois CA',     v:fmtP(meillCA2.caHT),   s:meillCA2.lbl+' ‚Äî Res: '+fmtP(meillCA2.resultat),    cl:cGR},
        {ic:'CA le plus bas',       v:fmtP(moinsCA2.caHT),   s:moinsCA2.lbl+' ‚Äî Charges: '+fmtP(moinsCA2.charges), cl:cOR},
        {ic:'Meilleur resultat',    v:fmtP(meillRes2.resultat),s:meillRes2.lbl+' ‚Äî CA: '+fmtP(meillRes2.caHT),      cl:cGR},
        {ic:'Pire resultat',        v:fmtP(piresRes2.resultat),s:piresRes2.lbl+' ‚Äî CA: '+fmtP(piresRes2.caHT),     cl:piresRes2.resultat<0?cRD:cOR},
        {ic:'Mois beneficiaires',   v:moisExc.length+' / '+moisData2.length,s:moisDef.length+' mois deficitaire(s)',cl:moisExc.length>=moisData2.length*0.75?cGR:cOR},
        {ic:'Deficits cumules',     v:moisDef.length>0?fmtP(Math.abs(moisDef.reduce(function(s,m){return s+m.resultat;},0))):'Neant',s:moisDef.length>0?moisDef.length+' mois dans le rouge':'Tous les mois positifs',cl:moisDef.length>0?cRD:cGR},
        {ic:'CA moyen mensuel',     v:fmtP(caMens),           s:moisData2.length+' mois enregistres',              cl:cBL},
        {ic:'Seuil de rentabilite', v:seuil>0?fmtP(seuil):'-',s:'Point mort mensuel estime',                      cl:cPU},
      ];

      // 4 cartes par ligne, 2 lignes = 8 cartes
      var fw=(CW-9)/4, fh=20;
      sectionTitle('FAITS MARQUANTS DE LA PERIODE', fh*2+15);
      for(var fi=0;fi<2;fi++){
        // V√©rifier que les 4 cartes de la ligne tiennent ensemble
        ensureFits(fh+3);
        for(var fj=0;fj<4;fj++){
          var fk=facts[fi*4+fj];
          var fx=MG+fj*(fw+3);
          fill(cWH);doc.roundedRect(fx,y,fw,fh,2,2,'F');
          fill(fk.cl);doc.rect(fx,y,fw,2.5,'F');
          stroke(cBR,0.2);doc.roundedRect(fx,y,fw,fh,2,2,'S');
          sf('normal',5.5,cMT);txt(fk.ic,fx+3,y+7.5);
          sf('bold',9,fk.cl);txt(fk.v,fx+3,y+14.5);
          sf('normal',5,cMT);txt(fk.s.slice(0,32),fx+3,y+19);
        }
        y+=fh+4;
      }
      y+=6;
    }

    // ‚îÄ‚îÄ ANALYSE DE SITUATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    var scoreG=50;
    if(evCA!==null&&Math.abs(evCA)<500){
      if(evCA>15)scoreG+=20;else if(evCA>5)scoreG+=12;else if(evCA<-10)scoreG-=15;else if(evCA<0)scoreG-=5;else scoreG+=6;
    }
    if(mgN>15)scoreG+=25;else if(mgN>8)scoreG+=15;else if(mgN>0)scoreG+=5;else if(mgN>-5)scoreG-=10;else scoreG-=25;
    if(txFixe>60)scoreG-=10;
    if(totD>0){if(ratioEndett>150)scoreG-=15;else if(ratioEndett>80)scoreG-=5;}
    scoreG=Math.max(0,Math.min(100,scoreG));
    var scoreLbl=scoreG>=70?'Situation saine':scoreG>=50?'Situation correcte':scoreG>=35?'Situation fragile':'Situation preoccupante';
    var scoreCl=scoreG>=70?cGR:scoreG>=50?cOR:scoreG>=35?[249,115,22]:cRD;
    var scoreBg=scoreG>=70?cLGR:scoreG>=50?cLOR:cLRD;

    var analyses=[];
    if(evCA!==null&&Math.abs(evCA)<500){
      if(evCA>10)analyses.push({cl:cGR,t:'CA en hausse de +'+evCA.toFixed(1)+'% vs N-1 ('+fmtP(TN1.caHT)+' ‚Üí '+fmtP(T.caHT)+'). Dynamique positive.'});
      else if(evCA<-10)analyses.push({cl:cRD,t:'CA en baisse de '+Math.abs(evCA).toFixed(1)+'% vs N-1. Analyser : clientele, prix, saisonnalite.'});
      else analyses.push({cl:cOR,t:'Evolution CA moderee vs N-1 ('+fmtPctP(evCA)+'). Stabilite.'});
    }
    if(mgN>15)analyses.push({cl:cGR,t:'Excellente marge nette ('+fmtPctP(mgN,true)+'). Structure financiere tres saine.'});
    else if(mgN>8)analyses.push({cl:cGR,t:'Bonne marge nette ('+fmtPctP(mgN,true)+'). Activite rentable et bien geree.'});
    else if(mgN>0)analyses.push({cl:cOR,t:'Marge nette faible ('+fmtPctP(mgN,true)+'). Optimiser les charges pour consolider la rentabilite.'});
    else analyses.push({cl:cRD,t:'Deficit estime ('+fmtPctP(mgN,true)+'). Charges en exces de '+fmtP(Math.abs(T.resultat))+' vs CA. Action requise.'});
    if(txFixe>60)analyses.push({cl:cOR,t:'Charges fixes elevees ('+fmtPctP(txFixe,true)+' du CA). Exposition forte aux baisses d\'activite.'});
    if(totD>0){
      if(ratioEndett>150)analyses.push({cl:cRD,t:'Endettement important : '+fmtP(totD)+' ('+ratioEndett.toFixed(0)+'% du CA). Mensualites : '+fmtP(totM)+'/mois.'});
      else if(ratioEndett>80)analyses.push({cl:cOR,t:'Endettement a surveiller : '+fmtP(totD)+' ('+ratioEndett.toFixed(0)+'% du CA).'});
      else analyses.push({cl:cGR,t:'Endettement maitrise : '+fmtP(totD)+' ('+ratioEndett.toFixed(0)+'% du CA).'});
    }
    if(T.tvaDue>2000)analyses.push({cl:cOR,t:'TVA a provisionner : '+fmtP(T.tvaDue)+'. Preparer la tresorerie pour la declaration.'});
    if(T.tvaDue<0)analyses.push({cl:cBL,t:'Credit de TVA : '+fmtP(Math.abs(T.tvaDue))+'. Recuperable aupres de l\'administration fiscale.'});

    var analHeight = 24 + analyses.length * 9;
    sectionTitle('ANALYSE DE LA SITUATION', analHeight);

    // Bloc score
    fill(scoreBg);doc.roundedRect(MG,y,CW,18,2,2,'F');
    stroke(scoreCl,0.4);doc.roundedRect(MG,y,CW,18,2,2,'S');
    // Barre de score
    fill(cBR);doc.roundedRect(MG+60,y+5,(CW-64),6,1,1,'F');
    fill(scoreCl);doc.roundedRect(MG+60,y+5,Math.max(1,(CW-64)*scoreG/100),6,1,1,'F');
    sf('bold',11,scoreCl);txt(scoreG+'/100',MG+4,y+10);
    sf('bold',8,cBD);txt(scoreLbl,MG+4,y+16);
    sf('normal',6,cMT);txt('Base : marge nette, evolution CA, charges, endettement',MG+62,y+10);
    y+=22;

    // Points d'analyse
    analyses.forEach(function(a){
      if(!fits(9)) newPage();
      fill(cGY);doc.rect(MG,y,CW,7.5,'F');
      stroke(cBR,0.15);doc.line(MG,y+7.5,MG+CW,y+7.5);
      fill(a.cl);doc.circle(MG+5,y+3.75,1.8,'F');
      sf('normal',6.5,cTX);
      var lines2=doc.splitTextToSize(a.t,CW-14);
      txt(lines2[0]||'',MG+10,y+4.8);
      y+=7.5;
      if(lines2[1]){
        if(!fits(7)) newPage();
        fill(cGY);doc.rect(MG,y,CW,7,'F');
        stroke(cBR,0.15);doc.line(MG,y+7,MG+CW,y+7);
        txt(lines2[1],MG+10,y+4.5);
        y+=7;
      }
    });
    y+=10;

    // ‚îÄ‚îÄ TOP CHARGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(topCharges.length>0){
      var nRows=Math.min(topCharges.length,12);
      // 8+58+52+32+18+14 = 182 ‚úì
      var cCols=[
        {label:'#',          x:MG,     w:8,  r:false},
        {label:'Fournisseur',x:MG+8,   w:58, r:false},
        {label:'Type',       x:MG+66,  w:52, r:false},
        {label:'Total HT',   x:MG+118, w:32, r:true},
        {label:'% Ch.',      x:MG+150, w:18, r:true},
        {label:'% CA',       x:MG+168, w:14, r:true},
      ];
      // Prot√©ger: si toute la section tient sur une page, forcer nouvelle page
      // Si trop grande pour une page (>220mm), accepter la coupure avec reHead
      var topTotalH = 12 + HEAD_H + ROW_H*nRows + TOTAL_H + 10;
      if(topTotalH < 200) ensureFits(topTotalH);
      else ensureFits(12 + HEAD_H + ROW_H*3); // au moins 3 lignes
      y+=3; fill(cBL);doc.rect(MG,y,3.5,8,'F'); fill(cLBL);doc.rect(MG+3.5,y,CW-3.5,8,'F');
      sf('bold',9,cBD);txt('TOP POSTES DE CHARGES',MG+8,y+5.6);
      stroke(cBR,0.5);var tw2=doc.getTextWidth('TOP POSTES DE CHARGES');
      doc.line(MG+11+tw2,y+4,MG+CW,y+4); y+=12;
      tableHeader(cCols);
      topCharges.slice(0,12).forEach(function(c,i){
        tableRow(cCols,[(i+1)+'.', (c.fournisseur||'-').slice(0,22), (c.type||'-').slice(0,20),
          fmtP(c.total),
          T.charges>0?fmtPctP(c.total/T.charges*100,true):'-',
          T.caHT>0?fmtPctP(c.total/T.caHT*100,true):'-'],i,
          {reHead:function(){tableHeader(cCols);}});
      });
      tableTotal(cCols,['','Total charges','',fmtP(T.charges),'100%',fmtPctP(txCh,true)]);
      y+=10;
    }

    // ‚îÄ‚îÄ DETTES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(dA.length>0){
      // 52+28+28+28+14+12+20 = 182 ‚úì
      var dCols=[
        {label:'Credit / Emprunt',x:MG,     w:52, r:false},
        {label:'Capital',         x:MG+52,  w:28, r:true},
        {label:'Restant',         x:MG+80,  w:28, r:true},
        {label:'Mensual.',        x:MG+108, w:28, r:true},
        {label:'Taux',            x:MG+136, w:14, r:true},
        {label:'Duree',           x:MG+150, w:12, r:true},
        {label:'Avanc.',          x:MG+162, w:20, r:true},
      ];
      var dettesTotalH = 12 + 13 + HEAD_H + ROW_H*dA.length + TOTAL_H + 10;
      if(dettesTotalH < 200) ensureFits(dettesTotalH);
      else ensureFits(12 + 13 + HEAD_H + ROW_H*2);
      y+=3; fill(cBL);doc.rect(MG,y,3.5,8,'F'); fill(cLBL);doc.rect(MG+3.5,y,CW-3.5,8,'F');
      sf('bold',9,cBD);txt('DETTES ET EMPRUNTS',MG+8,y+5.6);
      stroke(cBR,0.5);var tw3d=doc.getTextWidth('DETTES ET EMPRUNTS');
      doc.line(MG+11+tw3d,y+4,MG+CW,y+4); y+=12;
      // R√©sum√© dettes
      fill(cLBL);doc.roundedRect(MG,y,CW,10,1.5,1.5,'F');
      sf('normal',6.5,cBD);
      txt('Encours total : '+fmtP(totD)+'   |   Mensualites : '+fmtP(totM)+'/mois   |   '+dA.length+' emprunt(s) actif(s)   |   Ratio encours/CA : '+fmtPctP(ratioEndett,true),MG+4,y+6.5);
      y+=13;
      tableHeader(dCols);
      dA.forEach(function(d,i){
        var mt=parseFloat(d.montant)||0, rst=parseFloat(d.montantRestant||d.montant)||0;
        var mens=parseFloat(d.mensualite)||0;
        var prog=mt>0?Math.max(0,Math.min(100,(mt-rst)/mt*100)):0;
        tableRow(dCols,[(d.libelle||d.nom||'Emprunt').slice(0,22),
          fmtP(mt),fmtP(rst),mens>0?fmtP(mens)+'/m':'-',
          d.taux?d.taux+'%':'-',d.duree?d.duree+'m':'-',prog.toFixed(0)+'%'],i,
          {reHead:function(){tableHeader(dCols);}});
      });
      tableTotal(dCols,['TOTAL','',fmtP(totD),fmtP(totM)+'/m','','','']);
      y+=10;
    }

    // ‚îÄ‚îÄ PROJECTION (mode p√©riode seulement) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if(!_customRange){
      var allPM=[];
      for(var pm=0;pm<12;pm++){
        var pKey=year+'-'+String(pm+1).padStart(2,'0');
        var pr=computeMonth(_allData[pKey]||null,pKey);
        allPM.push({lbl:MONTHS_SHORT[pm],caHT:pr.hasData?pr.caHT:caMens,
          charges:pr.hasData?pr.charges:chargesMens,
          resultat:pr.hasData?pr.resultat:(caMens-chargesMens),isProj:!pr.hasData});
      }
      var projCA=allPM.reduce(function(s,m){return s+m.caHT;},0);
      var projCh=allPM.reduce(function(s,m){return s+m.charges;},0);
      var projRes=projCA-projCh+T.rentrees;
      var projMg=projCA>0?projRes/projCA*100:0;
      // 18+36+34+34+22+38 = 182 ‚úì
      var pCols=[
        {label:'Mois',    x:MG,     w:18, r:false},
        {label:'CA HT',   x:MG+18,  w:36, r:true},
        {label:'Charges', x:MG+54,  w:34, r:true},
        {label:'Resultat',x:MG+88,  w:34, r:true},
        {label:'Marge',   x:MG+122, w:22, r:true},
        {label:'Type',    x:MG+144, w:38, r:false},
      ];
      sectionTitle('PROJECTION FIN D\'ANNEE '+year, HEAD_H+ROW_H*12+TOTAL_H+4);
      tableHeader(pCols);
      allPM.forEach(function(m,idx){
        var mg2=m.caHT>0?m.resultat/m.caHT*100:0;
        tableRow(pCols,[m.lbl,fmtP(m.caHT),fmtP(m.charges),fmtP(m.resultat),
          fmtPctP(mg2,true),m.isProj?'Estime':'Reel'],idx,{
          bg:m.isProj?cLOR:null,
          colors:[cBL,cTX,cTX,m.resultat>=0?cGR:cRD,mg2>=0?cGR:cRD,m.isProj?cOR:cGR],
          reHead:function(){tableHeader(pCols);}
        });
      });
      tableTotal(pCols,['TOTAL',fmtP(projCA),fmtP(projCh),fmtP(projRes),fmtPctP(projMg,true),'']);
      y+=8;

      // Sc√©narios
      sectionTitle('SCENARIOS FIN D\'ANNEE',30);
      var scens=[['Pessimiste (-10%)',0.9],['Tendanciel',1.0],['Optimiste (+10%)',1.1],['Ambitieux (+20%)',1.2]];
      var sw2=(CW-9)/4;
      ensureFits(28);
      scens.forEach(function(sc,i){
        var sCA2=projCA*sc[1],sRes2=sCA2-projCh+T.rentrees;
        var smg2=sCA2>0?sRes2/sCA2*100:0;
        var sx2=MG+i*(sw2+3);
        var sclr=sc[1]>=1?cGR:cRD;
        var sbg=sc[1]>=1?cLGR:cLRD;
        fill(sbg);doc.roundedRect(sx2,y,sw2,24,2,2,'F');
        fill(sclr);doc.rect(sx2,y,sw2,3,'F');
        stroke(cBR,0.2);doc.roundedRect(sx2,y,sw2,24,2,2,'S');
        sf('normal',5.5,cMT);txt(sc[0],sx2+3,y+8);
        sf('bold',10,sclr);txt(fmtP(sRes2),sx2+3,y+17);
        sf('normal',5.5,cMT);txt('Marge: '+fmtPctP(smg2,true)+'   CA: '+fmtP(sCA2),sx2+3,y+22.5);
      });
      y+=28;
    }

    // ‚îÄ‚îÄ DISCLAIMER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ensureFits(16);
    fill(cLOR);doc.roundedRect(MG,y,CW,14,2,2,'F');
    stroke([253,230,138],0.4);doc.roundedRect(MG,y,CW,14,2,2,'S');
    sf('bold',6.5,[146,64,14]);
    txt('Document indicatif - ne constitue pas un bilan officiel. Pour un bilan certifie, consultez votre expert-comptable.',MG+4,y+5.5);
    sf('normal',6.5,[146,64,14]);
    txt('Donnees saisies sur ALTEORE (alteore.com). Genere le '+new Date().toLocaleDateString('fr-FR')+'.',MG+4,y+11);

    // Footer sur derni√®re page
    drawFooter();

    var fn='situation-alteore-'+nom.replace(/[^a-z0-9]/gi,'-').toLowerCase()+'-'+year+'.pdf';
    doc.save(fn);
  }catch(e){console.error('PDF error:',e);alert('Erreur PDF : '+e.message);}
}
</script>
</body>
</html>
