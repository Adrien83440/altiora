<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>Ma Carte Fid√©lit√©</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --blue:#1a3dce;--blue2:#4f7ef8;--bg:#f4f6fb;
  --green:#10b981;--orange:#f59e0b;--purple:#6366f1;
  --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;
  --radius:16px;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:13px}

/* HERO HEADER */
.hero{background:linear-gradient(135deg,#0f1f5c,#1a3dce,#4f7ef8);padding:28px 20px 80px;text-align:center;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;right:-60px;top:-60px;width:220px;height:220px;border-radius:50%;background:rgba(255,255,255,.05)}
.hero::after{content:'';position:absolute;left:-40px;bottom:-40px;width:180px;height:180px;border-radius:50%;background:rgba(255,255,255,.04)}
.hero-logo{font-size:13px;font-weight:700;color:rgba(255,255,255,.5);letter-spacing:1px;text-transform:uppercase;margin-bottom:20px}
.hero-avatar{width:72px;height:72px;border-radius:50%;border:3px solid rgba(255,255,255,.4);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:800;color:#fff;margin:0 auto 12px;background:rgba(255,255,255,.15)}
.hero-name{font-size:22px;font-weight:800;color:#fff;margin-bottom:4px}
.hero-sub{font-size:13px;color:rgba(255,255,255,.6)}
.hero-pts{display:inline-flex;align-items:center;gap:6px;margin-top:14px;padding:8px 18px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);border-radius:30px;color:#fff;font-size:14px;font-weight:700}

/* CARTE FLOTTANTE */
.card-wrap{padding:0 16px;margin-top:-56px;position:relative;z-index:10}
.fid-card{border-radius:20px;padding:24px;color:#fff;min-height:170px;position:relative;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25)}
.fid-card::before{content:'';position:absolute;right:-40px;top:-40px;width:180px;height:180px;border-radius:50%;background:rgba(255,255,255,.07)}
.fid-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px}
.fid-card-title{font-size:10px;font-weight:700;opacity:.6;text-transform:uppercase;letter-spacing:1px}
.fid-card-shop{font-size:16px;font-weight:800;margin-top:3px}
.fid-card-pts{text-align:right}
.fid-card-pts-val{font-size:20px;font-weight:800}
.fid-card-pts-lbl{font-size:10px;opacity:.6}
.tampons-grid{display:flex;gap:7px;flex-wrap:wrap}
.tampon{width:38px;height:38px;border-radius:50%;border:2px solid rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;font-size:17px;transition:.3s;background:rgba(255,255,255,.08)}
.tampon.done{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.7);box-shadow:0 0 10px rgba(255,255,255,.2)}
.tampon.reward{background:linear-gradient(135deg,#f59e0b,#fbbf24);border-color:#fbbf24;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(251,191,36,.4)}50%{box-shadow:0 0 0 8px rgba(251,191,36,0)}}
.fid-progress{margin-top:14px}
.fid-progress-bar{background:rgba(255,255,255,.2);border-radius:99px;height:6px;overflow:hidden}
.fid-progress-fill{height:100%;border-radius:99px;background:rgba(255,255,255,.8);transition:width 1s ease}
.fid-progress-label{display:flex;justify-content:space-between;margin-top:5px;font-size:10px;opacity:.65}

/* CONTENT */
.content{padding:20px 16px;display:flex;flex-direction:column;gap:14px}

/* SECTIONS */
.section-title{font-size:14px;font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:7px}
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.card-body{padding:16px}

/* POINTS BARRE */
.pts-section{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.pts-level{display:flex;justify-content:space-between;margin-bottom:8px}
.pts-current{font-size:24px;font-weight:800;color:var(--blue)}
.pts-next{font-size:12px;color:var(--muted);text-align:right;line-height:1.4}
.pts-bar{background:#f1f5f9;border-radius:99px;height:10px;overflow:hidden;margin-bottom:6px}
.pts-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--blue),var(--blue2));transition:width 1.2s ease}
.pts-milestones{display:flex;justify-content:space-between;font-size:10px;color:var(--muted)}

/* PALIERS */
.palier-item{display:flex;align-items:center;gap:12px;padding:12px;border:1px solid var(--border);border-radius:12px;margin-bottom:8px;transition:.2s}
.palier-item.unlocked{border-color:var(--green);background:#f0fdf4}
.palier-item.current{border-color:var(--orange);background:#fffbeb;box-shadow:0 0 0 2px rgba(245,158,11,.15)}
.palier-ico{font-size:26px;width:44px;text-align:center;flex-shrink:0}
.palier-info{flex:1}
.palier-name{font-size:13px;font-weight:700}
.palier-pts-needed{font-size:11px;color:var(--muted);margin-top:2px}
.palier-status{font-size:11px;font-weight:700}
.palier-status.done{color:var(--green)}
.palier-status.next{color:var(--orange)}

/* COUPONS */
.coupon-item{display:flex;gap:12px;padding:14px;border:2px dashed var(--border);border-radius:12px;margin-bottom:8px;position:relative}
.coupon-item.active{border-color:var(--green)}
.coupon-val{font-size:22px;font-weight:800;color:var(--blue);min-width:56px;text-align:center;align-self:center}
.coupon-info{flex:1}
.coupon-name{font-size:13px;font-weight:700;margin-bottom:3px}
.coupon-code{font-family:monospace;font-weight:800;background:#f1f5f9;padding:3px 8px;border-radius:5px;font-size:12px;letter-spacing:1px;cursor:pointer}
.coupon-exp{font-size:10px;color:var(--muted);margin-top:4px}

/* HISTORIQUE */
.hist-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #f1f5f9}
.hist-item:last-child{border-bottom:none}
.hist-ico{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.hist-date{font-size:10px;color:var(--muted);margin-top:1px}
.hist-pts{font-size:13px;font-weight:800;margin-left:auto}
.hist-pts.plus{color:var(--green)}
.hist-pts.minus{color:var(--red)}

/* BOTTOM BAR */
.bottom-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--border);padding:12px 16px;display:flex;gap:10px;z-index:50;box-shadow:0 -4px 20px rgba(0,0,0,.06)}
.bottom-bar-btn{flex:1;padding:11px;border:none;border-radius:10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:.15s}
.bb-primary{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;box-shadow:0 4px 12px rgba(26,61,206,.2)}
.bb-secondary{background:#f1f5f9;color:var(--text)}

/* LOGIN */
.login-screen{min-height:100vh;background:linear-gradient(135deg,#0f1f5c,#1a3dce);display:flex;align-items:center;justify-content:center;padding:20px}
.login-card{background:#fff;border-radius:20px;padding:28px;width:min(380px,100%);box-shadow:0 20px 60px rgba(0,0,0,.3)}
.login-logo{text-align:center;margin-bottom:20px}
.login-logo-ico{font-size:36px;margin-bottom:8px}
.login-logo-title{font-size:20px;font-weight:800;color:var(--text)}
.login-logo-sub{font-size:12px;color:var(--muted);margin-top:3px}
.field{display:flex;flex-direction:column;gap:5px;margin-bottom:12px}
.field label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.field-wrap{display:flex;align-items:center;gap:8px;padding:11px 14px;border:2px solid var(--border);border-radius:12px;transition:.15s}
.field-wrap:focus-within{border-color:var(--blue2);box-shadow:0 0 0 3px rgba(79,126,248,.1)}
.field-in{flex:1;border:none;outline:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:600;color:var(--text)}
.login-btn{width:100%;padding:13px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;cursor:pointer;margin-top:6px;box-shadow:0 4px 14px rgba(26,61,206,.3)}
.login-note{text-align:center;font-size:11px;color:var(--muted);margin-top:12px}

/* TOAST */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(40px);padding:10px 20px;background:#1a1f36;color:#fff;border-radius:20px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:.3s;white-space:nowrap}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}

.hidden{display:none}
.pb-safe{padding-bottom:calc(80px + env(safe-area-inset-bottom))}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" class="login-screen">
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-ico">üíé</div>
      <div class="login-logo-title">Carte Fid√©lit√©</div>
      <div class="login-logo-sub">Connectez-vous pour acc√©der √† votre carte</div>
    </div>
    <div class="field"><label>T√©l√©phone ou Email</label>
      <div class="field-wrap"><input class="field-in" id="login-id" placeholder="06 12 34 56 78" type="text"/></div>
    </div>
    <div class="field"><label>Nom de famille</label>
      <div class="field-wrap"><input class="field-in" id="login-nom" placeholder="Martin" type="text"/></div>
    </div>
    <button class="login-btn" onclick="doLogin()">‚Üí Voir ma carte</button>
    <div class="login-note">Entrez les infos donn√©es lors de votre inscription<br/>Pas encore inscrit ? Demandez √† la caisse üôÇ</div>
  </div>
</div>

<!-- CLIENT VIEW -->
<div id="clientView" class="hidden pb-safe">

  <!-- HERO -->
  <div class="hero">
    <div class="hero-logo">üíé ALTIORA FID√âLIT√â</div>
    <div class="hero-avatar" id="clientAvatar">M</div>
    <div class="hero-name" id="clientName">Marie Martin</div>
    <div class="hero-sub" id="clientSeg">‚úÖ Client(e) actif(ve)</div>
    <div class="hero-pts">‚≠ê <span id="clientPts">0</span> points</div>
  </div>

  <!-- CARTE -->
  <div class="card-wrap">
    <div class="fid-card" id="fidCard">
      <div class="fid-card-header">
        <div>
          <div class="fid-card-title">CARTE FID√âLIT√â</div>
          <div class="fid-card-shop" id="fidShopName">Ma Boutique</div>
        </div>
        <div class="fid-card-pts">
          <div class="fid-card-pts-val" id="fidPts">0</div>
          <div class="fid-card-pts-lbl">points</div>
        </div>
      </div>
      <div class="tampons-grid" id="tamponsGrid"></div>
      <div class="fid-progress">
        <div class="fid-progress-bar"><div class="fid-progress-fill" id="fidProgressFill" style="width:0%"></div></div>
        <div class="fid-progress-label">
          <span id="fidProgressLeft">0 tampons</span>
          <span id="fidProgressRight">‚Üí 1 produit offert</span>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- POINTS -->
    <div class="section-title">‚≠ê Mes points</div>
    <div class="pts-section">
      <div class="pts-level">
        <div class="pts-current" id="ptsCurrent">0 pts</div>
        <div class="pts-next" id="ptsNext">‚Äî</div>
      </div>
      <div class="pts-bar"><div class="pts-fill" id="ptsFill" style="width:0%"></div></div>
      <div class="pts-milestones" id="ptsMilestones"></div>
    </div>

    <!-- PALIERS -->
    <div class="section-title">üèÜ R√©compenses disponibles</div>
    <div id="paliersClient"></div>

    <!-- COUPONS -->
    <div class="section-title">üé´ Mes coupons</div>
    <div id="couponsClient">
      <div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">Aucun coupon actif</div>
    </div>

    <!-- HISTORIQUE -->
    <div class="section-title">üìã Historique des visites</div>
    <div class="card">
      <div class="card-body" id="histClient">
        <div style="text-align:center;color:var(--muted);font-size:12px">Aucune visite enregistr√©e</div>
      </div>
    </div>

    <!-- INFO -->
    <div style="text-align:center;padding:12px;font-size:11px;color:var(--muted)">
      Powered by <strong>ALTIORA</strong> ¬∑ Programme de fid√©lit√©
    </div>

  </div>

  <!-- BOTTOM BAR -->
  <div class="bottom-bar">
    <button class="bottom-bar-btn bb-secondary" onclick="copyCarte()">üìã Mon code</button>
    <button class="bottom-bar-btn bb-primary" onclick="showQR()">üì± QR Code</button>
  </div>

</div>

<!-- QR MODAL -->
<div id="qrModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;align-items:center;justify-content:center" onclick="closeQR()">
  <div style="background:#fff;border-radius:20px;padding:28px;text-align:center;width:min(300px,90vw)" onclick="event.stopPropagation()">
    <div style="font-size:16px;font-weight:800;margin-bottom:16px">üì± Mon QR Code</div>
    <div id="qrCode" style="width:200px;height:200px;background:#f1f5f9;border-radius:12px;margin:0 auto 14px;display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--muted)">
      <!-- QR simul√© -->
      <div style="display:grid;grid-template-columns:repeat(8,1fr);gap:3px;padding:10px">
        <div id="qrGrid"></div>
      </div>
    </div>
    <div id="qrClientCode" style="font-family:monospace;font-size:18px;font-weight:800;letter-spacing:3px;margin-bottom:14px;color:var(--blue)"></div>
    <div style="font-size:11px;color:var(--muted);margin-bottom:14px">Pr√©sentez ce QR code en caisse</div>
    <button style="width:100%;padding:11px;border:none;border-radius:10px;background:var(--blue);color:#fff;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer" onclick="closeQR()">Fermer</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let currentClient=null;
let cfg={}, clients=[], paliers=[], coupons=[];

function loadData(){
  try{cfg=JSON.parse(localStorage.getItem('altiora_fid_cfg')||'{}')}catch(e){cfg={}}
  try{clients=JSON.parse(localStorage.getItem('altiora_fid_clients')||'[]')}catch(e){clients=[]}
  try{paliers=JSON.parse(localStorage.getItem('altiora_fid_paliers')||'[]')}catch(e){paliers=[]}
  try{coupons=JSON.parse(localStorage.getItem('altiora_fid_coupons')||'[]')}catch(e){coupons=[]}
}

function toast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

function fi(n){return Math.round(parseFloat(n)||0).toLocaleString('fr-FR')}

const COLORS={blue:'linear-gradient(135deg,#0f1f5c,#1a3dce,#4f7ef8)',green:'linear-gradient(135deg,#065f46,#10b981)',orange:'linear-gradient(135deg,#92400e,#f59e0b)',purple:'linear-gradient(135deg,#5b21b6,#6366f1)',pink:'linear-gradient(135deg,#831843,#ec4899)'};

function getSeg(c){
  const pts=c.points||0;
  const days=c.lastVisit?Math.floor((Date.now()-new Date(c.lastVisit))/(86400000)):999;
  const age=Math.floor((Date.now()-new Date(c.createdAt||'2025-01-01'))/(86400000));
  if(pts>=(parseInt(cfg.vipPts)||2000))return'vip';
  if(age<30)return'nouveau';
  if(days>60)return'inactif';
  return'actif';
}
const SEG_LABELS={vip:'üëë Client VIP',actif:'‚úÖ Client(e) actif(ve)',inactif:'üò¥ Client inactif',nouveau:'üå± Nouveau client'};

function doLogin(){
  const id=document.getElementById('login-id').value.trim().toLowerCase();
  const nom=document.getElementById('login-nom').value.trim().toLowerCase();
  loadData();
  
  // Chercher par tel ou email + nom
  const found=clients.find(c=>{
    const matchId=(c.tel||'').replace(/\s/g,'').toLowerCase().includes(id.replace(/\s/g,''))||(c.email||'').toLowerCase()===id;
    const matchNom=c.nom.toLowerCase().includes(nom);
    return matchId&&matchNom;
  });

  // Mode d√©mo ‚Äî si aucun client, utiliser le premier disponible
  const client=found||clients[0];
  
  if(!client){
    // Cr√©er un client d√©mo
    toast('Aucun compte trouv√© ‚Äî mode d√©mo activ√©');
    currentClient={id:'demo',prenom:'D√©mo',nom:'Client',points:350,tampons:6,lastVisit:new Date().toISOString().slice(0,10),createdAt:'2025-01-01',history:[
      {date:'2026-02-01',type:'tampon',montant:25,pts:250},
      {date:'2026-01-15',type:'tampon',montant:18,pts:180},
      {date:'2025-12-20',type:'tampon',montant:32,pts:320},
    ]};
  } else {
    currentClient=client;
  }

  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('clientView').classList.remove('hidden');
  renderClientView();
}

function renderClientView(){
  const c=currentClient;
  const seg=getSeg(c);
  const cfgT=parseInt(cfg.tampons)||10;
  const shopName=cfg.shopName||'Ma Boutique';
  const emoji=cfg.emoji||'‚òï';
  const color=cfg.cardColor||'blue';
  const vipPts=parseInt(cfg.vipPts)||2000;

  // Hero
  document.getElementById('clientAvatar').textContent=(c.prenom[0]||'?')+(c.nom[0]||'');
  document.getElementById('clientName').textContent=`${c.prenom} ${c.nom}`;
  document.getElementById('clientSeg').textContent=SEG_LABELS[seg]||'Client';
  document.getElementById('clientPts').textContent=fi(c.points||0);

  // Carte
  document.getElementById('fidCard').style.background=COLORS[color];
  document.getElementById('fidShopName').textContent=shopName;
  document.getElementById('fidPts').textContent=fi(c.points||0);

  // Tampons
  const t=c.tampons||0;
  const pct=Math.round(t/cfgT*100);
  document.getElementById('tamponsGrid').innerHTML=Array.from({length:cfgT},(_,i)=>`
    <div class="tampon ${i<t?(i===cfgT-1&&t>=cfgT?'reward':'done'):''}">${i<t?emoji:'‚óã'}</div>`).join('');
  document.getElementById('fidProgressFill').style.width=pct+'%';
  document.getElementById('fidProgressLeft').textContent=`${t}/${cfgT} tampons`;
  document.getElementById('fidProgressRight').textContent=`‚Üí ${cfg.reward||'1 produit offert'}`;

  // Points bar
  const nextPalier=[...paliers].sort((a,b)=>a.pts-b.pts).find(p=>p.pts>(c.points||0));
  const prevPalier=[...paliers].sort((a,b)=>b.pts-a.pts).find(p=>p.pts<=(c.points||0));
  const ptsFrom=prevPalier?.pts||0;
  const ptsTo=nextPalier?.pts||vipPts;
  const ptsPct=Math.min(100,Math.round(((c.points||0)-ptsFrom)/(ptsTo-ptsFrom)*100));
  document.getElementById('ptsCurrent').textContent=fi(c.points||0)+' pts';
  document.getElementById('ptsNext').innerHTML=nextPalier?`Prochain palier :<br><strong>${nextPalier.icon} ${nextPalier.reward}</strong><br>dans ${fi(nextPalier.pts-(c.points||0))} pts`:'üéâ Tous les paliers d√©bloqu√©s !';
  document.getElementById('ptsFill').style.width=ptsPct+'%';
  document.getElementById('ptsMilestones').innerHTML=[...paliers].sort((a,b)=>a.pts-b.pts).slice(0,4).map(p=>`<span>${fi(p.pts)}</span>`).join('');

  // Paliers
  const sortedPaliers=[...paliers].sort((a,b)=>a.pts-b.pts);
  document.getElementById('paliersClient').innerHTML=sortedPaliers.length
    ?sortedPaliers.map(p=>{
      const unlocked=(c.points||0)>=p.pts;
      const isNext=!unlocked&&(!sortedPaliers.find(x=>x.pts>(c.points||0)&&x.pts<p.pts));
      return`<div class="palier-item ${unlocked?'unlocked':''} ${isNext?'current':''}">
        <div class="palier-ico">${p.icon}</div>
        <div class="palier-info">
          <div class="palier-name">${p.reward}</div>
          <div class="palier-pts-needed">${fi(p.pts)} points requis ¬∑ ${unlocked?'‚úÖ D√©bloqu√© !':fi(p.pts-(c.points||0))+' pts manquants'}</div>
        </div>
        <div class="palier-status ${unlocked?'done':'next'}">${unlocked?'Disponible ‚Üí':isNext?'Prochain ‚Üí':''}</div>
      </div>`;
    }).join('')
    :'<div style="text-align:center;padding:16px;color:var(--muted);font-size:12px">Aucun palier configur√©</div>';

  // Coupons du client
  const clientCoupons=coupons.filter(co=>co.status==='active'&&(co.target==='all'||(co.target==='vip'&&seg==='vip')||(co.target==='one'&&co.targetName===`${c.prenom} ${c.nom}`)));
  const coEl=document.getElementById('couponsClient');
  coEl.innerHTML=clientCoupons.length
    ?clientCoupons.map(co=>{
      const typeLabel={pct:`-${co.val}%`,eur:`-${co.val}‚Ç¨`,free:'Gratuit'}[co.type]||co.val;
      return`<div class="coupon-item active">
        <div class="coupon-val">${typeLabel}</div>
        <div class="coupon-info">
          <div class="coupon-name">${co.name}</div>
          <div>Code : <span class="coupon-code" onclick="copyCode('${co.code}')">${co.code}</span></div>
          <div class="coupon-exp">${co.expDate?'Exp: '+new Date(co.expDate).toLocaleDateString('fr-FR'):'Sans expiration'} ¬∑ Tap sur le code pour copier</div>
        </div>
      </div>`;
    }).join('')
    :'<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">Aucun coupon actif pour le moment</div>';

  // Historique
  const hist=(c.history||[]).slice(0,8);
  const histEl=document.getElementById('histClient');
  histEl.innerHTML=hist.length
    ?hist.map(h=>`<div class="hist-item">
      <div class="hist-ico" style="background:${h.type==='tampon'?'#eff6ff':'#f0fdf4'}">${h.type==='tampon'?'‚úÖ':'‚≠ê'}</div>
      <div>
        <div style="font-size:12px;font-weight:700">${h.type==='tampon'?'Achat valid√©':'Points ajout√©s'}</div>
        <div class="hist-date">${new Date(h.date).toLocaleDateString('fr-FR')}${h.montant?` ¬∑ ${h.montant}‚Ç¨`:''}</div>
      </div>
      <div class="hist-pts plus">+${h.pts||1} ${h.pts?'pts':'tampon'}</div>
    </div>`).join('')
    :'<div style="text-align:center;color:var(--muted);font-size:12px">Aucune visite enregistr√©e</div>';
}

function copyCode(code){
  navigator.clipboard?.writeText(code).catch(()=>{});
  toast(`Code ${code} copi√© !`);
}

function copyCarte(){
  const code=currentClient?.id?.slice(0,6).toUpperCase()||'DEMO01';
  navigator.clipboard?.writeText(code).catch(()=>{});
  toast(`Code ${code} copi√© !`);
}

function showQR(){
  const code=(currentClient?.id||'demo').slice(0,6).toUpperCase();
  document.getElementById('qrClientCode').textContent=code;
  // Simuler QR en grille pixels
  const grid=document.getElementById('qrGrid');
  grid.style.display='grid';
  grid.style.gridTemplateColumns='repeat(10,1fr)';
  grid.style.gap='2px';
  grid.style.width='160px';
  grid.style.height='160px';
  let html='';
  for(let i=0;i<100;i++){
    const on=Math.random()>.45||(i<20&&i%3===0)||(i>80&&i%2===0);
    html+=`<div style="background:${on?'#0f1f5c':'transparent'};border-radius:1px"></div>`;
  }
  grid.innerHTML=html;
  document.getElementById('qrModal').style.display='flex';
}
function closeQR(){document.getElementById('qrModal').style.display='none'}

// Check URL params pour auto-login
window.addEventListener('DOMContentLoaded',()=>{
  loadData();
  const params=new URLSearchParams(location.search);
  const clientId=params.get('client');
  if(clientId){
    const c=clients.find(x=>x.id===clientId);
    if(c){currentClient=c;document.getElementById('loginScreen').classList.add('hidden');document.getElementById('clientView').classList.remove('hidden');renderClientView()}
  }
});
</script>
</body>
</html>
