<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>Ma Carte FidÃ©litÃ©</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--blue:#1a3dce;--blue2:#4f7ef8;--bg:#f4f6fb;--green:#10b981;--orange:#f59e0b;--text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--radius:16px}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:13px}

.loading-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0f1f5c,#1a3dce);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;transition:opacity .4s}
.loading-screen.hide{opacity:0;pointer-events:none}
.loading-logo{font-size:48px;margin-bottom:16px}
.loading-title{font-size:20px;font-weight:800;color:#fff;margin-bottom:6px}
.loading-sub{font-size:12px;color:rgba(255,255,255,.5);margin-bottom:28px}
.loading-spinner{width:36px;height:36px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
.loading-status{font-size:11px;color:rgba(255,255,255,.4);margin-top:14px}
@keyframes spin{to{transform:rotate(360deg)}}

.error-screen{min-height:100vh;background:linear-gradient(135deg,#0f1f5c,#1a3dce);display:flex;align-items:center;justify-content:center;padding:20px}
.error-card{background:#fff;border-radius:20px;padding:32px 24px;width:min(400px,100%);text-align:center}
.error-ico{font-size:44px;margin-bottom:14px}
.error-title{font-size:18px;font-weight:800;margin-bottom:8px}
.error-sub{font-size:12px;color:var(--muted);line-height:1.7}
.error-debug{margin-top:12px;padding:10px;background:#f8faff;border-radius:8px;font-size:10px;font-family:monospace;color:#666;text-align:left;word-break:break-all}

.hero{background:linear-gradient(135deg,#0f1f5c,#1a3dce,#4f7ef8);padding:28px 20px 70px;text-align:center;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;right:-60px;top:-60px;width:220px;height:220px;border-radius:50%;background:rgba(255,255,255,.05)}
.hero-logo{font-size:11px;font-weight:700;color:rgba(255,255,255,.4);letter-spacing:2px;text-transform:uppercase;margin-bottom:20px}
.hero-avatar{width:70px;height:70px;border-radius:50%;border:3px solid rgba(255,255,255,.35);display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:800;color:#fff;margin:0 auto 12px;background:rgba(255,255,255,.15)}
.hero-name{font-size:22px;font-weight:800;color:#fff;margin-bottom:4px}
.hero-seg{font-size:12px;color:rgba(255,255,255,.55);margin-bottom:16px}
.hero-pts{display:inline-flex;align-items:center;gap:6px;padding:8px 20px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);border-radius:30px;color:#fff;font-size:14px;font-weight:700}

.card-wrap{padding:0 16px;margin-top:-52px;position:relative;z-index:10}
.fid-card{border-radius:20px;padding:22px;color:#fff;min-height:170px;position:relative;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25)}
.fid-card::before{content:'';position:absolute;right:-40px;top:-40px;width:180px;height:180px;border-radius:50%;background:rgba(255,255,255,.07)}
.card-blue{background:linear-gradient(135deg,#0f1f5c,#1a3dce,#4f7ef8)}
.card-green{background:linear-gradient(135deg,#065f46,#059669,#10b981)}
.card-orange{background:linear-gradient(135deg,#92400e,#d97706,#f59e0b)}
.card-purple{background:linear-gradient(135deg,#4c1d95,#5b21b6,#6366f1)}
.card-pink{background:linear-gradient(135deg,#831843,#be185d,#ec4899)}
.fid-card-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px}
.fid-card-label{font-size:10px;font-weight:700;opacity:.5;text-transform:uppercase;letter-spacing:1px}
.fid-card-shop{font-size:16px;font-weight:800;margin-top:3px}
.fid-pts-val{font-size:20px;font-weight:800;text-align:right}
.fid-pts-lbl{font-size:10px;opacity:.5;text-align:right}
.tampons-row{display:flex;gap:7px;flex-wrap:wrap}
.t{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:16px;background:rgba(255,255,255,.07)}
.t.done{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.65)}
.t.reward{background:linear-gradient(135deg,#f59e0b,#fbbf24);border-color:#fbbf24;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(251,191,36,.4)}50%{box-shadow:0 0 0 8px rgba(251,191,36,0)}}
.fid-bar-bg{background:rgba(255,255,255,.2);border-radius:99px;height:5px;overflow:hidden;margin-top:14px}
.fid-bar-fill{height:100%;border-radius:99px;background:rgba(255,255,255,.8);transition:width 1.2s ease}
.fid-bar-labels{display:flex;justify-content:space-between;margin-top:5px;font-size:10px;opacity:.55}

.content{padding:18px 16px 100px;display:flex;flex-direction:column;gap:14px}
.sec-title{font-size:14px;font-weight:800;display:flex;align-items:center;gap:7px}
.box{background:#fff;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}

.pts-section{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:18px}
.pts-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.pts-big{font-size:30px;font-weight:800;color:var(--blue);line-height:1}
.pts-sub{font-size:11px;color:var(--muted);margin-top:4px}
.pts-next{font-size:11px;color:var(--muted);text-align:right;line-height:1.6;max-width:160px}
.pts-bar-bg{background:#f1f5f9;border-radius:99px;height:10px;overflow:hidden;margin-bottom:6px}
.pts-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--blue),var(--blue2));transition:width 1.4s ease}
.pts-milestones{display:flex;justify-content:space-between;font-size:10px;color:var(--muted)}

.palier-item{display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:1px solid #f1f5f9}
.palier-item:last-child{border-bottom:none}
.palier-ico{font-size:24px;width:38px;text-align:center;flex-shrink:0}
.palier-name{font-size:13px;font-weight:700}
.palier-need{font-size:11px;color:var(--muted);margin-top:2px}
.badge-ok{font-size:11px;font-weight:700;color:var(--green);white-space:nowrap}
.badge-next{font-size:11px;font-weight:700;color:var(--orange);white-space:nowrap}

.coupon-item{display:flex;gap:12px;padding:14px 16px;border-bottom:1px solid #f1f5f9}
.coupon-item:last-child{border-bottom:none}
.coupon-val{font-size:22px;font-weight:800;color:var(--blue);min-width:52px;text-align:center;align-self:center;flex-shrink:0}
.coupon-name{font-size:13px;font-weight:700}
.coupon-code{font-family:monospace;font-weight:800;background:#eff6ff;padding:3px 9px;border-radius:6px;font-size:12px;letter-spacing:1.5px;cursor:pointer;display:inline-block;margin-top:3px}
.coupon-exp{font-size:10px;color:var(--muted);margin-top:3px}

.hist-item{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid #f1f5f9}
.hist-item:last-child{border-bottom:none}
.hist-ico{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0}
.hist-pts{margin-left:auto;font-size:13px;font-weight:800;color:var(--green)}

.bottom-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--border);padding:12px 16px calc(12px + env(safe-area-inset-bottom));display:flex;gap:10px;z-index:50;box-shadow:0 -4px 20px rgba(0,0,0,.06)}
.bb-btn{flex:1;padding:13px;border:none;border-radius:12px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer}
.bb-primary{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff}
.bb-secondary{background:#f1f5f9;color:var(--text)}

.qr-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;display:none;align-items:flex-end;justify-content:center}
.qr-overlay.show{display:flex}
.qr-sheet{background:#fff;border-radius:24px 24px 0 0;padding:28px 24px 40px;width:100%;max-width:480px;text-align:center;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.qr-handle{width:40px;height:4px;background:#e2e8f0;border-radius:99px;margin:0 auto 20px}
.qr-code-text{font-family:monospace;font-size:24px;font-weight:800;letter-spacing:4px;color:var(--blue);margin:14px 0 6px}
.qr-hint{font-size:11px;color:var(--muted);margin-bottom:20px}
.qr-close{width:100%;padding:13px;border:none;border-radius:12px;background:#f1f5f9;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer}

.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(16px);padding:10px 20px;background:#1a1f36;color:#fff;border-radius:20px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:.3s;white-space:nowrap;pointer-events:none}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}
.hidden{display:none!important}

  /* â”€â”€ ONGLETS NAVIGATION â”€â”€ */
  .tab-bar{display:flex;background:#fff;border-bottom:2px solid var(--border);position:sticky;top:0;z-index:40}
  .tab-btn{flex:1;padding:13px 8px;font-size:12px;font-weight:700;color:var(--muted);background:none;border:none;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:.2s;font-family:inherit}
  .tab-btn.active{color:var(--blue);border-bottom-color:var(--blue)}
  .tab-panel{display:none}.tab-panel.active{display:block}

  /* â”€â”€ PROFIL CLIENT â”€â”€ */
  .profile-card{background:#fff;border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:14px}
  .profile-avatar-wrap{position:relative;width:80px;height:80px;margin:0 auto 16px}
  .profile-avatar{width:80px;height:80px;border-radius:50%;object-fit:cover;font-size:28px;font-weight:800;color:#fff;display:flex;align-items:center;justify-content:center;border:3px solid var(--blue)}
  .avatar-edit-btn{position:absolute;bottom:0;right:0;width:26px;height:26px;border-radius:50%;background:var(--blue);border:2px solid #fff;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px}
  .profile-field{margin-bottom:14px}
  .profile-field label{display:block;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
  .profile-input{width:100%;padding:10px 13px;border:1.5px solid var(--border);border-radius:10px;font-size:14px;font-family:inherit;background:#fafbff;transition:.2s}
  .profile-input:focus{outline:none;border-color:var(--blue);background:#fff}
  .profile-input:disabled{background:#f8f9fd;color:var(--muted)}
  .profile-save-btn{width:100%;padding:13px;background:var(--blue);color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;transition:.2s;margin-top:6px}
  .profile-save-btn:hover{background:#3d6ef0}
  .profile-save-btn:active{transform:scale(.98)}
  .notif-row{display:flex;align-items:center;justify-content:space-between;padding:13px 0;border-bottom:1px solid var(--border)}
  .notif-row:last-child{border-bottom:none}
  .notif-label{font-size:13px;font-weight:600}
  .notif-sub{font-size:11px;color:var(--muted);margin-top:2px}
  .toggle-sw{position:relative;width:44px;height:24px;flex-shrink:0}
  .toggle-sw input{opacity:0;width:0;height:0}
  .toggle-track{position:absolute;inset:0;background:#e2e8f0;border-radius:12px;cursor:pointer;transition:.25s}
  .toggle-track:before{content:'';position:absolute;width:18px;height:18px;left:3px;top:3px;background:#fff;border-radius:50%;transition:.25s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
  .toggle-sw input:checked+.toggle-track{background:var(--blue)}
  .toggle-sw input:checked+.toggle-track:before{transform:translateX(20px)}

  /* â”€â”€ PHOTO OVERLAY â”€â”€ */
  .photo-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;align-items:center;justify-content:center}
  .photo-overlay.show{display:flex}
  .photo-sheet{background:#fff;border-radius:20px;padding:24px;width:90%;max-width:340px;text-align:center}
  .photo-title{font-size:15px;font-weight:800;margin-bottom:16px}
  .photo-preview{width:100px;height:100px;border-radius:50%;margin:0 auto 16px;object-fit:cover;display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:800;color:#fff;border:3px solid var(--blue)}
  .photo-options{display:grid;gap:10px;margin-bottom:14px}
  .photo-option-btn{padding:12px;border:1.5px solid var(--border);border-radius:12px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;background:#fff;transition:.15s}
  .photo-option-btn:hover{border-color:var(--blue);color:var(--blue)}
  .emoji-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:14px}
  .emoji-opt{width:48px;height:48px;border-radius:12px;border:2px solid var(--border);font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.15s;background:#fafbff}
  .emoji-opt:hover,.emoji-opt.selected{border-color:var(--blue);background:#eff6ff}
</style>
</head>
<body>

<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">ğŸ’</div>
  <div class="loading-title">Carte FidÃ©litÃ©</div>
  <div class="loading-sub">Chargement en cours...</div>
  <div class="loading-spinner"></div>
  <div class="loading-status" id="loadingStatus">Connexion...</div>
</div>

<div class="error-screen hidden" id="errorScreen">
  <div class="error-card">
    <div class="error-ico">âŒ</div>
    <div class="error-title">Lien invalide</div>
    <div class="error-sub" id="errorSub">Ce lien n'existe pas ou a expirÃ©.<br/>Demandez un nouveau lien Ã  votre commerÃ§ant.</div>
    <div class="error-debug hidden" id="errorDebug"></div>
  </div>
</div>

<div class="hidden" id="mainView">
  <div class="hero">
    <div class="hero-logo">ğŸ’ FIDÃ‰LITÃ‰</div>
    <div class="hero-avatar" id="hAvatar">?</div>
    <div class="hero-name" id="hName">â€”</div>
    <div class="hero-seg" id="hSeg"></div>
    <div class="hero-pts">â­ <span id="hPts">0</span> points</div>
  </div>

  <div class="card-wrap">
    <div class="fid-card card-blue" id="fidCard">
      <div class="fid-card-row">
        <div>
          <div class="fid-card-label">CARTE FIDÃ‰LITÃ‰</div>
          <div class="fid-card-shop" id="cShop">Ma Boutique</div>
        </div>
        <div>
          <div class="fid-pts-val" id="cPts">0</div>
          <div class="fid-pts-lbl">points</div>
        </div>
      </div>
      <div class="tampons-row" id="cTampons"></div>
      <div class="fid-bar-bg"><div class="fid-bar-fill" id="cBarFill" style="width:0%"></div></div>
      <div class="fid-bar-labels">
        <span id="cBarLeft">0 tampons</span>
        <span id="cBarRight">rÃ©compense</span>
      </div>
    </div>
  </div>

  <!-- Navigation onglets -->
  <div class="tab-bar">
    <button class="tab-btn active" onclick="switchTab('carte',this)">ğŸ´ Ma carte</button>
    <button class="tab-btn" onclick="switchTab('coupons-tab',this)">ğŸ« Coupons</button>
    <button class="tab-btn" onclick="switchTab('compte',this)">ğŸ‘¤ Mon compte</button>
  </div>

  <!-- Onglet CARTE -->
  <div class="tab-panel active" id="tab-carte">
  <div class="content">
    <div class="sec-title">â­ Mes points</div>
    <div class="pts-section">
      <div class="pts-top">
        <div>
          <div class="pts-big" id="ptsBig">0</div>
          <div class="pts-sub">points disponibles</div>
        </div>
        <div class="pts-next" id="ptsNext"></div>
      </div>
      <div class="pts-bar-bg"><div class="pts-bar-fill" id="ptsFill" style="width:0%"></div></div>
      <div class="pts-milestones" id="ptsMilestones"></div>
    </div>

    <div class="sec-title">ğŸ† RÃ©compenses</div>
    <div class="box"><div id="paliersEl"></div></div>

    <div class="sec-title hidden" id="couponTitle">ğŸ« Mes coupons</div>
    <div class="box hidden" id="couponBox"><div id="couponsEl"></div></div>

    <div class="sec-title">ğŸ“‹ Historique</div>
    <div class="box"><div id="histEl"></div></div>

    <div style="text-align:center;padding:8px;font-size:10px;color:var(--muted)">PropulsÃ© par <strong>ALTIORA</strong></div>
  </div>
  </div><!-- fin tab-carte -->

  <!-- Onglet COUPONS -->
  <div class="tab-panel" id="tab-coupons-tab">
    <div class="content" style="padding-top:16px">
      <div id="couponsTabEl"></div>
    </div>
  </div>

  <!-- Onglet MON COMPTE -->
  <div class="tab-panel" id="tab-compte">
    <div class="content" style="padding-top:16px">

      <!-- Avatar -->
      <div class="profile-card" style="text-align:center">
        <div class="profile-avatar-wrap">
          <div class="profile-avatar" id="profileAvatar" style="background:#4f7ef8">?</div>
          <div class="avatar-edit-btn" onclick="openPhotoModal()">âœï¸</div>
        </div>
        <div style="font-size:15px;font-weight:800" id="profileName">â€”</div>
        <div style="font-size:12px;color:var(--muted);margin-top:4px" id="profileSeg"></div>
      </div>

      <!-- Infos personnelles -->
      <div class="profile-card">
        <div style="font-size:13px;font-weight:800;margin-bottom:14px">ğŸ‘¤ Informations personnelles</div>
        <div class="profile-field">
          <label>PrÃ©nom</label>
          <input class="profile-input" id="edit-prenom" placeholder="Votre prÃ©nom"/>
        </div>
        <div class="profile-field">
          <label>Nom</label>
          <input class="profile-input" id="edit-nom" placeholder="Votre nom"/>
        </div>
        <div class="profile-field">
          <label>Email</label>
          <input class="profile-input" id="edit-email" type="email" placeholder="votre@email.com"/>
        </div>
        <div class="profile-field">
          <label>TÃ©lÃ©phone</label>
          <input class="profile-input" id="edit-tel" type="tel" placeholder="+33 6 00 00 00 00"/>
        </div>
        <div class="profile-field">
          <label>Date de naissance</label>
          <input class="profile-input" id="edit-birthday" type="date"/>
        </div>
        <button class="profile-save-btn" id="profileSaveBtn" onclick="saveProfile()">ğŸ’¾ Enregistrer mes infos</button>
      </div>

      <!-- PrÃ©fÃ©rences notifications -->
      <div class="profile-card">
        <div style="font-size:13px;font-weight:800;margin-bottom:4px">ğŸ”” Notifications</div>
        <div class="notif-row">
          <div>
            <div class="notif-label">Offres & coupons</div>
            <div class="notif-sub">Recevoir les promotions de la boutique</div>
          </div>
          <label class="toggle-sw"><input type="checkbox" id="notif-offres" checked/><span class="toggle-track"></span></label>
        </div>
        <div class="notif-row">
          <div>
            <div class="notif-label">Rappel tampons</div>
            <div class="notif-sub">Quand votre carte est presque pleine</div>
          </div>
          <label class="toggle-sw"><input type="checkbox" id="notif-tampons" checked/><span class="toggle-track"></span></label>
        </div>
        <div class="notif-row">
          <div>
            <div class="notif-label">Anniversaire</div>
            <div class="notif-sub">Offre spÃ©ciale le jour J</div>
          </div>
          <label class="toggle-sw"><input type="checkbox" id="notif-birthday" checked/><span class="toggle-track"></span></label>
        </div>
      </div>

      <div style="text-align:center;padding:8px;font-size:10px;color:var(--muted)">PropulsÃ© par <strong>ALTIORA</strong></div>
    </div>
  </div>

  <div class="bottom-bar">
    <button class="bb-btn bb-secondary" onclick="copyCode()">ğŸ“‹ Mon code</button>
    <button class="bb-btn bb-primary" onclick="showQR()">ğŸ“± QR Code caisse</button>
  </div>

<!-- Modal photo/avatar -->
<div class="photo-overlay" id="photoOverlay">
  <div class="photo-sheet">
    <div class="photo-title">ğŸ“¸ Ma photo de profil</div>
    <div class="photo-preview" id="photoPreview" style="background:#4f7ef8">?</div>
    <div class="photo-options">
      <label class="photo-option-btn" style="cursor:pointer">
        ğŸ“· Prendre une photo
        <input type="file" accept="image/*" capture="user" id="photoCamera" style="display:none" onchange="handlePhotoUpload(this)"/>
      </label>
      <label class="photo-option-btn" style="cursor:pointer">
        ğŸ–¼ï¸ Choisir depuis la galerie
        <input type="file" accept="image/*" id="photoGallery" style="display:none" onchange="handlePhotoUpload(this)"/>
      </label>
    </div>
    <div style="font-size:12px;font-weight:700;color:var(--muted);margin-bottom:8px">â€” ou choisir un avatar â€”</div>
    <div class="emoji-grid" id="emojiGrid"></div>
    <button class="photo-option-btn" style="width:100%;background:#fef2f2;color:#ef4444;border-color:#fecaca" onclick="closePhotoModal()">Annuler</button>
  </div>
</div>
</div>

<div class="qr-overlay" id="qrOverlay" onclick="if(event.target===this)closeQR()">
  <div class="qr-sheet">
    <div class="qr-handle"></div>
    <div style="font-size:16px;font-weight:800;margin-bottom:16px">ğŸ“± Mon QR Code</div>
    <div style="width:180px;height:180px;margin:0 auto;background:#f8faff;border-radius:12px;border:1px solid var(--border);display:flex;align-items:center;justify-content:center">
      <svg id="qrSvg" width="160" height="160" viewBox="0 0 160 160"></svg>
    </div>
    <div class="qr-code-text" id="qrCodeText">â€”â€”</div>
    <div class="qr-hint">PrÃ©sentez ce code Ã  la caisse</div>
    <button class="qr-close" onclick="closeQR()">Fermer</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
  authDomain: "altiora-70599.firebaseapp.com",
  projectId: "altiora-70599",
  storageBucket: "altiora-70599.firebasestorage.app",
  messagingSenderId: "120905555746",
  appId: "1:120905555746:web:618460c65cdc9e57cc8f7b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// â”€â”€ Utilitaires â”€â”€
const $ = id => document.getElementById(id);
const fi = n => Math.round(parseFloat(n)||0).toLocaleString('fr-FR');
const COLORS = {blue:'card-blue',green:'card-green',orange:'card-orange',purple:'card-purple',pink:'card-pink'};
const SEGS = {vip:'ğŸ‘‘ Client VIP',actif:'âœ… Client actif',inactif:'ğŸ˜´ Client inactif',nouveau:'ğŸŒ± Nouveau client'};
const AVATAR_COLORS = ['#4f7ef8','#10b981','#f59e0b','#6366f1','#ec4899','#14b8a6'];

function setStatus(msg){ const s=$('loadingStatus'); if(s) s.textContent=msg; }

function showError(reason, debug){
  $('loadingScreen').classList.add('hide');
  setTimeout(()=>{ $('loadingScreen').style.display='none'; }, 400);
  $('errorScreen').classList.remove('hidden');
  if(reason) $('errorSub').innerHTML = reason;
  if(debug){
    const d = $('errorDebug');
    d.classList.remove('hidden');
    d.textContent = debug;
  }
}

function showMain(){
  $('loadingScreen').classList.add('hide');
  setTimeout(()=>{ $('loadingScreen').style.display='none'; }, 400);
  $('mainView').classList.remove('hidden');
}

function getSeg(c, cfg){
  const pts = c.points||0;
  const days = c.lastVisit ? Math.floor((Date.now()-new Date(c.lastVisit))/86400000) : 999;
  const age = c.createdAt ? Math.floor((Date.now()-new Date(c.createdAt))/86400000) : 999;
  if(pts >= (cfg.vipPts||2000)) return 'vip';
  if(age < 30) return 'nouveau';
  if(days > 60) return 'inactif';
  return 'actif';
}

// â”€â”€ Lire l'ID depuis l'URL (gÃ¨re tous les formats) â”€â”€
function getClientId(){
  // Format normal : ?client=ID
  let id = new URLSearchParams(location.search).get('client');
  if(id) return id;
  // Format avec hash : #something?client=ID
  if(location.hash.includes('client=')){
    const afterHash = location.hash.includes('?') ? location.hash.split('?')[1] : location.hash.slice(1);
    id = new URLSearchParams(afterHash).get('client');
    if(id) return id;
    // Format #client=ID directement
    const m = location.hash.match(/client=([^&]+)/);
    if(m) return m[1];
  }
  return null;
}

const clientId = getClientId();
console.log('clientId extrait:', clientId, '| URL:', location.href);

if(!clientId){
  showError('Aucun identifiant client dans le lien.<br/>Demandez un nouveau lien Ã  votre commerÃ§ant.', 'URL: '+location.href);
} else {
  load(clientId);
}

async function load(id){
  try{
    setStatus('Chargement de votre carte...');
    console.log('Lecture Firestore: fidelite_public /'+id);

    const snap = await getDoc(doc(db, 'fidelite_public', id));
    console.log('RÃ©sultat:', snap.exists() ? 'TROUVÃ‰' : 'INTROUVABLE');

    if(!snap.exists()){
      showError(
        'Carte introuvable.<br/>Demandez Ã  votre commerÃ§ant de resynchroniser.',
        'ID: '+id+' | Collection: fidelite_public'
      );
      return;
    }

    const client = snap.data();
    console.log('Client:', client.prenom, client.nom);

    // Config boutique
    let cfg = {tampons:10, reward:'1 produit offert', emoji:'â˜•', shopName:'Ma Boutique', cardColor:'blue', vipPts:2000, paliers:[]};
    if(client.uid){
      try{
        const cfgSnap = await getDoc(doc(db, 'fidelite_public_cfg', client.uid));
        if(cfgSnap.exists()) cfg = {...cfg, ...cfgSnap.data()};
      }catch(e){ console.warn('Config boutique non trouvÃ©e:', e.message); }
    }

    window._setClientContext(db, id, client);
    try{
      render(client, cfg);
    }catch(renderErr){
      console.error('RENDER ERROR:', renderErr.message, renderErr.stack);
    }
    showMain();

  }catch(e){
    console.error('Erreur Firebase:', e);
    showError(
      'Erreur de connexion Firebase.',
      'Code: '+(e.code||'?')+' | '+( e.message||'').slice(0,80)
    );
  }
}

function render(c, cfg){
  const seg = getSeg(c, cfg);
  const cfgT = parseInt(cfg.tampons)||10;
  const t = c.tampons||0;
  const pts = c.points||0;
  const paliers = (cfg.paliers||[]).sort((a,b)=>a.pts-b.pts);
  const emoji = cfg.emoji||'â˜•';
  const color = COLORS[cfg.cardColor||'blue']||'card-blue';

  // Hero
  const initials = ((c.prenom||'?')[0]+(c.nom||'?')[0]).toUpperCase();
  $('hAvatar').textContent = initials;
  $('hAvatar').style.background = AVATAR_COLORS[(c.prenom||'A').charCodeAt(0) % AVATAR_COLORS.length];
  $('hName').textContent = c.prenom+' '+c.nom;
  $('hSeg').textContent = SEGS[seg]||'';
  $('hPts').textContent = fi(pts);

  // Carte
  $('fidCard').className = 'fid-card '+color;
  $('cShop').textContent = cfg.shopName||'Ma Boutique';
  $('cPts').textContent = fi(pts);
  $('cTampons').innerHTML = Array.from({length:cfgT},(_,i)=>
    `<div class="t ${i<t?'done':''}">${i<t?emoji:'â—‹'}</div>`).join('');
  $('cBarFill').style.width = Math.round(t/cfgT*100)+'%';
  $('cBarLeft').textContent = t+'/'+cfgT+' tampons';
  $('cBarRight').textContent = 'â†’ '+( cfg.reward||'rÃ©compense');

  // Points
  $('ptsBig').textContent = fi(pts);
  const nextP = paliers.find(p=>p.pts>pts);
  const prevP = [...paliers].reverse().find(p=>p.pts<=pts);
  const from = prevP?.pts||0, to = nextP?.pts||(cfg.vipPts||2000);
  $('ptsFill').style.width = Math.min(100,Math.max(0,Math.round((pts-from)/(to-from)*100)))+'%';
  $('ptsNext').innerHTML = nextP
    ? `Prochain :<br><strong>${nextP.icon} ${nextP.reward}</strong><br><span style="color:var(--orange)">${fi(nextP.pts-pts)} pts manquants</span>`
    : 'ğŸ‰ Tous dÃ©bloquÃ©s !';
  $('ptsMilestones').innerHTML = paliers.slice(0,4).map(p=>`<span>${fi(p.pts)}</span>`).join('');

  // Paliers
  $('paliersEl').innerHTML = paliers.length
    ? paliers.map(p=>{
        const ok = pts>=p.pts;
        return `<div class="palier-item" style="${ok?'background:#f0fdf4':''}">
          <div class="palier-ico">${p.icon}</div>
          <div style="flex:1">
            <div class="palier-name">${p.reward}</div>
            <div class="palier-need">${fi(p.pts)} pts${ok?'':' Â· '+fi(p.pts-pts)+' manquants'}</div>
          </div>
          <div class="${ok?'badge-ok':'badge-next'}">${ok?'âœ… Dispo':p===nextP?'Prochain â†’':''}</div>
        </div>`;
      }).join('')
    : '<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px">Aucun palier configurÃ©</div>';

  // Historique
  const hist = (c.history||[]).slice(0,10);
  $('histEl').innerHTML = hist.length
    ? hist.map(h=>`<div class="hist-item">
        <div class="hist-ico" style="background:${h.type==='tampon'?'#eff6ff':'#f0fdf4'}">${h.type==='tampon'?'âœ…':'â­'}</div>
        <div>
          <div style="font-size:12px;font-weight:700">${h.type==='tampon'?'Achat validÃ©':'Points ajoutÃ©s'}</div>
          <div style="font-size:10px;color:var(--muted)">${new Date(h.date).toLocaleDateString('fr-FR')}${h.montant?' Â· '+h.montant+'â‚¬':''}</div>
        </div>
        <div class="hist-pts">+${h.pts||1} ${h.pts?'pts':'â– '}</div>
      </div>`).join('')
    : '<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px">Aucune visite</div>';

  // Coupons â€” badge sur la tab-bar
  var nbCoupons = (c.coupons||[]).filter(function(cp){ return cp.status==='active'; }).length;
  var couponTab = document.querySelector('.tab-btn:nth-child(2)');
  if(couponTab && nbCoupons>0){
    couponTab.innerHTML = 'ğŸ« Coupons <span style="background:#ef4444;color:#fff;border-radius:10px;font-size:10px;padding:1px 6px;margin-left:4px">'+nbCoupons+'</span>';
  }
  // Cacher les anciennes sections (remplacÃ©es par l'onglet dÃ©diÃ©)
  if($('couponTitle')) $('couponTitle').classList.add('hidden');
  if($('couponBox'))   $('couponBox').classList.add('hidden');

  // QR
  const code = id.slice(0,8).toUpperCase();
  $('qrCodeText').textContent = code;
  generateQR(code);
}

// QR Code visuel
function generateQR(text){
  const svg = $('qrSvg');
  const size=9, cell=160/size;
  const corners=new Set([[0,0],[0,1],[0,2],[1,0],[2,0],[2,1],[2,2],[1,2],[6,0],[6,1],[6,2],[7,0],[8,0],[8,1],[8,2],[7,2],[0,6],[0,7],[0,8],[1,6],[2,6],[2,7],[2,8],[1,8]].map(([r,c])=>r+','+c));
  let html='';
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      const ic=corners.has(r+','+c);
      const on=ic||((text.charCodeAt((r*size+c)%text.length)*(r+1)*(c+1))%7>2);
      if(on) html+=`<rect x="${c*cell+1}" y="${r*cell+1}" width="${cell-2}" height="${cell-2}" rx="2" fill="#0f1f5c"/>`;
    }
  }
  svg.innerHTML=html;
}

// â”€â”€ RÃ©cupÃ©rer clientId pour les fonctions globales â”€â”€
const id = clientId;

window.copyCode = function(){
  const code = (id||'').slice(0,8).toUpperCase();
  navigator.clipboard?.writeText(code).catch(()=>{});
  const t=$('toast'); t.textContent='Code '+code+' copiÃ© !'; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
};

window.showQR = function(){ $('qrOverlay').classList.add('show'); };
window.closeQR = function(){ $('qrOverlay').classList.remove('show'); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTION ONGLETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _activeTab = 'carte';

window.switchTab = function(tabId, btn) {
  _activeTab = tabId;
  // Panels
  document.querySelectorAll('.tab-panel').forEach(function(p){ p.classList.remove('active'); });
  var panel = document.getElementById('tab-'+tabId);
  if (panel) panel.classList.add('active');
  // Boutons
  document.querySelectorAll('.tab-btn').forEach(function(b){ b.classList.remove('active'); });
  if (btn) btn.classList.add('active');
  // Charger les coupons dans l'onglet dÃ©diÃ©
  if (tabId === 'coupons-tab') renderCouponsTab();
  // Remplir le profil si premiÃ¨re visite
  if (tabId === 'compte' && _clientData) fillProfileForm(_clientData);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DONNÃ‰ES CLIENT (rÃ©fÃ©rence globale)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _clientData = null;
var _clientId   = null;
var _clientDb   = null;

// AppelÃ© depuis load() aprÃ¨s snap.data()
window._setClientContext = function(db, id, data) {
  _clientDb   = db;
  _clientId   = id;
  _clientData = data;
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ONGLET COUPONS (dÃ©diÃ©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCouponsTab() {
  var el = document.getElementById('couponsTabEl');
  if (!el || !_clientData) return;
  var coupons = (_clientData.coupons || []).filter(function(cp){ return cp.status === 'active'; });
  if (!coupons.length) {
    el.innerHTML = '<div style="text-align:center;padding:48px 20px;color:var(--muted)">'
      + '<div style="font-size:40px;margin-bottom:12px">ğŸ«</div>'
      + '<div style="font-size:14px;font-weight:700">Aucun coupon disponible</div>'
      + '<div style="font-size:12px;margin-top:6px">Vos coupons de rÃ©duction apparaÃ®tront ici</div>'
      + '</div>';
    return;
  }
  el.innerHTML = coupons.map(function(cp) {
    var typeLabel = cp.type==='pct' ? '-'+cp.val+'%' : cp.type==='eur' ? '-'+cp.val+'â‚¬' : 'ğŸ Offert';
    var typeColor = cp.type==='pct' ? '#4f7ef8' : cp.type==='eur' ? '#f97316' : '#10b981';
    var exp = cp.expDate ? 'Expire le '+new Date(cp.expDate).toLocaleDateString('fr-FR') : 'Sans expiration';
    return '<div style="background:#fff;border:2px dashed #e5e8f0;border-radius:14px;padding:18px;margin-bottom:12px;display:flex;gap:14px;align-items:center">'
      + '<div style="background:'+typeColor+';color:#fff;border-radius:12px;padding:12px 10px;font-size:20px;font-weight:900;min-width:72px;text-align:center;line-height:1.2">'+typeLabel+'</div>'
      + '<div style="flex:1">'
        + '<div style="font-size:14px;font-weight:800;margin-bottom:4px">'+cp.name+'</div>'
        + '<div style="font-family:monospace;font-size:13px;font-weight:700;background:#f1f5f9;display:inline-block;padding:3px 10px;border-radius:6px;letter-spacing:1px">'+cp.code+'</div>'
        + '<div style="font-size:11px;color:var(--muted);margin-top:5px">'+exp+'</div>'
      + '</div>'
    + '</div>';
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROFIL : remplir le formulaire
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fillProfileForm(c) {
  var SEGS2 = {vip:'ğŸ‘‘ Client VIP', actif:'âœ… Client actif', inactif:'ğŸ˜´ Client inactif', nouveau:'ğŸŒ± Nouveau client'};
  var prefs = c.prefs || {};

  document.getElementById('edit-prenom').value  = c.prenom  || '';
  document.getElementById('edit-nom').value     = c.nom     || '';
  document.getElementById('edit-email').value   = c.email   || '';
  document.getElementById('edit-tel').value     = c.tel     || '';
  document.getElementById('edit-birthday').value = c.birthday || '';

  document.getElementById('notif-offres').checked   = prefs.notifOffres   !== false;
  document.getElementById('notif-tampons').checked  = prefs.notifTampons  !== false;
  document.getElementById('notif-birthday').checked = prefs.notifBirthday !== false;

  // Header profil
  updateProfileAvatar(c);
  document.getElementById('profileName').textContent = (c.prenom||'') + ' ' + (c.nom||'');
  document.getElementById('profileSeg').textContent  = SEGS2[getSeg(c, {})] || '';
}

function updateProfileAvatar(c) {
  var av = document.getElementById('profileAvatar');
  var hAv = document.getElementById('hAvatar');
  var AVATAR_COLORS2 = ['#4f7ef8','#10b981','#f59e0b','#6366f1','#ec4899','#14b8a6'];
  var bgColor = AVATAR_COLORS2[(c.prenom||'A').charCodeAt(0) % AVATAR_COLORS2.length];

  if (c.photoUrl) {
    // Photo rÃ©elle (base64 ou URL)
    var imgStyle = 'width:80px;height:80px;border-radius:50%;object-fit:cover;border:3px solid var(--blue)';
    av.innerHTML  = '<img src="'+c.photoUrl+'" style="'+imgStyle+'" onerror="this.style.display='none'">';
    hAv.innerHTML = '<img src="'+c.photoUrl+'" style="width:60px;height:60px;border-radius:50%;object-fit:cover;" onerror="this.style.display='none'">';
  } else if (c.avatarEmoji) {
    av.style.background  = bgColor;
    av.textContent  = c.avatarEmoji;
    av.style.fontSize = '32px';
    hAv.textContent = c.avatarEmoji;
  } else {
    var initials = ((c.prenom||'?')[0] + (c.nom||'?')[0]).toUpperCase();
    av.style.background  = bgColor;
    av.textContent  = initials;
    av.style.fontSize = '24px';
    hAv.textContent = initials;
    hAv.style.background = bgColor;
  }

  // Preview dans le modal photo aussi
  var prev = document.getElementById('photoPreview');
  if (prev) {
    if (c.photoUrl) {
      prev.innerHTML = '<img src="'+c.photoUrl+'" style="width:100px;height:100px;border-radius:50%;object-fit:cover;">';
    } else if (c.avatarEmoji) {
      prev.textContent = c.avatarEmoji;
      prev.style.background = bgColor;
      prev.style.fontSize = '40px';
    } else {
      var ini2 = ((c.prenom||'?')[0]+(c.nom||'?')[0]).toUpperCase();
      prev.textContent = ini2;
      prev.style.background = bgColor;
      prev.style.fontSize = '28px';
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAUVEGARDE PROFIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.saveProfile = async function() {
  if (!_clientId || !_clientDb) { showToast('Non connectÃ©', true); return; }
  var btn = document.getElementById('profileSaveBtn');
  btn.textContent = 'â³ Enregistrement...';
  btn.disabled = true;

  var updates = {
    prenom:   document.getElementById('edit-prenom').value.trim(),
    nom:      document.getElementById('edit-nom').value.trim(),
    email:    document.getElementById('edit-email').value.trim(),
    tel:      document.getElementById('edit-tel').value.trim(),
    birthday: document.getElementById('edit-birthday').value,
    prefs: {
      notifOffres:   document.getElementById('notif-offres').checked,
      notifTampons:  document.getElementById('notif-tampons').checked,
      notifBirthday: document.getElementById('notif-birthday').checked
    }
  };

  try {
    // Mettre Ã  jour fidelite_public (donnÃ©es visibles cÃ´tÃ© client)
    await setDoc(doc(_clientDb, 'fidelite_public', _clientId), updates, {merge:true});

    // Mettre Ã  jour aussi fidelite/{uid}/clients/{clientId} si uid connu
    if (_clientData && _clientData.uid) {
      await setDoc(
        doc(_clientDb, 'fidelite', _clientData.uid, 'clients', _clientId),
        updates, {merge:true}
      );
    }

    // Mettre Ã  jour les donnÃ©es locales
    _clientData = Object.assign({}, _clientData, updates);

    // RafraÃ®chir l'affichage
    document.getElementById('profileName').textContent = (updates.prenom+' '+updates.nom).trim();
    document.getElementById('hName').textContent       = (updates.prenom+' '+updates.nom).trim();

    btn.textContent = 'âœ… EnregistrÃ© !';
    setTimeout(function(){ btn.textContent = 'ğŸ’¾ Enregistrer mes infos'; btn.disabled = false; }, 2000);
    showToast('Profil mis Ã  jour !');
  } catch(e) {
    console.error(e);
    btn.textContent = 'ğŸ’¾ Enregistrer mes infos';
    btn.disabled = false;
    showToast('Erreur de sauvegarde', true);
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GESTION PHOTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var AVATAR_EMOJIS = ['ğŸ˜Š','ğŸ˜','ğŸ¥°','ğŸ¤©','ğŸ¦Š','ğŸ¼','ğŸ¦','ğŸ¯','ğŸ¦‹','ğŸŒ¸','â­','ğŸ€','ğŸ¯','ğŸ¨','ğŸš€','ğŸ’','ğŸŒˆ','ğŸ•','â˜•','ğŸµ'];

window.openPhotoModal = function() {
  // Remplir la grille d'emojis
  var grid = document.getElementById('emojiGrid');
  grid.innerHTML = AVATAR_EMOJIS.map(function(e) {
    var sel = _clientData && _clientData.avatarEmoji === e ? ' selected' : '';
    return '<div class="emoji-opt'+sel+'" onclick="selectEmoji(''+e+'')">'+e+'</div>';
  }).join('');

  // Mettre Ã  jour la preview
  if (_clientData) updateProfileAvatar(_clientData);
  document.getElementById('photoOverlay').classList.add('show');
};

window.closePhotoModal = function() {
  document.getElementById('photoOverlay').classList.remove('show');
};

window.selectEmoji = async function(emoji) {
  document.querySelectorAll('.emoji-opt').forEach(function(e){ e.classList.remove('selected'); });
  event.currentTarget.classList.add('selected');

  if (!_clientId || !_clientDb) return;
  try {
    await setDoc(doc(_clientDb,'fidelite_public',_clientId), {avatarEmoji:emoji, photoUrl:''}, {merge:true});
    if (_clientData && _clientData.uid) {
      await setDoc(doc(_clientDb,'fidelite',_clientData.uid,'clients',_clientId), {avatarEmoji:emoji, photoUrl:''}, {merge:true});
    }
    _clientData = Object.assign({}, _clientData, {avatarEmoji:emoji, photoUrl:''});
    updateProfileAvatar(_clientData);
    showToast('Avatar mis Ã  jour !');
    setTimeout(function(){ closePhotoModal(); }, 800);
  } catch(e) { showToast('Erreur', true); }
};

window.handlePhotoUpload = async function(input) {
  var file = input.files[0];
  if (!file) return;
  if (file.size > 500*1024) { showToast('Photo trop grande (max 500 Ko)', true); return; }

  var reader = new FileReader();
  reader.onload = async function(ev) {
    var b64 = ev.target.result;
    // Afficher preview immÃ©diatement
    var prev = document.getElementById('photoPreview');
    prev.innerHTML = '<img src="'+b64+'" style="width:100px;height:100px;border-radius:50%;object-fit:cover;">';

    if (!_clientId || !_clientDb) return;
    try {
      await setDoc(doc(_clientDb,'fidelite_public',_clientId), {photoUrl:b64, avatarEmoji:''}, {merge:true});
      if (_clientData && _clientData.uid) {
        await setDoc(doc(_clientDb,'fidelite',_clientData.uid,'clients',_clientId), {photoUrl:b64, avatarEmoji:''}, {merge:true});
      }
      _clientData = Object.assign({}, _clientData, {photoUrl:b64, avatarEmoji:''});
      updateProfileAvatar(_clientData);
      showToast('Photo mise Ã  jour !');
      setTimeout(function(){ closePhotoModal(); }, 800);
    } catch(e) { showToast('Erreur upload', true); }
  };
  reader.readAsDataURL(file);
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, isErr) {
  var t = $('toast');
  t.textContent = msg;
  t.style.background = isErr ? '#ef4444' : '#16a34a';
  t.classList.add('show');
  setTimeout(function(){ t.classList.remove('show'); }, 3000);
}

</script>
</body>
</html>
