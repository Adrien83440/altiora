<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>Ma Carte Fid√©lit√©</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{--blue:#1a3dce;--blue2:#4f7ef8;--bg:#f4f6fb;--green:#10b981;--orange:#f59e0b;--purple:#6366f1;--text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--radius:16px}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:13px}

/* LOADING */
.loading-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0f1f5c,#1a3dce);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;transition:opacity .4s}
.loading-screen.hide{opacity:0;pointer-events:none}
.loading-logo{font-size:44px;margin-bottom:16px}
.loading-title{font-size:20px;font-weight:800;color:#fff;margin-bottom:8px}
.loading-sub{font-size:12px;color:rgba(255,255,255,.5);margin-bottom:24px}
.loading-spinner{width:36px;height:36px;border:3px solid rgba(255,255,255,.2);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-status{font-size:11px;color:rgba(255,255,255,.4);margin-top:12px;min-height:16px}

/* ERROR */
.error-screen{min-height:100vh;background:linear-gradient(135deg,#0f1f5c,#1a3dce);display:flex;align-items:center;justify-content:center;padding:20px}
.error-card{background:#fff;border-radius:20px;padding:32px;width:min(380px,100%);text-align:center}
.error-ico{font-size:40px;margin-bottom:12px}
.error-title{font-size:18px;font-weight:800;margin-bottom:8px}
.error-sub{font-size:13px;color:var(--muted);line-height:1.5}

/* HERO */
.hero{background:linear-gradient(135deg,#0f1f5c,#1a3dce,#4f7ef8);padding:28px 20px 70px;text-align:center;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;right:-60px;top:-60px;width:220px;height:220px;border-radius:50%;background:rgba(255,255,255,.05)}
.hero::after{content:'';position:absolute;left:-40px;bottom:-40px;width:180px;height:180px;border-radius:50%;background:rgba(255,255,255,.04)}
.hero-logo{font-size:12px;font-weight:700;color:rgba(255,255,255,.45);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:18px}
.hero-avatar{width:68px;height:68px;border-radius:50%;border:3px solid rgba(255,255,255,.4);display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:800;color:#fff;margin:0 auto 10px;background:rgba(255,255,255,.15)}
.hero-name{font-size:22px;font-weight:800;color:#fff;margin-bottom:4px}
.hero-seg{font-size:13px;color:rgba(255,255,255,.6);margin-bottom:14px}
.hero-pts{display:inline-flex;align-items:center;gap:6px;padding:8px 18px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);border-radius:30px;color:#fff;font-size:14px;font-weight:700}

/* CARTE FLOTTANTE */
.card-wrap{padding:0 16px;margin-top:-50px;position:relative;z-index:10}
.fid-card{border-radius:20px;padding:22px;color:#fff;min-height:165px;position:relative;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.25)}
.fid-card::before{content:'';position:absolute;right:-40px;top:-40px;width:180px;height:180px;border-radius:50%;background:rgba(255,255,255,.07)}
.fid-card-row{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:18px}
.fid-card-label{font-size:10px;font-weight:700;opacity:.55;text-transform:uppercase;letter-spacing:1px}
.fid-card-shop{font-size:16px;font-weight:800;margin-top:3px}
.fid-pts-val{font-size:20px;font-weight:800}
.fid-pts-lbl{font-size:10px;opacity:.55;text-align:right}
.tampons-row{display:flex;gap:7px;flex-wrap:wrap}
.t{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,.25);display:flex;align-items:center;justify-content:center;font-size:16px;background:rgba(255,255,255,.07);transition:.3s}
.t.done{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.7);box-shadow:0 0 8px rgba(255,255,255,.15)}
.t.reward{background:linear-gradient(135deg,#f59e0b,#fbbf24);border-color:#fbbf24;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(251,191,36,.4)}50%{box-shadow:0 0 0 8px rgba(251,191,36,0)}}
.fid-progress{margin-top:12px}
.fid-bar-bg{background:rgba(255,255,255,.2);border-radius:99px;height:5px;overflow:hidden}
.fid-bar-fill{height:100%;border-radius:99px;background:rgba(255,255,255,.8);transition:width 1.2s ease}
.fid-bar-labels{display:flex;justify-content:space-between;margin-top:4px;font-size:10px;opacity:.6}

/* CONTENT */
.content{padding:18px 16px 100px;display:flex;flex-direction:column;gap:14px}
.section-title{font-size:14px;font-weight:800;margin-bottom:10px;display:flex;align-items:center;gap:7px}
.box{background:#fff;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.box-body{padding:16px}

/* POINTS */
.pts-section{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.pts-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.pts-main{font-size:28px;font-weight:800;color:var(--blue);line-height:1}
.pts-sub{font-size:11px;color:var(--muted);margin-top:4px}
.pts-next{font-size:12px;color:var(--muted);text-align:right;line-height:1.5}
.pts-bar-bg{background:#f1f5f9;border-radius:99px;height:10px;overflow:hidden;margin-bottom:6px}
.pts-bar-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--blue),var(--blue2));transition:width 1.4s ease}
.pts-milestones{display:flex;justify-content:space-between;font-size:10px;color:var(--muted)}

/* PALIERS */
.palier-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid #f1f5f9}
.palier-item:last-child{border-bottom:none}
.palier-ico{font-size:24px;width:40px;text-align:center;flex-shrink:0}
.palier-info{flex:1}
.palier-name{font-size:13px;font-weight:700}
.palier-need{font-size:11px;color:var(--muted);margin-top:2px}
.palier-badge{font-size:11px;font-weight:700;white-space:nowrap}
.palier-badge.ok{color:var(--green)}
.palier-badge.next{color:var(--orange)}

/* COUPONS */
.coupon-item{display:flex;gap:12px;padding:14px 16px;border-bottom:1px solid #f1f5f9}
.coupon-item:last-child{border-bottom:none}
.coupon-val{font-size:22px;font-weight:800;color:var(--blue);min-width:52px;text-align:center;align-self:center;flex-shrink:0}
.coupon-name{font-size:13px;font-weight:700;margin-bottom:3px}
.coupon-code{font-family:monospace;font-weight:800;background:#f1f5f9;padding:3px 8px;border-radius:5px;font-size:12px;letter-spacing:1px;cursor:pointer;display:inline-block;margin-top:2px}
.coupon-code:active{background:#dbeafe}
.coupon-exp{font-size:10px;color:var(--muted);margin-top:3px}

/* HISTORIQUE */
.hist-item{display:flex;align-items:center;gap:10px;padding:11px 16px;border-bottom:1px solid #f1f5f9}
.hist-item:last-child{border-bottom:none}
.hist-ico{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.hist-right{margin-left:auto;font-size:13px;font-weight:800}
.hist-right.plus{color:var(--green)}

/* QR MODAL */
.qr-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;display:none;align-items:flex-end;justify-content:center}
.qr-overlay.show{display:flex}
.qr-sheet{background:#fff;border-radius:20px 20px 0 0;padding:28px 24px 40px;width:100%;max-width:480px;text-align:center;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.qr-handle{width:40px;height:4px;background:#e2e8f0;border-radius:99px;margin:0 auto 20px}
.qr-title{font-size:16px;font-weight:800;margin-bottom:16px}
.qr-canvas{width:200px;height:200px;background:#f8faff;border-radius:12px;margin:0 auto 14px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border)}
.qr-code-text{font-family:monospace;font-size:22px;font-weight:800;letter-spacing:4px;color:var(--blue);margin-bottom:6px}
.qr-hint{font-size:11px;color:var(--muted);margin-bottom:20px}
.qr-close{width:100%;padding:12px;border:none;border-radius:12px;background:#f1f5f9;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer}

/* BOTTOM BAR */
.bottom-bar{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--border);padding:12px 16px calc(12px + env(safe-area-inset-bottom));display:flex;gap:10px;z-index:50;box-shadow:0 -4px 20px rgba(0,0,0,.06)}
.bb-btn{flex:1;padding:12px;border:none;border-radius:10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:.15s}
.bb-primary{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;box-shadow:0 4px 12px rgba(26,61,206,.2)}
.bb-secondary{background:#f1f5f9;color:var(--text)}

/* TOAST */
.toast{position:fixed;bottom:88px;left:50%;transform:translateX(-50%) translateY(20px);padding:10px 20px;background:#1a1f36;color:#fff;border-radius:20px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:.3s;white-space:nowrap;pointer-events:none}
.toast.show{transform:translateX(-50%) translateY(0);opacity:1}

/* COLORS */
.card-blue{background:linear-gradient(135deg,#0f1f5c,#1a3dce,#4f7ef8)}
.card-green{background:linear-gradient(135deg,#065f46,#059669,#10b981)}
.card-orange{background:linear-gradient(135deg,#92400e,#d97706,#f59e0b)}
.card-purple{background:linear-gradient(135deg,#4c1d95,#5b21b6,#6366f1)}
.card-pink{background:linear-gradient(135deg,#831843,#be185d,#ec4899)}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-screen" id="loadingScreen">
  <div class="loading-logo">üíé</div>
  <div class="loading-title">Carte Fid√©lit√©</div>
  <div class="loading-sub">Chargement de votre carte...</div>
  <div class="loading-spinner"></div>
  <div class="loading-status" id="loadingStatus">Connexion...</div>
</div>

<!-- ERROR -->
<div class="error-screen hidden" id="errorScreen">
  <div class="error-card">
    <div class="error-ico">‚ùå</div>
    <div class="error-title">Lien invalide</div>
    <div class="error-sub">Ce lien de carte fid√©lit√© n'existe pas ou a expir√©.<br/>Demandez un nouveau lien √† votre commer√ßant.</div>
  </div>
</div>

<!-- MAIN (cach√© jusqu'au chargement) -->
<div class="hidden" id="mainView">

  <div class="hero">
    <div class="hero-logo">üíé FID√âLIT√â</div>
    <div class="hero-avatar" id="hAvatar">?</div>
    <div class="hero-name" id="hName">‚Äî</div>
    <div class="hero-seg" id="hSeg">‚Äî</div>
    <div class="hero-pts">‚≠ê <span id="hPts">0</span> points</div>
  </div>

  <div class="card-wrap">
    <div class="fid-card card-blue" id="fidCard">
      <div class="fid-card-row">
        <div>
          <div class="fid-card-label">CARTE FID√âLIT√â</div>
          <div class="fid-card-shop" id="cShop">‚Äî</div>
        </div>
        <div>
          <div class="fid-pts-val" id="cPts">0</div>
          <div class="fid-pts-lbl">points</div>
        </div>
      </div>
      <div class="tampons-row" id="cTampons"></div>
      <div class="fid-progress">
        <div class="fid-bar-bg"><div class="fid-bar-fill" id="cBarFill" style="width:0%"></div></div>
        <div class="fid-bar-labels">
          <span id="cBarLeft">0 tampons</span>
          <span id="cBarRight">‚Üí r√©compense</span>
        </div>
      </div>
    </div>
  </div>

  <div class="content">

    <!-- POINTS -->
    <div class="section-title">‚≠ê Mes points</div>
    <div class="pts-section">
      <div class="pts-top">
        <div>
          <div class="pts-main" id="ptsBig">0</div>
          <div class="pts-sub">points disponibles</div>
        </div>
        <div class="pts-next" id="ptsNext">‚Äî</div>
      </div>
      <div class="pts-bar-bg"><div class="pts-bar-fill" id="ptsFill" style="width:0%"></div></div>
      <div class="pts-milestones" id="ptsMilestones"></div>
    </div>

    <!-- PALIERS -->
    <div class="section-title">üèÜ R√©compenses</div>
    <div class="box">
      <div id="paliersEl"></div>
    </div>

    <!-- COUPONS -->
    <div class="section-title" id="couponTitle" style="display:none">üé´ Mes coupons</div>
    <div class="box hidden" id="couponBox">
      <div id="couponsEl"></div>
    </div>

    <!-- HISTORIQUE -->
    <div class="section-title">üìã Historique des visites</div>
    <div class="box">
      <div id="histEl"></div>
    </div>

    <div style="text-align:center;padding:10px;font-size:11px;color:var(--muted)">
      Propuls√© par <strong>ALTIORA</strong>
    </div>

  </div>

  <!-- BOTTOM BAR -->
  <div class="bottom-bar">
    <button class="bb-btn bb-secondary" onclick="copyCode()">üìã Mon code</button>
    <button class="bb-btn bb-primary" onclick="showQR()">üì± QR Code caisse</button>
  </div>

</div>

<!-- QR MODAL -->
<div class="qr-overlay" id="qrOverlay" onclick="if(event.target===this)closeQR()">
  <div class="qr-sheet">
    <div class="qr-handle"></div>
    <div class="qr-title">üì± Mon QR Code</div>
    <div class="qr-canvas" id="qrCanvas">
      <svg id="qrSvg" width="180" height="180" viewBox="0 0 180 180"></svg>
    </div>
    <div class="qr-code-text" id="qrCodeText">‚Äî</div>
    <div class="qr-hint">Pr√©sentez ce code √† la caisse pour valider votre visite</div>
    <button class="qr-close" onclick="closeQR()">Fermer</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getFirestore,doc,getDoc,collection,getDocs,query,where}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const FB={apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",storageBucket:"altiora-70599.firebasestorage.app",messagingSenderId:"120905555746",appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"};
const app=initializeApp(FB);
const db=getFirestore(app);

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function $(id){return document.getElementById(id)}
function toast(msg){
  const t=$('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}
function setStatus(msg){const s=$('loadingStatus');if(s)s.textContent=msg}
function fi(n){return Math.round(parseFloat(n)||0).toLocaleString('fr-FR')}
const COLORS={blue:'card-blue',green:'card-green',orange:'card-orange',purple:'card-purple',pink:'card-pink'};
const SEG={vip:'üëë Client VIP',actif:'‚úÖ Client actif',inactif:'üò¥ Client inactif',nouveau:'üå± Nouveau client'};

// ‚îÄ‚îÄ R√©cup√©rer l'ID client depuis l'URL ‚îÄ‚îÄ
// G√©rer les deux cas : ?client=ID et #hash?client=ID
let clientId = new URLSearchParams(location.search).get('client');
if(!clientId){
  // Cas o√π l'ID est apr√®s un hash : #clients?client=ID
  const hashQuery = location.hash.includes('?') ? location.hash.split('?')[1] : '';
  clientId = new URLSearchParams(hashQuery).get('client');
}
// Cas o√π tout est dans le hash sans ? : #client=ID
if(!clientId && location.hash.includes('client=')){
  clientId = location.hash.split('client=')[1]?.split('&')[0];
}

if(!clientId){
  showError();
}else{
  loadClientData(clientId);
}

async function loadClientData(id){
  try{
    setStatus('Chargement de votre carte...');
    console.log('Recherche client ID:', id);

    // 1. Fiche client publique
    const clientRef = doc(db,'fidelite_public',id);
    console.log('Ref path:', clientRef.path);
    const clientSnap=await getDoc(clientRef);
    console.log('Existe:', clientSnap.exists(), 'Data:', clientSnap.data());
    if(!clientSnap.exists()){
      setStatus('Carte introuvable ‚Äî ID: '+id);
      // Afficher l'erreur √† l'√©cran au lieu de cacher
      $('loadingScreen').classList.add('hide');
      setTimeout(()=>$('loadingScreen').style.display='none',400);
      $('errorScreen').classList.remove('hidden');
      $('errorScreen').querySelector('.error-sub').innerHTML = 
        'ID client: <strong style="font-family:monospace">'+id+'</strong><br/>Document introuvable dans Firebase.<br/>V√©rifiez que la synchronisation a √©t√© faite.';
      return;
    }
    const client=clientSnap.data();
    window._clientData=client;

    // 2. Config commer√ßant (publique)
    setStatus('Chargement de la boutique...');
    const uid=client.uid;
    let shopCfg={tampons:10,reward:'1 produit offert',emoji:'‚òï',shopName:'Ma Boutique',cardColor:'blue',vipPts:2000,paliers:[]};
    if(uid){
      try{
        const cfgSnap=await getDoc(doc(db,'fidelite_public_cfg',uid));
        if(cfgSnap.exists())shopCfg={...shopCfg,...cfgSnap.data()};
      }catch(e){console.warn('cfg not found',e)}
    }
    window._shopCfg=shopCfg;

    // 3. Coupons du client (depuis collection coupons commer√ßant)
    let clientCoupons=[];
    if(uid){
      try{
        // Lire depuis localStorage si m√™me device, sinon depuis Firestore
        const raw=localStorage.getItem('altiora_fid_coupons');
        const allCoupons=raw?JSON.parse(raw):[];
        clientCoupons=allCoupons.filter(c=>
          c.status==='active'&&
          (c.target==='all'||c.target===getSeg(client,shopCfg)||(c.target==='one'&&c.targetName===`${client.prenom} ${client.nom}`))
        );
      }catch(e){}
    }
    window._coupons=clientCoupons;

    setStatus('Affichage...');
    setTimeout(()=>{
      renderAll(client,shopCfg,clientCoupons);
      $('loadingScreen').classList.add('hide');
      setTimeout(()=>$('loadingScreen').style.display='none',400);
      $('mainView').classList.remove('hidden');
    },300);

  }catch(e){
    console.error('Erreur Firebase:', e.code, e.message, e);
    setStatus('Erreur: '+(e.code||e.message||'inconnue'));
    $('loadingScreen').classList.add('hide');
    setTimeout(()=>$('loadingScreen').style.display='none',400);
    $('errorScreen').classList.remove('hidden');
    $('errorScreen').querySelector('.error-sub').innerHTML = 
      'Erreur technique: <strong>'+( e.code||e.message||JSON.stringify(e))+'</strong><br/>ID: '+id;
  }
}

function getSeg(c,cfg){
  const pts=c.points||0;
  const days=c.lastVisit?Math.floor((Date.now()-new Date(c.lastVisit))/86400000):999;
  const age=c.createdAt?Math.floor((Date.now()-new Date(c.createdAt))/86400000):999;
  if(pts>=(cfg.vipPts||2000))return'vip';
  if(age<30)return'nouveau';
  if(days>60)return'inactif';
  return'actif';
}
function avatarColor(name){
  const cols=['#4f7ef8','#10b981','#f59e0b','#6366f1','#ec4899','#14b8a6'];
  return cols[(name||'A').charCodeAt(0)%cols.length];
}

function renderAll(c,cfg,coupons){
  const seg=getSeg(c,cfg);
  const cfgT=parseInt(cfg.tampons)||10;
  const t=c.tampons||0;
  const pts=c.points||0;
  const color=COLORS[cfg.cardColor||'blue']||'card-blue';

  // HERO
  $('hAvatar').textContent=(c.prenom||'?')[0].toUpperCase()+(c.nom||'')[0]?.toUpperCase()||'';
  $('hAvatar').style.background=avatarColor(c.prenom);
  $('hName').textContent=`${c.prenom} ${c.nom}`;
  $('hSeg').textContent=SEG[seg]||'Client';
  $('hPts').textContent=fi(pts);

  // CARTE
  $('fidCard').className=`fid-card ${color}`;
  $('cShop').textContent=cfg.shopName||'Ma Boutique';
  $('cPts').textContent=fi(pts);
  const emoji=cfg.emoji||'‚òï';
  $('cTampons').innerHTML=Array.from({length:cfgT},(_,i)=>`
    <div class="t ${i<t?'done':''}">${i<t?emoji:'‚óã'}</div>`).join('');
  const pct=Math.round(t/cfgT*100);
  $('cBarFill').style.width=pct+'%';
  $('cBarLeft').textContent=`${t}/${cfgT} tampons`;
  $('cBarRight').textContent=`‚Üí ${cfg.reward||'1 produit offert'}`;

  // POINTS BAR
  $('ptsBig').textContent=fi(pts);
  const paliers=(cfg.paliers||[]).sort((a,b)=>a.pts-b.pts);
  const nextP=paliers.find(p=>p.pts>pts);
  const prevP=[...paliers].reverse().find(p=>p.pts<=pts);
  const from=prevP?.pts||0;
  const to=nextP?.pts||(cfg.vipPts||2000);
  const pctP=Math.min(100,Math.round((pts-from)/(to-from)*100));
  $('ptsFill').style.width=Math.max(0,pctP)+'%';
  $('ptsNext').innerHTML=nextP
    ?`Prochain :<br><strong>${nextP.icon} ${nextP.reward}</strong><br><span style="color:var(--orange)">${fi(nextP.pts-pts)} pts manquants</span>`
    :'üéâ Tous les paliers<br>d√©bloqu√©s !';
  $('ptsMilestones').innerHTML=paliers.slice(0,4).map(p=>`<span>${fi(p.pts)}</span>`).join('');

  // PALIERS
  $('paliersEl').innerHTML=paliers.length
    ?paliers.map(p=>{
      const unlocked=pts>=p.pts;
      return`<div class="palier-item" style="${unlocked?'background:#f0fdf4':''}">
        <div class="palier-ico">${p.icon}</div>
        <div class="palier-info">
          <div class="palier-name">${p.reward}</div>
          <div class="palier-need">${fi(p.pts)} points${unlocked?'':` ¬∑ ${fi(p.pts-pts)} manquants`}</div>
        </div>
        <div class="palier-badge ${unlocked?'ok':'next'}">${unlocked?'‚úÖ Dispo ‚Üí':p===nextP?'Prochain ‚Üí':''}</div>
      </div>`;
    }).join('')
    :'<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px">Aucun palier configur√©</div>';

  // COUPONS
  if(coupons.length){
    $('couponTitle').style.display='flex';
    $('couponBox').classList.remove('hidden');
    $('couponsEl').innerHTML=coupons.map(co=>{
      const val={pct:`-${co.val}%`,eur:`-${co.val}‚Ç¨`,free:'Gratuit'}[co.type]||co.val;
      return`<div class="coupon-item">
        <div class="coupon-val">${val}</div>
        <div>
          <div class="coupon-name">${co.name}</div>
          <div class="coupon-code" onclick="copyCodeStr('${co.code}')">${co.code}</div>
          <div class="coupon-exp">${co.expDate?'Expire le '+new Date(co.expDate).toLocaleDateString('fr-FR'):'Sans expiration'} ¬∑ Tapez le code pour copier</div>
        </div>
      </div>`;
    }).join('');
  }

  // HISTORIQUE
  const hist=(c.history||[]).slice(0,10);
  $('histEl').innerHTML=hist.length
    ?hist.map(h=>`<div class="hist-item">
      <div class="hist-ico" style="background:${h.type==='tampon'?'#eff6ff':'#f0fdf4'}">${h.type==='tampon'?'‚úÖ':'‚≠ê'}</div>
      <div>
        <div style="font-size:12px;font-weight:700">${h.type==='tampon'?'Achat valid√©':'Points ajout√©s'}</div>
        <div style="font-size:10px;color:var(--muted)">${new Date(h.date).toLocaleDateString('fr-FR')}${h.montant?` ¬∑ ${h.montant}‚Ç¨`:''}</div>
      </div>
      <div class="hist-right plus">+${h.pts||1} ${h.pts?'pts':'‚¨ú'}</div>
    </div>`).join('')
    :'<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px">Aucune visite enregistr√©e</div>';

  // QR code text
  $('qrCodeText').textContent=clientId.slice(0,8).toUpperCase();
}

function showError(){
  $('loadingScreen').classList.add('hide');
  setTimeout(()=>$('loadingScreen').style.display='none',400);
  $('errorScreen').classList.remove('hidden');
}

// ‚îÄ‚îÄ QR Code simple (SVG) ‚îÄ‚îÄ
window.showQR=function(){
  const code=clientId.slice(0,8).toUpperCase();
  $('qrCodeText').textContent=code;
  generateQR(code);
  $('qrOverlay').classList.add('show');
}
window.closeQR=function(){$('qrOverlay').classList.remove('show')}

function generateQR(text){
  // QR visuel simple bas√© sur le code (pas un vrai QR scannable ‚Äî n√©cessite une lib externe)
  // On affiche un pattern unique par client suffisant pour la caisse
  const svg=$('qrSvg');
  const size=9;const cell=180/size;
  let html='';
  // Coins fixes (pattern QR standard)
  const corners=[[0,0],[0,1],[0,2],[1,0],[2,0],[2,1],[2,2],[1,2],[6,0],[6,1],[6,2],[7,0],[8,0],[8,1],[8,2],[7,2],[0,6],[0,7],[0,8],[1,6],[2,6],[2,7],[2,8],[1,8]];
  const cornerSet=new Set(corners.map(([r,c])=>`${r},${c}`));
  for(let r=0;r<size;r++){
    for(let c2=0;c2<size;c2++){
      const isCorner=cornerSet.has(`${r},${c2}`);
      // Data bits bas√©s sur le hash du clientId
      let on=isCorner;
      if(!isCorner){
        const h=(text.charCodeAt((r*size+c2)%text.length)*(r+1)*(c2+1))%7;
        on=h>2;
      }
      if(on)html+=`<rect x="${c2*cell+1}" y="${r*cell+1}" width="${cell-2}" height="${cell-2}" rx="2" fill="#0f1f5c"/>`;
    }
  }
  svg.innerHTML=html;
}

// ‚îÄ‚îÄ Actions ‚îÄ‚îÄ
window.copyCode=function(){
  const code=clientId.slice(0,8).toUpperCase();
  navigator.clipboard?.writeText(code).catch(()=>{});
  toast('Code '+code+' copi√© !');
}
window.copyCodeStr=function(code){
  navigator.clipboard?.writeText(code).catch(()=>{});
  toast('Code '+code+' copi√© !');
}
</script>
</body>
</html>
