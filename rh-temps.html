<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE ‚Äî Temps de travail</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --rh-dark:#052e16;--rh-main:#059669;--rh-mid:#10b981;--rh-bright:#34d399;
      --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f0fdf7;--radius:12px;
      --red:#ef4444;--red-light:#fee2e2;--orange:#f59e0b;--orange-light:#fef3c7;
      --blue:#1a3dce;--purple:#6366f1;--sidebar-w:250px;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-width:0;}

    /* TOPBAR */
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;gap:10px;flex-wrap:wrap;}
    .topbar-left h1{font-size:17px;font-weight:700;}
    .topbar-left p{font-size:12px;color:var(--muted);margin-top:2px;}
    .topbar-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;gap:6px;}
    .btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-mid));color:white;box-shadow:0 3px 10px rgba(5,150,105,.25);}
    .btn-rh:hover{opacity:.9;transform:translateY(-1px);}
    .btn-outline{background:white;color:var(--rh-main);border:1.5px solid var(--rh-border);}
    .btn-outline:hover{background:var(--rh-ghost);}
    .btn-ghost{background:transparent;color:var(--muted);border:1.5px solid var(--border);}
    .btn-ghost:hover{background:white;color:var(--text);}
    .btn-sm{padding:5px 11px;font-size:12px;}
    .btn-xs{padding:3px 8px;font-size:11px;}
    .btn-danger{background:#fee2e2;color:#dc2626;border:1px solid #fecaca;}
    .btn-danger:hover{background:#fecaca;}

    /* MOIS NAV */
    .mois-bar{background:white;border-bottom:1px solid var(--border);padding:10px 28px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
    .mois-nav{display:flex;align-items:center;gap:8px;}
    .mnav-btn{width:30px;height:30px;border:1.5px solid var(--border);border-radius:7px;background:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .15s;}
    .mnav-btn:hover{border-color:var(--rh-main);background:var(--rh-ghost);}
    .mois-label{font-size:15px;font-weight:700;min-width:160px;text-align:center;}
    .today-btn{font-size:12px;font-weight:600;padding:4px 10px;border:1.5px solid var(--rh-border);border-radius:7px;background:var(--rh-ghost);color:var(--rh-main);cursor:pointer;}
    .today-btn:hover{background:var(--rh-main);color:white;}
    .mois-stats{display:flex;gap:14px;margin-left:auto;flex-wrap:wrap;}
    .mois-stat{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:5px;}
    .mois-stat strong{color:var(--text);font-weight:700;}
    .dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

    /* CONTENT */
    .content{padding:20px 28px;flex:1;}

    /* KPI GRID */
    .kpi-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;}
    .kpi-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;}
    .kpi-card.green{background:var(--rh-ghost);border-color:var(--rh-border);}
    .kpi-card.orange{background:#fef9c3;border-color:#fde68a;}
    .kpi-card.red{background:#fee2e2;border-color:#fecaca;}
    .kpi-card.blue{background:#eff6ff;border-color:#bfdbfe;}
    .kpi-card.purple{background:#f5f3ff;border-color:#ddd6fe;}
    .kpi-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:4px;}
    .kpi-val{font-size:20px;font-weight:800;color:var(--text);}
    .kpi-val.green{color:var(--rh-main);}
    .kpi-val.orange{color:#d97706;}
    .kpi-val.red{color:#dc2626;}
    .kpi-sub{font-size:10px;color:var(--muted);margin-top:3px;}

    /* MAIN GRID */
    .main-grid{display:grid;grid-template-columns:1fr 320px;gap:16px;align-items:start;}

    /* TABLEAU */
    .table-card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:13px 18px;border-bottom:1px solid var(--border);}
    .card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px;}
    .table-wrap{overflow-x:auto;}
    table{width:100%;border-collapse:collapse;font-size:12px;}
    thead th{padding:9px 14px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;background:#fafffe;border-bottom:1px solid var(--border);white-space:nowrap;}
    thead th:not(:first-child){text-align:right;}
    tbody td{padding:10px 14px;border-bottom:1px solid #f1f5f9;vertical-align:middle;}
    tbody td:not(:first-child){text-align:right;font-weight:600;}
    tbody tr:last-child td{border-bottom:none;}
    tbody tr:hover td{background:#fafffe;}
    .emp-cell{display:flex;align-items:center;gap:9px;}
    .av{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0;}
    .emp-name{font-size:12px;font-weight:700;}
    .emp-meta{font-size:10px;color:var(--muted);}

    /* INPUT HEURES inline */
    .h-input{width:60px;border:1.5px solid var(--border);border-radius:7px;padding:5px 8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;text-align:center;outline:none;transition:border-color .15s;background:white;}
    .h-input:focus{border-color:var(--rh-main);box-shadow:0 0 0 3px rgba(5,150,105,.1);}
    .h-input.modified{border-color:var(--orange);background:#fffbeb;}
    .h-input.saved{border-color:var(--rh-main);background:var(--rh-ghost);}

    /* BADGES */
    .badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;}
    .badge-green{background:var(--rh-ghost);color:var(--rh-main);}
    .badge-orange{background:#fef3c7;color:#92400e;}
    .badge-red{background:#fee2e2;color:#991b1b;}
    .badge-blue{background:#eff6ff;color:#1e40af;}
    .badge-muted{background:#f1f5f9;color:var(--muted);}

    /* BARRE PROGRESSION */
    .prog-wrap{display:flex;align-items:center;gap:8px;}
    .prog-bar{flex:1;height:6px;background:#f1f5f9;border-radius:99px;overflow:hidden;min-width:60px;}
    .prog-fill{height:100%;border-radius:99px;transition:width .4s ease;}
    .prog-pct{font-size:10px;font-weight:700;white-space:nowrap;min-width:32px;}

    /* PANNEAU DROIT */
    .side-card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:14px;}
    .side-head{padding:12px 16px;border-bottom:1px solid var(--border);font-size:12px;font-weight:700;display:flex;align-items:center;gap:6px;}
    .side-body{padding:14px 16px;}

    /* GRAPHIQUE */
    .chart-wrap{position:relative;height:180px;}

    /* SAISIE RAPIDE */
    .quick-emp{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:9px;background:#fafffe;border:1px solid var(--rh-border);margin-bottom:8px;cursor:pointer;transition:all .15s;}
    .quick-emp:hover{background:var(--rh-ghost);border-color:var(--rh-main);}
    .quick-emp:last-child{margin-bottom:0;}
    .quick-name{font-size:12px;font-weight:600;}
    .quick-val{font-size:13px;font-weight:800;color:var(--rh-main);}
    .quick-val.zero{color:var(--muted);}
    .quick-val.sup{color:#d97706;}

    /* MODAL */
    .overlay{position:fixed;inset:0;background:rgba(5,46,22,.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;}
    .overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;width:100%;max-width:560px;box-shadow:0 24px 60px rgba(5,46,22,.2);overflow:hidden;max-height:90vh;overflow-y:auto;}
    .modal-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:white;z-index:1;}
    .modal-head h3{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:var(--muted);line-height:1;}
    .modal-body{padding:20px 22px;}
    .modal-foot{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;background:white;position:sticky;bottom:0;}
    .mfield{margin-bottom:14px;}
    .mfield label{font-size:11px;font-weight:700;color:var(--muted);display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.3px;}
    .minput{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;transition:border-color .15s;}
    .minput:focus{border-color:var(--rh-main);box-shadow:0 0 0 3px rgba(5,150,105,.1);}
    .mrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .mrow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}

    /* RECAP MODAL */
    .recap-row{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-radius:8px;margin-bottom:6px;}
    .recap-row.green{background:var(--rh-ghost);}
    .recap-row.orange{background:#fef3c7;}
    .recap-row.red{background:#fee2e2;}
    .recap-row.neutral{background:#f8faff;}

    /* LOADER */
    .loader{display:flex;align-items:center;justify-content:center;padding:50px;gap:10px;color:var(--muted);}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:18px;height:18px;border:2px solid var(--rh-border);border-top-color:var(--rh-main);border-radius:50%;animation:spin .7s linear infinite;}

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:11px 18px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.ok{background:var(--rh-main);}
    .toast.warn{background:var(--orange);}
    .toast.err{background:var(--red);}

    /* EMPTY */
    .empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:50px 30px;text-align:center;color:var(--muted);}
    .empty-icon{font-size:42px;margin-bottom:12px;}

    /* IMPORT PLANNING BADGE */
    .import-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;padding:2px 7px;border-radius:5px;background:#eff6ff;color:#1e40af;cursor:pointer;border:none;}
    .import-badge:hover{background:#dbeafe;}

    /* MOBILE */
    .hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:var(--rh-main);border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(5,150,105,.45);}
    .hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;}
    .nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;}
    .nav-overlay.show{display:block;}
    @media(max-width:768px){
      .hamburger{display:flex!important;}
      .main{margin-left:0!important;}
      .topbar{padding:10px 10px 10px 62px!important;flex-wrap:wrap!important;gap:6px!important;}
      .content{padding:12px 10px!important;}
      .kpi-grid{grid-template-columns:1fr 1fr!important;gap:8px!important;}
      .main-grid{grid-template-columns:1fr!important;}
      .mrow,.mrow3{grid-template-columns:1fr!important;}
    }
    @media(max-width:420px){
      .kpi-grid{grid-template-columns:1fr!important;}
    }
  </style>
</head>
<body>

<button class="hamburger" id="hamburger" onclick="toggleMobileNav()" aria-label="Menu">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="navOverlay" onclick="toggleMobileNav()"></div>

<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>‚è± Temps de travail</h1>
      <p>Suivi mensuel des heures ¬∑ Comparaison contrat vs r√©el ¬∑ Heures suppl√©mentaires</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-ghost btn-sm" onclick="importFromPlanning()" id="btn-import">üìÖ Importer du planning</button>
      <button class="btn btn-outline btn-sm" onclick="openExport()">üìä R√©capitulatif</button>
      <button class="btn btn-rh btn-sm" onclick="openSaisie(null)">+ Saisie manuelle</button>
    </div>
  </div>

  <!-- NAVIGATION MOIS -->
  <div class="mois-bar">
    <div class="mois-nav">
      <button class="mnav-btn" onclick="prevMois()">‚Äπ</button>
      <div class="mois-label" id="mois-label">‚Äî</div>
      <button class="mnav-btn" onclick="nextMois()">‚Ä∫</button>
      <button class="today-btn" onclick="goToday()">Aujourd'hui</button>
    </div>
    <div class="mois-stats" id="mois-stats">
      <div class="mois-stat"><div class="dot" style="background:var(--rh-main)"></div>Heures saisies : <strong id="stat-h">‚Äî</strong></div>
      <div class="mois-stat"><div class="dot" style="background:#3b82f6"></div>Th√©oriques : <strong id="stat-theo">‚Äî</strong></div>
      <div class="mois-stat"><div class="dot" style="background:#f59e0b"></div>Heures sup : <strong id="stat-sup">‚Äî</strong></div>
      <div class="mois-stat"><div class="dot" style="background:#6366f1"></div>Employ√©s saisis : <strong id="stat-nb">‚Äî</strong></div>
    </div>
  </div>

  <div class="content">
    <!-- KPI -->
    <div class="kpi-grid" id="kpi-grid">
      <div class="kpi-card green"><div class="kpi-lbl">Total heures r√©elles</div><div class="kpi-val green" id="k-total">‚Äî</div><div class="kpi-sub">Ce mois</div></div>
      <div class="kpi-card blue"><div class="kpi-lbl">Heures th√©oriques</div><div class="kpi-val" id="k-theo">‚Äî</div><div class="kpi-sub">Bas√© sur contrats</div></div>
      <div class="kpi-card" id="k-ecart-card"><div class="kpi-lbl">√âcart global</div><div class="kpi-val" id="k-ecart">‚Äî</div><div class="kpi-sub" id="k-ecart-sub">‚Äî</div></div>
      <div class="kpi-card orange"><div class="kpi-lbl">Heures suppl√©mentaires</div><div class="kpi-val orange" id="k-sup">‚Äî</div><div class="kpi-sub">√Ä r√©mun√©rer / r√©cup√©rer</div></div>
      <div class="kpi-card purple"><div class="kpi-lbl">Taux de pr√©sence</div><div class="kpi-val" id="k-taux" style="color:var(--purple)">‚Äî</div><div class="kpi-sub">Heures r√©elles / th√©oriques</div></div>
    </div>

    <!-- GRILLE PRINCIPALE -->
    <div class="main-grid">
      <!-- TABLEAU EMPLOY√âS -->
      <div class="table-card">
        <div class="card-head">
          <div class="card-title">üë• Heures par employ√© <span id="unsaved-badge" style="display:none;background:#fef3c7;color:#92400e;font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;margin-left:6px">‚ö†Ô∏è Modifications non sauvegard√©es</span></div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-ghost btn-xs" onclick="toggleAll()">‚òê Tout saisir</button>
            <button class="btn btn-rh btn-xs" id="btn-save-all" onclick="saveAll()" style="display:none">üíæ Sauvegarder tout</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="text-align:left">Employ√©</th>
                <th>Contrat</th>
                <th>H. Th√©oriques</th>
                <th>H. Travaill√©es</th>
                <th>Jours pr√©sence</th>
                <th>√âcart</th>
                <th>H. Sup</th>
                <th>Progression</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="9"><div class="loader"><div class="spin"></div><span>Chargement‚Ä¶</span></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- PANNEAU DROIT -->
      <div>
        <!-- Graphique heures -->
        <div class="side-card">
          <div class="side-head">üìä R√©partition des heures</div>
          <div class="side-body">
            <div class="chart-wrap"><canvas id="chartHeures"></canvas></div>
          </div>
        </div>

        <!-- Alertes -->
        <div class="side-card">
          <div class="side-head">‚ö†Ô∏è Alertes</div>
          <div class="side-body" id="alertes-body">
            <div style="font-size:12px;color:var(--muted);text-align:center;padding:10px 0">Chargement‚Ä¶</div>
          </div>
        </div>

        <!-- Synth√®se rapide -->
        <div class="side-card">
          <div class="side-head">üìã Top pr√©sences</div>
          <div class="side-body" id="top-body">
            <div style="font-size:12px;color:var(--muted);text-align:center;padding:10px 0">Chargement‚Ä¶</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL SAISIE -->
<div class="overlay" id="modal-saisie">
  <div class="modal">
    <div class="modal-head">
      <h3>‚è± Saisie des heures</h3>
      <button class="modal-close" onclick="closeModal('modal-saisie')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="mfield">
        <label>Employ√© *</label>
        <select class="minput" id="s-emp" onchange="onEmpChange()">
          <option value="">S√©lectionner‚Ä¶</option>
        </select>
      </div>
      <div class="mrow">
        <div class="mfield">
          <label>Heures travaill√©es</label>
          <input class="minput" type="text" inputmode="decimal" id="s-heures" placeholder="Ex: 151.67" oninput="calcEcart()"/>
        </div>
        <div class="mfield">
          <label>Jours de pr√©sence</label>
          <input class="minput" type="text" inputmode="decimal" id="s-jours" placeholder="Ex: 21"/>
        </div>
      </div>
      <div class="mrow">
        <div class="mfield">
          <label>Heures suppl√©mentaires</label>
          <input class="minput" type="text" inputmode="decimal" id="s-sup" placeholder="0" oninput="calcEcart()"/>
        </div>
        <div class="mfield">
          <label>Absences (jours)</label>
          <input class="minput" type="text" inputmode="decimal" id="s-abs" placeholder="0"/>
        </div>
      </div>
      <div class="mfield">
        <label>Note / commentaire</label>
        <input class="minput" id="s-note" placeholder="Optionnel‚Ä¶"/>
      </div>
      <!-- R√©cap contrat -->
      <div id="s-recap" style="display:none;margin-top:4px"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('modal-saisie')">Annuler</button>
      <button class="btn btn-rh" onclick="saveSaisie()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL R√âCAP / EXPORT -->
<div class="overlay" id="modal-export">
  <div class="modal">
    <div class="modal-head">
      <h3>üìä R√©capitulatif mensuel ‚Äî <span id="exp-titre">‚Äî</span></h3>
      <button class="modal-close" onclick="closeModal('modal-export')">‚úï</button>
    </div>
    <div class="modal-body" id="exp-body">
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('modal-export')">Fermer</button>
      <button class="btn btn-rh" onclick="printRecap()">üñ®Ô∏è Imprimer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, deleteDoc, collection, query, where }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com", projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746", appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth = getAuth(app);
  const db   = getFirestore(app);

  window._db   = db;
  window._auth = auth;
  window._doc  = doc;
  window._setDoc   = setDoc;
  window._getDoc   = getDoc;
  window._getDocs  = getDocs;
  window._deleteDoc = deleteDoc;
  window._collection = collection;
  window._query    = query;
  window._where    = where;
  window._signOut  = signOut;
  window._firebaseReady = true;

  onAuthStateChanged(auth, user => {
    if (!user) { window.location.href = 'index.html'; return; }
    window._uid = user.uid;
    window.initTemps();
  });
</script>

<script>
// ‚ïê‚ïê √âTAT ‚ïê‚ïê
var _employes   = [];
var _tempsMap   = {};   // { moisKey_empId : { heuresTravaillees, joursPresence, heureSup, absences, note } }
var _params     = {};
var _curMois    = new Date();
var _modified   = {};   // { empId: {heures, jours, sup, abs, note} }  ‚Äî saisies en cours
var _chartH     = null;

_curMois.setDate(1);

// ‚ïê‚ïê INIT ‚ïê‚ïê
window.initTemps = async function() {
  if (!window._uid) return;
  try {
    const ps = await window._getDoc(window._doc(window._db, 'rh_params', window._uid));
    _params = ps.exists() ? ps.data() : {};
  } catch(e) { _params = {}; }
  await loadEmployes();
  updateMoisLabel();
  await loadTemps();
  render();
};

async function loadEmployes() {
  _employes = [];
  try {
    const snap = await window._getDocs(window._collection(window._db, 'rh', window._uid, 'employes'));
    snap.forEach(d => _employes.push({ id: d.id, ...d.data() }));
    _employes.sort((a,b) => (a.nom||'').localeCompare(b.nom||''));
  } catch(e) { console.warn('Employ√©s:', e); }
}

async function loadTemps() {
  _tempsMap = {};
  const moisKey = getMoisKey();
  try {
    const snap = await window._getDocs(window._collection(window._db, 'rh', window._uid, 'temps'));
    snap.forEach(d => {
      const data = d.data();
      if (data.mois === moisKey) {
        _tempsMap[data.employeId] = { id: d.id, ...data };
      }
    });
  } catch(e) { console.warn('Temps:', e); }
}

// ‚ïê‚ïê UTILS ‚ïê‚ïê
function getMoisKey() {
  return _curMois.getFullYear() + '-' + String(_curMois.getMonth()+1).padStart(2,'0');
}

function getMoisLabel() {
  return _curMois.toLocaleDateString('fr-FR', { month:'long', year:'numeric' });
}

function updateMoisLabel() {
  document.getElementById('mois-label').textContent = getMoisLabel().charAt(0).toUpperCase() + getMoisLabel().slice(1);
}

function joursOuvres(y, m) {
  // Nombre de jours ouvr√©s (lun-ven) du mois
  var count = 0;
  var d = new Date(y, m, 1);
  while (d.getMonth() === m) {
    var dw = d.getDay();
    if (dw !== 0 && dw !== 6) count++;
    d.setDate(d.getDate()+1);
  }
  return count;
}

function heuresTheo(emp) {
  var h = parseFloat(emp.heuresHebdo) || 35;
  var y = _curMois.getFullYear(), m = _curMois.getMonth();
  var jo = joursOuvres(y, m);
  return Math.round(h * (jo/5) * 10) / 10;
}

function getAvatarColor(str) {
  var colors = ['#059669','#10b981','#3b82f6','#6366f1','#8b5cf6','#ec4899','#f59e0b','#14b8a6','#ef4444','#0ea5e9'];
  var idx = 0;
  for (var i=0; i<(str||'').length; i++) idx += str.charCodeAt(i);
  return colors[idx % colors.length];
}

function fmtH(h) {
  h = parseFloat(h) || 0;
  return h.toFixed(1) + 'h';
}

function fmtEcart(ecart) {
  if (ecart > 0) return '<span style="color:var(--rh-main);font-weight:700">+' + fmtH(ecart) + '</span>';
  if (ecart < 0) return '<span style="color:#dc2626;font-weight:700">' + fmtH(ecart) + '</span>';
  return '<span style="color:var(--muted)">0h</span>';
}

// ‚ïê‚ïê RENDER PRINCIPAL ‚ïê‚ïê
function render() {
  renderKpis();
  renderTable();
  renderAlertes();
  renderTop();
  renderChart();
  updateMoisLabel();
}

function renderKpis() {
  var totalReel = 0, totalTheo = 0, totalSup = 0, nbSaisis = 0;

  _employes.forEach(emp => {
    var t = _tempsMap[emp.id] || _modified[emp.id];
    var theo = heuresTheo(emp);
    totalTheo += theo;
    if (t && (parseFloat(t.heuresTravaillees) > 0 || parseFloat(t.joursPresence) > 0)) {
      totalReel += parseFloat(t.heuresTravaillees) || 0;
      totalSup  += parseFloat(t.heureSup) || 0;
      nbSaisis++;
    }
  });

  var ecart = totalReel - totalTheo;
  var taux  = totalTheo > 0 ? Math.min(totalReel / totalTheo * 100, 150) : 0;

  document.getElementById('k-total').textContent = fmtH(totalReel);
  document.getElementById('k-theo').textContent  = fmtH(totalTheo);
  document.getElementById('k-ecart').innerHTML   = fmtEcart(ecart);
  document.getElementById('k-ecart-sub').textContent = ecart > 0 ? 'Heures en plus' : ecart < 0 ? 'Heures en d√©ficit' : '√Ä l\'√©quilibre';
  document.getElementById('k-sup').textContent   = fmtH(totalSup);
  document.getElementById('k-taux').textContent  = taux > 0 ? taux.toFixed(0) + '%' : '‚Äî';

  // Couleur carte √©cart
  var ec = document.getElementById('k-ecart-card');
  ec.className = 'kpi-card ' + (ecart > 0 ? 'green' : ecart < 0 ? 'red' : '');

  // Stats barre
  document.getElementById('stat-h').textContent    = fmtH(totalReel);
  document.getElementById('stat-theo').textContent = fmtH(totalTheo);
  document.getElementById('stat-sup').textContent  = fmtH(totalSup);
  document.getElementById('stat-nb').textContent   = nbSaisis + ' / ' + _employes.length;
}

function renderTable() {
  var tbody = document.getElementById('tbody');
  if (!_employes.length) {
    tbody.innerHTML = '<tr><td colspan="9"><div class="empty"><div class="empty-icon">üë•</div><p>Aucun employ√©.<br><a href="rh-employes.html" style="color:var(--rh-main);font-weight:700">Ajouter des employ√©s ‚Üí</a></p></div></td></tr>';
    return;
  }

  tbody.innerHTML = _employes.map(emp => {
    var t     = _tempsMap[emp.id];
    var mod   = _modified[emp.id];
    var data  = mod || t;
    var theo  = heuresTheo(emp);
    var reel  = parseFloat(data?.heuresTravaillees) || 0;
    var jours = parseFloat(data?.joursPresence) || 0;
    var sup   = parseFloat(data?.heureSup) || 0;
    var ecart = reel > 0 ? reel - theo : null;
    var pct   = theo > 0 ? Math.min(reel / theo * 100, 130) : 0;
    var initials = ((emp.prenom||'').charAt(0) + (emp.nom||'').charAt(0)).toUpperCase();
    var color = getAvatarColor(emp.nom);
    var hasMod = !!mod;
    var hasSaved = !!t && !mod;

    // Badge statut
    var statut = '';
    if (hasMod) statut = '<span class="badge badge-orange">‚ö†Ô∏è Modifi√©</span>';
    else if (hasSaved) statut = '<span class="badge badge-green">‚úÖ Sauvegard√©</span>';
    else statut = '<span class="badge badge-muted">‚Äî Non saisi</span>';

    // Couleur progression
    var progColor = pct >= 95 ? 'var(--rh-main)' : pct >= 70 ? '#3b82f6' : pct > 0 ? '#f59e0b' : '#e2e8f0';

    // Input √©tat
    var inputCls = hasMod ? 'h-input modified' : hasSaved ? 'h-input saved' : 'h-input';

    return `<tr>
      <td>
        <div class="emp-cell">
          <div class="av" style="background:${color}">${initials}</div>
          <div>
            <div class="emp-name">${emp.prenom||''} ${emp.nom||''}</div>
            <div class="emp-meta">${emp.poste||emp.typeContrat||'CDI'} ¬∑ ${emp.heuresHebdo||35}h/sem</div>
          </div>
        </div>
      </td>
      <td><span class="badge badge-blue">${emp.typeContrat||'CDI'}</span></td>
      <td><span style="font-weight:700">${fmtH(theo)}</span></td>
      <td>
        <div style="display:flex;align-items:center;gap:6px;justify-content:flex-end">
          <input class="${inputCls}" id="inp-h-${emp.id}" type="text" inputmode="decimal"
            value="${reel > 0 ? reel : ''}" placeholder="‚Äî"
            onchange="onHInput('${emp.id}','heuresTravaillees',this.value)"
            onfocus="this.select()"/>
        </div>
      </td>
      <td>
        <input class="${inputCls}" id="inp-j-${emp.id}" type="text" inputmode="decimal"
          value="${jours > 0 ? jours : ''}" placeholder="‚Äî"
          onchange="onHInput('${emp.id}','joursPresence',this.value)"
          onfocus="this.select()" style="width:50px"/>
      </td>
      <td>${ecart !== null ? fmtEcart(ecart) : '<span style="color:var(--muted)">‚Äî</span>'}</td>
      <td>
        <input class="${inputCls}" id="inp-s-${emp.id}" type="text" inputmode="decimal"
          value="${sup > 0 ? sup : ''}" placeholder="0"
          onchange="onHInput('${emp.id}','heureSup',this.value)"
          onfocus="this.select()" style="width:50px"/>
      </td>
      <td style="min-width:120px">
        <div class="prog-wrap">
          <div class="prog-bar"><div class="prog-fill" style="width:${Math.min(pct,100)}%;background:${progColor}"></div></div>
          <div class="prog-pct" style="color:${progColor}">${pct > 0 ? pct.toFixed(0)+'%' : '‚Äî'}</div>
        </div>
      </td>
      <td>
        <div style="display:flex;gap:4px;justify-content:flex-end">
          ${statut}
          <button class="btn btn-ghost btn-xs" onclick="openSaisie('${emp.id}')" title="Saisie d√©taill√©e">‚úèÔ∏è</button>
          ${t ? `<button class="btn btn-danger btn-xs" onclick="deleteTemps('${emp.id}')" title="Supprimer">üóë</button>` : ''}
        </div>
      </td>
    </tr>`;
  }).join('');
}

function renderAlertes() {
  var body = document.getElementById('alertes-body');
  var alertes = [];
  var moisKey = getMoisKey();
  var now = new Date();
  var isCurrentMonth = getMoisKey() === (now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0'));

  _employes.forEach(emp => {
    var t    = _tempsMap[emp.id];
    var theo = heuresTheo(emp);
    if (!t) {
      if (isCurrentMonth && now.getDate() > 15) {
        alertes.push({ type:'warn', msg:`${emp.prenom||''} ${emp.nom||''} : aucune saisie ce mois` });
      }
      return;
    }
    var reel  = parseFloat(t.heuresTravaillees) || 0;
    var sup   = parseFloat(t.heureSup) || 0;
    var ecart = reel - theo;
    if (sup > 10) alertes.push({ type:'warn', msg:`${emp.prenom||''} ${emp.nom||''} : ${sup}h sup. √† traiter` });
    if (ecart < -10) alertes.push({ type:'err', msg:`${emp.prenom||''} ${emp.nom||''} : ${Math.abs(ecart).toFixed(1)}h de d√©ficit` });
    if (reel > theo * 1.2) alertes.push({ type:'info', msg:`${emp.prenom||''} ${emp.nom||''} : d√©passement ${(reel-theo).toFixed(1)}h (120%+)` });
  });

  if (!alertes.length) {
    body.innerHTML = '<div style="font-size:12px;color:var(--rh-main);text-align:center;padding:10px 0">‚úÖ Aucune alerte ce mois</div>';
    return;
  }

  body.innerHTML = alertes.slice(0,6).map(a => {
    var bg = a.type === 'err' ? '#fee2e2' : a.type === 'warn' ? '#fef3c7' : '#eff6ff';
    var col = a.type === 'err' ? '#991b1b' : a.type === 'warn' ? '#92400e' : '#1e40af';
    var ico = a.type === 'err' ? 'üî¥' : a.type === 'warn' ? 'üü°' : '‚ÑπÔ∏è';
    return `<div style="display:flex;gap:7px;align-items:flex-start;padding:7px 9px;background:${bg};border-radius:8px;margin-bottom:6px;font-size:11px;font-weight:600;color:${col}">
      <span style="flex-shrink:0">${ico}</span><span>${a.msg}</span>
    </div>`;
  }).join('') + (alertes.length > 6 ? `<div style="font-size:11px;color:var(--muted);text-align:center;margin-top:6px">+ ${alertes.length-6} autre(s)</div>` : '');
}

function renderTop() {
  var body = document.getElementById('top-body');
  var ranked = _employes
    .filter(emp => _tempsMap[emp.id] && parseFloat(_tempsMap[emp.id].heuresTravaillees) > 0)
    .map(emp => ({
      emp,
      h: parseFloat(_tempsMap[emp.id].heuresTravaillees) || 0,
      theo: heuresTheo(emp)
    }))
    .sort((a,b) => b.h - a.h);

  if (!ranked.length) {
    body.innerHTML = '<div style="font-size:12px;color:var(--muted);text-align:center;padding:10px 0">Aucune saisie ce mois</div>';
    return;
  }

  body.innerHTML = ranked.slice(0,6).map(({emp,h,theo}) => {
    var pct = theo > 0 ? (h/theo*100).toFixed(0) : '‚Äî';
    var color = getAvatarColor(emp.nom);
    var initials = ((emp.prenom||'').charAt(0)+(emp.nom||'').charAt(0)).toUpperCase();
    return `<div class="quick-emp" onclick="openSaisie('${emp.id}')">
      <div style="display:flex;align-items:center;gap:8px">
        <div class="av" style="background:${color};width:26px;height:26px;font-size:10px">${initials}</div>
        <div>
          <div class="quick-name">${emp.prenom||''} ${emp.nom||''}</div>
          <div style="font-size:10px;color:var(--muted)">${pct}% du contrat</div>
        </div>
      </div>
      <div class="quick-val ${h===0?'zero':h>theo?'sup':''}">${fmtH(h)}</div>
    </div>`;
  }).join('');
}

function renderChart() {
  var ctx = document.getElementById('chartHeures');
  if (!ctx) return;
  if (_chartH) { try { _chartH.destroy(); } catch(e) {} }

  var labels = [], reels = [], theos = [];
  _employes.forEach(emp => {
    if (!_tempsMap[emp.id]) return;
    labels.push((emp.prenom||'').charAt(0)+'.'+(emp.nom||'').split(' ')[0]);
    reels.push(parseFloat(_tempsMap[emp.id].heuresTravaillees)||0);
    theos.push(heuresTheo(emp));
  });

  if (!labels.length) { ctx.parentElement.innerHTML = '<div style="font-size:12px;color:var(--muted);text-align:center;padding:30px 0">Pas encore de donn√©es</div>'; return; }

  _chartH = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label:'R√©el', data:reels, backgroundColor:'rgba(5,150,105,0.7)', borderRadius:4 },
        { label:'Th√©o.', data:theos, backgroundColor:'rgba(209,250,229,0.8)', borderRadius:4 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position:'bottom', labels:{ font:{ size:10 }, boxWidth:12, padding:8 } } },
      scales: {
        x: { ticks:{ font:{ size:10 } }, grid:{ display:false } },
        y: { ticks:{ font:{ size:10 } }, grid:{ color:'#f1f5f9' } }
      }
    }
  });
}

// ‚ïê‚ïê SAISIE INLINE ‚ïê‚ïê
function onHInput(empId, field, value) {
  if (!_modified[empId]) {
    // Copier les donn√©es existantes
    var ex = _tempsMap[empId] || {};
    _modified[empId] = {
      employeId: empId,
      employeNom: getEmpNom(empId),
      mois: getMoisKey(),
      heuresTravaillees: parseFloat(ex.heuresTravaillees)||0,
      joursPresence: parseFloat(ex.joursPresence)||0,
      heureSup: parseFloat(ex.heureSup)||0,
      absences: parseFloat(ex.absences)||0,
      note: ex.note||''
    };
  }
  var v = parseFloat(value.replace(',','.')) || 0;
  _modified[empId][field] = v;

  // Mettre √† jour visuel input
  ['inp-h-','inp-j-','inp-s-'].forEach(pfx => {
    var el = document.getElementById(pfx+empId);
    if (el) { el.className = 'h-input modified'; }
  });

  // Afficher badge + bouton sauvegarder
  document.getElementById('unsaved-badge').style.display = '';
  document.getElementById('btn-save-all').style.display  = '';

  renderKpis();
  renderAlertes();
  renderTop();
}

function getEmpNom(empId) {
  var emp = _employes.find(e => e.id === empId);
  return emp ? (emp.prenom||'')+' '+(emp.nom||'') : '';
}

async function saveAll() {
  var ids = Object.keys(_modified);
  if (!ids.length) return;
  var btn = document.getElementById('btn-save-all');
  btn.disabled = true; btn.textContent = '‚è≥ Sauvegarde‚Ä¶';

  var ok = 0, err = 0;
  for (var empId of ids) {
    try {
      var data = { ..._modified[empId], updatedAt: new Date().toISOString() };
      var docId = getMoisKey() + '_' + empId;
      await window._setDoc(window._doc(window._db, 'rh', window._uid, 'temps', docId), data);
      _tempsMap[empId] = { id: docId, ...data };
      delete _modified[empId];
      // Feedback visuel
      ['inp-h-','inp-j-','inp-s-'].forEach(pfx => {
        var el = document.getElementById(pfx+empId);
        if (el) el.className = 'h-input saved';
      });
      ok++;
    } catch(e) { console.error(e); err++; }
  }

  document.getElementById('unsaved-badge').style.display = 'none';
  btn.style.display = 'none';
  btn.disabled = false; btn.textContent = 'üíæ Sauvegarder tout';
  showToast(err ? `${ok} sauvegard√©(s), ${err} erreur(s)` : `‚úÖ ${ok} saisie(s) sauvegard√©e(s)`, err ? 'warn' : 'ok');
  renderKpis();
}

function toggleAll() {
  // Focus sur le premier input vide
  var first = _employes.find(e => !_tempsMap[e.id] && !_modified[e.id]);
  if (first) {
    var el = document.getElementById('inp-h-'+first.id);
    if (el) { el.focus(); el.select(); }
  }
}

// ‚ïê‚ïê MODAL SAISIE D√âTAILL√âE ‚ïê‚ïê
function openSaisie(empId) {
  // Remplir le select employ√©
  var sel = document.getElementById('s-emp');
  sel.innerHTML = '<option value="">S√©lectionner‚Ä¶</option>' +
    _employes.map(e => `<option value="${e.id}" ${e.id===empId?'selected':''}>${e.prenom||''} ${e.nom||''} ‚Äî ${e.typeContrat||'CDI'} ${e.heuresHebdo||35}h</option>`).join('');

  if (empId) {
    var t = _tempsMap[empId] || _modified[empId] || {};
    document.getElementById('s-heures').value = t.heuresTravaillees || '';
    document.getElementById('s-jours').value  = t.joursPresence || '';
    document.getElementById('s-sup').value    = t.heureSup || '';
    document.getElementById('s-abs').value    = t.absences || '';
    document.getElementById('s-note').value   = t.note || '';
    onEmpChange();
  } else {
    ['s-heures','s-jours','s-sup','s-abs','s-note'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('s-recap').style.display = 'none';
  }

  document.getElementById('modal-saisie').classList.add('show');
}

function onEmpChange() {
  var empId = document.getElementById('s-emp').value;
  if (!empId) { document.getElementById('s-recap').style.display='none'; return; }
  var emp   = _employes.find(e => e.id === empId);
  if (!emp) return;
  var theo  = heuresTheo(emp);
  var recap = document.getElementById('s-recap');
  recap.style.display = '';
  recap.innerHTML = `<div class="recap-row neutral">
    <span style="font-size:11px;color:var(--muted)">Heures th√©oriques ce mois</span>
    <span style="font-size:13px;font-weight:800">${fmtH(theo)}</span>
  </div>`;
  calcEcart();
}

function calcEcart() {
  var empId = document.getElementById('s-emp').value;
  if (!empId) return;
  var emp  = _employes.find(e => e.id === empId);
  if (!emp) return;
  var theo = heuresTheo(emp);
  var reel = parseFloat(document.getElementById('s-heures').value.replace(',','.')) || 0;
  var sup  = parseFloat(document.getElementById('s-sup').value.replace(',','.'))    || 0;
  var ecart = reel - theo;
  var recap = document.getElementById('s-recap');
  var cls   = ecart > 0 ? 'green' : ecart < 0 ? 'red' : 'neutral';

  recap.innerHTML = `
    <div class="recap-row neutral"><span style="font-size:11px;color:var(--muted)">Heures th√©oriques</span><span style="font-size:13px;font-weight:800">${fmtH(theo)}</span></div>
    ${reel > 0 ? `<div class="recap-row ${cls}"><span style="font-size:11px;color:var(--muted)">√âcart (r√©el - th√©o.)</span><span style="font-size:13px;font-weight:800">${ecart>0?'+':''}${fmtH(ecart)}</span></div>` : ''}
    ${sup > 0 ? `<div class="recap-row orange"><span style="font-size:11px;color:var(--muted)">H. sup. d√©clar√©es</span><span style="font-size:13px;font-weight:800;color:#d97706">+${fmtH(sup)}</span></div>` : ''}
  `;
}

async function saveSaisie() {
  var empId = document.getElementById('s-emp').value;
  if (!empId) { showToast('S√©lectionnez un employ√©', 'warn'); return; }

  var data = {
    employeId:         empId,
    employeNom:        getEmpNom(empId),
    mois:              getMoisKey(),
    heuresTravaillees: parseFloat(document.getElementById('s-heures').value.replace(',','.')) || 0,
    joursPresence:     parseFloat(document.getElementById('s-jours').value.replace(',','.'))  || 0,
    heureSup:          parseFloat(document.getElementById('s-sup').value.replace(',','.'))    || 0,
    absences:          parseFloat(document.getElementById('s-abs').value.replace(',','.'))    || 0,
    note:              document.getElementById('s-note').value.trim(),
    updatedAt:         new Date().toISOString()
  };

  try {
    var docId = getMoisKey() + '_' + empId;
    await window._setDoc(window._doc(window._db, 'rh', window._uid, 'temps', docId), data);
    _tempsMap[empId] = { id: docId, ...data };
    delete _modified[empId];
    closeModal('modal-saisie');
    render();
    showToast('‚úÖ Saisie enregistr√©e', 'ok');
  } catch(e) {
    console.error(e);
    showToast('Erreur : ' + e.message, 'err');
  }
}

async function deleteTemps(empId) {
  if (!confirm('Supprimer la saisie de cet employ√© pour ce mois ?')) return;
  var docId = getMoisKey() + '_' + empId;
  try {
    await window._deleteDoc(window._doc(window._db, 'rh', window._uid, 'temps', docId));
    delete _tempsMap[empId];
    delete _modified[empId];
    render();
    showToast('Saisie supprim√©e', 'ok');
  } catch(e) { showToast('Erreur : '+e.message, 'err'); }
}

// ‚ïê‚ïê IMPORT DEPUIS PLANNING ‚ïê‚ïê
async function importFromPlanning() {
  var btn = document.getElementById('btn-import');
  btn.disabled = true; btn.textContent = '‚è≥ Import‚Ä¶';

  var y = _curMois.getFullYear(), m = _curMois.getMonth();
  var nb = new Date(y, m+1, 0).getDate();

  // Collecter toutes les cl√©s de semaine du mois
  var weekKeys = {};
  for (var d = 1; d <= nb; d++) {
    var dt = new Date(y, m, d);
    var mon = new Date(dt);
    var day = mon.getDay(), diff = (day===0) ? -6 : 1-day;
    mon.setDate(mon.getDate()+diff);
    mon.setHours(0,0,0,0);
    var wk = mon.toISOString().slice(0,10).replace(/-/g,'');
    weekKeys[wk] = true;
  }

  // Agr√©ger heures par employ√© depuis le planning
  var heuresParEmp = {}; // empId ‚Üí {heures, jours}
  _employes.forEach(emp => {
    heuresParEmp[emp.id] = { heures: 0, jours: 0 };
  });

  var found = false;
  for (var wk in weekKeys) {
    try {
      var snap = await window._getDocs(window._collection(window._db, 'rh', window._uid, 'plan_'+wk));
      snap.forEach(doc => {
        // cl√© = YYYY-MM-DD_empId
        var parts = doc.id.split('_');
        var empId = parts[parts.length-1];
        var dateStr = parts.slice(0, parts.length-1).join('_');
        // V√©rifier que le jour est dans le mois
        var dt2 = new Date(dateStr+'T12:00:00');
        if (dt2.getFullYear()!==y || dt2.getMonth()!==m) return;
        if (!heuresParEmp[empId]) return;
        var data = doc.data();
        var items = (data.items||[]).filter(it => it.type==='travail');
        if (!items.length) return;
        found = true;
        // Calculer heures du jour
        var hJour = items.reduce((s, it) => {
          if (it.plages && it.plages.length > 0) {
            return s + it.plages.reduce((ps,p) => {
              if (!p.deb||!p.fin) return ps;
              var a=p.deb.split(':').map(Number), b=p.fin.split(':').map(Number);
              return ps + Math.max(0,((b[0]*60+b[1])-(a[0]*60+a[1]))/60);
            }, 0);
          }
          if (!it.deb||!it.fin) return s;
          var a=it.deb.split(':').map(Number), b=it.fin.split(':').map(Number);
          return s + Math.max(0,((b[0]*60+b[1])-(a[0]*60+a[1]))/60);
        }, 0);
        heuresParEmp[empId].heures += hJour;
        heuresParEmp[empId].jours  += 1;
      });
    } catch(e) { /* semaine sans donn√©es */ }
  }

  btn.disabled = false; btn.textContent = 'üìÖ Importer du planning';

  if (!found) {
    showToast('Aucun cr√©neau planifi√© ce mois', 'warn');
    return;
  }

  // Pr√©-remplir les inputs
  var nbImported = 0;
  _employes.forEach(emp => {
    var h = heuresParEmp[emp.id];
    if (!h || h.heures === 0) return;
    if (!_modified[emp.id]) {
      var ex = _tempsMap[emp.id] || {};
      _modified[emp.id] = {
        employeId: emp.id,
        employeNom: getEmpNom(emp.id),
        mois: getMoisKey(),
        heuresTravaillees: Math.round(h.heures * 10) / 10,
        joursPresence: h.jours,
        heureSup: parseFloat(ex.heureSup)||0,
        absences: parseFloat(ex.absences)||0,
        note: ex.note||''
      };
    } else {
      _modified[emp.id].heuresTravaillees = Math.round(h.heures * 10) / 10;
      _modified[emp.id].joursPresence     = h.jours;
    }
    nbImported++;
  });

  if (nbImported > 0) {
    document.getElementById('unsaved-badge').style.display = '';
    document.getElementById('btn-save-all').style.display  = '';
  }

  renderTable();
  renderKpis();
  showToast(`üìÖ ${nbImported} employ√©(s) import√©(s) depuis le planning ‚Äî v√©rifiez puis sauvegardez`, 'ok');
}

// ‚ïê‚ïê R√âCAPITULATIF EXPORT ‚ïê‚ïê
function openExport() {
  document.getElementById('exp-titre').textContent = getMoisLabel();
  var body = document.getElementById('exp-body');

  var rows = _employes.map(emp => {
    var t    = _tempsMap[emp.id];
    var theo = heuresTheo(emp);
    var reel = parseFloat(t?.heuresTravaillees) || 0;
    var jours= parseFloat(t?.joursPresence) || 0;
    var sup  = parseFloat(t?.heureSup) || 0;
    var ecart= reel > 0 ? reel - theo : null;
    return { emp, theo, reel, jours, sup, ecart, note: t?.note||'' };
  });

  var totalReel = rows.reduce((s,r)=>s+r.reel,0);
  var totalTheo = rows.reduce((s,r)=>s+r.theo,0);
  var totalSup  = rows.reduce((s,r)=>s+r.sup,0);
  var taux = totalTheo > 0 ? (totalReel/totalTheo*100).toFixed(0) : '‚Äî';

  body.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:18px">
      <div class="recap-row green"><span style="font-size:11px;color:var(--muted)">Total heures</span><span style="font-weight:800;font-size:16px;color:var(--rh-main)">${fmtH(totalReel)}</span></div>
      <div class="recap-row neutral"><span style="font-size:11px;color:var(--muted)">Th√©oriques</span><span style="font-weight:800;font-size:16px">${fmtH(totalTheo)}</span></div>
      <div class="recap-row ${totalSup>0?'orange':'neutral'}"><span style="font-size:11px;color:var(--muted)">H. sup.</span><span style="font-weight:800;font-size:16px;color:${totalSup>0?'#d97706':'var(--text)'}">+${fmtH(totalSup)}</span></div>
    </div>
    <table style="width:100%;border-collapse:collapse;font-size:12px">
      <thead>
        <tr style="background:#fafffe;border-bottom:1px solid var(--border)">
          <th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">Employ√©</th>
          <th style="padding:8px 12px;text-align:right;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">Th√©o.</th>
          <th style="padding:8px 12px;text-align:right;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">R√©el</th>
          <th style="padding:8px 12px;text-align:right;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">Jours</th>
          <th style="padding:8px 12px;text-align:right;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">√âcart</th>
          <th style="padding:8px 12px;text-align:right;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">H. Sup.</th>
          <th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">Note</th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr style="border-bottom:1px solid #f1f5f9">
            <td style="padding:8px 12px;font-weight:600">${r.emp.prenom||''} ${r.emp.nom||''}</td>
            <td style="padding:8px 12px;text-align:right">${fmtH(r.theo)}</td>
            <td style="padding:8px 12px;text-align:right;font-weight:700;color:${r.reel>0?'var(--rh-main)':'var(--muted)'}">${r.reel>0?fmtH(r.reel):'‚Äî'}</td>
            <td style="padding:8px 12px;text-align:right">${r.jours>0?r.jours:'‚Äî'}</td>
            <td style="padding:8px 12px;text-align:right">${r.ecart!==null?(r.ecart>0?'<span style="color:var(--rh-main);font-weight:700">+'+fmtH(r.ecart)+'</span>':r.ecart<0?'<span style="color:#dc2626;font-weight:700">'+fmtH(r.ecart)+'</span>':'='):'‚Äî'}</td>
            <td style="padding:8px 12px;text-align:right;color:${r.sup>0?'#d97706':'var(--muted)'};font-weight:${r.sup>0?'700':'400'}">${r.sup>0?'+'+fmtH(r.sup):'‚Äî'}</td>
            <td style="padding:8px 12px;font-size:11px;color:var(--muted)">${r.note||''}</td>
          </tr>`).join('')}
        <tr style="background:#fafffe;font-weight:800">
          <td style="padding:10px 12px">TOTAL</td>
          <td style="padding:10px 12px;text-align:right">${fmtH(totalTheo)}</td>
          <td style="padding:10px 12px;text-align:right;color:var(--rh-main)">${fmtH(totalReel)}</td>
          <td style="padding:10px 12px;text-align:right">‚Äî</td>
          <td style="padding:10px 12px;text-align:right">${fmtEcart(totalReel-totalTheo)}</td>
          <td style="padding:10px 12px;text-align:right;color:#d97706">+${fmtH(totalSup)}</td>
          <td style="padding:10px 12px">Taux : ${taux}%</td>
        </tr>
      </tbody>
    </table>
  `;

  document.getElementById('modal-export').classList.add('show');
}

function printRecap() {
  window.print();
}

// ‚ïê‚ïê NAVIGATION MOIS ‚ïê‚ïê
function prevMois() {
  _curMois.setMonth(_curMois.getMonth()-1);
  _modified = {};
  reloadAndRender();
}
function nextMois() {
  _curMois.setMonth(_curMois.getMonth()+1);
  _modified = {};
  reloadAndRender();
}
function goToday() {
  _curMois = new Date();
  _curMois.setDate(1);
  _modified = {};
  reloadAndRender();
}

async function reloadAndRender() {
  document.getElementById('tbody').innerHTML = '<tr><td colspan="9"><div class="loader"><div class="spin"></div><span>Chargement‚Ä¶</span></div></td></tr>';
  document.getElementById('unsaved-badge').style.display = 'none';
  document.getElementById('btn-save-all').style.display  = 'none';
  await loadTemps();
  render();
}

window.prevMois = prevMois; window.nextMois = nextMois; window.goToday = goToday;
window.openSaisie = openSaisie; window.saveSaisie = saveSaisie; window.deleteTemps = deleteTemps;
window.onEmpChange = onEmpChange; window.calcEcart = calcEcart;
window.saveAll = saveAll; window.toggleAll = toggleAll;
window.importFromPlanning = importFromPlanning; window.openExport = openExport; window.printRecap = printRecap;

// ‚ïê‚ïê UTILS ‚ïê‚ïê
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
window.closeModal = closeModal;

function showToast(msg, type='') {
  var t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show '+(type||'');
  setTimeout(() => t.className='toast', 3800);
}

function toggleMobileNav() {
  var nav = document.querySelector('nav#alteore-nav, aside.sidebar, .sidebar');
  var hbg = document.getElementById('hamburger');
  var ovl = document.getElementById('navOverlay');
  if (nav) nav.classList.toggle('open');
  if (hbg) hbg.classList.toggle('open');
  if (ovl) ovl.classList.toggle('show');
}
window.toggleMobileNav = toggleMobileNav;
</script>

<script src="nav.js"></script>
<script>
(function openRhNav(){
  var tries=0;
  var t=setInterval(function(){
    var sub=document.getElementById("rh-nav-sub");
    var nav=document.getElementById("alteore-nav");
    if(sub&&nav){clearInterval(t);sub.style.maxHeight="2000px";nav.classList.add("rh-mode");}
    if(++tries>50)clearInterval(t);
  },50);
})();
</script>
</body>
</html>
