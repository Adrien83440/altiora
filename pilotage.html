<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ALTIORA ‚Äî Pilotage Mensuel</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --blue-dark:#0f1f5c;--blue-main:#1a3dce;--blue-light:#4f7ef8;
      --blue-ghost:#f0f4ff;--white:#fff;--text:#1a1f36;--muted:#6b7280;
      --border:#e2e8f0;--bg:#f5f7ff;--sidebar-w:252px;--radius:12px;
      --green:#10b981;--orange:#f59e0b;--red:#ef4444;--purple:#6366f1;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}

    /* SIDEBAR */
    .sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#0f1f5c 0%,#162366 100%);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;overflow-y:auto;}
    .sidebar-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 22px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:10px;}
    .sidebar-logo-icon{width:36px;height:36px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .sidebar-logo-text{font-size:18px;font-weight:800;color:white;letter-spacing:1px;}
    .sidebar-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,0.3);letter-spacing:1.2px;text-transform:uppercase;padding:14px 20px 5px;}
    .nav-item{display:flex;align-items:center;gap:11px;padding:10px 20px;color:rgba(255,255,255,0.6);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;user-select:none;}
    .nav-item:hover{color:white;background:rgba(255,255,255,0.06);}
    .nav-item.active{color:white;background:rgba(255,255,255,0.1);border-left-color:#4f7ef8;}
    .nav-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0;}
    .nav-label{flex:1;}
    .nav-chevron{font-size:11px;color:rgba(255,255,255,0.3);transition:transform 0.25s;margin-left:auto;}
    .nav-item.open .nav-chevron{transform:rotate(90deg);}
    .submenu{overflow:hidden;max-height:0;transition:max-height 0.3s ease;}
    .submenu.open{max-height:300px;}
    .sub-item{display:flex;align-items:center;gap:9px;padding:8px 20px 8px 44px;color:rgba(255,255,255,0.45);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;}
    .sub-item:hover{color:rgba(255,255,255,0.8);background:rgba(255,255,255,0.05);}
    .sub-item.active{color:white;background:rgba(79,126,248,0.15);border-left-color:rgba(79,126,248,0.6);}
    .sub-dot{width:5px;height:5px;background:rgba(255,255,255,0.3);border-radius:50%;flex-shrink:0;}
    .sub-item.active .sub-dot{background:#4f7ef8;}
    .sub-year-badge{margin-left:auto;font-size:10px;color:rgba(255,255,255,0.25);font-weight:600;}
    .sidebar-footer{margin-top:auto;padding:16px 20px 0;border-top:1px solid rgba(255,255,255,0.08);}
    .user-card{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.07);border-radius:10px;}
    .user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--blue-light),#6366f1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
    .user-name{font-size:12px;font-weight:600;color:white;}
    .user-plan{font-size:10px;color:rgba(255,255,255,0.4);}
    .logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:14px;padding:4px;}
    .logout-btn:hover{color:rgba(255,255,255,0.7);}

    /* MAIN */
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:17px;font-weight:700;color:var(--text);}
    .topbar-left p{font-size:12px;color:var(--muted);}
    .topbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    select.month-select{padding:7px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;color:var(--text);background:white;cursor:pointer;outline:none;}
    select.month-select:focus{border-color:var(--blue-main);}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;}
    .btn-primary{background:linear-gradient(135deg,var(--blue-main),var(--blue-light));color:white;box-shadow:0 3px 10px rgba(26,61,206,0.3);}
    .btn-primary:hover{opacity:0.9;transform:translateY(-1px);}
    .btn-success{background:linear-gradient(135deg,#10b981,#34d399);color:white;box-shadow:0 3px 10px rgba(16,185,129,0.3);}
    .btn-orange{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:white;}
    .btn-outline{background:white;color:var(--blue-main);border:1.5px solid var(--border);}
    .btn-outline:hover{border-color:var(--blue-main);background:var(--blue-ghost);}
    .btn-sm{padding:5px 10px;font-size:12px;}
    .btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}
    .btn-danger:hover{background:#fee2e2;}

    .content{padding:20px 28px;flex:1;}

    /* SUMMARY */
    .summary-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:20px;}
    .sum-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:16px;position:relative;overflow:hidden;}
    .sum-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
    .sum-card.blue::before{background:linear-gradient(90deg,var(--blue-main),var(--blue-light));}
    .sum-card.green::before{background:linear-gradient(90deg,#10b981,#34d399);}
    .sum-card.orange::before{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
    .sum-card.red::before{background:linear-gradient(90deg,#ef4444,#f87171);}
    .sum-card.purple::before{background:linear-gradient(90deg,#6366f1,#a5b4fc);}
    .sum-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:5px;}
    .sum-value{font-size:18px;font-weight:800;color:var(--text);letter-spacing:-0.5px;}
    .sum-value.positive{color:var(--green);}
    .sum-value.negative{color:var(--red);}
    .sum-sub{font-size:11px;color:var(--muted);margin-top:3px;}

    /* SECTIONS */
    .sections-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
    .section-card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .section-card.full{grid-column:1/-1;}
    .section-head{display:flex;align-items:center;justify-content:space-between;padding:13px 18px;border-bottom:1px solid var(--border);}
    .section-title{font-size:13px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px;}
    .section-title-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;}
    .badge-blue{background:var(--blue-ghost);color:var(--blue-main);}
    .badge-green{background:#f0fdf4;color:#10b981;}
    .badge-orange{background:#fffbeb;color:#f59e0b;}
    .badge-purple{background:#eef2ff;color:#6366f1;}
    .badge-red{background:#fef2f2;color:#ef4444;}
    .section-actions{display:flex;gap:8px;align-items:center;}

    /* TABLE */
    .data-table{width:100%;border-collapse:collapse;}
    .data-table th{padding:8px 10px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;background:#f8faff;border-bottom:1px solid var(--border);white-space:nowrap;}
    .data-table td{padding:5px 7px;border-bottom:1px solid #f1f5f9;vertical-align:middle;}
    .data-table tr:last-child td{border-bottom:none;}
    .data-table tr:hover td{background:#fafbff;}
    .data-table tfoot td{padding:9px 10px;font-weight:700;background:#f8faff;border-top:2px solid var(--border);font-size:12px;}

    /* credit type rows */
    .row-principal td{background:#fffbeb;}
    .row-interet td{background:#f0fdf4;}
    .row-type-label{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px;}
    .row-type-label.principal{background:#fef3c7;color:#92400e;}
    .row-type-label.interet{background:#d1fae5;color:#065f46;}

    /* INPUTS */
    .cell-input{width:100%;padding:5px 7px;border:1.5px solid transparent;border-radius:6px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;color:var(--text);background:transparent;outline:none;transition:all 0.15s;}
    .cell-input:focus{border-color:var(--blue-main);background:white;box-shadow:0 0 0 2px rgba(26,61,206,0.08);}
    .cell-input:hover{background:#f8faff;}
    select.cell-input{cursor:pointer;}
    .cell-readonly{padding:5px 7px;font-size:12px;font-weight:600;color:var(--text);}
    .cell-readonly.green{color:var(--green);}
    .cell-readonly.red{color:var(--red);}
    .cell-readonly.blue{color:var(--blue-main);}
    .cell-readonly.orange{color:var(--orange);}

    /* TVA */
    .tva-result{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;padding:16px 18px;}
    .tva-box{padding:14px 16px;border-radius:10px;text-align:center;}
    .tva-box.due{background:#fef2f2;border:1px solid #fecaca;}
    .tva-box.credit{background:#f0fdf4;border:1px solid #bbf7d0;}
    .tva-box.neutral{background:var(--blue-ghost);border:1px solid #c7d2fe;}
    .tva-box-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;}
    .tva-box-value{font-size:20px;font-weight:800;}
    .tva-box.due .tva-box-value{color:var(--red);}
    .tva-box.credit .tva-box-value{color:var(--green);}
    .tva-box.neutral .tva-box-value{color:var(--blue-main);}

    /* CASHFLOW */
    .cashflow-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;padding:16px 18px;}
    .cf-box{padding:14px 16px;border-radius:10px;border:1px solid var(--border);}
    .cf-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;}
    .cf-value{font-size:18px;font-weight:800;color:var(--text);}
    .cf-value.positive{color:var(--green);}
    .cf-value.negative{color:var(--red);}

    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(15,31,92,0.4);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;padding:28px;width:100%;max-width:480px;box-shadow:0 20px 60px rgba(15,31,92,0.2);}
    .modal h3{font-size:16px;font-weight:700;margin-bottom:6px;}
    .modal p{font-size:13px;color:var(--muted);margin-bottom:16px;line-height:1.6;}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all 0.3s;display:flex;align-items:center;gap:8px;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.success{background:#10b981;}
    .toast.warning{background:#f59e0b;}

    .loader{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--muted);font-size:13px;gap:10px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--blue-main);border-radius:50%;animation:spin .7s linear infinite;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .content{animation:fadeIn 0.3s ease both;}

    /* info box */
    .info-box{background:var(--blue-ghost);border:1px solid #c7d2fe;border-radius:8px;padding:8px 12px;font-size:11px;color:var(--blue-main);font-weight:500;margin:0 18px 12px;}
  .ucard:hover{background:rgba(255,255,255,.12);transform:translateY(-1px);transition:.15s}
</style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon">üìä</div>
    <div class="sidebar-logo-text">ALTIORA</div>
  </div>
  <div class="sidebar-section-label">Principal</div>
  <div class="nav-item" onclick="window.location.href='dashboard.html'"><span class="nav-icon">üè†</span><span class="nav-label">Tableau de bord</span></div>
  <div class="nav-item" onclick="window.location.href='suivi-ca.html'"><span class="nav-icon">üìà</span><span class="nav-label">Suivi CA & R√©sultats</span></div>
  <div class="nav-item" id="kpis-nav" onclick="toggleMenu('kpis-menu',this)"><span class="nav-icon">üéØ</span><span class="nav-label">KPIs Cl√©s</span><span class="nav-chevron">‚Ä∫</span></div>
  <div class="submenu open" id="kpis-menu">
    <div class="sub-item" onclick="window.location.href='cout-revient.html'"><span class="sub-dot"></span>Co√ªt de revient</div>
    <div class="sub-item" onclick="window.location.href='marges.html'"><span class="sub-dot"></span>Marge brute & nette</div>
    <div class="sub-item"><span class="sub-dot"></span>Panier moyen</div>
  </div>
  <div class="nav-item active" onclick="toggleMenu('pilotage-menu',this)"><span class="nav-icon">üß≠</span><span class="nav-label">Pilotage</span><span class="nav-chevron">‚Ä∫</span></div>
  <div class="submenu open" id="pilotage-menu">
    <div class="sub-item" onclick="setYear(2025,this)"><span class="sub-dot"></span>Pilotage 2025<span class="sub-year-badge">2025</span></div>
    <div class="sub-item active" onclick="setYear(2026,this)"><span class="sub-dot"></span>Pilotage 2026<span class="sub-year-badge">2026</span></div>
    <div class="sub-item" onclick="setYear(2027,this)"><span class="sub-dot"></span>Pilotage 2027<span class="sub-year-badge">2027</span></div>
  </div>
  <div class="nav-item" onclick="window.location.href='dashboard.html'"><span class="nav-icon">üè¶</span><span class="nav-label">Dettes & Emprunts</span></div>
  <div class="sidebar-footer">
    <div class="user-card" onclick="location.href=\'profil.html\'" style="cursor:pointer" title="Mon compte">
      <div class="user-avatar" id="userAvatar">A</div>
      <div><div class="user-name" id="userName">Utilisateur</div><div class="user-plan">Plan gratuit</div></div>
      <button class="logout-btn" onclick="handleLogout()">‚éã</button>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1 id="topTitle">Pilotage ‚Äî Janvier 2026</h1>
      <p id="topSub">Saisie et suivi mensuel complet</p>
    </div>
    <div class="topbar-right">
      <select class="month-select" id="monthSelect" onchange="loadMonth()">
        <option value="0">Janvier</option><option value="1">F√©vrier</option>
        <option value="2">Mars</option><option value="3">Avril</option>
        <option value="4">Mai</option><option value="5">Juin</option>
        <option value="6">Juillet</option><option value="7">Ao√ªt</option>
        <option value="8">Septembre</option><option value="9">Octobre</option>
        <option value="10">Novembre</option><option value="11">D√©cembre</option>
      </select>
      <button class="btn btn-orange btn-sm" onclick="openFixedChargesModal()">‚ö° Charges fixes ‚Üí Ann√©e</button>
      <button class="btn btn-success btn-sm" onclick="saveAll()">üíæ Sauvegarder</button>
    </div>
  </div>

  <div class="content" id="mainContent">
    <div class="loader"><div class="spin"></div> Chargement...</div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="fixedModal">
  <div class="modal">
    <h3>‚ö° Appliquer les charges fixes</h3>
    <p>Les charges fixes de ce mois seront copi√©es sur tous les mois <strong>sans charges saisies</strong> pour l'ann√©e en cours.</p>
    <div style="background:var(--blue-ghost);border-radius:10px;padding:12px 16px;font-size:12px;color:var(--blue-main);font-weight:600;">‚ö†Ô∏è Les mois d√©j√† renseign√©s ne seront pas √©cras√©s.</div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">Annuler</button>
      <button class="btn btn-orange" onclick="applyFixedCharges()">Appliquer sur toute l'ann√©e</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth = getAuth(app);
  const db = getFirestore(app);
  window._auth=auth;window._db=db;
  window._doc=doc;window._setDoc=setDoc;window._getDoc=getDoc;
  window._signOut=signOut;
  onAuthStateChanged(auth, user=>{
    if(!user){window.location.href='index.html';return;}
    window._uid=user.uid;
    const name=user.displayName||user.email.split('@')[0];
    document.getElementById('userName').textContent=name;
    document.getElementById('userAvatar').textContent=name.charAt(0).toUpperCase();
    const now=new Date();
    document.getElementById('monthSelect').value=now.getMonth();
    const urlYear = new URLSearchParams(window.location.search).get("year");
    window._year = urlYear ? parseInt(urlYear) : now.getFullYear();
    loadMonth();
  });
</script>

<script>
const MONTHS=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
const TVA_RATES=[0,5.5,10,20];
window._year=new Date().getFullYear();
let _data={};

function getMonthKey(){const m=parseInt(document.getElementById('monthSelect').value);return `${window._year}-${String(m+1).padStart(2,'0')}`;}
function getMonthLabel(){const m=parseInt(document.getElementById('monthSelect').value);return `${MONTHS[m]} ${window._year}`;}

function setYear(y,el){
  window._year=y;
  document.querySelectorAll('.sub-item').forEach(s=>s.classList.remove('active'));
  el.classList.add('active');
  loadMonth();
}
function toggleMenu(id,el){document.getElementById(id).classList.toggle('open');el.classList.toggle('open');}

function defaultData(year,month){
  const days=new Date(year,month+1,0).getDate();
  return {
    ca: Array.from({length:days},(_,i)=>({date:`${i+1}/${month+1}/${year}`,montantHT:'',tvaRate:20})),
    rentreesSupp:[{type:'Aides / subventions',montant:''},{type:'Apports personnels',montant:''},{type:'Remboursements',montant:''},{type:'Autres recettes',montant:''}],
    previsionCA:[{type:'Ventes clients',montant:''},{type:'Services',montant:''},{type:'Aides',montant:''}],
    chargesFixe:[{fournisseur:'',type:'',montantHT:'',tvaRate:20,deductible:'Oui',pointe:'Non'}],
    chargesVar:[{fournisseur:'',type:'',montantHT:'',tvaRate:20,deductible:'Oui',pointe:'Non'}],
    credits:[
      {fournisseur:'',nom:'',ligneType:'principal',montant:'',tvaRate:20,tvaAuto:false,tauxInteret:'',pointe:'Non'},
    ],
    leasing:[{fournisseur:'',type:'',montantHT:'',tvaRate:20,deductible:'Oui',pointe:'Non'}],
  };
}

async function loadMonth(){
  const key=getMonthKey();
  document.getElementById('topTitle').textContent=`Pilotage ‚Äî ${getMonthLabel()}`;
  document.getElementById('mainContent').innerHTML='<div class="loader"><div class="spin"></div> Chargement...</div>';
  const m=parseInt(document.getElementById('monthSelect').value);
  let data=defaultData(window._year,m);
  if(window._uid){
    try{
      const snap=await window._getDoc(window._doc(window._db,'pilotage',window._uid,'months',key));
      if(snap.exists()){
        const s=snap.data();
        if(s.ca&&s.ca.length===data.ca.length)data.ca=s.ca;
        if(s.rentreesSupp)data.rentreesSupp=s.rentreesSupp;
        if(s.previsionCA)data.previsionCA=s.previsionCA;
        if(s.chargesFixe)data.chargesFixe=s.chargesFixe;
        if(s.chargesVar)data.chargesVar=s.chargesVar;
        if(s.credits)data.credits=s.credits;
        if(s.leasing)data.leasing=s.leasing;
      }
    }catch(e){console.warn(e);}
  }
  _data=data;
  renderPage(data,m);
}

function renderPage(data,month){
  const t=calcTotals(data);
  document.getElementById('mainContent').innerHTML=`
    <div class="summary-grid">
      <div class="sum-card blue"><div class="sum-label">CA HT du mois</div><div class="sum-value" id="s-ca">${fmt(t.caHT)}</div><div class="sum-sub">Pr√©vision : ${fmtE(t.prevCA)}</div></div>
      <div class="sum-card orange"><div class="sum-label">Charges totales HT</div><div class="sum-value" id="s-ch">${fmt(t.chargesHT)}</div><div class="sum-sub">Fixes ${fmtE(t.fixesHT)} ¬∑ Var. ${fmtE(t.varHT)}</div></div>
      <div class="sum-card ${t.resultat>=0?'green':'red'}"><div class="sum-label">R√©sultat HT</div><div class="sum-value ${t.resultat>=0?'positive':'negative'}" id="s-res">${fmt(t.resultat)}</div><div class="sum-sub">CA ‚àí D√©penses</div></div>
      <div class="sum-card purple"><div class="sum-label">TVA collect√©e</div><div class="sum-value" id="s-tvac">${fmt(t.tvaCollectee)}</div><div class="sum-sub">Sur les ventes</div></div>
      <div class="sum-card ${t.tvaDue>=0?'red':'green'}"><div class="sum-label">TVA due / cr√©dit</div><div class="sum-value ${t.tvaDue>=0?'negative':'positive'}" id="s-tvad">${fmt(t.tvaDue)}</div><div class="sum-sub">${t.tvaDue>=0?'üî¥ √Ä payer':'üü¢ Cr√©dit TVA'}</div></div>
    </div>

    <!-- CA JOURNALIER + RENTR√âES -->
    <div class="sections-grid">
      <div class="section-card">
        <div class="section-head"><div class="section-title">üìÖ CA Journalier HT <span class="section-title-badge badge-blue">${MONTHS[month]} ${window._year}</span></div></div>
        <table class="data-table">
          <thead><tr><th>Date</th><th>Montant HT</th><th>TVA %</th><th>Total TTC</th><th>TVA collect√©e</th></tr></thead>
          <tbody id="ca-tbody">${renderCARows(data.ca)}</tbody>
          <tfoot><tr><td>TOTAL</td><td><span id="tot-caHT">${fmtN(t.caHT)}</span> ‚Ç¨</td><td>‚Äî</td><td><span id="tot-caTTC">${fmtN(t.caTTC)}</span> ‚Ç¨</td><td><span id="tot-tvaC">${fmtN(t.tvaCollectee)}</span> ‚Ç¨</td></tr></tfoot>
        </table>
      </div>
      <div style="display:flex;flex-direction:column;gap:16px;">
        <div class="section-card">
          <div class="section-head"><div class="section-title">üí∏ Rentr√©es suppl√©mentaires</div><button class="btn btn-outline btn-sm" onclick="addRentree()">+ Ajouter</button></div>
          <table class="data-table">
            <thead><tr><th>Type</th><th>Montant</th><th></th></tr></thead>
            <tbody id="rsupp-tbody">${renderRentrees(data.rentreesSupp)}</tbody>
            <tfoot><tr><td>TOTAL NET</td><td><span id="tot-rsupp">${fmtN(t.rentreesSupp)}</span> ‚Ç¨</td><td></td></tr></tfoot>
          </table>
        </div>
        <div class="section-card">
          <div class="section-head"><div class="section-title">üéØ Pr√©vision CA du mois</div></div>
          <table class="data-table">
            <thead><tr><th>Type</th><th>Montant pr√©vu</th></tr></thead>
            <tbody id="prev-tbody">${renderPrevCA(data.previsionCA)}</tbody>
            <tfoot><tr><td>Total HT</td><td><span id="tot-prev">${fmtN(t.prevCA)}</span> ‚Ç¨</td></tr></tfoot>
          </table>
        </div>
      </div>
    </div>

    <!-- CHARGES FIXES -->
    <div class="section-card full" style="margin-bottom:16px;">
      <div class="section-head">
        <div class="section-title">üîí Charges Fixes <span class="section-title-badge badge-orange">Pr√©visionnel</span></div>
        <div class="section-actions">
          <button class="btn btn-outline btn-sm" onclick="addCharge('chargesFixe','cf-tbody')">+ Ligne</button>
          <button class="btn btn-orange btn-sm" onclick="openFixedChargesModal()">‚ö° Appliquer sur l'ann√©e</button>
        </div>
      </div>
      <table class="data-table">
        <thead><tr><th>Point√©</th><th>Fournisseur</th><th>Type</th><th>Montant HT</th><th>TVA %</th><th>Total TTC</th><th>D√©ductible</th><th></th></tr></thead>
        <tbody id="cf-tbody">${renderCharges(data.chargesFixe,'chargesFixe')}</tbody>
        <tfoot><tr><td colspan="3">TOTAL CHARGES FIXES HT</td><td><span id="tot-fixHT">${fmtN(t.fixesHT)}</span> ‚Ç¨</td><td>‚Äî</td><td><span id="tot-fixTTC">${fmtN(t.fixesTTC)}</span> ‚Ç¨</td><td colspan="2">TVA d√©d. : <span id="tot-fixTVA">${fmtN(t.fixesTVA)}</span> ‚Ç¨</td></tr></tfoot>
      </table>
    </div>

    <!-- CHARGES VARIABLES -->
    <div class="section-card full" style="margin-bottom:16px;">
      <div class="section-head">
        <div class="section-title">üì¶ Charges Variables <span class="section-title-badge badge-green">Au fil de l'eau</span></div>
        <button class="btn btn-outline btn-sm" onclick="addCharge('chargesVar','cv-tbody')">+ Ligne</button>
      </div>
      <table class="data-table">
        <thead><tr><th>Point√©</th><th>Fournisseur</th><th>Type</th><th>Montant HT</th><th>TVA %</th><th>Total TTC</th><th>D√©ductible</th><th></th></tr></thead>
        <tbody id="cv-tbody">${renderCharges(data.chargesVar,'chargesVar')}</tbody>
        <tfoot><tr><td colspan="3">TOTAL CHARGES VARIABLES HT</td><td><span id="tot-varHT">${fmtN(t.varHT)}</span> ‚Ç¨</td><td>‚Äî</td><td><span id="tot-varTTC">${fmtN(t.varTTC)}</span> ‚Ç¨</td><td colspan="2">TVA d√©d. : <span id="tot-varTVA">${fmtN(t.varTVA)}</span> ‚Ç¨</td></tr></tfoot>
      </table>
    </div>

    <!-- CR√âDITS & LEASING -->
    <div class="sections-grid" style="margin-bottom:16px;">
      <div class="section-card">
        <div class="section-head">
          <div class="section-title">üè¶ Cr√©dits & Emprunts <span class="section-title-badge badge-purple">Principal + Int√©r√™ts</span></div>
          <div class="section-actions">
            <button class="btn btn-outline btn-sm" onclick="addCredit('principal')">+ Principal</button>
            <button class="btn btn-outline btn-sm" onclick="addCredit('interet')">+ Int√©r√™ts</button>
          </div>
        </div>
        <div class="info-box">üí° Principal = sans TVA ¬∑ Int√©r√™ts = TVA d√©ductible (saisie manuelle ou calcul auto depuis un taux)</div>
        <table class="data-table">
          <thead><tr><th>Point√©</th><th>Fournisseur / Cr√©dit</th><th>Ligne</th><th>Montant</th><th>Taux int. %</th><th>TVA %</th><th>TVA d√©d.</th><th></th></tr></thead>
          <tbody id="cred-tbody">${renderCredits(data.credits)}</tbody>
          <tfoot><tr>
            <td colspan="3">TOTAL CR√âDITS</td>
            <td><span id="tot-credP">${fmtN(t.creditsPrincipal)}</span> ‚Ç¨</td>
            <td>‚Äî</td><td>‚Äî</td>
            <td>TVA d√©d. : <span id="tot-credTVA">${fmtN(t.creditsTVA)}</span> ‚Ç¨</td>
            <td></td>
          </tr></tfoot>
        </table>
      </div>
      <div class="section-card">
        <div class="section-head">
          <div class="section-title">üöó LOA / LLD / Leasing <span class="section-title-badge badge-blue">Soumis TVA</span></div>
          <button class="btn btn-outline btn-sm" onclick="addCharge('leasing','leas-tbody')">+ Ligne</button>
        </div>
        <table class="data-table">
          <thead><tr><th>Point√©</th><th>Fournisseur</th><th>Type</th><th>Montant HT</th><th>TVA %</th><th>Total TTC</th><th>D√©d.</th><th></th></tr></thead>
          <tbody id="leas-tbody">${renderCharges(data.leasing,'leasing')}</tbody>
          <tfoot><tr><td colspan="3">TOTAL LEASING HT</td><td><span id="tot-leasHT">${fmtN(t.leasingHT)}</span> ‚Ç¨</td><td>‚Äî</td><td><span id="tot-leasTTC">${fmtN(t.leasingTTC)}</span> ‚Ç¨</td><td colspan="2"></td></tr></tfoot>
        </table>
      </div>
    </div>

    <!-- TVA & CASHFLOW -->
    <div class="sections-grid">
      <div class="section-card">
        <div class="section-head"><div class="section-title">üßæ Bilan TVA du mois</div></div>
        <div class="tva-result">
          <div class="tva-box neutral"><div class="tva-box-label">TVA Collect√©e</div><div class="tva-box-value" id="tva-c">${fmtN(t.tvaCollectee)} ‚Ç¨</div></div>
          <div class="tva-box neutral"><div class="tva-box-label">TVA D√©ductible</div><div class="tva-box-value" id="tva-d">${fmtN(t.tvaDed)} ‚Ç¨</div></div>
          <div class="tva-box ${t.tvaDue>=0?'due':'credit'}"><div class="tva-box-label">${t.tvaDue>=0?'TVA √† payer':'Cr√©dit TVA'}</div><div class="tva-box-value" id="tva-due">${fmtN(Math.abs(t.tvaDue))} ‚Ç¨</div></div>
        </div>
      </div>
      <div class="section-card">
        <div class="section-head"><div class="section-title">üí∞ Cashflow & R√©sultats</div></div>
        <div class="cashflow-grid">
          <div class="cf-box"><div class="cf-label">Cashflow r√©el</div><div class="cf-value ${t.cashflow>=0?'positive':'negative'}" id="cf-val">${fmt(t.cashflow)}</div></div>
          <div class="cf-box"><div class="cf-label">R√©sultat Pr√©vi</div><div class="cf-value" id="cf-prev">${fmt(t.prevCA-t.chargesHT)}</div></div>
          <div class="cf-box"><div class="cf-label">Delta Pr√©vi/R√©el</div><div class="cf-value ${t.delta>=0?'positive':'negative'}" id="cf-delta">${fmt(t.delta)}</div></div>
        </div>
      </div>
    </div>
  `;
}

/* ‚îÄ‚îÄ RENDERERS ‚îÄ‚îÄ */
function renderCARows(rows){
  return rows.map((r,i)=>`<tr>
    <td><span style="font-size:12px;color:var(--muted)">${r.date}</span></td>
    <td><input class="cell-input" style="width:85px" type="number" placeholder="0.00" value="${r.montantHT}" oninput="updateCA(${i},'montantHT',this.value)"/></td>
    <td><select class="cell-input" style="width:65px" onchange="updateCA(${i},'tvaRate',this.value)">${TVA_RATES.map(t=>`<option value="${t}" ${r.tvaRate==t?'selected':''}>${t}%</option>`).join('')}</select></td>
    <td><span class="cell-readonly blue">${r.montantHT?fmtN(parseFloat(r.montantHT)*(1+r.tvaRate/100)):'‚Äî'}</span></td>
    <td><span class="cell-readonly green">${r.montantHT?fmtN(parseFloat(r.montantHT)*r.tvaRate/100):'‚Äî'}</span></td>
  </tr>`).join('');
}

function renderRentrees(rows){
  return rows.map((r,i)=>`<tr>
    <td><input class="cell-input" style="width:140px" value="${r.type}" oninput="_data.rentreesSupp[${i}].type=this.value;refreshTotals()"/></td>
    <td><input class="cell-input" style="width:90px" type="number" placeholder="0.00" value="${r.montant}" oninput="_data.rentreesSupp[${i}].montant=this.value;refreshTotals()"/></td>
    <td><button class="btn btn-danger btn-sm" onclick="delRow('rentreesSupp',${i},'rsupp-tbody',renderRentrees)">‚úï</button></td>
  </tr>`).join('');
}

function renderPrevCA(rows){
  return rows.map((r,i)=>`<tr>
    <td><input class="cell-input" style="width:140px" value="${r.type}" oninput="_data.previsionCA[${i}].type=this.value"/></td>
    <td><input class="cell-input" style="width:90px" type="number" placeholder="0.00" value="${r.montant}" oninput="_data.previsionCA[${i}].montant=this.value;refreshTotals()"/></td>
  </tr>`).join('');
}

function renderCharges(rows,key){
  const tbId=key==='chargesFixe'?'cf-tbody':key==='chargesVar'?'cv-tbody':'leas-tbody';
  const isFixe=key==='chargesFixe';
  return rows.map((r,i)=>{
    const ht=parseFloat(r.montantHT)||0;
    const rate=parseFloat(r.tvaRate)||0;
    const ttc=ht>0?ht*(1+rate/100):0;
    return `<tr>
    <td><select class="cell-input" style="width:55px" onchange="_data['${key}'][${i}].pointe=this.value"><option ${r.pointe==='Oui'?'selected':''}>Oui</option><option ${r.pointe==='Non'?'selected':''}>Non</option></select></td>
    <td><input class="cell-input" style="width:95px" placeholder="Fournisseur" value="${r.fournisseur}" oninput="_data['${key}'][${i}].fournisseur=this.value"/></td>
    <td><input class="cell-input" style="width:95px" placeholder="Type" value="${r.type}" oninput="_data['${key}'][${i}].type=this.value"/></td>
    <td><input class="cell-input" style="width:76px" type="number" placeholder="HT" value="${r.montantHT}" id="${key}-ht-${i}" oninput="updateChargeHT('${key}',${i},this.value)"/></td>
    <td><select class="cell-input" style="width:55px" onchange="updateChargeTVARate('${key}',${i},this.value)">${TVA_RATES.map(t=>`<option value="${t}" ${rate==t?'selected':''}>${t}%</option>`).join('')}</select></td>
    <td><input class="cell-input" style="width:76px" type="number" placeholder="TTC" value="${ttc>0?ttc.toFixed(2):''}" id="${key}-ttc-${i}" oninput="updateChargeTTC('${key}',${i},this.value)"/></td>
    <td><select class="cell-input" style="width:55px" onchange="_data['${key}'][${i}].deductible=this.value;refreshTotals()"><option ${r.deductible==='Oui'?'selected':''}>Oui</option><option ${r.deductible==='Non'?'selected':''}>Non</option></select></td>
    <td style="white-space:nowrap;display:flex;gap:4px;align-items:center;padding:5px 7px;">
      ${isFixe?`<button class="btn btn-orange btn-sm" style="font-size:10px;padding:3px 8px;" title="Appliquer cette ligne sur toute l'ann√©e" onclick="duplicateFixeLine(${i})">‚ö° Ann√©e</button>`:''}
      <button class="btn btn-danger btn-sm" onclick="delRow('${key}',${i},'${tbId}',r=>renderCharges(r,'${key}'))">‚úï</button>
    </td>
  </tr>`;
  }).join('');
}

function updateChargeHT(key,i,value){
  _data[key][i].montantHT=value;
  const ht=parseFloat(value)||0;
  const rate=parseFloat(_data[key][i].tvaRate)||0;
  const ttcEl=document.getElementById(`${key}-ttc-${i}`);
  if(ttcEl)ttcEl.value=ht>0?(ht*(1+rate/100)).toFixed(2):'';
  refreshTotals();
}

function updateChargeTTC(key,i,value){
  const ttc=parseFloat(value)||0;
  const rate=parseFloat(_data[key][i].tvaRate)||0;
  const ht=ttc>0?(rate>0?ttc/(1+rate/100):ttc):0;
  _data[key][i].montantHT=ht>0?ht.toFixed(4):'';
  const htEl=document.getElementById(`${key}-ht-${i}`);
  if(htEl)htEl.value=ht>0?ht.toFixed(2):'';
  refreshTotals();
}

function updateChargeTVARate(key,i,value){
  _data[key][i].tvaRate=parseFloat(value);
  const ht=parseFloat(_data[key][i].montantHT)||0;
  if(ht>0){
    const ttcEl=document.getElementById(`${key}-ttc-${i}`);
    if(ttcEl)ttcEl.value=(ht*(1+parseFloat(value)/100)).toFixed(2);
  }
  refreshTotals();
}

async function duplicateFixeLine(i){
  if(!window._uid){showToast('Non connect√©','warning');return;}
  const currentM=parseInt(document.getElementById('monthSelect').value);
  const ligne=JSON.parse(JSON.stringify(_data.chargesFixe[i]));
  let count=0;
  for(let m=0;m<12;m++){
    if(m===currentM)continue;
    const key=`${window._year}-${String(m+1).padStart(2,'0')}`;
    try{
      const snap=await window._getDoc(window._doc(window._db,'pilotage',window._uid,'months',key));
      let md=defaultData(window._year,m);
      if(snap.exists())md={...md,...snap.data()};
      if(!md.chargesFixe)md.chargesFixe=[];
      const exists=md.chargesFixe.some(c=>c.fournisseur===ligne.fournisseur&&c.type===ligne.type);
      if(!exists){md.chargesFixe.push(ligne);await window._setDoc(window._doc(window._db,'pilotage',window._uid,'months',key),md);count++;}
    }catch(e){console.warn(e);}
  }
  showToast(`‚ö° "${ligne.fournisseur||ligne.type||'Ligne'}" appliqu√©e sur ${count} mois !`,'success');
}

function renderCredits(rows){
  return rows.map((r,i)=>{
    const isPrincipal = r.ligneType==='principal';
    const montant = parseFloat(r.montant)||0;
    const taux = parseFloat(r.tauxInteret)||0;
    // Si int√©r√™t avec taux auto : montant = principal * taux / 100 / 12
    let montantCalc = montant;
    let tvaAmount = 0;
    if(!isPrincipal){
      if(r.tvaAuto && taux>0){
        // cherche le principal du m√™me fournisseur
        const principal = _data.credits.find((c,j)=>j<i&&c.fournisseur===r.fournisseur&&c.ligneType==='principal');
        if(principal) montantCalc = (parseFloat(principal.montant)||0)*taux/100/12;
      }
      tvaAmount = montantCalc*(parseFloat(r.tvaRate)||20)/100;
    }
    return `<tr class="${isPrincipal?'row-principal':'row-interet'}">
      <td><select class="cell-input" style="width:58px" onchange="_data.credits[${i}].pointe=this.value"><option ${r.pointe==='Oui'?'selected':''}>Oui</option><option ${r.pointe==='Non'?'selected':''}>Non</option></select></td>
      <td><input class="cell-input" style="width:110px" placeholder="Nom cr√©dit" value="${r.fournisseur}" oninput="_data.credits[${i}].fournisseur=this.value;refreshCredits()"/></td>
      <td><span class="row-type-label ${isPrincipal?'principal':'interet'}">${isPrincipal?'üí≥ Principal':'üíπ Int√©r√™ts'}</span></td>
      <td>
        ${isPrincipal
          ? `<input class="cell-input" style="width:80px" type="number" placeholder="0.00" value="${r.montant}" oninput="_data.credits[${i}].montant=this.value;refreshCredits()"/>`
          : r.tvaAuto
            ? `<span class="cell-readonly orange">${fmtN(montantCalc)} ‚Ç¨</span>`
            : `<input class="cell-input" style="width:80px" type="number" placeholder="0.00" value="${r.montant}" oninput="_data.credits[${i}].montant=this.value;refreshCredits()"/>`
        }
      </td>
      <td>
        ${!isPrincipal
          ? `<input class="cell-input" style="width:65px" type="number" placeholder="%" value="${r.tauxInteret}" oninput="_data.credits[${i}].tauxInteret=this.value;_data.credits[${i}].tvaAuto=(this.value>0);refreshCredits()"/>`
          : `<span style="color:var(--muted);font-size:12px">‚Äî</span>`
        }
      </td>
      <td>
        ${!isPrincipal
          ? `<select class="cell-input" style="width:58px" onchange="_data.credits[${i}].tvaRate=parseFloat(this.value);refreshCredits()">${TVA_RATES.map(t=>`<option value="${t}" ${(r.tvaRate||20)==t?'selected':''}>${t}%</option>`).join('')}</select>`
          : `<span style="color:var(--muted);font-size:12px">Sans TVA</span>`
        }
      </td>
      <td><span class="cell-readonly ${isPrincipal?'':'green'}">${isPrincipal?'‚Äî':fmtN(tvaAmount)+' ‚Ç¨'}</span></td>
      <td><button class="btn btn-danger btn-sm" onclick="delCredit(${i})">‚úï</button></td>
    </tr>`;
  }).join('');
}

/* ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ */
function updateCA(i,field,value){
  _data.ca[i][field]=field==='tvaRate'?parseFloat(value):value;
  const ht=parseFloat(_data.ca[i].montantHT)||0;
  const rate=_data.ca[i].tvaRate;
  const ttcEl=document.querySelector(`#ca-tbody tr:nth-child(${i+1}) .cell-readonly.blue`);
  const tvaEl=document.querySelector(`#ca-tbody tr:nth-child(${i+1}) .cell-readonly.green`);
  if(ttcEl)ttcEl.textContent=ht?fmtN(ht*(1+rate/100)):'‚Äî';
  if(tvaEl)tvaEl.textContent=ht?fmtN(ht*rate/100):'‚Äî';
  refreshTotals();
}

function addCharge(key,tbodyId){
  _data[key].push({fournisseur:'',type:'',montantHT:'',tvaRate:20,deductible:'Oui',pointe:'Non'});
  document.getElementById(tbodyId).innerHTML=renderCharges(_data[key],key);
  refreshTotals();
}

function addCredit(type){
  _data.credits.push({fournisseur:'',nom:'',ligneType:type,montant:'',tvaRate:20,tvaAuto:false,tauxInteret:'',pointe:'Non'});
  refreshCredits();
}

function delCredit(i){
  _data.credits.splice(i,1);
  if(_data.credits.length===0)_data.credits.push({fournisseur:'',nom:'',ligneType:'principal',montant:'',tvaRate:20,tvaAuto:false,tauxInteret:'',pointe:'Non'});
  refreshCredits();
}

function refreshCredits(){
  const tb=document.getElementById('cred-tbody');
  if(tb)tb.innerHTML=renderCredits(_data.credits);
  refreshTotals();
}

function delRow(key,i,tbodyId,renderFn){
  _data[key].splice(i,1);
  if(_data[key].length===0){
    if(key==='rentreesSupp')_data[key].push({type:'',montant:''});
    else _data[key].push({fournisseur:'',type:'',montantHT:'',tvaRate:20,deductible:'Oui',pointe:'Non'});
  }
  document.getElementById(tbodyId).innerHTML=renderFn(_data[key]);
  refreshTotals();
}

function addRentree(){
  _data.rentreesSupp.push({type:'',montant:''});
  document.getElementById('rsupp-tbody').innerHTML=renderRentrees(_data.rentreesSupp);
}

/* ‚îÄ‚îÄ CALCULS ‚îÄ‚îÄ */
function calcTotals(data){
  const caHT=data.ca.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0);
  const caTTC=data.ca.reduce((s,r)=>{const h=parseFloat(r.montantHT)||0;return s+h*(1+r.tvaRate/100);},0);
  const tvaCollectee=data.ca.reduce((s,r)=>{const h=parseFloat(r.montantHT)||0;return s+h*r.tvaRate/100;},0);
  const rentreesSupp=data.rentreesSupp.reduce((s,r)=>s+(parseFloat(r.montant)||0),0);
  const prevCA=data.previsionCA.reduce((s,r)=>s+(parseFloat(r.montant)||0),0);

  const fixesHT=data.chargesFixe.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0);
  const fixesTTC=data.chargesFixe.reduce((s,r)=>{const h=parseFloat(r.montantHT)||0;return s+h*(1+(r.tvaRate||0)/100);},0);
  const fixesTVA=data.chargesFixe.reduce((s,r)=>{if(r.deductible==='Oui'){const h=parseFloat(r.montantHT)||0;return s+h*(r.tvaRate||0)/100;}return s;},0);

  const varHT=data.chargesVar.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0);
  const varTTC=data.chargesVar.reduce((s,r)=>{const h=parseFloat(r.montantHT)||0;return s+h*(1+(r.tvaRate||0)/100);},0);
  const varTVA=data.chargesVar.reduce((s,r)=>{if(r.deductible==='Oui'){const h=parseFloat(r.montantHT)||0;return s+h*(r.tvaRate||0)/100;}return s;},0);

  const leasingHT=data.leasing.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0);
  const leasingTTC=data.leasing.reduce((s,r)=>{const h=parseFloat(r.montantHT)||0;return s+h*(1+(r.tvaRate||0)/100);},0);
  const leasingTVA=data.leasing.reduce((s,r)=>{if(r.deductible==='Oui'){const h=parseFloat(r.montantHT)||0;return s+h*(r.tvaRate||0)/100;}return s;},0);

  // Cr√©dits
  let creditsPrincipal=0, creditsInteret=0, creditsTVA=0;
  data.credits.forEach((r,i)=>{
    if(r.ligneType==='principal'){
      creditsPrincipal+=parseFloat(r.montant)||0;
    } else {
      let montant=parseFloat(r.montant)||0;
      if(r.tvaAuto&&parseFloat(r.tauxInteret)>0){
        const principal=data.credits.slice(0,i).reverse().find(c=>c.fournisseur===r.fournisseur&&c.ligneType==='principal');
        if(principal)montant=(parseFloat(principal.montant)||0)*parseFloat(r.tauxInteret)/100/12;
      }
      creditsInteret+=montant;
      creditsTVA+=montant*(parseFloat(r.tvaRate)||20)/100;
    }
  });

  const chargesHT=fixesHT+varHT+creditsPrincipal+creditsInteret+leasingHT;
  const tvaDed=fixesTVA+varTVA+creditsTVA+leasingTVA;
  const tvaDue=tvaCollectee-tvaDed;
  const resultat=caHT+rentreesSupp-chargesHT;
  const cashflow=caHT+rentreesSupp-(fixesTTC+varTTC+creditsPrincipal+creditsInteret+leasingTTC);
  const delta=resultat-(prevCA-chargesHT);

  return {caHT,caTTC,tvaCollectee,rentreesSupp,prevCA,fixesHT,fixesTTC,fixesTVA,varHT,varTTC,varTVA,leasingHT,leasingTTC,leasingTVA,creditsPrincipal,creditsInteret,creditsTVA,chargesHT,tvaDed,tvaDue,resultat,cashflow,delta};
}

function refreshTotals(){
  const t=calcTotals(_data);
  const s=(id,v,cls)=>{const el=document.getElementById(id);if(!el)return;el.textContent=typeof v==='string'?v:fmtN(v);if(cls){el.className=el.className.replace(/positive|negative/g,'').trim();el.classList.add(cls);}};
  s('tot-caHT',t.caHT);s('tot-caTTC',t.caTTC);s('tot-tvaC',t.tvaCollectee);
  s('tot-rsupp',t.rentreesSupp);s('tot-prev',t.prevCA);
  s('tot-fixHT',t.fixesHT);s('tot-fixTTC',t.fixesTTC);s('tot-fixTVA',t.fixesTVA);
  s('tot-varHT',t.varHT);s('tot-varTTC',t.varTTC);s('tot-varTVA',t.varTVA);
  s('tot-leasHT',t.leasingHT);s('tot-leasTTC',t.leasingTTC);
  s('tot-credP',t.creditsPrincipal);s('tot-credTVA',t.creditsTVA);
  s('tva-c',fmtN(t.tvaCollectee)+' ‚Ç¨');s('tva-d',fmtN(t.tvaDed)+' ‚Ç¨');s('tva-due',fmtN(Math.abs(t.tvaDue))+' ‚Ç¨');
  s('cf-val',fmt(t.cashflow),t.cashflow>=0?'positive':'negative');
  s('cf-prev',fmt(t.prevCA-t.chargesHT));
  s('cf-delta',fmt(t.delta),t.delta>=0?'positive':'negative');
  s('s-ca',fmt(t.caHT));s('s-ch',fmt(t.chargesHT));
  s('s-res',fmt(t.resultat),t.resultat>=0?'positive':'negative');
  s('s-tvac',fmt(t.tvaCollectee));s('s-tvad',fmt(t.tvaDue),t.tvaDue>=0?'negative':'positive');
}

/* ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ */
async function saveAll(){
  if(!window._uid){showToast('Non connect√©','warning');return;}
  try{
    await window._setDoc(window._doc(window._db,'pilotage',window._uid,'months',getMonthKey()),JSON.parse(JSON.stringify(_data)));
    showToast('‚úÖ Sauvegard√© ‚Äî '+getMonthLabel(),'success');
  }catch(e){showToast('Erreur de sauvegarde','warning');console.error(e);}
}

/* ‚îÄ‚îÄ FIXED CHARGES ‚îÄ‚îÄ */
function openFixedChargesModal(){document.getElementById('fixedModal').classList.add('show');}
function closeModal(){document.getElementById('fixedModal').classList.remove('show');}
async function applyFixedCharges(){
  closeModal();
  if(!window._uid)return;
  const currentM=parseInt(document.getElementById('monthSelect').value);
  const fixedCharges=JSON.parse(JSON.stringify(_data.chargesFixe));
  let count=0;
  for(let m=0;m<12;m++){
    if(m===currentM)continue;
    const key=`${window._year}-${String(m+1).padStart(2,'0')}`;
    try{
      const snap=await window._getDoc(window._doc(window._db,'pilotage',window._uid,'months',key));
      let md=defaultData(window._year,m);
      if(snap.exists())md=snap.data();
      const has=md.chargesFixe&&md.chargesFixe.some(c=>c.fournisseur||c.montantHT);
      if(!has){md.chargesFixe=fixedCharges;await window._setDoc(window._doc(window._db,'pilotage',window._uid,'months',key),md);count++;}
    }catch(e){console.warn(e);}
  }
  showToast(`‚ö° Charges fixes appliqu√©es sur ${count} mois !`,'success');
}

async function handleLogout(){await window._signOut(window._auth);window.location.href='index.html';}

function fmt(n){return (n>=0?'+':'')+fmtN(n)+' ‚Ç¨';}
function fmtE(n){return fmtN(n)+' ‚Ç¨';}
function fmtN(n){return (parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2});}

function showToast(msg,type=''){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast show '+(type||'');
  setTimeout(()=>{t.className='toast';},3500);
}

window.loadMonth=loadMonth;window.setYear=setYear;window.toggleMenu=toggleMenu;
window.updateCA=updateCA;window.addCharge=addCharge;window.addCredit=addCredit;
window.delCredit=delCredit;window.refreshCredits=refreshCredits;
window.delRow=delRow;window.addRentree=addRentree;window.refreshTotals=refreshTotals;
window.updateChargeHT=updateChargeHT;window.updateChargeTTC=updateChargeTTC;window.updateChargeTVARate=updateChargeTVARate;
window.duplicateFixeLine=duplicateFixeLine;
window.saveAll=saveAll;window.openFixedChargesModal=openFixedChargesModal;
window.closeModal=closeModal;window.applyFixedCharges=applyFixedCharges;
window.handleLogout=handleLogout;
</script>

<script>
function toggleNav(subId, el) {
  const sub = document.getElementById(subId);
  const isOpen = sub.classList.contains('open');
  sub.classList.toggle('open');
  // rotate chevron
  const chevId = subId === 'kpis-sub' ? 'chev-kpis' : 'chev-pil';
  const chev = document.getElementById(chevId);
  if (chev) chev.style.transform = isOpen ? '' : 'rotate(90deg)';
}
function activatePage(pageId, openSub) {
  const el = document.getElementById(pageId);
  if (el) el.classList.add('on');
  if (openSub) {
    const sub = document.getElementById(openSub);
    if (sub) sub.classList.add('open');
    const chevId = openSub === 'kpis-sub' ? 'chev-kpis' : 'chev-pil';
    const chev = document.getElementById(chevId);
    if (chev) chev.style.transform = 'rotate(90deg)';
  }
}
</script>
<script>document.addEventListener('DOMContentLoaded',()=>activatePage('nav-pilotage','pil-sub'));</script>
</body>
</html>
