<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pilotage ‚Äî ALTEORE</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  :root{
    --blue-main:#4f7ef8;--blue-dark:#1a2f6e;--blue-ghost:rgba(79,126,248,.08);
    --bg:#f0f2f8;--card:#fff;--border:#e5e8f0;--muted:#8a94ad;
    --green:#22c55e;--orange:#f97316;--red:#ef4444;--purple:#a855f7;
  }
  body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:#1e2235;display:flex;min-height:100vh}
  
  /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
  .sidebar{width:240px;min-height:100vh;background:linear-gradient(180deg,#1a2f6e 0%,#0f1d4a 100%);display:flex;flex-direction:column;padding:0;position:fixed;top:0;left:0;bottom:0;z-index:100;overflow-y:auto;transition:transform .3s}
  .sidebar-logo{display:flex;align-items:center;gap:10px;padding:22px 20px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
  .sidebar-logo-icon{width:34px;height:34px;background:var(--blue-main);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px}
  .sidebar-logo-text{font-weight:800;font-size:15px;color:#fff;letter-spacing:.5px}
  .sidebar-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:16px 20px 6px}
  .nav-item{display:flex;align-items:center;gap:10px;padding:10px 20px;color:rgba(255,255,255,.55);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:.15s}
  .nav-item:hover,.nav-item.active{color:#fff;background:rgba(255,255,255,.07);border-left-color:var(--blue-main)}
  .nav-icon{font-size:15px;width:20px;text-align:center}
  .nav-chevron{margin-left:auto;font-size:14px;transition:transform .25s}
  .nav-item.open .nav-chevron{transform:rotate(90deg)}
  .submenu{overflow:hidden;max-height:0;transition:max-height .3s ease}
  .submenu.open{max-height:300px}
  .sub-item{display:flex;align-items:center;gap:9px;padding:8px 20px 8px 44px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s}
  .sub-item:hover{color:rgba(255,255,255,.8);background:rgba(255,255,255,.05)}
  .sub-item.active{color:#fff;background:rgba(79,126,248,.15);border-left-color:var(--blue-main)}
  .sub-item.active .sub-dot{background:var(--blue-main)}
  .sub-dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);flex-shrink:0}
  .sub-year-badge{margin-left:auto;background:rgba(79,126,248,.25);color:rgba(255,255,255,.7);font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px}
  .nav-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 20px 4px}
  .sidebar-footer{margin-top:auto;padding:16px 20px;border-top:1px solid rgba(255,255,255,.08)}
  .user-card{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;background:rgba(255,255,255,.06);cursor:pointer}
  .user-card:hover{background:rgba(255,255,255,.1)}
  .user-avatar{width:32px;height:32px;border-radius:50%;background:var(--blue-main);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;color:#fff;flex-shrink:0}
  .user-name{font-size:12px;font-weight:600;color:#fff}
  .user-plan{font-size:10px;color:rgba(255,255,255,.4)}
  .logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,.35);cursor:pointer;font-size:16px;padding:2px;transition:.15s}
  .logout-btn:hover{color:#ef4444}

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  .main{margin-left:240px;flex:1;padding:0;display:flex;flex-direction:column;min-height:100vh}
  .topbar{background:var(--card);border-bottom:1px solid var(--border);padding:16px 28px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap}
  .topbar-left h1{font-size:18px;font-weight:700;color:#1e2235}
  .topbar-left p{font-size:12px;color:var(--muted);margin-top:2px}
  .topbar-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
  .month-select{padding:7px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;background:#fff;cursor:pointer;font-family:inherit}
  .content{padding:24px 28px;flex:1}
  .loader{display:flex;align-items:center;justify-content:center;padding:80px;color:var(--muted);font-size:13px;gap:10px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--blue-main);border-radius:50%;animation:spin .7s linear infinite}

  /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
  .btn{padding:8px 16px;border-radius:9px;border:none;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;transition:.15s}
  .btn-primary{background:var(--blue-main);color:#fff}
  .btn-primary:hover{background:#3d6ef0}
  .btn-orange{background:var(--orange);color:#fff}
  .btn-orange:hover{background:#ea6c0a}
  .btn-outline{background:transparent;border:1px solid var(--border);color:#1e2235}
  .btn-outline:hover{background:var(--bg)}
  .btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca}
  .btn-danger:hover{background:#fee2e2}
  .btn-sm{padding:5px 11px;font-size:12px}

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .summary-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:20px}
  .sum-card{background:var(--card);border-radius:14px;padding:16px 18px;border:1px solid var(--border)}
  .sum-card.blue .sum-value{color:var(--blue-main)}
  .sum-card.orange .sum-value{color:var(--orange)}
  .sum-card.green .sum-value{color:var(--green)}
  .sum-card.red .sum-value{color:var(--red)}
  .sum-card.purple .sum-value{color:var(--purple)}
  .sum-label{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
  .sum-value{font-size:18px;font-weight:800;margin-bottom:4px}
  .sum-sub{font-size:11px;color:var(--muted)}
  .positive{color:var(--green)!important}
  .negative{color:var(--red)!important}

  /* ‚îÄ‚îÄ SECTIONS ‚îÄ‚îÄ */
  .sections-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
  .section-card{background:var(--card);border-radius:14px;border:1px solid var(--border);padding:18px;overflow:auto}
  .section-card.full{grid-column:1/-1}
  .section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:8px;flex-wrap:wrap}
  .section-title{font-size:13px;font-weight:700;color:#1e2235;display:flex;align-items:center;gap:8px}
  .section-actions{display:flex;gap:6px;flex-wrap:wrap}
  .section-title-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px}
  .badge-blue{background:rgba(79,126,248,.1);color:var(--blue-main)}
  .badge-orange{background:rgba(249,115,22,.1);color:var(--orange)}
  .badge-green{background:rgba(34,197,94,.1);color:var(--green)}
  .badge-purple{background:rgba(168,85,247,.1);color:var(--purple)}

  /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
  .data-table{width:100%;border-collapse:collapse;font-size:12px}
  .data-table th{background:#f8f9fd;padding:7px 9px;text-align:left;font-weight:600;color:var(--muted);font-size:11px;border-bottom:1px solid var(--border)}
  .data-table td{padding:5px 7px;border-bottom:1px solid #f1f3f9;vertical-align:middle}
  .data-table tfoot td{font-weight:700;font-size:12px;background:#f8f9fd;border-top:2px solid var(--border)}
  .tfoot-add-btn{font-size:11px!important;padding:4px 12px!important;color:var(--blue-main)!important;border-color:var(--blue-main)!important;opacity:.75}
  .tfoot-add-btn:hover{opacity:1;background:var(--blue-ghost)!important}
  .cell-input{width:100%;padding:4px 7px;border:1px solid var(--border);border-radius:6px;font-size:12px;font-family:inherit;background:#fafbff;transition:.15s}
  .cell-input:focus{outline:none;border-color:var(--blue-main);background:#fff}
  .cell-readonly{display:inline-block;padding:4px 7px;border-radius:6px;font-size:12px;font-weight:600}
  .cell-readonly.blue{background:rgba(79,126,248,.08);color:var(--blue-main)}
  .cell-readonly.green{background:rgba(34,197,94,.08);color:var(--green)}
  .cell-readonly.orange{background:rgba(249,115,22,.08);color:var(--orange)}
  .info-box{background:var(--blue-ghost);border-radius:8px;padding:9px 13px;font-size:11px;color:var(--blue-main);font-weight:500;margin-bottom:12px}

  /* ‚îÄ‚îÄ CREDITS ‚îÄ‚îÄ */
  .row-principal{background:rgba(79,126,248,.03)}
  .row-interet{background:rgba(168,85,247,.03)}
  .row-type-label{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700}
  .row-type-label.principal{background:rgba(79,126,248,.1);color:var(--blue-main)}
  .row-type-label.interet{background:rgba(168,85,247,.1);color:var(--purple)}

  /* ‚îÄ‚îÄ TVA / CASHFLOW ‚îÄ‚îÄ */
  .tva-result{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .tva-box{background:var(--bg);border-radius:10px;padding:14px;text-align:center}
  .tva-box.due{background:rgba(239,68,68,.06)}
  .tva-box.credit{background:rgba(34,197,94,.06)}
  .tva-box-label{font-size:11px;color:var(--muted);font-weight:600;margin-bottom:5px}
  .tva-box-value{font-size:16px;font-weight:800}
  .cashflow-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .cf-box{background:var(--bg);border-radius:10px;padding:14px;text-align:center}
  .cf-label{font-size:11px;color:var(--muted);font-weight:600;margin-bottom:5px}
  .cf-value{font-size:16px;font-weight:800}

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:1000;align-items:center;justify-content:center}
  .modal-overlay.show{display:flex}
  .modal{background:#fff;border-radius:16px;padding:28px;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.15)}
  .modal h3{font-size:16px;font-weight:700;margin-bottom:12px}
  .modal p{font-size:13px;color:var(--muted);margin-bottom:16px;line-height:1.6}
  .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}

  /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
  .toast{position:fixed;top:0;left:240px;right:0;padding:0;height:0;overflow:hidden;z-index:2000;pointer-events:none;transition:height .2s ease}
  .toast.show{height:36px}
  .toast-inner{display:flex;align-items:center;justify-content:center;gap:8px;height:36px;font-size:13px;font-weight:700;letter-spacing:.3px;background:#16a34a;color:#fff;width:100%}
  .toast.warning .toast-inner{background:#d97706}
  .toast.info .toast-inner{background:#1a2f6e}
  @media(max-width:768px){.toast{left:0}}

  /* ‚îÄ‚îÄ HAMBURGER ‚îÄ‚îÄ */
  .hamburger{display:none;position:fixed;top:14px;left:14px;z-index:200;background:var(--blue-main);border:none;border-radius:9px;width:38px;height:38px;flex-direction:column;align-items:center;justify-content:center;gap:5px;cursor:pointer;transition:.2s}
  .hamburger span{display:block;width:18px;height:2px;background:#fff;border-radius:2px;transition:.3s}
  .hamburger.open span:nth-child(1){transform:rotate(45deg) translate(5px,5px)}
  .hamburger.open span:nth-child(2){opacity:0}
  .hamburger.open span:nth-child(3){transform:rotate(-45deg) translate(5px,-5px)}
  .nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:90}
  .nav-overlay.show{display:block}

  @media(max-width:900px){
    .summary-grid{grid-template-columns:repeat(2,1fr)}
    .sections-grid{grid-template-columns:1fr}
  }
  @media(max-width:768px){
    .hamburger{display:flex}
    .sidebar{transform:translateX(-100%)}
    .sidebar.open{transform:translateX(0)}
    .main{margin-left:0}
    .topbar{padding:14px 16px;padding-top:60px}
    .content{padding:16px}
    .summary-grid{grid-template-columns:1fr 1fr}
    .tva-result,.cashflow-grid{grid-template-columns:1fr}
  }
  @media(max-width:480px){
    .summary-grid{grid-template-columns:1fr}
  }

/* ‚îÄ‚îÄ‚îÄ MONTH PICKER CUSTOM ‚îÄ‚îÄ‚îÄ */
.mp-wrap { position:relative; display:inline-block; }
.mp-display {
  display:flex; align-items:center; gap:6px;
  padding:4px 10px; border-radius:8px; border:1px solid var(--border);
  background:#fff; cursor:pointer; font-size:12px; font-weight:600;
  color:var(--text); min-width:110px; white-space:nowrap;
  transition:border-color .15s;
}
.mp-display:hover { border-color:var(--blue-main); }
.mp-display .mp-icon { color:var(--blue-main); font-size:14px; }
.mp-display.empty { color:var(--muted); font-weight:400; }
.mp-popup {
  position:fixed; z-index:9999;
  background:#fff; border-radius:14px; border:1px solid var(--border);
  box-shadow:0 8px 32px rgba(0,0,0,.15);
  padding:12px; width:240px;
  display:none;
}
.mp-popup.open { display:block; }
.mp-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:10px;
}
.mp-year-btn {
  background:none; border:none; cursor:pointer; font-size:18px;
  color:var(--muted); padding:2px 8px; border-radius:6px;
  transition:background .1s;
}
.mp-year-btn:hover { background:var(--hover); }
.mp-year-label { font-weight:700; font-size:14px; color:var(--text); }
.mp-months { display:grid; grid-template-columns:repeat(3,1fr); gap:6px; }
.mp-month-btn {
  padding:7px 4px; border-radius:8px; border:none; cursor:pointer;
  font-size:12px; font-weight:500; background:var(--hover);
  color:var(--text); transition:all .15s;
}
.mp-month-btn:hover { background:#dbeafe; color:var(--blue-main); }
.mp-month-btn.selected { background:var(--blue-main); color:#fff; font-weight:700; }
.mp-month-btn.in-range { background:#dbeafe; color:var(--blue-main); }
.mp-clear { display:block; width:100%; margin-top:8px; padding:5px; border:none;
  background:none; color:var(--muted); font-size:11px; cursor:pointer;
  border-top:1px solid var(--border); }
.mp-clear:hover { color:var(--red); }

/* ‚îÄ‚îÄ FOURNISSEURS ‚îÄ‚îÄ */
.sugg-wrap { position:relative; display:inline-block; }
.sugg-list {
  display:none; position:absolute; top:100%; left:0; z-index:500;
  background:#fff; border:1px solid var(--border); border-radius:8px;
  box-shadow:0 4px 16px rgba(0,0,0,.1); min-width:180px; max-width:260px;
  max-height:180px; overflow-y:auto; font-size:12px;
}
.sugg-list.show { display:block; }
.sugg-item {
  padding:7px 12px; cursor:pointer; white-space:nowrap; overflow:hidden;
  text-overflow:ellipsis; transition:.1s;
}
.sugg-item:hover, .sugg-item.focused { background:var(--blue-ghost); color:var(--blue-main); }
.sugg-item-save {
  padding:6px 12px; cursor:pointer; font-size:11px; color:var(--blue-main);
  font-weight:600; border-top:1px solid var(--border); background:#f8f9fd;
  border-radius:0 0 8px 8px;
}
.sugg-item-save:hover { background:rgba(79,126,248,.08); }
/* Suggestion fournisseur enrichie */
.sugg-item-supplier { display:flex; align-items:center; justify-content:space-between; padding:7px 10px; gap:6px; }
.sugg-item-name { flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.sugg-fiche-btn {
  flex-shrink:0; font-size:13px; padding:2px 5px; border-radius:6px;
  cursor:pointer; opacity:.6; transition:.15s; line-height:1;
  background:none;
}
.sugg-fiche-btn:hover { opacity:1; background:var(--blue-ghost); }
#suppliersModal .modal { max-width:480px; width:90%; }
.sup-list-item {
  display:flex; align-items:center; justify-content:space-between;
  padding:7px 10px; border-radius:8px; border:1px solid var(--border);
  background:#f8f9fd; font-size:13px; gap:8px; margin-bottom:6px;
}
.sup-list-item button { background:none; border:none; color:var(--red); cursor:pointer; font-size:14px; padding:2px 4px; }
.sup-list-item button:hover { background:#fef2f2; border-radius:6px; }
#suppliersModal .sup-add-row { display:flex; gap:8px; margin-bottom:14px; }
#suppliersModal .sup-add-row input { flex:1; }
.cat-tab {
  padding:7px 13px; border:none; background:none; cursor:pointer; font-size:12px;
  font-weight:600; color:var(--muted); border-bottom:2px solid transparent;
  margin-bottom:-1px; transition:.15s; font-family:inherit; border-radius:6px 6px 0 0;
}
.cat-tab:hover { color:#1e2235; background:var(--bg); }
.cat-tab.active { color:var(--blue-main); border-bottom-color:var(--blue-main); background:var(--blue-ghost); }

/* ‚îÄ‚îÄ FICHES FOURNISSEURS ‚îÄ‚îÄ */
.fiche-list { display:flex; flex-direction:column; gap:8px; max-height:300px; overflow-y:auto; }
.fiche-item {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 12px; border-radius:10px; border:1px solid var(--border);
  background:#f8f9fd; cursor:pointer; transition:.15s; gap:8px;
}
.fiche-item:hover { background:var(--blue-ghost); border-color:var(--blue-main); }
.fiche-item-left { display:flex; flex-direction:column; gap:2px; flex:1; min-width:0; }
.fiche-item-name { font-size:13px; font-weight:700; color:#1e2235; }
.fiche-item-meta { font-size:11px; color:var(--muted); }
.fiche-item-actions { display:flex; gap:4px; flex-shrink:0; }
.fiche-badge {
  font-size:10px; font-weight:700; padding:2px 8px; border-radius:10px;
  background:rgba(79,126,248,.1); color:var(--blue-main);
}
.fiche-badge.recurrent { background:rgba(34,197,94,.1); color:var(--green); }
.fiche-badge.ponctuel  { background:rgba(249,115,22,.1); color:var(--orange); }

/* Modal fiche (plus large) */
#ficheModal .modal { max-width:700px; width:95%; max-height:90vh; overflow-y:auto; }
#ficheModal .fiche-form { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px; }
#ficheModal .fiche-form .full { grid-column:1/-1; }
.fiche-form-label { font-size:11px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:4px; display:block; }
.fiche-form-input { width:100%; padding:8px 12px; border:1px solid var(--border); border-radius:8px; font-size:13px; font-family:inherit; background:#fafbff; transition:.15s; }
.fiche-form-input:focus { outline:none; border-color:var(--blue-main); background:#fff; }
.fiche-stats-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:16px; }
.fiche-stat-card { background:var(--bg); border-radius:10px; padding:12px; text-align:center; }
.fiche-stat-label { font-size:10px; font-weight:700; color:var(--muted); text-transform:uppercase; letter-spacing:.5px; margin-bottom:4px; }
.fiche-stat-value { font-size:16px; font-weight:800; color:#1e2235; }
.fiche-stat-sub { font-size:10px; color:var(--muted); margin-top:2px; }
.fiche-history { background:var(--bg); border-radius:10px; padding:14px; }
.fiche-history-title { font-size:12px; font-weight:700; color:var(--muted); margin-bottom:10px; text-transform:uppercase; letter-spacing:.5px; }
.fiche-history-row { display:flex; justify-content:space-between; align-items:center; padding:5px 0; border-bottom:1px solid var(--border); font-size:12px; }
.fiche-history-row:last-child { border-bottom:none; }
.fiche-history-month { font-weight:600; color:#1e2235; }
.fiche-history-amount { font-weight:700; color:var(--orange); }
.fiche-history-pct { font-size:11px; color:var(--muted); }

/* Bouton fiche dans les charges */
.btn-fiche {
  background:none; border:1px solid var(--border); border-radius:6px;
  font-size:12px; cursor:pointer; padding:3px 7px; color:var(--muted);
  transition:.15s; line-height:1;
}
.btn-fiche:hover { background:var(--blue-ghost); border-color:var(--blue-main); color:var(--blue-main); }
.btn-fiche.has-fiche { border-color:rgba(34,197,94,.4); color:var(--green); background:rgba(34,197,94,.05); }
.btn-fiche.has-fiche:hover { background:rgba(34,197,94,.1); }
</style>
</head>
<body>

<button class="hamburger" id="hamburger" onclick="toggleSidebar()" aria-label="Menu">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="navOverlay" onclick="closeSidebar()"></div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon">üìä</div>
    <div class="sidebar-logo-text">ALTEORE</div>
  </div>
  <div class="sidebar-section-label">Principal</div>
  <div class="nav-item" onclick="location.href='dashboard.html'"><span class="nav-icon">üè†</span><span class="nav-label">Tableau de bord</span></div>
  <div class="nav-item" onclick="location.href='suivi-ca.html'"><span class="nav-icon">üìà</span><span class="nav-label">Suivi CA & R√©sultats</span></div>
  <div class="nav-item" onclick="toggleMenu('kpis-menu',this)"><span class="nav-icon">üéØ</span><span class="nav-label">KPIs Cl√©s</span><span class="nav-chevron">‚Ä∫</span></div>
  <div class="submenu" id="kpis-menu">
    <div class="sub-item" onclick="location.href='cout-revient.html'"><span class="sub-dot"></span>Co√ªt de revient</div>
    <div class="sub-item" onclick="location.href='marges.html'"><span class="sub-dot"></span>Marge brute & nette</div>
    <div class="sub-item" onclick="location.href='panier-moyen.html'"><span class="sub-dot"></span>Panier moyen</div>
  </div>
  <div class="nav-item active" onclick="toggleMenu('pilotage-menu',this)"><span class="nav-icon">üß≠</span><span class="nav-label">Pilotage</span><span class="nav-chevron">‚Ä∫</span></div>
  <div class="submenu open" id="pilotage-menu">
    <div class="sub-item" onclick="setYear(2025,this)"><span class="sub-dot"></span>Pilotage 2025<span class="sub-year-badge">2025</span></div>
    <div class="sub-item" onclick="setYear(2026,this)"><span class="sub-dot"></span>Pilotage 2026<span class="sub-year-badge">2026</span></div>
    <div class="sub-item" onclick="setYear(2027,this)"><span class="sub-dot"></span>Pilotage 2027<span class="sub-year-badge">2027</span></div>
    <div class="sub-item" onclick="location.href='cashflow.html'" style="border-top:1px solid rgba(255,255,255,.06);margin-top:4px;padding-top:8px"><span class="sub-dot" style="background:#0d9488"></span>üíß Cashflow</div>
  </div>
  <div class="nav-item" onclick="location.href='dettes.html'"><span class="nav-icon">üè¶</span><span class="nav-label">Dettes & Emprunts</span></div>
  <div class="nav-section-label">Intelligence IA</div>
  <div class="nav-item" onclick="location.href='bilan.html'"><span class="nav-icon">ü§ñ</span><span class="nav-label">Analyse de Bilan</span><span class="nav-badge">IA</span></div>

  <div class="nav-section-label">Fid√©lisation</div>
  <div class="nav-item" onclick="toggleFidNav(this)" style="justify-content:space-between">
    <span style="display:flex;align-items:center;gap:8px"><span class="nav-icon">üíé</span><span class="nav-label">Fid√©lisation</span></span>
    <span class="nav-chev" style="font-size:11px;color:rgba(255,255,255,.3);transition:transform .25s">‚Ä∫</span>
  </div>
  <div id="fid-sub" style="overflow:hidden;max-height:0;transition:max-height .35s ease">
    <div class="sub-item" onclick="location.href='fidelisation.html'"><span class="sub-dot"></span>Dashboard fid√©lit√©</div>
    <div class="sub-item" onclick="location.href='fidelisation.html#clients'"><span class="sub-dot"></span>Clients</div>
    <div class="sub-item" onclick="location.href='fidelisation.html#carte'"><span class="sub-dot"></span>Carte fid√©lit√©</div>
  </div>
  <div class="nav-item" onclick="location.href='import.html'" style="border-top:1px solid rgba(255,255,255,.08);margin-top:8px"><span class="nav-icon">üì•</span><span class="nav-label">Import de donn√©es</span></div>
  <div class="sidebar-footer">
    <div class="user-card" onclick="location.href='profil.html'" title="Mon compte">
      <div class="user-avatar" id="userAvatar">A</div>
      <div><div class="user-name" id="userName">Utilisateur</div><div class="user-plan">Pro</div></div>
      <button class="logout-btn" onclick="event.stopPropagation();handleLogout()">‚éã</button>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1 id="topTitle">Pilotage ‚Äî Chargement...</h1>
      <p>Saisie et suivi mensuel complet</p>
    </div>
    <div class="topbar-right">
      <select class="month-select" id="monthSelect" onchange="loadMonth()">
        <option value="0">Janvier</option><option value="1">F√©vrier</option>
        <option value="2">Mars</option><option value="3">Avril</option>
        <option value="4">Mai</option><option value="5">Juin</option>
        <option value="6">Juillet</option><option value="7">Ao√ªt</option>
        <option value="8">Septembre</option><option value="9">Octobre</option>
        <option value="10">Novembre</option><option value="11">D√©cembre</option>
      </select>
      <button class="btn btn-orange btn-sm" onclick="openFixedModal()">‚ö° Charges fixes ‚Üí Ann√©e</button>
      <button class="btn btn-outline btn-sm" onclick="openSuppliersModal()" title="G√©rer mes fournisseurs">üìã Fournisseurs</button>
      <button class="btn btn-primary" onclick="saveAll()">üíæ Sauvegarder</button>
    </div>
  </div>
  <div class="content" id="mainContent">
    <div class="loader"><div class="spin"></div> Connexion en cours...</div>
  </div>
</div>


<!-- MODAL CATALOGUE + FICHES FOURNISSEURS -->
<div class="modal-overlay" id="suppliersModal" style="display:none">
  <div class="modal" style="max-width:580px;width:92%">
    <div style="display:flex;gap:0;margin-bottom:0;border-bottom:2px solid var(--border)">
      <button id="tab-btn-catalogue" class="cat-tab active" style="font-size:13px;padding:10px 18px" onclick="switchSupplierMainTab('catalogue')">üìã Catalogue</button>
      <button id="tab-btn-fiches" class="cat-tab" style="font-size:13px;padding:10px 18px" onclick="switchSupplierMainTab('fiches')">üè¢ Fiches fournisseurs</button>
    </div>
    <div id="tab-content-catalogue" style="padding-top:14px">
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Enregistrez vos valeurs r√©currentes pour les retrouver en suggestion.</p>
      <div style="display:flex;gap:4px;margin-bottom:14px;border-bottom:1px solid var(--border);padding-bottom:0">
        <button class="cat-tab active" data-cat="suppliers" onclick="switchCatTab('suppliers')">üè¢ Fournisseurs</button>
        <button class="cat-tab" data-cat="clients" onclick="switchCatTab('clients')">üë§ Clients</button>
        <button class="cat-tab" data-cat="descriptions" onclick="switchCatTab('descriptions')">üìù Descriptions</button>
        <button class="cat-tab" data-cat="types" onclick="switchCatTab('types')">üè∑Ô∏è Types</button>
      </div>
      <div class="sup-add-row">
        <input type="text" id="sup-new-input" class="cell-input" placeholder="Nouvelle valeur‚Ä¶" style="font-size:13px;padding:8px 12px;width:100%" onkeydown="if(event.key==='Enter')addCatalogueFromModal()"/>
        <button class="btn btn-primary btn-sm" onclick="addCatalogueFromModal()">+ Ajouter</button>
      </div>
      <div id="sup-modal-list" style="max-height:260px;overflow-y:auto"></div>
    </div>
    <div id="tab-content-fiches" style="display:none;padding-top:14px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <p style="font-size:12px;color:var(--muted);margin:0">Fiches d√©taill√©es avec analyse des achats.</p>
        <button class="btn btn-primary btn-sm" onclick="openFicheForm()">+ Nouvelle fiche</button>
      </div>
      <div id="fiches-list" class="fiche-list"></div>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:14px">
      <button class="btn btn-outline btn-sm" onclick="closeSuppliersModal()">Fermer</button>
    </div>
  </div>
</div>

<!-- MODAL FICHE FOURNISSEUR -->
<div class="modal-overlay" id="ficheModal" style="display:none">
  <div class="modal" style="max-width:700px;width:95%;max-height:90vh;overflow-y:auto">
    <div id="fiche-content"></div>
  </div>
</div>

<!-- MODAL PORT√âE (suppr / modif prix) -->
<div class="modal-overlay" id="scopeModal">
  <div class="modal">
    <h3 id="scope-title">Action sur plusieurs mois</h3>
    <p id="scope-desc" style="font-size:13px;color:var(--muted);margin-bottom:14px"></p>

    <div style="margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">Port√©e</div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer">
          <input type="radio" name="scopeMode" value="current" checked style="accent-color:var(--blue-main)">
          <span>Mois courant uniquement</span>
        </label>
        <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer">
          <input type="radio" name="scopeMode" value="period" style="accent-color:var(--blue-main)">
          <span>Sur une p√©riode</span>
        </label>
        <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer">
          <input type="radio" name="scopeMode" value="all" style="accent-color:var(--blue-main)">
          <span>Tous les mois o√π cette ligne existe</span>
        </label>
      </div>
    </div>

    <div id="scope-period-picker" style="display:none;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">P√©riode</div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <div style="display:flex;flex-direction:column;gap:4px">
          <label style="font-size:11px;color:var(--muted);font-weight:600">De</label>
          <select id="scope-from" style="padding:6px 10px;border-radius:8px;border:1px solid var(--border);font-size:13px;background:#fff;min-width:130px">
          <option value="0">Janvier</option>
          <option value="1">F√©vrier</option>
          <option value="2">Mars</option>
          <option value="3">Avril</option>
          <option value="4">Mai</option>
          <option value="5">Juin</option>
          <option value="6">Juillet</option>
          <option value="7">Ao√ªt</option>
          <option value="8">Septembre</option>
          <option value="9">Octobre</option>
          <option value="10">Novembre</option>
          <option value="11">D√©cembre</option>
          </select>
        </div>
        <div style="font-size:18px;color:var(--muted);padding-top:18px">‚Üí</div>
        <div style="display:flex;flex-direction:column;gap:4px">
          <label style="font-size:11px;color:var(--muted);font-weight:600">√Ä</label>
          <select id="scope-to" style="padding:6px 10px;border-radius:8px;border:1px solid var(--border);font-size:13px;background:#fff;min-width:130px">
          <option value="0">Janvier</option>
          <option value="1">F√©vrier</option>
          <option value="2">Mars</option>
          <option value="3">Avril</option>
          <option value="4">Mai</option>
          <option value="5">Juin</option>
          <option value="6">Juillet</option>
          <option value="7">Ao√ªt</option>
          <option value="8">Septembre</option>
          <option value="9">Octobre</option>
          <option value="10">Novembre</option>
          <option value="11">D√©cembre</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px">
          <label style="font-size:11px;color:var(--muted);font-weight:600">Ann√©e</label>
          <select id="scope-year" style="padding:6px 10px;border-radius:8px;border:1px solid var(--border);font-size:13px;background:#fff">
            <option id="scope-year-cur"></option>
            <option id="scope-year-next"></option>
          </select>
        </div>
      </div>
    </div>

    <!-- Nouveau prix (uniquement pour action modif) -->
    <div id="scope-price-wrap" style="display:none;margin-bottom:14px">
      <div style="font-size:12px;font-weight:700;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">Nouveau montant HT</div>
      <input id="scope-price-input" type="text" inputmode="decimal" class="cell-input" style="width:160px;font-size:14px;padding:8px 12px"
        placeholder="0.00" />
    </div>

    <div style="background:#fff7ed;border-radius:10px;padding:10px 14px;font-size:12px;color:#c2410c;font-weight:600;border:1px solid #fed7aa" id="scope-warning">
      ‚ö†Ô∏è Cette action modifiera les donn√©es Firestore sur les mois s√©lectionn√©s.
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeScopeModal()">Annuler</button>
      <button class="btn btn-orange" id="scope-confirm-btn" onclick="executeScopeAction()">Confirmer</button>
    </div>
  </div>
</div>

<!-- MODAL charges fixes -->
<div class="modal-overlay" id="fixedModal">
  <div class="modal">
    <h3>‚ö° Appliquer les charges fixes</h3>
    <p>Les <strong id="modal-nb-lignes">X</strong> lignes de charges fixes du mois en cours seront copi√©es sur la p√©riode choisie.</p>

    <div style="margin:14px 0">
      <div style="font-size:12px;font-weight:700;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">P√©riode de duplication</div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
        <div style="display:flex;flex-direction:column;gap:4px">
          <label style="font-size:11px;color:var(--muted);font-weight:600">De</label>
          <select id="modal-from" style="padding:6px 10px;border-radius:8px;border:1px solid var(--border);font-size:13px;background:#fff;min-width:130px">
          <option value="0">Janvier</option>
          <option value="1">F√©vrier</option>
          <option value="2">Mars</option>
          <option value="3">Avril</option>
          <option value="4">Mai</option>
          <option value="5">Juin</option>
          <option value="6">Juillet</option>
          <option value="7">Ao√ªt</option>
          <option value="8">Septembre</option>
          <option value="9">Octobre</option>
          <option value="10">Novembre</option>
          <option value="11">D√©cembre</option>
          </select>
        </div>
        <div style="font-size:18px;color:var(--muted);padding-top:18px">‚Üí</div>
        <div style="display:flex;flex-direction:column;gap:4px">
          <label style="font-size:11px;color:var(--muted);font-weight:600">√Ä</label>
          <select id="modal-to" style="padding:6px 10px;border-radius:8px;border:1px solid var(--border);font-size:13px;background:#fff;min-width:130px">
          <option value="0">Janvier</option>
          <option value="1">F√©vrier</option>
          <option value="2">Mars</option>
          <option value="3">Avril</option>
          <option value="4">Mai</option>
          <option value="5">Juin</option>
          <option value="6">Juillet</option>
          <option value="7">Ao√ªt</option>
          <option value="8">Septembre</option>
          <option value="9">Octobre</option>
          <option value="10">Novembre</option>
          <option value="11">D√©cembre</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;gap:4px">
          <label style="font-size:11px;color:var(--muted);font-weight:600">Ann√©e</label>
          <select id="modal-year" style="padding:6px 10px;border-radius:8px;border:1px solid var(--border);font-size:13px;background:#fff">
            <option id="modal-year-prev"></option>
            <option id="modal-year-cur"></option>
            <option id="modal-year-next"></option>
          </select>
        </div>
      </div>
    </div>

    <div style="margin:12px 0;display:flex;flex-direction:column;gap:8px">
      <div style="font-size:12px;font-weight:700;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px">Mode</div>
      <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer">
        <input type="radio" name="applyMode" value="empty" checked style="accent-color:#f97316">
        <span>Copier uniquement sur les mois <strong>sans charges</strong></span>
      </label>
      <label style="display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer">
        <input type="radio" name="applyMode" value="all" style="accent-color:#f97316">
        <span><strong>Remplacer</strong> les charges fixes sur tous les mois s√©lectionn√©s</span>
      </label>
    </div>

    <div style="background:#fff7ed;border-radius:10px;padding:10px 14px;font-size:12px;color:#c2410c;font-weight:600;border:1px solid #fed7aa">
      ‚ö†Ô∏è Le mois en cours ne sera pas modifi√©. En mode "Remplacer", les charges existantes seront √©cras√©es.
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closeModal()">Annuler</button>
      <button class="btn btn-orange" onclick="applyFixedCharges()">‚ö° Appliquer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"><div class="toast-inner" id="toast-inner"></div></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCRIPT 1 : Firebase (module ES6)
     R√¥le UNIQUE : init Firebase + auth + exposer sur window
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app = initializeApp({
  apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
  authDomain:"altiora-70599.firebaseapp.com",
  projectId:"altiora-70599",
  storageBucket:"altiora-70599.firebasestorage.app",
  messagingSenderId:"120905555746",
  appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
});

const auth = getAuth(app);
const db   = getFirestore(app);

// Exposer Firebase sur window pour le script applicatif
window._db      = db;
window._auth    = auth;
window._doc     = doc;
window._setDoc  = setDoc;
window._getDoc  = getDoc;
window._signOut = signOut;

onAuthStateChanged(auth, function(user) {
  if (!user) { window.location.href = 'index.html'; return; }
  window._uid = user.uid;
  var name = user.displayName || user.email.split('@')[0];
  document.getElementById('userName').textContent  = name;
  document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
  // D√©clencher le chargement applicatif
  window._firebaseReady = true;
  window.loadMonth();
});
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCRIPT 2 : Application (script classique)
     Tout le code m√©tier est ici ‚Äî pas de Firebase direct
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
/* ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ */
var MONTHS = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
var TVA_RATES = [0, 5.5, 10, 20];

// Lire l'ann√©e depuis l'URL (ex: pilotage.html?year=2027)
window._year = parseInt(new URLSearchParams(window.location.search).get('year')) || new Date().getFullYear();

// Activer le bon bouton dans la sidebar d√®s le DOM pr√™t
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('monthSelect').value = new Date().getMonth();
  document.querySelectorAll('.sub-year-badge').forEach(function(badge) {
    var item = badge.closest('.sub-item');
    if (item) item.classList.toggle('active', parseInt(badge.textContent) === window._year);
  });
  document.getElementById('topTitle').textContent = 'Pilotage ‚Äî ' + MONTHS[new Date().getMonth()] + ' ' + window._year;
});

var _data = {};

/* ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ */
function setYear(y, el) {
  window._year = y;
  document.querySelectorAll('#pilotage-menu .sub-item').forEach(function(s) { s.classList.remove('active'); });
  if (el) el.classList.add('active');
  loadMonth();
}

function toggleMenu(id, el) {
  document.getElementById(id).classList.toggle('open');
  el.classList.toggle('open');
}

function toggleFidNav(el) {
  var sub  = document.getElementById('fid-sub');
  var chev = el.querySelector('.nav-chev');
  var open = sub.style.maxHeight && sub.style.maxHeight !== '0px';
  sub.style.maxHeight = open ? '0px' : '300px';
  if (chev) chev.style.transform = open ? '' : 'rotate(90deg)';
}

function toggleSidebar() {
  var s = document.getElementById('sidebar');
  var o = document.getElementById('navOverlay');
  var b = document.getElementById('hamburger');
  s.classList.toggle('open');
  o.classList.toggle('show');
  b.classList.toggle('open');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('navOverlay').classList.remove('show');
  document.getElementById('hamburger').classList.remove('open');
}

/* ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ */
function getMonthKey() {
  var m = parseInt(document.getElementById('monthSelect').value);
  return window._year + '-' + String(m + 1).padStart(2, '0');
}
function getMonthLabel() {
  var m = parseInt(document.getElementById('monthSelect').value);
  return MONTHS[m] + ' ' + window._year;
}
function fmt(n)  { return (n >= 0 ? '+' : '') + fmtN(n) + ' ‚Ç¨'; }
function fmtE(n) { return fmtN(n) + ' ‚Ç¨'; }
function fmtN(n) { return (parseFloat(n) || 0).toLocaleString('fr-FR', {minimumFractionDigits:2, maximumFractionDigits:2}); }
function pf(v)   { return parseFloat((v||'').toString().replace(',','.')) || 0; }
function showToast(msg, type) {
  var t = document.getElementById('toast');
  var inner = document.getElementById('toast-inner');
  inner.textContent = msg;
  t.className = 'toast show ' + (type || '');
  var dur = (type === 'success') ? 1200 : 3500;
  setTimeout(function() { t.className = 'toast'; }, dur);
}

/* ‚îÄ‚îÄ‚îÄ DONN√âES PAR D√âFAUT ‚îÄ‚îÄ‚îÄ */
function defaultData(year, month) {
  var days = new Date(year, month + 1, 0).getDate();
  return {
    ca: Array.from({length: days}, function(_, i) {
      return {date: (i+1) + '/' + (month+1) + '/' + year, ht055: '', ht10: '', ht20: ''};
    }),
    rentreesSupp: [
      {type:'Aides / subventions', montant:''},
      {type:'Apports personnels',  montant:''},
      {type:'Remboursements',      montant:''},
      {type:'Autres recettes',     montant:''}
    ],
    previsionCA:  [{type:'Ventes clients', montant:''}, {type:'Services', montant:''}, {type:'Aides', montant:''}],
    chargesFixe:  [{fournisseur:'', type:'', montantHT:'', tvaRate:20, deductible:'Oui', pointe:'Non'}],
    chargesVar:   [{fournisseur:'', type:'', montantHT:'', tvaRate:20, deductible:'Oui', pointe:'Non'}],
    credits:      [{fournisseur:'', nom:'', ligneType:'principal', montant:'', tvaRate:20, tvaAuto:false, tauxInteret:'', pointe:'Non', amort:'constant'}],
    leasing:      [{fournisseur:'', type:'', montantHT:'', tvaRate:20, deductible:'Oui', pointe:'Non'}],
    facturesPro:  [{client:'', description:'', ht055:'', ht10:'', ht20:''}]
  };
}

/* ‚îÄ‚îÄ‚îÄ CHARGEMENT DONN√âES ‚îÄ‚îÄ‚îÄ */
async function loadMonth() {
  var key   = getMonthKey();
  var m     = parseInt(document.getElementById('monthSelect').value);
  var data  = defaultData(window._year, m);

  document.getElementById('topTitle').textContent = 'Pilotage ‚Äî ' + getMonthLabel();

  if (window._uid && window._getDoc && window._db) {
    document.getElementById('mainContent').innerHTML = '<div class="loader"><div class="spin"></div> Chargement...</div>';
    try {
      var snap = await window._getDoc(window._doc(window._db, 'pilotage', window._uid, 'months', key));
      if (snap.exists()) {
        var s = snap.data();
        if (s.ca && s.ca.length === data.ca.length) {
          // Migration: ancienne structure {montantHT, tvaRate} ‚Üí nouvelle {ht055, ht10, ht20}
          data.ca = s.ca.map(function(r, i) {
            if (r.ht055 !== undefined || r.ht10 !== undefined || r.ht20 !== undefined) return r;
            // Ancienne ligne: ventiler dans la colonne correspondant au taux
            var migrated = {date: r.date || data.ca[i].date, ht055: '', ht10: '', ht20: ''};
            if (r.montantHT && parseFloat(r.montantHT) > 0) {
              var rate = parseFloat(r.tvaRate) || 20;
              if (rate === 5.5) migrated.ht055 = r.montantHT;
              else if (rate === 10) migrated.ht10 = r.montantHT;
              else migrated.ht20 = r.montantHT;
            }
            return migrated;
          });
        }
        if (s.rentreesSupp)  data.rentreesSupp = s.rentreesSupp;
        if (s.previsionCA)   data.previsionCA  = s.previsionCA;
        if (s.chargesFixe)   data.chargesFixe  = s.chargesFixe;
        if (s.chargesVar)    data.chargesVar    = s.chargesVar;
        if (s.credits)       data.credits       = s.credits;
        if (s.leasing)       data.leasing       = s.leasing;
        if (s.facturesPro)   data.facturesPro   = s.facturesPro;
      }
    } catch(e) { console.warn('loadMonth Firestore error:', e); }
  }

  _data = data;
  renderPage(data, m);
}

/* ‚îÄ‚îÄ‚îÄ SAUVEGARDE ‚îÄ‚îÄ‚îÄ */
async function saveAll() {
  if (!window._uid) { showToast('Non connect√©', 'warning'); return; }
  try {
    await window._setDoc(
      window._doc(window._db, 'pilotage', window._uid, 'months', getMonthKey()),
      JSON.parse(JSON.stringify(_data))
    );
    await syncCreditsTosDettes();
    showToast('‚úÖ Sauvegard√© ‚Äî ' + getMonthLabel(), 'success');
  } catch(e) {
    showToast('Erreur sauvegarde', 'warning');
    console.error(e);
  }
}

/* ‚îÄ‚îÄ‚îÄ SYNC CR√âDITS ‚Üí DETTES ‚îÄ‚îÄ‚îÄ */
async function syncCreditsTosDettes() {
  if (!window._uid || !window._getDoc || !window._setDoc || !window._db) return;
  try {
    var snap = await window._getDoc(window._doc(window._db, 'dettes', window._uid, 'data', 'all'));
    var dettes = (snap.exists() && snap.data().list) ? snap.data().list : [];

    var credits = (_data.credits || []).filter(function(c) {
      return (c.ligneType === 'principal' || !c.ligneType) && c.fournisseur && c.fournisseur.trim() && parseFloat(c.montant) > 0;
    });

    if (credits.length === 0) return;
    var changed = false;

    credits.forEach(function(c) {
      var montant = parseFloat(c.montant) || 0;
      var nom     = (c.nom && c.nom.trim()) ? c.nom.trim() : c.fournisseur.trim();
      var debut   = c.dateDebut || '';
      var taux    = parseFloat(c.tauxInteret) || 0;
      var duree   = 0;
      if (c.dateDebut && c.dateFin) {
        var d1 = new Date(c.dateDebut + '-01'), d2 = new Date(c.dateFin + '-01');
        duree = Math.round((d2 - d1) / (1000 * 60 * 60 * 24 * 30.44));
        if (duree < 1) duree = 0;
      }
      var existingIdx = dettes.findIndex(function(d) {
        return d._pilotageRef === c.fournisseur.trim();
      });
      // montant dans pilotage = mensualit√©, capital = mensualit√© √ó dur√©e
      var capital = duree > 0 ? montant * duree : montant;
      var detteData = {
        type: 'emprunt', nom: nom, montant: capital, mensualite: montant, debut: debut,
        taux: taux, duree: duree, amort: c.amort || 'constant',
        active: true, _pilotageRef: c.fournisseur.trim(), paiements: []
      };
      if (existingIdx >= 0) {
        var existing = dettes[existingIdx];
        dettes[existingIdx] = Object.assign({}, existing, {
          nom: detteData.nom, montant: detteData.montant, mensualite: detteData.mensualite,
          debut: detteData.debut || existing.debut,
          taux: detteData.taux, duree: detteData.duree || existing.duree,
          amort: detteData.amort, _pilotageRef: detteData._pilotageRef
        });
        changed = true;
      } else {
        detteData.id = 'pil_' + c.fournisseur.trim().replace(/\s+/g,'_') + '_' + Date.now();
        dettes.push(detteData);
        changed = true;
      }
    });

    if (changed) {
      await window._setDoc(
        window._doc(window._db, 'dettes', window._uid, 'data', 'all'),
        { list: dettes }, { merge: true }
      );
    }
  } catch(e) {
    console.warn('syncCreditsTosDettes error:', e);
  }
}

async function forceSyncDettes() {
  if (!window._uid) { showToast('Non connect√©', 'warning'); return; }
  showToast('üîÑ Synchronisation en cours‚Ä¶', 'success');
  // Scanner tous les mois pour collecter tous les cr√©dits
  var allCredits = {};
  var currentYear = new Date().getFullYear();
  var fetchPromises = [];
  for (var y = 2023; y <= currentYear + 2; y++) {
    for (var m = 1; m <= 12; m++) {
      var key = y + '-' + String(m).padStart(2,'0');
      fetchPromises.push(
        window._getDoc(window._doc(window._db, 'pilotage', window._uid, 'months', key))
          .then(function(s) {
            if (!s.exists()) return;
            var d = s.data();
            var credits = migrateCreditsToSingleLine((d.credits || []).slice());
            credits.forEach(function(c) {
              if ((c.ligneType === 'principal' || !c.ligneType) && c.fournisseur && c.fournisseur.trim() && parseFloat(c.montant) > 0) {
                var ref = c.fournisseur.trim();
                if (!allCredits[ref]) allCredits[ref] = c;
              }
            });
          })
          .catch(function() {})
      );
    }
  }
  // Inclure aussi les cr√©dits du mois courant en m√©moire
  (_data.credits || []).forEach(function(c) {
    if ((c.ligneType === 'principal' || !c.ligneType) && c.fournisseur && c.fournisseur.trim() && parseFloat(c.montant) > 0) {
      allCredits[c.fournisseur.trim()] = c;
    }
  });

  await Promise.all(fetchPromises);

  var creditsList = Object.values(allCredits);
  if (creditsList.length === 0) { showToast('Aucun cr√©dit trouv√©', 'warning'); return; }

  try {
    var snap = await window._getDoc(window._doc(window._db, 'dettes', window._uid, 'data', 'all'));
    var dettes = (snap.exists() && snap.data().list) ? snap.data().list : [];

    creditsList.forEach(function(c) {
      var montant = parseFloat(c.montant) || 0;
      var nom     = (c.nom && c.nom.trim()) ? c.nom.trim() : c.fournisseur.trim();
      var debut   = c.dateDebut || '';
      var taux    = parseFloat(c.tauxInteret) || 0;
      var duree   = 0;
      if (c.dateDebut && c.dateFin) {
        var d1 = new Date(c.dateDebut + '-01'), d2 = new Date(c.dateFin + '-01');
        duree = Math.round((d2 - d1) / (1000 * 60 * 60 * 24 * 30.44));
        if (duree < 1) duree = 0;
      }
      // montant dans pilotage = mensualit√©, capital = mensualit√© √ó dur√©e
      var capital = duree > 0 ? montant * duree : montant;
      var existingIdx = dettes.findIndex(function(d) { return d._pilotageRef === c.fournisseur.trim(); });
      var detteData = {
        type: 'emprunt', nom: nom, montant: capital, mensualite: montant, debut: debut,
        taux: taux, duree: duree, amort: c.amort || 'constant',
        active: true, _pilotageRef: c.fournisseur.trim(), paiements: []
      };
      if (existingIdx >= 0) {
        dettes[existingIdx] = Object.assign({}, dettes[existingIdx], {
          nom: detteData.nom, montant: detteData.montant, mensualite: detteData.mensualite,
          debut: detteData.debut || dettes[existingIdx].debut,
          taux: detteData.taux, duree: detteData.duree || dettes[existingIdx].duree,
          amort: detteData.amort, _pilotageRef: detteData._pilotageRef
        });
      } else {
        detteData.id = 'pil_' + c.fournisseur.trim().replace(/\s+/g,'_') + '_' + Date.now();
        dettes.push(detteData);
      }
    });

    await window._setDoc(
      window._doc(window._db, 'dettes', window._uid, 'data', 'all'),
      { list: dettes }, { merge: true }
    );
    showToast('‚úÖ ' + creditsList.length + ' cr√©dit(s) synchronis√©(s) dans Dettes', 'success');
  } catch(e) {
    showToast('Erreur sync dettes', 'warning');
    console.warn('forceSyncDettes error:', e);
  }
}


async function saveQuiet() {
  // Si Firebase pas encore pr√™t, r√©essayer dans 500ms
  if (!window._uid || !window._setDoc) {
    setTimeout(saveQuiet, 500);
    return;
  }
  try {
    await window._setDoc(
      window._doc(window._db, 'pilotage', window._uid, 'months', getMonthKey()),
      JSON.parse(JSON.stringify(_data))
    );
    showToast('‚úì Enregistr√©', 'success');
  } catch(e) {
    console.warn('saveQuiet error:', e);
    showToast('Erreur sauvegarde', 'warning');
  }
}

/* ‚îÄ‚îÄ‚îÄ RENDU PAGE ‚îÄ‚îÄ‚îÄ */
function renderPage(data, month) {
  var t = calcTotals(data);
  document.getElementById('mainContent').innerHTML =
    '<div class="summary-grid">' +
      '<div class="sum-card blue"><div class="sum-label">CA HT du mois</div><div class="sum-value" id="s-ca">' + fmt(t.caHT) + '</div><div class="sum-sub" id="s-ca-detail">Journalier : ' + fmtE(t.caHT_j) + ' ¬∑ Factures pro : ' + fmtE(t.caFP_HT) + '</div></div>' +
      '<div class="sum-card orange"><div class="sum-label">Charges totales HT</div><div class="sum-value" id="s-ch">' + fmt(t.chargesHT) + '</div><div class="sum-sub">Fixes ' + fmtE(t.fixesHT) + ' ¬∑ Var. ' + fmtE(t.varHT) + '</div></div>' +
      '<div class="sum-card ' + (t.resultat>=0?'green':'red') + '"><div class="sum-label">R√©sultat HT</div><div class="sum-value ' + (t.resultat>=0?'positive':'negative') + '" id="s-res">' + fmt(t.resultat) + '</div><div class="sum-sub">CA ‚àí D√©penses</div></div>' +
      '<div class="sum-card purple"><div class="sum-label">TVA collect√©e</div><div class="sum-value" id="s-tvac">' + fmt(t.tvaCollectee) + '</div></div>' +
      '<div class="sum-card ' + (t.tvaDue>=0?'red':'green') + '"><div class="sum-label">TVA due / cr√©dit</div><div class="sum-value ' + (t.tvaDue>=0?'negative':'positive') + '" id="s-tvad">' + fmt(t.tvaDue) + '</div><div class="sum-sub">' + (t.tvaDue>=0?'üî¥ √Ä payer':'üü¢ Cr√©dit TVA') + '</div></div>' +
    '</div>' +

    '<div class="sections-grid">' +
      '<div class="section-card">' +
        '<div class="section-head"><div class="section-title">üìÖ CA Journalier HT <span class="section-title-badge badge-blue">' + MONTHS[month] + ' ' + window._year + '</span></div></div>' +
        '<table class="data-table">' +
          '<thead><tr><th>Date</th><th style="color:#10b981">HT 5,5%</th><th style="color:#f97316">HT 10%</th><th style="color:#4f7ef8">HT 20%</th><th>Total HT</th><th>Total TTC</th><th>TVA collect√©e</th></tr></thead>' +
          '<tbody id="ca-tbody">' + renderCARows(data.ca) + '</tbody>' +
          '<tfoot><tr><td>TOTAL</td><td style="color:#10b981;font-weight:700"><span id="tot-ca055">' + fmtN(t.caHT055) + '</span> ‚Ç¨</td><td style="color:#f97316;font-weight:700"><span id="tot-ca10">' + fmtN(t.caHT10) + '</span> ‚Ç¨</td><td style="color:#4f7ef8;font-weight:700"><span id="tot-ca20">' + fmtN(t.caHT20) + '</span> ‚Ç¨</td><td><span id="tot-caHT">' + fmtN(t.caHT_j) + '</span> ‚Ç¨</td><td><span id="tot-caTTC">' + fmtN(t.caHT055*1.055+t.caHT10*1.10+t.caHT20*1.20) + '</span> ‚Ç¨</td><td><span id="tot-tvaC">' + fmtN(t.caHT055*0.055+t.caHT10*0.10+t.caHT20*0.20) + '</span> ‚Ç¨</td></tr></tfoot>' +
        '</table>' +
      '</div>' +
      '<div style="display:flex;flex-direction:column;gap:16px;">' +
        '<div class="section-card">' +
          '<div class="section-head"><div class="section-title">üí∏ Rentr√©es suppl√©mentaires</div><button class="btn btn-outline btn-sm" onclick="addRentree()">+ Ajouter</button></div>' +
          '<table class="data-table"><thead><tr><th>Type</th><th>Montant</th><th></th></tr></thead>' +
          '<tbody id="rsupp-tbody">' + renderRentrees(data.rentreesSupp) + '</tbody>' +
          '<tfoot><tr><td>TOTAL NET</td><td><span id="tot-rsupp">' + fmtN(t.rentreesSupp) + '</span> ‚Ç¨</td><td></td></tr></tfoot></table>' +
        '</div>' +
        '<div class="section-card">' +
          '<div class="section-head"><div class="section-title">üéØ Pr√©vision CA du mois</div><button class="btn btn-outline btn-sm" onclick="addPrevLine()">+ Ligne</button></div>' +
          '<table class="data-table"><thead><tr><th>Type / Source</th><th>Montant pr√©vu</th><th>CA r√©el</th><th>√âcart</th></tr></thead>' +
          '<tbody id="prev-tbody">' + renderPrevCA(data.previsionCA, t.caHT) + '</tbody>' +
          '<tfoot><tr><td>Total</td><td><span id="tot-prev">' + fmtN(t.prevCA) + '</span> ‚Ç¨</td><td style="font-weight:700;color:var(--blue-main)" id="tot-prev-reel">' + fmtN(t.caHT) + ' ‚Ç¨</td><td id="tot-prev-ecart" style="font-weight:700"></td></tr></tfoot></table>' +
        '</div>' +
      '</div>' +
    '</div>' +

    '<div class="section-card full" style="margin-bottom:16px;">' +
      '<div class="section-head">' +
        '<div class="section-title">üßæ Autres CA ‚Äî Factures Pro <span class="section-title-badge badge-green">Coffrets ¬∑ Traiteur ¬∑ B2B</span></div>' +
        '<button class="btn btn-outline btn-sm" onclick="addFacturePro()">+ Facture</button>' +
      '</div>' +
      '<div class="info-box">üí° CA hors caisse journali√®re : factures professionnels, coffrets cadeaux, traiteur‚Ä¶ TVA mixte possible sur une m√™me facture.</div>' +
      '<table class="data-table">' +
        '<thead><tr><th>Client</th><th>Description</th><th style="color:#10b981">HT 5,5%</th><th style="color:#f97316">HT 10%</th><th style="color:#4f7ef8">HT 20%</th><th>Total HT</th><th>Total TTC</th><th>TVA</th><th></th></tr></thead>' +
        '<tbody id="fp-tbody">' + renderFacturesPro(data.facturesPro) + '</tbody>' +
        '<tfoot><tr><td colspan="2">TOTAL</td>' +
          '<td style="color:#10b981;font-weight:700"><span id="tot-fp055">' + fmtN(t.caFP055) + '</span> ‚Ç¨</td>' +
          '<td style="color:#f97316;font-weight:700"><span id="tot-fp10">' + fmtN(t.caFP10) + '</span> ‚Ç¨</td>' +
          '<td style="color:#4f7ef8;font-weight:700"><span id="tot-fp20">' + fmtN(t.caFP20) + '</span> ‚Ç¨</td>' +
          '<td><span id="tot-fpHT">' + fmtN(t.caFP055+t.caFP10+t.caFP20) + '</span> ‚Ç¨</td>' +
          '<td><span id="tot-fpTTC">' + fmtN(t.caFP055*1.055+t.caFP10*1.10+t.caFP20*1.20) + '</span> ‚Ç¨</td>' +
          '<td><span id="tot-fpTVA">' + fmtN(t.caFP055*0.055+t.caFP10*0.10+t.caFP20*0.20) + '</span> ‚Ç¨</td>' +
          '<td></td>' +
        '</tr>' +
        '<tr><td colspan="9" style="padding:6px 9px"><button class="btn btn-outline btn-sm tfoot-add-btn" onclick="addFacturePro()">+ Facture</button></td></tr></tfoot>' +
      '</table>' +
    '</div>' +

    '<div class="section-card full" style="margin-bottom:16px;">' +
      '<div class="section-head">' +
        '<div class="section-title">üîí Charges Fixes <span class="section-title-badge badge-orange">Pr√©visionnel</span></div>' +
        '<div class="section-actions">' +
          '<button class="btn btn-outline btn-sm" onclick="addCharge(\'chargesFixe\',\'cf-tbody\')">+ Ligne</button>' +
          '<button class="btn btn-orange btn-sm" onclick="openFixedModal()">‚ö° Appliquer sur l\'ann√©e</button>' +
        '</div>' +
      '</div>' +
      '<table class="data-table"><thead><tr><th>Point√©</th><th>Fournisseur</th><th>Type</th><th>Montant HT</th><th>TVA %</th><th>Total TTC</th><th>D√©ductible</th><th></th></tr></thead>' +
      '<tbody id="cf-tbody">' + renderCharges(data.chargesFixe, 'chargesFixe') + '</tbody>' +
      '<tfoot><tr><td colspan="3">TOTAL CHARGES FIXES HT</td><td><span id="tot-fixHT">' + fmtN(t.fixesHT) + '</span> ‚Ç¨</td><td>‚Äî</td><td><span id="tot-fixTTC">' + fmtN(t.fixesTTC) + '</span> ‚Ç¨</td><td colspan="2">TVA d√©d. : <span id="tot-fixTVA">' + fmtN(t.fixesTVA) + '</span> ‚Ç¨</td></tr>' +
      '<tr><td colspan="8" style="padding:6px 9px"><button class="btn btn-outline btn-sm tfoot-add-btn" onclick="addCharge(\'chargesFixe\',\'cf-tbody\')">+ Ligne</button></td></tr></tfoot>' +
      '</table>' +
    '</div>' +

    '<div class="section-card full" style="margin-bottom:16px;">' +
      '<div class="section-head">' +
        '<div class="section-title">üì¶ Charges Variables <span class="section-title-badge badge-green">Au fil de l\'eau</span></div>' +
        '<button class="btn btn-outline btn-sm" onclick="addCharge(\'chargesVar\',\'cv-tbody\')">+ Ligne</button>' +
      '</div>' +
      '<table class="data-table"><thead><tr><th>Point√©</th><th>Fournisseur</th><th>Type</th><th>Montant HT</th><th>TVA %</th><th>Total TTC</th><th>D√©ductible</th><th title="Exceptionnel : exclut la ligne du total normal">Excep.</th><th></th></tr></thead>' +
      '<tbody id="cv-tbody">' + renderCharges(data.chargesVar, 'chargesVar') + '</tbody>' +
      '<tfoot>' +
        '<tr><td colspan="3">TOTAL CHARGES VARIABLES HT</td><td><span id="tot-varHT">' + fmtN(t.varHT) + '</span> ‚Ç¨</td><td>‚Äî</td><td><span id="tot-varTTC">' + fmtN(t.varTTC) + '</span> ‚Ç¨</td><td colspan="3">TVA d√©d. : <span id="tot-varTVA">' + fmtN(t.varTVA) + '</span> ‚Ç¨</td></tr>' +
        (t.varHT_excep > 0 ? '<tr id="var-excep-row"><td colspan="3" style="color:#f97316;font-size:11px;padding:5px 9px">‚ö° Dont exceptionnel (exclu du total)</td><td style="color:#f97316;font-weight:700">' + fmtN(t.varHT_excep) + ' ‚Ç¨</td><td>‚Äî</td><td style="color:#f97316;font-weight:700">' + fmtN(t.varTTC_excep) + ' ‚Ç¨</td><td colspan="3"></td></tr>' : '<tr id="var-excep-row" style="display:none"></tr>') +
        '<tr><td colspan="9" style="padding:6px 9px"><button class="btn btn-outline btn-sm tfoot-add-btn" onclick="addCharge(\'chargesVar\',\'cv-tbody\')">+ Ligne</button></td></tr>' +
      '</tfoot>' +
      '</table>' +
    '</div>' +

    '<div class="section-card full" style="margin-bottom:16px">' +
        '<div class="section-head"><div class="section-title">üè¶ Cr√©dits & Emprunts <span class="section-title-badge badge-purple">Mensualit√© auto</span></div>' +
          '<div class="section-actions"><button class="btn btn-outline btn-sm" onclick="addCredit()">+ Cr√©dit</button><button class="btn btn-outline btn-sm" style="color:#6366f1;border-color:#6366f1" onclick="forceSyncDettes()">üîó Sync ‚Üí Dettes</button></div>' +
        '</div>' +
        '<div class="info-box">üí° Renseigne Principal + Taux ‚Üí mensualit√© calcul√©e automatiquement ¬∑ TVA d√©duite sur les int√©r√™ts uniquement ¬∑ Renseigne D√©but/Fin pour la propagation</div>' +
        '<table class="data-table"><thead><tr><th>Point√©</th><th>Nom cr√©dit</th><th>Principal ‚Ç¨</th><th>Taux int. %</th><th>Amortissement</th><th>Mensualit√© HT</th><th>dont Int√©r√™ts</th><th>TVA %</th><th>TVA d√©d.</th><th>D√©but / Fin</th><th></th></tr></thead>' +
        '<tbody id="cred-tbody">' + renderCredits(data.credits) + '</tbody>' +
        '<tfoot><tr><td colspan="2">TOTAL CR√âDITS</td><td><span id="tot-credP">' + fmtN(t.creditsPrincipal) + '</span> ‚Ç¨</td><td>‚Äî</td><td>‚Äî</td><td><span id="tot-credMens">' + fmtN(t.creditsPrincipal+t.creditsInteret) + '</span> ‚Ç¨</td><td><span id="tot-credInt">' + fmtN(t.creditsInteret) + '</span> ‚Ç¨</td><td>‚Äî</td><td>TVA d√©d. : <span id="tot-credTVA">' + fmtN(t.creditsTVA) + '</span> ‚Ç¨</td><td colspan="2"></td></tr>' +
        '<tr><td colspan="11" style="padding:6px 9px"><button class="btn btn-outline btn-sm tfoot-add-btn" onclick="addCredit()">+ Cr√©dit</button></td></tr></tfoot>' +
        '</table>' +
    '</div>' +
    '<div class="section-card full" style="margin-bottom:16px">' +
        '<div class="section-head"><div class="section-title">üöó LOA / LLD / Leasing <span class="section-title-badge badge-blue">Soumis TVA</span></div><button class="btn btn-outline btn-sm" onclick="addCharge(\'leasing\',\'leas-tbody\')">+ Ligne</button></div>' +
        '<table class="data-table"><thead><tr><th>Point√©</th><th>Fournisseur</th><th>Type</th><th>Montant HT</th><th>TVA %</th><th>Total TTC</th><th>D√©d.</th><th>D√©but / Fin</th><th></th></tr></thead>' +
        '<tbody id="leas-tbody">' + renderCharges(data.leasing, 'leasing') + '</tbody>' +
        '<tfoot><tr><td colspan="3">TOTAL LEASING HT</td><td><span id="tot-leasHT">' + fmtN(t.leasingHT) + '</span> ‚Ç¨</td><td>‚Äî</td><td><span id="tot-leasTTC">' + fmtN(t.leasingTTC) + '</span> ‚Ç¨</td><td colspan="3"></td></tr>' +
        '<tr><td colspan="9" style="padding:6px 9px"><button class="btn btn-outline btn-sm tfoot-add-btn" onclick="addCharge(\'leasing\',\'leas-tbody\')">+ Ligne</button></td></tr></tfoot>' +
        '</table>' +
    '</div>' +

    '<div class="sections-grid">' +
      '<div class="section-card">' +
        '<div class="section-head"><div class="section-title">üßæ Bilan TVA du mois</div></div>' +
        '<div class="tva-result">' +
          '<div class="tva-box neutral"><div class="tva-box-label">TVA Collect√©e</div><div class="tva-box-value" id="tva-c">' + fmtN(t.tvaCollectee) + ' ‚Ç¨</div></div>' +
          '<div class="tva-box neutral"><div class="tva-box-label">TVA D√©ductible</div><div class="tva-box-value" id="tva-d">' + fmtN(t.tvaDed) + ' ‚Ç¨</div></div>' +
          '<div class="tva-box ' + (t.tvaDue>=0?'due':'credit') + '"><div class="tva-box-label">' + (t.tvaDue>=0?'TVA √† payer':'Cr√©dit TVA') + '</div><div class="tva-box-value" id="tva-due">' + fmtN(Math.abs(t.tvaDue)) + ' ‚Ç¨</div></div>' +
        '</div>' +
      '</div>' +
      '<div class="section-card">' +
        '<div class="section-head"><div class="section-title">üí∞ Cashflow & R√©sultats</div></div>' +
        '<div class="cashflow-grid">' +
          '<div class="cf-box"><div class="cf-label">Cashflow r√©el</div><div class="cf-value ' + (t.cashflow>=0?'positive':'negative') + '" id="cf-val">' + fmt(t.cashflow) + '</div></div>' +
          '<div class="cf-box"><div class="cf-label">R√©sultat Pr√©vi</div><div class="cf-value" id="cf-prev">' + fmt(t.prevCA - t.chargesHT) + '</div></div>' +
          '<div class="cf-box"><div class="cf-label">Delta Pr√©vi/R√©el</div><div class="cf-value ' + (t.delta>=0?'positive':'negative') + '" id="cf-delta">' + fmt(t.delta) + '</div></div>' +
        '</div>' +
      '</div>' +
    '</div>';
}

/* ‚îÄ‚îÄ‚îÄ RENDERERS ‚îÄ‚îÄ‚îÄ */
function renderCARows(rows) {
  return rows.map(function(r, i) {
    var h055 = parseFloat(r.ht055) || 0;
    var h10  = parseFloat(r.ht10)  || 0;
    var h20  = parseFloat(r.ht20)  || 0;
    var totalHT  = h055 + h10 + h20;
    var totalTTC = h055*1.055 + h10*1.10 + h20*1.20;
    var totalTVA = h055*0.055 + h10*0.10  + h20*0.20;
    return '<tr>' +
      '<td><span style="font-size:11px;color:var(--muted)">' + r.date + '</span></td>' +
      '<td><input class="cell-input" style="width:72px" type="number" placeholder="0.00" value="' + (r.ht055||'') + '" oninput="updateCA(' + i + ',\'ht055\',this.value)"/></td>' +
      '<td><input class="cell-input" style="width:72px" type="number" placeholder="0.00" value="' + (r.ht10||'') + '" oninput="updateCA(' + i + ',\'ht10\',this.value)"/></td>' +
      '<td><input class="cell-input" style="width:72px" type="number" placeholder="0.00" value="' + (r.ht20||'') + '" oninput="updateCA(' + i + ',\'ht20\',this.value)"/></td>' +
      '<td><span class="cell-readonly blue">' + (totalHT  ? fmtN(totalHT)  : '‚Äî') + '</span></td>' +
      '<td><span class="cell-readonly blue">' + (totalTTC ? fmtN(totalTTC) : '‚Äî') + '</span></td>' +
      '<td><span class="cell-readonly green">' + (totalTVA ? fmtN(totalTVA) : '‚Äî') + '</span></td>' +
    '</tr>';
  }).join('');
}

function renderFacturesPro(rows) {
  if (!rows || rows.length === 0) rows = [{client:'', description:'', ht055:'', ht10:'', ht20:''}];
  return rows.map(function(r, i) {
    var h055 = parseFloat(r.ht055)||0, h10 = parseFloat(r.ht10)||0, h20 = parseFloat(r.ht20)||0;
    var totalHT  = h055 + h10 + h20;
    var totalTTC = h055*1.055 + h10*1.10 + h20*1.20;
    var totalTVA = h055*0.055 + h10*0.10  + h20*0.20;
    return '<tr>' +
      '<td>' + catalogInputHtml('clients', 'fp-cl-'+i, r.client||'', 'width:110px', 'Client / soci√©t√©', 'updateFacturePro('+i+',\'client\',this.value)') + '</td>' +
      '<td>' + catalogInputHtml('descriptions', 'fp-desc-'+i, r.description||'', 'width:140px', 'Description', 'updateFacturePro('+i+',\'description\',this.value)') + '</td>' +
      '<td><input class="cell-input" style="width:72px" type="number" placeholder="0.00" value="' + (r.ht055||'') + '" oninput="updateFacturePro(' + i + ',\'ht055\',this.value)"/></td>' +
      '<td><input class="cell-input" style="width:72px" type="number" placeholder="0.00" value="' + (r.ht10||'') + '" oninput="updateFacturePro(' + i + ',\'ht10\',this.value)"/></td>' +
      '<td><input class="cell-input" style="width:72px" type="number" placeholder="0.00" value="' + (r.ht20||'') + '" oninput="updateFacturePro(' + i + ',\'ht20\',this.value)"/></td>' +
      '<td><span class="cell-readonly blue" id="fp-ht-' + i + '">' + (totalHT  ? fmtN(totalHT)  : '‚Äî') + '</span></td>' +
      '<td><span class="cell-readonly blue" id="fp-ttc-' + i + '">' + (totalTTC ? fmtN(totalTTC) : '‚Äî') + '</span></td>' +
      '<td><span class="cell-readonly green" id="fp-tva-' + i + '">' + (totalTVA ? fmtN(totalTVA) : '‚Äî') + '</span></td>' +
      '<td><button class="btn btn-danger btn-sm" onclick="delFacturePro(' + i + ')">‚úï</button></td>' +
    '</tr>';
  }).join('');
}

function renderRentrees(rows) {
  return rows.map(function(r, i) {
    return '<tr>' +
      '<td><input class="cell-input" style="width:140px" value="' + r.type + '" oninput="_data.rentreesSupp[' + i + '].type=this.value;refreshTotals()"/></td>' +
      '<td><input class="cell-input" style="width:90px" type="number" placeholder="0.00" value="' + r.montant + '" oninput="_data.rentreesSupp[' + i + '].montant=this.value;refreshTotals()"/></td>' +
      '<td><button class="btn btn-danger btn-sm" onclick="delRow(\'rentreesSupp\',' + i + ',\'rsupp-tbody\',renderRentrees)">‚úï</button></td>' +
    '</tr>';
  }).join('');
}

function renderPrevCA(rows, caReelTotal) {
  // caReelTotal = CA r√©el du mois (toutes lignes confondues)
  // On le r√©partit au prorata sur la premi√®re ligne, les autres affichent ‚Äî
  // Mais surtout on affiche le total r√©el sur la ligne "total"
  var totalPrevu = rows.reduce(function(s,r){ return s+(parseFloat(r.montant)||0); }, 0);
  return rows.map(function(r, i) {
    var prevu = parseFloat(r.montant)||0;
    // R√©partir le CA r√©el au prorata de la pr√©vision de chaque ligne
    var reel = (totalPrevu > 0 && caReelTotal > 0 && prevu > 0)
      ? caReelTotal * (prevu / totalPrevu)
      : (i === 0 && caReelTotal > 0 ? caReelTotal : 0); // si pas de pr√©vision, tout sur ligne 0
    var ecart = reel - prevu;
    var reelDisp = caReelTotal > 0
      ? '<span style="font-weight:600;color:var(--blue-main)">' + fmtN(reel) + ' ‚Ç¨</span>'
      : '<span style="color:var(--muted);font-size:11px">En attente</span>';
    var ecartColor = ecart >= 0 ? '#10b981' : '#ef4444';
    var ecartDisp = caReelTotal > 0
      ? '<span style="font-weight:700;color:' + ecartColor + '">' + (ecart>=0?'+':'') + fmtN(ecart) + ' ‚Ç¨</span>'
      : '<span style="color:var(--muted)">‚Äî</span>';
    return '<tr>' +
      '<td><input class="cell-input" style="width:130px" value="' + esc(r.type) + '" oninput="_data.previsionCA[' + i + '].type=this.value"/></td>' +
      '<td><input class="cell-input" style="width:90px" type="text" inputmode="decimal" placeholder="0.00" value="' + (r.montant||'') + '" oninput="_data.previsionCA[' + i + '].montant=this.value;refreshTotals()"/></td>' +
      '<td style="text-align:right;padding:4px 8px" id="prev-reel-' + i + '">' + reelDisp + '</td>' +
      '<td style="text-align:right;padding:4px 8px" id="prev-ecart-' + i + '">' + ecartDisp + '</td>' +
    '</tr>';
  }).join('');
}

function renderCharges(rows, key) {
  var tbId = key==='chargesFixe' ? 'cf-tbody' : key==='chargesVar' ? 'cv-tbody' : 'leas-tbody';
  var isFixe = key === 'chargesFixe';
  return rows.map(function(r, i) {
    var ht  = pf(r.montantHT);
    var rate = parseFloat(r.tvaRate) || 0;
    var ttc = ht > 0 ? ht * (1 + rate/100) : 0;
    // Bouton fiche fournisseur
    var nom = (r.fournisseur||'').trim();
    var ficheExists = nom && _fichesMap && _fichesMap[nom.toLowerCase()];
    var safeNom = nom.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    var ficheBtn = nom ? ' <button class="btn-fiche' + (ficheExists?' has-fiche':'') + '" title="' + (ficheExists?'Voir fiche':'Cr√©er fiche') + '" onclick="event.stopPropagation();openFicheByName(\'' + safeNom + '\')">' + (ficheExists?'üè¢':'üìã') + '</button>' : '';
    var isExcep = key==='chargesVar' && r.exceptionnel;
    return '<tr style="' + (isExcep ? 'background:rgba(249,115,22,0.06);' : '') + '">' +
      '<td><select class="cell-input" style="width:55px" onchange="_data[\'' + key + '\'][' + i + '].pointe=this.value"><option' + (r.pointe==='Oui'?' selected':'') + '>Oui</option><option' + (r.pointe==='Non'?' selected':'') + '>Non</option></select></td>' +
      '<td><div style="display:flex;align-items:center;gap:3px;flex-wrap:nowrap">' + supplierInputHtml(key, i, r.fournisseur||'') + ficheBtn + '</div></td>' +
      '<td>' + catalogInputHtml('types', key+'-typ-'+i, r.type||'', 'width:95px', 'Type', '_data[\''+key+'\']['+i+'].type=this.value') + '</td>' +
      '<td><input class="cell-input" style="width:76px" type="text" inputmode="decimal" placeholder="HT" value="' + (r.montantHT||'') + '" id="' + key + '-ht-' + i + '" oninput="updateChargeHT(\'' + key + '\',' + i + ',this.value)"/></td>' +
      '<td><select class="cell-input" style="width:55px" onchange="updateChargeTVARate(\'' + key + '\',' + i + ',this.value)">' + TVA_RATES.map(function(t) { return '<option value="' + t + '"' + (rate==t?' selected':'') + '>' + t + '%</option>'; }).join('') + '</select></td>' +
      '<td><input class="cell-input" style="width:76px" type="text" inputmode="decimal" placeholder="TTC" value="' + (ttc>0?ttc.toFixed(2):'') + '" id="' + key + '-ttc-' + i + '" oninput="updateChargeTTC(\'' + key + '\',' + i + ',this.value)"/></td>' +
      '<td><select class="cell-input" style="width:55px" onchange="_data[\'' + key + '\'][' + i + '].deductible=this.value;refreshTotals()"><option' + (r.deductible==='Oui'?' selected':'') + '>Oui</option><option' + (r.deductible==='Non'?' selected':'') + '>Non</option></select></td>' +
      (key==='leasing' ? '<td style="white-space:nowrap;min-width:130px">' +
        mpHtml('mpL-'+i+'-deb','leasing',i,'dateDebut',r.dateDebut||'') +
        '<div style="margin-top:4px">' + mpHtml('mpL-'+i+'-fin','leasing',i,'dateFin',r.dateFin||'') + '</div>' +
      '</td>' : '') +
      (key==='chargesVar' ? '<td style="text-align:center;padding:4px 6px">' +
        '<label title="Exceptionnel : exclut cette charge du total normal" style="display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer">' +
        '<input type="checkbox"' + (r.exceptionnel ? ' checked' : '') + ' onchange="_data[\'' + key + '\'][' + i + '].exceptionnel=this.checked;refreshTotals()" style="width:15px;height:15px;cursor:pointer;accent-color:#f97316">' +
        '</label>' +
      '</td>' : '') +
      '<td style="white-space:nowrap;display:flex;gap:4px;align-items:center;padding:5px 7px;">' +
        (isFixe ? '<button class="btn btn-orange btn-sm" style="font-size:10px;padding:3px 8px;" onclick="duplicateFixeLine(' + i + ')">‚ö° Ann√©e</button>' : '') +
        (!isFixe && key==='leasing' ? '<button class="btn btn-orange btn-sm" style="font-size:10px;padding:3px 8px" onclick="propagateLeasing(' + i + ')">‚ö° Propager</button>' : '') +
        (key==='leasing'||key==='chargesVar'||key==='chargesFixe' ? '<button class="btn btn-outline btn-sm" style="font-size:10px;padding:3px 8px" title="Modifier le prix sur plusieurs mois" onclick="openChargeScopeUpdate(\'' + key + '\',' + i + ')">‚úèÔ∏è</button>' : '') +
        '<button class="btn btn-danger btn-sm" onclick="delRow(\'' + key + '\',' + i + ',\'' + tbId + '\',function(r){return renderCharges(r,\'' + key + '\')})">‚úï</button>' +
      '</td>' +
    '</tr>';
  }).join('');
}

function calcCreditInteret(r) {
  var principal = parseFloat((r.montant||'').toString().replace(',','.')) || 0;
  var taux      = parseFloat((r.tauxInteret||'').toString().replace(',','.')) || 0;
  if (principal <= 0 || taux <= 0) return 0;
  return principal * taux / 100 / 12;
}

function migrateCreditsToSingleLine(rows) {
  if (!rows || rows.length === 0) return rows;
  // Si aucune ligne 'interet' ‚Üí d√©j√† au bon format, rien √† faire
  var hasPairs = rows.some(function(r) { return r.ligneType === 'interet'; });
  if (!hasPairs) return rows;
  // Fusionner les paires principal+interet en ligne unique
  var result = [];
  var usedInteret = {};
  rows.forEach(function(r, i) {
    if (r.ligneType === 'interet') return; // trait√©s via leur principal
    var merged = Object.assign({}, r);
    merged.ligneType = 'principal';
    // Chercher la ligne int√©r√™ts li√©e (m√™me fournisseur, pas encore utilis√©e)
    var interetIdx = rows.findIndex(function(x, xi) {
      return x.ligneType === 'interet' && x.fournisseur === r.fournisseur && !usedInteret[xi];
    });
    if (interetIdx >= 0) {
      var interetRow = rows[interetIdx];
      usedInteret[interetIdx] = true;
      if (!merged.tauxInteret && interetRow.tauxInteret) merged.tauxInteret = interetRow.tauxInteret;
      if (interetRow.tvaRate) merged.tvaRate = interetRow.tvaRate;
      merged.tvaAuto = true;
    }
    result.push(merged);
  });
  if (typeof _data !== 'undefined') _data.credits = result;
  return result;
}

function renderCredits(rows) {
  rows = migrateCreditsToSingleLine(rows);
  var curKey = getMonthKey ? getMonthKey() : '';
  return rows.map(function(r, i) {
    // Masquer si hors plage de dates
    if (curKey && r.dateDebut && r.dateFin) {
      var deb = r.dateDebut.slice(0,7), fin = r.dateFin.slice(0,7);
      if (curKey < deb || curKey > fin) return '';
    }
    var principal  = parseFloat((r.montant||'').toString().replace(',','.')) || 0;
    var interet    = calcCreditInteret(r);
    var mensualite = principal + interet;
    var tvaAmount  = interet * (parseFloat(r.tvaRate)||20) / 100;
    return '<tr class="row-principal" id="cred-row-' + i + '">' +
      '<td><select class="cell-input" style="width:58px" onchange="_data.credits[' + i + '].pointe=this.value"><option' + (r.pointe==='Oui'?' selected':'') + '>Oui</option><option' + (r.pointe==='Non'?' selected':'') + '>Non</option></select></td>' +
      '<td>' + catalogInputHtml('clients', 'credN-'+i, r.fournisseur||'', 'width:120px', 'Nom cr√©dit', 'updateCreditField('+i+',\'fournisseur\',this.value)') + '</td>' +
      '<td><input class="cell-input" style="width:85px" type="text" inputmode="decimal" placeholder="0.00" value="' + (r.montant||'') + '" oninput="updateCreditMontant(' + i + ',this.value)"/></td>' +
      '<td><input class="cell-input" style="width:65px" type="text" inputmode="decimal" placeholder="%" value="' + (r.tauxInteret||'') + '" oninput="updateCreditTaux(' + i + ',this.value)"/></td>' +
      '<td><select class="cell-input" style="width:110px" onchange="_data.credits[' + i + '].amort=this.value;scheduleSave()">' +
        '<option value="constant"' + ((r.amort||'constant')==='constant'?' selected':'') + '>Mensualit√©s constantes</option>' +
        '<option value="lineaire"' + (r.amort==='lineaire'?' selected':'') + '>Capital constant</option>' +
        '<option value="fixe"' + (r.amort==='fixe'?' selected':'') + '>Int√©r√™ts fixes</option>' +
        '<option value="infine"' + (r.amort==='infine'?' selected':'') + '>In fine</option>' +
      '</select></td>' +
      '<td><span class="cell-readonly orange" id="cred-mens-' + i + '">' + (mensualite > 0 ? fmtN(mensualite) + ' ‚Ç¨' : '‚Äî') + '</span></td>' +
      '<td><span class="cell-readonly green" id="cred-int-' + i + '">' + (interet > 0 ? fmtN(interet) + ' ‚Ç¨' : '‚Äî') + '</span></td>' +
      '<td><select class="cell-input" style="width:58px" onchange="_data.credits[' + i + '].tvaRate=parseFloat(this.value);refreshCreditsCalc()">' + TVA_RATES.map(function(t) { return '<option value="' + t + '"' + ((r.tvaRate||20)==t?' selected':'') + '>' + t + '%</option>'; }).join('') + '</select></td>' +
      '<td><span class="cell-readonly green" id="cred-tva-' + i + '">' + (tvaAmount > 0 ? fmtN(tvaAmount) + ' ‚Ç¨' : '‚Äî') + '</span></td>' +
      '<td style="white-space:nowrap;min-width:130px">' +
        mpHtml('mpC-'+i+'-deb','credit',i,'dateDebut',r.dateDebut||'') +
        '<div style="margin-top:4px">' + mpHtml('mpC-'+i+'-fin','credit',i,'dateFin',r.dateFin||'') + '</div>' +
      '</td>' +
      '<td style="white-space:nowrap">' +
        '<button class="btn btn-orange btn-sm" style="font-size:10px" onclick="propagateCredit(' + i + ')">\u26a1 Propager</button> ' +
        '<button class="btn btn-outline btn-sm" style="font-size:10px" onclick="openCreditScopeUpdate(' + i + ')">\u270f\ufe0f</button>' +
        '<button class="btn btn-danger btn-sm" onclick="openCreditScopeDel(' + i + ')">√ó</button>' +
      '</td>' +
    '</tr>';
  }).join('');
}


function updateCA(i, field, value) {
  _data.ca[i][field] = value;
  scheduleSave();
  var h055 = parseFloat(_data.ca[i].ht055) || 0;
  var h10  = parseFloat(_data.ca[i].ht10)  || 0;
  var h20  = parseFloat(_data.ca[i].ht20)  || 0;
  var totalHT  = h055 + h10 + h20;
  var totalTTC = h055*1.055 + h10*1.10 + h20*1.20;
  var totalTVA = h055*0.055 + h10*0.10  + h20*0.20;
  var row = document.querySelector('#ca-tbody tr:nth-child(' + (i+1) + ')');
  if (row) {
    var spans = row.querySelectorAll('.cell-readonly');
    if (spans[0]) spans[0].textContent = totalHT  ? fmtN(totalHT)  : '‚Äî';
    if (spans[1]) spans[1].textContent = totalTTC ? fmtN(totalTTC) : '‚Äî';
    if (spans[2]) spans[2].textContent = totalTVA ? fmtN(totalTVA) : '‚Äî';
  }
  refreshTotals();
}


/* ‚îÄ‚îÄ‚îÄ PROPAGATION CR√âDIT / LEASING ‚îÄ‚îÄ‚îÄ */
async function propagateCredit(i) {
  if (!window._uid) { showToast('Non connect√©','warning'); return; }
  var r = _data.credits[i];
  if (!r.dateDebut || !r.dateFin) { showToast('Renseigne une date de d√©but et de fin','warning'); return; }
  var linesToPropagate = [r];
  var start = r.dateDebut; // 'YYYY-MM'
  var end   = r.dateFin;
  var count = 0;
  // G√©n√©rer tous les mois entre start et end (UTC pour √©viter d√©calage)
  var startParts = start.split('-'); var endParts = end.split('-');
  var curY = parseInt(startParts[0]), curM = parseInt(startParts[1])-1;
  var endY = parseInt(endParts[0]),   endM = parseInt(endParts[1])-1;
  while (curY < endY || (curY === endY && curM <= endM)) {
    var key = curY + '-' + String(curM+1).padStart(2,'0');
    try {
      var snap = await window._getDoc(window._doc(window._db,'pilotage',window._uid,'months',key));
      var md = defaultData(curY, curM);
      if (snap.exists()) { var ex=snap.data(); Object.keys(ex).forEach(function(k){md[k]=ex[k];}); }
      if (!md.credits) md.credits = [];
      linesToPropagate.forEach(function(line) {
        var lineWithDates = Object.assign({}, line);
        var exists = md.credits.some(function(c){return c.fournisseur===line.fournisseur && c.ligneType===line.ligneType;});
        if (!exists) md.credits.push(lineWithDates);
        else {
          var idx2 = md.credits.findIndex(function(c){return c.fournisseur===line.fournisseur && c.ligneType===line.ligneType;});
          if(idx2>=0) md.credits[idx2] = lineWithDates;
        }
      });
      await window._setDoc(window._doc(window._db,'pilotage',window._uid,'months',key), md);
      count++;
    } catch(e) { console.warn('propagateCredit erreur', key, e); }
    curM++; if(curM>11){curM=0;curY++;}
  }
  showToast('‚ö° Cr√©dit propag√© sur ' + count + ' mois', 'success');
}

async function propagateLeasing(i) {
  if (!window._uid) { showToast('Non connect√©','warning'); return; }
  var r = _data.leasing[i];
  if (!r.dateDebut || !r.dateFin) { showToast('Renseigne une date de d√©but et de fin','warning'); return; }
  var start = r.dateDebut;
  var end   = r.dateFin;
  var count = 0;
  var startParts = start.split('-'); var endParts = end.split('-');
  var curY = parseInt(startParts[0]), curM = parseInt(startParts[1])-1;
  var endY = parseInt(endParts[0]),   endM = parseInt(endParts[1])-1;
  while (curY < endY || (curY === endY && curM <= endM)) {
    var key = curY + '-' + String(curM+1).padStart(2,'0');
    try {
      var snap = await window._getDoc(window._doc(window._db,'pilotage',window._uid,'months',key));
      var md = defaultData(curY, curM);
      if (snap.exists()) { var ex=snap.data(); Object.keys(ex).forEach(function(k){md[k]=ex[k];}); }
      if (!md.leasing) md.leasing = [];
      var lineToSave = Object.assign({}, r);
      var exists = md.leasing.some(function(l){return l.fournisseur===r.fournisseur && l.type===r.type;});
      if (!exists) md.leasing.push(lineToSave);
      else {
        var idx2 = md.leasing.findIndex(function(l){return l.fournisseur===r.fournisseur && l.type===r.type;});
        if(idx2>=0) md.leasing[idx2] = lineToSave;
      }
      await window._setDoc(window._doc(window._db,'pilotage',window._uid,'months',key), md);
      count++;
    } catch(e) { console.warn('propagateLeasing erreur', key, e); }
    curM++; if(curM>11){curM=0;curY++;}
  }
  showToast('‚ö° Leasing propag√© sur ' + count + ' mois', 'success');
}

function addCharge(key, tbodyId) {
  var isLeas = key==='leasing';
  _data[key].push({fournisseur:'', type:'', montantHT:'', tvaRate:20, deductible:'Oui', pointe:'Non', dateDebut: isLeas?'':'', dateFin: isLeas?'':''});
  document.getElementById(tbodyId).innerHTML = renderCharges(_data[key], key);
  refreshTotals();
}

function addCredit() {
  _data.credits.push({fournisseur:'', nom:'', ligneType:'principal', montant:'', tvaRate:20, tvaAuto:false, tauxInteret:'', pointe:'Non', dateDebut:'', dateFin:'', amort:'constant'});
  refreshCredits();
}
function delCredit(i) {
  var r = _data.credits[i];
  // Si la ligne a des dates (propag√©e), proposer la suppression multi-mois
  if (r && (r.dateDebut || r.dateFin || (r.fournisseur && r.fournisseur.length > 0))) {
    openScopeModal({
      type:'delete', dataKey:'credits', rowIdx:i,
      fournisseur: r.fournisseur, ligneType: 'principal',
      tbodyId:'cred-tbody', renderFn: null
    });
  } else {
    _data.credits.splice(i, 1);
    if (_data.credits.length === 0) _data.credits.push({fournisseur:'', nom:'', ligneType:'principal', montant:'', tvaRate:20, tvaAuto:false, tauxInteret:'', pointe:'Non', dateDebut:'', dateFin:'', amort:'constant'});
    refreshCredits();
    scheduleSave();
  }
}
function refreshCredits() {
  // Re-render complet ‚Äî seulement pour ajout/suppression de lignes
  var tb = document.getElementById('cred-tbody');
  if (tb) tb.innerHTML = renderCredits(_data.credits);
  refreshTotals();
}

// Met √† jour un champ texte sans re-render (pr√©serve le focus)
function updateCreditField(i, field, value) {
  _data.credits[i][field] = value;
  refreshTotals();
}

function updateCreditMontant(i, value) {
  _data.credits[i].montant = value;
  // Recalculer la TVA de la ligne int√©r√™ts sans re-render
  refreshCreditsCalc();
}

function updateCreditTaux(i, value) {
  _data.credits[i].tauxInteret = value;
  _data.credits[i].tvaAuto = (parseFloat(value.replace(',','.')) > 0);
  refreshCreditsCalc();
}

// Recalcule uniquement les valeurs calcul√©es (TVA, montant auto) sans toucher aux inputs
function refreshCreditsCalc() {
  _data.credits.forEach(function(r, i) {
    var principal  = parseFloat((r.montant||'').toString().replace(',','.')) || 0;
    var taux       = parseFloat((r.tauxInteret||'').toString().replace(',','.')) || 0;
    var interet    = (principal > 0 && taux > 0) ? principal * taux / 100 / 12 : 0;
    var mensualite = principal + interet;
    var tvaAmount  = interet * (parseFloat(r.tvaRate)||20) / 100;
    var mensEl = document.getElementById('cred-mens-' + i);
    var intEl  = document.getElementById('cred-int-'  + i);
    var tvaEl  = document.getElementById('cred-tva-'  + i);
    if (mensEl) mensEl.textContent = mensualite > 0 ? fmtN(mensualite) + ' ‚Ç¨' : '‚Äî';
    if (intEl)  intEl.textContent  = interet    > 0 ? fmtN(interet)    + ' ‚Ç¨' : '‚Äî';
    if (tvaEl)  tvaEl.textContent  = tvaAmount  > 0 ? fmtN(tvaAmount)  + ' ‚Ç¨' : '‚Äî';
  });
  refreshTotals();
}

function delRow(key, i, tbodyId, renderFn) {
  var r = _data[key] && _data[key][i];
  // Leasing et chargesVar/Fixe avec fournisseur ‚Üí proposer suppression multi-mois
  if ((key === 'leasing' || key === 'chargesVar' || key === 'chargesFixe') && r && r.fournisseur) {
    openScopeModal({
      type:'delete', dataKey:key, rowIdx:i,
      fournisseur: r.fournisseur, lineType: r.type||'',
      tbodyId: tbodyId, renderFn: function(arr){ return renderFn(arr); }
    });
  } else {
    _doDelRow(key, i, tbodyId, renderFn);
  }
}
function _doDelRow(key, i, tbodyId, renderFn) {
  _data[key].splice(i, 1);
  if (_data[key].length === 0) {
    if (key === 'rentreesSupp') _data[key].push({type:'', montant:''});
    else _data[key].push({fournisseur:'', type:'', montantHT:'', tvaRate:20, deductible:'Oui', pointe:'Non'});
  }
  document.getElementById(tbodyId).innerHTML = renderFn(_data[key]);
  refreshTotals();
  scheduleSave();
}

function addFacturePro() {
  if (!_data.facturesPro) _data.facturesPro = [];
  _data.facturesPro.push({client:'', description:'', ht055:'', ht10:'', ht20:''});
  document.getElementById('fp-tbody').innerHTML = renderFacturesPro(_data.facturesPro);
  refreshTotals();
}

function updateFacturePro(i, field, val) {
  if (!_data.facturesPro) _data.facturesPro = [];
  _data.facturesPro[i][field] = val;
  // Recalcul en temps r√©el des spans de la ligne
  var r = _data.facturesPro[i];
  var h055 = parseFloat(r.ht055)||0, h10 = parseFloat(r.ht10)||0, h20 = parseFloat(r.ht20)||0;
  var ht  = h055 + h10 + h20;
  var ttc = h055*1.055 + h10*1.10 + h20*1.20;
  var tva = h055*0.055 + h10*0.10 + h20*0.20;
  var elHT  = document.getElementById('fp-ht-'  + i);
  var elTTC = document.getElementById('fp-ttc-' + i);
  var elTVA = document.getElementById('fp-tva-' + i);
  if (elHT)  elHT.textContent  = ht  ? fmtN(ht)  : '‚Äî';
  if (elTTC) elTTC.textContent = ttc ? fmtN(ttc) : '‚Äî';
  if (elTVA) elTVA.textContent = tva ? fmtN(tva) : '‚Äî';
  refreshTotals();
  scheduleSave();
}

function delFacturePro(i) {
  _data.facturesPro.splice(i, 1);
  if (_data.facturesPro.length === 0) _data.facturesPro = [{client:'', description:'', ht055:'', ht10:'', ht20:''}];
  document.getElementById('fp-tbody').innerHTML = renderFacturesPro(_data.facturesPro);
  refreshTotals();
}

function addPrevLine() {
  if (!_data.previsionCA) _data.previsionCA = [];
  _data.previsionCA.push({type:'', montant:''});
  var t = calcTotals(_data);
  var tbody = document.getElementById('prev-tbody');
  if (tbody) tbody.innerHTML = renderPrevCA(_data.previsionCA, t.caHT);
  refreshTotals();
}

function addRentree() {
  _data.rentreesSupp.push({type:'', montant:''});
  document.getElementById('rsupp-tbody').innerHTML = renderRentrees(_data.rentreesSupp);
}

function updateChargeHT(key, i, value) {
  _data[key][i].montantHT = value;
  var ht   = parseFloat((value||"").replace(",",".")) || 0;
  var rate = parseFloat(_data[key][i].tvaRate) || 0;
  var el   = document.getElementById(key + '-ttc-' + i);
  if (el) el.value = ht > 0 ? (ht*(1+rate/100)).toFixed(2) : '';
  refreshTotals();
}
function updateChargeTTC(key, i, value) {
  var ttc  = parseFloat((value||"").replace(",",".")) || 0;
  var rate = parseFloat(_data[key][i].tvaRate) || 0;
  var ht   = ttc > 0 ? (rate > 0 ? ttc/(1+rate/100) : ttc) : 0;
  _data[key][i].montantHT = ht > 0 ? ht.toFixed(4) : '';
  var el = document.getElementById(key + '-ht-' + i);
  if (el) el.value = ht > 0 ? ht.toFixed(2) : '';
  refreshTotals();
}
function updateChargeTVARate(key, i, value) {
  _data[key][i].tvaRate = parseFloat(value);
  var ht = pf(_data[key][i].montantHT);
  if (ht > 0) {
    var el = document.getElementById(key + '-ttc-' + i);
    if (el) el.value = (ht*(1+parseFloat(value)/100)).toFixed(2);
  }
  refreshTotals();
}

var _dupLineIdx = null;
function duplicateFixeLine(i) {
  _dupLineIdx = i;
  var ligne = _data.chargesFixe[i];
  var label = (ligne.fournisseur||'') + (ligne.type?' ‚Äì '+ligne.type:'');
  var el = document.getElementById('modal-nb-lignes');
  if(el) el.textContent = '"' + (label||'cette ligne') + '"';
  var currentM = parseInt(document.getElementById('monthSelect').value);
  var fromSel = document.getElementById('modal-from');
  var toSel = document.getElementById('modal-to');
  var yearSel = document.getElementById('modal-year');
  var yearCur = document.getElementById('modal-year-cur');
  var yearNext = document.getElementById('modal-year-next');
  if(fromSel) fromSel.value = (currentM + 1) % 12;
  if(toSel) toSel.value = 11;
  var yearPrev = document.getElementById('modal-year-prev');
  if(yearPrev) { yearPrev.value = window._year-1; yearPrev.textContent = window._year-1; }
  if(yearCur) { yearCur.value = window._year; yearCur.textContent = window._year; }
  if(yearNext) { yearNext.value = window._year+1; yearNext.textContent = window._year+1; }
  if(yearSel) yearSel.value = window._year;
  // Changer le bouton appliquer pour mode ligne unique
  document.getElementById('fixedModal').classList.add('show');
  document.getElementById('fixedModal').dataset.mode = 'line';
}

function openFixedModal() {
  _dupLineIdx = null;
  var nb = _data.chargesFixe.filter(function(c){return c.fournisseur||c.montantHT;}).length;
  var el = document.getElementById('modal-nb-lignes');
  if(el) el.textContent = nb + ' ligne' + (nb>1?'s':'');
  var currentM = parseInt(document.getElementById('monthSelect').value);
  var fromSel = document.getElementById('modal-from');
  var toSel = document.getElementById('modal-to');
  var yearSel = document.getElementById('modal-year');
  var yearCur = document.getElementById('modal-year-cur');
  var yearNext = document.getElementById('modal-year-next');
  if(fromSel) fromSel.value = (currentM + 1) % 12;
  if(toSel) toSel.value = 11;
  var yearPrev = document.getElementById('modal-year-prev');
  if(yearPrev) { yearPrev.value = window._year-1; yearPrev.textContent = window._year-1; }
  if(yearCur) { yearCur.value = window._year; yearCur.textContent = window._year; }
  if(yearNext) { yearNext.value = window._year+1; yearNext.textContent = window._year+1; }
  if(yearSel) yearSel.value = window._year;
  document.getElementById('fixedModal').dataset.mode = 'all';
  document.getElementById('fixedModal').classList.add('show');
}

/* ‚îÄ‚îÄ‚îÄ CALCULS ‚îÄ‚îÄ‚îÄ */
function calcTotals(data) {
  // CA journalier (tableau de saisie quotidienne)
  var caHT055 = data.ca.reduce(function(s,r){return s+(parseFloat(r.ht055)||0);},0);
  var caHT10  = data.ca.reduce(function(s,r){return s+(parseFloat(r.ht10)||0);},0);
  var caHT20  = data.ca.reduce(function(s,r){return s+(parseFloat(r.ht20)||0);},0);
  var caHT_j = caHT055 + caHT10 + caHT20;
  // Factures Pro
  var fpRows = data.facturesPro || [];
  var caFP055 = fpRows.reduce(function(s,r){return s+(parseFloat(r.ht055)||0);},0);
  var caFP10  = fpRows.reduce(function(s,r){return s+(parseFloat(r.ht10)||0);},0);
  var caFP20  = fpRows.reduce(function(s,r){return s+(parseFloat(r.ht20)||0);},0);
  var caFP_HT = caFP055 + caFP10 + caFP20;
  // CA total (journalier + factures pro)
  var caHT_total055 = caHT055 + caFP055;
  var caHT_total10  = caHT10  + caFP10;
  var caHT_total20  = caHT20  + caFP20;
  var caHT = caHT_j + caFP_HT;
  var caTTC = caHT_total055*1.055 + caHT_total10*1.10 + caHT_total20*1.20;
  var tvaCollectee = caHT_total055*0.055 + caHT_total10*0.10 + caHT_total20*0.20;
  var rentreesSupp = data.rentreesSupp.reduce(function(s,r){return s+(parseFloat(r.montant)||0);},0);
  var prevCA = data.previsionCA.reduce(function(s,r){return s+(parseFloat(r.montant)||0);},0);
  var fixesHT=0,fixesTTC=0,fixesTVA=0;
  data.chargesFixe.forEach(function(r){var h=pf(r.montantHT);fixesHT+=h;fixesTTC+=h*(1+(r.tvaRate||0)/100);if(r.deductible==='Oui')fixesTVA+=h*(r.tvaRate||0)/100;});
  var varHT=0,varTTC=0,varTVA=0,varHT_excep=0,varTTC_excep=0;
  data.chargesVar.forEach(function(r){
    var h=pf(r.montantHT);
    var ttc=h*(1+(r.tvaRate||0)/100);
    if(r.exceptionnel){
      varHT_excep+=h; varTTC_excep+=ttc;
    } else {
      varHT+=h; varTTC+=ttc;
      if(r.deductible==='Oui') varTVA+=h*(r.tvaRate||0)/100;
    }
  });
  var leasingHT=0,leasingTTC=0,leasingTVA=0;
  data.leasing.forEach(function(r){
    if (r.dateDebut && r.dateFin && curMonthKey) {
      if (curMonthKey < r.dateDebut || curMonthKey > r.dateFin) return;
    }
    var h=pf(r.montantHT);leasingHT+=h;leasingTTC+=h*(1+(r.tvaRate||0)/100);if(r.deductible==='Oui')leasingTVA+=h*(r.tvaRate||0)/100;
  });
  var creditsPrincipal=0,creditsInteret=0,creditsTVA=0;
  var curMonthKey = getMonthKey ? getMonthKey() : '';
  // Migrer si ancienne structure paires principal+interet
  var creditsToCalc = migrateCreditsToSingleLine ? migrateCreditsToSingleLine(data.credits.slice()) : data.credits;
  creditsToCalc.forEach(function(r){
    // Filtre dynamique : si dates renseign√©es, ne compter que si le mois est dans la plage
    if (r.dateDebut && r.dateFin && curMonthKey) {
      if (curMonthKey < r.dateDebut.slice(0,7) || curMonthKey > r.dateFin.slice(0,7)) return;
    }
    var parseVal = function(v){ return parseFloat((v||'').toString().replace(',','.')) || 0; };
    var principal = parseVal(r.montant);
    var interet   = (function(){ var p=principal, taux=parseVal(r.tauxInteret); return (p>0&&taux>0)?p*taux/100/12:0; })();
    creditsPrincipal += principal;
    creditsInteret   += interet;
    creditsTVA       += interet * (parseFloat(r.tvaRate)||20) / 100;
  });
  var chargesHT = fixesHT+varHT+creditsPrincipal+creditsInteret+leasingHT;
  var tvaDed = fixesTVA+varTVA+creditsTVA+leasingTVA;
  var tvaDue = tvaCollectee-tvaDed;
  var resultat = caHT+rentreesSupp-chargesHT;
  var cashflow = caHT+rentreesSupp-(fixesTTC+varTTC+creditsPrincipal+creditsInteret+leasingTTC);
  var delta = resultat-(prevCA-chargesHT);
  return {caHT,caHT_j,caFP_HT,caHT055,caHT10,caHT20,caTTC,tvaCollectee,rentreesSupp,prevCA,fixesHT,fixesTTC,fixesTVA,varHT,varTTC,varTVA,varHT_excep,varTTC_excep,leasingHT,leasingTTC,leasingTVA,creditsPrincipal,creditsInteret,creditsTVA,chargesHT,tvaDed,tvaDue,resultat,cashflow,delta,caFP055,caFP10,caFP20};
}

function refreshTotals() {
  var t = calcTotals(_data);
  function s(id,v,cls){var el=document.getElementById(id);if(!el)return;el.textContent=typeof v==='string'?v:fmtN(v);if(cls){el.className=el.className.replace(/positive|negative/g,'').trim();el.classList.add(cls);}}
  s('tot-ca055',t.caHT055);s('tot-ca10',t.caHT10);s('tot-ca20',t.caHT20);
  // Footer tableau CA journalier = journalier SEULEMENT (sans factures pro)
  s('tot-caHT', t.caHT_j);
  s('tot-caTTC', t.caHT055*1.055 + t.caHT10*1.10 + t.caHT20*1.20);
  s('tot-tvaC',  t.caHT055*0.055 + t.caHT10*0.10 + t.caHT20*0.20);
  var fpR = _data.facturesPro || [];
  var fp055=fpR.reduce(function(s,r){return s+(parseFloat(r.ht055)||0);},0);
  var fp10=fpR.reduce(function(s,r){return s+(parseFloat(r.ht10)||0);},0);
  var fp20=fpR.reduce(function(s,r){return s+(parseFloat(r.ht20)||0);},0);
  s('tot-fp055',fp055);s('tot-fp10',fp10);s('tot-fp20',fp20);
  s('tot-fpHT',fp055+fp10+fp20);
  s('tot-fpTTC',fp055*1.055+fp10*1.10+fp20*1.20);
  s('tot-fpTVA',fp055*0.055+fp10*0.10+fp20*0.20);
  s('tot-rsupp',t.rentreesSupp);s('tot-prev',t.prevCA);
  // Mettre √† jour le CA r√©el et l'√©cart dans la section pr√©vision
  var totPrevReelEl = document.getElementById('tot-prev-reel');
  var totPrevEcartEl = document.getElementById('tot-prev-ecart');
  if (totPrevReelEl) totPrevReelEl.textContent = fmtN(t.caHT) + ' ‚Ç¨';
  if (totPrevEcartEl) {
    var ecartTotal = t.caHT - t.prevCA;
    totPrevEcartEl.style.color = ecartTotal >= 0 ? '#10b981' : '#ef4444';
    totPrevEcartEl.textContent = (ecartTotal >= 0 ? '+' : '') + fmtN(ecartTotal) + ' ‚Ç¨';
  }
  // Mettre √† jour uniquement les cellules r√©el/√©cart sans re-render (pour ne pas perdre le focus)
  if (_data && _data.previsionCA) {
    var totalPrevu = _data.previsionCA.reduce(function(s,r){ return s+(parseFloat(r.montant)||0); }, 0);
    _data.previsionCA.forEach(function(r, i) {
      var reelEl = document.getElementById('prev-reel-' + i);
      var ecartEl = document.getElementById('prev-ecart-' + i);
      if (!reelEl || !ecartEl) return;
      var prevu = parseFloat(r.montant)||0;
      var reel = (totalPrevu > 0 && t.caHT > 0 && prevu > 0)
        ? t.caHT * (prevu / totalPrevu)
        : (i === 0 && t.caHT > 0 ? t.caHT : 0);
      var ecart = reel - prevu;
      if (t.caHT > 0) {
        reelEl.innerHTML = '<span style="font-weight:600;color:var(--blue-main)">' + fmtN(reel) + ' ‚Ç¨</span>';
        ecartEl.innerHTML = '<span style="font-weight:700;color:' + (ecart>=0?'#10b981':'#ef4444') + '">' + (ecart>=0?'+':'') + fmtN(ecart) + ' ‚Ç¨</span>';
      } else {
        reelEl.innerHTML = '<span style="color:var(--muted);font-size:11px">En attente</span>';
        ecartEl.innerHTML = '<span style="color:var(--muted)">‚Äî</span>';
      }
    });
  }
  s('tot-fixHT',t.fixesHT);s('tot-fixTTC',t.fixesTTC);s('tot-fixTVA',t.fixesTVA);
  s('tot-varHT',t.varHT);s('tot-varTTC',t.varTTC);s('tot-varTVA',t.varTVA);
  // Ligne exceptionnel
  var excepRow = document.getElementById('var-excep-row');
  if (excepRow) {
    if (t.varHT_excep > 0) {
      excepRow.style.display = '';
      excepRow.innerHTML = '<td colspan="3" style="color:#f97316;font-size:11px;padding:5px 9px">‚ö° Dont exceptionnel (exclu du total)</td>' +
        '<td style="color:#f97316;font-weight:700">' + fmtN(t.varHT_excep) + ' ‚Ç¨</td>' +
        '<td>‚Äî</td>' +
        '<td style="color:#f97316;font-weight:700">' + fmtN(t.varTTC_excep) + ' ‚Ç¨</td>' +
        '<td colspan="3"></td>';
    } else {
      excepRow.style.display = 'none';
    }
  }
  s('tot-leasHT',t.leasingHT);s('tot-leasTTC',t.leasingTTC);
  s('tot-credP',t.creditsPrincipal);s('tot-credMens',t.creditsPrincipal+t.creditsInteret);s('tot-credInt',t.creditsInteret);s('tot-credTVA',t.creditsTVA);
  s('tva-c',fmtN(t.tvaCollectee)+' ‚Ç¨');s('tva-d',fmtN(t.tvaDed)+' ‚Ç¨');s('tva-due',fmtN(Math.abs(t.tvaDue))+' ‚Ç¨');
  s('cf-val',fmt(t.cashflow),t.cashflow>=0?'positive':'negative');
  s('cf-prev',fmt(t.prevCA-t.chargesHT));
  s('cf-delta',fmt(t.delta),t.delta>=0?'positive':'negative');
  s('s-ca',fmt(t.caHT));s('s-ch',fmt(t.chargesHT));
  var detEl=document.getElementById('s-ca-detail');
  if(detEl) detEl.textContent='Journalier : '+fmtE(t.caHT_j)+' ¬∑ Factures pro : '+fmtE(t.caFP_HT);
  s('s-res',fmt(t.resultat),t.resultat>=0?'positive':'negative');
  s('s-tvac',fmt(t.tvaCollectee));s('s-tvad',fmt(t.tvaDue),t.tvaDue>=0?'negative':'positive');
}


function openCreditScopeUpdate(i) {
  var r = _data.credits[i];
  openScopeModal({
    type: 'update', dataKey: 'credits', rowIdx: i,
    fournisseur: r.fournisseur || '',
    ligneType: r.ligneType || 'principal',
    currentVal: r.montant || '',
    tbodyId: 'cred-tbody', renderFn: null
  });
}
function openCreditScopeDel(i) {
  var r = _data.credits[i];
  openScopeModal({
    type: 'delete', dataKey: 'credits', rowIdx: i,
    fournisseur: r.fournisseur || '',
    ligneType: r.ligneType || 'principal',
    tbodyId: 'cred-tbody', renderFn: null
  });
}
function openChargeScopeUpdate(key, i) {
  var r = _data[key][i];
  var tbId = key==='chargesFixe'?'cf-tbody':key==='chargesVar'?'cv-tbody':'leas-tbody';
  openScopeModal({
    type: 'update', dataKey: key, rowIdx: i,
    fournisseur: r.fournisseur || '',
    lineType: r.type || '',
    currentVal: r.montantHT || '',
    tbodyId: tbId,
    renderFn: function(arr){ return renderCharges(arr, key); }
  });
}

/* ‚îÄ‚îÄ‚îÄ MODAL DE PORT√âE (suppr / modif prix) ‚îÄ‚îÄ‚îÄ */
var _scopeAction = null; // {type:'delete'|'update', dataKey, rowIdx, fournisseur, lineKey, newVal}

function openScopeModal(action) {
  _scopeAction = action;
  // Titre et description
  var title = document.getElementById('scope-title');
  var desc  = document.getElementById('scope-desc');
  var priceWrap = document.getElementById('scope-price-wrap');
  var confirmBtn = document.getElementById('scope-confirm-btn');
  if (action.type === 'delete') {
    title.textContent = 'üóë Supprimer cette ligne';
    desc.textContent  = 'Supprimer "' + (action.fournisseur||action.lineKey||'cette ligne') + '" sur :';
    priceWrap.style.display = 'none';
    confirmBtn.textContent = 'üóë Supprimer';
    confirmBtn.className = 'btn btn-danger';
  } else {
    title.textContent = '‚úèÔ∏è Modifier le montant';
    desc.textContent  = 'Appliquer le nouveau prix sur "' + (action.fournisseur||'cette ligne') + '" sur :';
    priceWrap.style.display = 'block';
    document.getElementById('scope-price-input').value = action.currentVal || '';
    confirmBtn.textContent = '‚úèÔ∏è Appliquer';
    confirmBtn.className = 'btn btn-orange';
  }
  // Pr√©-remplir la p√©riode
  var curM = parseInt(document.getElementById('monthSelect').value);
  document.getElementById('scope-from').value = curM;
  document.getElementById('scope-to').value = 11;
  var yc = document.getElementById('scope-year-cur');
  var yn = document.getElementById('scope-year-next');
  if(yc){yc.value=window._year;yc.textContent=window._year;}
  if(yn){yn.value=window._year+1;yn.textContent=window._year+1;}
  document.getElementById('scope-year').value = window._year;
  // Mode par d√©faut = current
  document.querySelector('input[name="scopeMode"][value="current"]').checked = true;
  document.getElementById('scope-period-picker').style.display = 'none';
  document.getElementById('scopeModal').classList.add('show');
}

// Afficher/cacher le picker de p√©riode selon le mode
document.addEventListener('change', function(e) {
  if (e.target.name === 'scopeMode') {
    document.getElementById('scope-period-picker').style.display =
      e.target.value === 'period' ? 'block' : 'none';
  }
});

function closeScopeModal() {
  document.getElementById('scopeModal').classList.remove('show');
  _scopeAction = null;
}

async function executeScopeAction() {
  if (!_scopeAction || !window._uid) return;
  // Lire toutes les valeurs du DOM AVANT de fermer le modal
  var a = _scopeAction;
  var mode = document.querySelector('input[name="scopeMode"]:checked').value;
  var newPrice = a.type==='update' ? parseFloat((document.getElementById('scope-price-input').value||'').replace(',','.')) : null;
  var fromM  = parseInt(document.getElementById('scope-from').value);
  var toM    = parseInt(document.getElementById('scope-to').value);
  var selY   = parseInt(document.getElementById('scope-year').value);
  closeScopeModal(); // fermer apr√®s avoir tout lu

  // Construire la liste des mois √† traiter
  var targets = [];
  var curM = parseInt(document.getElementById('monthSelect').value);

  if (mode === 'current') {
    targets = [{year: window._year, month: curM}];
  } else if (mode === 'period') {
    // fromM/toM/selY d√©j√† lus avant closeScopeModal
    if (fromM <= toM) {
      for (var m = fromM; m <= toM; m++) targets.push({year:selY, month:m});
    } else {
      for (var m = fromM; m <= 11; m++) targets.push({year:selY, month:m});
      for (var m = 0; m <= toM; m++)    targets.push({year:selY+1, month:m});
    }
  } else { // all ‚Äî chercher sur 3 ans autour de l'ann√©e courante
    for (var dy = -1; dy <= 2; dy++) {
      for (var m = 0; m < 12; m++) targets.push({year:window._year+dy, month:m});
    }
  }

  var count = 0;
  for (var t = 0; t < targets.length; t++) {
    var tgt = targets[t];
    var key = tgt.year + '-' + String(tgt.month+1).padStart(2,'0');
    try {
      var snap = await window._getDoc(window._doc(window._db,'pilotage',window._uid,'months',key));
      if (!snap.exists()) continue; // ne cr√©er pas de mois vides
      var md = snap.data();
      var arr = md[a.dataKey];
      if (!arr) continue;
      // Trouver la ligne par fournisseur + type ou lineKey
      var idx2 = arr.findIndex(function(r) {
        if (a.dataKey === 'credits') return r.fournisseur === a.fournisseur && r.ligneType === a.ligneType;
        return r.fournisseur === a.fournisseur && (r.type||'') === (a.lineType||'');
      });
      if (idx2 < 0) continue;
      if (a.type === 'delete') {
        arr.splice(idx2, 1);
        if (arr.length === 0) {
          if (a.dataKey === 'credits') arr.push({fournisseur:'',ligneType:'principal',montant:'',tvaRate:20,tvaAuto:false,tauxInteret:'',pointe:'Non',dateDebut:'',dateFin:''});
          else arr.push({fournisseur:'',type:'',montantHT:'',tvaRate:20,deductible:'Oui',pointe:'Non',dateDebut:'',dateFin:''});
        }
      } else {
        if (!isNaN(newPrice) && newPrice >= 0) {
          if (a.dataKey === 'credits') arr[idx2].montant = newPrice.toFixed(2);
          else arr[idx2].montantHT = newPrice.toFixed(2);
        }
      }
      md[a.dataKey] = arr;
      await window._setDoc(window._doc(window._db,'pilotage',window._uid,'months',key), md);
      count++;
    } catch(e) { console.warn('executeScopeAction erreur', key, e); }
  }

  // Appliquer aussi sur le mois courant en m√©moire si dans les cibles
  var inCurrentMonth = targets.some(function(t){return t.year===window._year && t.month===curM;});
  if (inCurrentMonth) {
    var arr2 = _data[a.dataKey];
    var idx3 = arr2 ? arr2.findIndex(function(r){
      if (a.dataKey==='credits') return r.fournisseur===a.fournisseur && r.ligneType===a.ligneType;
      return r.fournisseur===a.fournisseur && (r.type||'')===(a.lineType||'');
    }) : -1;
    if (idx3 >= 0) {
      if (a.type==='delete') {
        arr2.splice(idx3, 1);
        if (arr2.length===0) arr2.push({fournisseur:'',type:'',montantHT:'',tvaRate:20,deductible:'Oui',pointe:'Non'});
        var tb = document.getElementById(a.tbodyId);
        if (tb) tb.innerHTML = a.renderFn ? a.renderFn(_data[a.dataKey]) : renderCredits(_data.credits);
      } else {
        if (!isNaN(newPrice)) {
          if (a.dataKey==='credits') arr2[idx3].montant = newPrice.toFixed(2);
          else arr2[idx3].montantHT = newPrice.toFixed(2);
          // Re-render pour mettre √† jour les inputs
          var tb2 = document.getElementById(a.tbodyId);
          if (tb2) tb2.innerHTML = a.renderFn ? a.renderFn(_data[a.dataKey]) : renderCredits(_data.credits);
        }
      }
      refreshTotals();
    }
  }

  showToast((a.type==='delete'?'üóë Supprim√©':'‚úèÔ∏è Modifi√©') + ' sur ' + count + ' mois', 'success');
}

/* ‚îÄ‚îÄ‚îÄ MODAL CHARGES FIXES ‚îÄ‚îÄ‚îÄ */
function openFixedModal() {
  var nb = _data.chargesFixe.filter(function(c){return c.fournisseur||c.montantHT;}).length;
  var el = document.getElementById('modal-nb-lignes');
  if(el) el.textContent = nb + ' ligne' + (nb>1?'s':'');
  var currentM = parseInt(document.getElementById('monthSelect').value);
  // Pr√©-remplir : de mois suivant √† d√©cembre par d√©faut
  var fromSel = document.getElementById('modal-from');
  var toSel = document.getElementById('modal-to');
  var yearSel = document.getElementById('modal-year');
  var yearCur = document.getElementById('modal-year-cur');
  var yearNext = document.getElementById('modal-year-next');
  if(fromSel) fromSel.value = (currentM + 1) % 12;
  if(toSel) toSel.value = 11;
  var yearPrev = document.getElementById('modal-year-prev');
  if(yearPrev) { yearPrev.value = window._year-1; yearPrev.textContent = window._year-1; }
  if(yearCur) { yearCur.value = window._year; yearCur.textContent = window._year; }
  if(yearNext) { yearNext.value = window._year+1; yearNext.textContent = window._year+1; }
  if(yearSel) yearSel.value = window._year;
  document.getElementById('fixedModal').classList.add('show');
}
function closeModal()     { document.getElementById('fixedModal').classList.remove('show'); }
async function applyFixedCharges() {
  closeModal();
  if (!window._uid) return;
  var currentM = parseInt(document.getElementById('monthSelect').value);
  var isLineMode = document.getElementById('fixedModal').dataset.mode === 'line';
  var fixedCharges;
  if (isLineMode && _dupLineIdx !== null) {
    var l = _data.chargesFixe[_dupLineIdx];
    fixedCharges = (l.fournisseur||l.montantHT) ? [JSON.parse(JSON.stringify(l))] : [];
  } else {
    fixedCharges = JSON.parse(JSON.stringify(
      _data.chargesFixe.filter(function(c){return c.fournisseur||c.montantHT;})
    ));
  }
  if (!fixedCharges.length) { showToast('Aucune charge √† dupliquer', 'warning'); return; }
  var modeEl = document.querySelector('input[name="applyMode"]:checked');
  var mode = modeEl ? modeEl.value : 'empty';
  var fromM  = parseInt(document.getElementById('modal-from').value);
  var toM    = parseInt(document.getElementById('modal-to').value);
  var selYear = parseInt(document.getElementById('modal-year').value);
  // Construire la liste des mois √† traiter (g√®re le cas fromM > toM si chevauchement d'ann√©e)
  var targets = [];
  if (fromM <= toM) {
    for (var m = fromM; m <= toM; m++) targets.push({year: selYear, month: m});
  } else {
    // ex: nov ‚Üí mars = nov,dec (ann√©e N) + jan,fev,mar (ann√©e N+1)
    for (var m = fromM; m <= 11; m++) targets.push({year: selYear, month: m});
    for (var m = 0; m <= toM; m++)    targets.push({year: selYear+1, month: m});
  }
  var count = 0;
  for (var t = 0; t < targets.length; t++) {
    var tgt = targets[t];
    if (tgt.year === window._year && tgt.month === currentM) continue; // skip mois courant
    var key = tgt.year + '-' + String(tgt.month+1).padStart(2,'0');
    try {
      var snap = await window._getDoc(window._doc(window._db,'pilotage',window._uid,'months',key));
      var md = defaultData(tgt.year, tgt.month);
      if (snap.exists()) {
        var existing = snap.data();
        Object.keys(existing).forEach(function(k){ md[k] = existing[k]; });
      }
      var hasCharges = md.chargesFixe && md.chargesFixe.some(function(c){return c.fournisseur||c.montantHT;});
      if (isLineMode) {
        // Mode ligne : ajouter si n'existe pas d√©j√†
        if(!md.chargesFixe) md.chargesFixe = [];
        var already = md.chargesFixe.some(function(c){return c.fournisseur===fixedCharges[0].fournisseur && c.type===fixedCharges[0].type;});
        if(!already) { md.chargesFixe.push(fixedCharges[0]); await window._setDoc(window._doc(window._db,'pilotage',window._uid,'months',key), md); count++; }
        continue;
      }
      if (mode === 'all' || !hasCharges) {
        md.chargesFixe = fixedCharges;
        await window._setDoc(window._doc(window._db,'pilotage',window._uid,'months',key), md);
        count++;
      }
    } catch(e) { console.warn('applyFixedCharges erreur', key, e); }
  }
  showToast('‚ö° Appliqu√© sur ' + count + ' mois !', 'success');
}

/* ‚îÄ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ‚îÄ */
async function handleLogout() {
  await window._signOut(window._auth);
  window.location.href = 'index.html';
}
</script>
<script src="nav.js"></script>
<script>

/* ‚îÄ‚îÄ‚îÄ MONTH PICKER CUSTOM ‚îÄ‚îÄ‚îÄ */
var _mpActive = null; // {wrapperId, field, rowType, rowIdx}

var MP_MONTHS = ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];

function mpOpen(wrapperId, field, rowType, rowIdx) {
  // Fermer l'√©ventuel picker ouvert
  if (_mpActive) mpClose();
  var wrap = document.getElementById(wrapperId);
  if (!wrap) return;
  var popup = wrap.querySelector('.mp-popup');
  if (!popup) return;
  // Lire valeur courante
  var val = _mpGetVal(rowType, rowIdx, field); // 'YYYY-MM' ou ''
  var curYear  = val ? parseInt(val.split('-')[0]) : new Date().getFullYear();
  var curMonth = val ? parseInt(val.split('-')[1]) - 1 : -1; // 0-based ou -1
  popup.dataset.year  = curYear;
  popup.dataset.month = curMonth;
  popup.dataset.field    = field;
  popup.dataset.rowType  = rowType;
  popup.dataset.rowIdx   = rowIdx;
  // Positionner le popup sous le trigger
  var display = wrap.querySelector('.mp-display');
  var rect = display.getBoundingClientRect();
  // position:fixed => coordonn√©es viewport (pas besoin de scrollY)
  popup.style.top  = (rect.bottom + 4) + 'px';
  popup.style.left = rect.left + 'px';
  mpRender(popup, curYear, curMonth, rowType, rowIdx, field);
  popup.classList.add('open');
  _mpActive = wrapperId;
  // Stopper la propagation pour √©viter que le document click handler referme imm√©diatement
  event.stopPropagation();
}

function mpClose() {
  if (!_mpActive) return;
  var wrap = document.getElementById(_mpActive);
  if (wrap) { var p = wrap.querySelector('.mp-popup'); if(p) p.classList.remove('open'); }
  _mpActive = null;
}

function mpRender(popup, year, selMonth, rowType, rowIdx, field) {
  // R√©cup√©rer la plage pour colorier in-range
  var startVal = _mpGetVal(rowType, rowIdx, 'dateDebut');
  var endVal   = _mpGetVal(rowType, rowIdx, 'dateFin');
  var startY = startVal ? parseInt(startVal.split('-')[0]) : null;
  var startM = startVal ? parseInt(startVal.split('-')[1])-1 : null;
  var endY   = endVal   ? parseInt(endVal.split('-')[0])   : null;
  var endM   = endVal   ? parseInt(endVal.split('-')[1])-1 : null;

  var html = '<div class="mp-header">' +
    '<button class="mp-year-btn" onclick="event.stopPropagation();mpChangeYear(' + (year-1) + ',this)">‚Äπ</button>' +
    '<span class="mp-year-label">' + year + '</span>' +
    '<button class="mp-year-btn" onclick="event.stopPropagation();mpChangeYear(' + (year+1) + ',this)">‚Ä∫</button>' +
  '</div><div class="mp-months">';

  for (var m = 0; m < 12; m++) {
    var isSel = (m === selMonth);
    var isInRange = false;
    if (startY !== null && endY !== null) {
      var curAbs = year*12+m, sAbs = startY*12+startM, eAbs = endY*12+endM;
      isInRange = curAbs >= sAbs && curAbs <= eAbs;
    }
    var cls = 'mp-month-btn' + (isSel?' selected':isInRange?' in-range':'');
    html += '<button class="' + cls + '" onclick="event.stopPropagation();mpSelect(' + year + ',' + m + ',this)">' + MP_MONTHS[m] + '</button>';
  }
  html += '</div><button class="mp-clear" onclick="event.stopPropagation();mpClear(this)">‚úï Effacer</button>';
  // Vider sauf le trigger display et le popup lui-m√™me
  popup.innerHTML = html;
}

function mpChangeYear(newYear, btn) {
  var popup = btn.closest('.mp-popup');
  var selMonth = parseInt(popup.dataset.month);
  var field   = popup.dataset.field;
  var rowType = popup.dataset.rowType;
  var rowIdx  = parseInt(popup.dataset.rowIdx);
  popup.dataset.year = newYear;
  mpRender(popup, newYear, selMonth, rowType, rowIdx, field);
}

function mpSelect(year, month, btn) {
  var popup = btn.closest('.mp-popup');
  var field   = popup.dataset.field;
  var rowType = popup.dataset.rowType;
  var rowIdx  = parseInt(popup.dataset.rowIdx);
  var val = year + '-' + String(month+1).padStart(2,'0');
  popup.dataset.month = month;
  _mpSetVal(rowType, rowIdx, field, val);
  // Mettre √† jour le display
  var wrap = popup.closest('.mp-wrap');
  if (wrap) {
    var disp = wrap.querySelector('.mp-display');
    if (disp) {
      disp.classList.remove('empty');
      disp.innerHTML = '<span class="mp-icon">üìÖ</span>' + MP_MONTHS[month] + ' ' + year;
    }
  }
  mpRender(popup, year, month, rowType, rowIdx, field);
  scheduleSave();
  refreshTotals();
  event.stopPropagation();
  mpClose();
}

function mpClear(btn) {
  var popup = btn.closest('.mp-popup');
  var field   = popup.dataset.field;
  var rowType = popup.dataset.rowType;
  var rowIdx  = parseInt(popup.dataset.rowIdx);
  _mpSetVal(rowType, rowIdx, field, '');
  var wrap = popup.closest('.mp-wrap');
  if (wrap) {
    var disp = wrap.querySelector('.mp-display');
    if (disp) { disp.classList.add('empty'); disp.innerHTML = '<span class="mp-icon">üìÖ</span>' + (field==='dateDebut'?'D√©but':'Fin'); }
  }
  popup.dataset.month = -1;
  mpRender(popup, parseInt(popup.dataset.year), -1, rowType, rowIdx, field);
  scheduleSave();
  event.stopPropagation();
  mpClose();
}

function _mpGetVal(rowType, rowIdx, field) {
  if (rowType === 'credit')  return (_data.credits[rowIdx]  && _data.credits[rowIdx][field])  || '';
  if (rowType === 'leasing') return (_data.leasing[rowIdx]  && _data.leasing[rowIdx][field])  || '';
  return '';
}
function _mpSetVal(rowType, rowIdx, field, val) {
  if (rowType === 'credit')  { if(_data.credits[rowIdx])  _data.credits[rowIdx][field]  = val; }
  if (rowType === 'leasing') { if(_data.leasing[rowIdx])  _data.leasing[rowIdx][field]  = val; }
}

// Fermer si clic ext√©rieur
document.addEventListener('click', function(e) {
  if (!_mpActive) return;
  // Ne fermer que si le clic est en dehors du popup ET du trigger
  if (e.target.closest && e.target.closest('.mp-wrap')) return;
  mpClose();
});

function mpHtml(wrapperId, rowType, rowIdx, field, val) {
  var label = val ? (MP_MONTHS[parseInt(val.split('-')[1])-1] + ' ' + val.split('-')[0]) : (field==='dateDebut'?'D√©but':'Fin');
  var isEmpty = !val;
  return '<div class="mp-wrap" id="' + wrapperId + '">' +
    '<div class="mp-display' + (isEmpty?' empty':'') + '" onclick="mpOpen(\'' + wrapperId + '\',\'' + field + '\',\'' + rowType + '\',' + rowIdx + ')">' +
      '<span class="mp-icon">üìÖ</span>' + label +
    '</div>' +
    '<div class="mp-popup"></div>' +
  '</div>';
}

</script>
<script>
/* ‚îÄ‚îÄ‚îÄ CATALOGUE AUTOCOMPLETE (fournisseurs, clients, descriptions, types) ‚îÄ‚îÄ‚îÄ */

// Stockage en m√©moire par cat√©gorie
var _catalogues = {
  suppliers:    [],
  clients:      [],
  descriptions: [],
  types:        []
};
var _sugg_focused = -1;
var _currentCatTab = 'suppliers';

// Labels affich√©s
var _catLabels = {
  suppliers:    { emoji:'üè¢', name:'Fournisseur', minLen: 0 },
  clients:      { emoji:'üë§', name:'Client',      minLen: 3 },
  descriptions: { emoji:'üìù', name:'Description', minLen: 3 },
  types:        { emoji:'üè∑Ô∏è', name:'Type',        minLen: 3 }
};

/* ‚îÄ‚îÄ Charger depuis Firestore ‚îÄ‚îÄ */
async function loadSuppliers() {
  if (!window._uid || !window._getDoc || !window._db) return;
  try {
    var snap = await window._getDoc(window._doc(window._db, 'catalogues', window._uid));
    if (snap.exists()) {
      var d = snap.data();
      Object.keys(_catalogues).forEach(function(cat) {
        if (d[cat]) _catalogues[cat] = d[cat].filter(Boolean);
      });
    } else {
      // Compatibilit√© ancien doc 'suppliers'
      var snapOld = await window._getDoc(window._doc(window._db, 'suppliers', window._uid));
      if (snapOld.exists()) {
        _catalogues.suppliers = (snapOld.data().list || []).filter(Boolean);
      }
    }
  } catch(e) { console.warn('loadSuppliers error:', e); }

  // Enrichir depuis le mois courant en m√©moire
  _enrichCataloguesFromData(_data);

  // Scanner tous les mois depuis 2023 jusqu'√† l'ann√©e en cours +2
  // pour r√©cup√©rer clients/descriptions/fournisseurs m√™me si le catalogue √©tait vide
  var currentYear = new Date().getFullYear();
  var years = [];
  for (var y = 2023; y <= currentYear + 2; y++) years.push(y);
  var fetchPromises = [];
  years.forEach(function(y) {
    for (var m = 1; m <= 12; m++) {
      var key = y + '-' + String(m).padStart(2, '0');
      fetchPromises.push(
        window._getDoc(window._doc(window._db, 'pilotage', window._uid, 'months', key))
          .then(function(s) { if (s.exists()) _enrichCataloguesFromData(s.data()); })
          .catch(function() {})
      );
    }
  });
  await Promise.all(fetchPromises);

  // Persister le catalogue enrichi pour les prochaines fois
  _persistCatalogues();
}

function _enrichCataloguesFromData(data) {
  ['chargesFixe','chargesVar','leasing'].forEach(function(k) {
    (data[k] || []).forEach(function(r) {
      if (r.fournisseur && r.fournisseur.trim()) _addToCat('suppliers', r.fournisseur.trim());
      if (r.type && r.type.trim())         _addToCat('types', r.type.trim());
    });
  });
  (data.credits || []).forEach(function(r) {
    if (r.fournisseur && r.fournisseur.trim()) _addToCat('suppliers', r.fournisseur.trim());
  });
  (data.facturesPro || []).forEach(function(r) {
    if (r.client && r.client.trim())           _addToCat('clients', r.client.trim());
    if (r.description && r.description.trim()) _addToCat('descriptions', r.description.trim());
  });
}

function _addToCat(cat, value) {
  if (!value || !_catalogues[cat]) return;
  var v = value.trim();
  if (!v) return;
  if (!_catalogues[cat].some(function(s){ return s.toLowerCase() === v.toLowerCase(); })) {
    _catalogues[cat].push(v);
  }
}

/* ‚îÄ‚îÄ Persister dans Firestore ‚îÄ‚îÄ */
async function _persistCatalogues() {
  if (!window._uid || !window._setDoc || !window._db) return;
  try {
    await window._setDoc(
      window._doc(window._db, 'catalogues', window._uid),
      JSON.parse(JSON.stringify(_catalogues))
    );
  } catch(e) { console.warn('_persistCatalogues error:', e); }
}

/* ‚îÄ‚îÄ HTML g√©n√©rique d'un input avec autocomplete ‚îÄ‚îÄ */
function catalogInputHtml(cat, uid, value, styleStr, placeholder, onInputCode) {
  var safeVal = (value||'').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  return '<div class="sugg-wrap" id="wrap-' + uid + '">' +
    '<input class="cell-input" style="' + styleStr + '" placeholder="' + placeholder + '" value="' + safeVal + '" autocomplete="off"' +
      ' id="inp-' + uid + '"' +
      ' data-cat="' + cat + '"' +
      ' oninput="' + onInputCode + ';showCatSugg(this,\'' + uid + '\',\'' + cat + '\')"' +
      ' onfocus="showCatSugg(this,\'' + uid + '\',\'' + cat + '\')"' +
      ' onkeydown="onCatKey(event,\'' + uid + '\')"' +
      ' onblur="hideCatSugg(\'' + uid + '\')"' +
    '/>' +
    '<div class="sugg-list" id="sugg-' + uid + '"></div>' +
  '</div>';
}

// Alias pour le champ fournisseur (conserve l'ancien appel)
function supplierInputHtml(key, i, value) {
  return catalogInputHtml(
    'suppliers', key+'-sup-'+i, value, 'width:95px', 'Fournisseur',
    '_data[\''+key+'\']['+i+'].fournisseur=this.value'
  );
}

/* ‚îÄ‚îÄ Afficher les suggestions ‚îÄ‚îÄ */
function showCatSugg(inp, uid, cat) {
  var list = document.getElementById('sugg-' + uid);
  if (!list) return;
  var q = (inp.value || '').trim().toLowerCase();
  var minLen = (_catLabels[cat] && _catLabels[cat].minLen) || 0;

  if (q.length < minLen) { list.classList.remove('show'); return; }

  var pool = _catalogues[cat] || [];
  var matches = pool.filter(function(s) {
    return !q || s.toLowerCase().startsWith(q) || s.toLowerCase().includes(q);
  }).slice(0, 8);

  var isSupplier = (cat === 'suppliers');

  var html = matches.map(function(s) {
    var safeName = s.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    var fiche = isSupplier && _fichesMap ? _fichesMap[s.toLowerCase()] : null;
    var badge = fiche ? '<span style="font-size:10px;font-weight:700;padding:1px 6px;border-radius:8px;margin-left:4px;background:' + (fiche.recurrence==='R√©current'?'rgba(34,197,94,.12);color:#16a34a':'rgba(249,115,22,.12);color:#ea580c') + '">' + (fiche.recurrence||'') + '</span>' : '';
    var ficheBtn = fiche ? '<span class="sugg-fiche-btn" title="Voir fiche" onmousedown="event.stopPropagation();event.preventDefault();openFicheDetail(\'' + (fiche.id||'').replace(/'/g,"\\'") + '\')">üè¢</span>' : '';
    return '<div class="sugg-item sugg-item-supplier" onmousedown="pickCatItem(\'' + uid + '\',\'' + safeName + '\')">' +
      '<span class="sugg-item-name">' + s.replace(/</g,'&lt;') + badge + '</span>' +
      ficheBtn +
    '</div>';
  }).join('');

  // Option "Enregistrer" si valeur non vide et pas d√©j√† dans le catalogue
  if (q.length >= 2 && !pool.some(function(s){ return s.toLowerCase() === q; })) {
    var dispVal = inp.value.replace(/</g,'&lt;').replace(/>/g,'&gt;');
    html += '<div class="sugg-item-save" onmousedown="saveCatItem(\'' + uid + '\',\'' + cat + '\',\'' + inp.value.replace(/\\/g,'\\\\').replace(/'/g,"\\'") + '\')">üíæ Enregistrer ¬´ ' + dispVal + ' ¬ª</div>';
  }

  if (!html) { list.classList.remove('show'); return; }
  list.innerHTML = html;
  list.classList.add('show');
  _sugg_focused = -1;
}

function pickCatItem(uid, value) {
  var inp = document.getElementById('inp-' + uid);
  if (!inp) return;
  inp.value = value;
  inp.dispatchEvent(new Event('input', {bubbles:true}));
  hideCatSugg(uid);
}

function saveCatItem(uid, cat, value) {
  if (!value || !value.trim()) return;
  _addToCat(cat, value.trim());
  _persistCatalogues();
  var label = (_catLabels[cat] && _catLabels[cat].name) || cat;
  showToast('‚úì ' + label + ' ¬´ ' + value + ' ¬ª enregistr√©', 'success');
  var list = document.getElementById('sugg-' + uid);
  if (list) list.classList.remove('show');
}

function hideCatSugg(uid) {
  setTimeout(function() {
    var list = document.getElementById('sugg-' + uid);
    if (list) list.classList.remove('show');
  }, 150);
}

function onCatKey(e, uid) {
  var list = document.getElementById('sugg-' + uid);
  if (!list || !list.classList.contains('show')) return;
  var items = list.querySelectorAll('.sugg-item');
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    _sugg_focused = Math.min(_sugg_focused + 1, items.length - 1);
    items.forEach(function(it,j){ it.classList.toggle('focused', j===_sugg_focused); });
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    _sugg_focused = Math.max(_sugg_focused - 1, 0);
    items.forEach(function(it,j){ it.classList.toggle('focused', j===_sugg_focused); });
  } else if (e.key === 'Enter' && _sugg_focused >= 0 && items[_sugg_focused]) {
    e.preventDefault();
    items[_sugg_focused].dispatchEvent(new MouseEvent('mousedown'));
  } else if (e.key === 'Escape') {
    list.classList.remove('show');
  }
}

/* ‚îÄ‚îÄ Modal de gestion du catalogue ‚îÄ‚îÄ */
function openSuppliersModal() {
  _currentCatTab = 'suppliers';
  renderCatModalList();
  document.querySelectorAll('.cat-tab').forEach(function(t){ t.classList.toggle('active', t.dataset.cat === 'suppliers'); });
  switchSupplierMainTab('catalogue');
  var m = document.getElementById('suppliersModal');
  m.style.display = 'flex';
  setTimeout(function(){ var el = document.getElementById('sup-new-input'); if(el) el.focus(); }, 100);
}

function closeSuppliersModal() {
  document.getElementById('suppliersModal').style.display = 'none';
}

function switchCatTab(cat) {
  _currentCatTab = cat;
  document.querySelectorAll('.cat-tab').forEach(function(t){ t.classList.toggle('active', t.dataset.cat === cat); });
  var info = _catLabels[cat] || {};
  document.getElementById('sup-new-input').placeholder = 'Nouveau ' + (info.name || cat).toLowerCase() + '‚Ä¶';
  renderCatModalList();
}

function renderCatModalList() {
  var el = document.getElementById('sup-modal-list');
  var list = _catalogues[_currentCatTab] || [];
  if (!list.length) {
    el.innerHTML = '<p style="font-size:13px;color:var(--muted);text-align:center;padding:20px">Aucune valeur enregistr√©e.</p>';
    return;
  }
  var isSuppliers = (_currentCatTab === 'suppliers');
  el.innerHTML = list.slice().sort(function(a,b){ return a.localeCompare(b,'fr'); }).map(function(s) {
    var safeName = s.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    var fiche = isSuppliers && _fichesMap ? _fichesMap[s.toLowerCase()] : null;
    var ficheBtn = '';
    if (isSuppliers) {
      if (fiche) {
        var safeId = (fiche.id||'').replace(/'/g,"\\'");
        var recColor = fiche.recurrence==='R√©current' ? '#16a34a' : '#ea580c';
        var recBg    = fiche.recurrence==='R√©current' ? 'rgba(34,197,94,.1)' : 'rgba(249,115,22,.1)';
        ficheBtn = '<button onclick="openFicheDetail(\'' + safeId + '\');closeSuppliersModal()" ' +
          'style="background:' + recBg + ';color:' + recColor + ';border:none;border-radius:8px;font-size:11px;font-weight:700;padding:3px 9px;cursor:pointer;white-space:nowrap" ' +
          'title="Voir la fiche fournisseur">üè¢ ' + (fiche.recurrence||'Fiche') + '</button>';
      } else {
        ficheBtn = '<button onclick="convertirEnFiche(\'' + safeName + '\')" ' +
          'style="background:rgba(79,126,248,.08);color:var(--blue-main);border:1px solid rgba(79,126,248,.25);border-radius:8px;font-size:11px;font-weight:700;padding:3px 9px;cursor:pointer;white-space:nowrap" ' +
          'title="Cr√©er une fiche pour ce fournisseur">+ Cr√©er fiche</button>';
      }
    }
    return '<div class="sup-list-item">' +
      '<span style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis">' + s.replace(/</g,'&lt;') + '</span>' +
      (ficheBtn ? '<span style="flex-shrink:0">' + ficheBtn + '</span>' : '') +
      '<button onclick="removeCatItem(\'' + _currentCatTab + '\',\'' + safeName + '\')" title="Supprimer" style="flex-shrink:0">‚úï</button>' +
    '</div>';
  }).join('');
}


// Convertir un nom du catalogue en fiche fournisseur compl√®te
function convertirEnFiche(nom) {
  closeSuppliersModal();
  openFicheForm();
  setTimeout(function() {
    var inp = document.getElementById('ff-nom');
    if (inp) inp.value = nom;
  }, 60);
}

function addCatalogueFromModal() {
  var inp = document.getElementById('sup-new-input');
  var name = inp.value.trim();
  if (!name) return;
  _addToCat(_currentCatTab, name);
  _persistCatalogues();
  inp.value = '';
  renderCatModalList();
  var info = _catLabels[_currentCatTab] || {};
  showToast('‚úì ' + (info.name || _currentCatTab) + ' ajout√©', 'success');
}

function removeCatItem(cat, value) {
  _catalogues[cat] = (_catalogues[cat] || []).filter(function(s){ return s !== value; });
  _persistCatalogues();
  renderCatModalList();
}

// Conserver les anciennes fonctions pour compatibilit√© √©ventuelle
function addSupplierFromModal() { addCatalogueFromModal(); }
function removeSupplier(name) { removeCatItem('suppliers', name); }
function renderSuppliersModalList() { renderCatModalList(); }

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded', function() {
  var _checkFb = setInterval(function() {
    if (window._uid && window._db) {
      clearInterval(_checkFb);
      loadSuppliers();
    }
  }, 500);
});

var _origRenderPage = renderPage;
renderPage = function(data, month) {
  _origRenderPage(data, month);
  _enrichCataloguesFromData(data);
  // Si les fiches sont d√©j√† charg√©es, re-render les boutons üè¢/üìã
  if (_fichesMap && Object.keys(_fichesMap).length > 0) {
    var cfT = document.getElementById('cf-tbody');
    if (cfT) cfT.innerHTML = renderCharges(data.chargesFixe, 'chargesFixe');
    var cvT = document.getElementById('cv-tbody');
    if (cvT) cvT.innerHTML = renderCharges(data.chargesVar, 'chargesVar');
  }
};
</script>
<script>
/* ‚îÄ‚îÄ‚îÄ AUTOSAVE ‚îÄ‚îÄ‚îÄ */
var _saveTimer = null;
function scheduleSave() {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(function() { saveQuiet(); }, 1000);
}

document.addEventListener('input', function(e) {
  if (e.target.classList && e.target.classList.contains('cell-input')) scheduleSave();
});
document.addEventListener('change', function(e) {
  if (e.target.classList && e.target.classList.contains('cell-input')) scheduleSave();
});
</script>
<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   FICHES FOURNISSEURS
   Collection Firestore : fournisseurs/{uid}  ‚Üí { list: [...] }
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

var _fiches    = [];
var _fichesMap = {};

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

async function loadFiches() {
  if (!window._uid || !window._getDoc || !window._db) return;
  try {
    var snap = await window._getDoc(window._doc(window._db, 'fournisseurs', window._uid));
    _fiches = (snap.exists() && snap.data().list) ? snap.data().list : [];
    _buildFichesMap();
    var cfT = document.getElementById('cf-tbody');
    if (cfT && _data) cfT.innerHTML = renderCharges(_data.chargesFixe, 'chargesFixe');
    var cvT = document.getElementById('cv-tbody');
    if (cvT && _data) cvT.innerHTML = renderCharges(_data.chargesVar, 'chargesVar');
    // Refresh la liste catalogue si la modale est ouverte sur l'onglet suppliers
    var suppModal = document.getElementById('suppliersModal');
    if (suppModal && suppModal.style.display !== 'none' && _currentCatTab === 'suppliers') {
      renderCatModalList();
    }
  } catch(e) { console.warn('loadFiches error:', e); }
}

function _buildFichesMap() {
  _fichesMap = {};
  _fiches.forEach(function(f) { if (f.nom) _fichesMap[f.nom.toLowerCase()] = f; });
}

async function saveFiches() {
  if (!window._uid || !window._setDoc || !window._db) return;
  try {
    await window._setDoc(window._doc(window._db, 'fournisseurs', window._uid), { list: JSON.parse(JSON.stringify(_fiches)) });
    _buildFichesMap();
  } catch(e) { showToast('Erreur sauvegarde fiche', 'warning'); }
}

function switchSupplierMainTab(tab) {
  var isFiches = (tab === 'fiches');
  document.getElementById('tab-content-catalogue').style.display = isFiches ? 'none' : 'block';
  document.getElementById('tab-content-fiches').style.display    = isFiches ? 'block' : 'none';
  document.getElementById('tab-btn-catalogue').classList.toggle('active', !isFiches);
  document.getElementById('tab-btn-fiches').classList.toggle('active', isFiches);
  if (isFiches) renderFichesList();
}

function renderFichesList() {
  var el = document.getElementById('fiches-list');
  if (!el) return;
  if (!_fiches.length) {
    el.innerHTML = '<p style="font-size:13px;color:var(--muted);text-align:center;padding:20px">Aucune fiche. Cliquez sur "+ Nouvelle fiche" pour commencer.</p>';
    return;
  }
  el.innerHTML = _fiches.slice().sort(function(a,b){return (a.nom||'').localeCompare(b.nom||'','fr');}).map(function(f) {
    var recBadge = f.recurrence ? '<span class="fiche-badge ' + (f.recurrence==='R√©current'?'recurrent':'ponctuel') + '">' + esc(f.recurrence) + '</span>' : '';
    var meta = [f.categorie, f.ville].filter(Boolean).join(' ¬∑ ');
    var safeId = (f.id||'').replace(/'/g,"\\'");
    return '<div class="fiche-item" onclick="openFicheDetail(\'' + safeId + '\')">' +
      '<div class="fiche-item-left">' +
        '<div class="fiche-item-name">' + esc(f.nom||'') + ' ' + recBadge + '</div>' +
        (meta ? '<div class="fiche-item-meta">' + esc(meta) + '</div>' : '') +
      '</div>' +
      '<div class="fiche-item-actions">' +
        '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();openFicheDetail(\'' + safeId + '\')" title="Stats">üìä</button>' +
        '<button class="btn btn-outline btn-sm" onclick="event.stopPropagation();openFicheForm(\'' + safeId + '\')" title="Modifier">‚úèÔ∏è</button>' +
        '<button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteFiche(\'' + safeId + '\')" title="Supprimer">‚úï</button>' +
      '</div>' +
    '</div>';
  }).join('');
}

function openFicheForm(id) {
  var fiche = id ? _fiches.find(function(f){ return f.id===id; }) : null;
  var isNew = !fiche;
  if (isNew) fiche = {id:'',nom:'',adresse:'',ville:'',telephone:'',email:'',categorie:'',recurrence:'R√©current',notes:''};
  var safeId = (fiche.id||'').replace(/'/g,"\\'");
  document.getElementById('fiche-content').innerHTML =
    '<h3 style="margin-bottom:16px">' + (isNew ? '‚ûï Nouvelle fiche fournisseur' : '‚úèÔ∏è Modifier ‚Äî ' + esc(fiche.nom)) + '</h3>' +
    '<div class="fiche-form">' +
      '<div><label class="fiche-form-label">Nom du fournisseur *</label><input class="fiche-form-input" id="ff-nom" value="' + esc(fiche.nom) + '" placeholder="Metro, Grand Frais‚Ä¶"/></div>' +
      '<div><label class="fiche-form-label">Cat√©gorie</label><input class="fiche-form-input" id="ff-cat" value="' + esc(fiche.categorie) + '" placeholder="Alimentaire, Services‚Ä¶"/></div>' +
      '<div><label class="fiche-form-label">T√©l√©phone</label><input class="fiche-form-input" id="ff-tel" value="' + esc(fiche.telephone) + '" placeholder="0X XX XX XX XX"/></div>' +
      '<div><label class="fiche-form-label">Email</label><input class="fiche-form-input" id="ff-email" value="' + esc(fiche.email) + '" placeholder="contact@fournisseur.fr"/></div>' +
      '<div><label class="fiche-form-label">Adresse</label><input class="fiche-form-input" id="ff-adresse" value="' + esc(fiche.adresse) + '" placeholder="Rue, num√©ro‚Ä¶"/></div>' +
      '<div><label class="fiche-form-label">Ville</label><input class="fiche-form-input" id="ff-ville" value="' + esc(fiche.ville) + '" placeholder="Paris‚Ä¶"/></div>' +
      '<div><label class="fiche-form-label">R√©currence</label><select class="fiche-form-input" id="ff-rec"><option value="R√©current"' + (fiche.recurrence==='R√©current'?' selected':'') + '>R√©current (mensuel)</option><option value="Ponctuel"' + (fiche.recurrence==='Ponctuel'?' selected':'') + '>Ponctuel</option><option value="Mixte"' + (fiche.recurrence==='Mixte'?' selected':'') + '>Mixte</option></select></div>' +
      '<div class="full"><label class="fiche-form-label">Notes (conditions, d√©lais, contact d√©di√©‚Ä¶)</label><textarea class="fiche-form-input" id="ff-notes" rows="3" style="resize:vertical">' + esc(fiche.notes) + '</textarea></div>' +
    '</div>' +
    '<div class="modal-actions">' +
      '<button class="btn btn-outline" onclick="closeFicheModal()">Annuler</button>' +
      (!isNew ? '<button class="btn btn-outline" onclick="openFicheDetail(\'' + safeId + '\')">‚Üê Stats</button>' : '') +
      '<button class="btn btn-primary" onclick="saveFicheForm(\'' + (fiche.id||'') + '\')">üíæ Enregistrer</button>' +
    '</div>';
  document.getElementById('ficheModal').style.display = 'flex';
  setTimeout(function(){ var el=document.getElementById('ff-nom'); if(el) el.focus(); }, 50);
}

async function saveFicheForm(id) {
  var nom = (document.getElementById('ff-nom').value||'').trim();
  if (!nom) { showToast('Le nom est obligatoire', 'warning'); return; }
  var fiche = {
    id: id || ('f_' + Date.now()),
    nom: nom,
    categorie:  (document.getElementById('ff-cat').value||'').trim(),
    telephone:  (document.getElementById('ff-tel').value||'').trim(),
    email:      (document.getElementById('ff-email').value||'').trim(),
    adresse:    (document.getElementById('ff-adresse').value||'').trim(),
    ville:      (document.getElementById('ff-ville').value||'').trim(),
    recurrence: document.getElementById('ff-rec').value,
    notes:      (document.getElementById('ff-notes').value||'').trim()
  };
  if (id) {
    var idx = _fiches.findIndex(function(f){ return f.id===id; });
    if (idx >= 0) _fiches[idx] = fiche; else _fiches.push(fiche);
  } else {
    _fiches.push(fiche);
  }
  _addToCat('suppliers', nom);
  _persistCatalogues();
  await saveFiches();
  showToast('‚úÖ Fiche fournisseur enregistr√©e', 'success');
  closeFicheModal();
  var ficheTab = document.getElementById('tab-content-fiches');
  if (ficheTab && ficheTab.style.display !== 'none') renderFichesList();
  var cfT = document.getElementById('cf-tbody');
  if (cfT && _data) cfT.innerHTML = renderCharges(_data.chargesFixe, 'chargesFixe');
  var cvT = document.getElementById('cv-tbody');
  if (cvT && _data) cvT.innerHTML = renderCharges(_data.chargesVar, 'chargesVar');
}

async function deleteFiche(id) {
  if (!confirm('Supprimer cette fiche fournisseur ? Les donn√©es de charges ne seront pas effac√©es.')) return;
  _fiches = _fiches.filter(function(f){ return f.id !== id; });
  await saveFiches();
  showToast('üóë Fiche supprim√©e', 'success');
  renderFichesList();
}

function openFicheByName(nom) {
  var fiche = nom ? _fichesMap[nom.toLowerCase()] : null;
  if (fiche) {
    openFicheDetail(fiche.id);
  } else {
    openFicheForm();
    setTimeout(function() { var inp=document.getElementById('ff-nom'); if(inp) inp.value=nom; }, 60);
  }
}

async function openFicheDetail(id) {
  var fiche = _fiches.find(function(f){ return f.id===id; });
  if (!fiche) return;
  var safeId = id.replace(/'/g,"\\'");
  var infoItems = [];
  if (fiche.categorie)            infoItems.push({l:'Cat√©gorie', v:esc(fiche.categorie)});
  if (fiche.recurrence)           infoItems.push({l:'R√©currence', v:'<span class="fiche-badge ' + (fiche.recurrence==='R√©current'?'recurrent':'ponctuel') + '">' + esc(fiche.recurrence) + '</span>'});
  if (fiche.telephone)            infoItems.push({l:'T√©l√©phone', v:'<a href="tel:' + esc(fiche.telephone) + '" style="color:var(--blue-main)">' + esc(fiche.telephone) + '</a>'});
  if (fiche.email)                infoItems.push({l:'Email', v:'<a href="mailto:' + esc(fiche.email) + '" style="color:var(--blue-main)">' + esc(fiche.email) + '</a>'});
  if (fiche.adresse||fiche.ville) infoItems.push({l:'Adresse', v:esc([fiche.adresse,fiche.ville].filter(Boolean).join(', '))});

  document.getElementById('fiche-content').innerHTML =
    '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">' +
      '<h3 style="margin:0">üè¢ ' + esc(fiche.nom) + '</h3>' +
      '<button class="btn btn-outline btn-sm" onclick="openFicheForm(\'' + safeId + '\')">‚úèÔ∏è Modifier</button>' +
    '</div>' +
    (infoItems.length ? '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:16px;background:var(--bg);border-radius:10px;padding:12px">' +
      infoItems.map(function(it){ return '<div><div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px">' + it.l + '</div><div style="font-size:12px">' + it.v + '</div></div>'; }).join('') +
    '</div>' : '') +
    (fiche.notes ? '<div style="background:#fffbeb;border-radius:8px;padding:10px 14px;font-size:12px;color:#92400e;margin-bottom:16px;border:1px solid #fde68a">üìù ' + esc(fiche.notes) + '</div>' : '') +
    '<div id="fiche-stats-loading" style="text-align:center;padding:30px;color:var(--muted)"><div class="spin" style="margin:0 auto 8px;width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--blue-main);border-radius:50%;animation:spin .7s linear infinite"></div>Calcul des statistiques d\'achats‚Ä¶</div>' +
    '<div class="modal-actions"><button class="btn btn-outline" onclick="closeFicheModal()">Fermer</button></div>';

  document.getElementById('ficheModal').style.display = 'flex';
  var stats = await computeFicheStats(fiche.nom);
  renderFicheStats(stats, fiche);
}

async function computeFicheStats(nom) {
  var nomLow = nom.toLowerCase();
  var byMonth = {};
  var currentYear = new Date().getFullYear();
  // Le mois courant est lu depuis _data en m√©moire (plus √† jour que Firestore)
  var curKey = (typeof getMonthKey === 'function') ? getMonthKey() : '';

  var fetchPromises = [];
  for (var y = currentYear - 2; y <= currentYear + 1; y++) {
    for (var m = 1; m <= 12; m++) {
      var key = y + '-' + String(m).padStart(2,'0');
      if (key === curKey) continue; // mois courant : on utilisera _data
      (function(k) {
        fetchPromises.push(
          window._getDoc(window._doc(window._db, 'pilotage', window._uid, 'months', k))
            .then(function(snap) {
              if (!snap.exists()) return;
              var d = snap.data(); var total = 0;
              ['chargesFixe','chargesVar','leasing'].forEach(function(cat) {
                (d[cat]||[]).forEach(function(r) { if ((r.fournisseur||'').toLowerCase()===nomLow) total+=pf(r.montantHT); });
              });
              if (total > 0) byMonth[k] = total;
            }).catch(function(){})
        );
      })(key);
    }
  }
  // Mois courant depuis _data (v√©rit√© terrain, m√™me non sauvegard√©)
  if (curKey && typeof _data !== 'undefined' && _data) {
    var curTotal = 0;
    ['chargesFixe','chargesVar','leasing'].forEach(function(cat) {
      (_data[cat]||[]).forEach(function(r) { if ((r.fournisseur||'').toLowerCase()===nomLow) curTotal+=pf(r.montantHT); });
    });
    if (curTotal > 0) byMonth[curKey] = curTotal;
  }
  await Promise.all(fetchPromises);
  var yearKeys     = Object.keys(byMonth).filter(function(k){ return k.startsWith(String(currentYear)); });
  var prevYearKeys = Object.keys(byMonth).filter(function(k){ return k.startsWith(String(currentYear-1)); });
  var totalYear     = yearKeys.reduce(function(s,k){ return s+(byMonth[k]||0); }, 0);
  var totalPrevYear = prevYearKeys.reduce(function(s,k){ return s+(byMonth[k]||0); }, 0);
  var curMonthCA = (typeof _data!=='undefined' && _data) ? calcTotals(_data).caHT : 0;
  return { byMonth:byMonth, totalYear:totalYear, totalPrevYear:totalPrevYear, annualCA:curMonthCA*12, curMonthCA:curMonthCA, currentYear:currentYear };
}

function renderFicheStats(stats, fiche) {
  var curMonthKey = getMonthKey();
  var curMonthAmt = stats.byMonth[curMonthKey] || 0;
  var pctMois  = stats.curMonthCA  > 0 ? (curMonthAmt/stats.curMonthCA*100).toFixed(1)+'%' : '‚Äî';
  var pctAnnee = stats.annualCA    > 0 ? (stats.totalYear/stats.annualCA*100).toFixed(1)+'%' : '‚Äî';
  var sortedMonths = Object.keys(stats.byMonth).sort().reverse().slice(0, 24);
  var statsHtml =
    '<div class="fiche-stats-grid">' +
      '<div class="fiche-stat-card"><div class="fiche-stat-label">Mois en cours</div><div class="fiche-stat-value">' + fmtE(curMonthAmt) + '</div><div class="fiche-stat-sub">' + pctMois + ' du CA mensuel</div></div>' +
      '<div class="fiche-stat-card"><div class="fiche-stat-label">Total ' + stats.currentYear + '</div><div class="fiche-stat-value">' + fmtE(stats.totalYear) + '</div><div class="fiche-stat-sub">' + pctAnnee + ' du CA annuel (est.)</div></div>' +
      '<div class="fiche-stat-card"><div class="fiche-stat-label">Total ' + (stats.currentYear-1) + '</div><div class="fiche-stat-value">' + fmtE(stats.totalPrevYear) + '</div><div class="fiche-stat-sub">Ann√©e pr√©c√©dente</div></div>' +
    '</div>' +
    (sortedMonths.length > 0 ?
      '<div class="fiche-history"><div class="fiche-history-title">üìÖ Historique des achats (HT)</div>' +
        sortedMonths.map(function(k) {
          var amt = stats.byMonth[k]; var parts = k.split('-');
          var label = MONTHS[parseInt(parts[1])-1] + ' ' + parts[0];
          var pctCA = (stats.annualCA > 0) ? (amt/(stats.annualCA/12)*100).toFixed(1)+'%' : '';
          return '<div class="fiche-history-row"><span class="fiche-history-month">' + label + '</span><span class="fiche-history-amount">' + fmtE(amt) + '</span>' + (pctCA?'<span class="fiche-history-pct">'+pctCA+' CA est.</span>':'') + '</div>';
        }).join('') +
      '</div>'
    : '<p style="font-size:13px;color:var(--muted);text-align:center;padding:10px">Aucun achat enregistr√© pour ce fournisseur.</p>');
  var loadEl = document.getElementById('fiche-stats-loading');
  if (loadEl) loadEl.outerHTML = statsHtml;
}

function closeFicheModal() {
  document.getElementById('ficheModal').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
  var _checkFb2 = setInterval(function() {
    if (window._uid && window._db) { clearInterval(_checkFb2); loadFiches(); }
  }, 600);
});

document.addEventListener('click', function(e) {
  var modal = document.getElementById('ficheModal');
  if (modal && e.target === modal) closeFicheModal();
});
</script>

</body>
</html>
