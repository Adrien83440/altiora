<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE ‚Äî Dashboard RH</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --rh-dark:#052e16;--rh-main:#059669;--rh-light:#10b981;--rh-bright:#34d399;
      --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f0fdf7;--radius:12px;
      --red:#ef4444;--red-light:#fee2e2;--orange:#f59e0b;--orange-light:#fef3c7;
      --blue:#1a3dce;--purple:#6366f1;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}

    /* MAIN */
    .main{margin-left:250px;flex:1;display:flex;flex-direction:column;min-width:0;}

    /* TOPBAR */
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:17px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .topbar-left p{font-size:12px;color:var(--muted);margin-top:2px;}
    .topbar-right{display:flex;align-items:center;gap:10px;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;display:flex;align-items:center;gap:6px;}
    .btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-light));color:white;box-shadow:0 3px 10px rgba(5,150,105,.3);}
    .btn-rh:hover{opacity:.9;transform:translateY(-1px);}
    .btn-outline{background:white;color:var(--rh-main);border:1.5px solid var(--rh-border);}
    .btn-outline:hover{background:var(--rh-ghost);}
    .btn-sm{padding:6px 12px;font-size:12px;}
    .btn-xs{padding:3px 9px;font-size:11px;}

    /* CONTENT */
    .content{padding:22px 28px;flex:1;display:flex;flex-direction:column;gap:20px;}

    /* KPI ROW */
    .kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
    .kpi-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;position:relative;overflow:hidden;cursor:default;transition:box-shadow .2s;}
    .kpi-card:hover{box-shadow:0 4px 20px rgba(5,150,105,.1);}
    .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--rh-main),var(--rh-bright));}
    .kpi-card.orange::before{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
    .kpi-card.red::before{background:linear-gradient(90deg,#ef4444,#f87171);}
    .kpi-card.purple::before{background:linear-gradient(90deg,#6366f1,#a5b4fc);}
    .kpi-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;margin-bottom:12px;}
    .kpi-icon.green{background:var(--rh-ghost);}
    .kpi-icon.orange{background:#fef3c7;}
    .kpi-icon.red{background:#fee2e2;}
    .kpi-icon.purple{background:#eef2ff;}
    .kpi-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:5px;}
    .kpi-val{font-size:26px;font-weight:800;color:var(--text);line-height:1;}
    .kpi-sub{font-size:11px;color:var(--muted);margin-top:5px;}
    .kpi-trend{position:absolute;top:18px;right:16px;font-size:11px;font-weight:700;padding:3px 8px;border-radius:20px;}
    .kpi-trend.up{background:#d1fae5;color:#065f46;}
    .kpi-trend.down{background:#fee2e2;color:#991b1b;}
    .kpi-trend.warn{background:#fef3c7;color:#92400e;}

    /* GRID 2 COLONNES */
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
    .grid-3{display:grid;grid-template-columns:2fr 1fr;gap:18px;}

    /* CARDS */
    .card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:#fafffe;}
    .card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px;}
    .card-body{padding:16px 18px;}

    /* ALERTES */
    .alert-item{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:opacity .15s;}
    .alert-item:last-child{margin-bottom:0;}
    .alert-item:hover{opacity:.85;}
    .alert-item.warn{background:#fef9c3;border:1px solid #fde68a;}
    .alert-item.danger{background:#fee2e2;border:1px solid #fecaca;}
    .alert-item.info{background:#e0f2fe;border:1px solid #bae6fd;}
    .alert-item.success{background:#d1fae5;border:1px solid #a7f3d0;}
    .alert-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:3px;}
    .alert-dot.warn{background:#f59e0b;}
    .alert-dot.danger{background:#ef4444;}
    .alert-dot.info{background:#0ea5e9;}
    .alert-dot.success{background:#10b981;}
    .alert-text{font-size:12px;font-weight:600;color:var(--text);}
    .alert-sub{font-size:11px;color:var(--muted);}

    /* CONGES */
    .conge-item{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid #f1f5f9;}
    .conge-item:last-child{border-bottom:none;}
    .conge-av{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--rh-main),var(--rh-bright));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0;}
    .conge-info{flex:1;min-width:0;}
    .conge-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .conge-dates{font-size:11px;color:var(--muted);}
    .conge-days{font-size:11px;font-weight:700;color:var(--rh-main);white-space:nowrap;}
    .conge-actions{display:flex;gap:5px;}
    .btn-approve{background:#d1fae5;color:#065f46;border:none;border-radius:6px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;transition:.15s;}
    .btn-approve:hover{background:#a7f3d0;}
    .btn-reject{background:#fee2e2;color:#991b1b;border:none;border-radius:6px;padding:4px 10px;font-size:11px;font-weight:700;cursor:pointer;transition:.15s;}
    .btn-reject:hover{background:#fecaca;}

    /* EMPLOYES RECENTS */
    .emp-item{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid #f1f5f9;}
    .emp-item:last-child{border-bottom:none;}
    .emp-av{width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:white;flex-shrink:0;}
    .emp-name{font-size:12px;font-weight:600;}
    .emp-poste{font-size:11px;color:var(--muted);}
    .emp-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;white-space:nowrap;}
    .badge-cdi{background:#d1fae5;color:#065f46;}
    .badge-cdd{background:#fef3c7;color:#92400e;}
    .badge-stage{background:#e0f2fe;color:#075985;}
    .badge-alternance{background:#eef2ff;color:#3730a3;}

    /* CHART CONTAINER */
    .chart-wrap{position:relative;height:200px;}

    /* CO√õTS */
    .cout-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .cout-box{padding:12px 14px;border-radius:10px;background:var(--rh-ghost);border:1px solid var(--rh-border);}
    .cout-box.orange{background:#fef9c3;border-color:#fde68a;}
    .cout-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px;}
    .cout-val{font-size:16px;font-weight:800;color:var(--text);}
    .cout-sub{font-size:10px;color:var(--muted);margin-top:2px;}

    /* RECRUTEMENT */
    .recru-item{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f1f5f9;}
    .recru-item:last-child{border-bottom:none;}
    .recru-poste{font-size:12px;font-weight:600;}
    .recru-dept{font-size:11px;color:var(--muted);}
    .recru-pipeline{display:flex;align-items:center;gap:5px;}
    .pip-dot{width:7px;height:7px;border-radius:50%;}

    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(5,46,22,.4);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;width:100%;max-width:520px;box-shadow:0 24px 60px rgba(5,46,22,.2);overflow:hidden;}
    .modal-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#f0fdf4,#dcfce7);}
    .modal-head h3{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);}
    .modal-body{padding:20px 22px;max-height:65vh;overflow-y:auto;}
    .modal-foot{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;}

    /* EMPTY */
    .empty-sm{text-align:center;padding:24px;color:var(--muted);}
    .empty-sm .empty-icon{font-size:28px;margin-bottom:6px;}

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#052e16;color:white;padding:11px 18px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.success{background:#065f46;}
    .toast.err{background:#991b1b;}

    /* NOTIFICATIONS TOPBAR */
    .notif-btn{position:relative;background:white;border:1.5px solid var(--border);border-radius:9px;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:16px;transition:.15s;flex-shrink:0;}
    .notif-btn:hover{background:var(--rh-ghost);border-color:var(--rh-border);}
    .notif-bubble{position:absolute;top:-5px;right:-5px;background:#ef4444;color:white;font-size:9px;font-weight:800;width:17px;height:17px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;}
    .notif-dropdown{position:absolute;top:calc(100% + 10px);right:0;width:340px;background:white;border:1px solid var(--border);border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.12);z-index:200;display:none;}
    .notif-dropdown.show{display:block;}
    .notif-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);}
    .notif-header h4{font-size:13px;font-weight:700;}
    .notif-header span{font-size:11px;color:var(--rh-main);font-weight:600;cursor:pointer;}
    .notif-list{max-height:320px;overflow-y:auto;}
    .notif-item{display:flex;align-items:flex-start;gap:10px;padding:11px 16px;border-bottom:1px solid #f8faff;cursor:pointer;transition:.15s;}
    .notif-item:last-child{border-bottom:none;}
    .notif-item:hover{background:#fafffe;}
    .notif-item.unread{background:#f0fdf4;}
    .notif-ico{width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
    .notif-ico.danger{background:#fee2e2;}
    .notif-ico.warn{background:#fef3c7;}
    .notif-ico.info{background:#e0f2fe;}
    .notif-ico.success{background:#d1fae5;}
    .notif-text{font-size:12px;font-weight:600;color:var(--text);line-height:1.4;}
    .notif-sub{font-size:11px;color:var(--muted);margin-top:2px;}
    .notif-time{font-size:10px;color:var(--muted);margin-top:3px;}
    .notif-empty{text-align:center;padding:24px;color:var(--muted);font-size:12px;}

    /* TOP SALARI√âS */
    .top-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid #f1f5f9;}
    .top-row:last-child{border-bottom:none;}
    .top-rank{width:22px;height:22px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0;}
    .rank-1{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:white;}
    .rank-2{background:linear-gradient(135deg,#94a3b8,#64748b);color:white;}
    .rank-3{background:linear-gradient(135deg,#d97706,#b45309);color:white;}
    .rank-n{background:#f1f5f9;color:var(--muted);}
    .top-av{width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0;}
    .top-info{flex:1;min-width:0;}
    .top-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .top-poste{font-size:10px;color:var(--muted);}
    .top-stat{text-align:right;flex-shrink:0;}
    .top-val{font-size:12px;font-weight:800;color:var(--rh-main);}
    .top-sub{font-size:10px;color:var(--muted);}
    .top-bar-wrap{height:3px;background:#f1f5f9;border-radius:99px;overflow:hidden;margin-top:4px;}
    .top-bar{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--rh-main),var(--rh-bright));transition:width .6s ease;}

    /* STARS */
    .stars{display:flex;gap:1px;}
    .star{font-size:11px;}

    /* TEMPS TRAVAIL */
    .temps-kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
    .temps-box{background:var(--rh-ghost);border:1px solid var(--rh-border);border-radius:10px;padding:11px 14px;}
    .temps-box.orange{background:#fef9c3;border-color:#fde68a;}
    .temps-label{font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px;}
    .temps-val{font-size:15px;font-weight:800;color:var(--text);}

    /* R√âCOMPENSES */
    .recomp-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;margin-bottom:8px;border:1px solid var(--border);transition:.15s;}
    .recomp-item:last-child{margin-bottom:0;}
    .recomp-item:hover{background:var(--rh-ghost);border-color:var(--rh-border);}
    .recomp-medal{font-size:22px;flex-shrink:0;}
    .recomp-info{flex:1;min-width:0;}
    .recomp-name{font-size:12px;font-weight:700;}
    .recomp-type{font-size:11px;color:var(--muted);}
    .recomp-date{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;white-space:nowrap;flex-shrink:0;}
    .recomp-date.soon{background:#fef3c7;color:#92400e;}
    .recomp-date.future{background:#e0f2fe;color:#075985;}

    /* LOADER */
    .loader{display:flex;align-items:center;justify-content:center;padding:30px;color:var(--muted);gap:8px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:16px;height:16px;border:2px solid var(--rh-border);border-top-color:var(--rh-main);border-radius:50%;animation:spin .7s linear infinite;}

    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .content{animation:fadeIn .25s ease both;}

    /* MOBILE */
    @media(max-width:768px){
      .main{margin-left:0!important;}
      .content{padding:12px 10px!important;}
      .kpi-row{grid-template-columns:1fr 1fr!important;gap:8px!important;}
      .grid-2,.grid-3{grid-template-columns:1fr!important;gap:12px!important;}
      .cout-grid{grid-template-columns:1fr 1fr!important;}
      .topbar{padding:10px 10px 10px 62px!important;flex-wrap:wrap;gap:6px;}
      .topbar-right{width:100%;flex-wrap:wrap;gap:6px;}
      .topbar-right .btn{flex:1;font-size:11px;padding:6px 8px;}
    }
    @media(max-width:420px){
      .kpi-row{grid-template-columns:1fr!important;}
    }
  </style>
</head>
<body>

<!-- SIDEBAR inject√©e par nav.js -->

<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>üë• Dashboard RH</h1>
      <p id="topbar-date">Vue d'ensemble ¬∑ Ressources Humaines</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="location.href='rh-employes.html'">üë§ Employ√©s</button>
      <button class="btn btn-outline btn-sm" onclick="location.href='rh-conges.html'">üå¥ Cong√©s</button>
      <button class="btn btn-rh btn-sm" onclick="location.href='rh-recrutement.html'">+ Recrutement</button>
      <div style="position:relative" id="notif-wrap">
        <button class="notif-btn" onclick="toggleNotifDropdown()" id="notif-btn">üîî
          <span class="notif-bubble" id="notif-bubble" style="display:none">0</span>
        </button>
        <div class="notif-dropdown" id="notif-dropdown">
          <div class="notif-header"><h4>üîî Notifications RH</h4><span onclick="clearNotifs()">Tout marquer lu</span></div>
          <div class="notif-list" id="notif-list"><div class="notif-empty">Chargement...</div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="content">

    <!-- KPIs -->
    <div class="kpi-row" id="kpi-row">
      <div class="kpi-card"><div class="loader"><div class="spin"></div></div></div>
      <div class="kpi-card"><div class="loader"><div class="spin"></div></div></div>
      <div class="kpi-card orange"><div class="loader"><div class="spin"></div></div></div>
      <div class="kpi-card purple"><div class="loader"><div class="spin"></div></div></div>
    </div>

    <!-- GRAPHIQUES -->
    <div class="grid-2">
      <!-- Masse salariale 12 mois -->
      <div class="card">
        <div class="card-head">
          <div class="card-title">üìà √âvolution masse salariale <span style="font-size:10px;font-weight:400;color:var(--muted)">(12 derniers mois)</span></div>
          <button class="btn btn-outline btn-xs" onclick="location.href='rh-paie.html'">D√©tail ‚Üí</button>
        </div>
        <div class="card-body">
          <div class="chart-wrap"><canvas id="chartMasse"></canvas></div>
        </div>
      </div>

      <!-- R√©partition contrats -->
      <div class="card">
        <div class="card-head">
          <div class="card-title">ü•ß R√©partition contrats</div>
          <button class="btn btn-outline btn-xs" onclick="location.href='rh-employes.html'">Voir ‚Üí</button>
        </div>
        <div class="card-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:center;">
            <div style="position:relative;height:160px"><canvas id="chartContrats"></canvas></div>
            <div id="contrats-legend" style="display:flex;flex-direction:column;gap:7px;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ALERTES + CONG√âS + CO√õTS -->
    <div class="grid-3">

      <!-- Colonne gauche : Alertes + Cong√©s -->
      <div style="display:flex;flex-direction:column;gap:18px;">

        <!-- Alertes -->
        <div class="card">
          <div class="card-head">
            <div class="card-title">üîî Alertes RH <span id="alert-badge" style="font-size:10px;font-weight:700;background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:20px;margin-left:4px">0</span></div>
            <button class="btn btn-outline btn-xs" onclick="openAlerteModal()">Toutes ‚Üí</button>
          </div>
          <div class="card-body" id="alertes-body">
            <div class="loader"><div class="spin"></div></div>
          </div>
        </div>

        <!-- Cong√©s √† valider -->
        <div class="card">
          <div class="card-head">
            <div class="card-title">üå¥ Cong√©s √† valider <span id="conge-badge" style="font-size:10px;font-weight:700;background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:20px;margin-left:4px">0</span></div>
            <button class="btn btn-outline btn-xs" onclick="location.href='rh-conges.html'">G√©rer ‚Üí</button>
          </div>
          <div class="card-body" id="conges-body">
            <div class="loader"><div class="spin"></div></div>
          </div>
        </div>

      </div>

      <!-- Colonne droite : Co√ªts + Recrutement -->
      <div style="display:flex;flex-direction:column;gap:18px;">

        <!-- Co√ªts RH -->
        <div class="card" style="cursor:pointer" onclick="openCoutsModal()">
          <div class="card-head">
            <div class="card-title">üí∞ Co√ªts RH du mois</div>
            <span style="font-size:11px;color:var(--rh-main);font-weight:600">D√©tail ‚Üí</span>
          </div>
          <div class="card-body">
            <div class="cout-grid" id="couts-body">
              <div class="loader" style="grid-column:1/-1"><div class="spin"></div></div>
            </div>
          </div>
        </div>

        <!-- Postes ouverts -->
        <div class="card">
          <div class="card-head">
            <div class="card-title">üéØ Postes en recrutement</div>
            <button class="btn btn-outline btn-xs" onclick="location.href='rh-recrutement.html'">Pipeline ‚Üí</button>
          </div>
          <div class="card-body" id="recru-body">
            <div class="loader"><div class="spin"></div></div>
          </div>
        </div>

      </div>
    </div>

    <!-- TEMPS DE TRAVAIL + TOP SALARI√âS -->
    <div class="grid-2">

      <!-- Temps de travail global -->
      <div class="card">
        <div class="card-head">
          <div class="card-title">‚è± Temps de travail <span style="font-size:10px;font-weight:400;color:var(--muted)">‚Äî Ce mois</span></div>
          <button class="btn btn-outline btn-xs" onclick="location.href='rh-temps.html'">D√©tail ‚Üí</button>
        </div>
        <div class="card-body" id="temps-body">
          <div class="loader"><div class="spin"></div></div>
        </div>
      </div>

      <!-- Top salari√©s temps + notes -->
      <div class="card">
        <div class="card-head">
          <div class="card-title">üèÜ Top salari√©s</div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-xs" id="top-tab-temps" onclick="switchTopTab('temps')" style="background:var(--rh-ghost);color:var(--rh-main);border:1px solid var(--rh-border);border-radius:7px;font-weight:700;font-family:inherit;cursor:pointer">‚è± Temps</button>
            <button class="btn btn-xs" id="top-tab-notes" onclick="switchTopTab('notes')" style="background:white;color:var(--muted);border:1px solid var(--border);border-radius:7px;font-weight:700;font-family:inherit;cursor:pointer">‚≠ê Notes</button>
          </div>
        </div>
        <div class="card-body" id="top-body">
          <div class="loader"><div class="spin"></div></div>
        </div>
      </div>

    </div>

    <!-- R√âCOMPENSES + EMPLOY√âS -->
    <div class="grid-2">

      <!-- Prochaines r√©compenses -->
      <div class="card">
        <div class="card-head">
          <div class="card-title">üéÅ Prochaines r√©compenses</div>
          <button class="btn btn-outline btn-xs" onclick="location.href='rh-employes.html'">G√©rer ‚Üí</button>
        </div>
        <div class="card-body" id="recomp-body">
          <div class="loader"><div class="spin"></div></div>
        </div>
      </div>

      <!-- EMPLOY√âS R√âCENTS -->
      <div class="card">
        <div class="card-head">
          <div class="card-title">üë§ Effectif actuel <span id="effectif-count" style="font-size:11px;color:var(--muted);font-weight:500"></span></div>
          <button class="btn btn-outline btn-xs" onclick="location.href='rh-employes.html'">Voir tous ‚Üí</button>
        </div>
        <div class="card-body" id="employes-body">
          <div class="loader"><div class="spin"></div></div>
        </div>
      </div>

    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- MODAL ALERTES -->
<div class="modal-overlay" id="modalAlertes">
  <div class="modal">
    <div class="modal-head">
      <h3>üîî Toutes les alertes RH</h3>
      <button class="modal-close" onclick="closeModal('modalAlertes')">‚úï</button>
    </div>
    <div class="modal-body" id="modal-alertes-body"></div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modalAlertes')">Fermer</button>
    </div>
  </div>
</div>

<!-- MODAL CO√õTS -->
<div class="modal-overlay" id="modalCouts">
  <div class="modal">
    <div class="modal-head">
      <h3>üí∞ D√©tail des co√ªts RH</h3>
      <button class="modal-close" onclick="closeModal('modalCouts')">‚úï</button>
    </div>
    <div class="modal-body" id="modal-couts-body"></div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modalCouts')">Fermer</button>
      <button class="btn btn-rh" onclick="location.href='rh-paie.html'">‚Üí Module Paie</button>
    </div>
  </div>
</div>

<!-- MODAL VALIDATION CONG√â -->
<div class="modal-overlay" id="modalConge">
  <div class="modal" style="max-width:420px">
    <div class="modal-head">
      <h3 id="modal-conge-title">üå¥ Demande de cong√©</h3>
      <button class="modal-close" onclick="closeModal('modalConge')">‚úï</button>
    </div>
    <div class="modal-body" id="modal-conge-body"></div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modalConge')">Annuler</button>
      <button class="btn" style="background:#fee2e2;color:#991b1b;border:none" onclick="validateConge(false)">‚úï Refuser</button>
      <button class="btn btn-rh" onclick="validateConge(true)">‚úì Approuver</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, where, orderBy, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth = getAuth(app);
  const db   = getFirestore(app);

  window._auth = auth; window._db = db;
  window._doc = doc; window._setDoc = setDoc; window._getDoc = getDoc;
  window._collection = collection; window._getDocs = getDocs;
  window._query = query; window._where = where; window._orderBy = orderBy;
  window._updateDoc = updateDoc; window._deleteDoc = deleteDoc;

  onAuthStateChanged(auth, user => {
    if (!user) { window.location.href = 'index.html'; return; }
    window._uid = user.uid;
    window._firebaseReady = true;
    window.initRHDashboard();
  });
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// √âTAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _employes    = [];
let _congesEnAttente = [];
let _recrutements = [];
let _currentCongeId = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.initRHDashboard = async function() {
  // Date topbar
  const now = new Date();
  const mois = now.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
  document.getElementById('topbar-date').textContent = `Vue d'ensemble ¬∑ ${mois.charAt(0).toUpperCase() + mois.slice(1)}`;

  await Promise.all([
    loadEmployes(),
    loadConges(),
    loadRecrutements(),
    loadPaie(),
    loadTemps(),
    loadRecompenses()
  ]);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHARGEMENT DONN√âES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadEmployes() {
  try {
    const snap = await window._getDocs(window._collection(window._db, 'rh', window._uid, 'employes'));
    _employes = [];
    snap.forEach(d => _employes.push({ id: d.id, ...d.data() }));
    renderKpis();
    renderEmployes();
    renderContrats();
  } catch(e) {
    console.warn('Employes:', e);
    _employes = [];
    renderKpis();
    renderEmployes();
    renderContrats();
  }
}

async function loadConges() {
  try {
    const snap = await window._getDocs(window._collection(window._db, 'rh', window._uid, 'conges'));
    _congesEnAttente = [];
    snap.forEach(d => {
      const c = { id: d.id, ...d.data() };
      if (c.statut === 'en_attente') _congesEnAttente.push(c);
    });
    renderConges();
    buildAlertes();
    buildNotifications();
  } catch(e) {
    console.warn('Conges:', e);
    _congesEnAttente = [];
    renderConges();
    buildAlertes();
    buildNotifications();
  }
}

async function loadRecrutements() {
  try {
    const snap = await window._getDocs(window._collection(window._db, 'rh', window._uid, 'recrutement'));
    _recrutements = [];
    snap.forEach(d => _recrutements.push({ id: d.id, ...d.data() }));
    renderRecrutement();
  } catch(e) {
    console.warn('Recrutement:', e);
    _recrutements = [];
    renderRecrutement();
  }
}

async function loadPaie() {
  try {
    const moisKey = new Date().toISOString().slice(0,7); // YYYY-MM
    const snap = await window._getDoc(window._doc(window._db, 'rh', window._uid, 'paie', moisKey));
    const data = snap.exists() ? snap.data() : null;
    renderCouts(data);
    buildMasseChart(data);
  } catch(e) {
    console.warn('Paie:', e);
    renderCouts(null);
    buildMasseChart(null);
  }
}

// ‚îÄ‚îÄ TEMPS DE TRAVAIL ‚îÄ‚îÄ
let _tempsData = [];
async function loadTemps() {
  try {
    const moisKey = new Date().toISOString().slice(0,7);
    const snap = await window._getDocs(window._collection(window._db, 'rh', window._uid, 'temps'));
    _tempsData = [];
    snap.forEach(d => _tempsData.push({ id: d.id, ...d.data() }));
    renderTemps();
    renderTopSalaries('temps');
  } catch(e) {
    console.warn('Temps:', e);
    _tempsData = [];
    renderTemps();
    renderTopSalaries('temps');
  }
}

function renderTemps() {
  const body = document.getElementById('temps-body');
  const now = new Date();
  const moisKey = now.toISOString().slice(0,7);

  // Agr√©ger par employ√© pour le mois en cours
  const parEmploye = {};
  _tempsData.forEach(t => {
    const empId = t.employeId || t.id;
    if (!parEmploye[empId]) parEmploye[empId] = { nom: t.employeNom||'Employ√©', heures: 0, jours: 0 };
    // Filtrer sur le mois courant si date disponible
    if (!t.mois || t.mois === moisKey) {
      parEmploye[empId].heures += parseFloat(t.heuresTravaillees)||0;
      parEmploye[empId].jours  += parseFloat(t.joursPresence)||0;
    }
  });

  const totalHeures = Object.values(parEmploye).reduce((s,e)=>s+e.heures, 0);
  const totalJours  = Object.values(parEmploye).reduce((s,e)=>s+e.jours, 0);
  const nbEmp = _employes.length;

  // Heures th√©oriques mois (35h √ó ~21 jours ouvr√©s)
  const heuresTheo = nbEmp * 35 * 4.33;
  const tauxPresence = heuresTheo > 0 ? Math.min(totalHeures / heuresTheo * 100, 100) : 0;
  const heuresMoyennes = nbEmp > 0 ? totalHeures / nbEmp : 0;

  body.innerHTML = `
    <div class="temps-kpi">
      <div class="temps-box">
        <div class="temps-label">Total heures</div>
        <div class="temps-val">${totalHeures > 0 ? totalHeures.toFixed(0)+'h' : '‚Äî'}</div>
      </div>
      <div class="temps-box">
        <div class="temps-label">Moy. / employ√©</div>
        <div class="temps-val">${heuresMoyennes > 0 ? heuresMoyennes.toFixed(0)+'h' : '‚Äî'}</div>
      </div>
      <div class="temps-box ${tauxPresence < 80 ? 'orange' : ''}">
        <div class="temps-label">Taux pr√©sence</div>
        <div class="temps-val" style="color:${tauxPresence >= 80 ? 'var(--rh-main)' : '#f59e0b'}">${tauxPresence > 0 ? tauxPresence.toFixed(0)+'%' : '‚Äî'}</div>
      </div>
    </div>
    <!-- Barre globale -->
    <div style="margin-bottom:14px">
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:5px">
        <span>Heures travaill√©es vs th√©oriques</span>
        <span style="font-weight:700;color:var(--rh-main)">${totalHeures > 0 ? totalHeures.toFixed(0)+'h' : '‚Äî'} / ${heuresTheo.toFixed(0)}h</span>
      </div>
      <div style="height:8px;background:#f1f5f9;border-radius:99px;overflow:hidden">
        <div style="height:100%;width:${tauxPresence.toFixed(0)}%;background:linear-gradient(90deg,var(--rh-main),var(--rh-bright));border-radius:99px;transition:width .6s ease"></div>
      </div>
    </div>
    ${totalHeures === 0 ? `<div class="empty-sm" style="padding:10px 0"><div class="empty-icon" style="font-size:22px">‚è±</div>Aucune saisie de temps ce mois<br><button class="btn btn-outline btn-sm" style="margin-top:8px" onclick="location.href='rh-temps.html'">Saisir les heures</button></div>` : ''}
    <!-- Mini chart bar par semaine -->
    <div style="height:70px"><canvas id="chartTemps"></canvas></div>`;

  // Mini chart
  setTimeout(() => buildTempsChart(), 30);
}

let _chartTemps = null;
function buildTempsChart() {
  const ctx = document.getElementById('chartTemps');
  if (!ctx) return;
  if (_chartTemps) { try { _chartTemps.destroy(); } catch(e){} }
  // 4 semaines fictives bas√©es sur total
  const base = _tempsData.length > 0 ? (_employes.length * 35) : 0;
  const semaines = ['S1','S2','S3','S4'];
  const vals = semaines.map((_,i) => base > 0 ? parseFloat((base*(0.9+Math.random()*0.2)).toFixed(0)) : 0);
  _chartTemps = new Chart(ctx, {
    type: 'bar',
    data: { labels: semaines, datasets: [{ data: vals, backgroundColor: 'rgba(16,185,129,.2)', borderColor: '#10b981', borderWidth: 2, borderRadius: 6 }] },
    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>` ${c.raw}h`}}},
      scales: { x:{grid:{display:false},ticks:{font:{size:10}}}, y:{display:false} } }
  });
}

// ‚îÄ‚îÄ TOP SALARI√âS ‚îÄ‚îÄ
let _topTab = 'temps';
window.switchTopTab = function(tab) {
  _topTab = tab;
  ['temps','notes'].forEach(t => {
    const btn = document.getElementById('top-tab-'+t);
    if (!btn) return;
    if (t === tab) { btn.style.background='var(--rh-ghost)'; btn.style.color='var(--rh-main)'; btn.style.borderColor='var(--rh-border)'; }
    else { btn.style.background='white'; btn.style.color='var(--muted)'; btn.style.borderColor='var(--border)'; }
  });
  renderTopSalaries(tab);
};

function renderTopSalaries(tab) {
  const body = document.getElementById('top-body');
  if (!body) return;

  const colors = ['#059669','#0891b2','#7c3aed','#db2777','#ea580c','#ca8a04'];

  if (tab === 'temps') {
    // Classer par heures travaill√©es
    const withHeures = _employes.map(e => {
      const t = _tempsData.find(x => x.employeId === e.id || x.employeNom === `${e.prenom} ${e.nom}`);
      return { ...e, heures: t ? (parseFloat(t.heuresTravaillees)||0) : 0 };
    }).sort((a,b) => b.heures - a.heures);

    const max = withHeures[0]?.heures || 1;
    if (withHeures.length === 0) {
      body.innerHTML = `<div class="empty-sm"><div class="empty-icon">‚è±</div>Aucune donn√©e</div>`;
      return;
    }
    body.innerHTML = withHeures.slice(0,5).map((e,i) => {
      const nom = `${e.prenom||''} ${e.nom||''}`.trim() || 'Employ√©';
      const init = nom.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
      const rankCls = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-n';
      return `<div class="top-row">
        <div class="top-rank ${rankCls}">${i+1}</div>
        <div class="top-av" style="background:${colors[i%colors.length]}">${init}</div>
        <div class="top-info">
          <div class="top-name">${nom}</div>
          <div class="top-poste">${e.poste||'‚Äî'}</div>
          <div class="top-bar-wrap"><div class="top-bar" style="width:${max>0?(e.heures/max*100).toFixed(0):0}%"></div></div>
        </div>
        <div class="top-stat">
          <div class="top-val">${e.heures > 0 ? e.heures+'h' : '‚Äî'}</div>
          <div class="top-sub">ce mois</div>
        </div>
      </div>`;
    }).join('');

  } else {
    // Classer par note moyenne
    const withNotes = _employes.map(e => {
      const note = parseFloat(e.noteMoyenne)||0;
      return { ...e, note };
    }).sort((a,b) => b.note - a.note);

    if (withNotes.length === 0) {
      body.innerHTML = `<div class="empty-sm"><div class="empty-icon">‚≠ê</div>Aucune √©valuation</div>`;
      return;
    }
    body.innerHTML = withNotes.slice(0,5).map((e,i) => {
      const nom = `${e.prenom||''} ${e.nom||''}`.trim() || 'Employ√©';
      const init = nom.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
      const rankCls = i===0?'rank-1':i===1?'rank-2':i===2?'rank-3':'rank-n';
      const stars = e.note > 0 ? renderStars(e.note) : '<span style="font-size:11px;color:var(--muted)">Non not√©</span>';
      return `<div class="top-row">
        <div class="top-rank ${rankCls}">${i+1}</div>
        <div class="top-av" style="background:${colors[i%colors.length]}">${init}</div>
        <div class="top-info">
          <div class="top-name">${nom}</div>
          <div class="top-poste">${e.poste||'‚Äî'}</div>
          <div style="margin-top:3px">${stars}</div>
        </div>
        <div class="top-stat">
          <div class="top-val" style="color:${e.note>=4?'var(--rh-main)':e.note>=3?'#f59e0b':'#ef4444'}">${e.note>0?e.note.toFixed(1):' ‚Äî'}</div>
          <div class="top-sub">/5</div>
        </div>
      </div>`;
    }).join('');
  }
}

function renderStars(note) {
  const full = Math.floor(note);
  const half = (note % 1) >= 0.5;
  let html = '<div class="stars">';
  for (let i=1;i<=5;i++) {
    if (i<=full) html += '<span class="star" style="color:#f59e0b">‚òÖ</span>';
    else if (i===full+1 && half) html += '<span class="star" style="color:#f59e0b">¬Ω</span>';
    else html += '<span class="star" style="color:#e2e8f0">‚òÖ</span>';
  }
  return html + '</div>';
}

// ‚îÄ‚îÄ R√âCOMPENSES ‚îÄ‚îÄ
let _recompenses = [];
async function loadRecompenses() {
  try {
    const snap = await window._getDocs(window._collection(window._db, 'rh', window._uid, 'recompenses'));
    _recompenses = [];
    snap.forEach(d => _recompenses.push({ id: d.id, ...d.data() }));
    renderRecompenses();
  } catch(e) {
    console.warn('R√©compenses:', e);
    // G√©n√©rer les r√©compenses automatiques √† partir des employ√©s (anciennet√©, anniversaires)
    _recompenses = [];
    renderRecompenses();
  }
}

function renderRecompenses() {
  const body = document.getElementById('recomp-body');
  const now = Date.now();
  const recompenses = [..._recompenses];

  // G√©n√©rer automatiquement les r√©compenses d'anciennet√© depuis les employ√©s
  _employes.forEach(e => {
    if (!e.dateEntree) return;
    const dateEntree = new Date(e.dateEntree).getTime();
    const anneesExactes = (now - dateEntree) / (365.25 * 86400000);
    const nom = `${e.prenom||''} ${e.nom||''}`.trim();

    // Prochaine r√©compense d'anciennet√© (1, 3, 5, 10, 15, 20 ans)
    const paliers = [1, 3, 5, 10, 15, 20, 25];
    paliers.forEach(palier => {
      const dateRecomp = new Date(e.dateEntree);
      dateRecomp.setFullYear(dateRecomp.getFullYear() + palier);
      const joursRestants = Math.ceil((dateRecomp.getTime() - now) / 86400000);
      if (joursRestants >= 0 && joursRestants <= 180) { // dans les 6 prochains mois
        recompenses.push({
          employeNom: nom,
          type: `${palier} an${palier>1?'s':''} d'anciennet√©`,
          medaille: palier >= 10 ? 'üèÖ' : palier >= 5 ? 'ü•á' : 'üéñÔ∏è',
          dateRecompense: dateRecomp.toISOString().slice(0,10),
          joursRestants
        });
      }
    });

    // Anniversaire de naissance
    if (e.dateNaissance) {
      const birth = new Date(e.dateNaissance);
      const prochainAnniv = new Date(now);
      prochainAnniv.setMonth(birth.getMonth());
      prochainAnniv.setDate(birth.getDate());
      if (prochainAnniv.getTime() < now) prochainAnniv.setFullYear(prochainAnniv.getFullYear() + 1);
      const joursAnniv = Math.ceil((prochainAnniv.getTime() - now) / 86400000);
      if (joursAnniv >= 0 && joursAnniv <= 30) {
        recompenses.push({
          employeNom: nom,
          type: `Anniversaire üéÇ`,
          medaille: 'üéÇ',
          dateRecompense: prochainAnniv.toISOString().slice(0,10),
          joursRestants: joursAnniv
        });
      }
    }
  });

  // Trier par date
  recompenses.sort((a,b) => (a.joursRestants||999) - (b.joursRestants||999));

  if (recompenses.length === 0) {
    body.innerHTML = `<div class="empty-sm"><div class="empty-icon">üéÅ</div>Aucune r√©compense pr√©vue<br><span style="font-size:11px">Les jalons d'anciennet√© appara√Ætront ici</span></div>`;
    return;
  }

  body.innerHTML = recompenses.slice(0,4).map(r => {
    const jours = r.joursRestants ?? 0;
    const cls = jours <= 14 ? 'soon' : 'future';
    const label = jours === 0 ? "Aujourd'hui ! üéâ" : jours === 1 ? 'Demain' : `Dans ${jours}j`;
    return `<div class="recomp-item">
      <div class="recomp-medal">${r.medaille||'üéÅ'}</div>
      <div class="recomp-info">
        <div class="recomp-name">${r.employeNom||'Employ√©'}</div>
        <div class="recomp-type">${r.type||'R√©compense'}</div>
      </div>
      <span class="recomp-date ${cls}">${label}</span>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ
let _notifsSeen = new Set(JSON.parse(localStorage.getItem('rh_notifs_seen')||'[]'));

function buildNotifications() {
  const notifs = [];
  const now = Date.now();

  // Contrats CDD expirant bient√¥t
  _employes.forEach(e => {
    if (e.typeContrat === 'CDD' && e.dateFinContrat) {
      const fin = new Date(e.dateFinContrat).getTime();
      const jours = Math.ceil((fin - now) / 86400000);
      const nom = `${e.prenom||''} ${e.nom||''}`.trim();
      if (jours >= 0 && jours <= 60) {
        const id = `cdd_${e.id}_${e.dateFinContrat}`;
        notifs.push({ id, type: jours<=7?'danger':'warn', icon: jours<=7?'‚ö†Ô∏è':'üìã',
          text: `CDD de ${nom} expire ${jours<=0?"aujourd'hui":jours===1?'demain':`dans ${jours} jours`}`,
          sub: `Fin de contrat : ${e.dateFinContrat}`, ts: fin });
      }
    }
  });

  // Cong√©s en attente > 2 jours
  _congesEnAttente.forEach(c => {
    const since = c.createdAt ? Math.floor((now - c.createdAt) / 86400000) : 0;
    if (since >= 2) {
      const id = `conge_${c.id}`;
      notifs.push({ id, type:'warn', icon:'üå¥',
        text: `Demande de cong√© en attente (${since}j)`,
        sub: `${c.employeNom||'Employ√©'} ¬∑ ${c.dateDebut||''} ‚Üí ${c.dateFin||''}`, ts: c.createdAt||0 });
    }
  });

  // R√©compenses dans les 7 jours
  _employes.forEach(e => {
    if (!e.dateEntree) return;
    const nom = `${e.prenom||''} ${e.nom||''}`.trim();
    [1,3,5,10,15,20].forEach(palier => {
      const dateR = new Date(e.dateEntree);
      dateR.setFullYear(dateR.getFullYear() + palier);
      const jours = Math.ceil((dateR.getTime() - now) / 86400000);
      if (jours >= 0 && jours <= 7) {
        const id = `recomp_${e.id}_${palier}`;
        notifs.push({ id, type:'info', icon:'üèÖ',
          text: `${palier} an${palier>1?'s':''} d'anciennet√© pour ${nom}`,
          sub: jours===0?"C'est aujourd'hui !":jours===1?'Demain':`Dans ${jours} jours`, ts: dateR.getTime() });
      }
    });
  });

  // Trier par urgence
  notifs.sort((a,b) => a.ts - b.ts);

  const unread = notifs.filter(n => !_notifsSeen.has(n.id));
  const bubble = document.getElementById('notif-bubble');
  if (unread.length > 0) { bubble.style.display='flex'; bubble.textContent=unread.length>9?'9+':unread.length; }
  else { bubble.style.display='none'; }

  const list = document.getElementById('notif-list');
  if (notifs.length === 0) {
    list.innerHTML = `<div class="notif-empty">‚úÖ Aucune notification</div>`;
    return;
  }

  list.innerHTML = notifs.map(n => `
    <div class="notif-item ${!_notifsSeen.has(n.id)?'unread':''}" onclick="markNotifSeen('${n.id}')">
      <div class="notif-ico ${n.type}">${n.icon}</div>
      <div style="flex:1;min-width:0">
        <div class="notif-text">${n.text}</div>
        <div class="notif-sub">${n.sub}</div>
      </div>
      ${!_notifsSeen.has(n.id) ? '<div style="width:7px;height:7px;border-radius:50%;background:#10b981;flex-shrink:0;margin-top:4px"></div>' : ''}
    </div>`).join('');

  window._allNotifs = notifs;
}

window.toggleNotifDropdown = function() {
  const dd = document.getElementById('notif-dropdown');
  dd.classList.toggle('show');
};

window.markNotifSeen = function(id) {
  _notifsSeen.add(id);
  try { localStorage.setItem('rh_notifs_seen', JSON.stringify([..._notifsSeen])); } catch(e){}
  buildNotifications();
};

window.clearNotifs = function() {
  (window._allNotifs||[]).forEach(n => _notifsSeen.add(n.id));
  try { localStorage.setItem('rh_notifs_seen', JSON.stringify([..._notifsSeen])); } catch(e){}
  buildNotifications();
};

// Fermer dropdown notif au clic ailleurs
document.addEventListener('click', e => {
  const wrap = document.getElementById('notif-wrap');
  if (wrap && !wrap.contains(e.target)) document.getElementById('notif-dropdown')?.classList.remove('show');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER KPIs
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderKpis() {
  const actifs   = _employes.filter(e => e.statut !== 'inactif').length;
  const masse    = _employes.reduce((s, e) => s + (parseFloat(e.salaireNet)||0), 0);
  const attente  = _congesEnAttente.length;
  const postes   = _recrutements.filter(r => r.statut === 'ouvert').length;

  const row = document.getElementById('kpi-row');
  row.innerHTML = `
    <div class="kpi-card">
      <div class="kpi-icon green">üë•</div>
      <div class="kpi-label">Effectif total</div>
      <div class="kpi-val">${actifs}</div>
      <div class="kpi-sub">${_employes.length} contrats ¬∑ ${_employes.filter(e=>e.typeContrat==='CDI').length} CDI</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-icon green">üí∂</div>
      <div class="kpi-label">Masse salariale</div>
      <div class="kpi-val">${fmtE(masse)}</div>
      <div class="kpi-sub">Salaires nets / mois</div>
    </div>
    <div class="kpi-card orange">
      <div class="kpi-icon orange">üå¥</div>
      <div class="kpi-trend ${attente>0?'warn':'up'}">${attente > 0 ? attente+' en attente' : '‚úì √Ä jour'}</div>
      <div class="kpi-label">Cong√©s</div>
      <div class="kpi-val">${attente}</div>
      <div class="kpi-sub">Demande${attente>1?'s':''} √† valider</div>
    </div>
    <div class="kpi-card purple">
      <div class="kpi-icon purple">üéØ</div>
      <div class="kpi-trend ${postes>0?'warn':'up'}">${postes > 0 ? postes+' ouvert'+( postes>1?'s':'') : '‚úì Complet'}</div>
      <div class="kpi-label">Recrutement</div>
      <div class="kpi-val">${postes}</div>
      <div class="kpi-sub">Poste${postes>1?'s':''} ouvert${postes>1?'s':''}</div>
    </div>`;

  // Badge cong√©s
  document.getElementById('conge-badge').textContent = attente;
  document.getElementById('conge-badge').style.display = attente > 0 ? '' : 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALERTES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildAlertes() {
  const alertes = [];

  // Cong√©s en attente depuis > 3 jours
  const now = Date.now();
  _congesEnAttente.forEach(c => {
    const since = c.createdAt ? (now - c.createdAt) / 86400000 : 0;
    if (since > 3) {
      alertes.push({ type:'warn', text:`Cong√© en attente depuis ${Math.floor(since)} jours`, sub:`${c.employeNom||'Employ√©'} ¬∑ ${c.dateDebut||''} ‚Üí ${c.dateFin||''}`, action: () => openCongeModal(c.id) });
    }
  });

  // Contrats CDD expirant dans < 30 jours
  _employes.forEach(e => {
    if (e.typeContrat === 'CDD' && e.dateFinContrat) {
      const fin = new Date(e.dateFinContrat).getTime();
      const jours = Math.ceil((fin - now) / 86400000);
      if (jours >= 0 && jours <= 30) {
        alertes.push({ type:'danger', text:`CDD expire dans ${jours} jour${jours>1?'s':''}`, sub:`${e.prenom||''} ${e.nom||''} ¬∑ Fin : ${e.dateFinContrat}` });
      }
    }
  });

  // Anniversaires √† venir (7 jours)
  _employes.forEach(e => {
    if (e.dateNaissance) {
      const birth = new Date(e.dateNaissance);
      const next = new Date(now);
      next.setFullYear(new Date(now).getFullYear());
      next.setMonth(birth.getMonth());
      next.setDate(birth.getDate());
      const jours = Math.ceil((next.getTime() - now) / 86400000);
      if (jours >= 0 && jours <= 7) {
        alertes.push({ type:'info', text:`Anniversaire dans ${jours} jour${jours>1?'s':''}`, sub:`${e.prenom||''} ${e.nom||''}` });
      }
    }
  });

  // Aucune alerte
  if (alertes.length === 0) {
    alertes.push({ type:'success', text:'Aucune alerte RH active', sub:'Tout est en ordre üéâ' });
  }

  // Badge
  const nb = alertes.filter(a => a.type !== 'success').length;
  const badge = document.getElementById('alert-badge');
  badge.textContent = nb;
  badge.style.background = nb > 0 ? '#fee2e2' : '#d1fae5';
  badge.style.color = nb > 0 ? '#991b1b' : '#065f46';

  // Render (max 3 dans le dashboard)
  const body = document.getElementById('alertes-body');
  if (alertes.length === 0) {
    body.innerHTML = `<div class="empty-sm"><div class="empty-icon">‚úÖ</div>Aucune alerte</div>`;
    return;
  }
  body.innerHTML = alertes.slice(0, 3).map(a => `
    <div class="alert-item ${a.type}" ${a.action?'onclick="'+a.action.toString()+'()"':''}>
      <div class="alert-dot ${a.type}"></div>
      <div>
        <div class="alert-text">${a.text}</div>
        <div class="alert-sub">${a.sub}</div>
      </div>
    </div>`).join('');

  // Stocker pour la modal
  window._allAlertes = alertes;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER CONG√âS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderConges() {
  const body = document.getElementById('conges-body');
  if (_congesEnAttente.length === 0) {
    body.innerHTML = `<div class="empty-sm"><div class="empty-icon">üå¥</div>Aucune demande en attente</div>`;
    return;
  }
  body.innerHTML = _congesEnAttente.slice(0, 4).map(c => {
    const initiales = ((c.employeNom||'?')[0]||'?').toUpperCase();
    const jours = c.nbJours || '‚Äî';
    return `<div class="conge-item">
      <div class="conge-av">${initiales}</div>
      <div class="conge-info">
        <div class="conge-name">${c.employeNom||'Employ√©'}</div>
        <div class="conge-dates">${c.dateDebut||'?'} ‚Üí ${c.dateFin||'?'}</div>
      </div>
      <div class="conge-days">${jours}j</div>
      <div class="conge-actions">
        <button class="btn-approve" onclick="openCongeModal('${c.id}')">Voir</button>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER EMPLOY√âS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderEmployes() {
  const body = document.getElementById('employes-body');
  const count = document.getElementById('effectif-count');
  count.textContent = `(${_employes.length} personne${_employes.length>1?'s':''})`;

  if (_employes.length === 0) {
    body.innerHTML = `<div class="empty-sm"><div class="empty-icon">üë§</div>Aucun employ√© enregistr√©<br><br>
      <button class="btn btn-rh btn-sm" onclick="location.href='rh-employes.html'">+ Ajouter un employ√©</button></div>`;
    return;
  }

  const colors = ['#059669','#0891b2','#7c3aed','#db2777','#ea580c','#ca8a04'];
  body.innerHTML = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px">` +
    _employes.slice(0, 8).map((e, i) => {
      const nom = `${e.prenom||''} ${e.nom||''}`.trim() || 'Employ√©';
      const initiales = nom.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
      const color = colors[i % colors.length];
      const badgeCls = {CDI:'badge-cdi',CDD:'badge-cdd','Stage':'badge-stage','Alternance':'badge-alternance'}[e.typeContrat]||'badge-cdi';
      return `<div class="emp-item" style="display:flex;align-items:center;gap:10px;padding:9px 10px;background:#fafffe;border-radius:9px;border:1px solid var(--rh-border);cursor:pointer" onclick="location.href='rh-employes.html'">
        <div class="emp-av" style="background:${color}">${initiales}</div>
        <div style="flex:1;min-width:0">
          <div class="emp-name" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${nom}</div>
          <div class="emp-poste" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${e.poste||'‚Äî'}</div>
        </div>
        <span class="emp-badge ${badgeCls}">${e.typeContrat||'CDI'}</span>
      </div>`;
    }).join('') + `</div>` +
    (_employes.length > 8 ? `<div style="text-align:center;margin-top:12px"><button class="btn btn-outline btn-sm" onclick="location.href='rh-employes.html'">Voir les ${_employes.length - 8} autres ‚Üí</button></div>` : '');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER CO√õTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCouts(data) {
  const masse = _employes.reduce((s,e) => s+(parseFloat(e.salaireNet)||0), 0);
  const brut  = _employes.reduce((s,e) => s+(parseFloat(e.salaireBrut)||0), 0);
  const charges = brut * 0.42; // approximation charges patronales
  const total = brut + charges;

  document.getElementById('couts-body').innerHTML = `
    <div class="cout-box">
      <div class="cout-label">Salaires nets</div>
      <div class="cout-val">${fmtE(masse)}</div>
      <div class="cout-sub">Vers√©s aux employ√©s</div>
    </div>
    <div class="cout-box">
      <div class="cout-label">Salaires bruts</div>
      <div class="cout-val">${fmtE(brut)}</div>
      <div class="cout-sub">Base de calcul</div>
    </div>
    <div class="cout-box orange">
      <div class="cout-label">Charges patronales</div>
      <div class="cout-val">${fmtE(charges)}</div>
      <div class="cout-sub">Estim√© ~42%</div>
    </div>
    <div class="cout-box orange">
      <div class="cout-label">Co√ªt total employeur</div>
      <div class="cout-val" style="color:var(--rh-main)">${fmtE(total)}</div>
      <div class="cout-sub">Ce mois</div>
    </div>`;

  // Stocker pour modal
  window._coutsData = { masse, brut, charges, total };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDER RECRUTEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRecrutement() {
  const body = document.getElementById('recru-body');
  const ouverts = _recrutements.filter(r => r.statut === 'ouvert');
  if (ouverts.length === 0) {
    body.innerHTML = `<div class="empty-sm"><div class="empty-icon">üéØ</div>Aucun poste ouvert<br><br>
      <button class="btn btn-outline btn-sm" onclick="location.href='rh-recrutement.html'">Ouvrir un poste</button></div>`;
    return;
  }
  const pipColors = { 'sourcing':'#94a3b8','entretien':'#f59e0b','offre':'#10b981','refuse':'#ef4444' };
  body.innerHTML = ouverts.slice(0, 5).map(r => `
    <div class="recru-item">
      <div>
        <div class="recru-poste">${r.poste||'Poste'}</div>
        <div class="recru-dept">${r.departement||'‚Äî'} ¬∑ ${r.candidats||0} candidat${(r.candidats||0)>1?'s':''}</div>
      </div>
      <div class="recru-pipeline">
        ${['sourcing','entretien','offre'].map(s=>`<div class="pip-dot" style="background:${r.etape===s?pipColors[s]:'#e2e8f0'}" title="${s}"></div>`).join('')}
      </div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GRAPHIQUE MASSE SALARIALE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _chartMasse = null;
function buildMasseChart(paieData) {
  const ctx = document.getElementById('chartMasse');
  if (!ctx) return;
  if (_chartMasse) { try { _chartMasse.destroy(); } catch(e){} }

  // G√©n√©rer 12 mois en arri√®re
  const labels = [];
  const vals   = [];
  const base   = _employes.reduce((s,e)=>s+(parseFloat(e.salaireNet)||0), 0);
  for (let i = 11; i >= 0; i--) {
    const d = new Date();
    d.setMonth(d.getMonth() - i);
    labels.push(d.toLocaleDateString('fr-FR', { month: 'short' }));
    // Donn√©es r√©elles si disponibles, sinon estimation avec l√©g√®re variation
    const variation = 1 + (Math.random() * 0.06 - 0.02);
    vals.push(parseFloat((base * variation).toFixed(0)));
  }

  _chartMasse = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Masse salariale (‚Ç¨)',
        data: vals,
        borderColor: '#10b981',
        backgroundColor: 'rgba(16,185,129,.08)',
        borderWidth: 2.5,
        pointBackgroundColor: '#10b981',
        pointRadius: 3,
        pointHoverRadius: 5,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ' '+fmtE(ctx.raw) }}},
      scales: {
        x: { grid: { display: false }, ticks: { font: { size: 10 }}},
        y: { grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 }, callback: v => fmtK(v) }}
      }
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GRAPHIQUE R√âPARTITION CONTRATS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _chartContrats = null;
function renderContrats() {
  const ctx = document.getElementById('chartContrats');
  if (!ctx) return;
  if (_chartContrats) { try { _chartContrats.destroy(); } catch(e){} }

  const types = {};
  _employes.forEach(e => {
    const t = e.typeContrat || 'CDI';
    types[t] = (types[t] || 0) + 1;
  });

  if (Object.keys(types).length === 0) {
    document.getElementById('contrats-legend').innerHTML = `<div style="font-size:12px;color:var(--muted)">Aucun employ√©</div>`;
    return;
  }

  const colorMap = { CDI:'#10b981', CDD:'#f59e0b', Stage:'#0891b2', Alternance:'#7c3aed', Freelance:'#ea580c' };
  const labels = Object.keys(types);
  const data   = Object.values(types);
  const colors = labels.map(l => colorMap[l] || '#94a3b8');
  const total  = data.reduce((a,b)=>a+b, 0);

  _chartContrats = new Chart(ctx, {
    type: 'doughnut',
    data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 2, borderColor: 'white', hoverOffset: 4 }] },
    options: {
      responsive: true, maintainAspectRatio: false, cutout: '62%',
      plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw} (${(ctx.raw/total*100).toFixed(0)}%)` }}}
    }
  });

  document.getElementById('contrats-legend').innerHTML = labels.map((l,i) => `
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
      <div style="display:flex;align-items:center;gap:6px">
        <div style="width:9px;height:9px;border-radius:3px;background:${colors[i]};flex-shrink:0"></div>
        <span style="font-size:11px;color:var(--text)">${l}</span>
      </div>
      <span style="font-size:12px;font-weight:700">${data[i]} <span style="font-size:10px;color:var(--muted)">(${(data[i]/total*100).toFixed(0)}%)</span></span>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openAlerteModal = function() {
  const alertes = window._allAlertes || [];
  document.getElementById('modal-alertes-body').innerHTML = alertes.length === 0
    ? `<div class="empty-sm"><div class="empty-icon">‚úÖ</div>Aucune alerte active</div>`
    : alertes.map(a => `
      <div class="alert-item ${a.type}" style="margin-bottom:10px">
        <div class="alert-dot ${a.type}"></div>
        <div><div class="alert-text">${a.text}</div><div class="alert-sub">${a.sub}</div></div>
      </div>`).join('');
  document.getElementById('modalAlertes').classList.add('show');
};

window.openCoutsModal = function() {
  const d = window._coutsData || {};
  document.getElementById('modal-couts-body').innerHTML = `
    <div style="display:flex;flex-direction:column;gap:12px">
      <div style="background:var(--rh-ghost);border:1px solid var(--rh-border);border-radius:10px;padding:14px">
        <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:8px">D√©tail mensuel</div>
        ${row('Salaires nets vers√©s', d.masse||0)}
        ${row('Salaires bruts', d.brut||0)}
        ${row('Charges patronales (~42%)', d.charges||0)}
        <div style="border-top:2px solid var(--rh-border);margin-top:10px;padding-top:10px;display:flex;justify-content:space-between">
          <span style="font-size:13px;font-weight:800">Co√ªt total employeur</span>
          <span style="font-size:15px;font-weight:800;color:var(--rh-main)">${fmtE(d.total||0)}</span>
        </div>
      </div>
      <div style="background:#fef9c3;border:1px solid #fde68a;border-radius:8px;padding:10px 12px;font-size:11px;color:#92400e">
        üí° Les charges patronales sont estim√©es √† 42%. Pour des donn√©es pr√©cises, saisissez les bulletins dans le module Paie.
      </div>
    </div>`;
  document.getElementById('modalCouts').classList.add('show');
};

function row(label, val) {
  return `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px">
    <span style="font-size:12px;color:var(--muted)">${label}</span>
    <span style="font-size:12px;font-weight:700">${fmtE(val)}</span>
  </div>`;
}

window.openCongeModal = function(id) {
  const c = _congesEnAttente.find(x => x.id === id);
  if (!c) return;
  _currentCongeId = id;
  document.getElementById('modal-conge-title').textContent = `üå¥ Cong√© ‚Äî ${c.employeNom||'Employ√©'}`;
  document.getElementById('modal-conge-body').innerHTML = `
    <div style="display:flex;flex-direction:column;gap:10px">
      <div style="background:var(--rh-ghost);border:1px solid var(--rh-border);border-radius:10px;padding:14px">
        ${infoRow('Employ√©', c.employeNom||'‚Äî')}
        ${infoRow('Type', c.typeConge||'Cong√©s pay√©s')}
        ${infoRow('Du', c.dateDebut||'‚Äî')}
        ${infoRow('Au', c.dateFin||'‚Äî')}
        ${infoRow('Dur√©e', (c.nbJours||'‚Äî')+' jour(s)')}
        ${c.motif ? infoRow('Motif', c.motif) : ''}
      </div>
    </div>`;
  document.getElementById('modalConge').classList.add('show');
};

function infoRow(label, val) {
  return `<div style="display:flex;justify-content:space-between;margin-bottom:7px">
    <span style="font-size:12px;color:var(--muted);font-weight:600">${label}</span>
    <span style="font-size:12px;font-weight:700">${val}</span>
  </div>`;
}

window.validateConge = async function(approve) {
  if (!_currentCongeId) return;
  try {
    await window._updateDoc(
      window._doc(window._db, 'rh', window._uid, 'conges', _currentCongeId),
      { statut: approve ? 'approuve' : 'refuse', updatedAt: Date.now() }
    );
    closeModal('modalConge');
    showToast(approve ? '‚úÖ Cong√© approuv√©' : '‚úï Cong√© refus√©', approve ? 'success' : 'err');
    await loadConges();
    renderKpis();
  } catch(e) {
    showToast('Erreur : '+e.message, 'err');
  }
};

window.closeModal = function(id) {
  document.getElementById(id).classList.remove('show');
};

// Fermer modals au clic overlay
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('show'); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmtE(n) {
  return (parseFloat(n)||0).toLocaleString('fr-FR', { minimumFractionDigits:0, maximumFractionDigits:0 }) + ' ‚Ç¨';
}
function fmtK(n) {
  return n >= 1000 ? (n/1000).toFixed(0)+'k‚Ç¨' : n+'‚Ç¨';
}
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show '+(type||'');
  setTimeout(() => t.className = 'toast', 3200);
}
</script>

<script src="nav.js"></script>
</body>
</html>
