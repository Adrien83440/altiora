<!-- ALTEORE espace-salarie v20260227-enrichi -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>Mon espace â€” ALTEORE</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --g1:#052e16;--g2:#064e23;--g3:#059669;--g4:#10b981;--g5:#34d399;
      --green-light:#d1fae5;--green-ghost:#f0fdf4;
      --text:#111827;--muted:#6b7280;--border:#e5e7eb;--bg:#f0fdf4;
      --red:#ef4444;--red-bg:#fef2f2;
      --orange:#f59e0b;--orange-bg:#fffbeb;
      --blue:#3b82f6;--blue-bg:#eff6ff;
      --purple:#7c3aed;--purple-bg:#faf5ff;
      --teal:#0891b2;--teal-bg:#ecfeff;
      --pink:#db2777;
      --r:14px;
    }
    html,body{overflow-x:hidden;max-width:100vw;}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:13px;}

    /* â”€â”€ LOADING â”€â”€ */
    #loading-wrap{position:fixed;inset:0;background:var(--g1);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;z-index:999;transition:opacity .4s;}
    #loading-wrap.fade{opacity:0;pointer-events:none;}
    .load-logo{font-size:26px;font-weight:800;color:white;letter-spacing:1px;opacity:.9;}
    .load-sub{font-size:11px;color:rgba(255,255,255,.35);font-weight:500;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:26px;height:26px;border:2.5px solid rgba(255,255,255,.12);border-top-color:#34d399;border-radius:50%;animation:spin .7s linear infinite;}

    /* â”€â”€ NOT FOUND â”€â”€ */
    #not-found{display:none;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;text-align:center;padding:32px;background:var(--g1);}
    #not-found.show{display:flex;}
    .nf-icon{font-size:52px;margin-bottom:14px;}
    .nf-title{font-size:20px;font-weight:800;color:white;margin-bottom:8px;}
    .nf-sub{font-size:12px;color:rgba(255,255,255,.45);max-width:290px;line-height:1.7;}

    /* â”€â”€ HERO â”€â”€ */
    .hero{background:linear-gradient(160deg,var(--g1) 0%,var(--g2) 55%,#0a5c30 100%);padding:22px 18px 88px;position:relative;overflow:hidden;}
    .hero::before{content:'';position:absolute;top:-70px;right:-70px;width:260px;height:260px;background:radial-gradient(circle,rgba(52,211,153,.18) 0%,transparent 70%);border-radius:50%;}
    .hero::after{content:'';position:absolute;bottom:-90px;left:25%;width:320px;height:320px;background:radial-gradient(circle,rgba(5,150,105,.12) 0%,transparent 70%);border-radius:50%;}
    .hero-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;position:relative;z-index:1;}
    .hero-brand{display:flex;align-items:center;gap:8px;}
    .hero-brand-icon{width:28px;height:28px;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.2);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;}
    .hero-brand-name{font-size:13px;font-weight:800;color:rgba(255,255,255,.9);letter-spacing:.5px;}
    .hero-tag{font-size:10px;font-weight:700;color:rgba(255,255,255,.4);background:rgba(255,255,255,.07);padding:3px 9px;border-radius:20px;border:1px solid rgba(255,255,255,.1);}
    .hero-body{position:relative;z-index:1;display:flex;align-items:flex-end;gap:14px;}
    .hero-avatar{width:52px;height:52px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;color:white;border:2px solid rgba(255,255,255,.22);flex-shrink:0;}
    .hero-info{flex:1;min-width:0;}
    .hero-name{font-size:19px;font-weight:800;color:white;margin-bottom:2px;line-height:1.2;}
    .hero-sub{font-size:11.5px;color:rgba(255,255,255,.5);line-height:1.5;}
    .hero-chips{display:flex;gap:5px;margin-top:6px;flex-wrap:wrap;}
    .hero-chip{font-size:9.5px;font-weight:700;color:rgba(255,255,255,.65);background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);padding:2px 8px;border-radius:20px;}

    /* â”€â”€ ONGLETS NAVIGATION â”€â”€ */
    .tabs-nav{background:white;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;overflow-x:auto;scrollbar-width:none;}
    .tabs-nav::-webkit-scrollbar{display:none;}
    .tabs-inner{display:flex;min-width:max-content;padding:0 14px;}
    .tnav{padding:12px 14px;font-size:12px;font-weight:700;color:var(--muted);border:none;background:none;cursor:pointer;border-bottom:2.5px solid transparent;transition:all .18s;display:flex;align-items:center;gap:5px;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif;}
    .tnav:hover{color:var(--g3);}
    .tnav.active{color:var(--g3);border-bottom-color:var(--g3);}
    .tnav .notif{background:var(--red);color:white;border-radius:20px;padding:1px 5px;font-size:9px;font-weight:800;}

    /* â”€â”€ SOLDES FLOTTANTS â”€â”€ */
    .soldes-wrap{padding:0 13px;margin-top:-66px;position:relative;z-index:10;}
    .soldes-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:7px;}
    .sc{background:white;border-radius:11px;padding:12px 11px;box-shadow:0 4px 18px rgba(0,0,0,.1);border:1px solid var(--border);}
    .sc-icon{font-size:18px;margin-bottom:4px;}
    .sc-val{font-size:18px;font-weight:800;line-height:1;color:var(--text);}
    .sc-val.g{color:var(--g3);}.sc-val.o{color:var(--orange);}.sc-val.r{color:var(--red);}.sc-val.b{color:var(--blue);}
    .sc-unit{font-size:9px;font-weight:600;}
    .sc-lbl{font-size:8.5px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-top:3px;}
    .sc-sub{font-size:9px;color:var(--muted);margin-top:2px;line-height:1.3;}
    .sc-bar{height:3px;background:#f3f4f6;border-radius:2px;overflow:hidden;margin-top:6px;}
    .sc-fill{height:100%;border-radius:2px;}

    /* â”€â”€ PAGE TABS â”€â”€ */
    .tab-section{display:none;padding:14px 13px 30px;max-width:640px;margin:0 auto;flex-direction:column;gap:14px;}
    .tab-section.active{display:flex;}

    /* â”€â”€ CARD â”€â”€ */
    .card{background:white;border-radius:var(--r);border:1px solid var(--border);overflow:hidden;box-shadow:0 1px 6px rgba(0,0,0,.04);}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:12px 15px;border-bottom:1px solid var(--border);}
    .card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;}
    .card-body{padding:15px;}

    /* â”€â”€ PROFIL â”€â”€ */
    .profil-section-title{font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin:14px 0 8px;padding-bottom:5px;border-bottom:1px solid var(--border);}
    .profil-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
    .profil-field{display:flex;flex-direction:column;gap:3px;}
    .profil-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;}
    .profil-val{font-size:13px;font-weight:600;color:var(--text);padding:8px 10px;background:#f9fafb;border-radius:8px;border:1.5px solid var(--border);}
    .profil-val.editable{cursor:pointer;transition:all .15s;}
    .profil-val.editable:hover{border-color:var(--g3);background:var(--green-ghost);}
    .profil-input{width:100%;padding:8px 10px;border:1.5px solid var(--g3);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;color:var(--text);outline:none;background:white;box-shadow:0 0 0 3px rgba(5,150,105,.07);}
    .profil-input:focus{box-shadow:0 0 0 3px rgba(5,150,105,.12);}
    .profil-full{grid-column:1/-1;}
    .contrat-card{background:linear-gradient(135deg,var(--g1),var(--g2));border-radius:12px;padding:16px 18px;display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;}
    .contrat-left .contrat-type{font-size:15px;font-weight:800;color:white;margin-bottom:4px;}
    .contrat-left .contrat-sub{font-size:11px;color:rgba(255,255,255,.55);line-height:1.5;}
    .contrat-stat{text-align:right;}
    .contrat-stat .cs-val{font-size:18px;font-weight:800;color:#34d399;}
    .contrat-stat .cs-lbl{font-size:9.5px;color:rgba(255,255,255,.45);text-transform:uppercase;letter-spacing:.5px;}
    .btn-save-profil{width:100%;padding:11px;background:linear-gradient(135deg,var(--g3),var(--g4));color:white;border:none;border-radius:10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;margin-top:14px;display:none;}
    .btn-save-profil.show{display:block;}
    .btn-save-profil:hover{opacity:.9;}
    .urgence-card{background:var(--orange-bg);border:1.5px solid #fde68a;border-radius:10px;padding:12px 14px;display:flex;align-items:center;gap:10px;}
    .urgence-ico{font-size:22px;flex-shrink:0;}
    .urgence-body{flex:1;min-width:0;}
    .urgence-name{font-size:13px;font-weight:700;margin-bottom:1px;}
    .urgence-lien{font-size:11px;color:var(--muted);}
    .urgence-tel{font-size:12px;font-weight:700;color:var(--orange);margin-top:2px;}

    /* â”€â”€ DOCUMENTS â”€â”€ */
    .doc-section-lbl{font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin:14px 0 8px;padding-bottom:5px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
    .doc-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;border:1.5px solid var(--border);background:white;margin-bottom:7px;transition:all .15s;cursor:pointer;}
    .doc-item:hover{border-color:#6ee7b7;background:var(--green-ghost);}
    .doc-item.uploaded{border-color:#86efac;background:#f0fdf4;}
    .doc-item.required{border-color:#fca5a5;background:#fff5f5;}
    .doc-item.employer{border-color:#bfdbfe;background:#eff6ff;}
    .doc-ico{width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
    .doc-ico.g{background:#dcfce7;}
    .doc-ico.r{background:#fee2e2;}
    .doc-ico.b{background:#dbeafe;}
    .doc-ico.o{background:#fef3c7;}
    .doc-info{flex:1;min-width:0;}
    .doc-name{font-size:12px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .doc-meta{font-size:10px;color:var(--muted);margin-top:1px;}
    .doc-action{flex-shrink:0;}
    .btn-upload{padding:5px 11px;background:var(--g3);color:white;border:none;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;transition:all .15s;}
    .btn-upload:hover{opacity:.85;}
    .btn-view{padding:5px 11px;background:#dbeafe;color:#1e40af;border:none;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;}
    .badge-req{background:#fee2e2;color:#991b1b;font-size:9px;font-weight:800;padding:2px 6px;border-radius:20px;}
    .badge-ok{background:#dcfce7;color:#166534;font-size:9px;font-weight:800;padding:2px 6px;border-radius:20px;}
    .badge-emp{background:#dbeafe;color:#1e40af;font-size:9px;font-weight:800;padding:2px 6px;border-radius:20px;}
    .doc-progress-bar{height:6px;background:#f3f4f6;border-radius:99px;overflow:hidden;margin:8px 0 2px;}
    .doc-progress-fill{height:100%;background:linear-gradient(90deg,var(--g3),var(--g4));border-radius:99px;transition:width .5s ease;}
    .upload-zone{border:2px dashed var(--border);border-radius:10px;padding:20px 14px;text-align:center;cursor:pointer;background:white;transition:all .15s;margin-top:8px;}
    .upload-zone:hover{border-color:var(--g3);background:var(--green-ghost);}
    .upload-zone-icon{font-size:28px;margin-bottom:6px;}
    .upload-zone-txt{font-size:12px;font-weight:600;color:var(--muted);}
    .upload-zone-sub{font-size:10px;color:var(--muted);margin-top:2px;}

    /* â”€â”€ CONGÃ‰S â”€â”€ */
    .stepper{display:flex;align-items:center;gap:0;margin-bottom:18px;}
    .step-dot{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;border:2px solid var(--border);background:white;color:var(--muted);transition:all .3s;flex-shrink:0;}
    .step-dot.done{background:var(--g3);border-color:var(--g3);color:white;}
    .step-dot.active{background:var(--green-ghost);border-color:var(--g3);color:var(--g3);}
    .step-line{flex:1;height:2px;background:var(--border);transition:background .3s;}
    .step-line.done{background:var(--g3);}
    .form-step{display:none;animation:fin .2s ease;}
    .form-step.active{display:block;}
    @keyframes fin{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
    .type-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:7px;margin-bottom:12px;}
    .tb{padding:10px 9px;border:2px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;background:white;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
    .tb:hover{border-color:var(--g4);background:var(--green-ghost);}
    .tb.sel{border-color:var(--g3);background:var(--green-ghost);}
    .tb-icon{font-size:19px;margin-bottom:3px;}
    .tb-lbl{font-size:11px;font-weight:700;color:var(--text);display:block;}
    .tb-sub{font-size:9.5px;color:var(--muted);display:block;margin-top:1px;}
    .field{display:flex;flex-direction:column;gap:4px;margin-bottom:11px;}
    .field label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;}
    .finput{width:100%;padding:10px 11px;border:1.5px solid var(--border);border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;color:var(--text);outline:none;transition:border-color .15s;-webkit-appearance:none;background:white;}
    .finput:focus{border-color:var(--g3);box-shadow:0 0 0 3px rgba(5,150,105,.07);}
    .date-row{display:grid;grid-template-columns:1fr 1fr;gap:9px;}
    .alert{border-radius:8px;padding:9px 11px;font-size:12px;font-weight:600;margin-bottom:9px;display:none;line-height:1.5;}
    .alert.show{display:block;}
    .alert-green{background:var(--green-ghost);color:#065f46;border-left:3px solid var(--g3);}
    .alert-orange{background:var(--orange-bg);color:#92400e;border-left:3px solid var(--orange);}
    .alert-blue{background:var(--blue-bg);color:#1e40af;border-left:3px solid var(--blue);}
    .alert-red{background:var(--red-bg);color:#991b1b;border-left:3px solid var(--red);}
    .resume{border:2px solid var(--green-light);border-radius:10px;padding:13px;background:var(--green-ghost);margin-bottom:11px;}
    .resume-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--green-light);font-size:12px;}
    .resume-row:last-child{border-bottom:none;font-weight:700;font-size:13px;padding-top:7px;}
    .resume-row span:first-child{color:var(--muted);}
    .btn{padding:9px 16px;border:none;border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;justify-content:center;gap:5px;}
    .btn-green{background:linear-gradient(135deg,var(--g3),var(--g4));color:white;box-shadow:0 3px 10px rgba(5,150,105,.25);}
    .btn-green:hover{opacity:.9;transform:translateY(-1px);}
    .btn-green:active{transform:translateY(0);}
    .btn-green:disabled{opacity:.4;transform:none;cursor:not-allowed;}
    .btn-ghost{background:white;color:var(--g3);border:1.5px solid var(--green-light);}
    .btn-ghost:hover{background:var(--green-ghost);}
    .btn-row{display:flex;gap:7px;justify-content:flex-end;margin-top:12px;}
    .success-wrap{display:none;flex-direction:column;align-items:center;padding:28px 18px;text-align:center;}
    .success-wrap.show{display:flex;}
    .success-circle{width:60px;height:60px;background:var(--green-ghost);border:3px solid var(--green-light);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:12px;animation:pop .35s cubic-bezier(.34,1.56,.64,1);}
    @keyframes pop{from{transform:scale(0)}to{transform:scale(1)}}
    .success-title{font-size:16px;font-weight:800;margin-bottom:5px;}
    .success-sub{font-size:12px;color:var(--muted);max-width:270px;line-height:1.6;}
    .filter-tabs{display:flex;gap:4px;overflow-x:auto;padding-bottom:2px;margin-bottom:11px;scrollbar-width:none;}
    .filter-tabs::-webkit-scrollbar{display:none;}
    .ftab{padding:4px 11px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:white;color:var(--muted);white-space:nowrap;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
    .ftab.active{background:var(--g3);color:white;border-color:var(--g3);}
    .dem-item{display:flex;align-items:flex-start;gap:10px;padding:11px 0;border-bottom:1px solid #f3f4f6;}
    .dem-item:last-child{border-bottom:none;}
    .dem-ico{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;margin-top:1px;}
    .dem-body{flex:1;min-width:0;}
    .dem-name{font-size:12px;font-weight:700;margin-bottom:2px;}
    .dem-dates{font-size:11px;color:var(--muted);}
    .dem-motif{font-size:11px;color:var(--muted);font-style:italic;margin-top:2px;}
    .dem-refus{font-size:10.5px;color:var(--red);margin-top:3px;}
    .badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700;flex-shrink:0;margin-top:3px;}
    .badge-pending{background:#fef3c7;color:#92400e;}
    .badge-approved{background:#dcfce7;color:#166534;}
    .badge-refused{background:#fee2e2;color:#991b1b;}
    .badge-cancelled{background:#f3f4f6;color:#6b7280;}
    .year-btn{font-size:11px;font-weight:700;color:rgba(255,255,255,.4);background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);padding:5px 11px;border-radius:20px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;font-family:'Plus Jakarta Sans',sans-serif;}
    .year-btn:hover{background:rgba(255,255,255,.13);}

    /* â”€â”€ PLANNING â”€â”€ */
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;text-align:center;}
    .cal-hdr{font-size:9.5px;font-weight:700;color:var(--muted);padding:2px 0;}
    .cal-day{aspect-ratio:1;border-radius:5px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:11px;font-weight:500;line-height:1.2;}
    .cal-day.work{font-weight:700;}
    .cal-day.off{opacity:0.4;}
    .cal-day.work-generic{font-weight:500;}
    .cal-day.today{outline:2px solid var(--g3);font-weight:800;}
    .cal-day.abs{color:white;font-weight:700;}
    .cal-day.abs-pending{opacity:.6;}

    /* â”€â”€ JUSTIFICATIF â”€â”€ */
    #justif-wrap{display:none;}
    #justif-preview{display:none;margin-top:7px;padding:8px 12px;background:var(--green-ghost);border:1px solid #6ee7b7;border-radius:8px;align-items:center;gap:8px;}

    /* â”€â”€ INFOS LINE â”€â”€ */
    .info-line{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid #f3f4f6;font-size:12px;}
    .info-line:last-child{border-bottom:none;}
    .info-line-icon{font-size:15px;flex-shrink:0;width:20px;text-align:center;}
    .info-line-label{color:var(--muted);width:110px;flex-shrink:0;font-size:11px;}
    .info-line-val{font-weight:600;flex:1;color:var(--text);}

    /* â”€â”€ TOAST â”€â”€ */
    .toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%) translateY(80px);background:#1a1f36;color:white;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;opacity:0;transition:all .3s;white-space:nowrap;}
    .toast.show{transform:translateX(-50%) translateY(0);opacity:1;}
    .toast.ok{background:var(--g3);}.toast.err{background:var(--red);}.toast.warn{background:var(--orange);}

    /* â”€â”€ MODAL â”€â”€ */
    .modal-overlay{position:fixed;inset:0;background:rgba(5,46,22,.5);backdrop-filter:blur(4px);z-index:200;display:none;align-items:flex-end;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:18px 18px 0 0;width:100%;max-width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 -8px 40px rgba(0,0,0,.15);}
    .modal-head{padding:16px 18px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:white;z-index:1;}
    .modal-head h3{font-size:14px;font-weight:800;}
    .modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);}
    .modal-body{padding:16px 18px 20px;}

    /* â”€â”€ EMPTY â”€â”€ */
    .empty{display:flex;flex-direction:column;align-items:center;padding:26px;text-align:center;color:var(--muted);}
    .empty-icon{font-size:30px;margin-bottom:7px;}

    /* â”€â”€ RESPONSIVE â”€â”€ */
    @media(max-width:480px){
      .soldes-grid{grid-template-columns:1fr 1fr;}
      .date-row{grid-template-columns:1fr;}
      .hero{padding:18px 13px 82px;}
      .profil-row{grid-template-columns:1fr;}
      .tnav{padding:12px 11px;font-size:11px;}
    }
  </style>
</head>
<body>

<div id="loading-wrap">
  <div class="load-logo">ğŸŒ¿ ALTEORE</div>
  <div class="spin"></div>
  <div class="load-sub">Chargement de votre espaceâ€¦</div>
</div>

<div id="not-found">
  <div class="nf-icon">ğŸ”—</div>
  <div class="nf-title">Lien invalide</div>
  <div class="nf-sub">Ce lien n'est pas valide ou a expirÃ©.<br>Demandez Ã  votre employeur un nouveau lien d'accÃ¨s.</div>
</div>

<div id="main-wrap" style="display:none">

  <!-- â•â• HERO â•â• -->
  <div class="hero">
    <div class="hero-top">
      <div class="hero-brand">
        <div class="hero-brand-icon">ğŸŒ¿</div>
        <div class="hero-brand-name">ALTEORE</div>
      </div>
      <button class="year-btn" onclick="changeYear()" id="year-btn">ğŸ“… <span id="year-lbl"></span></button>
    </div>
    <div class="hero-body">
      <div class="hero-avatar" id="hero-av">?</div>
      <div class="hero-info">
        <div class="hero-name" id="hero-name">â€”</div>
        <div class="hero-sub" id="hero-sub">â€”</div>
        <div class="hero-chips" id="hero-chips"></div>
      </div>
    </div>
  </div>

  <!-- â•â• SOLDES â•â• -->
  <div class="soldes-wrap"><div class="soldes-grid" id="soldes-grid"></div></div>

  <!-- â•â• NAVIGATION ONGLETS â•â• -->
  <div class="tabs-nav" style="margin-top:14px">
    <div class="tabs-inner">
      <button class="tnav active" onclick="showTab('accueil',this)">ğŸ  Accueil</button>
      <button class="tnav" onclick="showTab('profil',this)">ğŸ‘¤ Mon profil</button>
      <button class="tnav" onclick="showTab('documents',this)" id="tab-docs-btn">ğŸ“ Documents</button>
      <button class="tnav" onclick="showTab('conges',this)" id="tab-conges-btn">ğŸ–ï¸ CongÃ©s</button>
      <button class="tnav" onclick="showTab('planning',this)">ğŸ“… Planning</button>
    </div>
  </div>

  <!-- â•â• ONGLET ACCUEIL â•â• -->
  <div class="tab-section active" id="tab-accueil" style="margin-top:16px">

    <!-- Bienvenue -->
    <div class="card">
      <div class="card-body" style="padding:18px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
          <div style="font-size:32px">ğŸ‘‹</div>
          <div>
            <div style="font-size:15px;font-weight:800;color:var(--text)" id="welcome-name">Bienvenue !</div>
            <div style="font-size:11px;color:var(--muted)" id="welcome-date"></div>
          </div>
        </div>
        <div id="accueil-infos" style="display:flex;flex-direction:column;gap:0"></div>
      </div>
    </div>

    <!-- Solde rapide -->
    <div class="card">
      <div class="card-head"><div class="card-title">ğŸ“Š Mes soldes <span style="font-size:10px;font-weight:400;color:var(--muted)" id="accueil-annee-lbl"></span></div></div>
      <div class="card-body" style="padding:10px 14px">
        <div id="accueil-soldes"></div>
      </div>
    </div>

    <!-- Demandes rÃ©centes -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">ğŸ“‹ DerniÃ¨res demandes</div>
        <button class="btn-ghost btn" style="font-size:11px;padding:4px 10px" onclick="showTab('conges',document.querySelector('.tnav:nth-child(4))'))">Voir tout</button>
      </div>
      <div class="card-body" style="padding-top:8px" id="accueil-demandes"></div>
    </div>

    <!-- Actions rapides -->
    <div class="card">
      <div class="card-head"><div class="card-title">âš¡ Actions rapides</div></div>
      <div class="card-body" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <button class="btn btn-green" onclick="showTab('conges',document.querySelectorAll('.tnav')[3])">âœ‰ï¸ Demander un congÃ©</button>
        <button class="btn btn-ghost" onclick="showTab('documents',document.querySelectorAll('.tnav')[2])">ğŸ“¤ DÃ©poser un document</button>
        <button class="btn btn-ghost" onclick="showTab('profil',document.querySelectorAll('.tnav')[1])">âœï¸ Modifier mon profil</button>
        <button class="btn btn-ghost" onclick="showTab('planning',document.querySelectorAll('.tnav')[4])">ğŸ“… Voir mon planning</button>
      </div>
    </div>

  </div>

  <!-- â•â• ONGLET PROFIL â•â• -->
  <div class="tab-section" id="tab-profil" style="margin-top:16px">

    <!-- Carte contrat -->
    <div id="contrat-card-wrap"></div>

    <!-- Infos personnelles modifiables -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">ğŸ‘¤ Informations personnelles</div>
        <span style="font-size:10px;color:var(--muted)">âœï¸ Modifiable</span>
      </div>
      <div class="card-body">
        <div class="profil-section-title">CoordonnÃ©es</div>
        <div class="profil-row">
          <div class="profil-field">
            <div class="profil-label">PrÃ©nom</div>
            <div class="profil-val" id="pf-prenom"></div>
          </div>
          <div class="profil-field">
            <div class="profil-label">Nom</div>
            <div class="profil-val" id="pf-nom"></div>
          </div>
        </div>
        <div class="profil-row">
          <div class="profil-field">
            <div class="profil-label">Email personnel</div>
            <div class="profil-val editable" id="pf-email-perso" onclick="editField(this,'emailPerso')" title="Cliquer pour modifier">â€”</div>
          </div>
          <div class="profil-field">
            <div class="profil-label">TÃ©lÃ©phone</div>
            <div class="profil-val editable" id="pf-tel" onclick="editField(this,'telephone')" title="Cliquer pour modifier">â€”</div>
          </div>
        </div>
        <div class="profil-row profil-full">
          <div class="profil-field">
            <div class="profil-label">Adresse</div>
            <div class="profil-val editable" id="pf-adresse" onclick="editField(this,'adresse')" title="Cliquer pour modifier">â€”</div>
          </div>
        </div>
        <div class="profil-row">
          <div class="profil-field">
            <div class="profil-label">Date de naissance</div>
            <div class="profil-val editable" id="pf-ddn" onclick="editField(this,'dateNaissance')" title="Cliquer pour modifier">â€”</div>
          </div>
          <div class="profil-field">
            <div class="profil-label">NationalitÃ©</div>
            <div class="profil-val editable" id="pf-nat" onclick="editField(this,'nationalite')" title="Cliquer pour modifier">â€”</div>
          </div>
        </div>

        <div class="profil-section-title">Informations bancaires</div>
        <div class="profil-row">
          <div class="profil-field">
            <div class="profil-label">IBAN</div>
            <div class="profil-val editable" id="pf-iban" onclick="editField(this,'iban')" title="Cliquer pour modifier">â€”</div>
          </div>
          <div class="profil-field">
            <div class="profil-label">Titulaire du compte</div>
            <div class="profil-val editable" id="pf-titulaire" onclick="editField(this,'ibanTitulaire')" title="Cliquer pour modifier">â€”</div>
          </div>
        </div>
        <div style="font-size:10px;color:var(--muted);background:#fafafa;padding:8px 10px;border-radius:8px;border:1px solid var(--border)">
          ğŸ”’ Vos informations bancaires sont stockÃ©es de faÃ§on sÃ©curisÃ©e et uniquement accessibles par votre employeur pour le versement de votre salaire.
        </div>

        <div class="profil-section-title">Contact d'urgence</div>
        <div id="urgence-wrap"></div>
        <div class="profil-row" style="margin-top:8px">
          <div class="profil-field">
            <div class="profil-label">Nom & prÃ©nom</div>
            <div class="profil-val editable" id="pf-urgence-nom" onclick="editField(this,'contactUrgenceNom')" title="Cliquer pour modifier">â€”</div>
          </div>
          <div class="profil-field">
            <div class="profil-label">Lien (ex : conjoint)</div>
            <div class="profil-val editable" id="pf-urgence-lien" onclick="editField(this,'contactUrgenceLien')" title="Cliquer pour modifier">â€”</div>
          </div>
        </div>
        <div class="profil-row">
          <div class="profil-field">
            <div class="profil-label">TÃ©lÃ©phone urgence</div>
            <div class="profil-val editable" id="pf-urgence-tel" onclick="editField(this,'contactUrgenceTel')" title="Cliquer pour modifier">â€”</div>
          </div>
        </div>

        <button class="btn-save-profil" id="btn-save-profil" onclick="saveProfil()">ğŸ’¾ Enregistrer les modifications</button>
      </div>
    </div>

    <!-- Informations contrat (lecture seule) -->
    <div class="card">
      <div class="card-head"><div class="card-title">ğŸ“„ Mon contrat <span style="font-size:10px;color:var(--muted);font-weight:400">â€” gÃ©rÃ© par votre employeur</span></div></div>
      <div class="card-body" id="contrat-body"></div>
    </div>

  </div>

  <!-- â•â• ONGLET DOCUMENTS â•â• -->
  <div class="tab-section" id="tab-documents" style="margin-top:16px">

    <div class="card">
      <div class="card-head">
        <div class="card-title">ğŸ“ Mes documents</div>
        <span style="font-size:11px;color:var(--muted)" id="docs-progress-lbl"></span>
      </div>
      <div class="card-body">
        <div class="doc-progress-bar">
          <div class="doc-progress-fill" id="docs-progress-fill" style="width:0%"></div>
        </div>
        <!-- Documents Ã  fournir par le salariÃ© -->
        <div class="doc-section-lbl">
          <span>ğŸ“¤ Documents Ã  fournir</span>
          <span id="docs-required-count" style="font-size:10px;color:var(--muted)"></span>
        </div>
        <div id="docs-required-list"></div>

        <!-- Documents transmis par l'employeur -->
        <div class="doc-section-lbl" style="margin-top:16px">
          <span>ğŸ“¥ Documents reÃ§us de l'employeur</span>
          <span id="docs-employer-count" style="font-size:10px;color:var(--muted)"></span>
        </div>
        <div id="docs-employer-list"></div>
      </div>
    </div>

  </div>

  <!-- â•â• ONGLET CONGÃ‰S â•â• -->
  <div class="tab-section" id="tab-conges" style="margin-top:16px">

    <!-- Soldes dÃ©taillÃ©s -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">ğŸ“Š Mes soldes <span id="conges-annee-lbl" style="font-size:10px;font-weight:400;color:var(--muted)"></span></div>
      </div>
      <div class="card-body" style="padding:10px 14px" id="soldes-detail"></div>
    </div>

    <!-- Nouvelle demande -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">âœ‰ï¸ Faire une demande</div>
        <span id="step-lbl" style="font-size:11px;color:var(--muted)">Ã‰tape 1 / 3</span>
      </div>
      <div class="card-body">
        <div class="stepper">
          <div class="step-dot active" id="s1">1</div>
          <div class="step-line" id="sl1"></div>
          <div class="step-dot" id="s2">2</div>
          <div class="step-line" id="sl2"></div>
          <div class="step-dot" id="s3">3</div>
        </div>
        <div class="form-step active" id="st1">
          <div style="font-size:12px;font-weight:700;margin-bottom:10px">Quel type de congÃ© ?</div>
          <div class="type-grid" id="type-grid"></div>
          <div class="alert alert-blue" id="evenement-loi">
            <strong>DurÃ©es lÃ©gales :</strong><br>
            Mariage / PACS : 4j &nbsp;Â·&nbsp; Naissance / Adoption : 3j<br>
            DÃ©cÃ¨s conjoint ou enfant : 5j &nbsp;Â·&nbsp; DÃ©cÃ¨s parent : 3j &nbsp;Â·&nbsp; DÃ©cÃ¨s beau-parent : 3j
          </div>
          <div class="btn-row"><button class="btn btn-green" id="next1" onclick="goStep(2)" disabled>Suivant â†’</button></div>
        </div>
        <div class="form-step" id="st2">
          <div class="date-row">
            <div class="field"><label>Date de dÃ©but</label><input class="finput" type="date" id="f-deb" oninput="onDateChg()"/></div>
            <div class="field"><label>Date de fin</label><input class="finput" type="date" id="f-fin" oninput="onDateChg()"/></div>
          </div>
          <div class="alert alert-green" id="jours-alert"></div>
          <div class="alert alert-orange" id="solde-alert"></div>
          <div class="field"><label>Motif (facultatif)</label><input class="finput" type="text" id="f-motif" placeholder="Ex : vacances, formation, Ã©vÃ©nementâ€¦"/></div>
          <div id="justif-wrap" style="margin-bottom:11px">
            <div class="field" style="margin-bottom:0">
              <label>ğŸ“ Justificatif <span style="font-weight:400;text-transform:none;letter-spacing:0">(arrÃªt maladie, ordonnanceâ€¦)</span></label>
              <div id="justif-drop" onclick="document.getElementById('justif-input').click()" style="border:2px dashed var(--border);border-radius:10px;padding:18px 12px;text-align:center;cursor:pointer;background:white;transition:all .15s;" onmouseover="this.style.borderColor='var(--g3)';this.style.background='var(--green-ghost)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='white'">
                <div style="font-size:26px;margin-bottom:4px">ğŸ“„</div>
                <div style="font-size:12px;font-weight:600;color:var(--muted)">Appuyez pour joindre un fichier</div>
                <div style="font-size:10px;color:var(--muted);margin-top:2px">PDF, JPG, PNG Â· Max 5 Mo Â· Facultatif</div>
              </div>
              <input type="file" id="justif-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="onJustifChange(this)"/>
              <div id="justif-preview" style="margin-top:7px;padding:8px 12px;background:var(--green-ghost);border:1px solid #6ee7b7;border-radius:8px;align-items:center;gap:8px;">
                <span style="font-size:16px">ğŸ“</span>
                <span id="justif-name" style="flex:1;font-size:12px;font-weight:600;color:#065f46;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
                <span id="justif-size" style="font-size:11px;color:var(--muted);flex-shrink:0"></span>
                <button onclick="clearJustif(event)" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:15px;padding:0 2px;flex-shrink:0;line-height:1">âœ•</button>
              </div>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn btn-ghost" onclick="goStep(1)">â† Retour</button>
            <button class="btn btn-green" id="next2" onclick="goStep(3)" disabled>VÃ©rifier â†’</button>
          </div>
        </div>
        <div class="form-step" id="st3">
          <div style="font-size:12px;font-weight:700;margin-bottom:11px">RÃ©capitulatif</div>
          <div class="resume" id="recap"></div>
          <div class="alert alert-orange" id="recap-warn"></div>
          <div class="btn-row">
            <button class="btn btn-ghost" onclick="goStep(2)">â† Modifier</button>
            <button class="btn btn-green" id="btn-submit" onclick="submitDemande()">âœ‰ï¸ Envoyer la demande</button>
          </div>
        </div>
        <div class="success-wrap" id="success-wrap">
          <div class="success-circle">âœ…</div>
          <div class="success-title">Demande envoyÃ©e !</div>
          <div class="success-sub" id="success-sub">Votre demande a Ã©tÃ© transmise.</div>
          <button class="btn btn-green" style="margin-top:14px" onclick="resetForm()">+ Nouvelle demande</button>
        </div>
      </div>
    </div>

    <!-- Historique demandes -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">ğŸ“‹ Mes demandes</div>
        <span id="dem-count" style="font-size:11px;color:var(--muted)"></span>
      </div>
      <div class="card-body" style="padding-top:10px">
        <div class="filter-tabs">
          <button class="ftab active" onclick="setFilter(this,'all')">Toutes</button>
          <button class="ftab" onclick="setFilter(this,'pending')">â³ Attente</button>
          <button class="ftab" onclick="setFilter(this,'approved')">âœ… ApprouvÃ©es</button>
          <button class="ftab" onclick="setFilter(this,'refused')">âŒ RefusÃ©es</button>
          <button class="ftab" onclick="setFilter(this,'cancelled')">ğŸš« AnnulÃ©es</button>
        </div>
        <div id="dem-list"></div>
      </div>
    </div>

  </div>

  <!-- â•â• ONGLET PLANNING â•â• -->
  <div class="tab-section" id="tab-planning" style="margin-top:16px">
    <div class="card">
      <div class="card-head">
        <div class="card-title">ğŸ“… <span id="cal-title">Mon calendrier</span></div>
        <div style="display:flex;gap:5px">
          <button class="btn btn-ghost" style="padding:4px 9px;font-size:12px" onclick="prevM()">â€¹</button>
          <button class="btn btn-ghost" style="padding:4px 9px;font-size:12px" onclick="nextM()">â€º</button>
        </div>
      </div>
      <div class="card-body" style="padding:12px">
        <div class="cal-grid" id="cal-grid"></div>
        <div style="display:flex;flex-wrap:wrap;gap:7px;margin-top:9px" id="cal-legend"></div>
      </div>
    </div>
    <!-- Horaires habituels -->
    <div class="card" id="horaires-card">
      <div class="card-head"><div class="card-title">â° Mes horaires habituels</div></div>
      <div class="card-body" id="horaires-body"></div>
    </div>
  </div>

  <div style="text-align:center;padding:8px 0 16px;color:var(--muted);font-size:10.5px">
    PropulsÃ© par <strong>ALTEORE</strong> Â· Portail salariÃ© sÃ©curisÃ©
  </div>
</div>

<!-- MODAL upload document -->
<div class="modal-overlay" id="upload-modal">
  <div class="modal">
    <div class="modal-head">
      <h3 id="upload-modal-title">ğŸ“¤ DÃ©poser un document</h3>
      <button class="modal-close" onclick="closeUploadModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="font-size:12px;color:var(--muted);margin-bottom:12px" id="upload-modal-desc"></div>
      <div class="upload-zone" onclick="document.getElementById('upload-input').click()">
        <div class="upload-zone-icon">ğŸ“„</div>
        <div class="upload-zone-txt">Cliquer pour sÃ©lectionner un fichier</div>
        <div class="upload-zone-sub">PDF, JPG, PNG Â· Max 5 Mo</div>
      </div>
      <input type="file" id="upload-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="onUploadChange(this)"/>
      <div id="upload-preview" style="display:none;margin-top:10px;padding:10px 12px;background:var(--green-ghost);border:1px solid #6ee7b7;border-radius:8px;align-items:center;gap:8px;flex-direction:row">
        <span style="font-size:20px">ğŸ“</span>
        <div style="flex:1;min-width:0">
          <div id="upload-preview-name" style="font-size:12px;font-weight:700;color:#065f46;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></div>
          <div id="upload-preview-size" style="font-size:10px;color:var(--muted)"></div>
        </div>
        <button onclick="clearUpload()" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:16px;padding:0">âœ•</button>
      </div>
      <button class="btn btn-green" style="width:100%;margin-top:14px" id="upload-submit-btn" onclick="submitUpload()" disabled>ğŸ“¤ Envoyer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- â•â• FIREBASE â•â• -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, addDoc, getDocs, collection, query, where }
    from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com", projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746", appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const db = getFirestore(app);
  window._db = db;
  window._getDoc   = (path, ...s) => getDoc(doc(db, path, ...s));
  window._setDocFs = (path, id, data, opts) => setDoc(doc(db, path, id), data, opts||{});
  window._setDocPath = (segments, data, opts) => {
    // segments = ['col', 'doc', 'subcol', 'subdoc', ...]
    const ref = doc(db, ...segments);
    return setDoc(ref, data, opts||{});
  };
  window._addDoc   = (colPath, data) => addDoc(collection(db, ...colPath), data);
  window._getDocs  = (...colPath) => getDocs(collection(db, ...colPath));
  window._queryWhere = (colPath, field, val) =>
    getDocs(query(collection(db, ...colPath), where(field, '==', val)));
  window._dbReady  = true;
  window.startApp();
</script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var COLORS = {cp:'#059669',rtt:'#3b82f6',css:'#f59e0b',evenement:'#7c3aed',maladie:'#ef4444',recuperation:'#0891b2',formation:'#db2777'};
var LABELS  = {cp:'CongÃ©s payÃ©s',rtt:'RTT',css:'Sans solde',evenement:'Ã‰vÃ©nement familial',maladie:'Maladie / ArrÃªt',recuperation:'RÃ©cupÃ©ration heures',formation:'Formation'};
var ICONS   = {cp:'ğŸ–ï¸',rtt:'â°',css:'ğŸ’¼',evenement:'ğŸ‰',maladie:'ğŸ¤’',recuperation:'ğŸ”„',formation:'ğŸ“'};
var SOLDE_K = {cp:'cpRestant',rtt:'rttRestant',recuperation:'recupRestant'};
var DOW_KEY = ['lundi','mardi','mercredi','jeudi','vendredi','samedi','dimanche'];

// Documents que le salariÃ© doit fournir
var DOCS_REQUIRED = [
  {id:'cni',         label:"PiÃ¨ce dâ€™identitÃ©",       desc:"CNI ou passeport en cours de validitÃ©", icon:'ğŸªª'},
  {id:'rib',         label:"RIB",                                    desc:"RelevÃ© dâ€™identitÃ© bancaire au nom du salariÃ©", icon:'ğŸ¦'},
  {id:'justif_dom',  label:"Justificatif de domicile",               desc:"Facture de moins de 3 mois", icon:'ğŸ '},
  {id:'vitale',      label:"Carte vitale",                           desc:"Carte dâ€™assurance maladie", icon:'ğŸ’š'},
  {id:'titre_sejour',label:"Titre de sÃ©jour",                   desc:"Si ressortissant non-UE Â· facultatif", icon:'ğŸ“‹', optional:true},
  {id:'diplome',     label:"Justificatif de diplÃ´me",           desc:"Copie du diplÃ´me le plus Ã©levÃ© Â· facultatif", icon:'ğŸ“', optional:true},
];
// Echapper les labels pour usage dans onclick HTML
function escHtml(s){ return (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Ã‰TAT GLOBAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var _uid='', _empId='', _emp={}, _params={}, _demandes=[];
var _soldes={};
var _selType='';
var _demFilter='all';
var _calMonth=new Date();
var _year=new Date().getFullYear();
var _planningCache={};
var _profilEdits={};       // modifications en attente
var _profilFields={};      // valeurs actuelles du profil Ã©tendu
var _docsEmployee={};      // {docId: {name, size, uploadedAt, data}}
var _docsEmployer=[];      // [{label, name, uploadedAt, data}]
var _uploadDocId='';       // document en cours d'upload
var _uploadB64=null;
var _uploadMeta=null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DÃ‰MARRAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.startApp = function() {
  var p = new URLSearchParams(window.location.search);
  var pid = p.get('id') || '';
  if (!pid) { showNotFound(); return; }
  var t = setInterval(function() {
    if (window._dbReady) { clearInterval(t); loadEmploye(pid); }
  }, 80);
};

async function loadEmploye(pid) {
  try {
    var snap = await window._getDoc('rh_employes_public', pid);
    if (!snap.exists()) { showNotFound(); return; }
    var data = snap.data();
    _uid = data.uid; _empId = data.empId; _emp = data;

    // Charger le profil Ã©tendu (donnÃ©es saisies par le salariÃ©)
    try {
      var profSnap = await window._getDoc('rh_employes_public_profil', pid);
      if (profSnap.exists()) {
        _profilFields = profSnap.data();
      }
    } catch(e) { _profilFields = {}; }

    // Charger params RH
    try {
      var ps = await window._getDoc('rh_params', _uid);
      _params = ps.exists() ? ps.data() : {};
    } catch(e) { _params = {}; }

    // Charger donnÃ©es employÃ© privÃ©es (lecture seule)
    try {
      var empSnap = await window._getDoc('rh', _uid, 'employes', _empId);
      if (empSnap.exists()) {
        var ed = empSnap.data();
        // Fusion sÃ©curisÃ©e des donnÃ©es RO
        ['salaireBrut','salaireNet','heuresHebdo','frequence','categoriePoste','ccn',
         'dateNaissance','nationalite','periodeEssai','noteMoyenne'].forEach(function(k){
          if(ed[k] !== undefined && _emp[k] === undefined) _emp[k] = ed[k];
        });
        // Documents dÃ©posÃ©s par l'employeur
        if(ed.documentsEmployeur) _docsEmployer = ed.documentsEmployeur;
        // Documents du salariÃ© dÃ©jÃ  stockÃ©s
        if(ed.documentsEmployee) _docsEmployee = ed.documentsEmployee;
      }
    } catch(e) {}

    await loadDemandes();
    await loadPlanningMonth(_calMonth.getFullYear(), _calMonth.getMonth());
    calcSoldes();
    renderAll();

    var lw = document.getElementById('loading-wrap');
    lw.classList.add('fade');
    setTimeout(function() { lw.style.display='none'; document.getElementById('main-wrap').style.display='block'; }, 400);
  } catch(e) { console.error(e); showNotFound(); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARGEMENT DONNÃ‰ES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadDemandes() {
  _demandes = [];
  try {
    var snap = await window._queryWhere(['rh_conges', _uid, 'demandes'], 'empId', _empId);
    snap.forEach(function(d) { _demandes.push(Object.assign({id:d.id}, d.data())); });
    _demandes.sort(function(a,b) { return (b.createdAt||'').localeCompare(a.createdAt||''); });
  } catch(e) { console.warn('Demandes:', e.message); }
}

async function loadPlanningMonth(y, m) {
  _planningCache = {};
  if (!_uid || !_empId) return;
  var weekKeys = {};
  var nb = new Date(y, m+1, 0).getDate();
  for (var d = 1; d <= nb; d++) {
    var dt = new Date(y, m, d);
    var mon = new Date(dt);
    var day = mon.getDay(), diff = (day === 0) ? -6 : 1 - day;
    mon.setDate(mon.getDate() + diff);
    mon.setHours(0,0,0,0);
    var wk = mon.toISOString().slice(0,10).replace(/-/g,'');
    weekKeys[wk] = true;
  }
  for (var wk in weekKeys) {
    try {
      var snap = await window._getDocs('rh', _uid, 'plan_'+wk);
      snap.forEach(function(doc) {
        if (doc.id.endsWith('_'+_empId)) {
          var dateStr = doc.id.replace('_'+_empId, '');
          var data = doc.data();
          _planningCache[dateStr] = (data.items || []).filter(function(it) {
            return it.type === 'travail' || it.type === 'formation' || it.type === 'astreinte';
          });
        }
      });
    } catch(e) {}
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALCUL SOLDES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function calcSoldes() {
  var now = new Date();
  var y = _year;
  var cpAnnuels = parseFloat(_params.cpAnnuels) || 25;
  var cpPeriode = _params.cpPeriode || '1juin';
  var rttAnnuels = parseFloat(_params.rttAnnuels) || 0;
  var pDeb, pFin;
  if (cpPeriode === '1janv') { pDeb = new Date(y,0,1); pFin = new Date(y,11,31); }
  else { pDeb = new Date(y-1,5,1); pFin = new Date(y,4,31); }
  var entree = _emp.dateEntree ? new Date(_emp.dateEntree+'T12:00:00') : new Date(y-2,0,1);
  var debut = entree > pDeb ? entree : pDeb;
  var fin = now < pFin ? now : pFin;
  var mois = Math.max(0, (fin.getFullYear()-debut.getFullYear())*12 + (fin.getMonth()-debut.getMonth()));
  var ajust = parseFloat(_emp.cpAjustAcquis) || 0;
  var cpAcquis = Math.round(Math.max(0, mois*(cpAnnuels/12)+ajust)*10)/10;
  var cpPris = _demandes.filter(function(d) {
    if (!d.dateDebut || d.type !== 'cp' || d.statut !== 'approved') return false;
    var dt = new Date(d.dateDebut+'T12:00:00');
    return dt >= pDeb && dt <= pFin;
  }).reduce(function(s,d) { return s + (d.nbJours||0); }, 0);
  var rttBase = (parseFloat(_emp.rttAjust) >= 0) ? parseFloat(_emp.rttAjust) : rttAnnuels;
  var rttPris = _demandes.filter(function(d) { return d.type==='rtt' && d.statut==='approved' && new Date(d.dateDebut||0).getFullYear()===y; }).reduce(function(s,d) { return s+(d.nbJours||0); }, 0);
  _soldes = {
    cpAcquis: cpAcquis, cpPris: cpPris,
    cpRestant: Math.max(0, cpAcquis-cpPris),
    rttBase: rttBase, rttPris: rttPris,
    rttRestant: Math.max(0, rttBase-rttPris),
    recupRestant: parseFloat(_emp.recupHeures) || 0,
    pending: _demandes.filter(function(d) { return d.statut==='pending'; }).length,
  };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER GLOBAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAll() {
  var col = _emp.couleur || '#059669';
  var av = document.getElementById('hero-av');
  av.textContent = (_emp.prenom||'?').charAt(0).toUpperCase();
  av.style.background = col;
  document.getElementById('hero-name').textContent = ((_emp.prenom||'')+' '+(_emp.nom||'')).trim();
  document.getElementById('hero-sub').textContent  = [_emp.poste,_emp.departement,_emp.typeContrat].filter(Boolean).join(' Â· ');
  document.getElementById('year-lbl').textContent  = _year;

  // Chips hero
  var chips = [];
  if (_emp.typeContrat) chips.push(_emp.typeContrat);
  if (_emp.departement) chips.push(_emp.departement);
  if (_emp.heuresHebdo) chips.push(_emp.heuresHebdo+'h/sem');
  document.getElementById('hero-chips').innerHTML = chips.map(function(c){ return '<span class="hero-chip">'+c+'</span>'; }).join('');

  renderSoldesFlottants();
  renderAccueil();
  renderProfil();
  renderDocuments();
  renderSoldesDetail();
  renderTypeGrid();
  renderDemandes();
  renderCal();
  renderHoraires();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOLDES FLOTTANTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSoldesFlottants() {
  var s = _soldes;
  var cpPct = s.cpAcquis>0 ? Math.min(s.cpPris/s.cpAcquis*100,100).toFixed(0) : 0;
  var rttPct = s.rttBase>0 ? Math.min(s.rttPris/s.rttBase*100,100).toFixed(0) : 0;
  document.getElementById('soldes-grid').innerHTML =
    sc('ğŸ–ï¸', s.cpRestant.toFixed(1), 'j', 'CP restants', s.cpAcquis.toFixed(1)+'j acquis', s.cpRestant>10?'g':s.cpRestant>5?'o':'r', cpPct, 'var(--orange)')
   +sc('â°', s.rttRestant.toFixed(1), 'j', 'RTT restants', s.rttBase+'j allouÃ©s', s.rttRestant>0?'g':'r', rttPct, 'var(--blue)')
   +sc('ğŸ”„', s.recupRestant.toFixed(1), 'h', 'RÃ©cupÃ©ration', 'Heures Ã  prendre', s.recupRestant>0?'g':'', 0, '')
   +sc('â³', s.pending, '', 'En attente', 'demande'+(s.pending>1?'s':'')+' Ã  valider', s.pending>0?'o':'', 0, '');
}
function sc(icon, val, unit, lbl, sub, cls, pct, fillColor) {
  return '<div class="sc">'
    +'<div class="sc-icon">'+icon+'</div>'
    +'<div class="sc-val '+cls+'">'+val+'<span class="sc-unit">'+unit+'</span></div>'
    +'<div class="sc-lbl">'+lbl+'</div>'
    +'<div class="sc-sub">'+sub+'</div>'
    +(pct>0?'<div class="sc-bar"><div class="sc-fill" style="width:'+pct+'%;background:'+fillColor+'"></div></div>':'')
    +'</div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACCUEIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAccueil() {
  var now = new Date();
  var jours = ['dimanche','lundi','mardi','mercredi','jeudi','vendredi','samedi'];
  document.getElementById('welcome-name').textContent = 'Bonjour '+(_emp.prenom||'') +' ! ğŸ‘‹';
  document.getElementById('welcome-date').textContent = jours[now.getDay()]+' '+now.toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'});
  document.getElementById('accueil-annee-lbl').textContent = 'â€” '+_year;
  document.getElementById('conges-annee-lbl').textContent = 'â€” '+_year;

  // Infos contrat
  var infos = [];
  if(_emp.poste) infos.push({icon:'ğŸ’¼', label:'Poste', val:_emp.poste});
  if(_emp.dateEntree) infos.push({icon:'ğŸ“…', label:'EntrÃ©e', val:fmtDate(_emp.dateEntree)});
  if(_emp.typeContrat) infos.push({icon:'ğŸ“„', label:'Contrat', val:_emp.typeContrat});
  if(_emp.departement) infos.push({icon:'ğŸ¢', label:'Ã‰quipe', val:_emp.departement});
  document.getElementById('accueil-infos').innerHTML = infos.map(function(i){
    return '<div class="info-line"><span class="info-line-icon">'+i.icon+'</span><span class="info-line-label">'+i.label+'</span><span class="info-line-val">'+i.val+'</span></div>';
  }).join('');

  // Soldes accueil
  var s = _soldes;
  document.getElementById('accueil-soldes').innerHTML =
    soldeBar('ğŸ–ï¸ CP restants', s.cpRestant, s.cpAcquis, 'j', s.cpRestant>10?'var(--g3)':s.cpRestant>5?'var(--orange)':'var(--red)')
   +soldeBar('â° RTT restants', s.rttRestant, s.rttBase, 'j', s.rttRestant>0?'var(--blue)':'var(--red)')
   +(s.recupRestant>0?soldeBar('ğŸ”„ RÃ©cupÃ©ration', s.recupRestant, s.recupRestant, 'h', 'var(--teal)'):'');

  // 3 derniÃ¨res demandes
  var recent = _demandes.slice(0,3);
  var el = document.getElementById('accueil-demandes');
  if(!recent.length){ el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“‹</div>Aucune demande.</div>'; return; }
  el.innerHTML = recent.map(function(d){
    return demItemHtml(d);
  }).join('');

  // Badge congÃ©s en attente
  var pendingCount = _soldes.pending;
  var tabBtn = document.getElementById('tab-conges-btn');
  if(pendingCount>0 && tabBtn){
    tabBtn.innerHTML = 'ğŸ–ï¸ CongÃ©s <span class="notif">'+pendingCount+'</span>';
  }

  // Badge documents manquants
  var missingDocs = DOCS_REQUIRED.filter(function(d){ return !d.optional && !_docsEmployee[d.id]; }).length;
  var tabDocsBtn = document.getElementById('tab-docs-btn');
  if(missingDocs>0 && tabDocsBtn){
    tabDocsBtn.innerHTML = 'ğŸ“ Documents <span class="notif">'+missingDocs+'</span>';
  }
}

function soldeBar(label, val, max, unit, color) {
  var pct = max>0 ? Math.min(val/max*100,100).toFixed(0) : 0;
  return '<div style="margin-bottom:12px">'
    +'<div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:4px">'
      +'<span style="font-size:12px;font-weight:700">'+label+'</span>'
      +'<span style="font-size:14px;font-weight:800;color:'+color+'">'+val.toFixed(1)+'<span style="font-size:10px;font-weight:600"> '+unit+'</span></span>'
    +'</div>'
    +'<div style="height:6px;background:#f3f4f6;border-radius:99px;overflow:hidden">'
      +'<div style="height:100%;width:'+pct+'%;background:'+color+';border-radius:99px;transition:width .5s ease"></div>'
    +'</div>'
    +'<div style="font-size:10px;color:var(--muted);margin-top:2px">'+val.toFixed(1)+' / '+max.toFixed(1)+' '+unit+' ('+pct+'% utilisÃ©s)</div>'
  +'</div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderProfil() {
  // Contrat card
  var dateEntree = _emp.dateEntree ? fmtDate(_emp.dateEntree) : 'â€”';
  var anciennete = _emp.dateEntree ? calcAnciennete(_emp.dateEntree) : '';
  document.getElementById('contrat-card-wrap').innerHTML =
    '<div class="contrat-card">'
      +'<div class="contrat-left">'
        +'<div class="contrat-type">'+((_emp.typeContrat||'Contrat'))+' Â· '+(_emp.poste||'â€”')+'</div>'
        +'<div class="contrat-sub">'
          +(_emp.departement?_emp.departement+' Â· ':'')
          +(_emp.heuresHebdo?_emp.heuresHebdo+'h/semaine Â· ':'')
          +(_emp.frequence?_emp.frequence.charAt(0).toUpperCase()+_emp.frequence.slice(1)+'':'')
        +'</div>'
        +'<div class="contrat-sub" style="margin-top:4px">EntrÃ©e : '+dateEntree+'</div>'
      +'</div>'
      +(anciennete?'<div class="contrat-stat"><div class="cs-val">'+anciennete+'</div><div class="cs-lbl">AnciennetÃ©</div></div>':'')
    +'</div>';

  // Infos personnelles
  var pf = _profilFields;
  setVal('pf-prenom', _emp.prenom||'â€”');
  setVal('pf-nom', _emp.nom||'â€”');
  setEditVal('pf-email-perso', pf.emailPerso, 'Ajouter email personnel');
  setEditVal('pf-tel', pf.telephone, 'Ajouter tÃ©lÃ©phone');
  setEditVal('pf-adresse', pf.adresse, 'Ajouter adresse');
  setEditVal('pf-ddn', pf.dateNaissance, 'Ajouter date de naissance');
  setEditVal('pf-nat', pf.nationalite, 'Ajouter nationalitÃ©');
  setEditVal('pf-iban', pf.iban ? maskIban(pf.iban) : '', 'Ajouter IBAN');
  setEditVal('pf-titulaire', pf.ibanTitulaire, 'Ajouter titulaire');
  setEditVal('pf-urgence-nom', pf.contactUrgenceNom, 'Ajouter contact urgence');
  setEditVal('pf-urgence-lien', pf.contactUrgenceLien, 'Ex : conjoint, parent...');
  setEditVal('pf-urgence-tel', pf.contactUrgenceTel, 'TÃ©lÃ©phone urgence');

  // Urgence card
  var uw = document.getElementById('urgence-wrap');
  if(pf.contactUrgenceNom && pf.contactUrgenceTel){
    uw.innerHTML = '<div class="urgence-card">'
      +'<div class="urgence-ico">ğŸš¨</div>'
      +'<div class="urgence-body">'
        +'<div class="urgence-name">'+pf.contactUrgenceNom+'</div>'
        +(pf.contactUrgenceLien?'<div class="urgence-lien">'+pf.contactUrgenceLien+'</div>':'')
        +'<div class="urgence-tel">ğŸ“ '+pf.contactUrgenceTel+'</div>'
      +'</div>'
    +'</div>';
  } else { uw.innerHTML = ''; }

  // Contrat RO
  var contratRows = [];
  if(_emp.typeContrat) contratRows.push({icon:'ğŸ“„', label:'Type', val:_emp.typeContrat});
  if(_emp.dateEntree) contratRows.push({icon:'ğŸ“…', label:'Date entrÃ©e', val:fmtDate(_emp.dateEntree)});
  if(_emp.heuresHebdo) contratRows.push({icon:'â°', label:'Horaire', val:_emp.heuresHebdo+'h / semaine'});
  if(_emp.categoriePoste) contratRows.push({icon:'ğŸ’¼', label:'CatÃ©gorie', val:capitalize(_emp.categoriePoste)});
  if(_emp.ccn) contratRows.push({icon:'ğŸ“‹', label:'Convention', val:_emp.ccn});
  if(_emp.periodeEssai && _emp.periodeEssai.active) contratRows.push({icon:'âš ï¸', label:'PÃ©riode essai', val:'En cours'});
  var cb = document.getElementById('contrat-body');
  if(contratRows.length){
    cb.innerHTML = contratRows.map(function(r){
      return '<div class="info-line"><span class="info-line-icon">'+r.icon+'</span><span class="info-line-label">'+r.label+'</span><span class="info-line-val">'+r.val+'</span></div>';
    }).join('');
  } else {
    cb.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“‹</div><span>Infos de contrat Ã  renseigner par votre employeur.</span></div>';
  }
}

function setVal(id, val) { var el=document.getElementById(id); if(el) el.textContent=val; }
function setEditVal(id, val, placeholder) {
  var el = document.getElementById(id);
  if(!el) return;
  if(val) {
    el.textContent = val;
    el.style.color = 'var(--text)';
  } else {
    el.textContent = placeholder||'â€”';
    el.style.color = 'var(--muted)';
  }
}

function editField(el, fieldKey) {
  var currentVal = _profilFields[fieldKey] || '';
  var input = document.createElement('input');
  input.className = 'profil-input';
  input.value = currentVal;
  input.placeholder = el.getAttribute('title') || 'Saisir...';
  el.replaceWith(input);
  input.focus();
  input.select();

  function save() {
    var newVal = input.value.trim();
    _profilEdits[fieldKey] = newVal;
    _profilFields[fieldKey] = newVal;
    var div = document.createElement('div');
    div.id = el.id;
    div.className = el.className;
    div.setAttribute('onclick', el.getAttribute('onclick'));
    div.setAttribute('title', el.getAttribute('title'));
    div.style.color = newVal ? 'var(--text)' : 'var(--muted)';
    if(fieldKey==='iban' && newVal) div.textContent = maskIban(newVal);
    else div.textContent = newVal || (el.getAttribute('title')||'â€”');
    input.replaceWith(div);
    // RÃ©attacher le event onclick
    div.addEventListener('click', function(){ editField(div, fieldKey); });
    // Afficher bouton save
    if(Object.keys(_profilEdits).length > 0){
      document.getElementById('btn-save-profil').classList.add('show');
    }
  }
  input.addEventListener('blur', save);
  input.addEventListener('keydown', function(e){ if(e.key==='Enter') input.blur(); if(e.key==='Escape'){ input.value=currentVal; input.blur(); } });
}
window.editField = editField;

async function saveProfil() {
  if(!Object.keys(_profilEdits).length) return;
  var btn = document.getElementById('btn-save-profil');
  btn.textContent = 'â³ Enregistrement...';
  btn.disabled = true;
  try {
    // Fusionner avec donnÃ©es existantes
    var toSave = Object.assign({}, _profilFields, _profilEdits, {
      empId: _empId,
      uid: _uid,
      updatedAt: new Date().toISOString()
    });
    await window._setDocFs('rh_employes_public_profil', _uid+'_'+_empId, toSave, {merge:true});
    // Aussi mettre Ã  jour les champs non-sensibles sur le doc public
    var publicUpdate = {};
    if(_profilEdits.telephone) publicUpdate.telephone = _profilEdits.telephone;
    if(_profilEdits.contactUrgenceNom) publicUpdate.contactUrgenceNom = _profilEdits.contactUrgenceNom;
    if(_profilEdits.contactUrgenceTel) publicUpdate.contactUrgenceTel = _profilEdits.contactUrgenceTel;
    if(_profilEdits.contactUrgenceLien) publicUpdate.contactUrgenceLien = _profilEdits.contactUrgenceLien;
    if(Object.keys(publicUpdate).length){
      Object.assign(_emp, publicUpdate);
    }
    _profilEdits = {};
    btn.classList.remove('show');
    btn.textContent = 'ğŸ’¾ Enregistrer les modifications';
    btn.disabled = false;
    showToast('âœ… Profil enregistrÃ©','ok');
    renderProfil(); // re-render urgence card
  } catch(e) {
    console.error(e);
    showToast('Erreur : '+e.message,'err');
    btn.textContent = 'ğŸ’¾ Enregistrer les modifications';
    btn.disabled = false;
  }
}
window.saveProfil = saveProfil;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOCUMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderDocuments() {
  var total = DOCS_REQUIRED.filter(function(d){ return !d.optional; }).length;
  var done = DOCS_REQUIRED.filter(function(d){ return !d.optional && _docsEmployee[d.id]; }).length;
  var pct = total>0 ? Math.round(done/total*100) : 0;

  document.getElementById('docs-progress-lbl').textContent = done+' / '+total+' documents fournis';
  document.getElementById('docs-progress-fill').style.width = pct+'%';
  document.getElementById('docs-required-count').textContent = done+'/'+total;

  // Liste docs Ã  fournir â€” data-idx pour Ã©viter apostrophes dans onclick
  var reqList = document.getElementById('docs-required-list');
  reqList.innerHTML = DOCS_REQUIRED.map(function(doc, idx) {
    var uploaded = _docsEmployee[doc.id];
    var cls = uploaded ? 'doc-item uploaded' : (doc.optional ? 'doc-item' : 'doc-item required');
    var icoClass = uploaded ? 'g' : (doc.optional ? 'o' : 'r');
    var dateStr = uploaded && uploaded.uploadedAt ? ' \u00b7 ' + fmtDate(uploaded.uploadedAt.split('T')[0]) : '';
    var labelSafe = escHtml(doc.label);
    var descSafe  = escHtml(uploaded ? ('\u2705 '+uploaded.name+dateStr) : doc.desc);
    var btn = uploaded
      ? '<button class="btn-view" data-idx="'+idx+'" onclick="viewDocIdx(this)">\ud83d\udc41 Voir</button>'
      : '<button class="btn-upload" data-idx="'+idx+'" onclick="openUploadIdx(this)">\ud83d\udce4 D\u00e9poser</button>';
    return '<div class="'+cls+'">'
      +'<div class="doc-ico '+icoClass+'">'+doc.icon+'</div>'
      +'<div class="doc-info">'
        +'<div class="doc-name">'+labelSafe+(doc.optional?' <span style="font-size:9px;font-weight:400;color:var(--muted)">(facultatif)</span>':'')+'</div>'
        +'<div class="doc-meta">'+descSafe+'</div>'
      +'</div>'
      +'<div class="doc-action">'+btn+'</div>'
    +'</div>';
  }).join('');

  // Docs reÃ§us de l'employeur
  var empList = document.getElementById('docs-employer-list');
  document.getElementById('docs-employer-count').textContent = _docsEmployer.length || '0';
  if(!_docsEmployer.length){
    empList.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“¥</div>Aucun document transmis par votre employeur pour l\'instant.</div>';
  } else {
    empList.innerHTML = _docsEmployer.map(function(doc, i) {
      var dateStr = doc.uploadedAt ? fmtDate(doc.uploadedAt.split('T')[0]) : '';
      return '<div class="doc-item employer">'
        +'<div class="doc-ico b">ğŸ“„</div>'
        +'<div class="doc-info">'
          +'<div class="doc-name">'+doc.label+'</div>'
          +'<div class="doc-meta">'+doc.name+(dateStr?' Â· '+dateStr:'')+'</div>'
        +'</div>'
        +'<div class="doc-action">'
          +(doc.data ? '<button class="btn-view" onclick="viewEmployerDoc('+i+')">ğŸ‘ Voir</button>' : '')
        +'</div>'
      +'</div>';
    }).join('');
  }
}

// Ouvre la modal via index (pas de string dans onclick)
function openUploadIdx(btn) {
  var idx = parseInt(btn.getAttribute('data-idx'));
  var docDef = DOCS_REQUIRED[idx] || {};
  openUploadModal(docDef.id, docDef.label, docDef.desc);
}
window.openUploadIdx = openUploadIdx;

function openUploadModal(docId, label, desc) {
  _uploadDocId = docId;
  _uploadB64 = null; _uploadMeta = null;
  document.getElementById('upload-modal-title').textContent = '\ud83d\udce4 '+(label||docId);
  document.getElementById('upload-modal-desc').textContent = desc||'';
  document.getElementById('upload-input').value = '';
  document.getElementById('upload-preview').style.display = 'none';
  document.getElementById('upload-submit-btn').disabled = true;
  document.getElementById('upload-modal').classList.add('show');
}
window.openUploadModal = openUploadModal;

function closeUploadModal() {
  document.getElementById('upload-modal').classList.remove('show');
  _uploadB64 = null; _uploadMeta = null;
}
window.closeUploadModal = closeUploadModal;

function onUploadChange(input) {
  var file = input.files[0];
  if (!file) return;
  if (file.size > 5*1024*1024) { showToast('Fichier trop lourd (max 5 Mo)','err'); return; }
  var reader = new FileReader();
  reader.onload = function(e) {
    _uploadB64 = e.target.result;
    _uploadMeta = { name: file.name, size: file.size, type: file.type };
    document.getElementById('upload-preview-name').textContent = file.name;
    document.getElementById('upload-preview-size').textContent = (file.size/1024).toFixed(0)+'Ko';
    document.getElementById('upload-preview').style.display = 'flex';
    document.getElementById('upload-submit-btn').disabled = false;
  };
  reader.readAsDataURL(file);
}
window.onUploadChange = onUploadChange;

function clearUpload() {
  _uploadB64 = null; _uploadMeta = null;
  document.getElementById('upload-input').value = '';
  document.getElementById('upload-preview').style.display = 'none';
  document.getElementById('upload-submit-btn').disabled = true;
}
window.clearUpload = clearUpload;

async function submitUpload() {
  if(!_uploadB64 || !_uploadDocId) return;
  var btn = document.getElementById('upload-submit-btn');
  btn.disabled = true; btn.textContent = 'â³ Envoi...';
  try {
    var docData = {
      name: _uploadMeta.name,
      size: _uploadMeta.size,
      type: _uploadMeta.type,
      data: _uploadB64,
      uploadedAt: new Date().toISOString()
    };
    _docsEmployee[_uploadDocId] = docData;
    // Sauvegarder dans Firestore (sur la fiche employÃ© privÃ©e)
    var docsUpdate = {};
    docsUpdate['documentsEmployee'] = _docsEmployee;
    await window._setDocPath(['rh', _uid, 'employes', _empId], docsUpdate, {merge:true});
    closeUploadModal();
    renderDocuments();
    showToast('âœ… Document dÃ©posÃ© avec succÃ¨s','ok');
  } catch(e) {
    console.error(e);
    showToast('Erreur : '+e.message,'err');
    btn.disabled = false; btn.textContent = 'ğŸ“¤ Envoyer';
  }
}
window.submitUpload = submitUpload;

function viewDocIdx(btn) {
  var idx = parseInt(btn.getAttribute('data-idx'));
  var docDef = DOCS_REQUIRED[idx] || {};
  viewDoc(docDef.id);
}
window.viewDocIdx = viewDocIdx;

function viewDoc(docId) {
  var doc = _docsEmployee[docId];
  if(!doc || !doc.data) { showToast('Document non disponible','err'); return; }
  var win = window.open('','_blank');
  if(doc.type && doc.type.startsWith('image/')){
    win.document.write('<html><body style="margin:0;background:#111"><img src="'+doc.data+'" style="max-width:100%;display:block;margin:auto"/></body></html>');
  } else {
    win.location.href = doc.data;
  }
}
window.viewDoc = viewDoc;

function viewEmployerDoc(i) {
  var doc = _docsEmployer[i];
  if(!doc || !doc.data) { showToast('Document non disponible','err'); return; }
  var win = window.open('','_blank');
  if(doc.type && doc.type.startsWith('image/')){
    win.document.write('<html><body style="margin:0;background:#111"><img src="'+doc.data+'" style="max-width:100%;display:block;margin:auto"/></body></html>');
  } else {
    win.location.href = doc.data;
  }
}
window.viewEmployerDoc = viewEmployerDoc;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOLDES DÃ‰TAILLÃ‰S (onglet congÃ©s)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderSoldesDetail() {
  var s = _soldes;
  var items = [
    {icon:'ğŸ–ï¸', label:'CongÃ©s payÃ©s', acquis:s.cpAcquis, pris:s.cpPris, restant:s.cpRestant, unit:'j', color:'var(--g3)'},
    {icon:'â°', label:'RTT', acquis:s.rttBase, pris:s.rttPris, restant:s.rttRestant, unit:'j', color:'var(--blue)'},
    {icon:'ğŸ”„', label:'RÃ©cupÃ©ration', acquis:s.recupRestant, pris:0, restant:s.recupRestant, unit:'h', color:'var(--teal)'},
  ];
  document.getElementById('soldes-detail').innerHTML = items.map(function(it){
    var pct = it.acquis>0 ? Math.min(it.pris/it.acquis*100,100).toFixed(0) : 0;
    return '<div style="margin-bottom:12px;padding:10px 12px;background:#f9fafb;border-radius:10px;border:1px solid var(--border)">'
      +'<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'
        +'<span style="font-size:12px;font-weight:700">'+it.icon+' '+it.label+'</span>'
        +'<span style="font-size:16px;font-weight:800;color:'+it.color+'">'+it.restant.toFixed(1)+'<span style="font-size:10px;font-weight:600"> '+it.unit+'</span></span>'
      +'</div>'
      +'<div style="height:6px;background:#e5e7eb;border-radius:99px;overflow:hidden;margin-bottom:5px">'
        +'<div style="height:100%;width:'+pct+'%;background:'+it.color+';border-radius:99px;transition:width .5s ease"></div>'
      +'</div>'
      +'<div style="display:flex;justify-content:space-between;font-size:10px;color:var(--muted)">'
        +'<span>'+it.pris.toFixed(1)+' '+it.unit+' pris</span>'
        +'<span>'+it.acquis.toFixed(1)+' '+it.unit+' allouÃ©s</span>'
      +'</div>'
    +'</div>';
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TYPE GRID (congÃ©s)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderTypeGrid() {
  var types = [
    {k:'cp',          sub: _soldes.cpRestant.toFixed(1)+'j disponibles'},
    {k:'rtt',         sub: _soldes.rttRestant.toFixed(1)+'j disponibles'},
    {k:'recuperation',sub:(_soldes.recupRestant||0)+'h disponibles'},
    {k:'css',         sub:'Non dÃ©comptÃ© du solde'},
    {k:'evenement',   sub:'DurÃ©es lÃ©gales'},
    {k:'maladie',     sub:'ArrÃªt mÃ©dical'},
    {k:'formation',   sub:'Formation professionnelle'},
  ];
  document.getElementById('type-grid').innerHTML = types.map(function(t) {
    return '<button class="tb '+((_selType===t.k)?'sel':'')+'" onclick="selType(\''+t.k+'\')">'
      +'<div class="tb-icon">'+ICONS[t.k]+'</div>'
      +'<span class="tb-lbl">'+LABELS[t.k]+'</span>'
      +'<span class="tb-sub">'+t.sub+'</span>'
      +'</button>';
  }).join('');
}

function setFilter(btn, f) {
  _demFilter = f;
  document.querySelectorAll('.ftab').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  renderDemandes();
}
window.setFilter = setFilter;

function renderDemandes() {
  var el = document.getElementById('dem-list');
  var cnt = document.getElementById('dem-count');
  var list = _demFilter === 'all' ? _demandes : _demandes.filter(function(d) { return d.statut === _demFilter; });
  cnt.textContent = _demandes.length+' demande'+(_demandes.length>1?'s':'');
  if (!list.length) { el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ“‹</div>Aucune demande.</div>'; return; }
  el.innerHTML = list.map(function(d){ return demItemHtml(d); }).join('');
}

function demItemHtml(d) {
  var db = d.dateDebut ? new Date(d.dateDebut+'T12:00:00').toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'}) : '?';
  var de = (d.dateFin && d.dateFin!==d.dateDebut) ? ' â†’ '+new Date(d.dateFin+'T12:00:00').toLocaleDateString('fr-FR',{day:'numeric',month:'short'}) : '';
  var bTxt = {pending:'â³ En attente',approved:'âœ… ApprouvÃ©e',refused:'âŒ RefusÃ©e',cancelled:'ğŸš« AnnulÃ©e'}[d.statut] || d.statut;
  return '<div class="dem-item">'
    +'<div class="dem-ico" style="background:'+(COLORS[d.type]||'#6b7280')+'22">'+(ICONS[d.type]||'ğŸ“‹')+'</div>'
    +'<div class="dem-body">'
      +'<div class="dem-name">'+(LABELS[d.type]||d.type)+' <strong style="color:'+(COLORS[d.type]||'var(--g3)')+'">'+(d.nbJours||0)+'j</strong></div>'
      +'<div class="dem-dates">'+db+de+'</div>'
      +(d.motif?'<div class="dem-motif">'+d.motif+'</div>':'')
      +(d.motifRefus?'<div class="dem-refus">Motif du refus : '+d.motifRefus+'</div>':'')
      +'<span class="badge badge-'+(d.statut||'pending')+'">'+bTxt+'</span>'
    +'</div>'
  +'</div>';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PLANNING & HORAIRES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderCal() {
  var y = _calMonth.getFullYear(), m = _calMonth.getMonth();
  var nb = new Date(y,m+1,0).getDate();
  var firstDow = (new Date(y,m,1).getDay()+6)%7;
  document.getElementById('cal-title').textContent = new Date(y,m,1).toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
  var horaires = (_params && _params.horaires) || {
    lundi:{actif:true},mardi:{actif:true},mercredi:{actif:true},
    jeudi:{actif:true},vendredi:{actif:true},samedi:{actif:false},dimanche:{actif:false}
  };
  var absMap = {};
  _demandes.filter(function(d) { return d.statut==='approved'||d.statut==='pending'; }).forEach(function(d) {
    if (!d.dateDebut) return;
    var cur = new Date(d.dateDebut+'T12:00:00');
    var fin = new Date((d.dateFin||d.dateDebut)+'T12:00:00');
    while (cur <= fin) {
      if (cur.getFullYear()===y && cur.getMonth()===m)
        absMap[cur.getDate()] = {type:d.type, pending:d.statut==='pending'};
      cur.setDate(cur.getDate()+1);
    }
  });
  var today = new Date();
  var hdrs = ['L','M','M','J','V','S','D'];
  var calHtml = '';
  hdrs.forEach(function(h) { calHtml += '<div class="cal-hdr">'+h+'</div>'; });
  for (var i=0; i<firstDow; i++) calHtml += '<div></div>';
  var usedTypes = {};
  for (var d=1; d<=nb; d++) {
    var dow = (firstDow+d-1)%7;
    var jourKey = DOW_KEY[dow];
    var dateStr = y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
    var items = _planningCache[dateStr] || null;
    var hasPlan = items && items.length > 0;
    var abs = absMap[d];
    var isToday = d===today.getDate() && m===today.getMonth() && y===today.getFullYear();
    var bg='', col='', ttl='', cls='cal-day', extra='';
    if (isToday) cls += ' today';
    if (abs) {
      bg = abs.pending ? (COLORS[abs.type]+'cc') : COLORS[abs.type];
      col = 'white';
      ttl = LABELS[abs.type]+(abs.pending?' (en attente)':'');
      cls += ' abs'+(abs.pending?' abs-pending':'');
      usedTypes[abs.type] = true;
      if (hasPlan) extra = '<div style="font-size:7px;opacity:0.7;line-height:1;margin-top:2px">'+getPlagesStr(items[0])+'</div>';
    } else if (hasPlan) {
      var totalH = items.reduce(function(s,it) { return s + itemH(it); }, 0);
      bg = 'rgba(5,150,105,0.12)'; col = '#047857'; cls += ' work';
      ttl = getPlagesStr(items[0]) + ' (' + totalH.toFixed(1) + 'h)';
      extra = '<div style="font-size:7.5px;font-weight:700;line-height:1.2;margin-top:2px;opacity:0.85">'+getPlagesStr(items[0])+'</div>';
      usedTypes['__travail'] = true;
    } else if (horaires[jourKey] && horaires[jourKey].actif) {
      bg = 'rgba(5,150,105,0.06)'; col = '#6ee7b7'; cls += ' work work-generic';
      var h = horaires[jourKey];
      ttl = 'Horaire habituel'+(h.deb&&h.fin?' Â· '+h.deb+' â€“ '+h.fin:'');
    } else {
      bg = 'transparent'; col = '#d1d5db'; cls += ' off';
    }
    var style = 'background:'+bg+';color:'+col+';';
    if (isToday) style += 'outline:2px solid #059669;outline-offset:-2px;';
    calHtml += '<div class="'+cls+'" style="'+style+'" title="'+ttl+'">'+d+extra+'</div>';
  }
  document.getElementById('cal-grid').innerHTML = calHtml;
  var legHtml = '';
  if (Object.keys(_planningCache).length > 0)
    legHtml += '<div style="display:flex;align-items:center;gap:5px;font-size:10px;color:var(--muted)"><div style="width:9px;height:9px;border-radius:2px;background:rgba(5,150,105,0.4)"></div>PlanifiÃ©</div>';
  else
    legHtml += '<div style="display:flex;align-items:center;gap:5px;font-size:10px;color:var(--muted)"><div style="width:9px;height:9px;border-radius:2px;background:rgba(5,150,105,0.15)"></div>Horaire habituel</div>';
  legHtml += Object.keys(usedTypes).filter(function(t){ return t!=='__travail'; }).map(function(t) {
    return '<div style="display:flex;align-items:center;gap:5px;font-size:10px;color:var(--muted)"><div style="width:9px;height:9px;border-radius:2px;background:'+(COLORS[t]||'#6b7280')+'"></div>'+(LABELS[t]||t)+'</div>';
  }).join('');
  document.getElementById('cal-legend').innerHTML = legHtml;
}

function renderHoraires() {
  var horaires = (_params && _params.horaires) || {};
  var joursActifs = DOW_KEY.filter(function(j){ return horaires[j] && horaires[j].actif; });
  var card = document.getElementById('horaires-card');
  if(!joursActifs.length){ card.style.display='none'; return; }
  card.style.display='';
  var jLabels = {lundi:'Lundi',mardi:'Mardi',mercredi:'Mercredi',jeudi:'Jeudi',vendredi:'Vendredi',samedi:'Samedi',dimanche:'Dimanche'};
  document.getElementById('horaires-body').innerHTML = joursActifs.map(function(j){
    var h = horaires[j];
    return '<div class="info-line">'
      +'<span class="info-line-icon">ğŸ“†</span>'
      +'<span class="info-line-label">'+jLabels[j]+'</span>'
      +'<span class="info-line-val" style="font-size:12px">'+(h.deb&&h.fin?h.deb+' â€“ '+h.fin:'Actif')+'</span>'
    +'</div>';
  }).join('');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMULAIRE CONGÃ‰S
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var _curStep = 1;
var _justifB64 = null;
var _justifMeta = null;

function onJustifChange(input) {
  var file = input.files[0];
  if (!file) return;
  if (file.size > 5*1024*1024) { showToast('Fichier trop lourd (max 5 Mo)','err'); return; }
  var reader = new FileReader();
  reader.onload = function(e) {
    _justifB64 = e.target.result;
    _justifMeta = { name: file.name, size: file.size, type: file.type };
    document.getElementById('justif-name').textContent = file.name;
    document.getElementById('justif-size').textContent = (file.size/1024).toFixed(0)+'Ko';
    var prev = document.getElementById('justif-preview');
    prev.style.display = 'flex';
    document.getElementById('justif-drop').style.display = 'none';
  };
  reader.readAsDataURL(file);
}
window.onJustifChange = onJustifChange;

function clearJustif(e) {
  if (e) e.stopPropagation();
  _justifB64 = null; _justifMeta = null;
  var inp = document.getElementById('justif-input');
  if (inp) inp.value = '';
  document.getElementById('justif-preview').style.display = 'none';
  document.getElementById('justif-drop').style.display = '';
}
window.clearJustif = clearJustif;

function selType(k) {
  _selType = k;
  renderTypeGrid();
  document.getElementById('next1').disabled = false;
  document.getElementById('evenement-loi').className = 'alert alert-blue'+(k==='evenement'?' show':'');
  var jw = document.getElementById('justif-wrap');
  if (jw) jw.style.display = (k==='maladie' || k==='formation') ? '' : 'none';
  clearJustif();
}
window.selType = selType;

function goStep(n) {
  if (n===2 && !_selType) return;
  if (n===3) {
    var deb = document.getElementById('f-deb').value;
    if (!deb) { showToast('SÃ©lectionnez une date de dÃ©but','err'); return; }
    buildRecap();
  }
  _curStep = n;
  document.querySelectorAll('.form-step').forEach(function(e) { e.classList.remove('active'); });
  var st = document.getElementById('st'+n);
  if (st) st.classList.add('active');
  for (var i=1; i<=3; i++) {
    var dd = document.getElementById('s'+i);
    var ll = document.getElementById('sl'+i);
    if (dd) dd.className = 'step-dot'+(i<n?' done':i===n?' active':'');
    if (ll && i<3) ll.className = 'step-line'+(i<n?' done':'');
  }
  document.getElementById('step-lbl').textContent = 'Ã‰tape '+n+' / 3';
}
window.goStep = goStep;

function joursOuvres(deb, fin) {
  if (!deb || !fin) return 0;
  var d = new Date(deb+'T12:00:00'), f = new Date(fin+'T12:00:00'), c = 0;
  while (d <= f) { var dw = d.getDay(); if (dw!==0 && dw!==6) c++; d.setDate(d.getDate()+1); }
  return c;
}

function onDateChg() {
  var deb = document.getElementById('f-deb').value;
  var fin = document.getElementById('f-fin').value;
  if (fin && fin < deb) { document.getElementById('f-fin').value = deb; fin = deb; }
  var ja = document.getElementById('jours-alert');
  var sa = document.getElementById('solde-alert');
  if (!deb) { ja.className='alert alert-green'; sa.className='alert alert-orange'; document.getElementById('next2').disabled=true; return; }
  var jours = joursOuvres(deb, fin||deb);
  ja.textContent = 'ğŸ“… '+jours+' jour'+(jours>1?'s':'')+' ouvrÃ©'+(jours>1?'s':'');
  ja.className = 'alert alert-green show';
  document.getElementById('next2').disabled = false;
  var sk = SOLDE_K[_selType];
  if (sk && _soldes[sk] !== undefined) {
    var solde = parseFloat(_soldes[sk]) || 0;
    if (jours > solde) {
      sa.textContent = 'âš ï¸ Solde insuffisant : '+solde.toFixed(1)+(_selType==='recuperation'?'h':'j')+' disponibles, '+jours+'j demandÃ©s';
      sa.className = 'alert alert-orange show';
    } else sa.className = 'alert alert-orange';
  } else sa.className = 'alert alert-orange';
}
window.onDateChg = onDateChg;

function buildRecap() {
  var deb    = document.getElementById('f-deb').value;
  var fin    = document.getElementById('f-fin').value || deb;
  var motif  = document.getElementById('f-motif').value.trim();
  var jours  = joursOuvres(deb, fin);
  var debFmt = new Date(deb+'T12:00:00').toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  var finFmt = new Date(fin+'T12:00:00').toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});
  var sk     = SOLDE_K[_selType];
  var solde  = (sk !== undefined) ? (parseFloat(_soldes[sk])||0) : null;
  var apres  = solde !== null ? Math.max(0, solde-jours) : null;
  var rw     = document.getElementById('recap-warn');
  if (solde !== null && jours > solde) {
    rw.textContent = 'âš ï¸ Solde insuffisant ('+solde.toFixed(1)+'j dispo). Votre employeur en sera informÃ©.';
    rw.className = 'alert alert-orange show';
  } else rw.className = 'alert alert-orange';
  document.getElementById('recap').innerHTML =
    '<div class="resume-row"><span>Type</span><span>'+ICONS[_selType]+' '+LABELS[_selType]+'</span></div>'
    +'<div class="resume-row"><span>Du</span><span>'+debFmt+'</span></div>'
    +'<div class="resume-row"><span>Au</span><span>'+finFmt+'</span></div>'
    +(motif?'<div class="resume-row"><span>Motif</span><span>'+motif+'</span></div>':'')
    +'<div class="resume-row"><span>Total</span><span style="color:var(--g3)">'+jours+' jour'+(jours>1?'s':'')+' ouvrÃ©'+(jours>1?'s':'')+'</span></div>'
    +(apres!==null?'<div class="resume-row"><span>Solde aprÃ¨s</span><span style="color:'+(apres>5?'var(--g3)':'var(--orange)')+'">'+apres.toFixed(1)+'j</span></div>':'')
    +(_justifB64?'<div class="resume-row"><span>Justificatif</span><span style="color:var(--g3)">ğŸ“ '+(_justifMeta?_justifMeta.name:'Fichier joint')+'</span></div>':'');
}

async function submitDemande() {
  var deb   = document.getElementById('f-deb').value;
  var fin   = document.getElementById('f-fin').value || deb;
  var motif = document.getElementById('f-motif').value.trim();
  var jours = joursOuvres(deb, fin);
  var btn = document.getElementById('btn-submit');
  btn.disabled = true; btn.textContent = 'Envoiâ€¦';
  var demandeData = {
    empId:_empId, uid:_uid, type:_selType, dateDebut:deb, dateFin:fin, nbJours:jours,
    statut:'pending', motif:motif||null,
    createdAt:new Date().toISOString(), source:'salarie',
  };
  if (_justifB64 && _justifMeta) {
    demandeData.justificatif = { data:_justifB64, name:_justifMeta.name, size:_justifMeta.size, type:_justifMeta.type };
  }
  try {
    await window._addDoc(['rh_conges', _uid, 'demandes'], demandeData);
    _demandes.unshift({id:'tmp_'+Date.now(),empId:_empId,type:_selType,dateDebut:deb,dateFin:fin,nbJours:jours,statut:'pending',motif:motif||null,createdAt:new Date().toISOString()});
    calcSoldes(); renderSoldesFlottants(); renderDemandes(); renderCal(); renderAccueil();
    document.getElementById('st3').classList.remove('active');
    var sw = document.getElementById('success-wrap');
    sw.style.display = 'flex'; sw.classList.add('show');
    document.getElementById('success-sub').textContent = 'Votre demande de '+jours+'j ('+LABELS[_selType]+') a Ã©tÃ© transmise. Votre employeur la traitera prochainement.';
  } catch(e) {
    console.error(e); showToast('Erreur : '+e.message, 'err');
    btn.disabled = false; btn.textContent = 'âœ‰ï¸ Envoyer la demande';
  }
}
window.submitDemande = submitDemande;

function resetForm() {
  _selType = ''; _curStep = 1;
  var sw = document.getElementById('success-wrap');
  sw.style.display = 'none'; sw.classList.remove('show');
  document.getElementById('f-deb').value = '';
  document.getElementById('f-fin').value = '';
  document.getElementById('f-motif').value = '';
  document.getElementById('jours-alert').className = 'alert alert-green';
  document.getElementById('solde-alert').className = 'alert alert-orange';
  document.getElementById('next1').disabled = true;
  document.getElementById('next2').disabled = true;
  clearJustif();
  var jw = document.getElementById('justif-wrap');
  if (jw) jw.style.display = 'none';
  goStep(1); renderTypeGrid();
}
window.resetForm = resetForm;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION ONGLETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showTab(id, btn) {
  document.querySelectorAll('.tab-section').forEach(function(s){ s.classList.remove('active'); });
  document.querySelectorAll('.tnav').forEach(function(b){ b.classList.remove('active'); });
  var sec = document.getElementById('tab-'+id);
  if(sec) sec.classList.add('active');
  if(btn) btn.classList.add('active');
}
window.showTab = showTab;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function changeYear() {
  var v = prompt('AnnÃ©e Ã  afficher :', _year);
  var n = parseInt(v)||0;
  if (n>=2020 && n<=2030) {
    _year = n;
    document.getElementById('year-lbl').textContent = _year;
    document.getElementById('accueil-annee-lbl').textContent = 'â€” '+_year;
    document.getElementById('conges-annee-lbl').textContent = 'â€” '+_year;
    calcSoldes(); renderSoldesFlottants(); renderAccueil(); renderSoldesDetail(); renderDemandes();
  }
}
window.changeYear = changeYear;

function prevM() {
  _calMonth.setMonth(_calMonth.getMonth()-1);
  loadPlanningMonth(_calMonth.getFullYear(), _calMonth.getMonth()).then(renderCal);
}
function nextM() {
  _calMonth.setMonth(_calMonth.getMonth()+1);
  loadPlanningMonth(_calMonth.getFullYear(), _calMonth.getMonth()).then(renderCal);
}
window.prevM = prevM; window.nextM = nextM;

function fmtDate(s) {
  if(!s) return 'â€”';
  try { return new Date(s+'T12:00:00').toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric'}); } catch(e){ return s; }
}

function calcAnciennete(dateStr) {
  if(!dateStr) return '';
  var d = new Date(dateStr+'T12:00:00');
  var now = new Date();
  var mois = (now.getFullYear()-d.getFullYear())*12 + (now.getMonth()-d.getMonth());
  if(mois<1) return 'Nouveau';
  if(mois<12) return mois+' mois';
  var ans = Math.floor(mois/12);
  var rm = mois%12;
  return ans+'an'+(ans>1?'s':'')+(rm>0?' '+rm+'m':'');
}

function maskIban(iban) {
  if(!iban || iban.length<8) return iban;
  return iban.slice(0,4) + ' **** **** ' + iban.slice(-4);
}

function capitalize(s) { return s ? s.charAt(0).toUpperCase()+s.slice(1) : s; }

function getPlagesStr(it) {
  if (!it) return '';
  if (it.plages && it.plages.length > 0) return it.plages.map(function(p){ return p.deb+'â€“'+p.fin; }).join(' | ');
  return (it.deb||'') + (it.fin ? 'â€“'+it.fin : '');
}

function itemH(it) {
  if (it.plages && it.plages.length > 0) {
    return it.plages.reduce(function(s,p) {
      if (!p.deb||!p.fin) return s;
      var a=p.deb.split(':').map(Number), b=p.fin.split(':').map(Number);
      return s + Math.max(0, ((b[0]*60+b[1])-(a[0]*60+a[1]))/60);
    }, 0);
  }
  if (!it.deb||!it.fin) return 0;
  var a=it.deb.split(':').map(Number), b=it.fin.split(':').map(Number);
  return Math.max(0, ((b[0]*60+b[1])-(a[0]*60+a[1]))/60);
}

function showNotFound() {
  document.getElementById('loading-wrap').style.display = 'none';
  document.getElementById('not-found').classList.add('show');
}

function showToast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show '+(type||'');
  setTimeout(function() { t.className='toast'; }, 3200);
}
</script>
</body>
</html>
