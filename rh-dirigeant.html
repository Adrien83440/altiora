<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <title>ALTEORE ‚Äî R√©mun√©ration dirigeant</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --rh-dark:#052e16;--rh-main:#059669;--rh-light:#10b981;--rh-bright:#34d399;
      --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f0fdf7;--radius:12px;
      --red:#ef4444;--orange:#f59e0b;--blue:#1a3dce;--purple:#6366f1;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}
    .main{margin-left:250px;flex:1;display:flex;flex-direction:column;min-width:0;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:17px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .topbar-left p{font-size:12px;color:var(--muted);margin-top:2px;}
    .topbar-right{display:flex;align-items:center;gap:10px;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;display:flex;align-items:center;gap:6px;}
    .btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-light));color:white;box-shadow:0 3px 10px rgba(5,150,105,.3);}
    .btn-rh:hover{opacity:.9;transform:translateY(-1px);}
    .btn-outline{background:white;color:var(--rh-main);border:1.5px solid var(--rh-border);}
    .btn-outline:hover{background:var(--rh-ghost);}
    .btn-sm{padding:6px 12px;font-size:12px;}

    .content{padding:22px 28px;flex:1;display:flex;flex-direction:column;gap:20px;}

    /* DISCLAIMER */
    .disclaimer{background:#fef3c7;border:1px solid #fcd34d;border-radius:10px;padding:12px 16px;display:flex;align-items:flex-start;gap:10px;font-size:12px;color:#92400e;line-height:1.6;}

    /* STATUS SELECTOR */
    .statut-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
    .statut-btn{background:white;border:2px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;text-align:center;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
    .statut-btn:hover{border-color:var(--rh-main);background:var(--rh-ghost);}
    .statut-btn.active{border-color:var(--rh-main);background:var(--rh-ghost);box-shadow:0 0 0 3px rgba(5,150,105,.15);}
    .statut-icon{font-size:24px;margin-bottom:6px;}
    .statut-label{font-size:12px;font-weight:700;color:var(--text);}
    .statut-sub{font-size:10px;color:var(--muted);margin-top:3px;line-height:1.4;}

    /* CARD */
    .card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .card-head{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
    .card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .card-body{padding:20px;}

    /* GRID SAISIE */
    .saisie-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
    .field{display:flex;flex-direction:column;gap:5px;}
    .field label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;}
    .field-wrap{display:flex;align-items:center;gap:6px;padding:10px 12px;background:#f8faff;border:1.5px solid var(--border);border-radius:8px;transition:border-color .15s;}
    .field-wrap:focus-within{border-color:var(--rh-main);background:white;box-shadow:0 0 0 3px rgba(5,150,105,.08);}
    .field-wrap input{flex:1;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;font-weight:700;color:var(--text);outline:none;min-width:0;}
    .field-wrap input::placeholder{color:#cbd5e1;font-weight:400;}
    .field-unit{font-size:12px;font-weight:600;color:var(--muted);flex-shrink:0;}
    .field-hint{font-size:10px;color:var(--muted);margin-top:2px;}
    .field-readonly .field-wrap{background:#f1f5f9;}
    .field-readonly input{color:var(--muted);}

    /* KPI ROW */
    .kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
    .kpi-box{background:white;border:1px solid var(--border);border-radius:10px;padding:16px;position:relative;overflow:hidden;}
    .kpi-box::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
    .kpi-box.green::before{background:linear-gradient(90deg,var(--rh-main),var(--rh-bright));}
    .kpi-box.orange::before{background:linear-gradient(90deg,var(--orange),#fbbf24);}
    .kpi-box.red::before{background:linear-gradient(90deg,var(--red),#f87171);}
    .kpi-box.blue::before{background:linear-gradient(90deg,var(--blue),#4f7ef8);}
    .kpi-box.purple::before{background:linear-gradient(90deg,var(--purple),#a5b4fc);}
    .kpi-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
    .kpi-val{font-size:19px;font-weight:800;color:var(--text);}
    .kpi-val.green{color:var(--rh-main);}
    .kpi-val.orange{color:var(--orange);}
    .kpi-val.red{color:var(--red);}
    .kpi-val.blue{color:var(--blue);}
    .kpi-sub{font-size:10px;color:var(--muted);margin-top:3px;}

    /* D√âCOMPOSITION */
    .decomp-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}

    /* TABLE COTISATIONS */
    .cot-table{width:100%;border-collapse:collapse;font-size:12px;}
    .cot-table thead th{padding:8px 12px;background:#f8faff;border-bottom:1px solid var(--border);font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;}
    .cot-table thead th:not(:first-child){text-align:right;}
    .cot-table tbody td{padding:8px 12px;border-bottom:1px solid #f1f5f9;}
    .cot-table tbody td:not(:first-child){text-align:right;font-weight:600;}
    .cot-cat{font-size:10px;font-weight:700;color:var(--muted);background:#fafbff;padding:6px 12px;text-transform:uppercase;letter-spacing:.5px;}
    .cot-table tfoot td{padding:9px 12px;border-top:2px solid var(--border);font-weight:800;}
    .cot-table tfoot td:not(:first-child){text-align:right;}

    /* BARRE VISUELLE */
    .viz-bar{height:32px;border-radius:8px;overflow:hidden;display:flex;margin-top:10px;}
    .viz-seg{display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:white;transition:width .5s ease;overflow:hidden;white-space:nowrap;min-width:0;}
    .viz-legend{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
    .leg-item{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted);}
    .leg-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}

    /* NET √Ä POCHE */
    .net-banner{background:linear-gradient(135deg,var(--rh-dark),#064e3b);border-radius:14px;padding:24px 28px;color:white;display:flex;align-items:center;justify-content:space-between;gap:20px;}
    .net-banner-left{flex:1;}
    .net-banner-title{font-size:12px;font-weight:600;color:rgba(255,255,255,.6);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;}
    .net-banner-val{font-size:36px;font-weight:800;line-height:1;}
    .net-banner-sub{font-size:11px;color:rgba(255,255,255,.5);margin-top:6px;}
    .net-banner-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;}
    .net-stat{text-align:center;padding:14px;background:rgba(255,255,255,.08);border-radius:10px;}
    .net-stat-label{font-size:10px;color:rgba(255,255,255,.4);text-transform:uppercase;font-weight:600;margin-bottom:4px;}
    .net-stat-val{font-size:16px;font-weight:800;}
    .net-stat-val.green{color:#34d399;}
    .net-stat-val.orange{color:#fbbf24;}
    .net-stat-val.red{color:#f87171;}

    /* COMPARAISON */
    .comp-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f1f5f9;}
    .comp-row:last-child{border-bottom:none;}
    .comp-label{font-size:12px;color:var(--text);}
    .comp-val{font-size:12px;font-weight:700;}

    /* CHART */
    .chart-wrap{position:relative;height:220px;}

    /* TOGGLE REMUN√âRATION */
    .rem-toggle{display:flex;gap:6px;margin-bottom:16px;}
    .rem-tab{padding:7px 16px;border-radius:8px;border:1.5px solid var(--border);background:white;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;color:var(--muted);transition:all .15s;}
    .rem-tab.active{border-color:var(--rh-main);background:var(--rh-ghost);color:var(--rh-main);}

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.ok{background:var(--rh-main);}
    .toast.err{background:var(--red);}

    /* HAMBURGER */
    .hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:var(--rh-main);border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(5,150,105,.45);}
    .hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;}
    .nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;}
    .nav-overlay.show{display:block;}

    /* EMPTY / PLACEHOLDER */
    .placeholder{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;text-align:center;color:var(--muted);padding:40px;}
    .placeholder-icon{font-size:48px;margin-bottom:12px;}

    /* RESPONSIVE */
    @media(max-width:768px){
      .hamburger{display:flex!important;}
      .main{margin-left:0!important;width:100vw!important;}
      .topbar{padding:10px 10px 10px 62px!important;}
      .content{padding:12px 10px!important;}
      .statut-grid{grid-template-columns:1fr 1fr!important;gap:8px!important;}
      .saisie-grid{grid-template-columns:1fr!important;}
      .kpi-row{grid-template-columns:1fr 1fr!important;gap:8px!important;}
      .decomp-grid{grid-template-columns:1fr!important;}
      .net-banner{flex-direction:column!important;}
      .net-banner-stats{grid-template-columns:1fr!important;}
      input,select{font-size:16px!important;}
    }
    @media(max-width:420px){
      .statut-grid{grid-template-columns:1fr!important;}
      .kpi-row{grid-template-columns:1fr!important;}
    }
  </style>
</head>
<body>

<button class="hamburger" id="hamburger" onclick="toggleMobileNav()" aria-label="Menu">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="navOverlay" onclick="toggleMobileNav()"></div>

<div class="main">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-left">
      <h1>üëî R√©mun√©ration dirigeant</h1>
      <p>Calcul du co√ªt r√©el pour l'entreprise selon votre statut juridique</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="window.location.href='rh-paie.html'">üí∂ Paie salari√©s</button>
      <button class="btn btn-rh btn-sm" onclick="saveDirigeant()">üíæ Sauvegarder</button>
    </div>
  </div>

  <div class="content">

    <!-- DISCLAIMER -->
    <div class="disclaimer">
      <span style="font-size:18px;flex-shrink:0">‚ö†Ô∏è</span>
      <span><strong>Outil de simulation uniquement.</strong> Les calculs sont bas√©s sur les taux et r√®gles en vigueur en 2025 (taux TNS URSSAF, charges IS/IR selon le r√©gime). Ils ne tiennent pas compte de votre situation fiscale personnelle, d'√©ventuels optimisations ou abattements sp√©cifiques. Consultez votre expert-comptable pour une analyse personnalis√©e.</span>
    </div>

    <!-- CHOIX STATUT -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">üè¢ Votre statut juridique</div>
      </div>
      <div class="card-body">
        <div class="statut-grid" id="statutGrid">
          <button class="statut-btn active" data-statut="sarl-gerant-maj" onclick="setStatut(this)">
            <div class="statut-icon">üè¢</div>
            <div class="statut-label">SARL / EURL</div>
            <div class="statut-sub">G√©rant majoritaire<br><span style="color:var(--rh-main);font-weight:700">TNS</span></div>
          </button>
          <button class="statut-btn" data-statut="sarl-gerant-min" onclick="setStatut(this)">
            <div class="statut-icon">ü§ù</div>
            <div class="statut-label">SARL / SELARL</div>
            <div class="statut-sub">G√©rant minoritaire<br><span style="color:var(--orange);font-weight:700">Assimil√© salari√©</span></div>
          </button>
          <button class="statut-btn" data-statut="sas-president" onclick="setStatut(this)">
            <div class="statut-icon">üöÄ</div>
            <div class="statut-label">SAS / SASU</div>
            <div class="statut-sub">Pr√©sident<br><span style="color:var(--orange);font-weight:700">Assimil√© salari√©</span></div>
          </button>
          <button class="statut-btn" data-statut="ei-micro" onclick="setStatut(this)">
            <div class="statut-icon">üë§</div>
            <div class="statut-label">EI / Auto-entrepreneur</div>
            <div class="statut-sub">Entrepreneur individuel<br><span style="color:var(--blue);font-weight:700">TNS simplifi√©</span></div>
          </button>
        </div>

        <!-- INFO STATUT -->
        <div id="statutInfo" style="margin-top:14px;padding:12px 16px;background:#f0fdf4;border:1px solid var(--rh-border);border-radius:10px;font-size:12px;color:var(--rh-dark);line-height:1.7;">
          <strong>G√©rant majoritaire SARL (TNS)</strong> ‚Äî Rattach√© √† la S√©curit√© Sociale des Ind√©pendants (SSI). Cotisations calcul√©es sur la r√©mun√©ration nette. Taux global ~45% sur le revenu net (maladie, retraite, pr√©voyance, allocations familiales, formation). Possibilit√© de se verser des dividendes (partiellement soumis aux cotisations si > 10% capital).
        </div>
      </div>
    </div>

    <!-- SAISIE R√âMUN√âRATION -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">üí∞ Saisie de la r√©mun√©ration</div>
        <div class="rem-toggle">
          <button class="rem-tab active" id="tab-mensuel" onclick="setFreq('mensuel')">Mensuel</button>
          <button class="rem-tab" id="tab-annuel" onclick="setFreq('annuel')">Annuel</button>
        </div>
      </div>
      <div class="card-body">
        <div class="saisie-grid">
          <div class="field">
            <label>R√©mun√©ration nette souhait√©e</label>
            <div class="field-wrap">
              <input type="text" inputmode="decimal" id="inp-net" placeholder="3 000" oninput="onNetInput(this.value)"/>
              <span class="field-unit" id="unit-net">‚Ç¨/mois</span>
            </div>
            <div class="field-hint">Ce que vous percevez r√©ellement</div>
          </div>
          <div class="field">
            <label>‚Äî ou ‚Äî R√©mun√©ration brute</label>
            <div class="field-wrap">
              <input type="text" inputmode="decimal" id="inp-brut" placeholder="4 350" oninput="onBrutInput(this.value)"/>
              <span class="field-unit" id="unit-brut">‚Ç¨/mois</span>
            </div>
            <div class="field-hint">Avant cotisations sociales</div>
          </div>
          <div class="field">
            <label>Dividendes envisag√©s</label>
            <div class="field-wrap">
              <input type="text" inputmode="decimal" id="inp-div" placeholder="0" oninput="calc()"/>
              <span class="field-unit">‚Ç¨/mois</span>
            </div>
            <div class="field-hint">PFU 30% ou bar√®me IR</div>
          </div>
        </div>
        <div class="saisie-grid" style="margin-top:12px">
          <div class="field">
            <label>R√©sultat net entreprise</label>
            <div class="field-wrap">
              <input type="text" inputmode="decimal" id="inp-resultat" placeholder="50 000" oninput="calc()"/>
              <span class="field-unit">‚Ç¨/an</span>
            </div>
            <div class="field-hint">Pour calculer IS et capacit√© dividendes</div>
          </div>
          <div class="field">
            <label>Taux d'imposition (IR estim√©)</label>
            <div class="field-wrap">
              <input type="text" inputmode="decimal" id="inp-ir" placeholder="30" oninput="calc()"/>
              <span class="field-unit">%</span>
            </div>
            <div class="field-hint" id="ir-hint">Tranche marginale estim√©e</div>
          </div>
          <div class="field">
            <label>Anciennet√© dirigeant</label>
            <div class="field-wrap">
              <input type="text" inputmode="decimal" id="inp-anciennete" placeholder="0" oninput="calc()"/>
              <span class="field-unit">ans</span>
            </div>
            <div class="field-hint">Taux r√©duit 1re ann√©e TNS</div>
          </div>
        </div>
      </div>
    </div>

    <!-- R√âSULTATS KPI -->
    <div class="kpi-row" id="kpiRow">
      <div class="kpi-box green">
        <div class="kpi-lbl">Net √† poche / mois</div>
        <div class="kpi-val green" id="kpi-net">‚Äî</div>
        <div class="kpi-sub">Apr√®s cotisations</div>
      </div>
      <div class="kpi-box orange">
        <div class="kpi-lbl">Cotisations sociales</div>
        <div class="kpi-val orange" id="kpi-cot">‚Äî</div>
        <div class="kpi-sub" id="kpi-cot-sub">~45% brut (TNS)</div>
      </div>
      <div class="kpi-box red">
        <div class="kpi-lbl">Co√ªt total entreprise</div>
        <div class="kpi-val red" id="kpi-cout">‚Äî</div>
        <div class="kpi-sub">R√©mun√©ration + charges pat.</div>
      </div>
      <div class="kpi-box blue">
        <div class="kpi-lbl">IR estim√© / mois</div>
        <div class="kpi-val blue" id="kpi-ir">‚Äî</div>
        <div class="kpi-sub">Pr√©l√®vement √† la source</div>
      </div>
      <div class="kpi-box purple">
        <div class="kpi-lbl">Net r√©el apr√®s IR</div>
        <div class="kpi-val" id="kpi-net-ir">‚Äî</div>
        <div class="kpi-sub">Net ‚àí IR mensuel estim√©</div>
      </div>
    </div>

    <!-- NET BANNER -->
    <div class="net-banner" id="netBanner" style="display:none">
      <div class="net-banner-left">
        <div class="net-banner-title">üí∂ Synth√®se dirigeant</div>
        <div class="net-banner-val" id="banner-net">‚Äî</div>
        <div class="net-banner-sub" id="banner-statut">Net mensuel estim√© ¬∑ Statut : ‚Äî</div>
      </div>
      <div class="net-banner-stats">
        <div class="net-stat">
          <div class="net-stat-label">Co√ªt entreprise/an</div>
          <div class="net-stat-val orange" id="banner-cout-an">‚Äî</div>
        </div>
        <div class="net-stat">
          <div class="net-stat-label">Net annuel (avant IR)</div>
          <div class="net-stat-val green" id="banner-net-an">‚Äî</div>
        </div>
        <div class="net-stat">
          <div class="net-stat-label">Ratio net / co√ªt</div>
          <div class="net-stat-val" id="banner-ratio">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- D√âCOMPOSITION -->
    <div class="decomp-grid" id="decompSection" style="display:none">

      <!-- COTISATIONS DETAIL -->
      <div class="card">
        <div class="card-head">
          <div class="card-title">üìä D√©tail des cotisations sociales 2025</div>
        </div>
        <div class="card-body" style="padding:0">
          <table class="cot-table" id="cotTable">
            <thead><tr><th style="text-align:left">Cotisation</th><th>Base</th><th>Taux</th><th>Montant</th></tr></thead>
            <tbody id="cotBody"></tbody>
            <tfoot id="cotFoot"></tfoot>
          </table>
        </div>
      </div>

      <!-- GRAPHIQUE + BARRE -->
      <div class="card">
        <div class="card-head">
          <div class="card-title">üéØ R√©partition du co√ªt total</div>
        </div>
        <div class="card-body">
          <div class="chart-wrap"><canvas id="chartDirigeant"></canvas></div>

          <div style="margin-top:16px;">
            <div style="font-size:11px;color:var(--muted);margin-bottom:6px">D√©composition visuelle</div>
            <div class="viz-bar" id="vizBar"></div>
            <div class="viz-legend" id="vizLegend"></div>
          </div>

          <!-- COMPARAISON TNS vs Assimil√© salari√© -->
          <div id="compSection" style="margin-top:20px;display:none">
            <div style="font-size:12px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px">üîÑ Comparaison statuts <span style="font-size:10px;color:var(--muted);font-weight:400">(pour m√™me r√©mun√©ration brute)</span></div>
            <div id="compRows"></div>
          </div>
        </div>
      </div>

    </div>

    <!-- DIVIDENDES -->
    <div class="card" id="divCard" style="display:none">
      <div class="card-head">
        <div class="card-title">üìà Analyse dividendes</div>
      </div>
      <div class="card-body">
        <div id="divContent"></div>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth = getAuth(app), db = getFirestore(app);
  window._auth = auth; window._db = db;
  window._doc = doc; window._setDoc = setDoc; window._getDoc = getDoc;
  window._signOut = signOut;
  onAuthStateChanged(auth, function(user) {
    if (!user) { window.location.href = 'index.html'; return; }
    window._uid = user.uid;
    window.initDirigeant();
  });
</script>

<script>
// ‚ïê‚ïê DONN√âES STATUTS ‚ïê‚ïê
const STATUTS = {
  'sarl-gerant-maj': {
    label: 'G√©rant majoritaire SARL (TNS)',
    regime: 'tns',
    info: 'Rattach√© √† la S√©curit√© Sociale des Ind√©pendants (SSI). Cotisations sur r√©mun√©ration nette. Taux global ~45%. Dividendes > 10% capital soumis aux cotisations.',
    // Taux TNS 2025 (sur revenu net)
    cotisations: [
      { cat:'SANT√â', label:'Maladie-maternit√© (6,50%)', base:'net', taux:0.065 },
      { cat:'SANT√â', label:'Indemnit√©s journali√®res (0,85%)', base:'net', taux:0.0085 },
      { cat:'RETRAITE', label:'Retraite de base (17,75% j. + 0,60% d.)', base:'net', taux:0.1835, plaf:'annuel' },
      { cat:'RETRAITE', label:'Retraite compl√©mentaire (7,00%)', base:'net', taux:0.07 },
      { cat:'PR√âVOYANCE', label:'Invalidit√©-d√©c√®s (1,30%)', base:'net', taux:0.013 },
      { cat:'FAMILLE', label:'Allocations familiales (3,10%)', base:'net', taux:0.031 },
      { cat:'FORMATION', label:'Formation professionnelle (0,25%)', base:'PMSS', taux:0.0025, fixe:true },
      { cat:'RETRAITE', label:'CSG/CRDS (9,70% √ó 98,25%)', base:'net', taux:0.09533 },
    ],
    // Cotisations patronales (assimil√© salari√© = 0 pour TNS)
    patronales: [],
    note: '‚ö†Ô∏è Cotisations minimales dues m√™me sans r√©mun√©ration (~1 200 ‚Ç¨/an). Taux r√©duit la 1re ann√©e (ACRE).'
  },
  'sarl-gerant-min': {
    label: 'G√©rant minoritaire SARL (Assimil√© salari√©)',
    regime: 'salarie',
    info: 'Assimil√© salari√© : rattach√© au r√©gime g√©n√©ral. Cotisations salariales + patronales comme un salari√©. Pas de couverture ch√¥mage. Cotisations plus √©lev√©es mais meilleures prestations retraite.',
    cotisations: [], // calcul√© via calcCotisations standard
    patronales: [],
    note: 'üí° Charges totales ~75-80% du salaire brut (salariales + patronales).'
  },
  'sas-president': {
    label: 'Pr√©sident SAS/SASU (Assimil√© salari√©)',
    regime: 'salarie',
    info: 'Assimil√© salari√© : r√©gime g√©n√©ral. M√™mes r√®gles que le g√©rant minoritaire. Pas de couverture ch√¥mage mais retraite avantageuse. R√©mun√©ration souvent compl√©t√©e par dividendes (PFU 30%).',
    cotisations: [],
    patronales: [],
    note: 'üí° Structure SAS flexible : dividendes non soumis aux cotisations (sauf si SASU avec r√©mun√©ration 0).'
  },
  'ei-micro': {
    label: 'EI / Auto-entrepreneur',
    regime: 'micro',
    info: 'R√©gime microsocial : cotisations calcul√©es sur le CA (pas le b√©n√©fice). Taux fixes selon activit√©. Simple mais moins protecteur pour la retraite.',
    cotisations: [
      { cat:'GLOBAL', label:'Prestations de services (21,20%)', base:'ca', taux:0.212 },
      { cat:'GLOBAL', label:'Vente de marchandises (12,30%)', base:'ca', taux:0.123 },
      { cat:'GLOBAL', label:'Professions lib√©rales (21,20%)', base:'ca', taux:0.212 },
    ],
    patronales: [],
    note: '‚ö†Ô∏è Pas de d√©duction de charges r√©elles. Plafonds CA : 77 700 ‚Ç¨ (services) / 188 700 ‚Ç¨ (ventes).'
  }
};

// ‚îÄ‚îÄ Constantes 2025 ‚îÄ‚îÄ
const PMSS   = 3925;           // PMSS mensuel 2025
const PMSS_A = PMSS * 12;      // PMSS annuel = 47 100‚Ç¨
const PASS   = PMSS_A;         // PASS 2025 = PMSS_A = 47 100‚Ç¨
const SMIC_A = 11.88*35*52;    // SMIC annuel ‚âà 21 622‚Ç¨
const SMIC_M = SMIC_A / 12;    // SMIC mensuel ‚âà 1 802‚Ç¨

// ‚ïê‚ïê STATE ‚ïê‚ïê
var _statut    = 'sarl-gerant-maj';
var _freq      = 'mensuel';
var _brutMens  = 0;
var _netMens   = 0;
var _divMens   = 0;
var _resultat  = 0;
var _tauxIR    = 30;
var _chart     = null;

function fmtE(n, decimals) {
  var d = decimals !== undefined ? decimals : 0;
  return (parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:d,maximumFractionDigits:d})+' ‚Ç¨';
}
function pct(n) { return (parseFloat(n)||0).toFixed(1)+'%'; }
function parseF(v) { return parseFloat((v||'').toString().replace(/\s/g,'').replace(',','.')) || 0; }

// ‚ïê‚ïê INIT ‚ïê‚ïê
window.initDirigeant = async function() {
  await loadSaved();
  calc();
};

async function loadSaved() {
  try {
    var snap = await window._getDoc(window._doc(window._db, 'rh_params', window._uid + '_dirigeant'));
    if (snap.exists()) {
      var d = snap.data();
      _statut   = d.statut || 'sarl-gerant-maj';
      _brutMens = d.brutMens || 0;
      _netMens  = d.netMens  || 0;
      _divMens  = d.divMens  || 0;
      _resultat = d.resultat || 0;
      _tauxIR   = d.tauxIR   || 30;
      _freq     = d.freq     || 'mensuel';

      // Remplir les champs
      if (_brutMens > 0) document.getElementById('inp-brut').value = fmtN(_brutMens);
      if (_netMens  > 0) document.getElementById('inp-net').value  = fmtN(_netMens);
      if (_divMens  > 0) document.getElementById('inp-div').value  = fmtN(_divMens);
      if (_resultat > 0) document.getElementById('inp-resultat').value = fmtN(_resultat);
      document.getElementById('inp-ir').value = _tauxIR;

      // Activer le bon statut
      document.querySelectorAll('.statut-btn').forEach(function(b) {
        b.classList.toggle('active', b.dataset.statut === _statut);
      });
      updateStatutInfo();
      setFreq(_freq);
    }
  } catch(e) { console.warn('loadSaved:', e); }
}

function fmtN(n) { return (parseFloat(n)||0).toFixed(2).replace('.',','); }

// ‚ïê‚ïê STATUT ‚ïê‚ïê
function setStatut(btn) {
  _statut = btn.dataset.statut;
  document.querySelectorAll('.statut-btn').forEach(function(b){ b.classList.remove('active'); });
  btn.classList.add('active');
  updateStatutInfo();
  calc();
}
window.setStatut = setStatut;

function updateStatutInfo() {
  var s = STATUTS[_statut];
  document.getElementById('statutInfo').innerHTML = '<strong>'+s.label+'</strong> ‚Äî '+s.info;
}

// ‚ïê‚ïê FR√âQUENCE ‚ïê‚ïê
function setFreq(freq) {
  _freq = freq;
  ['mensuel','annuel'].forEach(function(f) {
    document.getElementById('tab-'+f).classList.toggle('active', f===freq);
  });
  var suffix = freq === 'mensuel' ? '‚Ç¨/mois' : '‚Ç¨/an';
  document.getElementById('unit-net').textContent  = suffix;
  document.getElementById('unit-brut').textContent = suffix;
}
window.setFreq = setFreq;

// ‚ïê‚ïê INPUTS ‚ïê‚ïê
function onNetInput(val) {
  var net = parseF(val);
  if (_freq === 'annuel') net = net / 12;
  _netMens = net;
  _brutMens = 0; // r√©initialiser l'autre
  document.getElementById('inp-brut').value = '';
  calc();
}
function onBrutInput(val) {
  var brut = parseF(val);
  if (_freq === 'annuel') brut = brut / 12;
  _brutMens = brut;
  _netMens = 0;
  document.getElementById('inp-net').value = '';
  calc();
}
window.onNetInput = onNetInput;
window.onBrutInput = onBrutInput;

// ‚ïê‚ïê BAR√àME IR 2025 (revenu net imposable annuel ‚Üí taux moyen) ‚ïê‚ïê
function calcIR(revenuNetImposable) {
  // Bar√®me progressif 2025 (1 part)
  // 0‚Ç¨ ‚Üí 11 294‚Ç¨      : 0%
  // 11 294‚Ç¨ ‚Üí 28 797‚Ç¨ : 11%
  // 28 797‚Ç¨ ‚Üí 82 341‚Ç¨ : 30%
  // 82 341‚Ç¨ ‚Üí 177 106‚Ç¨: 41%
  // > 177 106‚Ç¨        : 45%
  var rni = Math.max(0, revenuNetImposable);
  var impot = 0;
  if (rni > 177106) { impot += (rni - 177106) * 0.45; rni = 177106; }
  if (rni > 82341)  { impot += (rni - 82341)  * 0.41; rni = 82341;  }
  if (rni > 28797)  { impot += (rni - 28797)  * 0.30; rni = 28797;  }
  if (rni > 11294)  { impot += (rni - 11294)  * 0.11; rni = 11294;  }
  return Math.max(0, impot);
}

function getTauxMoyen(revenuNetImposable) {
  var rni = Math.max(0, revenuNetImposable);
  if (rni === 0) return 0;
  // Abattement 10% plafonn√© 14 171‚Ç¨ min 495‚Ç¨
  var abat = Math.min(Math.max(rni * 0.10, 495), 14171);
  var rniNet = rni - abat;
  var impot = calcIR(rniNet);
  return Math.min(impot / rni * 100, 45);
}

// ‚ïê‚ïê CALCUL PRINCIPAL ‚ïê‚ïê
function calc() {
  var s = STATUTS[_statut];

  // Lire valeurs
  var netInput  = parseF(document.getElementById('inp-net').value);
  var brutInput = parseF(document.getElementById('inp-brut').value);
  var divMens   = parseF(document.getElementById('inp-div').value);
  var resultat  = parseF(document.getElementById('inp-resultat').value);
  // IR : si champ rempli par l'utilisateur on l'utilise, sinon on calcule auto
  var irSaisi   = parseF(document.getElementById('inp-ir').value);

  if (_freq === 'annuel') { netInput /= 12; brutInput /= 12; divMens /= 12; }

  var brut = brutInput > 0 ? brutInput : 0;
  var net  = netInput  > 0 ? netInput  : 0;

  // ‚îÄ‚îÄ Si dividendes seuls (sans r√©mun√©ration) : mode dividende-only ‚îÄ‚îÄ
  var divOnly = (brut === 0 && net === 0 && divMens > 0);

  if (brut === 0 && net === 0 && divMens === 0 && resultat === 0) {
    hideResults(); return;
  }

  // ‚îÄ‚îÄ Calcul cotisations (seulement si r√©mun√©ration saisie) ‚îÄ‚îÄ
  var result = { regime: s.regime, brut: 0, net: 0, cotisations: 0, chargesPat: 0, cotDetail: [], coutEntreprise: 0 };
  if (!divOnly) {
    if (s.regime === 'tns')     result = calcTNS(brut, net, s);
    else if (s.regime === 'salarie') result = calcAssimileSalarie(brut, net);
    else if (s.regime === 'micro')   result = calcMicro(brut, net);
  }

  // ‚îÄ‚îÄ IR auto via bar√®me 2025 ‚îÄ‚îÄ
  // Revenu imposable = r√©mun√©ration nette + dividendes (PFU optionnel ‚Üí bar√®me)
  // Pour TNS : cotisations d√©ductibles ‚Üí base = net
  // Pour assimil√© salari√© : abattement 10% d√©j√† int√©gr√© dans bar√®me
  var remunNette = result.net || 0;
  var divBrut = divMens * 12; // annuel
  var revenuBrut_an = remunNette * 12 + divBrut; // total annuel brut
  var tauxAutoCalc = getTauxMoyen(revenuBrut_an);
  var tauxIR = irSaisi > 0 ? irSaisi : Math.round(tauxAutoCalc * 10) / 10;

  // Mettre √† jour le champ IR si calcul√© automatiquement
  if (irSaisi === 0) {
    var irField = document.getElementById('inp-ir');
    if (irField && irField !== document.activeElement) {
      irField.value = tauxIR.toFixed(1);
      irField.placeholder = tauxIR.toFixed(1);
    }
    // Indicateur visuel "calcul√© auto"
    var irHint = document.getElementById('ir-hint');
    if (irHint) irHint.textContent = '‚ú® Calcul√© automatiquement (bar√®me 2025, 1 part)';
  } else {
    var irHint = document.getElementById('ir-hint');
    if (irHint) irHint.textContent = 'Tranche marginale estim√©e';
  }

  // ‚îÄ‚îÄ Calculs finaux ‚îÄ‚îÄ
  var divPFU  = divMens * 0.30; // flat tax 30%
  var divNet  = divMens - divPFU;
  var irMens  = (remunNette * 12 * tauxIR / 100) / 12;
  var irDivMens = divMens * 0.128; // part IR du PFU (12,8%)
  var netApresIR = remunNette - irMens;
  var coutTotal = result.coutEntreprise;

  // ‚îÄ‚îÄ Affichage KPIs ‚îÄ‚îÄ
  var set = function(id, v) { var el = document.getElementById(id); if (el) el.textContent = v; };
  set('kpi-net',        divOnly ? (divNet > 0 ? fmtE(divNet, 0) : '‚Äî') : fmtE(remunNette, 0));
  set('kpi-cot',        fmtE(result.cotisations, 0));
  set('kpi-cot-sub',    pct(result.cotisations / (result.brut||1) * 100)+' du brut');
  set('kpi-cout',       divOnly ? '‚Äî' : fmtE(coutTotal, 0));
  set('kpi-ir',         '~'+fmtE(irMens, 0)+'/mois');
  set('kpi-net-ir',     fmtE(netApresIR, 0));

  // ‚îÄ‚îÄ Banner ‚îÄ‚îÄ
  document.getElementById('netBanner').style.display = '';
  if (divOnly) {
    set('banner-net',    fmtE(divNet, 0)+'/mois (net PFU)');
    set('banner-statut', 'Dividendes nets apr√®s PFU 30% ¬∑ '+s.label);
    set('banner-cout-an','‚Äî');
    set('banner-net-an', fmtE(divNet * 12, 0));
    var ratioBanner = document.getElementById('banner-ratio');
    if (ratioBanner) { ratioBanner.textContent = '70%'; ratioBanner.className = 'net-stat-val orange'; }
  } else {
    set('banner-net',    fmtE(remunNette, 0)+'/mois');
    set('banner-statut', 'Net mensuel estim√© ¬∑ '+s.label);
    set('banner-cout-an',fmtE(coutTotal * 12, 0));
    set('banner-net-an', fmtE(remunNette * 12, 0));
    var ratio = coutTotal > 0 ? (remunNette / coutTotal * 100) : 0;
    var ratioBanner = document.getElementById('banner-ratio');
    if (ratioBanner) { ratioBanner.textContent = pct(ratio); ratioBanner.className = 'net-stat-val '+(ratio>=60?'green':ratio>=45?'orange':'red'); }
  }

  // ‚îÄ‚îÄ D√©composition (seulement si r√©mun√©ration) ‚îÄ‚îÄ
  if (!divOnly) {
    document.getElementById('decompSection').style.display = '';
    renderCotTable(result);
    renderChart(result);
    renderVizBar(result);
    if (result.brut > 0) renderComparaison(result.brut, s.regime);
  } else {
    document.getElementById('decompSection').style.display = 'none';
  }

  // ‚îÄ‚îÄ Dividendes ‚îÄ‚îÄ
  if (divMens > 0 || resultat > 0) renderDivSection(divMens, divNet, resultat, s.regime, tauxIR, tauxAutoCalc);
  else document.getElementById('divCard').style.display = 'none';
}

// ‚ïê‚ïê CALCUL TNS (g√©rant majoriatire SARL, EURL) ‚ïê‚ïê
function calcTNS(brutInput, netInput, s) {
  // TNS : cotisations ‚âà 45% du net (calcul√©es sur net)
  // Si saisie brut ‚Üí it√©rer pour trouver net
  var net, brut;

  if (brutInput > 0) {
    // Brut TNS = Net + cotisations ‚âà Net √ó 1.45
    // On it√®re car cotisations d√©pendent du net
    net = brutInput / 1.45;
    for (var i = 0; i < 10; i++) {
      var cot = calcCotTNS(net);
      net = brutInput - cot.total;
    }
    brut = brutInput;
  } else {
    net  = netInput;
    brut = net + calcCotTNS(net).total;
  }

  var cotDetail = calcCotTNS(net);

  return {
    regime: 'tns',
    brut: brut,
    net:  Math.max(net, 0),
    cotisations: cotDetail.total,
    cotDetail: cotDetail.rows,
    coutEntreprise: brut, // TNS : la r√©mun√©ration est une charge d√©ductible, pas de charges patronales
    chargesPat: 0
  };
}

function calcCotTNS(net) {
  var n = parseFloat(net) || 0;
  var rows = [];
  var total = 0;

  // Taux TNS 2025 ‚Äî Source URSSAF / SSI
  var nAn = n * 12; // revenu annuel pour calculs plafonds
  // Maladie-maternit√© : taux progressif 2025
  var tauxMaladie = nAn <= PASS * 0.5 ? 0.0 : (nAn <= PASS ? 0.0317 : 0.065);
  // Allocations familiales : exo < 110% PASS, r√©duit < 140% PASS, plein sinon
  var tauxAF = nAn <= PASS * 1.10 ? 0.0 : (nAn <= PASS * 1.40 ? 0.0215 : 0.0525);
  var items = [
    { cat:'SANT√â',     label:'Maladie-maternit√© ('+pct(tauxMaladie*100)+')',  base:n,                          taux:tauxMaladie  },
    { cat:'SANT√â',     label:'Indemnit√©s journali√®res (0,85%)',               base:Math.min(n, PMSS*5),         taux:0.0085       },
    { cat:'RETRAITE',  label:'Retraite de base (17,75% plafonn√©)',            base:Math.min(n, PMSS),           taux:0.1775       },
    { cat:'RETRAITE',  label:'Retraite de base d√©plafonn√©e (0,60%)',          base:n,                          taux:0.006        },
    { cat:'RETRAITE',  label:'Retraite compl√©mentaire (7,00%)',               base:Math.min(n*12,PMSS_A*3.66)/12, taux:0.07      },
    { cat:'PR√âVOY.',   label:'Invalidit√©-d√©c√®s (1,30%)',                      base:Math.min(n, PMSS*5),         taux:0.013        },
    { cat:'FAMILLE',   label:'Allocations familiales ('+pct(tauxAF*100)+')', base:n,                          taux:tauxAF       },
    { cat:'FORMATION', label:'Formation professionnelle (0,25%)',             base:PMSS,                       taux:0.0025       },
    { cat:'CSG/CRDS',  label:'CSG d√©ductible (6,80% √ó 98,25%)',              base:n * 0.9825,                  taux:0.068        },
    { cat:'CSG/CRDS',  label:'CSG non d√©ductible + CRDS (2,90% √ó 98,25%)',   base:n * 0.9825,                  taux:0.029        },
  ];

  items.forEach(function(it) {
    var montant = it.base * it.taux;
    total += montant;
    rows.push({ cat:it.cat, label:it.label+(it.note?' ('+it.note+')':''), base:it.base, taux:it.taux*100, montant:montant });
  });

  return { total: Math.round(total*100)/100, rows };
}

// ‚ïê‚ïê CALCUL ASSIMIL√â SALARI√â (SAS, g√©rant minoritaire) ‚ïê‚ïê
function calcAssimileSalarie(brutInput, netInput) {
  // Taux assimil√© salari√© 2025 ‚Äî utilise les constantes globales
  // PMSS = 3925, SMIC_M = 1802

  function cot(brut) {
    var b = brut, assiette_csg = b * 0.9825, plaf1 = Math.min(b, PMSS);
    var sal = 0;
    sal += plaf1 * 0.069;
    sal += b * 0.004;
    sal += assiette_csg * 0.068;
    sal += assiette_csg * 0.024;
    sal += assiette_csg * 0.005;
    sal += plaf1 * 0.0315;
    if (b > PMSS) sal += Math.min(b-PMSS,7*PMSS)*0.0864;
    var pat = 0;
    pat += b * (b <= 2.25*SMIC_M ? 0.07 : 0.13);
    pat += b * 0.015;
    pat += b * (b <= 3.3*SMIC_M ? 0.0345 : 0.0525);
    pat += plaf1 * 0.0855;
    pat += b * 0.0202;
    pat += Math.min(b,4*PMSS)*0.04;
    pat += Math.min(b,4*PMSS)*0.0025;
    pat += b * 0.001;
    pat += plaf1 * 0.0472;
    if (b > PMSS) pat += Math.min(b-PMSS,7*PMSS)*0.1295;
    pat += plaf1 * 0.0129;
    if (b > PMSS) pat += Math.min(b-PMSS,7*PMSS)*0.0216;
    return { sal: Math.round(sal*100)/100, pat: Math.round(pat*100)/100, net: Math.round((b-sal)*100)/100 };
  }

  var brut, net, c;
  if (brutInput > 0) {
    brut = brutInput; c = cot(brut); net = c.net;
  } else {
    // Inverser : it√©rer
    brut = netInput / 0.77;
    for (var i = 0; i < 10; i++) { c = cot(brut); brut = netInput + c.sal; }
    c = cot(brut); net = c.net;
  }

  var rows = [
    { cat:'SALARIALES', label:'Vieillesse (6,90%+0,40%)',  base:brut, taux:7.30, montant:Math.min(brut,PMSS)*0.069+brut*0.004 },
    { cat:'SALARIALES', label:'CSG/CRDS (9,70%√ó98,25%)',  base:brut, taux:9.53, montant:brut*0.9825*0.097 },
    { cat:'SALARIALES', label:'Retraite comp T1 (3,15%)',  base:brut, taux:3.15, montant:Math.min(brut,PMSS)*0.0315 },
    { cat:'PATRONALES', label:'Maladie (7% ou 13%)',        base:brut, taux:brut<=2.25*SMIC_M?7:13, montant:brut*(brut<=2.25*SMIC_M?0.07:0.13) },
    { cat:'PATRONALES', label:'AT/MP (1,50%)',              base:brut, taux:1.50, montant:brut*0.015 },
    { cat:'PATRONALES', label:'Alloc. familiales',          base:brut, taux:brut<=3.3*SMIC_M?3.45:5.25, montant:brut*(brut<=3.3*SMIC_M?0.0345:0.0525) },
    { cat:'PATRONALES', label:'Vieillesse pat. (8,55%+2,02%)', base:brut, taux:10.57, montant:Math.min(brut,PMSS)*0.0855+brut*0.0202 },
    { cat:'PATRONALES', label:'Ch√¥mage (4,00%) + AGS',     base:brut, taux:4.25, montant:Math.min(brut,4*PMSS)*0.0425 },
    { cat:'PATRONALES', label:'Retraite comp T1 (4,72%+1,29%)', base:brut, taux:6.01, montant:Math.min(brut,PMSS)*0.0601 },
  ];

  return {
    regime: 'salarie',
    brut: brut,
    net: net,
    cotisations: c.sal,
    chargesPat: c.pat,
    cotDetail: rows,
    coutEntreprise: brut + c.pat
  };
}

// ‚ïê‚ïê CALCUL MICRO ‚ïê‚ïê
function calcMicro(caInput, netInput) {
  var ca = caInput > 0 ? caInput : (netInput > 0 ? netInput / (1 - 0.212) : 0);
  var taux = 0.212; // services
  var cotisations = ca * taux;
  var net = ca - cotisations;
  var rows = [
    { cat:'GLOBAL', label:'Cotisations forfaitaires (21,20%)', base:ca, taux:21.2, montant:cotisations },
  ];
  return {
    regime: 'micro',
    brut: ca,
    net: net,
    cotisations: cotisations,
    chargesPat: 0,
    cotDetail: rows,
    coutEntreprise: ca
  };
}

// ‚ïê‚ïê RENDER COTISATIONS TABLE ‚ïê‚ïê
function renderCotTable(result) {
  var f2 = function(n){ return (Math.round(n*100)/100).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨'; };
  var lastCat = '';
  var html = result.cotDetail.map(function(r) {
    var catRow = '';
    if (r.cat !== lastCat) {
      catRow = '<tr><td class="cot-cat" colspan="4">'+r.cat+'</td></tr>';
      lastCat = r.cat;
    }
    return catRow + `<tr>
      <td>${r.label}</td>
      <td style="text-align:right;color:var(--muted)">${f2(r.base)}</td>
      <td style="text-align:right;color:var(--muted)">${r.taux.toFixed(2)}%</td>
      <td style="text-align:right;color:var(--red)">‚àí${f2(r.montant)}</td>
    </tr>`;
  }).join('');
  document.getElementById('cotBody').innerHTML = html;

  var brut = result.brut || 0;
  document.getElementById('cotFoot').innerHTML = `
    <tr><td><strong>Total cotisations${result.chargesPat>0?' salariales':''}</strong></td>
        <td></td>
        <td style="text-align:right">${brut>0?pct(result.cotisations/brut*100):''}</td>
        <td style="text-align:right;color:var(--red)"><strong>‚àí${f2(result.cotisations)}</strong></td></tr>
    ${result.chargesPat>0?`<tr><td><strong>Charges patronales</strong></td><td></td><td style="text-align:right">${brut>0?pct(result.chargesPat/brut*100):''}</td><td style="text-align:right;color:var(--orange)"><strong>+${f2(result.chargesPat)}</strong></td></tr>`:''}
    <tr style="background:#f0fdf4"><td><strong>Co√ªt total entreprise</strong></td><td></td><td></td><td style="text-align:right;color:var(--rh-main)"><strong>${f2(result.coutEntreprise)}</strong></td></tr>
    <tr style="background:#f0fdf4"><td><strong>Net dirigeant</strong></td><td></td><td></td><td style="text-align:right;color:var(--rh-main)"><strong>${f2(result.net)}</strong></td></tr>
  `;
}

// ‚ïê‚ïê RENDER CHART ‚ïê‚ïê
function renderChart(result) {
  var ctx = document.getElementById('chartDirigeant');
  if (!ctx) return;
  if (_chart) { try{_chart.destroy();}catch(e){} }

  var data = [
    { label:'Net dirigeant',      val:Math.max(result.net,0),       color:'#059669' },
    { label:'Cotisations sal.',   val:result.cotisations,           color:'#ef4444' },
  ];
  if (result.chargesPat > 0) {
    data.push({ label:'Charges pat.', val:result.chargesPat, color:'#f59e0b' });
  }
  data = data.filter(function(d){ return d.val > 0; });

  _chart = new Chart(ctx, {
    type:'doughnut',
    data:{
      labels: data.map(function(d){ return d.label; }),
      datasets:[{ data:data.map(function(d){ return d.val; }), backgroundColor:data.map(function(d){ return d.color; }), borderWidth:2, borderColor:'white', hoverOffset:6 }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      cutout:'62%',
      plugins:{
        legend:{ display:true, position:'bottom', labels:{ font:{size:11}, padding:12 } },
        tooltip:{ callbacks:{ label:function(c){ return ' '+fmtE(c.raw,0)+' ('+pct(c.raw/result.coutEntreprise*100)+')'; } } }
      }
    }
  });
}

// ‚ïê‚ïê BARRE VISUELLE ‚ïê‚ïê
function renderVizBar(result) {
  var total = result.coutEntreprise;
  if (total <= 0) return;
  var segs = [
    { label:'Net', val:Math.max(result.net,0), color:'#059669' },
    { label:'Cot.', val:result.cotisations, color:'#ef4444' },
  ];
  if (result.chargesPat > 0) segs.push({ label:'Pat.', val:result.chargesPat, color:'#f59e0b' });

  document.getElementById('vizBar').innerHTML = segs.map(function(s){
    var w = (s.val/total*100).toFixed(1);
    return `<div class="viz-seg" style="width:${w}%;background:${s.color}" title="${s.label}: ${fmtE(s.val,0)}">${parseFloat(w)>8?s.label:''}</div>`;
  }).join('');

  document.getElementById('vizLegend').innerHTML = segs.map(function(s){
    return `<div class="leg-item"><div class="leg-dot" style="background:${s.color}"></div>${s.label} : <strong>${fmtE(s.val,0)}</strong> (${pct(s.val/total*100)})</div>`;
  }).join('');
}

// ‚ïê‚ïê COMPARAISON STATUTS ‚ïê‚ïê
function renderComparaison(brut, regimeCurrent) {
  var comp = document.getElementById('compSection');
  comp.style.display = '';

  // Calculer pour TNS et Assimil√© salari√© avec le m√™me brut
  var tns = calcTNS(brut, 0, STATUTS['sarl-gerant-maj']);
  var sal = calcAssimileSalarie(brut, 0);

  var rows = [
    { label:'Brut / CA',         tns:tns.brut,          sal:sal.brut,          better:'equal' },
    { label:'Cotisations',       tns:tns.cotisations,   sal:sal.cotisations,   better:'tns', lower:true },
    { label:'Charges patronales',tns:0,                  sal:sal.chargesPat,    better:'tns', lower:true },
    { label:'Net dirigeant',     tns:tns.net,            sal:sal.net,           better:'compare' },
    { label:'Co√ªt total entr.',  tns:tns.coutEntreprise, sal:sal.coutEntreprise,better:'tns', lower:true },
    { label:'Ratio net/co√ªt',    tns:tns.net/tns.coutEntreprise*100, sal:sal.net/sal.coutEntreprise*100, isPct:true, better:'compare' },
  ];

  document.getElementById('compRows').innerHTML = rows.map(function(r) {
    var tnsGood = r.better==='tns';
    var tnsVal  = r.isPct ? pct(r.tns) : fmtE(r.tns,0);
    var salVal  = r.isPct ? pct(r.sal) : fmtE(r.sal,0);
    var tnsCls  = r.better==='equal'?'':( (r.tns>r.sal) === !r.lower ? 'td-pos' : 'td-neg');
    var salCls  = r.better==='equal'?'':( (r.sal>r.tns) === !r.lower ? 'td-pos' : 'td-neg');
    return `<div class="comp-row">
      <div class="comp-label">${r.label}</div>
      <div style="display:flex;gap:20px">
        <div style="text-align:right;min-width:90px"><span style="font-size:9px;color:var(--muted)">TNS </span><span class="comp-val ${tnsCls}" style="font-size:12px">${tnsVal}</span></div>
        <div style="text-align:right;min-width:90px"><span style="font-size:9px;color:var(--muted)">Ass.sal. </span><span class="comp-val ${salCls}" style="font-size:12px">${salVal}</span></div>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê DIVIDENDES ‚ïê‚ïê
function renderDivSection(divMens, divNet, resultat, regime, tauxIR, tauxAutoCalc) {
  var card = document.getElementById('divCard');
  card.style.display = '';

  var pfuDiv    = divMens * 0.30;          // PFU = IR 12,8% + PS 17,2%
  var netPFU    = divMens - pfuDiv;
  // Option bar√®me : PS 17,2% + IR au taux moyen calcul√©
  var ps        = divMens * 0.172;
  var tMoy      = (tauxAutoCalc || tauxIR) / 100;
  var irBarem   = divMens * tMoy;
  var netBarem  = Math.max(0, divMens - ps - irBarem);
  // Quelle option est plus favorable ?
  var pfuMieux  = netPFU >= netBarem;
  // Cotisations TNS sur dividendes (SARL TMN, simplifi√©e)
  var divCotTNS = regime === 'tns' ? divMens * 0.45 * 0.80 : 0; // indicatif

  // IS si r√©sultat saisi
  var isTheorique = 0, baseTaux15 = 0, baseTaux25 = 0;
  if (resultat > 0) {
    baseTaux15   = Math.min(resultat, 42500);
    baseTaux25   = Math.max(0, resultat - 42500);
    isTheorique  = baseTaux15 * 0.15 + baseTaux25 * 0.25;
  }
  var resultatApresIS = Math.max(0, resultat - isTheorique);

  document.getElementById('divContent').innerHTML = `
    <!-- 3 cases PFU -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px">
      <div style="background:#f8faff;border:1px solid #c7d2fe;border-radius:10px;padding:14px">
        <div style="font-size:10px;color:var(--muted);text-transform:uppercase;font-weight:700;margin-bottom:6px">Dividendes bruts</div>
        <div style="font-size:18px;font-weight:800">${fmtE(divMens,0)}/mois</div>
        <div style="font-size:10px;color:var(--muted);margin-top:3px">${fmtE(divMens*12,0)}/an</div>
      </div>
      <div style="background:#fef3c7;border:1px solid #fcd34d;border-radius:10px;padding:14px">
        <div style="font-size:10px;color:#92400e;text-transform:uppercase;font-weight:700;margin-bottom:6px">PFU ‚Äî Flat Tax 30%</div>
        <div style="font-size:18px;font-weight:800;color:#d97706">‚àí${fmtE(pfuDiv,0)}/mois</div>
        <div style="font-size:10px;color:var(--muted);margin-top:3px">IR 12,8% + PS 17,2%</div>
      </div>
      <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;padding:14px">
        <div style="font-size:10px;color:#065f2c;text-transform:uppercase;font-weight:700;margin-bottom:6px">Net apr√®s PFU ‚úì</div>
        <div style="font-size:18px;font-weight:800;color:#059669">${fmtE(netPFU,0)}/mois</div>
        <div style="font-size:10px;color:var(--muted);margin-top:3px">${fmtE(netPFU*12,0)}/an</div>
      </div>
    </div>

    <!-- Comparaison PFU vs Bar√®me -->
    <div style="background:#f8faff;border:1px solid #e2e8f0;border-radius:10px;padding:14px;margin-bottom:12px">
      <div style="font-size:11px;font-weight:700;margin-bottom:10px;color:#374151">üìä PFU vs Option bar√®me IR (taux moyen ${pct(tMoy*100)})</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <div style="padding:10px;background:${pfuMieux?'#f0fdf4':'#fff'};border:1.5px solid ${pfuMieux?'#10b981':'#e2e8f0'};border-radius:8px">
          <div style="font-size:10px;font-weight:700;color:${pfuMieux?'#059669':'#6b7280'};margin-bottom:4px">${pfuMieux?'‚úÖ ':''} PFU (30% fixe)</div>
          <div style="font-size:16px;font-weight:800;color:${pfuMieux?'#059669':'#374151'}">${fmtE(netPFU,0)}/mois</div>
          <div style="font-size:10px;color:var(--muted)">IR 12,8% + PS 17,2%</div>
        </div>
        <div style="padding:10px;background:${!pfuMieux?'#f0fdf4':'#fff'};border:1.5px solid ${!pfuMieux?'#10b981':'#e2e8f0'};border-radius:8px">
          <div style="font-size:10px;font-weight:700;color:${!pfuMieux?'#059669':'#6b7280'};margin-bottom:4px">${!pfuMieux?'‚úÖ ':''} Bar√®me IR</div>
          <div style="font-size:16px;font-weight:800;color:${!pfuMieux?'#059669':'#374151'}">${fmtE(netBarem,0)}/mois</div>
          <div style="font-size:10px;color:var(--muted)">PS 17,2% + IR ${pct(tMoy*100)}</div>
        </div>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:8px">
        üí° Option bar√®me avantageuse si votre taux marginal est inf√©rieur √† 12,8%. ${tauxAutoCalc > 12.8 ? 'Dans votre cas, le PFU semble plus avantageux.' : tauxAutoCalc > 0 ? 'Dans votre cas, le bar√®me pourrait √™tre avantageux.' : 'Renseignez votre revenu pour une comparaison pr√©cise.'}
      </div>
    </div>

    <!-- Alerte selon statut -->
    ${regime === 'tns' ? `
    <div style="background:#fef9c3;border:1px solid #fde68a;border-radius:8px;padding:10px 14px;font-size:11px;color:#92400e;margin-bottom:10px">
      ‚ö†Ô∏è <strong>SARL/EURL g√©rant majoritaire :</strong> les dividendes d√©passant 10% du capital social + comptes courants d'associ√©s sont soumis aux cotisations TNS (~45%). Ils s'ajoutent alors √† votre assiette de cotisations. Consultez votre expert-comptable.
    </div>` : `
    <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:10px 14px;font-size:11px;color:#065f2c;margin-bottom:10px">
      ‚úÖ <strong>SAS/SASU :</strong> les dividendes ne sont pas soumis aux cotisations sociales ‚Äî uniquement PFU 30% ou option bar√®me IR.
    </div>`}

    <!-- IS si r√©sultat saisi -->
    ${resultat > 0 ? `
    <div style="background:#f8faff;border:1px solid #c7d2fe;border-radius:10px;padding:14px">
      <div style="font-size:11px;font-weight:700;margin-bottom:10px;color:#374151">üè¢ Imp√¥t sur les Soci√©t√©s (IS) th√©orique</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px">
        <div style="text-align:center">
          <div style="font-size:9px;color:var(--muted);font-weight:700">R√©sultat net</div>
          <div style="font-size:14px;font-weight:800">${fmtE(resultat,0)}</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:9px;color:var(--muted);font-weight:700">IS (15% + 25%)</div>
          <div style="font-size:14px;font-weight:800;color:#ef4444">‚àí${fmtE(isTheorique,0)}</div>
          <div style="font-size:9px;color:var(--muted)">${fmtE(baseTaux15,0)}√ó15% + ${fmtE(baseTaux25,0)}√ó25%</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:9px;color:var(--muted);font-weight:700">Distribuable</div>
          <div style="font-size:14px;font-weight:800;color:#10b981">${fmtE(resultatApresIS,0)}</div>
        </div>
        <div style="text-align:center">
          <div style="font-size:9px;color:var(--muted);font-weight:700">Si distribu√© en div.</div>
          <div style="font-size:14px;font-weight:800;color:#6366f1">${fmtE(resultatApresIS*0.70,0)}</div>
          <div style="font-size:9px;color:var(--muted)">Net apr√®s PFU</div>
        </div>
      </div>
    </div>` : ''}
  `;
}

function hideResults() {
  document.getElementById('netBanner').style.display = 'none';
  document.getElementById('decompSection').style.display = 'none';
  document.getElementById('divCard').style.display = 'none';
}

// ‚ïê‚ïê SAVE ‚ïê‚ïê
async function saveDirigeant() {
  if (!window._uid) return;
  var data = {
    statut:    _statut,
    freq:      _freq,
    brutMens:  parseF(document.getElementById('inp-brut').value) / (_freq==='annuel'?12:1),
    netMens:   parseF(document.getElementById('inp-net').value) / (_freq==='annuel'?12:1),
    divMens:   parseF(document.getElementById('inp-div').value) / (_freq==='annuel'?12:1),
    resultat:  parseF(document.getElementById('inp-resultat').value),
    tauxIR:    parseF(document.getElementById('inp-ir').value),
    updatedAt: new Date().toISOString()
  };
  try {
    await window._setDoc(window._doc(window._db, 'rh_params', window._uid + '_dirigeant'), data);
    showToast('‚úÖ Param√®tres sauvegard√©s', 'ok');
  } catch(e) { showToast('Erreur : '+e.message, 'err'); console.error(e); }
}
window.saveDirigeant = saveDirigeant;

// UTILS
function showToast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show '+(type||'');
  setTimeout(function(){ t.className='toast'; }, 3200);
}
function toggleMobileNav() {
  var hbg=document.getElementById('hamburger'),ov=document.getElementById('navOverlay'),sb=document.querySelector('nav,aside.sidebar,.sidebar');
  if(sb)sb.classList.toggle('open');if(ov)ov.classList.toggle('show');if(hbg)hbg.classList.toggle('open');
}
window.toggleMobileNav=toggleMobileNav;

// Recalc √† chaque changement
['inp-div','inp-resultat','inp-ir','inp-anciennete'].forEach(function(id){
  var el=document.getElementById(id);
  if(el)el.addEventListener('input',calc);
});
</script>

<script src="nav.js"></script>
<script>
(function openRhNav(){
  var tries=0;
  var t=setInterval(function(){
    var sub=document.getElementById("rh-nav-sub");
    var nav=document.getElementById("alteore-nav");
    if(sub&&nav){clearInterval(t);sub.style.maxHeight="2000px";nav.classList.add("rh-mode");}
    if(++tries>50)clearInterval(t);
  },50);
})();
</script>
</body>
</html>
