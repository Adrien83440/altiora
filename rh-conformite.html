<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE â€” ConformitÃ© & LÃ©gal RH</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --rh-dark:#052e16;--rh-main:#059669;--rh-mid:#10b981;--rh-bright:#34d399;
      --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f5f7ff;
      --sidebar-w:252px;--radius:12px;
      --red:#ef4444;--orange:#f59e0b;--blue:#3b82f6;--purple:#6366f1;
      --amber:#d97706;--teal:#0891b2;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}

    /* SIDEBAR */
    .sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#052e16 0%,#064e23 50%,#065f2c 100%);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;overflow-y:auto;}
    .sidebar-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 22px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:10px;}
    .sidebar-logo-icon{width:36px;height:36px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .sidebar-logo-text{font-size:18px;font-weight:800;color:white;letter-spacing:1px;}
    .nav-item{display:flex;align-items:center;gap:11px;padding:10px 20px;color:rgba(255,255,255,0.6);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;text-decoration:none;}
    .nav-item:hover{color:white;background:rgba(255,255,255,0.06);}
    .nav-item.active{color:white;background:rgba(255,255,255,0.1);border-left-color:#34d399;}
    .nav-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0;}
    .sidebar-footer{margin-top:auto;padding:16px 20px 0;border-top:1px solid rgba(255,255,255,0.08);}
    .user-card{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.07);border-radius:10px;}
    .user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--rh-mid),#059669);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
    .user-name{font-size:12px;font-weight:600;color:white;}
    .user-plan{font-size:10px;color:rgba(255,255,255,0.4);}
    .logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:14px;padding:4px;}

    /* MAIN */
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:17px;font-weight:700;}
    .topbar-left p{font-size:12px;color:var(--muted);}
    .topbar-right{display:flex;align-items:center;gap:10px;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.18s;}
    .btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-mid));color:white;box-shadow:0 3px 10px rgba(5,150,105,.25);}
    .btn-rh:hover{opacity:.9;transform:translateY(-1px);}
    .btn-outline{background:white;color:var(--rh-main);border:1.5px solid var(--rh-border);}
    .btn-outline:hover{border-color:var(--rh-main);background:var(--rh-ghost);}
    .btn-sm{padding:5px 12px;font-size:12px;}
    .btn-xs{padding:3px 8px;font-size:11px;}
    .btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}
    .btn-amber{background:#fffbeb;color:var(--amber);border:1px solid #fde68a;}

    /* CONTENT LAYOUT */
    .content{padding:22px 28px;flex:1;display:flex;gap:20px;align-items:flex-start;}
    .left-nav{width:220px;flex-shrink:0;position:sticky;top:78px;}
    .right-content{flex:1;min-width:0;display:flex;flex-direction:column;gap:16px;}

    /* LEFT NAV */
    .conf-nav{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .conf-nav-head{padding:12px 16px;background:var(--rh-ghost);border-bottom:1px solid var(--rh-border);font-size:11px;font-weight:700;color:var(--rh-dark);text-transform:uppercase;letter-spacing:.5px;}
    .conf-nav-item{display:flex;align-items:center;gap:8px;padding:9px 14px;cursor:pointer;border-left:3px solid transparent;transition:all .15s;font-size:12px;font-weight:500;color:var(--muted);}
    .conf-nav-item:hover{background:var(--rh-ghost);color:var(--rh-dark);}
    .conf-nav-item.active{background:var(--rh-ghost);color:var(--rh-dark);border-left-color:var(--rh-main);font-weight:700;}
    .conf-nav-icon{font-size:14px;width:16px;text-align:center;}
    .conf-nav-badge{margin-left:auto;font-size:9px;font-weight:700;padding:1px 5px;border-radius:8px;}
    .badge-ok{background:#dcfce7;color:#166534;}
    .badge-warn{background:#fef3c7;color:#92400e;}
    .badge-err{background:#fee2e2;color:#991b1b;}
    .badge-info{background:#dbeafe;color:#1e40af;}

    /* SCORE GLOBAL */
    .score-banner{background:linear-gradient(135deg,#052e16,#064e23,#065f2c);border-radius:var(--radius);padding:20px 24px;color:white;display:flex;align-items:center;gap:20px;}
    .score-circle{width:72px;height:72px;border-radius:50%;border:4px solid rgba(255,255,255,.2);display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0;position:relative;}
    .score-num{font-size:24px;font-weight:800;line-height:1;}
    .score-denom{font-size:11px;color:rgba(255,255,255,.5);}
    .score-info{flex:1;}
    .score-title{font-size:16px;font-weight:700;margin-bottom:4px;}
    .score-sub{font-size:12px;color:rgba(255,255,255,.6);margin-bottom:12px;}
    .score-bar-wrap{height:6px;background:rgba(255,255,255,.15);border-radius:3px;overflow:hidden;}
    .score-bar-fill{height:100%;border-radius:3px;transition:width .8s ease;}
    .score-kpis{display:flex;gap:14px;margin-top:12px;}
    .score-kpi{text-align:center;}
    .score-kpi-val{font-size:18px;font-weight:800;}
    .score-kpi-lbl{font-size:9px;color:rgba(255,255,255,.5);text-transform:uppercase;font-weight:600;}

    /* SECTION CARD */
    .conf-section{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .conf-section-head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);cursor:pointer;user-select:none;}
    .conf-section-head:hover{background:#fafbff;}
    .conf-section-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .conf-section-meta{display:flex;align-items:center;gap:8px;}
    .conf-section-body{padding:16px 18px;display:flex;flex-direction:column;gap:10px;}
    .conf-section-body.collapsed{display:none;}
    .chevron{font-size:11px;color:var(--muted);transition:transform .2s;}
    .chevron.open{transform:rotate(90deg);}

    /* OBLIGATION ITEM */
    .oblig-item{border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;transition:all .15s;display:flex;gap:12px;align-items:flex-start;}
    .oblig-item:hover{border-color:#c7d2fe;background:#fafbff;}
    .oblig-item.ok{border-color:#6ee7b7;background:#f0fdf4;}
    .oblig-item.warn{border-color:#fcd34d;background:#fffbeb;}
    .oblig-item.err{border-color:#fca5a5;background:#fef2f2;}
    .oblig-item.na{border-color:#e2e8f0;background:#f8faff;opacity:.7;}
    .oblig-check{width:20px;height:20px;border-radius:6px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;margin-top:1px;}
    .check-ok{background:#dcfce7;color:#166534;}
    .check-warn{background:#fef3c7;color:#92400e;}
    .check-err{background:#fee2e2;color:#991b1b;}
    .check-na{background:#f1f5f9;color:#94a3b8;}
    .check-todo{background:#dbeafe;color:#1e40af;}
    .oblig-content{flex:1;min-width:0;}
    .oblig-title{font-size:12px;font-weight:700;color:var(--text);margin-bottom:2px;}
    .oblig-desc{font-size:11px;color:var(--muted);line-height:1.5;}
    .oblig-ref{font-size:10px;color:#94a3b8;margin-top:4px;font-style:italic;}
    .oblig-actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
    .oblig-tag{font-size:10px;font-weight:700;padding:2px 7px;border-radius:12px;}
    .tag-ccn{background:#f3e8ff;color:#7e22ce;}
    .tag-legal{background:#dbeafe;color:#1e40af;}
    .tag-rgpd{background:#fce7f3;color:#9d174d;}
    .tag-social{background:#dcfce7;color:#166534;}
    .tag-hygiene{background:#fff7ed;color:#c2410c;}
    .tag-secu{background:#fef2f2;color:#991b1b;}
    .tag-eff{background:#f0fdf4;color:#166534;}

    /* STATUS SELECTOR */
    .status-sel{display:flex;gap:4px;margin-top:6px;}
    .status-btn{font-size:10px;font-weight:700;padding:3px 8px;border-radius:8px;border:none;cursor:pointer;transition:all .12s;opacity:.5;}
    .status-btn:hover{opacity:.8;}
    .status-btn.active{opacity:1;}
    .sb-ok{background:#dcfce7;color:#166534;}
    .sb-warn{background:#fef3c7;color:#92400e;}
    .sb-err{background:#fee2e2;color:#991b1b;}
    .sb-na{background:#f1f5f9;color:#94a3b8;}

    /* NOTES */
    .oblig-note-input{width:100%;margin-top:6px;padding:6px 8px;border:1.5px solid var(--border);border-radius:6px;font-family:'Plus Jakarta Sans',sans-serif;font-size:11px;color:var(--text);outline:none;resize:none;min-height:48px;}
    .oblig-note-input:focus{border-color:var(--rh-main);}

    /* DOCUMENTS LÃ‰GAUX */
    .doc-legal-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:#f8faff;margin-bottom:8px;}
    .doc-legal-item:last-child{margin-bottom:0;}
    .doc-legal-ico{font-size:20px;flex-shrink:0;}
    .doc-legal-info{flex:1;}
    .doc-legal-name{font-size:12px;font-weight:700;}
    .doc-legal-desc{font-size:11px;color:var(--muted);}
    .doc-legal-status{font-size:11px;font-weight:700;padding:3px 8px;border-radius:8px;}

    /* SALARIÃ‰ CARDS */
    .emp-conf-item{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:#fafbff;margin-bottom:6px;}
    .emp-avatar{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0;}
    .emp-conf-name{font-size:12px;font-weight:600;}
    .emp-conf-poste{font-size:10px;color:var(--muted);}
    .emp-conf-badges{display:flex;gap:4px;margin-left:auto;flex-wrap:wrap;justify-content:flex-end;}

    /* CALENDRIER OBLIGATIONS */
    .cal-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
    .cal-month{background:#f8faff;border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center;}
    .cal-month-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:6px;}
    .cal-items{display:flex;flex-direction:column;gap:3px;}
    .cal-item{font-size:9px;padding:2px 5px;border-radius:4px;font-weight:600;text-align:left;}

    /* CCN BADGE */
    .ccn-banner{background:linear-gradient(135deg,#1e3a5f,#1e40af);border-radius:10px;padding:12px 16px;color:white;display:flex;align-items:center;gap:12px;margin-bottom:16px;}
    .ccn-banner-icon{font-size:24px;}
    .ccn-banner-info{flex:1;}
    .ccn-banner-title{font-size:13px;font-weight:700;}
    .ccn-banner-sub{font-size:11px;color:rgba(255,255,255,.6);}
    .ccn-banner-idcc{font-size:10px;font-weight:700;padding:2px 8px;border-radius:12px;background:rgba(255,255,255,.15);color:white;}

    /* PRINT */
    @media print{
      .sidebar,.topbar,.left-nav,.score-banner,.conf-nav{display:none!important;}
      .main{margin:0!important;}
      .content{padding:0!important;flex-direction:column!important;}
      .right-content{width:100%!important;}
      .conf-section-body.collapsed{display:flex!important;}
    }

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.ok{background:var(--rh-main);}
    .toast.err{background:var(--red);}

    /* LOADER */
    .loader{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--muted);gap:10px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--rh-main);border-radius:50%;animation:spin .7s linear infinite;}

    /* HAMBURGER */
    .hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:#052e16;border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(5,46,22,.45);}
    .hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;}
    .nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;}
    .nav-overlay.show{display:block;}

    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(15,31,92,.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;width:100%;max-width:560px;box-shadow:0 24px 60px rgba(15,31,92,.2);overflow:hidden;}
    .modal-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
    .modal-head h3{font-size:14px;font-weight:700;}
    .modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);}
    .modal-body{padding:20px 22px;max-height:65vh;overflow-y:auto;}
    .modal-foot{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;}
    .modal-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:5px;display:block;}
    .modal-input{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;outline:none;}
    .modal-input:focus{border-color:var(--rh-main);}
    .modal-textarea{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;outline:none;resize:vertical;min-height:80px;}
    .modal-textarea:focus{border-color:var(--rh-main);}

    @media(max-width:768px){
      .hamburger{display:flex!important;}
      .sidebar{position:fixed!important;top:0!important;left:0!important;height:100vh!important;width:min(280px,84vw)!important;z-index:1001!important;transform:translateX(-105%)!important;transition:transform .3s cubic-bezier(.4,0,.2,1)!important;}
      .sidebar.open{transform:translateX(0)!important;box-shadow:8px 0 32px rgba(0,0,0,.3)!important;}
      .main{margin-left:0!important;}
      .topbar{padding:10px 10px 10px 62px!important;}
      .content{padding:12px 10px!important;flex-direction:column!important;}
      .left-nav{width:100%!important;position:static!important;}
      .cal-grid{grid-template-columns:repeat(2,1fr)!important;}
    }
  </style>
</head>
<body>

<button class="hamburger" id="hamburger-btn" onclick="toggleSidebar()">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="nav-overlay" onclick="closeSidebar()"></div>

<!-- SIDEBAR injectÃ©e par nav.js -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>âš–ï¸ ConformitÃ© & LÃ©gal</h1>
      <p id="topbar-ccn-sub">Audit de conformitÃ© RH Â· Documents lÃ©gaux Â· RGPD Â· SÃ©curitÃ© au travail</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="window.print()">ğŸ–¨ï¸ Rapport</button>
      <button class="btn btn-rh btn-sm" onclick="saveAll()">ğŸ’¾ Sauvegarder</button>
      <a href="rh-dashboard.html" class="btn btn-outline btn-sm">â† RH</a>
    </div>
  </div>

  <div class="content" id="main-content">
    <div class="loader"><div class="spin"></div><span>Chargementâ€¦</span></div>
  </div>
</div>

<!-- MODAL AJOUT NOTE -->
<div class="modal-overlay" id="modal-note">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modal-note-title">ğŸ“ Commentaire</h3>
      <button class="modal-close" onclick="closeModalNote()">âœ•</button>
    </div>
    <div class="modal-body">
      <label class="modal-label">Statut</label>
      <select class="modal-input" id="mn-status" style="margin-bottom:12px">
        <option value="ok">âœ… Conforme</option>
        <option value="warn">âš ï¸ Ã€ amÃ©liorer</option>
        <option value="err">âŒ Non conforme</option>
        <option value="na">â€” Non applicable</option>
      </select>
      <label class="modal-label">Note / commentaire</label>
      <textarea class="modal-textarea" id="mn-note" placeholder="DÃ©crivez l'action entreprise, la date de mise en conformitÃ© prÃ©vueâ€¦"></textarea>
      <label class="modal-label" style="margin-top:12px">Date d'Ã©chÃ©ance</label>
      <input type="date" class="modal-input" id="mn-echeance"/>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline btn-sm" onclick="closeModalNote()">Annuler</button>
      <button class="btn btn-rh btn-sm" onclick="saveNote()">Enregistrer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, initializeFirestore, doc, getDoc, setDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth = getAuth(app);
  const db = initializeFirestore(app, { experimentalAutoDetectLongPolling: true });
  window._auth=auth; window._db=db;
  window._doc=doc; window._getDoc=getDoc; window._setDoc=setDoc;
  window._collection=collection; window._getDocs=getDocs;
  window._signOut=signOut;
  onAuthStateChanged(auth, user => {
    if (!user) { window.location.href='index.html'; return; }
    window._uid = user.uid;
    const name = user.displayName || user.email.split('@')[0];
    ['uname','uname2'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=name;});
    ['av','av2'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=name.charAt(0).toUpperCase();});
    window._firebaseReady = true;
    window.initConformite();
  });
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CCN â€” mÃªme rÃ©fÃ©rentiel que rh-params / rh-employes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CCN_RULES = {
  'droit_commun':        {label:'Code du travail (droit commun)',        idcc:null,  secteur:'tous'},
  'chr':                 {label:'HÃ´tels-CafÃ©s-Restaurants (CHR)',         idcc:1979,  secteur:'chr'},
  'restauration_rapide': {label:'Restauration rapide',                    idcc:1501,  secteur:'chr'},
  'commerce':            {label:'Commerce de dÃ©tail non alimentaire',     idcc:1517,  secteur:'commerce'},
  'commerce_alimentaire':{label:'Commerce alimentaire',                   idcc:2216,  secteur:'commerce'},
  'grande_distribution': {label:'Grande distribution',                    idcc:2216,  secteur:'commerce'},
  'boulangerie':         {label:'Boulangerie-PÃ¢tisserie artisanale',      idcc:843,   secteur:'alim'},
  'patisserie':          {label:'PÃ¢tisserie artisanale',                  idcc:1267,  secteur:'alim'},
  'boucherie':           {label:'Boucherie-Charcuterie artisanale',       idcc:953,   secteur:'alim'},
  'btp':                 {label:'BÃ¢timent (BTP ouvriers)',                idcc:1597,  secteur:'btp'},
  'btp_etam':            {label:'BTP â€” ETAM',                             idcc:2609,  secteur:'btp'},
  'coiffure':            {label:'Coiffure',                               idcc:2596,  secteur:'beaute'},
  'esthetique':          {label:'EsthÃ©tique-CosmÃ©tique-Parfumerie',       idcc:3032,  secteur:'beaute'},
  'sante':               {label:'SantÃ© (FEHAP / EHPAD)',                  idcc:29,    secteur:'sante'},
  'cabinet_medical':     {label:'Cabinet mÃ©dical / Para-mÃ©dical',         idcc:1748,  secteur:'sante'},
  'pharmacie':           {label:"Pharmacie d'officine",                   idcc:1996,  secteur:'sante'},
  'nettoyage':           {label:'Nettoyage et services associÃ©s',         idcc:3043,  secteur:'services'},
  'transport_routier':   {label:'Transport routier (conducteurs)',        idcc:16,    secteur:'transport'},
  'transport_voyageurs': {label:'Transport en commun',                    idcc:1424,  secteur:'transport'},
  'automobile':          {label:"Services de l'automobile",               idcc:1090,  secteur:'auto'},
  'immobilier':          {label:'Immobilier / Agences',                   idcc:1527,  secteur:'immo'},
  'securite':            {label:'PrÃ©vention-SÃ©curitÃ© privÃ©e',             idcc:1351,  secteur:'securite_priv'},
  'agriculture':         {label:'Agriculture / Exploitations agricoles',  idcc:7024,  secteur:'agri'},
  'viticulture':         {label:'Viticulture',                            idcc:9111,  secteur:'agri'},
  'sap':                 {label:'Services Ã  la personne (SAP)',           idcc:3127,  secteur:'sap'},
  'aide_domicile':       {label:'Aide Ã  domicile (associations)',         idcc:2941,  secteur:'sap'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ã‰TAT GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _params = {};
var _employes = {};
var _conformiteData = {}; // DonnÃ©es sauvegardÃ©es { itemId: { statut, note, echeance } }
var _currentSection = 'affichage';
var _modalItemId = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.initConformite = async function() {
  try {
    // Charger params
    const dp = await window._getDoc(window._doc(window._db, 'rh_params', window._uid));
    if (dp.exists()) _params = dp.data();

    // Charger employÃ©s
    const se = await window._getDocs(window._collection(window._db, 'rh', window._uid, 'employes'));
    se.forEach(d => _employes[d.id] = Object.assign({id:d.id}, d.data()));

    // Charger donnÃ©es conformitÃ© sauvegardÃ©es
    const dc = await window._getDoc(window._doc(window._db, 'rh_params', window._uid + '_conformite'));
    if (dc.exists()) _conformiteData = dc.data();

    renderPage();
  } catch(e) {
    console.error(e);
    document.getElementById('main-content').innerHTML = '<div class="loader" style="color:var(--red)">âš ï¸ Erreur de chargement : ' + e.message + '</div>';
  }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DÃ‰FINITION DES OBLIGATIONS (corpus complet)
// Chaque obligation : { id, titre, desc, ref, tags[], secteurs[], effectifMin, statut_defaut }
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getObligations() {
  const ccn = _params.ccnDefault || 'droit_commun';
  const effectif = _params.effectif || '1-9';
  const eff10 = effectif !== '1-9';
  const eff50 = effectif === '50-249' || effectif === '250+';
  const eff11 = effectif !== '1-9'; // â‰¥ 11 (mÃªme rÃ¨gle que â‰¥10 pour simplification)
  const secteur = (CCN_RULES[ccn] || {}).secteur || 'tous';

  return [

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 1. AFFICHAGES OBLIGATOIRES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    { cat:'affichage', id:'aff_interdiction_fumer', titre:"Interdiction de fumer / vapoter",
      desc:"Affichage visible Ã  l'entrÃ©e et dans chaque local de l'interdiction de fumer et de vapoter.",
      ref:"Art. R3512-2 Code de la santÃ© publique", tags:['legal'], priorite:'haute', obligatoire:true },

    { cat:'affichage', id:'aff_harcelement', titre:"HarcÃ¨lement moral et sexuel",
      desc:"Textes des articles L1152-1 et L1153-1 du Code du travail + coordonnÃ©es du DÃ©fenseur des droits et de l'inspection du travail.",
      ref:"Art. L1152-1, L1153-1 CT + DÃ©cret 2019-15", tags:['legal','rgpd'], priorite:'haute', obligatoire:true },

    { cat:'affichage', id:'aff_inspection_travail', titre:"CoordonnÃ©es de l'inspection du travail",
      desc:"Adresse et numÃ©ro de tÃ©lÃ©phone de l'inspecteur du travail dont dÃ©pend l'Ã©tablissement.",
      ref:"Art. R4711-1 CT", tags:['legal'], priorite:'haute', obligatoire:true },

    { cat:'affichage', id:'aff_medecin_travail', titre:"CoordonnÃ©es du mÃ©decin du travail",
      desc:"Nom, adresse et tÃ©lÃ©phone du service de santÃ© au travail interentreprises (SSTI).",
      ref:"Art. R4711-1 CT", tags:['legal','social'], priorite:'haute', obligatoire:true },

    { cat:'affichage', id:'aff_urgences', titre:"NumÃ©ros d'urgence et consignes de sÃ©curitÃ©",
      desc:"SAMU 15, Police 17, Pompiers 18, Urgences 112 + consignes d'Ã©vacuation en cas d'incendie avec plan d'Ã©vacuation.",
      ref:"Art. R4227-28 CT", tags:['secu'], priorite:'haute', obligatoire:true },

    { cat:'affichage', id:'aff_egalite_remuneration', titre:"Ã‰galitÃ© de rÃ©munÃ©ration H/F",
      desc:"Affichage de l'Ã©galitÃ© de rÃ©munÃ©ration entre hommes et femmes (art. L3221-1 Ã  L3221-7 CT).",
      ref:"Art. L3221-9 CT", tags:['legal','social'], priorite:'haute', obligatoire:true },

    { cat:'affichage', id:'aff_horaires', titre:"Horaires collectifs de travail",
      desc:"Affichage des horaires de travail de chaque catÃ©gorie de personnel, datÃ© et signÃ©.",
      ref:"Art. D3171-1 CT", tags:['legal'], priorite:'haute', obligatoire:true },

    { cat:'affichage', id:'aff_conges_payes', titre:"Ordre des dÃ©parts en congÃ©s payÃ©s",
      desc:"Affichage de l'ordre de dÃ©part en congÃ©s au moins 1 mois avant le dÃ©part (si dÃ©parts organisÃ©s).",
      ref:"Art. D3141-6 CT", tags:['legal'], priorite:'moyenne', obligatoire:true },

    { cat:'affichage', id:'aff_convention_collective', titre:"Existence de la convention collective",
      desc:"IntitulÃ© de la convention collective applicable, disponible pour consultation sur demande.",
      ref:"Art. L2262-5 CT", tags:['legal','ccn'], priorite:'haute', obligatoire:true },

    { cat:'affichage', id:'aff_rqth', titre:"Obligation d'emploi des travailleurs handicapÃ©s",
      desc:"Information sur l'obligation d'emploi des travailleurs handicapÃ©s (OETH) pour les entreprises â‰¥ 20 salariÃ©s.",
      ref:"Art. L5212-1 CT", tags:['legal','social'], priorite:'haute', obligatoire: effectif !== '1-9' },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 2. REGISTRES & DOCUMENTS OBLIGATOIRES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    { cat:'registres', id:'reg_personnel', titre:"Registre unique du personnel",
      desc:"Tenu Ã  jour dÃ¨s le 1er salariÃ©. Contient : nom, prÃ©nom, nationalitÃ©, date de naissance, sexe, emploi, qualification, date d'entrÃ©e et de sortie, pour chaque travailleur.",
      ref:"Art. L1221-13 et D1221-23 CT", tags:['legal','social'], priorite:'haute', obligatoire:true },

    { cat:'registres', id:'reg_accidents', titre:"Registre des accidents du travail bÃ©nins",
      desc:"Tenu en accord avec le mÃ©decin du travail pour les accidents n'entraÃ®nant pas d'arrÃªt de travail ni de soins mÃ©dicaux donnant lieu Ã  prise en charge.",
      ref:"Art. L441-4 Code SS + Art. R441-16 CSS", tags:['secu','social'], priorite:'haute', obligatoire:true },

    { cat:'registres', id:'reg_conges', titre:"Document individuel de contrÃ´le des congÃ©s et absences",
      desc:"Suivi des CP, RTT, absences, rÃ©cupÃ©rations par salariÃ©. Conservation 5 ans.",
      ref:"Art. D3171-11 CT", tags:['legal','social'], priorite:'haute', obligatoire:true },

    { cat:'registres', id:'reg_delegues', titre:"ProcÃ¨s-verbaux des Ã©lections CSE / DP",
      desc:"Conservation des PV d'Ã©lections (ou carence si aucun candidat) des reprÃ©sentants du personnel.",
      ref:"Art. L2314-29 CT", tags:['legal','social'], priorite:'haute', obligatoire: eff11 },

    { cat:'registres', id:'reg_document_unique', titre:"Document Unique d'Ã‰valuation des Risques (DUER)",
      desc:"Inventaire des risques professionnels identifiÃ©s dans l'Ã©tablissement. Mis Ã  jour annuellement et aprÃ¨s tout accident grave. Conservation 40 ans.",
      ref:"Art. R4121-1 CT", tags:['secu','legal'], priorite:'critique', obligatoire:true },

    { cat:'registres', id:'reg_mise_en_demeure', titre:"Registre des mises en demeure et procÃ¨s-verbaux",
      desc:"Conservation des mises en demeure de l'inspection du travail et des procÃ¨s-verbaux d'infraction.",
      ref:"Art. L8113-7 CT", tags:['legal'], priorite:'haute', obligatoire:true },

    { cat:'registres', id:'reg_formation', titre:"Plan de dÃ©veloppement des compÃ©tences",
      desc:"Document listant les actions de formation planifiÃ©es pour les salariÃ©s. PrÃ©sentÃ© au CSE pour consultation.",
      ref:"Art. L6312-1 CT", tags:['legal','social'], priorite:'haute', obligatoire: eff10 },

    { cat:'reglement', id:'regl_interieur', titre:"RÃ¨glement intÃ©rieur",
      desc:"Document obligatoire â‰¥50 salariÃ©s fixant les rÃ¨gles gÃ©nÃ©rales de discipline, d'hygiÃ¨ne et de sÃ©curitÃ©. DÃ©posÃ© Ã  l'inspection du travail et affichÃ©.",
      ref:"Art. L1321-1 CT", tags:['legal'], priorite:'haute', obligatoire: eff50 },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 3. SANTÃ‰ ET SÃ‰CURITÃ‰ AU TRAVAIL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    { cat:'secu', id:'secu_visite_medicale', titre:"Visites mÃ©dicales d'embauche et de suivi",
      desc:"Visite d'information et de prÃ©vention (VIP) dans les 3 mois suivant l'embauche. Suivi renforcÃ© pour les postes Ã  risque. Conservation des fiches d'aptitude.",
      ref:"Art. R4624-10 CT", tags:['secu','social'], priorite:'critique', obligatoire:true },

    { cat:'secu', id:'secu_premiers_secours', titre:"Sauveteurs Secouristes du Travail (SST)",
      desc:"Au moins 1 SST formÃ© par atelier ou chantier oÃ¹ des travaux dangereux sont effectuÃ©s. RecommandÃ© dans tous les Ã©tablissements.",
      ref:"Art. R4224-15 CT", tags:['secu'], priorite:'haute', obligatoire:true },

    { cat:'secu', id:'secu_epi', titre:"Equipements de Protection Individuelle (EPI)",
      desc:"Fourniture gratuite d'EPI adaptÃ©s aux risques. Formation Ã  leur utilisation. Remplacement et entretien assurÃ©s par l'employeur.",
      ref:"Art. R4321-1 CT", tags:['secu'], priorite:'haute', obligatoire:true },

    { cat:'secu', id:'secu_formation_securite', titre:"Formation Ã  la sÃ©curitÃ© dÃ¨s l'embauche",
      desc:"Formation pratique et appropriÃ©e Ã  la sÃ©curitÃ© du travailleur Ã  l'embauche, lors d'un changement de poste, aprÃ¨s accident du travail grave.",
      ref:"Art. L4141-2 CT", tags:['secu','legal'], priorite:'haute', obligatoire:true },

    { cat:'secu', id:'secu_incendie', titre:"Formation incendie et exercices d'Ã©vacuation",
      desc:"Formation d'Ã©vacuation annuelle avec exercice pratique. DÃ©signation d'un responsable Ã©vacuation. Plans d'Ã©vacuation affichÃ©s et extincteurs vÃ©rifiÃ©s.",
      ref:"Art. R4227-28 et R4227-39 CT", tags:['secu'], priorite:'haute', obligatoire:true },

    { cat:'secu', id:'secu_alcool_drogue', titre:"Politique alcool et drogues sur le lieu de travail",
      desc:"Interdiction de l'alcool et des substances illicites sur le lieu de travail. Mention dans le rÃ¨glement intÃ©rieur. ProcÃ©dure en cas de suspicion.",
      ref:"Art. R4228-20 CT", tags:['secu','legal'], priorite:'haute', obligatoire:true },

    { cat:'secu', id:'secu_penibilite', titre:"PrÃ©vention de la pÃ©nibilitÃ© (C2P)",
      desc:"DÃ©claration des facteurs de risques professionnels au-delÃ  des seuils : travail de nuit, bruit, vibrations, tempÃ©ratures extrÃªmes, port de charges. Alimentez le Compte Professionnel de PrÃ©vention.",
      ref:"Art. L4163-1 CT", tags:['secu','social'], priorite:'haute', obligatoire:true },

    { cat:'secu', id:'secu_teletra_risques', titre:"Ã‰valuation des risques psychosociaux (RPS)",
      desc:"IntÃ©gration des RPS (stress, burn-out, harcÃ¨lement) dans le DUER. Plan d'action de prÃ©vention. Indicateurs de suivi.",
      ref:"Accord national interprofessionnel 2008 + Art. L4121-1 CT", tags:['secu','social'], priorite:'haute', obligatoire:true },

    // SpÃ©cifique CHR / restauration
    { cat:'secu', id:'secu_hygiene_alim', titre:"HygiÃ¨ne alimentaire â€” Formation HACCP",
      desc:"Au moins 1 personne formÃ©e Ã  l'hygiÃ¨ne alimentaire (mÃ©thode HACCP) par Ã©tablissement manipulant des denrÃ©es. Obligation CHR / restauration / boulangerie / boucherie.",
      ref:"RÃ¨glement CE 852/2004 + ArrÃªtÃ© 05/10/2011", tags:['secu','hygiene'], priorite:'critique',
      obligatoire: ['chr','restauration_rapide','boulangerie','patisserie','boucherie','commerce_alimentaire','grande_distribution'].includes(ccn) },

    { cat:'secu', id:'secu_haccp_plan', titre:"Plan de maÃ®trise sanitaire (PMS)",
      desc:"Document dÃ©crivant les mesures d'hygiÃ¨ne, le plan HACCP, les procÃ©dures de traÃ§abilitÃ© et de gestion des non-conformitÃ©s. Obligatoire CHR / IAA.",
      ref:"Art. 5 RÃ¨glement CE 852/2004", tags:['secu','hygiene'], priorite:'critique',
      obligatoire: ['chr','restauration_rapide','boulangerie','patisserie','boucherie','commerce_alimentaire'].includes(ccn) },

    // BTP spÃ©cifique
    { cat:'secu', id:'secu_btp_ppsps', titre:"Plan Particulier de SÃ©curitÃ© et de Protection de la SantÃ© (PPSPS)",
      desc:"Document de prÃ©vention Ã©tabli pour chaque chantier. Coordination SPS obligatoire pour les chantiers importants.",
      ref:"Art. R4532-60 CT", tags:['secu','btp'], priorite:'critique',
      obligatoire: ['btp','btp_etam'].includes(ccn) },

    { cat:'secu', id:'secu_btp_carteproBTP', titre:"Carte professionnelle BTP",
      desc:"Carte BTP obligatoire pour tout salariÃ© et intÃ©rimaire sur chantier depuis 2017. DÃ©livrÃ©e par la CNETP. Ã€ vÃ©rifier pour chaque nouveau salariÃ©.",
      ref:"Art. L8291-1 CT", tags:['secu','btp'], priorite:'haute',
      obligatoire: ['btp','btp_etam'].includes(ccn) },

    // Transport
    { cat:'secu', id:'secu_transport_aptitude', titre:"Visite mÃ©dicale aptitude conducteur",
      desc:"Visite mÃ©dicale spÃ©cifique pour les conducteurs de vÃ©hicules de transport. Renouvellement tous les 5 ans (3 ans aprÃ¨s 60 ans).",
      ref:"Art. R221-10 Code de la route", tags:['secu'], priorite:'critique',
      obligatoire: ['transport_routier','transport_voyageurs'].includes(ccn) },

    // SÃ©curitÃ© privÃ©e
    { cat:'secu', id:'secu_securite_agrement', titre:"AgrÃ©ment CNAPS et carte professionnelle agents",
      desc:"Chaque agent de sÃ©curitÃ© doit possÃ©der une carte professionnelle valide dÃ©livrÃ©e par le CNAPS. AgrÃ©ment de l'entreprise requis.",
      ref:"Art. L612-20 Code de la sÃ©curitÃ© intÃ©rieure", tags:['secu','legal'], priorite:'critique',
      obligatoire: ccn === 'securite' },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 4. RGPD & DONNÃ‰ES PERSONNELLES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    { cat:'rgpd', id:'rgpd_registre_traitement', titre:"Registre des activitÃ©s de traitement",
      desc:"Inventaire de tous les traitements de donnÃ©es personnelles (salariÃ©s, clients, fournisseurs). Tenu Ã  jour, accessible Ã  la CNIL sur demande.",
      ref:"Art. 30 RGPD", tags:['rgpd'], priorite:'critique', obligatoire:true },

    { cat:'rgpd', id:'rgpd_politique_confidentialite', titre:"Politique de confidentialitÃ© (site web)",
      desc:"Document dÃ©crivant les donnÃ©es collectÃ©es, leur usage, durÃ©e de conservation, droits des utilisateurs. AffichÃ©e sur le site web.",
      ref:"Art. 13 et 14 RGPD", tags:['rgpd'], priorite:'haute', obligatoire:true },

    { cat:'rgpd', id:'rgpd_mentions_legales', titre:"Mentions lÃ©gales (site web)",
      desc:"Nom, raison sociale, SIRET, adresse, directeur de publication, hÃ©bergeur. Obligatoires sur tout site internet.",
      ref:"Art. 6 Loi LCEN 2004-575", tags:['rgpd','legal'], priorite:'haute', obligatoire:true },

    { cat:'rgpd', id:'rgpd_information_salaries', titre:"Information des salariÃ©s sur le traitement de leurs donnÃ©es",
      desc:"Remise d'une notice d'information RGPD Ã  l'embauche : donnÃ©es collectÃ©es, finalitÃ©, durÃ©e de conservation, droits d'accÃ¨s/rectification/suppression.",
      ref:"Art. 13 RGPD + DÃ©libÃ©ration CNIL", tags:['rgpd','social'], priorite:'haute', obligatoire:true },

    { cat:'rgpd', id:'rgpd_dpo', titre:"DÃ©signation d'un DPO (si requis)",
      desc:"DÃ©lÃ©guÃ© Ã  la Protection des DonnÃ©es obligatoire pour les organismes publics, le traitement Ã  grande Ã©chelle de donnÃ©es sensibles, ou la surveillance systÃ©matique. RecommandÃ© pour toute entreprise.",
      ref:"Art. 37 RGPD", tags:['rgpd'], priorite:'moyenne',
      obligatoire: eff50 },

    { cat:'rgpd', id:'rgpd_camera_videosurveillance', titre:"VidÃ©osurveillance / VidÃ©oprotection",
      desc:"DÃ©claration auprÃ¨s de la prÃ©fecture (loi 1995). Information des salariÃ©s (RGPD). Panneau d'information visible. Conservation max 30 jours. Zones interdites (toilettes, vestiaires, salles de pause).",
      ref:"Loi 95-73 + Art. L1222-4 CT + Art. 13 RGPD", tags:['rgpd','secu'], priorite:'haute', obligatoire:false },

    { cat:'rgpd', id:'rgpd_cnil_biometrie', titre:"Autorisation CNIL pour donnÃ©es biomÃ©triques",
      desc:"Tout dispositif de contrÃ´le biomÃ©trique (empreintes, reconnaissance faciale) nÃ©cessite une autorisation CNIL prÃ©alable. Analyse d'impact (AIPD) obligatoire.",
      ref:"Art. 9 RGPD + DÃ©libÃ©ration CNIL", tags:['rgpd'], priorite:'haute', obligatoire:false },

    { cat:'rgpd', id:'rgpd_retention_docs_rh', titre:"DurÃ©es de conservation des documents RH",
      desc:"Bulletins de paie : 5 ans. Contrats de travail : 5 ans aprÃ¨s fin de contrat. Registre personnel : 5 ans. Dossier salariÃ© : 5 ans. DUER : 40 ans. VidÃ©osurveillance : 30 jours.",
      ref:"Code CT + RGPD", tags:['rgpd','legal'], priorite:'haute', obligatoire:true },

    { cat:'rgpd', id:'rgpd_cookies', titre:"Politique de gestion des cookies (site web)",
      desc:"Bandeau cookies conforme : consentement explicite, granularitÃ© par catÃ©gorie (analytique, marketing, etc.), refus aussi simple qu'accepter.",
      ref:"Art. 82 Loi Informatique et LibertÃ©s + Recommandation CNIL 2020", tags:['rgpd'], priorite:'haute', obligatoire:true },

    { cat:'rgpd', id:'rgpd_sous_traitants', titre:"Clauses RGPD dans les contrats sous-traitants",
      desc:"Tout sous-traitant traitant des donnÃ©es personnelles pour votre compte doit signer un DPA (Data Processing Agreement) conforme Ã  l'art. 28 RGPD.",
      ref:"Art. 28 RGPD", tags:['rgpd'], priorite:'haute', obligatoire:true },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 5. DROIT DU TRAVAIL â€” CONTRATS & PERSONNEL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    { cat:'contrats', id:'cont_contrat_ecrit', titre:"Contrat de travail Ã©crit pour chaque salariÃ©",
      desc:"CDI : Ã©crit recommandÃ© (obligatoire si CCN l'impose). CDD, temps partiel, intÃ©rim : Ã©crit obligatoire dans les 2 jours ouvrables. Convention collective doit Ãªtre mentionnÃ©e.",
      ref:"Art. L1221-1 et L3123-6 CT", tags:['legal','social','ccn'], priorite:'critique', obligatoire:true },

    { cat:'contrats', id:'cont_avenant', titre:"Avenant signÃ© pour toute modification du contrat",
      desc:"Toute modification du contrat (salaire, horaires, fonctions) doit Ãªtre formalisÃ©e par un avenant signÃ© par les deux parties avant application.",
      ref:"Art. L1222-6 CT", tags:['legal','social'], priorite:'haute', obligatoire:true },

    { cat:'contrats', id:'cont_periode_essai', titre:"Respect des pÃ©riodes d'essai et dÃ©lais de prÃ©venance",
      desc:"DurÃ©es lÃ©gales ET conventionnelles. DÃ©lai de prÃ©venance en cas de rupture (minimum 24h si < 8 jours, 48h si < 1 mois, 2 semaines si < 3 mois, 1 mois si > 3 mois).",
      ref:"Art. L1221-19 CT + CCN applicable", tags:['legal','social','ccn'], priorite:'haute', obligatoire:true },

    { cat:'contrats', id:'cont_cdd_motifs', titre:"CDD : motifs lÃ©gaux et durÃ©e maximale",
      desc:"CDD uniquement pour motifs lÃ©gaux (remplacement, accroissement activitÃ©, saisonnier, etc.). DurÃ©e max 18 mois (36 mois accroissement exceptionnel). Renouvellement max 2 fois.",
      ref:"Art. L1242-2 et L1243-13 CT", tags:['legal','social'], priorite:'haute', obligatoire:true },

    { cat:'contrats', id:'cont_temps_partiel', titre:"Temps partiel : durÃ©e minimale et mentions obligatoires",
      desc:"Minimum 24h/semaine (sauf dÃ©rogations). RÃ©partition horaire fixÃ©e au contrat. Heures complÃ©mentaires â‰¤ 1/10 de la durÃ©e contractuelle (1/3 si accord collectif).",
      ref:"Art. L3123-1 et L3123-6 CT", tags:['legal','social','ccn'], priorite:'haute', obligatoire:true },

    { cat:'contrats', id:'cont_bulletin_paie', titre:"Bulletin de paie conforme (dÃ©matÃ©rialisÃ© possible)",
      desc:"Mentions obligatoires : SIREN, CCN, emploi, classification, salaire brut, cotisations, NET SOCIAL, NET Ã€ PAYER, date de paiement. Conservation 5 ans.",
      ref:"Art. R3243-1 CT + DÃ©cret 2016-190", tags:['legal','social','ccn'], priorite:'critique', obligatoire:true },

    { cat:'contrats', id:'cont_smic', titre:"Respect du SMIC et des salaires minima CCN",
      desc:"Salaire brut â‰¥ SMIC en vigueur. VÃ©rification rÃ©guliÃ¨re des grilles de salaires de la CCN applicable qui peuvent Ãªtre supÃ©rieures au SMIC.",
      ref:"Art. L3231-2 CT + ArrÃªtÃ©s d'extension CCN", tags:['legal','social','ccn'], priorite:'critique', obligatoire:true },

    { cat:'contrats', id:'cont_heures_sup', titre:"Heures supplÃ©mentaires : majorations et contingent",
      desc:"HS majorÃ©es de 25% (8 premiÃ¨res) puis 50%. Contingent annuel d'HS (220h droit commun, peut varier selon CCN). Contrepartie en repos obligatoire.",
      ref:"Art. L3121-28 CT + CCN applicable", tags:['legal','social','ccn'], priorite:'haute', obligatoire:true },

    { cat:'contrats', id:'cont_egalite_pro', titre:"Index Ã©galitÃ© professionnelle H/F",
      desc:"Calcul et publication de l'Index Ã©galitÃ© H/F avant le 1er mars chaque annÃ©e. Obligatoire â‰¥50 salariÃ©s. Sanctions si < 75/100 sans plan de rattrapage.",
      ref:"Loi 2018-771 + DÃ©cret 2019-15", tags:['legal','social'], priorite:'haute', obligatoire: eff50 },

    { cat:'contrats', id:'cont_entretien_pro', titre:"Entretiens professionnels bisannuels (art. L6315-1)",
      desc:"Entretien professionnel tous les 2 ans. Bilan rÃ©capitulatif tous les 6 ans : 1 action de formation suivie, 1 Ã©lÃ©ment de certification acquis, progression salariale ou professionnelle. Sinon : abondement CPF de 3000â‚¬.",
      ref:"Art. L6315-1 CT", tags:['legal','social','ccn'], priorite:'critique', obligatoire:true },

    { cat:'contrats', id:'cont_mutuelle', titre:"Mutuelle collective obligatoire",
      desc:"Couverture complÃ©mentaire santÃ© collective obligatoire pour tous les salariÃ©s. Part patronale minimum 50%. Cas de dispense possibles (ayant droit, CDD < 3 mois).",
      ref:"Loi ANI 2013 + Art. L911-7 CSS", tags:['legal','social'], priorite:'haute', obligatoire:true },

    { cat:'contrats', id:'cont_participation', titre:"Participation et intÃ©ressement",
      desc:"Participation aux bÃ©nÃ©fices obligatoire â‰¥50 salariÃ©s 3 ans. IntÃ©ressement facultatif mais exonÃ©rations fiscales attractives.",
      ref:"Art. L3321-1 CT", tags:['legal','social'], priorite:'haute', obligatoire: eff50 },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 6. REPRÃ‰SENTATION DU PERSONNEL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    { cat:'representation', id:'rep_cse_election', titre:"Ã‰lections CSE (ComitÃ© Social et Ã‰conomique)",
      desc:"Mise en place du CSE obligatoire â‰¥11 salariÃ©s (pendant 12 mois consÃ©cutifs). Organisation des Ã©lections dans les 90 jours. PV de carence si aucun candidat.",
      ref:"Art. L2311-2 et L2314-1 CT", tags:['legal','social'], priorite:'critique', obligatoire: eff11 },

    { cat:'representation', id:'rep_cse_reunions', titre:"RÃ©unions CSE pÃ©riodiques",
      desc:"â‰¥11 salariÃ©s : au moins 1 rÃ©union/mois. â‰¥50 salariÃ©s : rÃ©unions thÃ©matiques (SSCT, Ã©conomique, ordinaire). PV de chaque rÃ©union.",
      ref:"Art. L2315-27 CT", tags:['legal','social'], priorite:'haute', obligatoire: eff11 },

    { cat:'representation', id:'rep_negociation', titre:"NÃ©gociation annuelle obligatoire (NAO)",
      desc:"NÃ©gociation annuelle sur les salaires, le temps de travail et le partage de la valeur ajoutÃ©e. â‰¥50 salariÃ©s avec dÃ©lÃ©guÃ© syndical.",
      ref:"Art. L2242-1 CT", tags:['legal','social'], priorite:'haute', obligatoire: eff50 },

    { cat:'representation', id:'rep_syndicats', titre:"LibertÃ© syndicale et affichage des communications syndicales",
      desc:"LibertÃ© d'adhÃ©sion syndicale. Panneau d'affichage dÃ©diÃ© aux organisations syndicales. Ne pas entraver l'activitÃ© syndicale.",
      ref:"Art. L2141-1 CT", tags:['legal','social'], priorite:'haute', obligatoire: eff50 },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 7. OBLIGATIONS SOCIALES & DÃ‰CLARATIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    { cat:'social', id:'soc_dpae', titre:"DPAE (DÃ©claration PrÃ©alable Ã  l'Embauche)",
      desc:"DÃ©claration obligatoire auprÃ¨s de l'URSSAF au plus tÃ´t 8 jours avant l'embauche, au plus tard 1 heure avant la prise de poste.",
      ref:"Art. L1221-10 CT", tags:['legal','social'], priorite:'critique', obligatoire:true },

    { cat:'social', id:'soc_dsn', titre:"DSN (DÃ©claration Sociale Nominative) mensuelle",
      desc:"DÃ©claration mensuelle transmise Ã  la CNAV, CPAM, PÃ´le Emploi, URSSAF. DÃ©lai : 5 ou 15 du mois suivant. PÃ©nalitÃ©s en cas de retard.",
      ref:"Art. L133-5-3 CSS", tags:['legal','social'], priorite:'critique', obligatoire:true },

    { cat:'social', id:'soc_urssaf', titre:"Paiement des cotisations URSSAF",
      desc:"Paiement mensuel (ou trimestriel si â‰¤9 salariÃ©s et option choisie) des charges sociales patronales et salariales.",
      ref:"Art. R243-6 CSS", tags:['legal','social'], priorite:'critique', obligatoire:true },

    { cat:'social', id:'soc_retraite_complementaire', titre:"AdhÃ©sion Ã  une caisse de retraite complÃ©mentaire",
      desc:"AdhÃ©sion obligatoire Ã  l'AGIRC-ARRCO pour tous les salariÃ©s du secteur privÃ©. DÃ©claration et paiement des cotisations.",
      ref:"Accord national AGIRC-ARRCO", tags:['legal','social'], priorite:'critique', obligatoire:true },

    { cat:'social', id:'soc_prevoyance_ccn', titre:"PrÃ©voyance collective CCN",
      desc:"Garanties de prÃ©voyance (incapacitÃ©, invaliditÃ©, dÃ©cÃ¨s) imposÃ©es par la convention collective. VÃ©rifier le taux et les bÃ©nÃ©ficiaires selon la CCN.",
      ref:"CCN applicable + Art. L911-2 CSS", tags:['legal','social','ccn'], priorite:'haute', obligatoire:true },

    { cat:'social', id:'soc_1pct_logement', titre:"Participation effort construction (1% patronal)",
      desc:"Participation Ã  l'effort de construction (PEEC) : 0,45% de la masse salariale brute annuelle N-1. Obligatoire â‰¥20 salariÃ©s.",
      ref:"Art. L313-1 CCH", tags:['legal','social'], priorite:'haute',
      obligatoire: effectif !== '1-9' && effectif !== '10-49' },

    { cat:'social', id:'soc_taxe_apprentissage', titre:"Taxe d'apprentissage et contribution formation",
      desc:"Taxe d'apprentissage (0,68% MS) + Contribution Ã  la formation professionnelle (0,55% MS â‰¤10 salariÃ©s, 1% â‰¥11 salariÃ©s). Via DSN.",
      ref:"Art. L6241-1 CT", tags:['legal','social'], priorite:'haute', obligatoire:true },

    { cat:'social', id:'soc_agefiph', titre:"Contribution AGEFIPH / FIPHFP (obligation emploi handicapÃ©)",
      desc:"Si â‰¥20 salariÃ©s et taux d'emploi travailleurs handicapÃ©s < 6% : contribution AGEFIPH. DÃ©claration annuelle DOETH.",
      ref:"Art. L5212-9 CT", tags:['legal','social'], priorite:'haute',
      obligatoire: effectif !== '1-9' && effectif !== '10-49' },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 8. SPÃ‰CIFIQUES PAR SECTEUR / CCN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    { cat:'ccn_specifique', id:'ccn_licenciement_proc', titre:"ProcÃ©dure de licenciement conforme Ã  la CCN",
      desc:"Respecter la procÃ©dure lÃ©gale ET conventionnelle : convocation entretien prÃ©alable, dÃ©lai entre convocation et entretien (5 jours ouvrables), notification par LRAR, dÃ©lai de prÃ©avis CCN.",
      ref:"Art. L1232-2 CT + CCN applicable", tags:['legal','social','ccn'], priorite:'critique', obligatoire:true },

    { cat:'ccn_specifique', id:'ccn_preavis', titre:"PrÃ©avis de rupture conforme Ã  la CCN",
      desc:"Le prÃ©avis applicable est le plus favorable entre la loi et la CCN. VÃ©rifier les durÃ©es par catÃ©gorie (ouvrier, employÃ©, agent de maÃ®trise, cadre).",
      ref:"Art. L1234-1 CT + CCN applicable", tags:['legal','social','ccn'], priorite:'haute', obligatoire:true },

    { cat:'ccn_specifique', id:'ccn_primes', titre:"Primes conventionnelles obligatoires",
      desc:"Prime d'anciennetÃ©, prime de vacances, prime de fin d'annÃ©e prÃ©vues par la CCN. VÃ©rifier l'anciennetÃ© de chaque salariÃ© et les seuils dÃ©clencheurs.",
      ref:"CCN applicable", tags:['social','ccn'], priorite:'haute', obligatoire:true },

    { cat:'ccn_specifique', id:'ccn_classification', titre:"Classification des emplois conforme Ã  la CCN",
      desc:"Chaque salariÃ© doit avoir une classification (coefficient, niveau, Ã©chelon) correspondant Ã  ses fonctions rÃ©elles, conforme Ã  la grille de la CCN.",
      ref:"CCN applicable", tags:['social','ccn'], priorite:'haute', obligatoire:true },

    { cat:'ccn_specifique', id:'ccn_travail_nuit', titre:"Travail de nuit : contreparties lÃ©gales et conventionnelles",
      desc:"Majoration minimum 10% (variable selon CCN). Information du mÃ©decin du travail. BÃ©nÃ©fice d'un suivi mÃ©dical renforcÃ©. Contrepartie en repos.",
      ref:"Art. L3122-7 CT + CCN applicable", tags:['legal','social','ccn'], priorite:'haute',
      obligatoire: ['boulangerie','patisserie','chr','sante','transport_routier','securite'].includes(ccn) },

    { cat:'ccn_specifique', id:'ccn_dimanche', titre:"Travail le dimanche : dÃ©rogations et majorations",
      desc:"Autorisation prÃ©fectorale ou dÃ©rogation de droit selon le secteur. RÃ©munÃ©ration majorÃ©e (minimum 30% ou selon CCN). Volontariat du salariÃ© formalisÃ©.",
      ref:"Art. L3132-12 CT + CCN applicable", tags:['legal','social','ccn'], priorite:'haute',
      obligatoire: ['chr','restauration_rapide','commerce','commerce_alimentaire','grande_distribution','boulangerie'].includes(ccn) },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // 9. NUMÃ‰RIQUE & OUTILS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    { cat:'numerique', id:'num_charte_info', titre:"Charte informatique",
      desc:"Document dÃ©finissant les rÃ¨gles d'utilisation des outils informatiques professionnels (internet, email, tÃ©lÃ©phone, rÃ©seaux sociaux). AnnexÃ©e au rÃ¨glement intÃ©rieur ou remise individuellement.",
      ref:"CNIL + Art. L1222-4 CT", tags:['rgpd','legal'], priorite:'moyenne', obligatoire:false },

    { cat:'numerique', id:'num_teletravail', titre:"Accord ou charte de tÃ©lÃ©travail",
      desc:"Si tÃ©lÃ©travail rÃ©gulier : accord collectif ou charte unilatÃ©rale. Formalisation des modalitÃ©s, prise en charge des frais, Ã©quipements, droit Ã  la dÃ©connexion.",
      ref:"Art. L1222-9 CT + ANI TÃ©lÃ©travail 2020", tags:['legal','social'], priorite:'haute', obligatoire:false },

    { cat:'numerique', id:'num_droit_deconnexion', titre:"Droit Ã  la dÃ©connexion",
      desc:"â‰¥50 salariÃ©s : nÃ©gociation sur les modalitÃ©s du droit Ã  la dÃ©connexion. En l'absence d'accord : charte Ã©laborÃ©e aprÃ¨s avis du CSE.",
      ref:"Art. L2242-17 CT", tags:['legal','social'], priorite:'moyenne', obligatoire: eff50 },

    { cat:'numerique', id:'num_cybersecurite', titre:"Politique de cybersÃ©curitÃ© et sauvegardes",
      desc:"Politique de mots de passe, chiffrement des donnÃ©es sensibles, sauvegardes rÃ©guliÃ¨res, procÃ©dure en cas de violation de donnÃ©es (notification CNIL dans 72h).",
      ref:"Art. 33 RGPD + Guide CNIL TPE/PME", tags:['rgpd','secu'], priorite:'haute', obligatoire:true },

  ];
}

// CatÃ©gories
const CATEGORIES = [
  { id:'affichage',       label:'ğŸ“‹ Affichages obligatoires',        icon:'ğŸ“‹' },
  { id:'registres',       label:'ğŸ“ Registres & Documents',          icon:'ğŸ“' },
  { id:'reglement',       label:'ğŸ“œ RÃ¨glement intÃ©rieur',             icon:'ğŸ“œ' },
  { id:'secu',            label:'ğŸ¦º SantÃ© & SÃ©curitÃ©',                icon:'ğŸ¦º' },
  { id:'rgpd',            label:'ğŸ”’ RGPD & DonnÃ©es',                  icon:'ğŸ”’' },
  { id:'contrats',        label:'ğŸ“„ Contrats & Personnel',            icon:'ğŸ“„' },
  { id:'representation',  label:'ğŸ¤ ReprÃ©sentation du personnel',     icon:'ğŸ¤' },
  { id:'social',          label:'ğŸ’¼ Obligations sociales',            icon:'ğŸ’¼' },
  { id:'ccn_specifique',  label:'âš–ï¸ CCN â€” Obligations spÃ©cifiques',  icon:'âš–ï¸' },
  { id:'numerique',       label:'ğŸ’» NumÃ©rique & Outils',              icon:'ğŸ’»' },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPage() {
  const mc = document.getElementById('main-content');
  const obligations = getObligations();
  const ccn = _params.ccnDefault || 'droit_commun';
  const ccnInfo = CCN_RULES[ccn] || {};
  const empList = Object.values(_employes).filter(e => e.statut !== 'archive');

  // Calcul score global
  const applicables = obligations.filter(o => o.obligatoire);
  const scores = applicables.map(o => {
    const d = _conformiteData[o.id] || {};
    const st = d.statut || 'todo';
    return st === 'ok' ? 1 : st === 'warn' ? 0.5 : st === 'err' ? 0 : st === 'na' ? null : null;
  }).filter(v => v !== null);
  const totalOk = scores.filter(v => v === 1).length;
  const totalWarn = scores.filter(v => v === 0.5).length;
  const totalErr = scores.filter(v => v === 0).length;
  const totalTodo = applicables.filter(o => {
    const st = (_conformiteData[o.id] || {}).statut;
    return !st || st === 'todo';
  }).length;
  const evaluated = scores.length;
  const scorePct = evaluated > 0 ? Math.round((totalOk + totalWarn * 0.5) / applicables.length * 100) : 0;
  const barColor = scorePct >= 80 ? '#34d399' : scorePct >= 50 ? '#fbbf24' : '#f87171';

  // Update topbar subtitle avec CCN
  const tb = document.getElementById('topbar-ccn-sub');
  if (tb) tb.textContent = 'CCN : ' + (ccnInfo.label || 'Code du travail') + (ccnInfo.idcc ? ' (IDCC '+ccnInfo.idcc+')' : '') + ' Â· ' + empList.length + ' salariÃ©(s)';

  // Badges par catÃ©gorie
  function catBadge(catId) {
    const items = obligations.filter(o => o.cat === catId && o.obligatoire);
    if (!items.length) return '';
    const errs = items.filter(o => (_conformiteData[o.id]||{}).statut === 'err').length;
    const warns = items.filter(o => (_conformiteData[o.id]||{}).statut === 'warn').length;
    const oks = items.filter(o => (_conformiteData[o.id]||{}).statut === 'ok').length;
    if (errs) return `<span class="conf-nav-badge badge-err">${errs} âŒ</span>`;
    if (warns) return `<span class="conf-nav-badge badge-warn">${warns} âš ï¸</span>`;
    if (oks === items.length) return `<span class="conf-nav-badge badge-ok">âœ“</span>`;
    return `<span class="conf-nav-badge badge-info">${items.length - oks} â†’</span>`;
  }

  mc.innerHTML = `
  <div style="display:flex;gap:20px;align-items:flex-start;width:100%">

    <!-- NAV GAUCHE -->
    <div class="left-nav">
      <div class="conf-nav">
        <div class="conf-nav-head">Rubriques</div>
        ${CATEGORIES.map(c => `
          <div class="conf-nav-item ${_currentSection===c.id?'active':''}" id="nav-${c.id}" onclick="scrollToSection('${c.id}')">
            <span class="conf-nav-icon">${c.icon}</span>
            <span>${c.label.replace(/^.+ /,'')}</span>
            ${catBadge(c.id)}
          </div>`).join('')}
      </div>

      <!-- SYNTHÃˆSE EMPLOYÃ‰S -->
      <div class="conf-nav" style="margin-top:12px">
        <div class="conf-nav-head">ğŸ‘¥ SalariÃ©s (${empList.length})</div>
        <div style="padding:8px 10px;max-height:280px;overflow-y:auto">
          ${empList.length === 0
            ? '<div style="font-size:11px;color:var(--muted);padding:8px;text-align:center">Aucun salariÃ©</div>'
            : empList.slice(0,12).map(e => {
                const COLORS=['#059669','#3b82f6','#8b5cf6','#f59e0b','#ef4444','#14b8a6'];
                const ci = (e.prenom||'A').charCodeAt(0) % COLORS.length;
                const init = ((e.prenom||'')[0]||'').toUpperCase() + ((e.nom||'')[0]||'').toUpperCase();
                const manquants = getManquantsSalarie(e);
                return `<div class="emp-conf-item">
                  <div class="emp-avatar" style="background:${COLORS[ci]}">${init}</div>
                  <div style="flex:1;min-width:0">
                    <div class="emp-conf-name">${e.prenom||''} ${e.nom||''}</div>
                    <div class="emp-conf-poste">${e.poste||'â€”'}</div>
                  </div>
                  ${manquants > 0
                    ? `<span class="oblig-tag tag-secu" style="font-size:9px">${manquants} doc.</span>`
                    : `<span style="font-size:12px">âœ…</span>`}
                </div>`;
              }).join('') +
              (empList.length > 12 ? `<div style="font-size:10px;color:var(--muted);text-align:center;padding:4px">+ ${empList.length-12} autres</div>` : '')
          }
        </div>
      </div>
    </div>

    <!-- CONTENU DROIT -->
    <div class="right-content" id="right-content">

      <!-- SCORE GLOBAL -->
      <div class="score-banner">
        <div class="score-circle">
          <div class="score-num" style="color:${barColor}">${scorePct}</div>
          <div class="score-denom">/ 100</div>
        </div>
        <div class="score-info">
          <div class="score-title">Score de conformitÃ© RH</div>
          <div class="score-sub">${applicables.length} obligations applicables Â· ${empList.length} salariÃ©(s)</div>
          <div class="score-bar-wrap">
            <div class="score-bar-fill" style="width:${scorePct}%;background:${barColor}"></div>
          </div>
          <div class="score-kpis">
            <div class="score-kpi"><div class="score-kpi-val" style="color:#34d399">${totalOk}</div><div class="score-kpi-lbl">Conformes</div></div>
            <div class="score-kpi"><div class="score-kpi-val" style="color:#fbbf24">${totalWarn}</div><div class="score-kpi-lbl">Ã€ amÃ©liorer</div></div>
            <div class="score-kpi"><div class="score-kpi-val" style="color:#f87171">${totalErr}</div><div class="score-kpi-lbl">Non conf.</div></div>
            <div class="score-kpi"><div class="score-kpi-val" style="color:rgba(255,255,255,.5)">${totalTodo}</div><div class="score-kpi-lbl">Ã€ Ã©valuer</div></div>
          </div>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div style="font-size:10px;color:rgba(255,255,255,.4);margin-bottom:6px">Convention collective</div>
          <div style="font-size:12px;font-weight:700;color:white">${ccnInfo.label||'Code du travail'}</div>
          ${ccnInfo.idcc ? `<div style="font-size:10px;color:rgba(255,255,255,.5)">IDCC ${ccnInfo.idcc}</div>` : ''}
          <div style="font-size:10px;color:rgba(255,255,255,.4);margin-top:8px">${empList.length} salariÃ©(s) actif(s)</div>
        </div>
      </div>

      <!-- CALENDRIER DES OBLIGATIONS RÃ‰CURRENTES -->
      <div class="conf-section" id="section-calendrier">
        <div class="conf-section-head" onclick="toggleSection('calendrier')">
          <div class="conf-section-title">ğŸ“… Calendrier des obligations rÃ©currentes</div>
          <div class="conf-section-meta">
            <span style="font-size:11px;color:var(--muted)">Actions Ã  planifier dans l'annÃ©e</span>
            <span class="chevron open" id="chev-calendrier">â€º</span>
          </div>
        </div>
        <div class="conf-section-body" id="body-calendrier">
          ${renderCalendrier(ccn)}
        </div>
      </div>

      <!-- SECTIONS PAR CATÃ‰GORIE -->
      ${CATEGORIES.map(cat => {
        const items = obligations.filter(o => o.cat === cat.id);
        if (!items.length) return '';
        const applicable = items.filter(o => o.obligatoire);
        const nonApp = items.filter(o => !o.obligatoire);
        return `
          <div class="conf-section" id="section-${cat.id}">
            <div class="conf-section-head" onclick="toggleSection('${cat.id}')">
              <div class="conf-section-title">${cat.label}</div>
              <div class="conf-section-meta">
                ${renderCatSummary(applicable)}
                <span class="chevron open" id="chev-${cat.id}">â€º</span>
              </div>
            </div>
            <div class="conf-section-body" id="body-${cat.id}">
              ${applicable.map(o => renderObligation(o)).join('')}
              ${nonApp.length > 0 ? `
                <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;padding:8px 0 4px;margin-top:6px;border-top:1px solid var(--border)">
                  RecommandÃ© / conditionnel
                </div>
                ${nonApp.map(o => renderObligation(o)).join('')}
              ` : ''}
            </div>
          </div>`;
      }).join('')}

      <!-- SYNTHÃˆSE PAR SALARIÃ‰ -->
      <div class="conf-section" id="section-salaries">
        <div class="conf-section-head" onclick="toggleSection('salaries')">
          <div class="conf-section-title">ğŸ‘¥ ConformitÃ© par salariÃ©</div>
          <div class="conf-section-meta">
            <span style="font-size:11px;color:var(--muted)">${empList.length} salariÃ©(s)</span>
            <span class="chevron open" id="chev-salaries">â€º</span>
          </div>
        </div>
        <div class="conf-section-body" id="body-salaries">
          ${renderSalariesConformite(empList)}
        </div>
      </div>

    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER OBLIGATION ITEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderObligation(o) {
  const d = _conformiteData[o.id] || {};
  const statut = d.statut || (o.obligatoire ? 'todo' : 'na');
  const checkIcons = { ok:'âœ“', warn:'âš ', err:'âœ•', na:'â€”', todo:'?' };
  const checkClasses = { ok:'check-ok', warn:'check-warn', err:'check-err', na:'check-na', todo:'check-todo' };
  const itemClasses = { ok:'ok', warn:'warn', err:'err', na:'na', todo:'' };

  const tagHtml = o.tags.map(t => `<span class="oblig-tag tag-${t}">${{legal:'âš–ï¸ LÃ©gal',rgpd:'ğŸ”’ RGPD',social:'ğŸ‘¥ Social',secu:'ğŸ¦º SÃ©curitÃ©',hygiene:'ğŸ½ï¸ HygiÃ¨ne',ccn:'ğŸ“‹ CCN',btp:'ğŸ—ï¸ BTP',eff:'ğŸ¢ Effectif'}[t]||t}</span>`).join(' ');

  const prioHtml = o.priorite === 'critique'
    ? '<span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:8px;background:#fee2e2;color:#991b1b">CRITIQUE</span>'
    : '';

  return `<div class="oblig-item ${itemClasses[statut]||''}" id="item-${o.id}">
    <div class="oblig-check ${checkClasses[statut]}">${checkIcons[statut]}</div>
    <div class="oblig-content">
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">
        <div class="oblig-title">${o.titre}</div>
        ${prioHtml}
        ${!o.obligatoire ? '<span style="font-size:9px;font-weight:700;padding:2px 6px;border-radius:8px;background:#f1f5f9;color:#64748b">RecommandÃ©</span>' : ''}
      </div>
      <div class="oblig-desc">${o.desc}</div>
      <div class="oblig-ref">ğŸ“Œ ${o.ref}</div>
      ${d.note ? `<div style="margin-top:6px;padding:6px 8px;background:#f8faff;border-radius:6px;font-size:11px;color:var(--text);border-left:3px solid var(--rh-main)">ğŸ’¬ ${d.note}</div>` : ''}
      ${d.echeance ? `<div style="font-size:10px;color:var(--amber);margin-top:4px;font-weight:600">â° Ã‰chÃ©ance : ${new Date(d.echeance).toLocaleDateString('fr-FR')}</div>` : ''}
      <div style="display:flex;align-items:center;gap:8px;margin-top:8px;flex-wrap:wrap">
        <div style="display:flex;gap:4px">
          ${['ok','warn','err','na'].map(s => `
            <button class="status-btn sb-${s} ${statut===s?'active':''}" onclick="setStatut('${o.id}','${s}')">
              ${{ok:'âœ… OK',warn:'âš ï¸ Partiel',err:'âŒ KO',na:'â€” N/A'}[s]}
            </button>`).join('')}
        </div>
        <button class="btn btn-outline btn-xs" onclick="openModalNote('${o.id}','${o.titre.replace(/'/g,"\\'")}')">ğŸ’¬ Note</button>
        ${tagHtml}
      </div>
    </div>
  </div>`;
}

function renderCatSummary(items) {
  if (!items.length) return '';
  const errs = items.filter(o => (_conformiteData[o.id]||{}).statut === 'err').length;
  const warns = items.filter(o => (_conformiteData[o.id]||{}).statut === 'warn').length;
  const oks = items.filter(o => (_conformiteData[o.id]||{}).statut === 'ok').length;
  return `<span style="font-size:11px;color:var(--muted)">${oks}âœ… ${warns}âš ï¸ ${errs}âŒ</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALENDRIER OBLIGATIONS RÃ‰CURRENTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCalendrier(ccn) {
  const cal = {
    '01':['DSN paie dÃ©cembre (15/01)','Taxe apprentissage (solde)'],
    '02':['DSN janvier','Index Ã©galitÃ© H/F â‰¥50 sal. (avant 01/03)'],
    '03':['DSN fÃ©vrier','NAO â€” compte-rendu sinon PV carence'],
    '04':['DSN mars','Bilan DUER annuel','VÃ©rification extincteurs'],
    '05':['DSN avril','VÃ©rification contrats CDD (durÃ©e max)'],
    '06':['DSN mai','Exercice Ã©vacuation incendie','Visite mÃ©decin travail (planning)'],
    '07':['DSN juin','Bilan entretiens professionnels (6 ans)'],
    '08':['DSN juillet','VÃ©rification habilitations Ã©lectriques BTP'],
    '09':['DSN aoÃ»t','Plan de formation N+1 (prÃ©sentation CSE â‰¥50)'],
    '10':['DSN septembre','Renouvellement carte pro BTP si applicable'],
    '11':['DSN octobre','Convocation CSE pour budget Å“uvres sociales â‰¥50','DOETH (emploi handicapÃ©) â‰¥20 sal.'],
    '12':['DSN novembre','ClÃ´ture PEEC (1% logement)','PrÃ©parer N1 : taxe apprentissage'],
  };
  const months = ['Jan','FÃ©v','Mar','Avr','Mai','Jun','Jul','AoÃ»','Sep','Oct','Nov','DÃ©c'];
  const colors = ['#dbeafe','#dcfce7','#fef3c7','#fee2e2'];

  return `<div class="cal-grid">${Object.entries(cal).map(([m, items], idx) => `
    <div class="cal-month">
      <div class="cal-month-label">${months[parseInt(m)-1]}</div>
      <div class="cal-items">
        ${items.map((item, i) => `<div class="cal-item" style="background:${colors[i%colors.length]};color:#374151">${item}</div>`).join('')}
      </div>
    </div>`).join('')}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFORMITÃ‰ PAR SALARIÃ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getManquantsSalarie(e) {
  const docsRequis = ['cni','rib','vitale','contrat'];
  return docsRequis.filter(d => {
    const docs = e.documents || [];
    return !docs.some(doc => doc.type === d);
  }).length;
}

function renderSalariesConformite(empList) {
  if (!empList.length) return '<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">Aucun salariÃ© actif.</div>';

  const checks = [
    { id:'visite', label:'Visite mÃ©dicale', check: e => (e.prochaineSuiviMedical || e.dateVisiteMedicale) ? 'ok' : 'warn' },
    { id:'contrat', label:'Contrat', check: e => (e.documents||[]).some(d=>d.type==='contrat') ? 'ok' : 'err' },
    { id:'rib', label:'RIB', check: e => (e.documents||[]).some(d=>d.type==='rib') ? 'ok' : 'warn' },
    { id:'cni', label:'PiÃ¨ce ID', check: e => (e.documents||[]).some(d=>d.type==='cni') ? 'ok' : 'warn' },
    { id:'mutuelle', label:'Mutuelle', check: e => e.mutuelle ? 'ok' : 'warn' },
    { id:'entretien', label:'Entretien pro', check: e => {
        if (!e.derniereEmbauche) return 'warn';
        const embauche = new Date(e.derniereEmbauche);
        const now = new Date();
        const years = (now - embauche) / (365.25 * 24 * 3600 * 1000);
        return years < 2 ? 'ok' : (years < 3 ? 'warn' : 'err');
      }
    },
  ];

  const statIcons = { ok:'âœ…', warn:'âš ï¸', err:'âŒ' };

  return `
    <div style="overflow-x:auto">
      <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:600px">
        <thead>
          <tr style="background:var(--rh-ghost)">
            <th style="padding:8px 12px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--border)">SalariÃ©</th>
            ${checks.map(c=>`<th style="padding:8px 10px;text-align:center;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--border)">${c.label}</th>`).join('')}
            <th style="padding:8px 10px;text-align:center;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;border-bottom:1px solid var(--border)">Fiche</th>
          </tr>
        </thead>
        <tbody>
          ${empList.map(e => {
            const COLORS=['#059669','#3b82f6','#8b5cf6','#f59e0b','#ef4444','#14b8a6'];
            const ci = (e.prenom||'A').charCodeAt(0) % COLORS.length;
            const init = ((e.prenom||'')[0]||'').toUpperCase()+((e.nom||'')[0]||'').toUpperCase();
            return `<tr style="border-bottom:1px solid #f1f5f9">
              <td style="padding:8px 12px">
                <div style="display:flex;align-items:center;gap:8px">
                  <div style="width:24px;height:24px;border-radius:6px;background:${COLORS[ci]};display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:white;flex-shrink:0">${init}</div>
                  <div>
                    <div style="font-weight:600">${e.prenom||''} ${e.nom||''}</div>
                    <div style="font-size:10px;color:var(--muted)">${e.poste||'â€”'}</div>
                  </div>
                </div>
              </td>
              ${checks.map(c => {
                const st = c.check(e);
                return `<td style="text-align:center;padding:8px 10px;font-size:14px">${statIcons[st]||'â€”'}</td>`;
              }).join('')}
              <td style="text-align:center;padding:8px 10px">
                <a href="rh-employes.html" style="font-size:10px;color:var(--rh-main);font-weight:700;text-decoration:none">â†’ Fiche</a>
              </td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>
    <div style="margin-top:12px;font-size:11px;color:var(--muted);padding:8px 10px;background:#f8faff;border-radius:8px;border:1px solid var(--border)">
      ğŸ’¡ <b>Visite mÃ©dicale</b> : Ã  planifier dans les 3 mois suivant l'embauche puis selon le suivi dÃ©fini. <b>Entretien professionnel</b> : obligatoire tous les 2 ans (art. L6315-1 CT).
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatut(itemId, statut) {
  if (!_conformiteData[itemId]) _conformiteData[itemId] = {};
  _conformiteData[itemId].statut = statut;
  // Mettre Ã  jour l'item visuellement
  const item = document.getElementById('item-' + itemId);
  if (!item) return;
  const checkIcons = { ok:'âœ“', warn:'âš ', err:'âœ•', na:'â€”', todo:'?' };
  const checkCls = { ok:'check-ok', warn:'check-warn', err:'check-err', na:'check-na', todo:'check-todo' };
  const itemCls = { ok:'ok', warn:'warn', err:'err', na:'na', todo:'' };
  const check = item.querySelector('.oblig-check');
  if (check) { check.textContent = checkIcons[statut]; check.className = 'oblig-check ' + (checkCls[statut]||''); }
  item.className = 'oblig-item ' + (itemCls[statut]||'');
  // Mettre Ã  jour les boutons
  item.querySelectorAll('.status-btn').forEach(btn => {
    btn.classList.toggle('active', btn.textContent.includes({ok:'OK',warn:'Partiel',err:'KO',na:'N/A'}[statut]||''));
  });
  scheduleAutoSave();
}

var _autoSaveTimer = null;
function scheduleAutoSave() {
  clearTimeout(_autoSaveTimer);
  _autoSaveTimer = setTimeout(() => saveAll(true), 2000);
}

async function saveAll(silent) {
  if (!window._uid) return;
  try {
    await window._setDoc(
      window._doc(window._db, 'rh_params', window._uid + '_conformite'),
      Object.assign({}, _conformiteData, { updatedAt: new Date().toISOString() }),
      { merge: true }
    );
    if (!silent) showToast('âœ… DonnÃ©es de conformitÃ© sauvegardÃ©es', 'ok');
  } catch(e) {
    showToast('Erreur : ' + e.message, 'err');
  }
}

// Modal note
var _modalItemTitle = '';
function openModalNote(itemId, titre) {
  _modalItemId = itemId;
  _modalItemTitle = titre;
  const d = _conformiteData[itemId] || {};
  document.getElementById('modal-note-title').textContent = 'ğŸ“ ' + titre;
  document.getElementById('mn-status').value = d.statut || 'ok';
  document.getElementById('mn-note').value = d.note || '';
  document.getElementById('mn-echeance').value = d.echeance || '';
  document.getElementById('modal-note').classList.add('show');
}

function closeModalNote() {
  document.getElementById('modal-note').classList.remove('show');
  _modalItemId = null;
}

function saveNote() {
  if (!_modalItemId) return;
  if (!_conformiteData[_modalItemId]) _conformiteData[_modalItemId] = {};
  const statut = document.getElementById('mn-status').value;
  const note = document.getElementById('mn-note').value.trim();
  const echeance = document.getElementById('mn-echeance').value;
  _conformiteData[_modalItemId].statut = statut;
  if (note) _conformiteData[_modalItemId].note = note;
  else delete _conformiteData[_modalItemId].note;
  if (echeance) _conformiteData[_modalItemId].echeance = echeance;
  else delete _conformiteData[_modalItemId].echeance;
  closeModalNote();
  // Re-render l'item
  const o = getObligations().find(x => x.id === _modalItemId);
  if (o) {
    const container = document.getElementById('item-' + _modalItemId);
    if (container) container.outerHTML = renderObligation(o);
  }
  scheduleAutoSave();
}

function toggleSection(id) {
  const body = document.getElementById('body-' + id);
  const chev = document.getElementById('chev-' + id);
  if (!body) return;
  body.classList.toggle('collapsed');
  if (chev) chev.classList.toggle('open', !body.classList.contains('collapsed'));
}

function scrollToSection(id) {
  _currentSection = id;
  const el = document.getElementById('section-' + id);
  if (el) el.scrollIntoView({ behavior:'smooth', block:'start' });
  document.querySelectorAll('.conf-nav-item').forEach(item => item.classList.remove('active'));
  const nav = document.getElementById('nav-' + id);
  if (nav) nav.classList.add('active');
}

// Sidebar mobile
function toggleSidebar() {
  document.querySelector('.sidebar')?.classList.toggle('open');
  document.getElementById('nav-overlay')?.classList.toggle('show');
}
function closeSidebar() {
  document.querySelector('.sidebar')?.classList.remove('open');
  document.getElementById('nav-overlay')?.classList.remove('show');
}

function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + (type||'');
  setTimeout(() => t.className = 'toast', 3200);
}

window.saveAll = saveAll;
window.setStatut = setStatut;
window.openModalNote = openModalNote;
window.closeModalNote = closeModalNote;
window.saveNote = saveNote;
window.toggleSection = toggleSection;
window.scrollToSection = scrollToSection;
window.toggleSidebar = toggleSidebar;
window.closeSidebar = closeSidebar;
</script>

<script src="nav.js"></script>
</body>
</html>
