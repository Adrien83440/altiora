<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>ALTEORE ‚Äî Gestion des Stocks</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --nav:#0f1f5c;--blue:#1a3dce;--blue2:#4f7ef8;--bg:#f4f6fb;
  --border:#e2e8f0;--text:#1a1f36;--muted:#6b7280;
  --green:#10b981;--red:#ef4444;--orange:#f59e0b;--purple:#6366f1;
  --yellow:#fbbf24;--radius:14px;--sw:250px;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px}
main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column;min-width:0}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;gap:12px}
.topbar h1{font-size:16px;font-weight:700}
.topbar p{font-size:11px;color:var(--muted)}
.tb-r{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:5px}
.btn-p{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;box-shadow:0 3px 10px rgba(26,61,206,.2)}
.btn-p:hover{opacity:.9;transform:translateY(-1px)}
.btn-o{background:#fff;color:var(--blue);border:1.5px solid var(--border)}
.btn-o:hover{border-color:var(--blue2)}
.btn-d{background:#fef2f2;color:var(--red);border:1px solid #fecaca}
.btn-g{background:#f0fdf4;color:var(--green);border:1px solid #bbf7d0}
.btn-xs{padding:4px 9px;font-size:11px}
.badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;vertical-align:middle;white-space:nowrap}
.badge-green{background:#d1fae5;color:#065f46}
.badge-orange{background:#fef3c7;color:#92400e}
.badge-red{background:#fee2e2;color:#b91c1c}
.badge-blue{background:#dbeafe;color:#1d4ed8}
.badge-purple{background:#ede9fe;color:#5b21b6}
.toast{position:fixed;bottom:18px;right:18px;padding:10px 16px;border-radius:9px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(60px);opacity:0;transition:.3s;pointer-events:none}
.toast.show{transform:translateY(0);opacity:1}
.toast-ok{background:#1a1f36;color:#fff}
.toast-err{background:#ef4444;color:#fff}

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
.content{padding:20px 24px;display:flex;flex-direction:column;gap:18px}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs{display:flex;gap:6px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:5px;width:fit-content}
.tab{padding:7px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;color:var(--muted);transition:.15s;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;white-space:nowrap}
.tab.on{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;box-shadow:0 2px 8px rgba(26,61,206,.25)}

/* ‚îÄ‚îÄ KPI ROW ‚îÄ‚îÄ */
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
.kpi-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;transition:.15s}
.kpi-card:hover{border-color:#c7d2fe;box-shadow:0 3px 10px rgba(79,126,248,.08)}
.kpi-icon{font-size:18px;margin-bottom:6px}
.kpi-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px}
.kpi-val{font-size:20px;font-weight:800;color:var(--text);line-height:1}
.kpi-sub{font-size:10px;color:var(--muted);margin-top:3px}
.kpi-card.alert-card{border-color:#fde68a;background:#fffbeb}
.kpi-card.rupture-card{border-color:#fecaca;background:#fef2f2}
.kpi-card.ok-card{border-color:#bbf7d0;background:#f0fdf4}

/* ‚îÄ‚îÄ SECTION CARD ‚îÄ‚îÄ */
.section-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.section-head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);gap:12px;flex-wrap:wrap}
.section-head h2{font-size:13px;font-weight:700;color:var(--text)}
.section-head p{font-size:11px;color:var(--muted)}
.section-body{padding:16px 18px}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-wrap{overflow-x:auto;border-radius:10px;border:1px solid var(--border)}
table{width:100%;border-collapse:collapse;min-width:600px}
thead th{background:#f8faff;padding:10px 12px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);white-space:nowrap;position:sticky;top:0}
thead th.num{text-align:right}
tbody td{padding:10px 12px;border-bottom:1px solid #f1f5f9;font-size:12.5px;vertical-align:middle}
tbody tr:last-child td{border-bottom:none}
tbody tr:hover td{background:#f8faff}
td.num{text-align:right;font-weight:600}
td.muted{color:var(--muted)}
.empty-row td{text-align:center;color:var(--muted);padding:32px;font-style:italic}

/* ‚îÄ‚îÄ INPUTS INLINE ‚îÄ‚îÄ */
.in-input{width:100%;min-width:80px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;color:var(--text);background:#fff;outline:none;transition:.15s}
.in-input:focus{border-color:var(--blue2);box-shadow:0 0 0 3px rgba(79,126,248,.1)}
.in-input[type=number]{text-align:right}
.in-select{width:100%;min-width:100px;padding:6px 8px;border:1px solid var(--border);border-radius:7px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;color:var(--text);background:#fff;outline:none;cursor:pointer}
.in-select:focus{border-color:var(--blue2)}

/* ‚îÄ‚îÄ CHARTS GRID ‚îÄ‚îÄ */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.chart-card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:16px}
.chart-title{font-size:12px;font-weight:700;color:var(--text);margin-bottom:12px;display:flex;align-items:center;gap:6px}
.chart-wrap{position:relative;height:220px}

/* ‚îÄ‚îÄ SYNTH LIST ‚îÄ‚îÄ */
.synth-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.synth-box{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:14px}
.synth-box-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.synth-item{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-radius:8px;background:#f8faff;border:1px solid var(--border);margin-bottom:6px;gap:8px}
.synth-item:last-child{margin-bottom:0}
.synth-item-left{display:flex;flex-direction:column;gap:2px;min-width:0}
.synth-item-name{font-size:12px;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.synth-item-sub{font-size:10px;color:var(--muted)}
.no-items{text-align:center;color:var(--muted);padding:20px;font-size:12px;font-style:italic}

/* ‚îÄ‚îÄ PROGRESS BAR ‚îÄ‚îÄ */
.prog-wrap{background:#f1f5f9;border-radius:99px;height:6px;overflow:hidden;min-width:60px}
.prog-fill{height:100%;border-radius:99px;transition:width .5s ease}

/* ‚îÄ‚îÄ OVERLAY / MODAL ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(15,31,92,.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:20px;padding:28px;max-width:560px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 24px 60px rgba(0,0,0,.2)}
.modal-title{font-size:16px;font-weight:800;margin-bottom:20px;display:flex;align-items:center;gap:8px}
.mfield{margin-bottom:14px}
.mfield label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;display:block;margin-bottom:5px}
.mfield-wrap{display:flex;align-items:center;gap:8px;padding:9px 13px;border:1.5px solid var(--border);border-radius:10px;background:#f8faff;transition:.15s}
.mfield-wrap:focus-within{border-color:var(--blue2);background:#fff;box-shadow:0 0 0 3px rgba(79,126,248,.1)}
.mfield-in{flex:1;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;color:var(--text);outline:none}
.mfield-sel{flex:1;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;color:var(--text);outline:none;cursor:pointer}
.mfield-unit{font-size:13px;font-weight:700;color:var(--muted)}
.mgrid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}

/* ‚îÄ‚îÄ SEARCH & FILTER BAR ‚îÄ‚îÄ */
.filter-bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.search-wrap{position:relative;flex:1;min-width:180px}
.search-wrap input{width:100%;padding:8px 12px 8px 32px;border:1.5px solid var(--border);border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12.5px;font-weight:500;color:var(--text);outline:none;transition:.15s;background:#fff}
.search-wrap input:focus{border-color:var(--blue2);box-shadow:0 0 0 3px rgba(79,126,248,.1)}
.search-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:13px;pointer-events:none}
.filter-sel{padding:8px 10px;border:1.5px solid var(--border);border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;color:var(--text);background:#fff;outline:none;cursor:pointer}
.filter-sel:focus{border-color:var(--blue2)}

/* ‚îÄ‚îÄ PANE ‚îÄ‚îÄ */
.pane{display:none}.pane.on{display:flex;flex-direction:column;gap:18px}

/* ‚îÄ‚îÄ VALO TABLE ‚îÄ‚îÄ */
.valo-total-row{background:linear-gradient(135deg,#eff6ff,#f0fdf4);border-top:2px solid var(--border)!important}
.valo-total-row td{font-weight:800!important;font-size:13px!important}

/* ‚îÄ‚îÄ STOCK STATUS INDICATOR ‚îÄ‚îÄ */
.stock-bar-wrap{display:flex;align-items:center;gap:6px;min-width:100px}

/* ‚îÄ‚îÄ MOUVEMENT TYPE ‚îÄ‚îÄ */
.mov-in{color:#059669;font-weight:700;background:#d1fae5;padding:3px 8px;border-radius:5px;font-size:11px}
.mov-out{color:#dc2626;font-weight:700;background:#fee2e2;padding:3px 8px;border-radius:5px;font-size:11px}

/* ‚îÄ‚îÄ AUTOCOMPLETE FOURNISSEUR ‚îÄ‚îÄ */
.sugg-wrap{position:relative}
.sugg-list{
  display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;z-index:500;
  background:#fff;border:1.5px solid var(--blue2);border-radius:10px;
  box-shadow:0 8px 24px rgba(26,61,206,.15);max-height:220px;overflow-y:auto;
}
.sugg-list.show{display:block}
.sugg-item{
  padding:9px 12px;font-size:13px;font-weight:600;cursor:pointer;
  color:var(--text);transition:.1s;display:flex;align-items:center;gap:8px;
  border-bottom:1px solid #f1f5f9;
}
.sugg-item:last-child{border-bottom:none}
.sugg-item:hover,.sugg-item.focused{background:#eff6ff;color:var(--blue)}
.sugg-item-empty{padding:10px 12px;font-size:12px;color:var(--muted);font-style:italic}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MOBILE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
html,body{overflow-x:hidden;max-width:100vw}
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:#0f1f5c;border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(15,31,92,.45);-webkit-tap-highlight-color:transparent}
.hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;pointer-events:none}
.hamburger.open span:nth-child(1){transform:translateY(7.5px) rotate(45deg)}
.hamburger.open span:nth-child(2){opacity:0;transform:scaleX(0)}
.hamburger.open span:nth-child(3){transform:translateY(-7.5px) rotate(-45deg)}
.nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000}
.nav-overlay.show{display:block}
@media(max-width:768px){
  .hamburger{display:flex!important}
  main{margin-left:0!important;width:100vw!important}
  .topbar{padding:10px 10px 10px 62px!important;flex-wrap:wrap!important;gap:6px!important}
  .topbar h1{font-size:14px!important}
  .tb-r{width:100%!important;flex-wrap:wrap!important}
  .tb-r .btn{flex:1 1 auto!important;font-size:11px!important;padding:7px 8px!important}
  .content{padding:12px 10px!important;gap:12px!important}
  .kpi-row{grid-template-columns:1fr 1fr!important;gap:8px!important}
  .charts-grid{grid-template-columns:1fr!important;gap:10px!important}
  .synth-grid{grid-template-columns:1fr!important;gap:10px!important}
  .mgrid2{grid-template-columns:1fr!important}
  .tabs{overflow-x:auto!important;flex-wrap:nowrap!important;width:100%!important}
  .tab{flex-shrink:0!important}
  table{min-width:460px!important;font-size:11px!important}
  input,select,textarea{font-size:16px!important;-webkit-appearance:none!important}
  .overlay{align-items:flex-end!important;padding:0!important}
  .modal{width:100%!important;max-width:100%!important;border-radius:18px 18px 0 0!important;max-height:92vh!important}
  canvas{max-width:100%!important}
  .filter-bar{flex-direction:column!important;align-items:stretch!important}
  .search-wrap{min-width:0!important}
}
@media(max-width:420px){
  .kpi-row{grid-template-columns:1fr!important}
}
</style>
</head>
<body>

<button class="hamburger" id="hamburger" onclick="window.alteoreToggleSidebar&&window.alteoreToggleSidebar()" aria-label="Menu">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="navOverlay" onclick="window.alteoreCloseSidebar&&window.alteoreCloseSidebar()"></div>

<main>
  <div class="topbar">
    <div>
      <h1>üì¶ Gestion des Stocks</h1>
      <p>Produits ¬∑ Mouvements ¬∑ Valorisation ¬∑ Synth√®se</p>
    </div>
    <div class="tb-r">
      <button class="btn btn-o" onclick="location.href='dashboard.html'">‚Üê Dashboard</button>
      <button class="btn btn-o" id="btn-export-pdf" onclick="exportPDF()">üñ®Ô∏è Export PDF</button>
      <button class="btn btn-p" onclick="openProdModal()">+ Ajouter produit</button>
    </div>
  </div>

  <div class="content">

    <!-- KPI ROW -->
    <div class="kpi-row" id="kpiRow">
      <div class="kpi-card ok-card">
        <div class="kpi-icon">üì¶</div>
        <div class="kpi-lbl">R√©f√©rences actives</div>
        <div class="kpi-val" id="kpiRefs">0</div>
        <div class="kpi-sub" id="kpiRefsub">‚Äî</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üí∞</div>
        <div class="kpi-lbl">Valeur stock (PA)</div>
        <div class="kpi-val" id="kpiValeur">0 ‚Ç¨</div>
        <div class="kpi-sub">au co√ªt d'achat</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-icon">üìà</div>
        <div class="kpi-lbl">Marge potentielle</div>
        <div class="kpi-val" id="kpiMarge">0 ‚Ç¨</div>
        <div class="kpi-sub" id="kpiMargePct">‚Äî</div>
      </div>
      <div class="kpi-card alert-card" id="kpiAlertCard">
        <div class="kpi-icon">‚ö†Ô∏è</div>
        <div class="kpi-lbl">En alerte seuil</div>
        <div class="kpi-val" id="kpiAlerts">0</div>
        <div class="kpi-sub">√† r√©approvisionner</div>
      </div>
      <div class="kpi-card rupture-card" id="kpiRuptureCard">
        <div class="kpi-icon">üö®</div>
        <div class="kpi-lbl">En rupture</div>
        <div class="kpi-val" id="kpiRupture">0</div>
        <div class="kpi-sub">stock = 0</div>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
      <button class="tab on" data-tab="produits" onclick="switchTab('produits')">üì¶ Produits</button>
      <button class="tab" data-tab="mouvements" onclick="switchTab('mouvements')">üîÑ Mouvements</button>
      <button class="tab" data-tab="valorisation" onclick="switchTab('valorisation')">üí∞ Valorisation</button>
      <button class="tab" data-tab="graphiques" onclick="switchTab('graphiques')">üìä Graphiques</button>
      <button class="tab" data-tab="synthese" onclick="switchTab('synthese')">üéØ Synth√®se</button>
    </div>

    <!-- ‚ïê‚ïê‚ïê PANE PRODUITS ‚ïê‚ïê‚ïê -->
    <div class="pane on" id="pane-produits">
      <div class="section-card">
        <div class="section-head">
          <div>
            <h2>Stock produits</h2>
            <p>G√©rez vos r√©f√©rences ‚Äî PA, PV, seuils et statuts calcul√©s en temps r√©el</p>
          </div>
          <div class="filter-bar" style="gap:8px">
            <div class="search-wrap" style="min-width:200px">
              <span class="search-icon">üîç</span>
              <input type="text" id="searchProd" placeholder="Rechercher r√©f, nom, cat√©gorie‚Ä¶" oninput="renderProducts()">
            </div>
            <select class="filter-sel" id="filterStatut" onchange="renderProducts()">
              <option value="">Tous statuts</option>
              <option value="ok">‚úÖ OK</option>
              <option value="alerte">‚ö†Ô∏è Alerte</option>
              <option value="rupture">üö® Rupture</option>
            </select>
            <select class="filter-sel" id="filterCat" onchange="renderProducts()">
              <option value="">Toutes cat√©gories</option>
            </select>
            <button class="btn btn-p btn-xs" onclick="openProdModal()">+ Produit</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>R√©f.</th>
                <th>Produit</th>
                <th>Cat√©gorie</th>
                <th class="num">PA HT</th>
                <th class="num">PV HT</th>
                <th class="num">Stock r√©el</th>
                <th class="num">Seuil</th>
                <th>Statut</th>
                <th class="num">Valeur stock</th>
                <th class="num">Marge pot.</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="prodBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PANE MOUVEMENTS ‚ïê‚ïê‚ïê -->
    <div class="pane" id="pane-mouvements">
      <div class="section-card">
        <div class="section-head">
          <div>
            <h2>Mouvements de stock</h2>
            <p>Entr√©es (livraisons, retours) et sorties (ventes, pertes)</p>
          </div>
          <div class="filter-bar">
            <div class="search-wrap">
              <span class="search-icon">üîç</span>
              <input type="text" id="searchMov" placeholder="Rechercher r√©f, commentaire‚Ä¶" oninput="renderMouvements()">
            </div>
            <select class="filter-sel" id="filterMovType" onchange="renderMouvements()">
              <option value="">Tous types</option>
              <option value="IN">Entr√©es</option>
              <option value="OUT">Sorties</option>
            </select>
            <button class="btn btn-p btn-xs" onclick="openMovModal()">+ Mouvement</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Type</th>
                <th>R√©f.</th>
                <th>Produit</th>
                <th class="num">Qt√©</th>
                <th class="num">PA unit.</th>
                <th class="num">Valeur mvt</th>
                <th>Commentaire</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="movBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PANE VALORISATION ‚ïê‚ïê‚ïê -->
    <div class="pane" id="pane-valorisation">
      <div class="section-card">
        <div class="section-head">
          <div><h2>Valorisation du stock</h2><p>Vue financi√®re consolid√©e au prix d'achat</p></div>
          <div class="filter-bar">
            <div class="search-wrap">
              <span class="search-icon">üîç</span>
              <input type="text" id="searchValo" placeholder="Rechercher‚Ä¶" oninput="renderValo()">
            </div>
            <select class="filter-sel" id="sortValo" onchange="renderValo()">
              <option value="valeur">Trier par valeur ‚Üì</option>
              <option value="marge">Trier par marge ‚Üì</option>
              <option value="ref">Trier par r√©f.</option>
            </select>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>R√©f.</th>
                <th>Produit</th>
                <th>Cat√©gorie</th>
                <th class="num">Stock</th>
                <th class="num">PA HT</th>
                <th class="num">Valeur stock</th>
                <th class="num">PV HT</th>
                <th class="num">Marge unit.</th>
                <th class="num">Marge pot. totale</th>
                <th class="num">% Marge</th>
              </tr>
            </thead>
            <tbody id="valoBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PANE GRAPHIQUES ‚ïê‚ïê‚ïê -->
    <div class="pane" id="pane-graphiques">
      <div class="charts-grid">
        <div class="chart-card">
          <div class="chart-title">üìä Top 10 produits par valeur stock</div>
          <div class="chart-wrap"><canvas id="chartValo"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">üéØ R√©partition par statut</div>
          <div class="chart-wrap"><canvas id="chartStatut"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">üìà Top 10 marges potentielles</div>
          <div class="chart-wrap"><canvas id="chartMarge"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">üîÑ Mouvements par mois (30 derniers jours)</div>
          <div class="chart-wrap"><canvas id="chartMov"></canvas></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê PANE SYNTHESE ‚ïê‚ïê‚ïê -->
    <div class="pane" id="pane-synthese">
      <!-- M√©triques synth√®se -->
      <div class="kpi-row" style="grid-template-columns:repeat(4,1fr)">
        <div class="kpi-card">
          <div class="kpi-icon">üì¶</div>
          <div class="kpi-lbl">Nb mouvements total</div>
          <div class="kpi-val" id="synMouvTotal">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">‚¨ÜÔ∏è</div>
          <div class="kpi-lbl">Entr√©es (30j)</div>
          <div class="kpi-val" id="synEntrees">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">‚¨áÔ∏è</div>
          <div class="kpi-lbl">Sorties (30j)</div>
          <div class="kpi-val" id="synSorties">0</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">‚ö†Ô∏è</div>
          <div class="kpi-lbl">Mouvements r√©f. inconnue</div>
          <div class="kpi-val" id="synOrphan">0</div>
        </div>
      </div>
      <div class="synth-grid">
        <div class="synth-box">
          <div class="synth-box-title">üö® Alertes prioritaires</div>
          <div id="synAlertsList"></div>
        </div>
        <div class="synth-box">
          <div class="synth-box-title">üîÑ Derniers mouvements</div>
          <div id="synMovList"></div>
        </div>
        <div class="synth-box">
          <div class="synth-box-title">üèÜ Top 5 valeur stock</div>
          <div id="synTopValo"></div>
        </div>
        <div class="synth-box">
          <div class="synth-box-title">üìä R√©partition cat√©gories</div>
          <div id="synCatList"></div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</main>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL PRODUIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="prodOverlay">
  <div class="modal">
    <div class="modal-title"><span id="prodModalIcon">üì¶</span><span id="prodModalTitle">Ajouter un produit</span></div>
    <input type="hidden" id="m-prod-id"/>
    <div class="mgrid2">
      <div class="mfield">
        <label>R√©f√©rence (SKU) *</label>
        <div class="mfield-wrap"><input class="mfield-in" id="m-ref" placeholder="ex: SKU-001"/></div>
      </div>
      <div class="mfield">
        <label>Nom du produit *</label>
        <div class="mfield-wrap"><input class="mfield-in" id="m-nom" placeholder="ex: Caf√© arabica 250g"/></div>
      </div>
    </div>
    <div class="mgrid2">
      <div class="mfield">
        <label>Cat√©gorie</label>
        <div class="mfield-wrap"><input class="mfield-in" id="m-cat" placeholder="ex: Boissons, √âpicerie‚Ä¶"/></div>
      </div>
      <div class="mfield">
        <label>Fournisseur <span id="fourn-count" style="font-size:10px;color:var(--muted)"></span></label>
        <div class="sugg-wrap" id="sugg-wrap-fourn">
          <div class="mfield-wrap" style="position:relative">
            <input class="mfield-in" id="m-fournisseur" placeholder="ex: Dupont SA" autocomplete="off"
              oninput="onFournisseurInput(this)"
              onfocus="onFournisseurInput(this)"
              onblur="setTimeout(hideFournSugg,180)"
              onkeydown="onFournisseurKey(event)"/>
            <span id="fourn-loading" style="font-size:11px;color:var(--muted);display:none">‚è≥</span>
          </div>
          <div class="sugg-list" id="sugg-fourn"></div>
        </div>
      </div>
    </div>
    <div class="mgrid2">
      <div class="mfield">
        <label>Prix d'achat HT (‚Ç¨) *</label>
        <div class="mfield-wrap"><input class="mfield-in" id="m-pa" type="text" inputmode="decimal" placeholder="0,00"/><span class="mfield-unit">‚Ç¨</span></div>
      </div>
      <div class="mfield">
        <label>Prix de vente HT (‚Ç¨)</label>
        <div class="mfield-wrap"><input class="mfield-in" id="m-pv" type="text" inputmode="decimal" placeholder="0,00"/><span class="mfield-unit">‚Ç¨</span></div>
      </div>
    </div>
    <div class="mgrid2">
      <div class="mfield">
        <label>Stock initial (qt√©)</label>
        <div class="mfield-wrap"><input class="mfield-in" id="m-stock" type="text" inputmode="decimal" placeholder="0"/><span class="mfield-unit">unit√©s</span></div>
      </div>
      <div class="mfield">
        <label>Seuil d'alerte minimum</label>
        <div class="mfield-wrap"><input class="mfield-in" id="m-min" type="text" inputmode="decimal" placeholder="0"/><span class="mfield-unit">unit√©s</span></div>
      </div>
    </div>
    <div class="mfield">
      <label>Unit√© de mesure</label>
      <div class="mfield-wrap">
        <select class="mfield-sel" id="m-unite">
          <option value="unit√©">Unit√©</option>
          <option value="kg">kg</option>
          <option value="g">g</option>
          <option value="L">Litre</option>
          <option value="bo√Æte">Bo√Æte</option>
          <option value="carton">Carton</option>
          <option value="palette">Palette</option>
          <option value="m">M√®tre</option>
          <option value="m¬≤">m¬≤</option>
        </select>
      </div>
    </div>
    <div class="mfield">
      <label>Notes</label>
      <div class="mfield-wrap"><input class="mfield-in" id="m-notes" placeholder="Notes optionnelles‚Ä¶"/></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-o" onclick="closeProdModal()">Annuler</button>
      <button class="btn btn-p" onclick="saveProd()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL MOUVEMENT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="movOverlay">
  <div class="modal">
    <div class="modal-title">üîÑ <span id="movModalTitle">Ajouter un mouvement</span></div>
    <input type="hidden" id="m-mov-id"/>
    <div class="mgrid2">
      <div class="mfield">
        <label>Date *</label>
        <div class="mfield-wrap"><input class="mfield-in" id="m-date" type="date"/></div>
      </div>
      <div class="mfield">
        <label>Type *</label>
        <div class="mfield-wrap">
          <select class="mfield-sel" id="m-type">
            <option value="IN">‚¨ÜÔ∏è Entr√©e (livraison, retour‚Ä¶)</option>
            <option value="OUT">‚¨áÔ∏è Sortie (vente, perte‚Ä¶)</option>
          </select>
        </div>
      </div>
    </div>
    <div class="mgrid2">
      <div class="mfield">
        <label>R√©f√©rence produit *</label>
        <div class="mfield-wrap"><input class="mfield-in" id="m-mov-ref" placeholder="SKU-001"/></div>
      </div>
      <div class="mfield">
        <label>Quantit√© *</label>
        <div class="mfield-wrap"><input class="mfield-in" id="m-qty" type="text" inputmode="decimal" placeholder="0"/></div>
      </div>
    </div>
    <div class="mfield">
      <label>Commentaire</label>
      <div class="mfield-wrap"><input class="mfield-in" id="m-note" placeholder="ex: Livraison fournisseur, Ventes du jour‚Ä¶"/></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-o" onclick="closeMovModal()">Annuler</button>
      <button class="btn btn-p" onclick="saveMov()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// √âTAT ET DONN√âES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _state = { products: [], movements: [] };
var _charts = {};

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function uid() { return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function today() {
  var d = new Date(), p = function(x){ return String(x).padStart(2,'0'); };
  return d.getFullYear()+'-'+p(d.getMonth()+1)+'-'+p(d.getDate());
}
function pf(v) { return parseFloat(String(v||'0').replace(',','.')); }
function fmt(n, d) {
  d = d === undefined ? 2 : d;
  return Number(n||0).toLocaleString('fr-FR',{minimumFractionDigits:d,maximumFractionDigits:d});
}
function fmtK(n) {
  n = Number(n||0);
  if (Math.abs(n) >= 1000) return fmt(n/1000,1)+' k‚Ç¨';
  return fmt(n,0)+' ‚Ç¨';
}

// ‚îÄ‚îÄ Statut ‚îÄ‚îÄ
function stockStatus(stock, min) {
  stock = Number(stock||0); min = Number(min||0);
  if (stock <= 0) return { key:'rupture', label:'RUPTURE', cls:'badge-red' };
  if (min > 0 && stock <= min) return { key:'alerte', label:'ALERTE', cls:'badge-orange' };
  return { key:'ok', label:'OK', cls:'badge-green' };
}

// ‚îÄ‚îÄ Stock calcul√© (base + mouvements) ‚îÄ‚îÄ
function computeStocks() {
  var map = {};
  _state.products.forEach(function(p) {
    map[(p.ref||'').trim()] = pf(p.stockBase);
  });
  _state.movements.forEach(function(m) {
    var ref = (m.ref||'').trim();
    if (!ref) return;
    if (!(ref in map)) map[ref] = 0;
    var q = pf(m.qty);
    if (m.type === 'IN')  map[ref] += q;
    if (m.type === 'OUT') map[ref] -= q;
  });
  return map;
}

function productByRef() {
  var map = {};
  _state.products.forEach(function(p){ if(p.ref) map[(p.ref||'').trim()] = p; });
  return map;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE ‚Äî LOAD / SAVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadFromFirebase() {
  if (!window._uid || !window._getDoc || !window._db) return;
  try {
    var snap = await window._getDoc(window._doc(window._db, 'stock', window._uid, 'data', 'all'));
    if (snap.exists()) {
      var d = snap.data();
      _state.products  = d.products  || [];
      _state.movements = d.movements || [];
    }
  } catch(e) { console.error('Stock load error:', e); }
}

var _saveTimer;
function scheduleSave() {
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(saveToFirebase, 800);
}

async function saveToFirebase() {
  if (!window._uid || !window._setDoc || !window._db) return;
  try {
    await window._setDoc(
      window._doc(window._db, 'stock', window._uid, 'data', 'all'),
      { products: _state.products, movements: _state.movements, updatedAt: new Date().toISOString() }
    );
  } catch(e) { console.error('Stock save error:', e); showToast('Erreur sauvegarde', true); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTOCOMPLETE FOURNISSEURS (depuis catalogues Firestore)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _suppliers = [];
var _suppLoaded = false;
var _fournIdx = -1;

async function loadSuppliersFromCatalogue() {
  if (_suppLoaded || !window._uid || !window._getDoc || !window._db) return;
  document.getElementById('fourn-loading').style.display = 'inline';
  try {
    var snap = await window._getDoc(window._doc(window._db, 'catalogues', window._uid));
    if (snap.exists() && snap.data().suppliers) {
      _suppliers = (snap.data().suppliers || []).filter(Boolean).sort();
    } else {
      var snapOld = await window._getDoc(window._doc(window._db, 'suppliers', window._uid));
      if (snapOld.exists()) {
        _suppliers = (snapOld.data().list || []).filter(Boolean).sort();
      }
    }
    // Enrichir avec les fournisseurs deja saisis dans les produits stock
    _state.products.forEach(function(p) {
      if (p.fournisseur && p.fournisseur.trim() && !_suppliers.includes(p.fournisseur.trim())) {
        _suppliers.push(p.fournisseur.trim());
      }
    });
    _suppliers.sort();
    _suppLoaded = true;
    var cnt = document.getElementById('fourn-count');
    if (cnt) cnt.textContent = _suppliers.length ? '(' + _suppliers.length + ' disponibles)' : '';
  } catch(e) { console.warn('loadSuppliers error:', e); }
  document.getElementById('fourn-loading').style.display = 'none';
}

function onFournisseurInput(inp) {
  if (!_suppLoaded) { loadSuppliersFromCatalogue(); }
  var val = (inp.value || '').toLowerCase().trim();
  var list = document.getElementById('sugg-fourn');
  if (!list) return;

  var filtered = _suppliers.filter(function(s) {
    return !val || s.toLowerCase().includes(val);
  }).slice(0, 12);

  if (!filtered.length) {
    list.innerHTML = '<div class="sugg-item-empty">Aucun fournisseur dans Pilotage</div>';
    list.classList.toggle('show', val.length > 0);
    return;
  }

  _fournIdx = -1;
  list.innerHTML = filtered.map(function(s, i) {
    var safe = s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    var hl = val ? s.replace(new RegExp('(' + val.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + ')','gi'),'<strong>$1</strong>') : s;
    return '<div class="sugg-item" data-val="' + safe + '" data-i="' + i + '" onmousedown="pickFournisseur(this)">\uD83C\uDFE2 ' + hl + '</div>';
  }).join('');
  list.classList.add('show');
}

function pickFournisseur(el) {
  document.getElementById('m-fournisseur').value = el.dataset.val;
  hideFournSugg();
}

function hideFournSugg() {
  var list = document.getElementById('sugg-fourn');
  if (list) list.classList.remove('show');
  _fournIdx = -1;
}

function onFournisseurKey(e) {
  var list = document.getElementById('sugg-fourn');
  if (!list || !list.classList.contains('show')) return;
  var items = list.querySelectorAll('.sugg-item');
  if (!items.length) return;
  if (e.key === 'ArrowDown') { e.preventDefault(); _fournIdx = Math.min(_fournIdx + 1, items.length - 1); }
  else if (e.key === 'ArrowUp') { e.preventDefault(); _fournIdx = Math.max(_fournIdx - 1, 0); }
  else if (e.key === 'Enter' && _fournIdx >= 0) { e.preventDefault(); pickFournisseur(items[_fournIdx]); return; }
  else if (e.key === 'Escape') { hideFournSugg(); return; }
  else { return; }
  items.forEach(function(it, i) { it.classList.toggle('focused', i === _fournIdx); });
  if (_fournIdx >= 0) items[_fournIdx].scrollIntoView({ block: 'nearest' });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// RENDERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ
function renderKPIs() {
  var stk = computeStocks();
  var totalVal = 0, totalMarge = 0, alerts = 0, ruptures = 0;

  _state.products.forEach(function(p) {
    var ref = (p.ref||'').trim(); if (!ref) return;
    var stock = Number(stk[ref]||0);
    var pa = pf(p.pa), pv = pf(p.pv), min = pf(p.min);
    totalVal   += pa * stock;
    totalMarge += (pv - pa) * stock;
    var st = stockStatus(stock, min);
    if (st.key === 'alerte' || st.key === 'rupture') alerts++;
    if (st.key === 'rupture') ruptures++;
  });

  var refs = _state.products.filter(function(p){ return (p.ref||'').trim(); }).length;
  document.getElementById('kpiRefs').textContent = refs;
  document.getElementById('kpiRefsub').textContent = refs === 1 ? '1 r√©f√©rence' : refs+' r√©f√©rences';
  document.getElementById('kpiValeur').textContent = fmtK(totalVal);
  document.getElementById('kpiMarge').textContent = fmtK(totalMarge);
  var pct = totalVal > 0 ? (totalMarge / totalVal * 100) : 0;
  document.getElementById('kpiMargePct').textContent = fmt(pct,1)+' % de marge';
  document.getElementById('kpiAlerts').textContent = alerts;
  document.getElementById('kpiRupture').textContent = ruptures;

  var alertCard = document.getElementById('kpiAlertCard');
  alertCard.className = 'kpi-card ' + (alerts > 0 ? 'alert-card' : 'ok-card');
  var ruptCard = document.getElementById('kpiRuptureCard');
  ruptCard.className = 'kpi-card ' + (ruptures > 0 ? 'rupture-card' : 'ok-card');
}

// ‚îÄ‚îÄ PRODUITS ‚îÄ‚îÄ
function renderProducts() {
  var stk = computeStocks();
  var body = document.getElementById('prodBody');
  var search = (document.getElementById('searchProd').value||'').toLowerCase();
  var filterSt = document.getElementById('filterStatut').value;
  var filterCat = document.getElementById('filterCat').value;

  // M√†j filtre cat√©gories
  var cats = [...new Set(_state.products.map(function(p){ return p.cat||''; }).filter(Boolean))];
  var sel = document.getElementById('filterCat');
  var cur = sel.value;
  sel.innerHTML = '<option value="">Toutes cat√©gories</option>';
  cats.sort().forEach(function(c){ sel.innerHTML += '<option value="'+c+'"'+(c===cur?' selected':'')+'>'+c+'</option>'; });

  var filtered = _state.products.filter(function(p) {
    var ref = (p.ref||'').trim();
    var stock = Number(stk[ref]||0);
    var st = stockStatus(stock, pf(p.min));
    if (filterSt && st.key !== filterSt) return false;
    if (filterCat && (p.cat||'') !== filterCat) return false;
    if (search) {
      var q = (p.ref+' '+p.name+' '+(p.cat||'')).toLowerCase();
      if (!q.includes(search)) return false;
    }
    return true;
  });

  body.innerHTML = '';
  if (!filtered.length) {
    body.innerHTML = '<tr class="empty-row"><td colspan="11">Aucun produit trouv√©</td></tr>';
    return;
  }

  filtered.forEach(function(p) {
    var ref = (p.ref||'').trim();
    var stock = Number(stk[ref]||0);
    var pa = pf(p.pa), pv = pf(p.pv), min = pf(p.min);
    var st = stockStatus(stock, min);
    var vStock = pa * stock;
    var mPot = (pv - pa) * stock;
    var stockPct = min > 0 ? Math.min(100, (stock / (min * 2)) * 100) : (stock > 0 ? 100 : 0);
    var barColor = st.key === 'rupture' ? '#ef4444' : st.key === 'alerte' ? '#f59e0b' : '#10b981';

    var tr = document.createElement('tr');
    tr.innerHTML =
      '<td><span style="font-family:monospace;font-size:11px;background:#f1f5f9;padding:3px 7px;border-radius:5px;font-weight:700">'+escHtml(ref)+'</span></td>'+
      '<td style="font-weight:600;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="'+escHtml(p.name||'')+'">'+escHtml(p.name||'‚Äî')+'</td>'+
      '<td class="muted">'+escHtml(p.cat||'‚Äî')+'</td>'+
      '<td class="num">'+fmt(pa)+' ‚Ç¨</td>'+
      '<td class="num">'+fmt(pv)+' ‚Ç¨</td>'+
      '<td class="num">'+
        '<div class="stock-bar-wrap">'+
          '<span style="font-weight:700;color:'+(st.key==='rupture'?'#ef4444':st.key==='alerte'?'#f59e0b':'var(--text)')+'">'+fmt(stock,0)+'</span>'+
          '<div class="prog-wrap" style="flex:1"><div class="prog-fill" style="width:'+stockPct+'%;background:'+barColor+'"></div></div>'+
        '</div>'+
      '</td>'+
      '<td class="num muted">'+fmt(min,0)+'</td>'+
      '<td><span class="badge '+st.cls+'">'+st.label+'</span></td>'+
      '<td class="num" style="font-weight:700">'+fmt(vStock)+' ‚Ç¨</td>'+
      '<td class="num" style="color:'+(mPot>=0?'#059669':'#dc2626')+';font-weight:700">'+fmt(mPot)+' ‚Ç¨</td>'+
      '<td><div style="display:flex;gap:4px">'+
        '<button class="btn btn-o btn-xs" onclick="editProd(\''+p.id+'\')">‚úèÔ∏è</button>'+
        '<button class="btn btn-d btn-xs" onclick="deleteProd(\''+p.id+'\')">‚úï</button>'+
      '</div></td>';
    body.appendChild(tr);
  });
}

// ‚îÄ‚îÄ MOUVEMENTS ‚îÄ‚îÄ
function renderMouvements() {
  var pmap = productByRef();
  var body = document.getElementById('movBody');
  var search = (document.getElementById('searchMov').value||'').toLowerCase();
  var filterType = document.getElementById('filterMovType').value;

  var rows = _state.movements.slice().sort(function(a,b){ return (b.date||'').localeCompare(a.date||''); });

  var filtered = rows.filter(function(m) {
    if (filterType && m.type !== filterType) return false;
    if (search) {
      var q = ((m.ref||'')+' '+(m.note||'')).toLowerCase();
      if (!q.includes(search)) return false;
    }
    return true;
  });

  body.innerHTML = '';
  if (!filtered.length) {
    body.innerHTML = '<tr class="empty-row"><td colspan="9">Aucun mouvement trouv√©</td></tr>';
    return;
  }

  filtered.forEach(function(m) {
    var ref = (m.ref||'').trim();
    var prod = pmap[ref];
    var pa = prod ? pf(prod.pa) : 0;
    var qty = pf(m.qty);
    var valMvt = pa * qty;
    var unknown = !!ref && !prod;
    var dateStr = m.date ? new Date(m.date).toLocaleDateString('fr-FR') : '‚Äî';

    var tr = document.createElement('tr');
    tr.innerHTML =
      '<td class="muted">'+dateStr+'</td>'+
      '<td><span class="'+(m.type==='IN'?'mov-in':'mov-out')+'">'+(m.type==='IN'?'‚¨ÜÔ∏è Entr√©e':'‚¨áÔ∏è Sortie')+'</span></td>'+
      '<td><span style="font-family:monospace;font-size:11px;background:#f1f5f9;padding:3px 7px;border-radius:5px;font-weight:700">'+escHtml(ref||'‚Äî')+'</span>'+(unknown?'<br><span class="badge badge-orange" style="margin-top:2px">R√©f. inconnue</span>':'')+'</td>'+
      '<td style="font-weight:600;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+escHtml(prod ? (prod.name||'') : (unknown?'‚ö†Ô∏è Inconnu':'‚Äî'))+'</td>'+
      '<td class="num" style="font-weight:700;color:'+(m.type==='IN'?'#059669':'#dc2626')+'">'+(m.type==='IN'?'+':'-')+fmt(qty,0)+'</td>'+
      '<td class="num muted">'+(pa>0 ? fmt(pa)+' ‚Ç¨' : '‚Äî')+'</td>'+
      '<td class="num" style="font-weight:600">'+(pa>0 ? fmt(valMvt)+' ‚Ç¨' : '‚Äî')+'</td>'+
      '<td class="muted" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+escHtml(m.note||'‚Äî')+'</td>'+
      '<td><div style="display:flex;gap:4px">'+
        '<button class="btn btn-o btn-xs" onclick="editMov(\''+m.id+'\')">‚úèÔ∏è</button>'+
        '<button class="btn btn-d btn-xs" onclick="deleteMov(\''+m.id+'\')">‚úï</button>'+
      '</div></td>';
    body.appendChild(tr);
  });
}

// ‚îÄ‚îÄ VALORISATION ‚îÄ‚îÄ
function renderValo() {
  var stk = computeStocks();
  var body = document.getElementById('valoBody');
  var search = (document.getElementById('searchValo').value||'').toLowerCase();
  var sortBy = document.getElementById('sortValo').value;

  var rows = [];
  _state.products.forEach(function(p) {
    var ref = (p.ref||'').trim(); if (!ref) return;
    var stock = Number(stk[ref]||0);
    var pa = pf(p.pa), pv = pf(p.pv);
    var vStock = pa * stock;
    var margU = pv - pa;
    var mPot = margU * stock;
    var pctMarge = pa > 0 ? (margU / pa * 100) : 0;
    rows.push({ p: p, ref: ref, stock: stock, pa: pa, pv: pv, vStock: vStock, margU: margU, mPot: mPot, pctMarge: pctMarge });
  });

  if (search) rows = rows.filter(function(r){ return (r.ref+' '+r.p.name+' '+(r.p.cat||'')).toLowerCase().includes(search); });
  if (sortBy === 'valeur') rows.sort(function(a,b){ return b.vStock - a.vStock; });
  else if (sortBy === 'marge') rows.sort(function(a,b){ return b.mPot - a.mPot; });
  else rows.sort(function(a,b){ return a.ref.localeCompare(b.ref); });

  body.innerHTML = '';
  if (!rows.length) {
    body.innerHTML = '<tr class="empty-row"><td colspan="10">Aucun produit</td></tr>';
    return;
  }

  var totVal = 0, totMarge = 0;
  rows.forEach(function(r) {
    totVal += r.vStock; totMarge += r.mPot;
    var tr = document.createElement('tr');
    tr.innerHTML =
      '<td><span style="font-family:monospace;font-size:11px;background:#f1f5f9;padding:3px 7px;border-radius:5px;font-weight:700">'+escHtml(r.ref)+'</span></td>'+
      '<td style="font-weight:600">'+escHtml(r.p.name||'‚Äî')+'</td>'+
      '<td class="muted">'+escHtml(r.p.cat||'‚Äî')+'</td>'+
      '<td class="num" style="font-weight:700">'+fmt(r.stock,0)+'</td>'+
      '<td class="num">'+fmt(r.pa)+' ‚Ç¨</td>'+
      '<td class="num" style="font-weight:700">'+fmt(r.vStock)+' ‚Ç¨</td>'+
      '<td class="num">'+fmt(r.pv)+' ‚Ç¨</td>'+
      '<td class="num" style="color:'+(r.margU>=0?'#059669':'#dc2626')+';font-weight:600">'+fmt(r.margU)+' ‚Ç¨</td>'+
      '<td class="num" style="color:'+(r.mPot>=0?'#059669':'#dc2626')+';font-weight:700">'+fmt(r.mPot)+' ‚Ç¨</td>'+
      '<td class="num"><span class="badge '+(r.pctMarge>=30?'badge-green':r.pctMarge>=15?'badge-blue':'badge-orange')+'">'+fmt(r.pctMarge,1)+' %</span></td>';
    body.appendChild(tr);
  });

  // Total row
  var trTotal = document.createElement('tr');
  trTotal.className = 'valo-total-row';
  var totPct = totVal > 0 ? (totMarge / totVal * 100) : 0;
  trTotal.innerHTML =
    '<td colspan="5" style="font-weight:800;padding:12px">TOTAL</td>'+
    '<td class="num" style="font-weight:800">'+fmt(totVal)+' ‚Ç¨</td>'+
    '<td class="num"></td><td class="num"></td>'+
    '<td class="num" style="font-weight:800;color:#059669">'+fmt(totMarge)+' ‚Ç¨</td>'+
    '<td class="num"><span class="badge badge-blue">'+fmt(totPct,1)+' %</span></td>';
  body.appendChild(trTotal);
}

// ‚îÄ‚îÄ GRAPHIQUES ‚îÄ‚îÄ
function renderGraphiques() {
  var stk = computeStocks();

  // Donn√©es
  var prodData = _state.products.map(function(p) {
    var ref = (p.ref||'').trim();
    var stock = Number(stk[ref]||0);
    var pa = pf(p.pa), pv = pf(p.pv);
    return { ref: ref, name: p.name||ref, vStock: pa*stock, mPot: (pv-pa)*stock, stock: stock, min: pf(p.min) };
  }).filter(function(d){ return d.ref; });

  // Top 10 valeur
  var top10valo = prodData.slice().sort(function(a,b){ return b.vStock - a.vStock; }).slice(0,10);
  buildOrUpdateChart('chartValo', 'bar', {
    labels: top10valo.map(function(d){ return d.ref; }),
    datasets: [{
      label: 'Valeur stock (‚Ç¨)',
      data: top10valo.map(function(d){ return Math.round(d.vStock*100)/100; }),
      backgroundColor: 'rgba(79,126,248,.7)',
      borderColor: 'rgba(79,126,248,1)',
      borderWidth: 1, borderRadius: 6
    }]
  }, { indexAxis:'y', plugins:{legend:{display:false}} });

  // R√©partition statuts
  var ok = 0, alerte = 0, rupture = 0;
  prodData.forEach(function(d){
    var s = stockStatus(d.stock, d.min);
    if (s.key === 'ok') ok++;
    else if (s.key === 'alerte') alerte++;
    else rupture++;
  });
  buildOrUpdateChart('chartStatut', 'doughnut', {
    labels: ['‚úÖ OK', '‚ö†Ô∏è Alerte', 'üö® Rupture'],
    datasets: [{ data: [ok, alerte, rupture], backgroundColor: ['rgba(16,185,129,.75)','rgba(245,158,11,.75)','rgba(239,68,68,.75)'], borderWidth: 0 }]
  }, { cutout:'65%', plugins:{legend:{position:'bottom',labels:{font:{size:11},padding:10}}} });

  // Top 10 marges
  var top10marge = prodData.filter(function(d){ return d.mPot > 0; }).sort(function(a,b){ return b.mPot - a.mPot; }).slice(0,10);
  buildOrUpdateChart('chartMarge', 'bar', {
    labels: top10marge.map(function(d){ return d.ref; }),
    datasets: [{
      label: 'Marge potentielle (‚Ç¨)',
      data: top10marge.map(function(d){ return Math.round(d.mPot*100)/100; }),
      backgroundColor: 'rgba(16,185,129,.7)',
      borderColor: 'rgba(16,185,129,1)',
      borderWidth: 1, borderRadius: 6
    }]
  }, { indexAxis:'y', plugins:{legend:{display:false}} });

  // Mouvements par jour (30 derniers jours)
  var now = new Date();
  var days = {};
  for (var i = 29; i >= 0; i--) {
    var d = new Date(now); d.setDate(d.getDate() - i);
    var key = d.toISOString().slice(0,10);
    days[key] = { in: 0, out: 0 };
  }
  _state.movements.forEach(function(m) {
    if (m.date in days) {
      if (m.type === 'IN') days[m.date].in += pf(m.qty);
      if (m.type === 'OUT') days[m.date].out += pf(m.qty);
    }
  });
  var dayLabels = Object.keys(days).map(function(k){ return k.slice(5); }); // MM-DD
  buildOrUpdateChart('chartMov', 'bar', {
    labels: dayLabels,
    datasets: [
      { label: 'Entr√©es', data: Object.values(days).map(function(d){ return d.in; }), backgroundColor: 'rgba(16,185,129,.6)', borderRadius: 3 },
      { label: 'Sorties', data: Object.values(days).map(function(d){ return d.out; }), backgroundColor: 'rgba(239,68,68,.6)', borderRadius: 3 }
    ]
  }, { plugins:{legend:{position:'top',labels:{font:{size:11}}}} });
}

function buildOrUpdateChart(id, type, data, extraOpts) {
  if (_charts[id]) { _charts[id].destroy(); delete _charts[id]; }
  var ctx = document.getElementById(id);
  if (!ctx) return;
  _charts[id] = new Chart(ctx, {
    type: type,
    data: data,
    options: Object.assign({
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: type === 'doughnut' ? {} : {
        x: { grid: { color: 'rgba(0,0,0,.05)' }, ticks: { font: { size: 10 } } },
        y: { grid: { color: 'rgba(0,0,0,.05)' }, ticks: { font: { size: 10 } } }
      }
    }, extraOpts || {})
  });
}

// ‚îÄ‚îÄ SYNTH√àSE ‚îÄ‚îÄ
function renderSynth() {
  var stk = computeStocks();
  var pmap = productByRef();

  // M√©triques 30 derniers jours
  var cutoff = new Date(); cutoff.setDate(cutoff.getDate() - 30);
  var cutStr = cutoff.toISOString().slice(0,10);
  var entrees = 0, sorties = 0;
  _state.movements.forEach(function(m) {
    if ((m.date||'') >= cutStr) {
      if (m.type === 'IN') entrees += pf(m.qty);
      if (m.type === 'OUT') sorties += pf(m.qty);
    }
  });
  var orphans = _state.movements.filter(function(m){ var r=(m.ref||'').trim(); return r && !pmap[r]; });

  document.getElementById('synMouvTotal').textContent = _state.movements.length;
  document.getElementById('synEntrees').textContent = fmt(entrees,0);
  document.getElementById('synSorties').textContent = fmt(sorties,0);
  document.getElementById('synOrphan').textContent = orphans.length;

  // Alertes prioritaires
  var alertItems = [];
  _state.products.forEach(function(p) {
    var ref = (p.ref||'').trim(); if (!ref) return;
    var stock = Number(stk[ref]||0);
    var st = stockStatus(stock, pf(p.min));
    if (st.key !== 'ok') alertItems.push({ p: p, ref: ref, stock: stock, st: st });
  });
  alertItems.sort(function(a,b){ return (a.stock - pf(a.p.min)) - (b.stock - pf(b.p.min)); });
  var alertsEl = document.getElementById('synAlertsList');
  alertsEl.innerHTML = '';
  if (!alertItems.length) {
    alertsEl.innerHTML = '<div class="no-items">‚úÖ Aucune alerte ‚Äî tout est OK</div>';
  } else {
    alertItems.slice(0,8).forEach(function(item) {
      alertsEl.innerHTML +=
        '<div class="synth-item">'+
          '<div class="synth-item-left">'+
            '<div class="synth-item-name">'+escHtml(item.ref)+' ‚Äî '+escHtml(item.p.name||'')+'</div>'+
            '<div class="synth-item-sub">Stock '+fmt(item.stock,0)+' / Seuil '+fmt(pf(item.p.min),0)+'</div>'+
          '</div>'+
          '<span class="badge '+item.st.cls+'">'+item.st.label+'</span>'+
        '</div>';
    });
  }

  // Derniers mouvements
  var lastMov = _state.movements.slice().sort(function(a,b){ return (b.date||'').localeCompare(a.date||''); }).slice(0,8);
  var movEl = document.getElementById('synMovList');
  movEl.innerHTML = '';
  if (!lastMov.length) {
    movEl.innerHTML = '<div class="no-items">Aucun mouvement enregistr√©</div>';
  } else {
    lastMov.forEach(function(m) {
      var ref = (m.ref||'').trim();
      var known = !!pmap[ref];
      var dateStr = m.date ? new Date(m.date).toLocaleDateString('fr-FR') : '‚Äî';
      movEl.innerHTML +=
        '<div class="synth-item">'+
          '<div class="synth-item-left">'+
            '<div class="synth-item-name">'+(m.type==='IN'?'‚¨ÜÔ∏è':'‚¨áÔ∏è')+' '+escHtml(ref||'?')+' (√ó'+fmt(pf(m.qty),0)+')</div>'+
            '<div class="synth-item-sub">'+dateStr+(m.note?' ‚Ä¢ '+escHtml(m.note):'')+'</div>'+
          '</div>'+
          '<span class="badge '+(known?'badge-green':'badge-orange')+'">'+(known?'OK':'R√©f. ?')+'</span>'+
        '</div>';
    });
  }

  // Top 5 valeur stock
  var stk2 = computeStocks();
  var topValo = _state.products.map(function(p) {
    var ref = (p.ref||'').trim(); if (!ref) return null;
    var stock = Number(stk2[ref]||0);
    return { ref: ref, name: p.name||'', vStock: pf(p.pa)*stock };
  }).filter(Boolean).sort(function(a,b){ return b.vStock - a.vStock; }).slice(0,5);
  var topEl = document.getElementById('synTopValo');
  topEl.innerHTML = '';
  if (!topValo.length) {
    topEl.innerHTML = '<div class="no-items">Aucun produit</div>';
  } else {
    var maxV = topValo[0].vStock || 1;
    topValo.forEach(function(item) {
      var pct = (item.vStock / maxV * 100).toFixed(1);
      topEl.innerHTML +=
        '<div class="synth-item" style="flex-direction:column;align-items:stretch;gap:5px">'+
          '<div style="display:flex;justify-content:space-between">'+
            '<span class="synth-item-name">'+escHtml(item.ref)+' ‚Äî '+escHtml(item.name.slice(0,25))+'</span>'+
            '<span style="font-weight:700;font-size:12px">'+fmt(item.vStock)+' ‚Ç¨</span>'+
          '</div>'+
          '<div class="prog-wrap"><div class="prog-fill" style="width:'+pct+'%;background:#4f7ef8"></div></div>'+
        '</div>';
    });
  }

  // Cat√©gories
  var catMap = {};
  _state.products.forEach(function(p) {
    var cat = p.cat || 'Sans cat√©gorie';
    var ref = (p.ref||'').trim(); if (!ref) return;
    var stock = Number(stk[ref]||0);
    var vStock = pf(p.pa) * stock;
    if (!catMap[cat]) catMap[cat] = { count: 0, val: 0 };
    catMap[cat].count++;
    catMap[cat].val += vStock;
  });
  var catEl = document.getElementById('synCatList');
  catEl.innerHTML = '';
  var catArr = Object.keys(catMap).map(function(k){ return { cat: k, count: catMap[k].count, val: catMap[k].val }; });
  catArr.sort(function(a,b){ return b.val - a.val; });
  if (!catArr.length) {
    catEl.innerHTML = '<div class="no-items">Aucune cat√©gorie</div>';
  } else {
    var maxCat = catArr[0].val || 1;
    catArr.forEach(function(item) {
      var pct = (item.val / maxCat * 100).toFixed(1);
      catEl.innerHTML +=
        '<div class="synth-item" style="flex-direction:column;align-items:stretch;gap:5px">'+
          '<div style="display:flex;justify-content:space-between">'+
            '<span class="synth-item-name">'+escHtml(item.cat)+'</span>'+
            '<span style="color:var(--muted);font-size:11px">'+item.count+' r√©f ¬∑ '+fmt(item.val)+' ‚Ç¨</span>'+
          '</div>'+
          '<div class="prog-wrap"><div class="prog-fill" style="width:'+pct+'%;background:#6366f1"></div></div>'+
        '</div>';
    });
  }
}

// ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ
function renderAll() {
  renderKPIs();
  var activeTab = document.querySelector('.tab.on');
  var tabName = activeTab ? activeTab.dataset.tab : 'produits';
  if (tabName === 'produits') renderProducts();
  else if (tabName === 'mouvements') renderMouvements();
  else if (tabName === 'valorisation') renderValo();
  else if (tabName === 'graphiques') renderGraphiques();
  else if (tabName === 'synthese') renderSynth();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.switchTab = function(name) {
  document.querySelectorAll('.tab').forEach(function(t){ t.classList.toggle('on', t.dataset.tab === name); });
  document.querySelectorAll('.pane').forEach(function(p){ p.classList.toggle('on', p.id === 'pane-'+name); });
  if (name === 'produits') renderProducts();
  else if (name === 'mouvements') renderMouvements();
  else if (name === 'valorisation') renderValo();
  else if (name === 'graphiques') renderGraphiques();
  else if (name === 'synthese') renderSynth();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS PRODUIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openProdModal = function(id) {
  var p = id ? _state.products.find(function(x){ return x.id === id; }) : null;
  document.getElementById('prodModalIcon').textContent = p ? '‚úèÔ∏è' : 'üì¶';
  document.getElementById('prodModalTitle').textContent = p ? 'Modifier le produit' : 'Ajouter un produit';
  document.getElementById('m-prod-id').value = p ? p.id : '';
  document.getElementById('m-ref').value = p ? (p.ref||'') : '';
  document.getElementById('m-nom').value = p ? (p.name||'') : '';
  document.getElementById('m-cat').value = p ? (p.cat||'') : '';
  document.getElementById('m-fournisseur').value = p ? (p.fournisseur||'') : '';
  document.getElementById('m-pa').value = p ? (p.pa||'') : '';
  document.getElementById('m-pv').value = p ? (p.pv||'') : '';
  document.getElementById('m-stock').value = p ? (p.stockBase||'') : '';
  document.getElementById('m-min').value = p ? (p.min||'') : '';
  document.getElementById('m-unite').value = p ? (p.unite||'unit√©') : 'unit√©';
  document.getElementById('m-notes').value = p ? (p.notes||'') : '';
  document.getElementById('prodOverlay').classList.add('show');
  loadSuppliersFromCatalogue();
  setTimeout(function(){ document.getElementById('m-ref').focus(); }, 100);
};
window.editProd = window.openProdModal;

window.closeProdModal = function() {
  document.getElementById('prodOverlay').classList.remove('show');
};

window.saveProd = function() {
  var ref = document.getElementById('m-ref').value.trim();
  var nom = document.getElementById('m-nom').value.trim();
  if (!ref) { showToast('La r√©f√©rence est obligatoire', true); return; }
  if (!nom) { showToast('Le nom du produit est obligatoire', true); return; }

  var id = document.getElementById('m-prod-id').value;
  var existing = id ? _state.products.find(function(x){ return x.id === id; }) : null;

  // V√©rif doublon ref
  var dupRef = _state.products.find(function(p){ return (p.ref||'').trim() === ref && p.id !== id; });
  if (dupRef) { showToast('Cette r√©f√©rence existe d√©j√† : '+ref, true); return; }

  var data = {
    id: existing ? existing.id : uid(),
    ref: ref,
    name: nom,
    cat: document.getElementById('m-cat').value.trim(),
    fournisseur: document.getElementById('m-fournisseur').value.trim(),
    pa: String(pf(document.getElementById('m-pa').value)),
    pv: String(pf(document.getElementById('m-pv').value)),
    stockBase: String(pf(document.getElementById('m-stock').value)),
    min: String(pf(document.getElementById('m-min').value)),
    unite: document.getElementById('m-unite').value,
    notes: document.getElementById('m-notes').value.trim(),
    createdAt: existing ? existing.createdAt : new Date().toISOString()
  };

  if (existing) {
    var idx = _state.products.findIndex(function(x){ return x.id === id; });
    _state.products[idx] = data;
  } else {
    _state.products.push(data);
  }

  scheduleSave();
  closeProdModal();
  renderAll();
  showToast(existing ? 'Produit modifi√©' : 'Produit ajout√© ‚úÖ');
};

window.deleteProd = function(id) {
  if (!confirm('Supprimer ce produit ? Les mouvements associ√©s seront conserv√©s.')) return;
  _state.products = _state.products.filter(function(p){ return p.id !== id; });
  scheduleSave();
  renderAll();
  showToast('Produit supprim√©');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS MOUVEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openMovModal = function(id) {
  var m = id ? _state.movements.find(function(x){ return x.id === id; }) : null;
  document.getElementById('movModalTitle').textContent = m ? 'Modifier le mouvement' : 'Ajouter un mouvement';
  document.getElementById('m-mov-id').value = m ? m.id : '';
  document.getElementById('m-date').value = m ? (m.date||today()) : today();
  document.getElementById('m-type').value = m ? (m.type||'IN') : 'IN';
  document.getElementById('m-mov-ref').value = m ? (m.ref||'') : '';
  document.getElementById('m-qty').value = m ? (m.qty||'') : '';
  document.getElementById('m-note').value = m ? (m.note||'') : '';
  document.getElementById('movOverlay').classList.add('show');
  setTimeout(function(){ document.getElementById('m-mov-ref').focus(); }, 100);
};
window.editMov = window.openMovModal;

window.closeMovModal = function() {
  document.getElementById('movOverlay').classList.remove('show');
};

window.saveMov = function() {
  var ref = document.getElementById('m-mov-ref').value.trim();
  var qty = pf(document.getElementById('m-qty').value);
  if (!ref) { showToast('La r√©f√©rence est obligatoire', true); return; }
  if (!qty || qty <= 0) { showToast('La quantit√© doit √™tre > 0', true); return; }

  var id = document.getElementById('m-mov-id').value;
  var existing = id ? _state.movements.find(function(x){ return x.id === id; }) : null;

  var data = {
    id: existing ? existing.id : uid(),
    date: document.getElementById('m-date').value || today(),
    type: document.getElementById('m-type').value,
    ref: ref,
    qty: String(qty),
    note: document.getElementById('m-note').value.trim()
  };

  if (existing) {
    var idx = _state.movements.findIndex(function(x){ return x.id === id; });
    _state.movements[idx] = data;
  } else {
    _state.movements.push(data);
  }

  scheduleSave();
  closeMovModal();
  renderAll();
  showToast(existing ? 'Mouvement modifi√©' : 'Mouvement enregistr√© ‚úÖ');
};

window.deleteMov = function(id) {
  if (!confirm('Supprimer ce mouvement ?')) return;
  _state.movements = _state.movements.filter(function(m){ return m.id !== id; });
  scheduleSave();
  renderAll();
  showToast('Mouvement supprim√©');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.exportPDF = function() {
  var stk = computeStocks();
  var now = new Date().toLocaleDateString('fr-FR');
  var rows = _state.products.map(function(p) {
    var ref = (p.ref||'').trim(); if(!ref) return '';
    var stock = Number(stk[ref]||0);
    var pa = pf(p.pa), pv = pf(p.pv), min = pf(p.min);
    var st = stockStatus(stock, min);
    var vStock = pa*stock, mPot=(pv-pa)*stock;
    return '<tr style="border-bottom:1px solid #e2e8f0">'+
      '<td style="padding:8px 10px;font-family:monospace;font-size:11px">'+ref+'</td>'+
      '<td style="padding:8px 10px">'+escHtml(p.name||'')+'</td>'+
      '<td style="padding:8px 10px;color:#6b7280">'+escHtml(p.cat||'')+'</td>'+
      '<td style="padding:8px 10px;text-align:right">'+fmt(pa)+' ‚Ç¨</td>'+
      '<td style="padding:8px 10px;text-align:right">'+fmt(pv)+' ‚Ç¨</td>'+
      '<td style="padding:8px 10px;text-align:right;font-weight:700">'+fmt(stock,0)+'</td>'+
      '<td style="padding:8px 10px;text-align:right">'+fmt(min,0)+'</td>'+
      '<td style="padding:8px 10px;text-align:center"><span style="padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;background:'+(st.key==='ok'?'#d1fae5;color:#065f46':st.key==='alerte'?'#fef3c7;color:#92400e':'#fee2e2;color:#b91c1c')+'">'+st.label+'</span></td>'+
      '<td style="padding:8px 10px;text-align:right;font-weight:700">'+fmt(vStock)+' ‚Ç¨</td>'+
      '<td style="padding:8px 10px;text-align:right;color:'+(mPot>=0?'#059669':'#dc2626')+';font-weight:700">'+fmt(mPot)+' ‚Ç¨</td>'+
    '</tr>';
  }).join('');

  var totalVal = 0, totalMarge = 0;
  _state.products.forEach(function(p){
    var ref=(p.ref||'').trim(); if(!ref)return;
    var stock=Number(stk[ref]||0), pa=pf(p.pa), pv=pf(p.pv);
    totalVal += pa*stock; totalMarge += (pv-pa)*stock;
  });

  var html = '<!DOCTYPE html><html><head><meta charset="UTF-8">'+
    '<title>Stock ‚Äî '+now+'</title>'+
    '<style>body{font-family:Arial,sans-serif;color:#1a1f36;font-size:12px;padding:20px}'+
    'h1{font-size:18px;font-weight:800;margin-bottom:4px}'+
    '.sub{color:#6b7280;margin-bottom:20px;font-size:12px}'+
    '.kpis{display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap}'+
    '.kpi{border:1px solid #e2e8f0;border-radius:8px;padding:10px 14px;min-width:160px}'+
    '.kpi-lbl{font-size:10px;color:#6b7280;text-transform:uppercase;font-weight:700}'+
    '.kpi-val{font-size:18px;font-weight:800;margin-top:4px}'+
    'table{width:100%;border-collapse:collapse}'+
    'thead th{background:#f8faff;padding:8px 10px;text-align:left;font-size:10px;text-transform:uppercase;font-weight:700;color:#6b7280;border-bottom:2px solid #e2e8f0}'+
    'thead th.r{text-align:right}'+
    'tr:nth-child(even) td{background:#f9fafb}'+
    '.total{background:#eff6ff!important;font-weight:800}'+
    '</style></head><body>'+
    '<h1>üì¶ √âtat du Stock ‚Äî Alteore</h1>'+
    '<div class="sub">G√©n√©r√© le '+now+' ¬∑ '+_state.products.length+' r√©f√©rence(s)</div>'+
    '<div class="kpis">'+
      '<div class="kpi"><div class="kpi-lbl">Valeur stock (PA)</div><div class="kpi-val">'+fmt(totalVal)+' ‚Ç¨</div></div>'+
      '<div class="kpi"><div class="kpi-lbl">Marge potentielle</div><div class="kpi-val">'+fmt(totalMarge)+' ‚Ç¨</div></div>'+
      '<div class="kpi"><div class="kpi-lbl">Nb r√©f√©rences</div><div class="kpi-val">'+_state.products.length+'</div></div>'+
    '</div>'+
    '<table><thead><tr>'+
      '<th>R√©f.</th><th>Produit</th><th>Cat√©gorie</th>'+
      '<th class="r">PA HT</th><th class="r">PV HT</th><th class="r">Stock</th>'+
      '<th class="r">Seuil</th><th>Statut</th><th class="r">Valeur</th><th class="r">Marge pot.</th>'+
    '</tr></thead><tbody>'+rows+
    '<tr class="total"><td colspan="8" style="padding:8px 10px">TOTAL</td>'+
    '<td style="padding:8px 10px;text-align:right">'+fmt(totalVal)+' ‚Ç¨</td>'+
    '<td style="padding:8px 10px;text-align:right;color:#059669">'+fmt(totalMarge)+' ‚Ç¨</td></tr>'+
    '</tbody></table></body></html>';

  var win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  setTimeout(function(){ win.print(); }, 400);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function escHtml(str) {
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function showToast(msg, err) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + (err ? 'toast-err' : 'toast-ok') + ' show';
  clearTimeout(window._toastTimer);
  window._toastTimer = setTimeout(function(){ t.classList.remove('show'); }, 2800);
}

// Fermer modals sur overlay click
document.getElementById('prodOverlay').addEventListener('click', function(e){ if(e.target===this) closeProdModal(); });
document.getElementById('movOverlay').addEventListener('click', function(e){ if(e.target===this) closeMovModal(); });

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POINT D'ENTR√âE ‚Äî appel√© par Firebase
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.chargerStock = async function() {
  if (!window._uid) return;
  _suppLoaded = false; // reset cache pour ce uid
  await loadFromFirebase();
  renderAll();
};
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FIREBASE ‚Äî MODULE ES6
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
  authDomain: "altiora-70599.firebaseapp.com",
  projectId: "altiora-70599",
  storageBucket: "altiora-70599.firebasestorage.app",
  messagingSenderId: "120905555746",
  appId: "1:120905555746:web:618460c65cdc9e57cc8f7b"
});
const auth = getAuth(app);
const db   = getFirestore(app);

window._auth    = auth;
window._db      = db;
window._doc     = doc;
window._setDoc  = setDoc;
window._getDoc  = getDoc;
window._collection = collection;
window._getDocs = getDocs;
window._signOut = signOut;

window.doLogout = async function() {
  try { if (window._signOut && auth) await window._signOut(auth); } catch(e) {}
  location.href = 'index.html';
};

onAuthStateChanged(auth, function(user) {
  if (!user) { window.location.href = 'index.html'; return; }
  window._uid = user.uid;
  window._firebaseReady = true;
  window.chargerStock();
});
</script>

<script src="nav.js"></script>
</body>
</html>
