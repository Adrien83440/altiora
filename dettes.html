<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ALTIORA ‚Äî Dettes & Emprunts</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --nav:#0f1f5c;--blue:#1a3dce;--blue2:#4f7ef8;--bg:#f4f6fb;
  --border:#e2e8f0;--text:#1a1f36;--muted:#6b7280;
  --green:#10b981;--red:#ef4444;--orange:#f59e0b;--purple:#6366f1;
  --yellow:#fbbf24;--radius:14px;--sw:250px;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px}

/* NAV */
nav{width:var(--sw);min-height:100vh;background:linear-gradient(180deg,#0f1f5c,#162366);position:fixed;top:0;left:0;display:flex;flex-direction:column;padding-bottom:20px;overflow-y:auto;z-index:99}
.logo{display:flex;align-items:center;gap:10px;padding:22px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
.logo-i{width:33px;height:33px;background:rgba(255,255,255,.14);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
.logo-t{font-size:17px;font-weight:800;color:#fff;letter-spacing:1px}
.ns{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 18px 4px}
.ni{display:flex;align-items:center;gap:9px;padding:9px 18px;color:rgba(255,255,255,.55);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.ni:hover{color:#fff;background:rgba(255,255,255,.06)}
.ni.on{color:#fff;background:rgba(255,255,255,.1);border-left-color:#4f7ef8}
.sub{overflow:hidden;max-height:0;transition:max-height .3s}
.sub.open{max-height:200px}
.si{display:flex;align-items:center;gap:7px;padding:7px 18px 7px 40px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.si:hover{color:rgba(255,255,255,.75);background:rgba(255,255,255,.04)}
.si.on{color:#fff;background:rgba(79,126,248,.15);border-left-color:rgba(79,126,248,.6)}
.dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25)}
.si.on .dot{background:#4f7ef8}
.nav-footer{margin-top:auto;padding:12px 18px 0;border-top:1px solid rgba(255,255,255,.08)}
.ucard{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,.07);border-radius:8px}
.uav{width:29px;height:29px;background:linear-gradient(135deg,#4f7ef8,#6366f1);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
.un{font-size:11.5px;font-weight:600;color:#fff}
.upl{font-size:10px;color:rgba(255,255,255,.3)}
.lbtn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,.3);cursor:pointer;font-size:13px}

/* MAIN */
main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.topbar h1{font-size:16px;font-weight:700}
.topbar p{font-size:11px;color:var(--muted)}
.tb-r{display:flex;gap:8px;align-items:center}
.btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:5px}
.btn-p{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;box-shadow:0 3px 10px rgba(26,61,206,.2)}
.btn-o{background:#fff;color:var(--blue);border:1.5px solid var(--border)}
.btn-o:hover{border-color:var(--blue2)}
.btn-xs{padding:4px 9px;font-size:11px}
.btn-d{background:#fef2f2;color:var(--red);border:1px solid #fecaca}
.btn-g{background:#f0fdf4;color:var(--green);border:1px solid #bbf7d0}
.badge{font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;vertical-align:middle}
.badge-blue{background:#dbeafe;color:#1d4ed8}
.badge-red{background:#fee2e2;color:#b91c1c}
.badge-orange{background:#fef3c7;color:#92400e}
.badge-green{background:#d1fae5;color:#065f46}
.badge-purple{background:#ede9fe;color:#5b21b6}

/* PAGE */
.page{padding:20px 24px;display:flex;flex-direction:column;gap:18px}

/* ALERTES */
.alert-bar{background:linear-gradient(135deg,#fef3c7,#fde68a);border:1px solid #fcd34d;border-radius:12px;padding:14px 18px;display:flex;align-items:center;gap:12px}
.alert-bar.hidden{display:none}
.alert-icon{font-size:20px;flex-shrink:0}
.alert-text{flex:1;font-size:12px;font-weight:600;color:#92400e}
.alert-items{display:flex;flex-direction:column;gap:3px;margin-top:4px;font-size:11px;font-weight:500;color:#78350f}

/* KPIs */
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px 16px}
.kpi.red{background:#fef2f2;border-color:#fecaca}
.kpi.orange{background:#fffbeb;border-color:#fde68a}
.kpi.green{background:#f0fdf4;border-color:#bbf7d0}
.kpi.purple{background:#f5f3ff;border-color:#ddd6fe}
.kpi.blue{background:#eff6ff;border-color:#bfdbfe}
.kpi-ico{font-size:18px;margin-bottom:5px}
.kpi-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.kpi-val{font-size:19px;font-weight:800;margin-top:2px}
.kpi-sub{font-size:10px;color:var(--muted);margin-top:1px}

/* TABS */
.tabs{display:flex;gap:4px;background:#f1f5f9;border-radius:10px;padding:4px;width:fit-content}
.tab{padding:7px 16px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;color:var(--muted);transition:.15s;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif}
.tab.on{background:#fff;color:var(--blue);box-shadow:0 1px 4px rgba(0,0,0,.1)}

/* SECTION */
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.section-title{font-size:14px;font-weight:700}
.section-sub{font-size:11px;color:var(--muted);margin-top:1px}

/* DETTE CARDS */
.dette-grid{display:flex;flex-direction:column;gap:12px}
.dette-card{background:#fff;border:1px solid var(--border);border-radius:14px;overflow:hidden;transition:.15s}
.dette-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.07)}
.dette-card.alerte{border-left:4px solid var(--red)}
.dette-card.bientot{border-left:4px solid var(--orange)}
.dette-head{padding:14px 18px;display:flex;align-items:center;gap:12px;cursor:pointer;user-select:none}
.dette-type-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0}
.dette-info{flex:1;min-width:0}
.dette-nom{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px}
.dette-meta{font-size:11px;color:var(--muted);margin-top:1px}
.dette-stats{display:flex;gap:20px;align-items:center}
.dette-stat{text-align:right}
.dette-stat-lbl{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase}
.dette-stat-val{font-size:14px;font-weight:800}
.dette-stat-val.red{color:var(--red)}
.dette-stat-val.green{color:var(--green)}
.dette-stat-val.orange{color:var(--orange)}
.dette-chevron{font-size:16px;color:var(--muted);transition:transform .25s;flex-shrink:0}
.dette-card.open .dette-chevron{transform:rotate(90deg)}

/* D√âTAIL DETTE */
.dette-detail{display:none;border-top:1px solid var(--border)}
.dette-card.open .dette-detail{display:block}
.dette-detail-body{padding:18px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:18px}
.detail-section{background:#f8faff;border:1px solid var(--border);border-radius:10px;padding:14px}
.detail-section-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.field-row{display:flex;flex-direction:column;gap:4px;margin-bottom:10px}
.field-row:last-child{margin-bottom:0}
.field-lbl{font-size:11px;font-weight:600;color:var(--muted)}
.field-wrap{display:flex;align-items:center;gap:7px;padding:8px 11px;border:1.5px solid var(--border);border-radius:8px;background:#fff;transition:.15s}
.field-wrap:focus-within{border-color:var(--blue2);box-shadow:0 0 0 3px rgba(79,126,248,.1)}
.field-in{flex:1;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;color:var(--text);outline:none;min-width:0}
.field-in::placeholder{color:#cbd5e1;font-weight:400}
.field-unit{font-size:11px;font-weight:700;color:var(--muted);flex-shrink:0}
.field-sel{flex:1;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;color:var(--text);outline:none;cursor:pointer}

/* PROGRESSBAR */
.prog-wrap{margin:14px 0}
.prog-head{display:flex;justify-content:space-between;font-size:11px;font-weight:600;margin-bottom:5px}
.prog-bar{height:10px;background:#f1f5f9;border-radius:99px;overflow:hidden}
.prog-fill{height:100%;border-radius:99px;transition:width .6s ease}

/* √âCH√âANCIER */
.echeancier-wrap{overflow-x:auto;margin-top:14px}
.ech-table{width:100%;border-collapse:collapse;font-size:12px}
.ech-table th{padding:8px 12px;text-align:right;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;background:#f8faff;border-bottom:1px solid var(--border)}
.ech-table th:first-child{text-align:left}
.ech-table td{padding:8px 12px;border-bottom:1px solid #f1f5f9;text-align:right}
.ech-table td:first-child{text-align:left;font-weight:600}
.ech-table tr.payee td{color:var(--muted);text-decoration:line-through}
.ech-table tr.aujourd-hui td{background:#fffbeb;font-weight:700}
.ech-table tr.en-retard td{background:#fef2f2;color:var(--red);font-weight:700}
.ech-paid-btn{padding:2px 8px;font-size:10px;border-radius:5px;cursor:pointer;border:none;font-family:'Plus Jakarta Sans',sans-serif;font-weight:600}

/* CHARTS */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px}
.card-t{font-size:13px;font-weight:700;margin-bottom:12px}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(15,31,92,.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center}
.overlay.show{display:flex}
.modal{background:#fff;border-radius:18px;width:100%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 60px rgba(15,31,92,.2)}
.modal-head{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:#fff;z-index:1}
.modal-head h3{font-size:15px;font-weight:700}
.modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted)}
.modal-body{padding:20px 24px}
.modal-footer{padding:14px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
.mfield{display:flex;flex-direction:column;gap:5px;margin-bottom:14px}
.mfield label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.mfield-wrap{display:flex;align-items:center;gap:8px;padding:9px 13px;border:2px solid var(--border);border-radius:10px;background:#f8faff;transition:.15s}
.mfield-wrap:focus-within{border-color:var(--blue2);background:#fff;box-shadow:0 0 0 3px rgba(79,126,248,.1)}
.mfield-in{flex:1;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;color:var(--text);outline:none}
.mfield-in::placeholder{color:#cbd5e1;font-weight:400;font-size:13px}
.mfield-sel{flex:1;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;color:var(--text);outline:none;cursor:pointer}
.mfield-unit{font-size:12px;font-weight:700;color:var(--muted)}
.type-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px}
.type-btn{padding:12px;border:2px solid var(--border);border-radius:10px;cursor:pointer;text-align:center;background:#fff;transition:.15s;font-family:'Plus Jakarta Sans',sans-serif}
.type-btn:hover{border-color:var(--blue2);background:#eff6ff}
.type-btn.on{border-color:var(--blue);background:#eff6ff}
.type-btn-icon{font-size:22px;margin-bottom:4px}
.type-btn-lbl{font-size:12px;font-weight:700;color:var(--text)}
.mgrid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}

.toast{position:fixed;bottom:18px;right:18px;padding:10px 16px;border-radius:9px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(60px);opacity:0;transition:.3s}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{background:#10b981;color:#fff}
.toast.err{background:#ef4444;color:#fff}

/* R√©sum√© annuel */
.calendar-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:4px}
.cal-month{background:#f8faff;border-radius:8px;padding:8px 6px;text-align:center}
.cal-month-name{font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:4px}
.cal-month-amount{font-size:11px;font-weight:800;color:var(--text)}
.cal-month.has-payment{background:#fff4e5;border:1px solid #fcd34d}
.cal-month.overdue{background:#fef2f2;border:1px solid #fecaca}
.ucard:hover{background:rgba(255,255,255,.12);transform:translateY(-1px);transition:.15s}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   RESPONSIVE UNIVERSEL ‚Äî ALTIORA
   Mobile first: < 768px
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* HAMBURGER BUTTON */
.hamburger {
  display: none;
  position: fixed;
  top: 12px;
  left: 12px;
  z-index: 200;
  width: 40px;
  height: 40px;
  background: #0f1f5c;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 5px;
  box-shadow: 0 2px 12px rgba(15,31,92,.3);
}
.hamburger span {
  display: block;
  width: 18px;
  height: 2px;
  background: white;
  border-radius: 2px;
  transition: all .25s;
}
.hamburger.open span:nth-child(1){ transform: translateY(7px) rotate(45deg); }
.hamburger.open span:nth-child(2){ opacity: 0; }
.hamburger.open span:nth-child(3){ transform: translateY(-7px) rotate(-45deg); }

/* OVERLAY FERMETURE SIDEBAR */
.nav-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.45);
  z-index: 98;
}
.nav-overlay.show { display: block; }

@media (max-width: 768px) {

  /* SIDEBAR ‚Üí DRAWER */
  .hamburger { display: flex !important; }

  nav, .sidebar {
    transform: translateX(-100%);
    transition: transform .28s cubic-bezier(.4,0,.2,1);
    z-index: 99;
    width: 260px !important;
  }
  nav.open, .sidebar.open {
    transform: translateX(0);
  }

  /* MAIN PREND TOUTE LA LARGEUR */
  main, .main {
    margin-left: 0 !important;
  }

  /* TOPBAR : padding left pour le hamburger */
  .topbar {
    padding-left: 62px !important;
    flex-wrap: wrap;
    gap: 8px;
  }
  .topbar h1 { font-size: 14px !important; }
  .topbar p  { font-size: 10px !important; }
  .tb-r, .topbar-right {
    width: 100%;
    justify-content: flex-end;
    flex-wrap: wrap;
  }

  /* PAGE PADDING */
  .page, .content {
    padding: 14px 12px !important;
    gap: 12px !important;
  }

  /* TOUTES LES GRILLES ‚Üí 1 COLONNE */
  .kpi-row, .kpi-grid,
  .g2, .g3,
  .charts-row, .charts-row-3,
  .charts-2, .charts-3,
  .fields-grid, .mgrid2,
  .sim-grid, .sim-levers, .sim-g,
  .detail-grid, .results-row,
  .plan-grid, .cats, .cats-grid,
  .cat-grid, .fact-kpis,
  .type-grid {
    grid-template-columns: 1fr !important;
  }

  /* 2 colonnes pour les KPIs (compromis) */
  .kpi-row, .kpi-grid, .fact-kpis {
    grid-template-columns: 1fr 1fr !important;
  }

  /* TABLEAUX SCROLLABLES */
  table, .data-table, .ech-table, .fact-table {
    font-size: 11px !important;
  }
  [style*="overflow-x:auto"],
  .echeancier-wrap,
  .table-card > div {
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch;
  }
  /* Wrapper auto sur tous les tableaux */
  table {
    min-width: 500px;
  }

  /* INPUTS + BOUTONS PLUS GRANDS (TOUCH) */
  .field-in, .mfield-in, .field-sel, .mfield-sel,
  .field-wrap, .mfield-wrap,
  .sim-input, .sim-fi,
  .cell-input,
  input[type=number], input[type=text],
  input[type=email], input[type=date],
  input[type=tel], select, textarea {
    font-size: 16px !important; /* √©vite zoom iOS */
    min-height: 44px !important;
  }
  .field-wrap, .mfield-wrap, .sim-input-wrap, .sim-fw {
    padding: 10px 14px !important;
  }

  /* BOUTONS */
  .btn, button.btn {
    min-height: 40px !important;
    padding: 9px 14px !important;
    font-size: 12px !important;
  }
  .btn-xs { min-height: 34px !important; padding: 6px 10px !important; }

  /* HERO PROFIL */
  .hero {
    flex-direction: column !important;
    text-align: center;
    padding: 20px 16px !important;
  }
  .hero-right { margin-top: 8px; }
  .hero-tags { justify-content: center; }

  /* MONTH STRIP */
  .month-strip {
    gap: 4px !important;
  }
  .mbtn {
    padding: 5px 8px !important;
    font-size: 11px !important;
  }

  /* DETTE CARDS */
  .dette-stats {
    flex-direction: column !important;
    gap: 6px !important;
    align-items: flex-start !important;
  }
  .dette-head {
    flex-wrap: wrap;
    gap: 8px;
  }

  /* MODAL */
  .modal {
    margin: 8px;
    max-height: 95vh;
    border-radius: 14px;
  }

  /* SAISIE SECTION */
  .saisie-head {
    flex-direction: column !important;
    gap: 8px !important;
  }

  /* YEAR BAR */
  .yr-bar, .year-bar {
    flex-wrap: wrap;
    gap: 4px !important;
  }

  /* TABS */
  .tabs {
    flex-wrap: wrap !important;
    width: 100% !important;
  }
  .tab { flex: 1; text-align: center; }

  /* CALENDAR GRID */
  .calendar-grid {
    grid-template-columns: repeat(4, 1fr) !important;
    gap: 6px !important;
  }

  /* SIM RESULT */
  .sim-res-grid, .sim-rg {
    grid-template-columns: 1fr 1fr !important;
    gap: 10px !important;
  }
}

@media (max-width: 480px) {
  .kpi-row, .kpi-grid, .fact-kpis {
    grid-template-columns: 1fr !important;
  }
  .sim-res-grid, .sim-rg {
    grid-template-columns: 1fr !important;
  }
}

</style>
</head>
<body>

<nav>
  <div class="logo"><div class="logo-i">üìä</div><div class="logo-t">ALTIORA</div></div>
  <div class="ns">Principal</div>
  <div class="ni" id="nav-dashboard" onclick="location.href='dashboard.html'"><span>üè†</span><span>Tableau de bord</span></div>
  <div class="ni" id="nav-suivi" onclick="location.href='suivi-ca.html'"><span>üìà</span><span>Suivi CA & R√©sultats</span></div>
  <div class="ni" id="nav-kpis" onclick="toggleNav('kpis-sub',this)"><span>üéØ</span><span style="flex:1">KPIs Cl√©s</span><span class="chev" id="chev-kpis">‚Ä∫</span></div>
  <div class="sub" id="kpis-sub">
    <div class="si" id="nav-cout" onclick="location.href='cout-revient.html'"><span class="dot"></span>Co√ªt de revient</div>
    <div class="si" id="nav-marges" onclick="location.href='marges.html'"><span class="dot"></span>Marge brute &amp; nette</div>
    <div class="si" id="nav-panier" onclick="location.href='panier-moyen.html'"><span class="dot"></span>Panier moyen</div>
  </div>
  <div class="ni" id="nav-pilotage" onclick="toggleNav('pil-sub',this)"><span>üß≠</span><span style="flex:1">Pilotage</span><span class="chev" id="chev-pil">‚Ä∫</span></div>
  <div class="sub" id="pil-sub">
    <div class="si" onclick="location.href='pilotage.html?year=2025'"><span class="dot"></span>Pilotage 2025</div>
    <div class="si" onclick="location.href='pilotage.html?year=2026'"><span class="dot"></span>Pilotage 2026</div>
    <div class="si" onclick="location.href='pilotage.html?year=2027'"><span class="dot"></span>Pilotage 2027</div>
  </div>
  <div class="ni" id="nav-dettes" onclick="location.href='dettes.html'"><span>üè¶</span><span>Dettes &amp; Emprunts</span></div>
  <div class="ns">Mon espace</div>
  <div class="ni" onclick="location.href='compte.html'"><span>üë§</span><span>Mon compte</span></div>
  <div class="nav-footer">
    <div class="ucard" onclick="location.href='profil.html'" style="cursor:pointer;transition:.15s" title="Mon compte">
      <div class="uav" id="av">A</div>
      <div><div class="un" id="uname">Utilisateur</div><div class="upl">Plan gratuit</div></div>
      <button class="lbtn" onclick="doLogout()">‚éã</button>
    </div>
  </div>
</nav>

<main>
  <div class="topbar">
    <div>
      <h1>üè¶ Dettes & Emprunts</h1>
      <p>G√©rez l'ensemble de vos dettes, √©ch√©anciers et paiements ‚Äî vue consolid√©e en temps r√©el</p>
    </div>
    <div class="tb-r">
      <button class="btn btn-o" onclick="location.href='dashboard.html'">‚Üê Dashboard</button>
      <button class="btn btn-p" onclick="openModal()">+ Ajouter une dette</button>
    </div>
  </div>

  <div class="page">

    <!-- ALERTES -->
    <div class="alert-bar hidden" id="alertBar">
      <div class="alert-icon">‚ö†Ô∏è</div>
      <div>
        <div class="alert-text">√âch√©ances √† surveiller</div>
        <div class="alert-items" id="alertItems"></div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-row">
      <div class="kpi red"><div class="kpi-ico">üí∞</div><div class="kpi-lbl">Total dettes restantes</div><div class="kpi-val" id="k-total">‚Äî</div><div class="kpi-sub">Solde d√ª consolid√©</div></div>
      <div class="kpi orange"><div class="kpi-ico">üìÖ</div><div class="kpi-lbl">√âch√©ances ce mois</div><div class="kpi-val" id="k-mois">‚Äî</div><div class="kpi-sub">√Ä payer ce mois-ci</div></div>
      <div class="kpi blue"><div class="kpi-ico">üìÜ</div><div class="kpi-lbl">√âch√©ances 3 prochains mois</div><div class="kpi-val" id="k-3mois">‚Äî</div><div class="kpi-sub">Projection tr√©sorerie</div></div>
      <div class="kpi green"><div class="kpi-ico">‚úÖ</div><div class="kpi-lbl">D√©j√† rembours√©</div><div class="kpi-val" id="k-rembourse">‚Äî</div><div class="kpi-sub">Cumul paiements</div></div>
      <div class="kpi purple"><div class="kpi-ico">üìä</div><div class="kpi-lbl">Nb dettes actives</div><div class="kpi-val" id="k-nb">‚Äî</div><div class="kpi-sub">En cours</div></div>
    </div>

    <!-- CALENDRIER ANNUEL -->
    <div class="card">
      <div class="card-t">üìÖ Calendrier des √©ch√©ances <span style="font-size:11px;color:var(--muted);font-weight:400" id="calYear"></span></div>
      <div class="calendar-grid" id="calGrid"></div>
    </div>

    <!-- GRAPHIQUES -->
    <div class="g2">
      <div class="card"><div class="card-t">üìâ √âvolution solde restant d√ª</div><div style="height:200px"><canvas id="cSolde"></canvas></div></div>
      <div class="card"><div class="card-t">üç© R√©partition par type</div><div style="height:200px"><canvas id="cType"></canvas></div></div>
    </div>

    <!-- TABS + LISTE -->
    <div>
      <div class="section-head">
        <div>
          <div class="section-title">üìã Mes dettes</div>
          <div class="section-sub">Cliquez sur une dette pour voir le d√©tail et l'√©ch√©ancier</div>
        </div>
        <div class="tabs" id="filterTabs">
          <button class="tab on" onclick="setFilter('tous',this)">Toutes</button>
          <button class="tab" onclick="setFilter('emprunt',this)">üè¶ Emprunts</button>
          <button class="tab" onclick="setFilter('fournisseur',this)">üì¶ Fournisseurs</button>
          <button class="tab" onclick="setFilter('leasing',this)">üöó Leasing</button>
          <button class="tab" onclick="setFilter('decouvert',this)">üí≥ D√©couvert</button>
        </div>
      </div>
      <div class="dette-grid" id="detteGrid">
        <div style="text-align:center;padding:40px;color:var(--muted);font-size:13px">
          <div style="font-size:40px;margin-bottom:12px">üè¶</div>
          <div style="font-weight:700;margin-bottom:4px">Aucune dette enregistr√©e</div>
          <div>Cliquez sur "+ Ajouter une dette" pour commencer</div>
        </div>
      </div>
    </div>

  </div>
</main>

<!-- MODAL AJOUT -->
<div class="overlay" id="overlay">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modalTitle">‚ûï Nouvelle dette</h3>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <!-- TYPE -->
      <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:8px">Type de dette</div>
      <div class="type-grid">
        <div class="type-btn on" id="type-emprunt" onclick="selectType('emprunt')"><div class="type-btn-icon">üè¶</div><div class="type-btn-lbl">Emprunt bancaire</div></div>
        <div class="type-btn" id="type-fournisseur" onclick="selectType('fournisseur')"><div class="type-btn-icon">üì¶</div><div class="type-btn-lbl">Dette fournisseur</div></div>
        <div class="type-btn" id="type-leasing" onclick="selectType('leasing')"><div class="type-btn-icon">üöó</div><div class="type-btn-lbl">Cr√©dit-bail / Leasing</div></div>
        <div class="type-btn" id="type-decouvert" onclick="selectType('decouvert')"><div class="type-btn-icon">üí≥</div><div class="type-btn-lbl">D√©couvert bancaire</div></div>
      </div>

      <!-- INFOS G√âN√âRALES -->
      <div class="mfield">
        <label>Nom / Description</label>
        <div class="mfield-wrap"><input class="mfield-in" id="m-nom" placeholder="ex: Pr√™t BNP Paribas, Fournisseur ABC..."/></div>
      </div>
      <div class="mgrid2">
        <div class="mfield">
          <label>Montant initial (‚Ç¨)</label>
          <div class="mfield-wrap"><input class="mfield-in" id="m-montant" type="number" placeholder="50000" oninput="calcPreview()"/><span class="mfield-unit">‚Ç¨</span></div>
        </div>
        <div class="mfield">
          <label>Date de d√©but</label>
          <div class="mfield-wrap"><input class="mfield-in" id="m-debut" type="date"/></div>
        </div>
      </div>

      <!-- CHAMPS SELON TYPE -->
      <div id="champs-emprunt">
        <div class="mgrid2">
          <div class="mfield">
            <label>Taux d'int√©r√™t annuel (%)</label>
            <div class="mfield-wrap"><input class="mfield-in" id="m-taux" type="number" step="0.01" placeholder="3.5" oninput="calcPreview()"/><span class="mfield-unit">%</span></div>
          </div>
          <div class="mfield">
            <label>Dur√©e (mois)</label>
            <div class="mfield-wrap"><input class="mfield-in" id="m-duree" type="number" placeholder="60" oninput="calcPreview()"/><span class="mfield-unit">mois</span></div>
          </div>
        </div>
        <div class="mfield">
          <label>Type d'amortissement</label>
          <div class="mfield-wrap"><select class="mfield-sel" id="m-amort" onchange="calcPreview()">
            <option value="constant">Mensualit√©s constantes (amortissement d√©gressif)</option>
            <option value="lineaire">Capital constant (amortissement lin√©aire)</option>
            <option value="infine">In fine (int√©r√™ts seuls + capital √† terme)</option>
          </select></div>
        </div>
      </div>

      <div id="champs-fournisseur" style="display:none">
        <div class="mgrid2">
          <div class="mfield">
            <label>Date d'√©ch√©ance</label>
            <div class="mfield-wrap"><input class="mfield-in" id="m-echeance" type="date"/></div>
          </div>
          <div class="mfield">
            <label>R√©f√©rence facture</label>
            <div class="mfield-wrap"><input class="mfield-in" id="m-ref" placeholder="FAC-2024-001"/></div>
          </div>
        </div>
      </div>

      <div id="champs-leasing" style="display:none">
        <div class="mgrid2">
          <div class="mfield">
            <label>Loyer mensuel HT (‚Ç¨)</label>
            <div class="mfield-wrap"><input class="mfield-in" id="m-loyer" type="number" placeholder="800" oninput="calcPreview()"/><span class="mfield-unit">‚Ç¨/mois</span></div>
          </div>
          <div class="mfield">
            <label>Dur√©e (mois)</label>
            <div class="mfield-wrap"><input class="mfield-in" id="m-duree-lea" type="number" placeholder="48" oninput="calcPreview()"/><span class="mfield-unit">mois</span></div>
          </div>
        </div>
      </div>

      <div id="champs-decouvert" style="display:none">
        <div class="mgrid2">
          <div class="mfield">
            <label>Plafond autoris√© (‚Ç¨)</label>
            <div class="mfield-wrap"><input class="mfield-in" id="m-plafond" type="number" placeholder="10000"/><span class="mfield-unit">‚Ç¨</span></div>
          </div>
          <div class="mfield">
            <label>Taux d'int√©r√™t (%)</label>
            <div class="mfield-wrap"><input class="mfield-in" id="m-taux-dec" type="number" placeholder="12" oninput="calcPreview()"/><span class="mfield-unit">% / an</span></div>
          </div>
        </div>
      </div>

      <!-- APER√áU -->
      <div id="preview" style="background:#f0fdf4;border:1.5px solid #86efac;border-radius:10px;padding:12px 14px;display:none;margin-top:4px">
        <div style="font-size:11px;font-weight:700;color:#065f46;margin-bottom:6px">‚úÖ Aper√ßu calcul√©</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px" id="previewContent"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-o" onclick="closeModal()">Annuler</button>
      <button class="btn btn-p" onclick="saveDette()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ CONSTANTES ‚îÄ‚îÄ
const MONTHS=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
const MONTHS_SHORT=['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];
const TYPE_CONFIG={
  emprunt:{icon:'üè¶',label:'Emprunt bancaire',color:'#4f7ef8',bg:'#eff6ff'},
  fournisseur:{icon:'üì¶',label:'Fournisseur',color:'#f59e0b',bg:'#fffbeb'},
  leasing:{icon:'üöó',label:'Leasing',color:'#6366f1',bg:'#f5f3ff'},
  decouvert:{icon:'üí≥',label:'D√©couvert',color:'#ef4444',bg:'#fef2f2'},
};
let _dettes=[], _filter='tous', _editId=null, _selectedType='emprunt', _charts={};

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ
function load(){try{const d=localStorage.getItem('altiora_dettes');if(d)_dettes=JSON.parse(d);}catch(e){}_dettes=_dettes||[];}
function save(){localStorage.setItem('altiora_dettes',JSON.stringify(_dettes));}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function fe(n,dec=2){return(parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:dec,maximumFractionDigits:dec})+' ‚Ç¨';}
function fi(n){return Math.round(parseFloat(n)||0).toLocaleString('fr-FR');}
function uid(){return Date.now()+'_'+Math.random().toString(36).slice(2);}
function fdate(d){if(!d)return'‚Äî';const dt=new Date(d);return dt.toLocaleDateString('fr-FR');}
function addMonths(date,n){const d=new Date(date);d.setMonth(d.getMonth()+n);return d;}
function set(id,v){const e=document.getElementById(id);if(e)e.textContent=v;}
function showToast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(()=>t.className='toast',3000);}
function toggleKpis(el){document.getElementById('ksub').classList.toggle('open');}
function togglePil(el){document.getElementById('psub').classList.toggle('open');}
async function doLogout(){try{if(window._signOut&&window._auth)await window._signOut(window._auth);}catch(e){}location.href='index.html';}

// ‚îÄ‚îÄ CALCUL √âCH√âANCIER ‚îÄ‚îÄ
function calcEcheancier(d){
  const m=parseFloat(d.montant)||0, taux=parseFloat(d.taux)||0, duree=parseInt(d.duree)||0;
  const debut=new Date(d.debut);
  let rows=[];

  if(d.type==='fournisseur'){
    rows=[{date:d.echeance||d.debut,capital:m,interet:0,mensualite:m,solde:0,idx:0}];
    return rows;
  }

  if(d.type==='decouvert'){
    // Int√©r√™ts mensuels sur solde
    const tauxM=taux/12/100;
    rows=[{date:d.debut,capital:0,interet:m*tauxM,mensualite:m*tauxM,solde:m,idx:0,note:'Int√©r√™ts mensuels'}];
    return rows;
  }

  if(d.type==='leasing'){
    const loyer=parseFloat(d.loyer)||0;
    for(let i=0;i<duree;i++){
      const dt=addMonths(debut,i+1);
      rows.push({date:dt.toISOString().slice(0,10),capital:0,interet:0,mensualite:loyer,solde:m-(loyer*(i+1)),idx:i});
    }
    return rows;
  }

  // Emprunt bancaire
  const tauxM=taux/12/100;
  if(d.amort==='infine'){
    const intM=m*tauxM;
    for(let i=0;i<duree;i++){
      const dt=addMonths(debut,i+1);
      const isLast=i===duree-1;
      rows.push({date:dt.toISOString().slice(0,10),capital:isLast?m:0,interet:intM,mensualite:isLast?m+intM:intM,solde:isLast?0:m,idx:i});
    }
    return rows;
  }

  if(d.amort==='lineaire'){
    const capM=m/duree;
    let solde=m;
    for(let i=0;i<duree;i++){
      const interet=solde*tauxM;
      const dt=addMonths(debut,i+1);
      rows.push({date:dt.toISOString().slice(0,10),capital:capM,interet,mensualite:capM+interet,solde:Math.max(0,solde-capM),idx:i});
      solde-=capM;
    }
    return rows;
  }

  // Mensualit√©s constantes (d√©faut)
  if(tauxM===0){
    const capM=m/duree; let solde=m;
    for(let i=0;i<duree;i++){
      const dt=addMonths(debut,i+1);
      rows.push({date:dt.toISOString().slice(0,10),capital:capM,interet:0,mensualite:capM,solde:Math.max(0,solde-capM),idx:i});
      solde-=capM;
    }
    return rows;
  }
  const mensualite=m*(tauxM*Math.pow(1+tauxM,duree))/(Math.pow(1+tauxM,duree)-1);
  let solde=m;
  for(let i=0;i<duree;i++){
    const interet=solde*tauxM;
    const capital=mensualite-interet;
    const dt=addMonths(debut,i+1);
    rows.push({date:dt.toISOString().slice(0,10),capital,interet,mensualite,solde:Math.max(0,solde-capital),idx:i});
    solde-=capital;
  }
  return rows;
}

function getSoldeRestant(d){
  const ech=calcEcheancier(d);
  const paid=d.paiements||[];
  const paidSet=new Set(paid);
  const remaining=ech.filter(r=>!paidSet.has(r.idx));
  if(!remaining.length)return 0;
  if(d.type==='fournisseur')return remaining.reduce((s,r)=>s+r.mensualite,0);
  return remaining.length>0?remaining[0].solde+(remaining[0].capital||0):0;
}

function getSoldeRestantPrecis(d){
  const ech=calcEcheancier(d);
  const paid=new Set(d.paiements||[]);
  // Solde = dernier solde apr√®s les paiements effectu√©s
  let lastPaid=-1;
  ech.forEach(r=>{if(paid.has(r.idx))lastPaid=r.idx;});
  if(lastPaid===-1)return parseFloat(d.montant)||0;
  const row=ech.find(r=>r.idx===lastPaid);
  return row?row.solde:0;
}

function getTotalRembourse(d){
  const ech=calcEcheancier(d);
  const paid=new Set(d.paiements||[]);
  return ech.filter(r=>paid.has(r.idx)).reduce((s,r)=>s+(r.capital||r.mensualite||0),0);
}

function getEchCeMois(d){
  const now=new Date(); const ym=now.getFullYear()*100+now.getMonth();
  const ech=calcEcheancier(d);
  const paid=new Set(d.paiements||[]);
  return ech.filter(r=>{
    const dt=new Date(r.date); const rym=dt.getFullYear()*100+dt.getMonth();
    return rym===ym&&!paid.has(r.idx);
  }).reduce((s,r)=>s+r.mensualite,0);
}

function getEch3Mois(d){
  const now=new Date();
  const fin=new Date(now); fin.setMonth(fin.getMonth()+3);
  const ech=calcEcheancier(d);
  const paid=new Set(d.paiements||[]);
  return ech.filter(r=>{
    const dt=new Date(r.date);
    return dt>=now&&dt<=fin&&!paid.has(r.idx);
  }).reduce((s,r)=>s+r.mensualite,0);
}

// ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ
function renderKPIs(){
  const actives=_dettes.filter(d=>d.active!==false);
  const total=actives.reduce((s,d)=>s+getSoldeRestantPrecis(d),0);
  const mois=actives.reduce((s,d)=>s+getEchCeMois(d),0);
  const trois=actives.reduce((s,d)=>s+getEch3Mois(d),0);
  const rembourse=actives.reduce((s,d)=>s+getTotalRembourse(d),0);
  set('k-total',fe(total)); set('k-mois',fe(mois));
  set('k-3mois',fe(trois)); set('k-rembourse',fe(rembourse));
  set('k-nb',actives.length.toString());
}

// ‚îÄ‚îÄ ALERTES ‚îÄ‚îÄ
function renderAlertes(){
  const now=new Date();
  const soon=new Date(now); soon.setDate(soon.getDate()+7);
  const alerts=[];
  _dettes.filter(d=>d.active!==false).forEach(d=>{
    const ech=calcEcheancier(d);
    const paid=new Set(d.paiements||[]);
    ech.forEach(r=>{
      if(paid.has(r.idx))return;
      const dt=new Date(r.date);
      if(dt<now)alerts.push({nom:d.nom,date:fdate(r.date),montant:r.mensualite,type:'retard'});
      else if(dt<=soon)alerts.push({nom:d.nom,date:fdate(r.date),montant:r.mensualite,type:'bientot'});
    });
  });
  const bar=document.getElementById('alertBar');
  const items=document.getElementById('alertItems');
  if(!alerts.length){bar.classList.add('hidden');return;}
  bar.classList.remove('hidden');
  items.innerHTML=alerts.slice(0,5).map(a=>
    `<div>‚Ä¢ ${a.nom} ‚Äî ${a.date} ‚Äî ${fe(a.montant)} ${a.type==='retard'?'üî¥ EN RETARD':'üü° dans 7 jours'}</div>`
  ).join('');
}

// ‚îÄ‚îÄ CALENDRIER ANNUEL ‚îÄ‚îÄ
function renderCalendar(){
  const now=new Date(); const yr=now.getFullYear();
  document.getElementById('calYear').textContent=yr;
  const monthly=Array(12).fill(0);
  _dettes.filter(d=>d.active!==false).forEach(d=>{
    const ech=calcEcheancier(d);
    ech.forEach(r=>{
      const dt=new Date(r.date);
      if(dt.getFullYear()===yr)monthly[dt.getMonth()]+=r.mensualite;
    });
  });
  const max=Math.max(...monthly,1);
  const calGrid=document.getElementById('calGrid');
  const curM=now.getMonth();
  calGrid.innerHTML=MONTHS_SHORT.map((m,i)=>{
    const amt=monthly[i];
    const isPast=i<curM; const isCur=i===curM;
    let cls='cal-month'; if(amt>0)cls+=' has-payment'; if(isPast&&amt>0)cls+=' overdue';
    return`<div class="${cls}">
      <div class="cal-month-name" style="${isCur?'color:var(--blue);font-weight:800':''}">${m}</div>
      <div class="cal-month-amount" style="color:${amt>0?(isPast?'var(--red)':'var(--orange)'):'var(--muted)'}">${amt>0?fe(amt,0):'‚Äî'}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ GRAPHIQUES ‚îÄ‚îÄ
function dc(id){if(_charts[id]){try{_charts[id].destroy();}catch(e){}delete _charts[id];}}

function renderCharts(){
  // Solde restant dans le temps
  const now=new Date(); const yr=now.getFullYear();
  const monthly=Array(12).fill(0);
  _dettes.filter(d=>d.active!==false).forEach(d=>{
    let solde=getSoldeRestantPrecis(d);
    const ech=calcEcheancier(d);
    const paid=new Set(d.paiements||[]);
    for(let i=0;i<12;i++){
      const month=i;
      ech.filter(r=>{const dt=new Date(r.date);return dt.getFullYear()===yr&&dt.getMonth()===month&&!paid.has(r.idx);})
        .forEach(r=>{solde-=(r.capital||0);});
      monthly[i]+=Math.max(0,solde);
    }
  });

  dc('cSolde');const cs=document.getElementById('cSolde');
  if(cs)_charts.cSolde=new Chart(cs,{type:'line',data:{labels:MONTHS_SHORT,datasets:[{label:'Solde restant d√ª',data:monthly,borderColor:'#ef4444',backgroundColor:'#ef444422',fill:true,tension:.4,pointRadius:4,borderWidth:2.5,spanGaps:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v.toLocaleString('fr-FR')+'‚Ç¨'}}}}});

  // R√©partition par type
  const byType={emprunt:0,fournisseur:0,leasing:0,decouvert:0};
  _dettes.filter(d=>d.active!==false).forEach(d=>{byType[d.type]=(byType[d.type]||0)+getSoldeRestantPrecis(d);});
  const types=Object.keys(byType).filter(t=>byType[t]>0);
  dc('cType');const ct=document.getElementById('cType');
  if(ct){
    if(types.length){
      _charts.cType=new Chart(ct,{type:'doughnut',data:{labels:types.map(t=>TYPE_CONFIG[t].label),datasets:[{data:types.map(t=>byType[t]),backgroundColor:types.map(t=>TYPE_CONFIG[t].color),borderWidth:2,borderColor:'#fff',hoverOffset:5}]},options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{position:'bottom',labels:{font:{size:11},boxWidth:10}}}}});
    } else {
      _charts.cType=new Chart(ct,{type:'doughnut',data:{labels:['Aucune dette'],datasets:[{data:[1],backgroundColor:['#e2e8f0']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
    }
  }
}

// ‚îÄ‚îÄ LISTE DETTES ‚îÄ‚îÄ
function setFilter(f,el){
  _filter=f;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  el.classList.add('on');
  renderDettes();
}

function renderDettes(){
  const grid=document.getElementById('detteGrid');
  let list=_dettes;
  if(_filter!=='tous')list=list.filter(d=>d.type===_filter);
  if(!list.length){
    grid.innerHTML=`<div style="text-align:center;padding:40px;color:var(--muted)"><div style="font-size:36px;margin-bottom:10px">üè¶</div><div style="font-weight:700">Aucune dette${_filter!=='tous'?' de ce type':''}</div></div>`;
    return;
  }

  grid.innerHTML=list.map(d=>{
    const tc=TYPE_CONFIG[d.type]||TYPE_CONFIG.emprunt;
    const solde=getSoldeRestantPrecis(d);
    const montant=parseFloat(d.montant)||0;
    const pct=montant>0?(1-solde/montant)*100:0;
    const rembourse=getTotalRembourse(d);
    const echMois=getEchCeMois(d);
    const now=new Date();
    const ech=calcEcheancier(d);
    const paid=new Set(d.paiements||[]);
    const hasRetard=ech.some(r=>!paid.has(r.idx)&&new Date(r.date)<now);
    const hasBientot=!hasRetard&&ech.some(r=>{const dt=new Date(r.date);const soon=new Date(now);soon.setDate(soon.getDate()+7);return!paid.has(r.idx)&&dt>=now&&dt<=soon;});

    return`<div class="dette-card ${hasRetard?'alerte':hasBientot?'bientot':''}" id="dc-${d.id}">
      <div class="dette-head" onclick="toggleDette('${d.id}')">
        <div class="dette-type-icon" style="background:${tc.bg};color:${tc.color}">${tc.icon}</div>
        <div class="dette-info">
          <div class="dette-nom">
            ${d.nom||'Sans nom'}
            <span class="badge badge-${d.type==='emprunt'?'blue':d.type==='fournisseur'?'orange':d.type==='leasing'?'purple':'red'}">${tc.label}</span>
            ${hasRetard?'<span class="badge badge-red">‚ö†Ô∏è Retard</span>':''}
            ${hasBientot?'<span class="badge badge-orange">üìÖ Bient√¥t</span>':''}
            ${solde<=0?'<span class="badge badge-green">‚úÖ Sold√©e</span>':''}
          </div>
          <div class="dette-meta">
            D√©but : ${fdate(d.debut)} ¬∑ Montant initial : ${fe(montant)}
            ${d.taux?` ¬∑ Taux : ${d.taux}%`:''}${d.duree?` ¬∑ Dur√©e : ${d.duree} mois`:''}
          </div>
          <div class="prog-wrap" style="margin:6px 0 0">
            <div class="prog-head" style="margin-bottom:3px"><span style="font-size:10px;color:var(--muted)">Rembours√©</span><span style="font-size:10px;font-weight:700">${pct.toFixed(1)}%</span></div>
            <div class="prog-bar"><div class="prog-fill" style="width:${Math.min(pct,100)}%;background:${pct>=100?'var(--green)':pct>=50?'var(--blue2)':'var(--orange)'}"></div></div>
          </div>
        </div>
        <div class="dette-stats">
          <div class="dette-stat">
            <div class="dette-stat-lbl">Solde restant</div>
            <div class="dette-stat-val ${solde>0?'red':'green'}">${fe(solde)}</div>
          </div>
          ${echMois>0?`<div class="dette-stat">
            <div class="dette-stat-lbl">Ce mois</div>
            <div class="dette-stat-val orange">${fe(echMois)}</div>
          </div>`:''}
        </div>
        <span class="dette-chevron">‚Ä∫</span>
      </div>
      <div class="dette-detail">
        <div class="dette-detail-body">
          <div style="display:flex;gap:8px;margin-bottom:14px">
            <button class="btn btn-o btn-xs" onclick="editDette('${d.id}')">‚úèÔ∏è Modifier</button>
            <button class="btn btn-d btn-xs" onclick="deleteDette('${d.id}')">üóë Supprimer</button>
          </div>
          ${renderDetailStats(d)}
          ${renderEcheancier(d)}
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderDetailStats(d){
  const solde=getSoldeRestantPrecis(d);
  const montant=parseFloat(d.montant)||0;
  const rembourse=getTotalRembourse(d);
  const ech=calcEcheancier(d);
  const totalInterets=ech.reduce((s,r)=>s+(r.interet||0),0);
  return`<div class="detail-grid">
    <div class="detail-section">
      <div class="detail-section-title">üìä R√©capitulatif</div>
      <div class="cat-row" style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:12px"><span>Montant initial</span><strong>${fe(montant)}</strong></div>
      <div class="cat-row" style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:12px"><span>D√©j√† rembours√©</span><strong style="color:var(--green)">${fe(rembourse)}</strong></div>
      <div class="cat-row" style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:12px"><span>Solde restant d√ª</span><strong style="color:var(--red)">${fe(solde)}</strong></div>
      ${totalInterets>0?`<div class="cat-row" style="display:flex;justify-content:space-between;font-size:12px"><span>Total int√©r√™ts</span><strong style="color:var(--orange)">${fe(totalInterets)}</strong></div>`:''}
    </div>
    <div class="detail-section">
      <div class="detail-section-title">üìÖ Prochaines √©ch√©ances</div>
      ${getProchaines(d)}
    </div>
  </div>`;
}

function getProchaines(d){
  const now=new Date();
  const ech=calcEcheancier(d);
  const paid=new Set(d.paiements||[]);
  const next=ech.filter(r=>!paid.has(r.idx)&&new Date(r.date)>=now).slice(0,3);
  if(!next.length)return'<div style="color:var(--green);font-weight:700;font-size:12px">‚úÖ Toutes les √©ch√©ances sont pay√©es</div>';
  return next.map(r=>`<div style="display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px">
    <span>${fdate(r.date)}</span><strong>${fe(r.mensualite)}</strong></div>`).join('');
}

function renderEcheancier(d){
  const ech=calcEcheancier(d);
  if(!ech.length)return'';
  const paid=new Set(d.paiements||[]);
  const now=new Date();
  const rows=ech.map(r=>{
    const dt=new Date(r.date);
    const isPaid=paid.has(r.idx);
    const isLate=!isPaid&&dt<now;
    const isToday=!isPaid&&dt.getFullYear()===now.getFullYear()&&dt.getMonth()===now.getMonth();
    return`<tr class="${isPaid?'payee':isLate?'en-retard':isToday?'aujourd-hui':''}">
      <td>${fdate(r.date)}${isLate?' üî¥':isToday?' üìç':''}</td>
      ${d.type!=='fournisseur'&&d.type!=='leasing'?`<td>${fe(r.capital||0)}</td><td>${fe(r.interet||0)}</td>`:''}
      <td>${fe(r.mensualite)}</td>
      <td style="color:${r.solde>0?'var(--text)':'var(--green)'}">${fe(r.solde)}</td>
      <td>
        ${isPaid
          ?`<button class="ech-paid-btn" style="background:#f0fdf4;color:var(--green)" onclick="togglePaid('${d.id}',${r.idx})">‚úÖ Pay√©</button>`
          :`<button class="ech-paid-btn" style="background:#f8faff;color:var(--blue2);border:1px solid var(--border)" onclick="togglePaid('${d.id}',${r.idx})">Marquer pay√©</button>`
        }
      </td>
    </tr>`;
  }).join('');

  return`<div class="echeancier-wrap">
    <div style="font-size:12px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px">
      üìã √âch√©ancier complet
      <span style="font-size:10px;color:var(--muted);font-weight:400">(${ech.length} √©ch√©ance${ech.length>1?'s':''})</span>
    </div>
    <table class="ech-table">
      <thead><tr>
        <th style="text-align:left">Date</th>
        ${d.type!=='fournisseur'&&d.type!=='leasing'?'<th>Capital</th><th>Int√©r√™ts</th>':''}
        <th>Montant</th>
        <th>Solde restant</th>
        <th>Statut</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;
}

function toggleDette(id){
  const card=document.getElementById('dc-'+id);
  if(card)card.classList.toggle('open');
}

function togglePaid(id,idx){
  const d=_dettes.find(x=>x.id===id); if(!d)return;
  if(!d.paiements)d.paiements=[];
  const i=d.paiements.indexOf(idx);
  if(i>-1)d.paiements.splice(i,1); else d.paiements.push(idx);
  save(); renderAll(); showToast(i>-1?'Paiement annul√©':'‚úÖ Paiement enregistr√©','ok');
}

function deleteDette(id){
  if(!confirm('Supprimer cette dette ?'))return;
  _dettes=_dettes.filter(d=>d.id!==id); save(); renderAll(); showToast('Dette supprim√©e','ok');
}

function editDette(id){
  const d=_dettes.find(x=>x.id===id); if(!d)return;
  _editId=id; openModal(d);
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(existing=null){
  document.getElementById('overlay').classList.add('show');
  document.getElementById('modalTitle').textContent=existing?'‚úèÔ∏è Modifier la dette':'‚ûï Nouvelle dette';
  if(existing){
    selectType(existing.type);
    document.getElementById('m-nom').value=existing.nom||'';
    document.getElementById('m-montant').value=existing.montant||'';
    document.getElementById('m-debut').value=existing.debut||'';
    document.getElementById('m-taux').value=existing.taux||'';
    document.getElementById('m-duree').value=existing.duree||'';
    document.getElementById('m-amort').value=existing.amort||'constant';
    document.getElementById('m-echeance').value=existing.echeance||'';
    document.getElementById('m-ref').value=existing.ref||'';
    document.getElementById('m-loyer').value=existing.loyer||'';
    document.getElementById('m-duree-lea').value=existing.dureeLea||'';
    document.getElementById('m-plafond').value=existing.plafond||'';
    document.getElementById('m-taux-dec').value=existing.tauxDec||'';
    calcPreview();
  } else {
    _editId=null; resetModal();
  }
}

function closeModal(){document.getElementById('overlay').classList.remove('show');}

function resetModal(){
  ['m-nom','m-montant','m-debut','m-taux','m-duree','m-echeance','m-ref','m-loyer','m-duree-lea','m-plafond','m-taux-dec'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  document.getElementById('m-amort').value='constant';
  document.getElementById('preview').style.display='none';
  selectType('emprunt');
}

function selectType(t){
  _selectedType=t;
  ['emprunt','fournisseur','leasing','decouvert'].forEach(k=>{
    document.getElementById('type-'+k).classList.toggle('on',k===t);
    const ch=document.getElementById('champs-'+k);
    if(ch)ch.style.display=k===t?'block':'none';
  });
  calcPreview();
}

function calcPreview(){
  const m=parseFloat(document.getElementById('m-montant').value)||0;
  const taux=parseFloat(document.getElementById('m-taux').value)||0;
  const duree=parseInt(document.getElementById('m-duree').value)||0;
  const amort=document.getElementById('m-amort').value;
  const loyer=parseFloat(document.getElementById('m-loyer').value)||0;
  const dureeLea=parseInt(document.getElementById('m-duree-lea').value)||0;
  const preview=document.getElementById('preview');
  const content=document.getElementById('previewContent');
  if(!m){preview.style.display='none';return;}

  let items=[];
  if(_selectedType==='emprunt'&&m&&duree){
    const tauxM=taux/12/100;
    let mensualite=0,totalInterets=0;
    if(amort==='lineaire'){mensualite=m/duree+(m*tauxM);totalInterets=m*tauxM*(duree+1)/2;}
    else if(amort==='infine'){mensualite=m*tauxM;totalInterets=m*tauxM*duree;}
    else if(tauxM===0){mensualite=m/duree;}
    else{mensualite=m*(tauxM*Math.pow(1+tauxM,duree))/(Math.pow(1+tauxM,duree)-1);totalInterets=mensualite*duree-m;}
    items=[{l:'Mensualit√©',v:fe(mensualite)},{l:'Total int√©r√™ts',v:fe(totalInterets)},{l:'Co√ªt total',v:fe(m+totalInterets)}];
  } else if(_selectedType==='leasing'&&loyer&&dureeLea){
    items=[{l:'Loyer mensuel',v:fe(loyer)},{l:'Total versements',v:fe(loyer*dureeLea)},{l:'Dur√©e',v:dureeLea+' mois'}];
  } else if(_selectedType==='decouvert'&&m&&parseFloat(document.getElementById('m-taux-dec').value)){
    const tauxDec=parseFloat(document.getElementById('m-taux-dec').value)||0;
    items=[{l:'Int√©r√™ts/mois',v:fe(m*tauxDec/12/100)},{l:'Montant d√©couvert',v:fe(m)},{l:'Taux annuel',v:tauxDec+'%'}];
  } else if(m){
    items=[{l:'Montant',v:fe(m)}];
  }
  if(!items.length){preview.style.display='none';return;}
  preview.style.display='block';
  content.innerHTML=items.map(i=>`<div><div style="font-size:10px;font-weight:700;color:#065f46;margin-bottom:2px">${i.l}</div><div style="font-size:14px;font-weight:800;color:#047857">${i.v}</div></div>`).join('');
}

function saveDette(){
  const nom=document.getElementById('m-nom').value.trim();
  const montant=parseFloat(document.getElementById('m-montant').value)||0;
  const debut=document.getElementById('m-debut').value;
  if(!nom||!montant||!debut){showToast('Remplissez au moins le nom, montant et date','err');return;}

  const data={
    id:_editId||uid(), type:_selectedType, nom, montant, debut, active:true,
    paiements:_editId?(_dettes.find(d=>d.id===_editId)?.paiements||[]):[],
  };
  if(_selectedType==='emprunt'){
    data.taux=parseFloat(document.getElementById('m-taux').value)||0;
    data.duree=parseInt(document.getElementById('m-duree').value)||0;
    data.amort=document.getElementById('m-amort').value;
  } else if(_selectedType==='fournisseur'){
    data.echeance=document.getElementById('m-echeance').value;
    data.ref=document.getElementById('m-ref').value;
  } else if(_selectedType==='leasing'){
    data.loyer=parseFloat(document.getElementById('m-loyer').value)||0;
    data.dureeLea=parseInt(document.getElementById('m-duree-lea').value)||0;
    data.duree=data.dureeLea;
  } else if(_selectedType==='decouvert'){
    data.plafond=parseFloat(document.getElementById('m-plafond').value)||0;
    data.tauxDec=parseFloat(document.getElementById('m-taux-dec').value)||0;
  }

  if(_editId){_dettes=_dettes.map(d=>d.id===_editId?{...d,...data}:d);}
  else{_dettes.push(data);}
  save(); closeModal(); renderAll();
  showToast(_editId?'‚úÖ Dette modifi√©e':'‚úÖ Dette ajout√©e !','ok');
}

// ‚îÄ‚îÄ RENDER ALL ‚îÄ‚îÄ
function renderAll(){renderKPIs();renderAlertes();renderCalendar();renderCharts();renderDettes();}

// ‚îÄ‚îÄ START ‚îÄ‚îÄ
load(); renderAll();

// Firebase optionnel
async function tryFirebase(){
  if(!window._uid||!window._getDoc)return;
  try{
    const snap=await window._getDoc(window._doc(window._db,'dettes',window._uid,'data','all'));
    if(snap.exists()&&snap.data().list){_dettes=snap.data().list;save();renderAll();}
    const u=window._auth?.currentUser;
    if(u){const n=u.displayName||u.email?.split('@')[0]||'';document.getElementById('uname').textContent=n;document.getElementById('av').textContent=n[0]?.toUpperCase()||'A';}
  }catch(e){}
}
setTimeout(tryFirebase,500);
</script>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import{getFirestore,doc,setDoc,getDoc}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const app=initializeApp({apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",storageBucket:"altiora-70599.firebasestorage.app",messagingSenderId:"120905555746",appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"});
const auth=getAuth(app),db=getFirestore(app);
window._auth=auth;window._db=db;window._doc=doc;window._setDoc=setDoc;window._getDoc=getDoc;window._signOut=signOut;
onAuthStateChanged(auth,user=>{
  if(!user){location.href='index.html';return;}
  window._uid=user.uid;
  tryFirebase();
  // Auto-save Firebase quand on sauvegarde localement
  const origSave=window.save;
  window.saveFirebase=()=>{if(window._setDoc)window._setDoc(window._doc(db,'dettes',user.uid,'data','all'),{list:_dettes},{merge:true}).catch(()=>{});};
});
</script>
