<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>ALTEORE â€” Planning RH Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --rh-dark:#052e16;--rh-main:#059669;--rh-mid:#10b981;--rh-bright:#34d399;
  --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
  --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f0fdf7;--sidebar-w:252px;--radius:12px;
  --green:#10b981;--orange:#f59e0b;--red:#ef4444;--blue:#3b82f6;--purple:#6366f1;
  --t-travail:#dcfce7;--tc-travail:#166534;
  --t-repos:#f3f4f6;--tc-repos:#6b7280;
  --t-conge:#dbeafe;--tc-conge:#1e40af;
  --t-maladie:#fee2e2;--tc-maladie:#991b1b;
  --t-formation:#fef3c7;--tc-formation:#92400e;
  --t-astreinte:#ede9fe;--tc-astreinte:#5b21b6;
  --t-partiel:#fff7ed;--tc-partiel:#c2410c;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}
.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden;}

/* TOPBAR */
.topbar{background:white;border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;gap:8px;flex-wrap:wrap;}
.topbar-left h1{font-size:16px;font-weight:700;}
.topbar-left p{font-size:11px;color:var(--muted);}
.topbar-right{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.18s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap;}
.btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-mid));color:white;box-shadow:0 2px 8px rgba(5,150,105,.25);}
.btn-rh:hover{opacity:.9;transform:translateY(-1px);}
.btn-outline{background:white;color:var(--text);border:1.5px solid var(--border);}
.btn-outline:hover{border-color:var(--rh-main);color:var(--rh-main);}
.btn-ai{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;box-shadow:0 2px 8px rgba(99,102,241,0.3);}
.btn-ai:hover{opacity:0.9;}
.btn-sm{padding:5px 11px;font-size:11px;}
.btn-xs{padding:3px 8px;font-size:10px;}
.btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}

/* PLAN NAV */
.plan-nav{background:white;border-bottom:1px solid var(--border);padding:0 20px;display:flex;align-items:center;gap:0;position:sticky;top:57px;z-index:40;flex-wrap:wrap;}
.plan-nav-week{display:flex;align-items:center;gap:6px;padding:8px 0;flex:1;min-width:180px;}
.wnav-btn{width:28px;height:28px;border:1.5px solid var(--border);border-radius:6px;background:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s;}
.wnav-btn:hover{border-color:var(--rh-main);color:var(--rh-main);}
.week-label{font-size:13px;font-weight:700;color:var(--text);min-width:160px;text-align:center;}
.today-btn{font-size:10px;font-weight:700;padding:3px 9px;border:1.5px solid var(--rh-border);border-radius:6px;background:var(--rh-ghost);color:var(--rh-main);cursor:pointer;}
.view-tabs{display:flex;gap:1px;padding:6px 0;}
.vtab{padding:5px 11px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;color:var(--muted);border:none;background:transparent;transition:all .15s;}
.vtab.active{background:var(--rh-ghost);color:var(--rh-main);}
.disp-tabs{display:flex;gap:1px;padding:6px 0;border-left:1px solid var(--border);margin-left:6px;padding-left:10px;}
.dtab{padding:5px 9px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;color:var(--muted);border:none;background:transparent;transition:all .15s;}
.dtab.active{background:#e0f2fe;color:#0369a1;}
.filter-sep{width:1px;height:24px;background:var(--border);margin:0 6px;}

/* STATS BAR */
.stats-bar{background:white;border-bottom:1px solid var(--border);padding:7px 20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;overflow-x:auto;}
.sitem{display:flex;align-items:center;gap:5px;font-size:11px;flex-shrink:0;}
.sdot{width:8px;height:8px;border-radius:50%;}
.sval{font-weight:700;}
.slbl{color:var(--muted);}
.infr-badge{background:#fef2f2;color:#dc2626;border:1px solid #fecaca;border-radius:6px;padding:2px 8px;font-size:10px;font-weight:700;cursor:pointer;margin-left:auto;}
.infr-badge:hover{background:#fee2e2;}

/* EMP LEGEND */
.emp-legend{background:white;border-bottom:1px solid var(--border);padding:7px 20px;display:flex;align-items:center;gap:6px;overflow-x:auto;}
.emp-legend::-webkit-scrollbar{height:2px;}
.leg-item{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600;color:var(--text);cursor:pointer;padding:3px 8px;border-radius:16px;border:1.5px solid var(--border);background:white;flex-shrink:0;transition:all .15s;}
.leg-item:hover{border-color:var(--rh-main);}
.leg-item.hidden{opacity:.3;}
.leg-item.active-filter{border-color:var(--rh-main);background:var(--rh-ghost);}
.leg-dot{width:8px;height:8px;border-radius:3px;flex-shrink:0;}
.leg-skills{font-size:9px;color:var(--muted);margin-left:2px;}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘   PLANNING MENSUEL â€” GANTT HORIZONTAL   â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.plan-content{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;}

/* â• GANTT MOIS â• */
.gantt-wrap{min-width:1000px;}
.gantt-head{display:grid;background:white;border-bottom:2px solid var(--border);position:sticky;top:0;z-index:10;}
.gh-emp{padding:10px 14px;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;border-right:1px solid var(--border);display:flex;align-items:center;gap:6px;}
.gh-day{padding:5px 2px;text-align:center;border-right:1px solid var(--border);min-width:0;}
.gh-dname{font-size:8px;font-weight:700;color:var(--muted);text-transform:uppercase;}
.gh-dnum{font-size:13px;font-weight:800;line-height:1.2;}
.gh-day.today{background:var(--rh-ghost);}
.gh-day.today .gh-dnum{color:var(--rh-main);}
.gh-day.we{background:#fafafa;}
.gh-day.we .gh-dnum{color:#d1d5db;}
.gantt-row{display:grid;border-bottom:1px solid var(--border);min-height:52px;background:white;transition:background .1s;}
.gantt-row:hover{background:#fafffe;}
.ge-cell{padding:8px 12px;border-right:1px solid var(--border);display:flex;align-items:center;gap:7px;position:sticky;left:0;background:inherit;z-index:5;}
.ge-av{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0;}
.ge-info{min-width:0;}
.ge-name{font-size:11px;font-weight:700;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ge-meta{font-size:9px;color:var(--muted);display:flex;align-items:center;gap:4px;flex-wrap:wrap;}
.ge-hbadge{background:var(--rh-ghost);color:var(--rh-main);padding:1px 5px;border-radius:4px;font-weight:700;font-size:9px;}
.ge-alert{background:#fef2f2;color:#dc2626;padding:1px 5px;border-radius:4px;font-weight:700;font-size:9px;}
.gd-cell{border-right:1px solid var(--border);padding:3px;cursor:pointer;min-height:52px;position:relative;transition:background .12s;display:flex;flex-direction:column;gap:2px;align-items:stretch;}
.gd-cell:hover{background:#f0fdf4;}
.gd-cell.today{background:#f7fff9;}
.gd-cell.we{background:#f9fafb;}
.gd-cell.we:hover{background:#f3f9f3;}

/* PILL */
.cr-pill{border-radius:5px;padding:3px 6px;cursor:pointer;transition:all .12s;position:relative;overflow:hidden;}
.cr-pill:hover{filter:brightness(.94);transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,0.08);}
.cr-time{font-size:9px;font-weight:700;line-height:1.2;}
.cr-lbl{font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cr-x{position:absolute;top:2px;right:3px;font-size:9px;opacity:0;cursor:pointer;background:rgba(0,0,0,0.15);border-radius:2px;width:12px;height:12px;display:flex;align-items:center;justify-content:center;}
.cr-pill:hover .cr-x{opacity:1;}
.add-hint{display:flex;align-items:center;justify-content:center;margin-top:auto;height:16px;font-size:12px;color:var(--rh-main);opacity:0;transition:opacity .15s;}
.gd-cell:hover .add-hint{opacity:1;}
.pill-sep{font-size:8px;color:rgba(0,0,0,.3);text-align:center;line-height:1;}

/* TYPE COLORS */
.t-travail{background:var(--t-travail);color:var(--tc-travail);}
.t-repos{background:var(--t-repos);color:var(--tc-repos);}
.t-conge{background:var(--t-conge);color:var(--tc-conge);}
.t-maladie{background:var(--t-maladie);color:var(--tc-maladie);}
.t-formation{background:var(--t-formation);color:var(--tc-formation);}
.t-astreinte{background:var(--t-astreinte);color:var(--tc-astreinte);}
.t-partiel{background:var(--t-partiel);color:var(--tc-partiel);}

/* COULEURS EMP */
.c0{background:#059669;}.c1{background:#3b82f6;}.c2{background:#8b5cf6;}
.c3{background:#f59e0b;}.c4{background:#ef4444;}.c5{background:#14b8a6;}
.c6{background:#f97316;}.c7{background:#6366f1;}.c8{background:#10b981;}.c9{background:#0ea5e9;}

/* POLYVALENCE BADGE */
.poly-badge{display:inline-flex;align-items:center;gap:2px;font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px;background:#fef3c7;color:#92400e;}

/* â• VUE SEMAINE TIMELINE (Shift view) â• */
.timeline-wrap{padding:16px 20px;min-width:900px;}
.timeline-head{display:flex;gap:0;margin-bottom:0;border-bottom:2px solid var(--border);background:white;position:sticky;top:0;z-index:5;}
.tl-emp-col{width:160px;flex-shrink:0;padding:8px 12px;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;}
.tl-hours{flex:1;display:flex;position:relative;overflow:hidden;}
.tl-hour{flex:1;text-align:center;font-size:10px;font-weight:600;color:var(--muted);padding:8px 0;border-left:1px solid var(--border);}
.tl-row{display:flex;border-bottom:1px solid var(--border);min-height:50px;background:white;}
.tl-row:hover{background:#fafffe;}
.tl-emp{width:160px;flex-shrink:0;padding:8px 12px;display:flex;align-items:center;gap:7px;position:sticky;left:0;background:inherit;z-index:2;}
.tl-bar-wrap{flex:1;position:relative;display:flex;align-items:center;}
.tl-grid-line{position:absolute;top:0;bottom:0;width:1px;background:var(--border);}
.tl-shift-bar{position:absolute;height:32px;top:50%;transform:translateY(-50%);border-radius:6px;padding:2px 6px;display:flex;flex-direction:column;justify-content:center;cursor:pointer;transition:all .12s;font-size:9px;font-weight:700;z-index:3;overflow:hidden;white-space:nowrap;}
.tl-shift-bar:hover{filter:brightness(.92);z-index:4;box-shadow:0 3px 10px rgba(0,0,0,0.12);}
.tl-now{position:absolute;top:0;bottom:0;width:2px;background:#ef4444;z-index:4;}
.tl-now::before{content:'';position:absolute;top:-4px;left:-4px;width:10px;height:10px;background:#ef4444;border-radius:50%;}

/* â• VUE MOIS CALENDRIER â• */
.month-wrap{padding:0;}
.month-grid{display:grid;grid-template-columns:repeat(7,1fr);border-left:1px solid var(--border);border-top:1px solid var(--border);}
.m-dhead{padding:7px;text-align:center;font-size:10px;font-weight:700;color:var(--muted);background:#f8faff;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.m-cell{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:5px;min-height:90px;cursor:pointer;transition:background .12s;position:relative;}
.m-cell:hover{background:#f0fdf4;}
.m-cell.m-today{background:#f0fdf9;}
.m-cell.m-other .m-dnum{color:#d1d5db;}
.m-cell.m-other{background:#fafafa;}
.m-cell.m-we{background:#f9fafb;}
.m-dnum{font-size:12px;font-weight:700;margin-bottom:3px;}
.m-dnum-circle{background:var(--rh-main);color:white;border-radius:50%;width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;}
.m-pill{font-size:8px;font-weight:700;padding:2px 5px;border-radius:4px;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:block;}
.m-more{font-size:9px;color:var(--muted);font-weight:600;}
.m-total-badge{position:absolute;top:4px;right:4px;font-size:8px;font-weight:800;color:var(--rh-main);background:var(--rh-ghost);padding:1px 4px;border-radius:4px;}

/* â• VUE JOUR â• */
.day-wrap{padding:16px 20px;display:flex;gap:12px;flex-wrap:wrap;}
.day-card{background:white;border:1px solid var(--border);border-radius:12px;overflow:hidden;min-width:190px;max-width:220px;flex:1;}
.dc-head{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.dc-body{padding:8px 10px;}
.dc-footer{padding:6px 10px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.dc-skills{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px;}
.dc-skill-chip{font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px;background:#f1f5f9;color:#475569;}
.dc-h{font-size:11px;font-weight:800;color:var(--rh-main);}
.dc-libre{font-size:11px;color:var(--muted);font-style:italic;}

/* POLYVALENCE PANEL */
.poly-panel{background:white;border:1px solid var(--border);border-radius:12px;overflow:hidden;margin:12px 20px;}
.poly-head{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:#fafbff;}
.poly-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;}
.poly-grid{padding:14px 16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;}
.poly-emp-card{border:1.5px solid var(--border);border-radius:10px;padding:12px;transition:border-color .15s;}
.poly-emp-card:hover{border-color:var(--rh-main);}
.poly-emp-name{font-size:12px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;}
.poly-comp-list{display:flex;flex-direction:column;gap:4px;}
.poly-comp-row{display:flex;align-items:center;justify-content:space-between;font-size:11px;}
.poly-comp-name{color:var(--text);}
.poly-stars{display:flex;gap:2px;}
.poly-star{font-size:11px;color:#d1d5db;}
.poly-star.on{color:#f59e0b;}
.poly-avail-bar{margin-top:8px;height:4px;background:#f1f5f9;border-radius:99px;overflow:hidden;}
.poly-avail-fill{height:100%;background:var(--rh-main);border-radius:99px;}

/* â• INFR PANEL â• */
.infr-panel{display:none;background:#fef2f2;border-bottom:2px solid #fecaca;padding:10px 20px;}
.infr-panel.show{display:block;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(15,31,92,0.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;}
.overlay.show{display:flex;}
.modal{background:white;border-radius:16px;width:100%;max-width:500px;box-shadow:0 24px 60px rgba(0,0,0,0.15);overflow:hidden;max-height:95vh;display:flex;flex-direction:column;}
.modal-lg{max-width:680px;}
.modal-xl{max-width:820px;}
.modal-head{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.modal-head h3{font-size:14px;font-weight:700;}
.mclose{background:none;border:none;font-size:17px;cursor:pointer;color:var(--muted);}
.modal-body{padding:18px 20px;overflow-y:auto;flex:1;}
.modal-foot{padding:13px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;flex-shrink:0;}
.mf{margin-bottom:13px;}
.ml{font-size:11px;font-weight:600;color:var(--muted);margin-bottom:5px;display:block;}
.mi{width:100%;padding:8px 11px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;background:white;}
.mi:focus{border-color:var(--rh-main);box-shadow:0 0 0 3px rgba(5,150,105,0.08);}
.mrow{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.mrow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}

/* TYPE SELECTOR */
.type-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:14px;}
.type-btn{padding:8px 6px;border:2px solid var(--border);border-radius:8px;cursor:pointer;text-align:center;background:white;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
.type-btn:hover{border-color:var(--rh-main);}
.type-btn.active{border-color:var(--rh-main);background:var(--rh-ghost);}
.type-btn-icon{font-size:16px;margin-bottom:2px;}
.type-btn-lbl{font-size:9px;font-weight:700;color:var(--text);}

/* PRESET HORAIRES */
.preset-scroll{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;margin-bottom:10px;}
.preset-scroll::-webkit-scrollbar{height:2px;}
.preset-btn{padding:5px 10px;border:1.5px solid var(--border);border-radius:6px;cursor:pointer;background:white;font-size:11px;font-weight:600;white-space:nowrap;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
.preset-btn:hover{border-color:var(--rh-main);background:var(--rh-ghost);color:var(--rh-main);}
.preset-btn.used{border-color:#c7d2fe;background:#eef2ff;color:#4338ca;}

/* PLAGES */
.plage-row{display:flex;align-items:center;gap:6px;margin-bottom:6px;}
.plage-sep{font-size:10px;font-weight:700;color:var(--muted);text-align:center;padding:0 2px;}
.plage-hl{border:1.5px solid var(--border);border-radius:7px;padding:7px 9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;color:var(--text);outline:none;width:100px;}
.plage-hl:focus{border-color:var(--rh-main);}
.plage-dur{font-size:10px;font-weight:700;color:var(--rh-main);background:var(--rh-ghost);padding:4px 7px;border-radius:5px;white-space:nowrap;}
.plage-del{width:22px;height:22px;border-radius:5px;border:1px solid #fecaca;background:#fef2f2;color:var(--red);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;}
.cr-total-dur{padding:8px 12px;background:var(--rh-ghost);border-radius:8px;font-size:12px;font-weight:700;color:var(--rh-main);display:flex;align-items:center;justify-content:space-between;}

/* ALERTES */
.alert-row{display:flex;align-items:flex-start;gap:6px;padding:7px 10px;border-radius:7px;font-size:11px;font-weight:600;margin-bottom:5px;}
.alert-row.err{background:#fee2e2;color:#dc2626;border-left:3px solid #dc2626;}
.alert-row.warn{background:#fef3c7;color:#92400e;border-left:3px solid #d97706;}
.alert-row.ok{background:#dcfce7;color:#166534;border-left:3px solid #16a34a;}

/* MULTI-DATES */
.multi-toggle{display:flex;align-items:center;gap:8px;padding:9px 12px;border-radius:9px;border:2px dashed #d1d5db;background:#fafbff;cursor:pointer;transition:all .2s;width:100%;}
.multi-toggle.on{border-style:solid;border-color:var(--rh-main);background:var(--rh-ghost);border-bottom:none;border-radius:9px 9px 0 0;}
.multi-panel{display:none;background:var(--rh-ghost);border:2px solid var(--rh-main);border-top:none;border-radius:0 0 9px 9px;padding:12px;}
.multi-panel.show{display:block;}
.multi-range-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:end;gap:8px;margin-bottom:10px;}
.multi-filters{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px;}
.chip{display:flex;align-items:center;gap:4px;padding:4px 9px;border-radius:16px;border:1.5px solid #e2e8f0;background:white;cursor:pointer;font-size:10px;font-weight:600;color:#374151;transition:all .15s;}
.chip input{display:none;}
.chip.on{border-color:var(--rh-main);background:white;color:var(--rh-main);}
.multi-days-wrap{border:1.5px solid #e2e8f0;border-radius:8px;overflow:hidden;background:white;margin-bottom:8px;}
.mday-head{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:linear-gradient(90deg,#f0fdf7,#e8f5e9);border-bottom:1px solid #e2e8f0;}
.mday-list{max-height:160px;overflow-y:auto;}
.mday-row{display:flex;align-items:center;gap:8px;padding:5px 10px;border-bottom:1px solid #f1f5f9;cursor:pointer;transition:background .1s;}
.mday-row:hover{background:#f0fdf4;}
.mday-row.off{opacity:.4;}
.mday-cb{width:14px;height:14px;border-radius:3px;accent-color:var(--rh-main);flex-shrink:0;}
.mday-name{font-size:10px;font-weight:800;width:24px;}
.mday-date{font-size:10px;color:var(--muted);flex:1;}
.mday-tag{font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px;}
.tag-we{color:#7c3aed;background:#ede9fe;}
.tag-fer{color:#92400e;background:#fef3c7;}
.tag-ouv{color:#065f46;background:#d1fae5;}
.tag-deja{color:#1e40af;background:#dbeafe;}
.multi-hrs{background:white;border:1.5px solid #e2e8f0;border-radius:8px;padding:10px;margin-bottom:8px;}

/* â• IA MODAL â• */
.ai-head-bg{background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%);padding:18px 20px;}
.ai-head-bg h3{color:white;font-size:15px;font-weight:700;}
.ai-head-bg p{color:rgba(255,255,255,.65);font-size:11px;margin-top:3px;}
.ai-sections{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.ai-sec{padding:10px 12px;border:1.5px solid var(--border);border-radius:9px;}
.ai-sec-lbl{font-size:10px;font-weight:700;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;}
.ai-field{width:100%;border:none;outline:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;color:var(--text);}
.ai-res-box{background:#1e293b;border-radius:10px;padding:14px;color:white;max-height:260px;overflow-y:auto;margin-top:10px;}
.ai-think{display:flex;align-items:center;gap:6px;color:rgba(255,255,255,.5);font-size:12px;}
.ai-d{width:6px;height:6px;border-radius:50%;background:#6366f1;animation:ap 1.2s ease-in-out infinite;}
.ai-d:nth-child(2){animation-delay:.2s;}.ai-d:nth-child(3){animation-delay:.4s;}
@keyframes ap{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1.1)}}
.ai-emp-row{display:flex;align-items:flex-start;gap:8px;margin-bottom:8px;font-size:12px;}
.ai-emp-n{color:rgba(255,255,255,.9);font-weight:700;min-width:110px;flex-shrink:0;}
.ai-shifts{display:flex;flex-wrap:wrap;gap:3px;}
.ai-sp{padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700;}
.ai-apply-btn{width:100%;margin-top:10px;background:linear-gradient(135deg,#059669,#34d399);color:white;border:none;border-radius:8px;padding:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;}
.ai-apply-btn:hover{opacity:.9;}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:#1e293b;color:white;padding:11px 18px;border-radius:10px;font-size:12px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.ok{background:#059669;}
.toast.warn{background:#d97706;}

/* EMPTY */
.empty-plan{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;text-align:center;color:var(--muted);}

/* MOBILE */
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:var(--rh-main);border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(15,31,92,.45);}
.hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;}
.hamburger.open span:nth-child(1){transform:translateY(7.5px) rotate(45deg);}
.hamburger.open span:nth-child(2){opacity:0;transform:scaleX(0);}
.hamburger.open span:nth-child(3){transform:translateY(-7.5px) rotate(-45deg);}
.nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;}
.nav-overlay.show{display:block;}

/* Spinner */
.spin{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--rh-main);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loader{display:flex;align-items:center;justify-content:center;gap:10px;padding:60px;color:var(--muted);}

@media(max-width:768px){
  .hamburger{display:flex!important;}
  .main{margin-left:0!important;width:100vw!important;}
  .topbar{padding:10px 10px 10px 62px!important;flex-wrap:wrap;}
  .plan-nav{padding:0 10px;}
  .plan-content{overflow-x:auto;}
  .mrow,.mrow3,.type-grid,.ai-sections{grid-template-columns:1fr 1fr!important;}
  .poly-grid{grid-template-columns:1fr!important;}
}
@media(max-width:480px){
  .mrow,.type-grid{grid-template-columns:1fr!important;}
}

/* Dropdown poste */
.poste-tag{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;background:#e0f2fe;color:#0369a1;}
.comp-stars{display:inline-flex;gap:2px;}

/* Motif pattern pour congÃ©s */
.t-conge{background:repeating-linear-gradient(-45deg,#dbeafe,#dbeafe 4px,#eff6ff 4px,#eff6ff 8px)!important;}

/* Highlight pole polyvalence */
.poly-highlight{box-shadow:0 0 0 2px #f59e0b!important;border-color:#f59e0b!important;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAG & DROP â€” pointer events (mouse + touch)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Pills Gantt */
.cr-pill{cursor:grab;user-select:none;}
.cr-pill:active{cursor:grabbing;}
.cr-pill.pm-dragging{opacity:.3;pointer-events:none;}

/* Barres Timeline */
.tl-shift-bar{cursor:grab;user-select:none;touch-action:none;}
.tl-bar-wrap .tl-shift-bar{cursor:grab;}  /* barre = grab, fond = crosshair */
.tl-shift-bar.pm-dragging{opacity:.25;pointer-events:none;}

/* Drop targets Gantt */
.gd-cell.pm-over{background:rgba(5,150,105,.14)!important;box-shadow:inset 0 0 0 2px var(--rh-main);border-radius:4px;}
.gd-cell.pm-over-emp{background:rgba(99,102,241,.12)!important;box-shadow:inset 0 0 0 2px #6366f1;border-radius:4px;}

/* Drop targets Timeline (changement d'employÃ©) */
.tl-row.pm-over{background:rgba(5,150,105,.08)!important;box-shadow:inset 0 0 0 2px var(--rh-main);}
.tl-row.pm-over-emp{background:rgba(99,102,241,.08)!important;box-shadow:inset 0 0 0 2px #6366f1;}

/* Ghost flottant */
#dnd-ghost{
  position:fixed;z-index:9999;pointer-events:none;
  padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;
  font-family:'Plus Jakarta Sans',sans-serif;
  box-shadow:0 8px 28px rgba(0,0,0,.28);
  display:none;white-space:nowrap;
  transform:rotate(-2deg) scale(1.05);
  border:2px solid rgba(255,255,255,.5);
}

/* Tooltip heure en cours de drag timeline */
#tl-drag-tip{
  position:fixed;z-index:9999;pointer-events:none;
  background:#1e293b;color:white;padding:4px 9px;border-radius:6px;
  font-size:11px;font-weight:700;font-family:'Plus Jakarta Sans',sans-serif;
  display:none;white-space:nowrap;
}

/* Toast confirmation */
.dnd-toast{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(16px);
  background:#1e293b;color:white;padding:9px 18px;border-radius:10px;
  font-size:12px;font-weight:600;z-index:9998;opacity:0;
  transition:all .25s;pointer-events:none;white-space:nowrap;
}
.dnd-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ZOOM / DENSITÃ‰ â€” pilotÃ© par data-zoom sur body
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â”€â”€ COMPACT â”€â”€ */
body[data-zoom="compact"] .gantt-row,
body[data-zoom="compact"] .gd-cell       { min-height:36px; }
body[data-zoom="compact"] .ge-av         { width:24px;height:24px;font-size:9px; }
body[data-zoom="compact"] .ge-name       { font-size:10px; }
body[data-zoom="compact"] .ge-meta       { display:none; }
body[data-zoom="compact"] .cr-pill       { padding:2px 4px; }
body[data-zoom="compact"] .cr-time       { font-size:8px; }
body[data-zoom="compact"] .cr-lbl        { font-size:9px; }
body[data-zoom="compact"] .m-cell        { min-height:60px; }
body[data-zoom="compact"] .m-pill        { font-size:7px;padding:1px 4px; }

/* â”€â”€ NORMAL (dÃ©faut) â”€â”€ */
body[data-zoom="normal"] .gantt-row,
body[data-zoom="normal"] .gd-cell        { min-height:52px; }

/* â”€â”€ CONFORTABLE â”€â”€ */
body[data-zoom="comfortable"] .gantt-row,
body[data-zoom="comfortable"] .gd-cell   { min-height:70px; }
body[data-zoom="comfortable"] .ge-av     { width:36px;height:36px;font-size:13px; }
body[data-zoom="comfortable"] .ge-name   { font-size:13px; }
body[data-zoom="comfortable"] .ge-meta   { font-size:10px; }
body[data-zoom="comfortable"] .ge-cell   { padding:10px 14px; }
body[data-zoom="comfortable"] .cr-pill   { padding:5px 8px; }
body[data-zoom="comfortable"] .cr-time   { font-size:10px; }
body[data-zoom="comfortable"] .cr-lbl    { font-size:11px; }
body[data-zoom="comfortable"] .m-cell    { min-height:120px; }
body[data-zoom="comfortable"] .m-pill    { font-size:9px;padding:3px 6px; }
body[data-zoom="comfortable"] .m-dnum   { font-size:14px; }

/* â”€â”€ LARGE â”€â”€ */
body[data-zoom="large"] .gantt-row,
body[data-zoom="large"] .gd-cell         { min-height:92px; }
body[data-zoom="large"] .ge-av           { width:44px;height:44px;font-size:15px; }
body[data-zoom="large"] .ge-name         { font-size:14px; }
body[data-zoom="large"] .ge-meta         { font-size:11px; }
body[data-zoom="large"] .ge-cell         { padding:12px 16px;gap:10px; }
body[data-zoom="large"] .ge-info         { display:flex;flex-direction:column;gap:4px; }
body[data-zoom="large"] .cr-pill         { padding:6px 10px; }
body[data-zoom="large"] .cr-time         { font-size:11px; }
body[data-zoom="large"] .cr-lbl          { font-size:12px; }
body[data-zoom="large"] .m-cell          { min-height:160px; }
body[data-zoom="large"] .m-pill          { font-size:10px;padding:4px 8px; }
body[data-zoom="large"] .m-dnum          { font-size:16px; }
body[data-zoom="large"] .gh-dnum         { font-size:16px; }
body[data-zoom="large"] .gh-dname        { font-size:10px; }

/* ZOOM CONTROLS */
.zoom-controls{display:flex;align-items:center;gap:3px;padding:4px 0;border-left:1px solid var(--border);margin-left:6px;padding-left:10px;}
.zoom-lbl{font-size:10px;font-weight:600;color:var(--muted);margin-right:2px;}
.zoom-btn{width:28px;height:24px;border:1.5px solid var(--border);border-radius:5px;background:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--muted);transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
.zoom-btn:hover{border-color:var(--rh-main);color:var(--rh-main);}
.zoom-btn.active{background:var(--rh-ghost);border-color:var(--rh-main);color:var(--rh-main);}
.zoom-sep-v{width:1px;height:14px;background:var(--border);margin:0 2px;}

/* Colonne employÃ© : largeur variable selon zoom */
body[data-zoom="compact"]    { --emp-col-w: 130px; }
body[data-zoom="normal"]     { --emp-col-w: 170px; }
body[data-zoom="comfortable"]{ --emp-col-w: 200px; }
body[data-zoom="large"]      { --emp-col-w: 220px; }

/* Week-end mieux visible */
.gd-cell.we{background:repeating-linear-gradient(135deg,#f9fafb,#f9fafb 8px,#f3f4f6 8px,#f3f4f6 16px);}
.gd-cell.we:hover{background:#f0fdf4;}
.gh-day.we{background:linear-gradient(180deg,#f3f4f6,#f9fafb);}
</style>
</head>
<body>

<div id="dnd-ghost"></div>
<div id="tl-drag-tip"></div>
<div class="dnd-toast" id="dnd-toast"></div>

<button class="hamburger" id="hamburger" onclick="toggleMobileNav()"><span></span><span></span><span></span></button>
<div class="nav-overlay" id="navOverlay" onclick="toggleMobileNav()"></div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>ğŸ“… Planning RH</h1>
      <p id="topbar-sub">Planning mensuel Â· Toutes vues Â· Polyvalence Â· IA</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="openPolyPanel()">ğŸ¯ Polyvalence</button>
      <button class="btn btn-outline btn-sm" onclick="exportPDF()">ğŸ–¨ï¸ Imprimer</button>
      <button class="btn btn-ai btn-sm" onclick="openAI()">âœ¨ IA Planning</button>
      <button class="btn btn-sm" style="background:linear-gradient(135deg,#1d4ed8,#60a5fa);color:white" onclick="openCongeRapide()">ğŸ–ï¸ CongÃ©s</button>
      <button class="btn btn-rh btn-sm" onclick="openCreneauModal()">+ CrÃ©neau</button>
    </div>
  </div>

  <!-- NAV PLANNING -->
  <div class="plan-nav">
    <div class="plan-nav-week">
      <button class="wnav-btn" onclick="navPrev()">â€¹</button>
      <div class="week-label" id="week-label">â€¦</div>
      <button class="wnav-btn" onclick="navNext()">â€º</button>
      <button class="today-btn" onclick="goToday()">Aujourd'hui</button>
    </div>
    <div class="view-tabs">
      <button class="vtab" id="vtab-mois" onclick="setView('mois')">Mois</button>
      <button class="vtab active" id="vtab-semaine" onclick="setView('semaine')">Semaine</button>
      <button class="vtab" id="vtab-jour" onclick="setView('jour')">Jour</button>
    </div>
    <div class="disp-tabs" id="disp-tabs">
      <button class="dtab active" id="dtab-gantt" onclick="setDisp('gantt')">â˜° Gantt</button>
      <button class="dtab" id="dtab-time" onclick="setDisp('timeline')">â± Timeline</button>
    </div>
    <div class="filter-sep"></div>
    <div style="display:flex;align-items:center;gap:6px;padding:4px 0">
      <select class="mi" id="filter-poste" onchange="applyFilters()" style="width:130px;padding:4px 8px;font-size:11px">
        <option value="">Tous postes</option>
      </select>
    </div>
    <div class="zoom-controls">
      <span class="zoom-lbl">Zoom :</span>
      <button class="zoom-btn" id="zbtn-compact"    onclick="setZoom('compact')"     title="Compact â€” max de salariÃ©s visibles">â€”</button>
      <button class="zoom-btn active" id="zbtn-normal"      onclick="setZoom('normal')"       title="Normal">â‰¡</button>
      <button class="zoom-btn" id="zbtn-comfortable" onclick="setZoom('comfortable')" title="Confortable â€” plus lisible">â˜°</button>
      <button class="zoom-btn" id="zbtn-large"       onclick="setZoom('large')"        title="Large â€” idÃ©al grand Ã©cran">âŠŸ</button>
    </div>
  </div>

  <!-- LÃ‰GENDE -->
  <div class="emp-legend" id="emp-legend">
    <div style="font-size:10px;font-weight:700;color:var(--muted);flex-shrink:0">Ã‰quipe :</div>
    <div style="font-size:11px;color:var(--muted)">Chargementâ€¦</div>
  </div>

  <!-- STATS -->
  <div class="stats-bar">
    <div class="sitem"><div class="sdot" style="background:var(--rh-main)"></div><span class="sval" id="s-h">â€”</span><span class="slbl"> h planifiÃ©es</span></div>
    <div class="sitem"><div class="sdot" style="background:#3b82f6"></div><span class="sval" id="s-act">â€”</span><span class="slbl"> actifs</span></div>
    <div class="sitem"><div class="sdot" style="background:#f59e0b"></div><span class="sval" id="s-cg">â€”</span><span class="slbl"> congÃ©s</span></div>
    <div class="sitem"><div class="sdot" style="background:#ef4444"></div><span class="sval" id="s-ab">â€”</span><span class="slbl"> absences</span></div>
    <div class="sitem" id="s-ec-wrap" style="display:none"><div class="sdot" style="background:#8b5cf6"></div><span class="sval" id="s-ec">â€”</span><span class="slbl"> ETP couverts</span></div>
    <div id="infr-trigger" style="display:none;margin-left:auto">
      <div class="infr-badge" onclick="toggleInfrPanel()">âš ï¸ <span id="s-infr">0</span> infraction(s)</div>
    </div>
  </div>

  <!-- INFRACTIONS -->
  <div class="infr-panel" id="infr-panel">
    <div style="font-size:12px;font-weight:700;color:#dc2626;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between">
      <span>âš ï¸ Infractions lÃ©gales cette pÃ©riode</span>
      <button onclick="toggleInfrPanel()" style="background:none;border:none;color:#dc2626;cursor:pointer">âœ•</button>
    </div>
    <div id="infr-list" style="display:flex;flex-direction:column;gap:4px"></div>
  </div>

  <!-- CONTENU -->
  <div class="plan-content" id="plan-content">
    <div class="loader"><div class="spin"></div><span>Chargement du planningâ€¦</span></div>
  </div>
</div>

<!-- MODAL CRÃ‰NEAU -->
<div class="overlay" id="modalCr">
  <div class="modal">
    <div class="modal-head">
      <h3 id="cr-title">â• Nouveau crÃ©neau</h3>
      <button class="mclose" onclick="closeCr()">âœ•</button>
    </div>
    <div class="modal-body">
      <!-- EMPLOYÃ‰ -->
      <div class="mf">
        <label class="ml">EmployÃ© *</label>
        <select class="mi" id="cr-emp" onchange="onEmpChange()"></select>
      </div>
      <div id="emp-skills-row" style="display:none;margin-bottom:12px">
        <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">CompÃ©tences & Postes</div>
        <div id="emp-skills-display" style="display:flex;gap:4px;flex-wrap:wrap"></div>
      </div>

      <!-- TYPE SELECTOR -->
      <div class="mf">
        <label class="ml">Type de crÃ©neau</label>
        <div class="type-grid" id="type-grid">
          <button type="button" class="type-btn active" data-type="travail" onclick="setType('travail',this)"><div class="type-btn-icon">ğŸ’¼</div><div class="type-btn-lbl">Travail</div></button>
          <button type="button" class="type-btn" data-type="partiel" onclick="setType('partiel',this)"><div class="type-btn-icon">â°</div><div class="type-btn-lbl">Partiel</div></button>
          <button type="button" class="type-btn" data-type="conge" onclick="setType('conge',this)"><div class="type-btn-icon">ğŸ–ï¸</div><div class="type-btn-lbl">CongÃ©</div></button>
          <button type="button" class="type-btn" data-type="maladie" onclick="setType('maladie',this)"><div class="type-btn-icon">ğŸ¤’</div><div class="type-btn-lbl">Maladie</div></button>
          <button type="button" class="type-btn" data-type="formation" onclick="setType('formation',this)"><div class="type-btn-icon">ğŸ“š</div><div class="type-btn-lbl">Formation</div></button>
          <button type="button" class="type-btn" data-type="astreinte" onclick="setType('astreinte',this)"><div class="type-btn-icon">ğŸ””</div><div class="type-btn-lbl">Astreinte</div></button>
          <button type="button" class="type-btn" data-type="repos" onclick="setType('repos',this)"><div class="type-btn-icon">ğŸ˜´</div><div class="type-btn-lbl">Repos</div></button>
          <button type="button" class="type-btn" data-type="autre" onclick="setType('autre',this)"><div class="type-btn-icon">ğŸ“‹</div><div class="type-btn-lbl">Autre</div></button>
        </div>
      </div>

      <!-- DATE -->
      <div class="mrow" id="date-single-row">
        <div class="mf">
          <label class="ml">Date *</label>
          <input class="mi" type="date" id="cr-date" oninput="onDateChange()"/>
        </div>
        <div class="mf" id="poste-field">
          <label class="ml">Poste / Note</label>
          <input class="mi" id="cr-note" placeholder="Ex: Caisse, Cuisine, Accueilâ€¦"/>
        </div>
      </div>

      <!-- MULTI-DATES TOGGLE -->
      <div style="margin-bottom:14px">
        <button type="button" class="multi-toggle" id="multi-toggle-btn" onclick="toggleMulti(!_multiOpen)">
          <div id="multi-icon" style="font-size:16px">ğŸ“…</div>
          <div style="flex:1;text-align:left">
            <div style="font-size:11px;font-weight:700;color:var(--text)" id="multi-toggle-title">Saisir sur plusieurs jours</div>
            <div style="font-size:10px;color:var(--muted)" id="multi-toggle-sub">Cliquez pour ouvrir</div>
          </div>
          <div id="multi-arrow" style="font-size:14px;color:var(--muted);transition:transform .2s">â€º</div>
        </button>
        <div class="multi-panel" id="multi-panel">
          <div class="multi-range-row">
            <div class="mf" style="margin-bottom:0"><label class="ml">Du</label><input class="mi" type="date" id="m-deb" oninput="buildMultiPreview()"/></div>
            <div style="font-size:18px;color:var(--muted);padding-bottom:6px;align-self:end">â†’</div>
            <div class="mf" style="margin-bottom:0"><label class="ml">Au</label><input class="mi" type="date" id="m-fin" oninput="buildMultiPreview()"/></div>
          </div>
          <div class="multi-filters">
            <label class="chip on" onclick="this.classList.toggle('on');buildMultiPreview()"><input type="checkbox" id="excl-we" checked/>â›” Week-ends</label>
            <label class="chip on" onclick="this.classList.toggle('on');buildMultiPreview()"><input type="checkbox" id="excl-fer" checked/>ğŸ‰ FÃ©riÃ©s</label>
            <label class="chip" onclick="this.classList.toggle('on');buildMultiPreview()"><input type="checkbox" id="excl-deja"/>âš ï¸ DÃ©jÃ  saisis</label>
          </div>
          <div class="multi-days-wrap" id="multi-days-wrap" style="display:none">
            <div class="mday-head">
              <div style="font-size:10px;font-weight:700;color:var(--rh-main)">Jours sÃ©lectionnÃ©s <span id="mday-count" style="background:var(--rh-main);color:white;border-radius:8px;padding:1px 6px;margin-left:4px;font-size:10px">0</span></div>
              <div style="display:flex;gap:4px">
                <button type="button" class="btn btn-xs btn-outline" onclick="checkAll(true)">âœ“ Tout</button>
                <button type="button" class="btn btn-xs btn-outline" onclick="checkAll(false)">âœ• Aucun</button>
              </div>
            </div>
            <div class="mday-list" id="mday-list"></div>
          </div>
          <!-- Horaires multi -->
          <div class="multi-hrs" id="multi-hrs" style="display:none">
            <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:8px">â° Horaires appliquÃ©s Ã  chaque jour</div>
            <div style="display:flex;align-items:center;gap:8px">
              <input type="time" class="plage-hl" id="mh-deb" value="09:00" oninput="updMultiDur()"/>
              <span style="color:var(--muted)">â†’</span>
              <input type="time" class="plage-hl" id="mh-fin" value="17:00" oninput="updMultiDur()"/>
              <div class="plage-dur" id="mh-dur">8h</div>
            </div>
          </div>
          <!-- RÃ©sumÃ© -->
          <div id="multi-summary" style="display:none;background:#1a2035;border-radius:8px;padding:10px 12px;font-size:11px;color:rgba(255,255,255,.7);display:flex;align-items:center;gap:10px">
            <div style="font-size:22px;font-weight:800;color:white" id="multi-sum-n">0</div>
            <div style="width:1px;height:28px;background:rgba(255,255,255,.1)"></div>
            <div><div id="multi-sum-label" style="font-weight:700;color:white">jours Ã  enregistrer</div><div id="multi-sum-detail"></div></div>
          </div>
        </div>
      </div>

      <!-- PLAGES HORAIRES -->
      <div id="cr-hrs-section">
        <!-- PRESETS -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
          <label class="ml" style="margin:0">Plages horaires</label>
          <button type="button" onclick="addPlage()" class="btn btn-xs" style="background:var(--rh-ghost);color:var(--rh-main);border:1px solid var(--rh-border)">+ Coupure</button>
        </div>
        <div class="preset-scroll" id="preset-scroll"></div>
        <div id="cr-plages-wrap"></div>
        <div id="cr-total-dur" style="display:none" class="cr-total-dur">
          <span>â± Total</span><span id="cr-total-val">0h</span>
        </div>
      </div>

      <!-- ALERTES LIVE -->
      <div id="live-alerts" style="margin-top:10px"></div>

      <!-- RÃ‰CURRENCE -->
      <div class="mf" style="margin-top:10px">
        <label class="ml">RÃ©currence (optionnel)</label>
        <select class="mi" id="cr-recur">
          <option value="">Aucune</option>
          <option value="week">Toutes les semaines (mÃªme jour)</option>
          <option value="2week">Toutes les 2 semaines</option>
        </select>
        <div id="recur-until-row" style="display:none;margin-top:8px">
          <label class="ml">Jusqu'au</label>
          <input class="mi" type="date" id="cr-recur-until"/>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-danger btn-sm" id="cr-del" style="display:none;margin-right:auto" onclick="delCr()">ğŸ—‘ Supprimer</button>
      <button class="btn btn-outline" onclick="closeCr()">Annuler</button>
      <button class="btn btn-rh" id="save-btn" onclick="saveCr()">ğŸ’¾ Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL IA -->
<div class="overlay" id="modalAI">
  <div class="modal modal-lg">
    <div class="ai-head-bg">
      <h3>âœ¨ GÃ©nÃ©ration IA du planning</h3>
      <p id="ai-period-label">Analyse vos Ã©quipes, compÃ©tences et contraintes pour proposer un planning optimal</p>
    </div>
    <div class="modal-body">
      <div class="ai-sections">
        <div class="ai-sec"><div class="ai-sec-lbl">Ouverture</div><input class="ai-field" id="ai-op" type="time" value="08:00"/></div>
        <div class="ai-sec"><div class="ai-sec-lbl">Fermeture</div><input class="ai-field" id="ai-cl" type="time" value="20:00"/></div>
        <div class="ai-sec"><div class="ai-sec-lbl">Min. personnes / shift</div><input class="ai-field" id="ai-ms" type="number" min="1" value="2"/></div>
        <div class="ai-sec"><div class="ai-sec-lbl">Jours repos / semaine</div><input class="ai-field" id="ai-rd" type="number" min="1" max="3" value="2"/></div>
      </div>
      <div class="mf">
        <label class="ml">Instructions spÃ©cifiques</label>
        <textarea class="mi" id="ai-inst" rows="3" placeholder="Ex : Marie ne travaille pas le lundi. Pas d'ouverture le dimanche. PrÃ©fÃ©rer des shifts matin/soir en rotation. GÃ©rer la polyvalence caisse/cuisineâ€¦" style="resize:none;font-size:12px"></textarea>
      </div>
      <div id="ai-res-wrap" style="display:none">
        <div class="ai-res-box" id="ai-res-box">
          <div style="font-size:10px;font-weight:700;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">RÃ©sultat IA</div>
          <div id="ai-res-content"></div>
        </div>
        <button class="ai-apply-btn" id="ai-apply-btn" style="display:none" onclick="applyAI()">âœ… Appliquer ce planning</button>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeAI()">Fermer</button>
      <button class="btn btn-ai" id="ai-gen-btn" onclick="genAI()">âœ¨ GÃ©nÃ©rer</button>
    </div>
  </div>
</div>

<!-- MODAL POLYVALENCE -->
<div class="overlay" id="modalPoly">
  <div class="modal modal-xl">
    <div class="modal-head">
      <h3>ğŸ¯ Polyvalence & CompÃ©tences de l'Ã©quipe</h3>
      <button class="mclose" onclick="closePoly()">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="font-size:12px;color:var(--muted);margin-bottom:16px">Visualisez les compÃ©tences de vos employÃ©s pour les positionner sur les bons crÃ©neaux. Renseignez les postes dans la fiche employÃ©.</div>
      <div id="poly-grid-content" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px"></div>
      <div style="margin-top:20px;padding:14px;background:#f8faff;border-radius:10px;border:1px solid var(--border)">
        <div style="font-size:12px;font-weight:700;margin-bottom:10px">ğŸ“Š Matrice de polyvalence (Postes Ã— EmployÃ©s)</div>
        <div id="poly-matrix" style="overflow-x:auto"></div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closePoly()">Fermer</button>
      <a href="rh-employes.html" class="btn btn-rh">âœï¸ Modifier les compÃ©tences</a>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import{getFirestore,doc,setDoc,getDoc,getDocs,deleteDoc,collection}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const app=initializeApp({apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",storageBucket:"altiora-70599.firebasestorage.app",messagingSenderId:"120905555746",appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"});
const auth=getAuth(app);const db=getFirestore(app);
window._auth=auth;window._db=db;window._doc=doc;window._setDoc=setDoc;window._getDoc=getDoc;
window._getDocs=getDocs;window._deleteDoc=deleteDoc;window._col=collection;window._signOut=signOut;
onAuthStateChanged(auth,u=>{
  if(!u){location.href='index.html';return;}
  window._uid=u.uid;
  const n=u.displayName||u.email.split('@')[0];
  const ua=document.getElementById('uname');const av=document.getElementById('av');
  if(ua)ua.textContent=n;if(av)av.textContent=n.charAt(0).toUpperCase();
  window._firebaseReady=true;
  window.initPlanning();
});
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   PLANNING RH PRO â€” ALTEORE
//   Gestion ultra-complÃ¨te des horaires, polyvalence et IA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ STATE â”€â”€
let _emps=[], _cr={}, _view='semaine', _disp='gantt';
let _cur=new Date(), _editId=null, _hidden=new Set(), _aiResult=null;
let _zoom=localStorage.getItem('rh_zoom')||'normal';
let _multiOpen=false, _filterPoste='', _infractions={}, _ccnDefault='droit_commun';
let _plages=[{deb:'09:00',fin:'17:00'}], _crType='travail';

const COLS=['c0','c1','c2','c3','c4','c5','c6','c7','c8','c9'];
const TYPE_ICO={travail:'ğŸ’¼',partiel:'â°',conge:'ğŸ–ï¸',maladie:'ğŸ¤’',formation:'ğŸ“š',astreinte:'ğŸ””',repos:'ğŸ˜´',autre:'ğŸ“‹'};
const TYPE_LBL={travail:'Travail',partiel:'Tps partiel',conge:'CongÃ©',maladie:'Maladie',formation:'Formation',astreinte:'Astreinte',repos:'Repos',autre:'Autre'};

// PrÃ©sets horaires courants par secteur
const PRESETS=[
  {lbl:'Matin 9-17',plages:[{deb:'09:00',fin:'17:00'}]},
  {lbl:'Matin 8-16',plages:[{deb:'08:00',fin:'16:00'}]},
  {lbl:'Midi 12-20',plages:[{deb:'12:00',fin:'20:00'}]},
  {lbl:'Soir 14-22',plages:[{deb:'14:00',fin:'22:00'}]},
  {lbl:'Nuit 22-6',plages:[{deb:'22:00',fin:'06:00'}]},
  {lbl:'Coupure 9-14|17-21',plages:[{deb:'09:00',fin:'14:00'},{deb:'17:00',fin:'21:00'}]},
  {lbl:'Court 1h15',plages:[{deb:'09:00',fin:'10:15'}]},
  {lbl:'Demi 9-13',plages:[{deb:'09:00',fin:'13:00'}]},
  {lbl:'Ouverture 7-15',plages:[{deb:'07:00',fin:'15:00'}]},
  {lbl:'Fermeture 15-23',plages:[{deb:'15:00',fin:'23:00'}]},
];

// â”€â”€ CCN RULES â”€â”€
const CCN_RULES={
  droit_commun:{label:'Droit commun',jourMax:10,hebdoMax:48,reposMin:11,pauseApres:6,pauseMin:20},
  commerce:{label:'Commerce alimentaire',jourMax:10,hebdoMax:44,reposMin:11,pauseApres:6,pauseMin:20},
  restauration:{label:'Restauration rapide',jourMax:10,hebdoMax:43,reposMin:11,pauseApres:5,pauseMin:20},
  hotellerie:{label:'HÃ´tellerie-Restauration',jourMax:11,hebdoMax:48,reposMin:11,pauseApres:6,pauseMin:30},
  btp:{label:'BTP',jourMax:10,hebdoMax:46,reposMin:11,pauseApres:6,pauseMin:20},
  industrie:{label:'Industrie',jourMax:10,hebdoMax:48,reposMin:11,pauseApres:6,pauseMin:20},
  sap:{label:'Services Ã  la personne',jourMax:10,hebdoMax:35,reposMin:11,pauseApres:6,pauseMin:20},
};
function getCCN(emp){return CCN_RULES[emp.ccn||_ccnDefault]||CCN_RULES.droit_commun;}

// â”€â”€ HELPERS â”€â”€
function fmt(d){return d.toISOString().slice(0,10);}
function isToday(d){const t=new Date();return fmt(d)===fmt(t);}
function isWE(d){const day=d.getDay();return day===0||day===6;}
function diffH(a,b){
  if(!a||!b)return 0;
  const[ah,am]=a.split(':').map(Number),[bh,bm]=b.split(':').map(Number);
  let mins=(bh*60+bm)-(ah*60+am);
  if(mins<0)mins+=24*60; // nuit
  return Math.max(0,mins/60);
}
function toMin(t){if(!t)return 0;const[h,m]=t.split(':').map(Number);return h*60+m;}
function itemH(it){
  if(it.plages&&it.plages.length>0)return it.plages.reduce((s,p)=>s+diffH(p.deb,p.fin),0);
  return diffH(it.deb,it.fin);
}
function fmtDur(h){
  const hh=Math.floor(h),mm=Math.round((h-hh)*60);
  return mm>0?`${hh}h${String(mm).padStart(2,'0')}`:`${hh}h`;
}
function monday(d){const dt=new Date(d),day=dt.getDay(),diff=(day===0)?-6:1-day;dt.setDate(dt.getDate()+diff);dt.setHours(0,0,0,0);return dt;}
function weekDays(d){const m=monday(d);return Array.from({length:7},(_,i)=>{const dd=new Date(m);dd.setDate(m.getDate()+i);return dd;});}
function monthDays(d){
  const year=d.getFullYear(),month=d.getMonth();
  const first=new Date(year,month,1);
  const last=new Date(year,month+1,0);
  const startDow=first.getDay()===0?6:first.getDay()-1;
  const days=[];
  for(let i=0;i<startDow;i++){const dd=new Date(year,month,1-startDow+i);days.push({date:dd,cur:false});}
  for(let i=1;i<=last.getDate();i++)days.push({date:new Date(year,month,i),cur:true});
  while(days.length%7!==0){const last2=days[days.length-1].date;const dd=new Date(last2);dd.setDate(dd.getDate()+1);days.push({date:dd,cur:false});}
  return days;
}

// ClÃ© de collection Firestore (par mois pour vue mois)
function crKey(d){return `plan_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;}
function weekKey(d){return `plan_${fmt(monday(d)).replace(/-/g,'')}` ;}

// â”€â”€ INIT â”€â”€
async function initPlanning(){
  if(!window._uid){setTimeout(initPlanning,400);return;}
  // Appliquer le zoom sauvegardÃ©
  document.body.setAttribute('data-zoom',_zoom);
  ['compact','normal','comfortable','large'].forEach(k=>{
    document.getElementById('zbtn-'+k)?.classList.toggle('active',k===_zoom);
  });
  await loadRHParams();
  await loadEmps();
  await loadCr();
  render();
}
window.initPlanning=initPlanning;

async function loadRHParams(){
  try{
    const snap=await window._getDoc(window._doc(window._db,'rh_params',window._uid));
    if(snap.exists()){const d=snap.data();if(d.ccnDefault)_ccnDefault=d.ccnDefault;}
  }catch(e){console.warn(e);}
}

async function loadEmps(){
  _emps=[];
  try{
    const s=await window._getDocs(window._col(window._db,'rh',window._uid,'employes'));
    s.forEach(d=>{const e=d.data();if(e.statut!=='archive')_emps.push({id:d.id,...e});});
    _emps.sort((a,b)=>(a.prenom||'').localeCompare(b.prenom||''));
  }catch(e){console.warn(e);}
  buildPosteFilter();
  renderLegend();
  fillEmpSel();
}

// Charge les crÃ©neaux pour la pÃ©riode affichÃ©e (semaine ou mois)
async function loadCr(){
  _cr={};
  try{
    if(_view==='mois'){
      // Utiliser TOUS les jours visibles dans la grille (y compris dÃ©bordements
      // des mois adjacents) pour ne rater aucune collection de semaine.
      // monthDays() retourne dÃ©jÃ  les jours padding avant/aprÃ¨s le mois.
      const keys=new Set();
      monthDays(_cur).forEach(({date})=>keys.add(weekKey(date)));
      for(const k of keys){
        const s=await window._getDocs(window._col(window._db,'rh',window._uid,k));
        s.forEach(doc=>{_cr[doc.id]=doc.data();});
      }
    } else {
      const k=weekKey(_cur);
      const s=await window._getDocs(window._col(window._db,'rh',window._uid,k));
      s.forEach(doc=>{_cr[doc.id]=doc.data();});
    }
  }catch(e){console.warn(e);}
}

// â”€â”€ NAV â”€â”€
function navPrev(){
  if(_view==='mois')_cur.setMonth(_cur.getMonth()-1);
  else if(_view==='jour')_cur.setDate(_cur.getDate()-1);
  else _cur.setDate(_cur.getDate()-7);
  refresh();
}
function navNext(){
  if(_view==='mois')_cur.setMonth(_cur.getMonth()+1);
  else if(_view==='jour')_cur.setDate(_cur.getDate()+1);
  else _cur.setDate(_cur.getDate()+7);
  refresh();
}
function goToday(){_cur=new Date();refresh();}
window.navPrev=navPrev;window.navNext=navNext;window.goToday=goToday;

async function refresh(){await loadCr();render();}

function setView(v){
  _view=v;
  ['mois','semaine','jour'].forEach(k=>document.getElementById('vtab-'+k)?.classList.toggle('active',k===v));
  const dt=document.getElementById('disp-tabs');
  if(dt)dt.style.display=(v==='mois')?'none':'flex';
  refresh();
}
window.setView=setView;

function setDisp(d){
  _disp=d;
  ['gantt','timeline'].forEach(k=>document.getElementById('dtab-'+k)?.classList.toggle('active',k===d));
  render();
}
window.setDisp=setDisp;

function applyFilters(){
  _filterPoste=document.getElementById('filter-poste')?.value||'';
  render();
}
window.applyFilters=applyFilters;

// â”€â”€ ZOOM / DENSITÃ‰ â”€â”€
function setZoom(z){
  _zoom=z;
  localStorage.setItem('rh_zoom',z);
  document.body.setAttribute('data-zoom',z);
  ['compact','normal','comfortable','large'].forEach(k=>{
    document.getElementById('zbtn-'+k)?.classList.toggle('active',k===z);
  });
  render();
}
window.setZoom=setZoom;

// Applique le zoom sauvegardÃ© au dÃ©marrage
(function(){
  document.body.setAttribute('data-zoom',_zoom);
  // Activer le bon bouton une fois le DOM prÃªt
  document.addEventListener('DOMContentLoaded',()=>{
    ['compact','normal','comfortable','large'].forEach(k=>{
      document.getElementById('zbtn-'+k)?.classList.toggle('active',k===_zoom);
    });
  });
})();

// â”€â”€ RENDER â”€â”€
function render(){
  updLabel();
  checkLegal();
  updStats();
  if(_view==='mois')renderMois();
  else if(_view==='jour')renderJour();
  else if(_disp==='timeline'||((_view==='jour')&&_disp==='timeline'))renderTimeline();
  else renderGantt();
}

function updLabel(){
  const el=document.getElementById('week-label');
  const sub=document.getElementById('topbar-sub');
  if(_view==='mois'){
    const s=_cur.toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
    if(el)el.textContent=s.charAt(0).toUpperCase()+s.slice(1);
    if(sub)sub.textContent='Vue mensuelle Â· Planning complet';
  } else if(_view==='jour'){
    if(el)el.textContent=_cur.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});
    if(sub)sub.textContent='Vue journaliÃ¨re';
  } else {
    const days=weekDays(_cur);
    const s=`${days[0].toLocaleDateString('fr-FR',{day:'numeric',month:'short'})} â€“ ${days[6].toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'})}`;
    if(el)el.textContent=s;
    if(sub)sub.textContent=`Vue semaine Â· ${_disp==='timeline'?'Timeline':'Gantt'}`;
  }
}

// â”€â”€ GANTT SEMAINE â”€â”€
function renderGantt(){
  const days=weekDays(_cur);
  const vis=visibleEmps();
  const pc=document.getElementById('plan-content');
  const empW=({compact:130,normal:170,comfortable:200,large:220})[_zoom]||170;
  const cols=`${empW}px repeat(7,minmax(80px,1fr))`;

  let h=`<div class="gantt-wrap"><div class="gantt-head" style="display:grid;grid-template-columns:${cols}">
    <div class="gh-emp">EmployÃ© <span style="font-size:9px;font-weight:400;margin-left:4px">${vis.length}/${_emps.length}</span></div>
    ${days.map(d=>`<div class="gh-day ${isToday(d)?'today':''} ${isWE(d)?'we':''}">
      <div class="gh-dname">${d.toLocaleDateString('fr-FR',{weekday:'short'})}</div>
      <div class="gh-dnum">${d.getDate()}</div>
    </div>`).join('')}
  </div>`;

  if(!vis.length){
    h+=`<div class="empty-plan"><div style="font-size:42px;margin-bottom:12px">ğŸ‘¥</div><h3>Aucun employÃ© visible</h3><a href="rh-employes.html" style="color:var(--rh-main);font-weight:700;margin-top:8px">+ Ajouter des employÃ©s â†’</a></div>`;
  } else {
    vis.forEach((e,i)=>{
      const cc=COLS[i%COLS.length];
      const weekH=empWeekH(e.id,days);
      const ccn=getCCN(e);
      const infraCnt=Object.keys(_infractions).filter(k=>k.includes(e.id)).reduce((s,k)=>s+_infractions[k].length,0);
      // Nom affichÃ© selon le zoom
      const nomCourt=`${e.prenom||''} ${(e.nom||'')[0]||'.'}.`;
      const nomLong=`${e.prenom||''} ${e.nom||''}`;
      const nomAff=(_zoom==='comfortable'||_zoom==='large')?nomLong:nomCourt;
      const showPoste=(_zoom==='large')&&e.poste;
      h+=`<div class="gantt-row" style="display:grid;grid-template-columns:${cols}">
        <div class="ge-cell">
          <div class="ge-av ${cc}">${(e.prenom||'?')[0]}${(e.nom||'')[0]||''}</div>
          <div class="ge-info">
            <div class="ge-name">${nomAff}</div>
            <div class="ge-meta">
              <span class="ge-hbadge">${fmtDur(weekH)}</span>
              ${infraCnt>0?`<span class="ge-alert">âš ï¸${infraCnt}</span>`:''}
            </div>
            ${showPoste?`<div class="ge-meta" style="margin-top:2px;color:var(--muted)">${e.poste}</div>`:''}
            ${(_zoom==='comfortable'||_zoom==='large')&&e.competences&&e.competences.length>0?`<div class="ge-meta" style="margin-top:2px">${e.competences.slice(0,2).map(c=>`<span class="poste-tag">${c.nom||c}</span>`).join('')}</div>`:''}
          </div>
        </div>
        ${days.map(d=>{
          const k=`${fmt(d)}_${e.id}`;
          const items=(_cr[k]?.items||[]);
          const off=isWE(d)&&!items.length;
          const infrs=_infractions[k]||[];
          return `<div class="gd-cell ${isToday(d)?'today':''} ${off?'we':''}"
            data-dnd-target-k="${k}"
            ondragover="dndOver(event,'${k}')"
            ondragleave="dndLeave(event)"
            ondrop="dndDrop(event,'${k}')"
            onclick="openCreneauModal('${e.id}','${fmt(d)}')">
            ${items.map(it=>pillGantt(it,k)).join('')}
            ${infrs.length?`<div style="font-size:8px;font-weight:700;color:#dc2626;padding:1px 3px;background:#fee2e2;border-radius:3px;margin-top:2px">âš ï¸</div>`:''}
            ${items.length?'':'<div class="add-hint">+</div>'}
          </div>`;
        }).join('')}
      </div>`;
    });
  }
  h+='</div>';
  pc.innerHTML=h;
}

function pillGantt(it,k){
  const plages=it.plages&&it.plages.length>0?it.plages:(it.deb&&it.fin?[{deb:it.deb,fin:it.fin}]:[]);
  const totalH=plages.reduce((s,p)=>s+diffH(p.deb,p.fin),0);
  const timeTxt=plages.length>1?plages.map(p=>`${p.deb}â€“${p.fin}`).join('|'):plages[0]?`${plages[0].deb}â€“${plages[0].fin}`:'';
  return `<div class="cr-pill t-${it.type}"
    data-dnd-k="${k}" data-dnd-id="${it.id}"
    onpointerdown="pmGanttDown(event,'${k}','${it.id}')"
    onclick="event.stopPropagation();editCr('${k}','${it.id}')">
    <div class="cr-time">${timeTxt}${totalH>0?' ('+fmtDur(totalH)+')':''}</div>
    <div class="cr-lbl">${TYPE_ICO[it.type]||'ğŸ“‹'} ${it.note||TYPE_LBL[it.type]||it.type}</div>
    <span class="cr-x" onclick="event.stopPropagation();qDel('${k}','${it.id}')">âœ•</span>
  </div>`;
}

// â”€â”€ TIMELINE SEMAINE â”€â”€
// â”€â”€ TIMELINE (vue par jour unique) â”€â”€
// Affiche une seule journÃ©e. Navigation par boutons jours quand vue=semaine.
// DnD : glisser une barre sur la ligne d'un autre employÃ© â†’ rÃ©affectation.
let _tlDay = null; // jour affichÃ© en timeline quand vue=semaine

function tl_setDay(dateStr){
  _tlDay = new Date(dateStr + 'T12:00:00');
  render();
}
window.tl_setDay = tl_setDay;

function renderTimeline(){
  // Jour Ã  afficher
  const d = (_view==='semaine') ? (_tlDay || weekDays(_cur)[0]) : _cur;
  if(_view==='semaine') _tlDay = d;

  const vis = visibleEmps();
  const pc  = document.getElementById('plan-content');
  if(!vis.length){
    pc.innerHTML=`<div class="empty-plan"><div style="font-size:42px">ğŸ‘¥</div><h3>Aucun employÃ© visible</h3></div>`;
    return;
  }

  const START_H=6, END_H=23, SPAN=END_H-START_H;
  const pct=(h,m=0)=>Math.max(0,Math.min(100,((h-START_H)*60+m)/(SPAN*60)*100));
  const now=new Date();
  const nowPct=isToday(d)?pct(now.getHours(),now.getMinutes()):null;
  const TICKS=[6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22];
  const empW=({compact:120,normal:155,comfortable:185,large:210})[_zoom]||155;

  // â”€â”€ Barre de sÃ©lection du jour (vue semaine) â”€â”€
  let dayNav='';
  if(_view==='semaine'){
    const days=weekDays(_cur);
    dayNav=`<div style="display:flex;align-items:center;gap:4px;padding:7px 16px;background:white;border-bottom:1px solid var(--border);overflow-x:auto;-webkit-overflow-scrolling:touch;flex-shrink:0">
      <span style="font-size:10px;font-weight:700;color:var(--muted);white-space:nowrap;margin-right:4px">Jour :</span>
      ${days.map(dd=>{
        const active=fmt(dd)===fmt(d);
        const we=isWE(dd);
        return `<button onclick="tl_setDay('${fmt(dd)}')" style="padding:4px 10px;border-radius:6px;border:1.5px solid ${active?'var(--rh-main)':'var(--border)'};background:${active?'var(--rh-ghost)':we?'#f9fafb':'white'};color:${active?'var(--rh-main)':we?'#9ca3af':'var(--text)'};font-family:'Plus Jakarta Sans',sans-serif;font-size:11px;font-weight:${active?700:500};cursor:pointer;white-space:nowrap;flex-shrink:0;transition:all .15s">${dd.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric'})}</button>`;
      }).join('')}
    </div>`;
  }

  // â”€â”€ En-tÃªte jour â”€â”€
  const dayHdr=`<div style="padding:9px 16px;background:white;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0">
    <span style="font-size:14px;font-weight:800;color:${isToday(d)?'var(--rh-main)':'var(--text)'}">${d.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'})}</span>
    ${isToday(d)?`<span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:var(--rh-ghost);color:var(--rh-main)">Aujourd'hui</span>`:''}
    <span style="font-size:11px;color:var(--muted);margin-left:auto">â†” Glisser une barre pour changer l'employÃ©</span>
  </div>`;

  // â”€â”€ RÃ¨gle horaire â”€â”€
  const ruler=`<div style="display:flex;position:sticky;top:0;z-index:10;background:white;border-bottom:2px solid var(--border);box-shadow:0 2px 4px rgba(0,0,0,.04)">
    <div style="width:${empW}px;flex-shrink:0;padding:7px 12px;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase">EmployÃ©</div>
    <div style="flex:1;position:relative;height:30px;min-width:0">
      ${TICKS.map(hh=>`
        <div style="position:absolute;left:${pct(hh)}%;top:0;bottom:0;width:1px;background:#f1f5f9;pointer-events:none"></div>
        <span style="position:absolute;left:${pct(hh)}%;top:7px;font-size:9px;font-weight:700;color:#94a3b8;transform:translateX(-50%)">${hh}h</span>
      `).join('')}
      ${nowPct!==null?`<div style="position:absolute;left:${nowPct}%;top:0;bottom:0;width:2px;background:#ef4444;z-index:3;pointer-events:none"><div style="position:absolute;top:-3px;left:-4px;width:10px;height:10px;background:#ef4444;border-radius:50%"></div></div>`:''}
    </div>
  </div>`;

  // â”€â”€ Lignes employÃ©s â”€â”€
  const rows=vis.map((e,i)=>{
    const cc=COLS[i%COLS.length];
    const k=`${fmt(d)}_${e.id}`;
    const items=(_cr[k]?.items||[]);
    const totalH=items.filter(it=>it.type==='travail'||it.type==='partiel').reduce((s,it)=>s+itemH(it),0);
    const infraCnt=(_infractions[k]||[]).length;

    const bars=items.map(it=>{
      const plages=it.plages&&it.plages.length>0?it.plages:(it.deb&&it.fin?[{deb:it.deb,fin:it.fin}]:[]);
      return plages.map(p=>{
        const [dh,dm]=(p.deb||'00:00').split(':').map(Number);
        const [fh,fm]=(p.fin||'00:00').split(':').map(Number);
        const left=pct(dh,dm);
        const width=Math.max(pct(fh,fm)-left, 1.5);
        const dur=diffH(p.deb,p.fin);
        if(left>100||left+width<0)return '';
        return `<div class="tl-shift-bar t-${it.type}"
          style="left:${left}%;width:${width}%;min-width:28px;z-index:3"
          data-dnd-k="${k}" data-dnd-id="${it.id}"
          data-deb="${p.deb}" data-fin="${p.fin}"
          onpointerdown="pmTlDown(event,'${k}','${it.id}','${p.deb}','${p.fin}')"
          onclick="event.stopPropagation();editCr('${k}','${it.id}')"
          title="${p.deb}â†’${p.fin} (${fmtDur(dur)})">
          ${dur>=0.75?`<span style="font-size:9px;font-weight:700;pointer-events:none">${p.deb}â€“${p.fin}</span>`:''}
          ${it.note&&dur>=1?`<span style="opacity:.75;font-size:9px;pointer-events:none"> ${it.note}</span>`:''}
        </div>`;
      }).join('');
    }).join('');

    return `<div class="tl-row" style="height:52px"
      data-dnd-target-k="${k}"
      ondragover="dndTlOver(event,'${k}',this)"
      ondragleave="dndTlLeave(event,this)"
      ondrop="dndDrop(event,'${k}')">
      <!-- Colonne employÃ© (sticky) -->
      <div class="tl-emp" style="width:${empW}px;position:sticky;left:0;background:inherit;z-index:4">
        <div class="${cc} ge-av" style="width:28px;height:28px;font-size:10px;flex-shrink:0">${(e.prenom||'?')[0]}${(e.nom||'')[0]||''}</div>
        <div style="min-width:0">
          <div style="font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${e.prenom||''} ${e.nom||''}</div>
          <div style="display:flex;gap:4px;align-items:center">
            ${totalH>0?`<span style="font-size:9px;font-weight:700;color:var(--rh-main)">${fmtDur(totalH)}</span>`:''}
            ${infraCnt>0?`<span style="font-size:9px;font-weight:700;color:#dc2626">âš ï¸</span>`:''}
          </div>
        </div>
      </div>
      <!-- Zone barres -->
      <div class="tl-bar-wrap" style="position:relative;flex:1;min-width:0;cursor:crosshair"
        onclick="tlBwrapClick(event,'${e.id}','${fmt(d)}')"
        data-start="${_pm.tlStartH||6}" data-span="${(_pm.tlEndH||23)-(_pm.tlStartH||6)}">
        ${TICKS.map(hh=>`<div class="tl-grid-line" style="left:${pct(hh)}%"></div>`).join('')}
        ${bars}
        ${!items.length?`<div style="position:absolute;inset:0;display:flex;align-items:center;padding-left:14px;pointer-events:none;color:#d1d5db;font-size:11px;font-weight:500">+ Cliquer pour ajouter</div>`:''}
      </div>
    </div>`;
  }).join('');

  pc.innerHTML=`<div style="display:flex;flex-direction:column;height:100%">
    ${dayNav}${dayHdr}
    <div style="flex:1;overflow:auto;-webkit-overflow-scrolling:touch">
      <div style="min-width:${empW+500}px;height:100%">
        ${ruler}${rows}
      </div>
    </div>
  </div>`;
}

// â”€â”€ Clic sur la zone horaire timeline â†’ ouvre modal prÃ©-rempli â”€â”€
function tlBwrapClick(ev, empId, date){
  // Ignorer si c'est la fin d'un drag ou un clic sur une barre existante
  if(_pm.active) return;
  if(ev.target.classList.contains('tl-shift-bar') || ev.target.closest('.tl-shift-bar')) return;

  const bwrap = ev.currentTarget;
  const rect  = bwrap.getBoundingClientRect();
  const START_H = 6, END_H = 23, SPAN = (END_H - START_H) * 60;

  // Calcul de l'heure cliquÃ©e
  const ratio  = (ev.clientX - rect.left) / rect.width;
  const rawMin = ratio * SPAN + START_H * 60;
  const debMin = _snapQ(Math.max(START_H * 60, Math.min(END_H * 60 - 60, rawMin)));
  const finMin = Math.min(debMin + 60, END_H * 60); // durÃ©e par dÃ©faut 1h
  const debStr = _minToStr(debMin);
  const finStr = _minToStr(finMin);

  // Ouvrir le modal avec l'heure prÃ©-remplie
  openCreneauModal(empId, date);
  // Forcer la plage calculÃ©e (aprÃ¨s que renderPlages() ait tournÃ©)
  setTimeout(() => {
    _plages = [{deb: debStr, fin: finStr}];
    renderPlages();
  }, 20);
}
window.tlBwrapClick = tlBwrapClick;

// dndTlOver/dndTlLeave supprimÃ©s (pointer-events engine)

// â”€â”€ VUE MOIS â”€â”€
function renderMois(){
  const days=monthDays(_cur);
  const vis=visibleEmps();
  const pc=document.getElementById('plan-content');
  const JOURS=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
  // Nombre de pills selon le zoom
  const maxPills={compact:2,normal:3,comfortable:5,large:7}[_zoom]||3;

  let h=`<div class="month-wrap"><div class="month-grid">
    ${JOURS.map(j=>`<div class="m-dhead">${j}</div>`).join('')}
    ${days.map(({date,cur})=>{
      const kp=fmt(date);
      const allItems=[];
      vis.forEach(e=>(_cr[`${kp}_${e.id}`]?.items||[]).forEach(it=>allItems.push({e,it})));
      const totalH=allItems.filter(({it})=>it.type==='travail'||it.type==='partiel').reduce((s,{it})=>s+itemH(it),0);
      const shown=allItems.slice(0,maxPills);
      const empCount=vis.filter(e=>(_cr[`${kp}_${e.id}`]?.items||[]).length>0).length;
      return `<div class="m-cell ${isToday(date)?'m-today':''} ${!cur?'m-other':''} ${isWE(date)?'m-we':''}"
        onclick="setView('jour');_cur=new Date('${kp}T12:00:00');render()">
        <div class="m-dnum">
          <span ${isToday(date)?'class="m-dnum-circle"':''}>${date.getDate()}</span>
          ${(_zoom==='comfortable'||_zoom==='large')&&cur?`<span style="font-size:9px;font-weight:500;color:var(--muted);margin-left:4px">${date.toLocaleDateString('fr-FR',{weekday:'short'})}</span>`:''}
        </div>
        ${totalH>0?`<div class="m-total-badge">${fmtDur(totalH)}${(_zoom==='large'&&empCount>0)?` Â· ${empCount}p`:''}  </div>`:''}
        ${shown.map(({e,it})=>{
          const plages=it.plages&&it.plages.length>0?it.plages:(it.deb?[{deb:it.deb,fin:it.fin}]:[]);
          const timeTxt=plages[0]?`${plages[0].deb}`:it.type;
          const empTxt=(_zoom==='comfortable'||_zoom==='large')?`${e.prenom||''} `:''
          return `<div class="m-pill t-${it.type}">${empTxt}${timeTxt}</div>`;
        }).join('')}
        ${allItems.length>maxPills?`<div class="m-more">+${allItems.length-maxPills} autres</div>`:''}
        ${allItems.length===0&&cur?`<div style="font-size:10px;color:#d1d5db;padding:4px 0">libre</div>`:''}
      </div>`;
    }).join('')}
  </div></div>`;
  pc.innerHTML=h;
}

// â”€â”€ VUE JOUR â”€â”€
function renderJour(){
  const vis=visibleEmps();
  const pc=document.getElementById('plan-content');
  const d=_cur;

  if(!vis.length){pc.innerHTML=`<div class="empty-plan"><div style="font-size:42px">ğŸ‘¥</div><h3>Aucun employÃ©</h3></div>`;return;}

  let h=`<div style="padding:14px 20px;font-size:14px;font-weight:800;color:var(--text)">${d.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
  <div class="day-wrap">`;

  vis.forEach((e,i)=>{
    const cc=COLS[i%COLS.length];
    const k=`${fmt(d)}_${e.id}`;
    const items=(_cr[k]?.items||[]);
    const totalH=items.filter(it=>it.type==='travail'||it.type==='partiel').reduce((s,it)=>s+itemH(it),0);
    const comps=(e.competences||[]).slice(0,4);

    h+=`<div class="day-card">
      <div class="dc-head">
        <div class="${cc} ge-av" style="width:30px;height:30px;font-size:11px">${(e.prenom||'?')[0]}${(e.nom||'')[0]||''}</div>
        <div style="min-width:0">
          <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${e.prenom||''} ${e.nom||''}</div>
          <div style="font-size:10px;color:var(--muted)">${e.typeContrat||'CDI'} Â· ${e.heuresHebdo||35}h</div>
        </div>
      </div>
      ${comps.length?`<div class="dc-skills">${comps.map(c=>`<span class="dc-skill-chip">${c.nom||c}</span>`).join('')}</div>`:''}
      <div class="dc-body">
        ${items.length?items.map(it=>pillGantt(it,k)).join(''):'<div class="dc-libre">Libre</div>'}
      </div>
      <div class="dc-footer">
        ${totalH>0?`<span class="dc-h">${fmtDur(totalH)}</span>`:'<span></span>'}
        <button class="btn btn-xs btn-rh" onclick="openCreneauModal('${e.id}','${fmt(d)}')">+</button>
      </div>
    </div>`;
  });

  h+=`</div>`;
  pc.innerHTML=h;
}

// â”€â”€ STATS + LÃ‰GALE â”€â”€
function updStats(){
  let totalH=0,actifs=0,conges=0,abs=0;
  const days=_view==='mois'?monthDays(_cur).filter(x=>x.cur).map(x=>x.date):_view==='jour'?[_cur]:weekDays(_cur);
  days.forEach(d=>{
    _emps.forEach(e=>{
      const k=`${fmt(d)}_${e.id}`;
      const items=(_cr[k]?.items||[]);
      items.forEach(it=>{
        if(it.type==='travail'||it.type==='partiel'){totalH+=itemH(it);actifs++;}
        else if(it.type==='conge')conges++;
        else if(it.type==='maladie')abs++;
      });
    });
  });
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set('s-h',fmtDur(totalH));set('s-act',actifs);set('s-cg',conges);set('s-ab',abs);
  const infraCnt=Object.values(_infractions).reduce((s,a)=>s+a.length,0);
  const ib=document.getElementById('infr-trigger');
  if(ib)ib.style.display=infraCnt>0?'block':'none';
  set('s-infr',infraCnt);
}

function checkLegal(){
  _infractions={};
  const days=_view==='mois'?monthDays(_cur).filter(x=>x.cur).map(x=>x.date):weekDays(_cur);
  _emps.forEach(e=>{
    const ccn=getCCN(e);
    days.forEach(d=>{
      const k=`${fmt(d)}_${e.id}`;
      const items=(_cr[k]?.items||[]).filter(it=>it.type==='travail'||it.type==='partiel');
      if(!items.length)return;
      const jourH=items.reduce((s,it)=>s+itemH(it),0);
      const alerts=[];
      if(jourH>ccn.jourMax)alerts.push({sev:'err',msg:`${e.prenom} : ${fmtDur(jourH)} > max ${ccn.jourMax}h (${fmt(d)})`});
      // Repos inter-shift
      const yesterday=new Date(d);yesterday.setDate(yesterday.getDate()-1);
      const yvK=`${fmt(yesterday)}_${e.id}`;
      const yvItems=(_cr[yvK]?.items||[]).filter(it=>it.type==='travail'||it.type==='partiel');
      if(yvItems.length){
        const lastFin=Math.max(...yvItems.map(it=>toMin(it.plages?.length?it.plages[it.plages.length-1].fin:it.fin||'00:00')));
        const firstDeb=Math.min(...items.map(it=>toMin(it.plages?.length?it.plages[0].deb:it.deb||'00:00')));
        const gapH=((24*60-lastFin)+firstDeb)/60;
        if(gapH<ccn.reposMin)alerts.push({sev:'err',msg:`${e.prenom} : repos inter-shift ${gapH.toFixed(1)}h < ${ccn.reposMin}h (${fmt(d)})`});
      }
      if(alerts.length)_infractions[k]=alerts;
    });
  });

  const list=document.getElementById('infr-list');
  if(list){
    const all=Object.values(_infractions).flat();
    list.innerHTML=all.map(a=>`<div class="alert-row ${a.sev}">${a.sev==='err'?'ğŸ”´':'ğŸŸ¡'} ${a.msg}</div>`).join('');
    if(!all.length)document.getElementById('infr-panel')?.classList.remove('show');
  }
}

function toggleInfrPanel(){document.getElementById('infr-panel')?.classList.toggle('show');}
window.toggleInfrPanel=toggleInfrPanel;

// â”€â”€ LÃ‰GENDE â”€â”€
function renderLegend(){
  const el=document.getElementById('emp-legend');
  if(!_emps.length){el.innerHTML=`<div style="font-size:11px;font-weight:700;color:var(--muted)">Ã‰quipe :</div><a href="rh-employes.html" style="font-size:11px;font-weight:700;color:var(--rh-main);text-decoration:none">+ Ajouter des employÃ©s â†’</a>`;return;}
  el.innerHTML=`<div style="font-size:10px;font-weight:700;color:var(--muted);flex-shrink:0">Ã‰quipe :</div>`+
  _emps.map((e,i)=>`<div class="leg-item ${_hidden.has(e.id)?'hidden':''}" onclick="toggleEmp('${e.id}')">
    <div class="leg-dot ${COLS[i%COLS.length]}"></div>${e.prenom||''} ${(e.nom||'')[0]||''}.
    ${(e.competences||[]).length?`<span class="leg-skills">(${(e.competences||[]).length} post.)</span>`:''}
  </div>`).join('');
}

function toggleEmp(id){_hidden.has(id)?_hidden.delete(id):_hidden.add(id);renderLegend();render();}
window.toggleEmp=toggleEmp;

function visibleEmps(){
  let list=_emps.filter(e=>!_hidden.has(e.id));
  if(_filterPoste)list=list.filter(e=>(e.competences||[]).some(c=>(c.nom||c)===_filterPoste));
  return list;
}

function buildPosteFilter(){
  const postes=new Set();
  _emps.forEach(e=>(e.competences||[]).forEach(c=>postes.add(c.nom||c)));
  const sel=document.getElementById('filter-poste');
  if(sel){
    sel.innerHTML=`<option value="">Tous postes</option>`+[...postes].sort().map(p=>`<option value="${p}">${p}</option>`).join('');
  }
}

function fillEmpSel(){
  const sel=document.getElementById('cr-emp');
  if(sel)sel.innerHTML=_emps.map(e=>`<option value="${e.id}">${e.prenom||''} ${e.nom||''}</option>`).join('');
}

function empWeekH(eid,days){
  let h=0;
  days.forEach(d=>{
    (_cr[`${fmt(d)}_${eid}`]?.items||[]).forEach(it=>{
      if(it.type==='travail'||it.type==='partiel')h+=itemH(it);
    });
  });
  return h;
}

// â”€â”€ MODAL CRÃ‰NEAU â”€â”€
function openCreneauModal(empId='',date='',defType='travail'){
  _editId=null;
  _plages=[{deb:'09:00',fin:'17:00'}];
  _crType=defType;
  document.getElementById('cr-title').textContent='â• Nouveau crÃ©neau';
  document.getElementById('cr-del').style.display='none';
  if(empId)document.getElementById('cr-emp').value=empId;
  if(date)document.getElementById('cr-date').value=date;
  else document.getElementById('cr-date').value=fmt(_cur);
  document.getElementById('cr-note').value='';
  document.getElementById('cr-recur').value='';
  document.getElementById('recur-until-row').style.display='none';
  setType(defType,document.querySelector(`.type-btn[data-type="${defType}"]`));
  toggleMulti(false);
  onEmpChange();
  renderPresets();
  renderPlages();
  document.getElementById('modalCr').classList.add('show');
}
window.openCreneauModal=openCreneauModal;

function openCongeRapide(){
  openCreneauModal('','','conge');
  setTimeout(()=>toggleMulti(true),60);
}
window.openCongeRapide=openCongeRapide;

function closeCr(){document.getElementById('modalCr').classList.remove('show');}
window.closeCr=closeCr;

function onEmpChange(){
  const eid=document.getElementById('cr-emp')?.value;
  const emp=_emps.find(e=>e.id===eid);
  const row=document.getElementById('emp-skills-row');
  const disp=document.getElementById('emp-skills-display');
  if(emp&&emp.competences&&emp.competences.length&&row&&disp){
    row.style.display='block';
    disp.innerHTML=emp.competences.map(c=>`<span class="poste-tag">â­ ${c.nom||c}</span>`).join('');
  } else if(row){row.style.display='none';}
  updLiveAlerts();
}
window.onEmpChange=onEmpChange;

function setType(type,btn){
  _crType=type;
  document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  const showHrs=['travail','partiel','formation','astreinte'].includes(type);
  document.getElementById('cr-hrs-section').style.display=showHrs?'block':'none';
  document.getElementById('multi-hrs').style.display=showHrs?'block':'none';
  renderPresets();
  if(showHrs)renderPlages();
  updLiveAlerts();
}
window.setType=setType;

function onDateChange(){updLiveAlerts();}
window.onDateChange=onDateChange;

// PrÃ©sets selon type
function renderPresets(){
  const wrap=document.getElementById('preset-scroll');
  if(!wrap)return;
  if(!['travail','partiel','astreinte'].includes(_crType)){wrap.innerHTML='';return;}
  wrap.innerHTML=PRESETS.map((p,i)=>`<button type="button" class="preset-btn" onclick="applyPreset(${i})">${p.lbl}</button>`).join('');
}
function applyPreset(i){
  _plages=PRESETS[i].plages.map(p=>({...p}));
  renderPlages();
}
window.applyPreset=applyPreset;

// â”€â”€ PLAGES â”€â”€
function renderPlages(){
  const wrap=document.getElementById('cr-plages-wrap');
  if(!wrap)return;
  wrap.innerHTML=_plages.map((p,i)=>`
    <div class="plage-row">
      ${i>0?`<div class="plage-sep" style="width:36px;text-align:center;font-size:9px;font-weight:700;color:var(--muted)">â†³ coupure</div>`:`<div style="width:36px"></div>`}
      <input type="time" class="plage-hl" value="${p.deb}" oninput="updPlage(${i},'deb',this.value)"/>
      <span style="color:var(--muted);font-size:14px">â†’</span>
      <input type="time" class="plage-hl" value="${p.fin}" oninput="updPlage(${i},'fin',this.value)"/>
      <div class="plage-dur">${fmtDur(diffH(p.deb,p.fin))}</div>
      ${_plages.length>1?`<button type="button" class="plage-del" onclick="removePlage(${i})">Ã—</button>`:`<div style="width:22px"></div>`}
    </div>`).join('');
  updTotalDur();
}

function addPlage(){
  const last=_plages[_plages.length-1];
  const [fh,fm]=(last.fin||'17:00').split(':').map(Number);
  const newDeb=`${String(fh+1).padStart(2,'0')}:${String(fm).padStart(2,'0')}`;
  const newFin=`${String(fh+3).padStart(2,'0')}:${String(fm).padStart(2,'0')}`;
  _plages.push({deb:newDeb,fin:newFin});
  renderPlages();
}
window.addPlage=addPlage;

function removePlage(i){if(_plages.length<=1)return;_plages.splice(i,1);renderPlages();}
window.removePlage=removePlage;

function updPlage(i,field,val){if(_plages[i])_plages[i][field]=val;updTotalDur();updLiveAlerts();}
window.updPlage=updPlage;

function updTotalDur(){
  const total=_plages.reduce((s,p)=>s+diffH(p.deb,p.fin),0);
  const el=document.getElementById('cr-total-dur');
  const val=document.getElementById('cr-total-val');
  if(el){el.style.display=total>0?'flex':'none';}
  if(val){val.textContent=fmtDur(total);}
  // Mettre Ã  jour les dur de chaque plage
  document.querySelectorAll('.plage-dur').forEach((el,i)=>{
    if(_plages[i])el.textContent=fmtDur(diffH(_plages[i].deb,_plages[i].fin));
  });
}

// â”€â”€ ALERTES LIVE â”€â”€
function updLiveAlerts(){
  const el=document.getElementById('live-alerts');
  if(!el)return;
  el.innerHTML='';
  const eid=document.getElementById('cr-emp')?.value;
  const date=document.getElementById('cr-date')?.value;
  if(!eid||!date||!['travail','partiel'].includes(_crType))return;
  const emp=_emps.find(e=>e.id===eid);
  if(!emp)return;
  const ccn=getCCN(emp);
  const alerts=[];
  const k=`${date}_${eid}`;
  const existH=(_cr[k]?.items||[]).filter(it=>it.type==='travail'||it.type==='partiel').reduce((s,it)=>s+itemH(it),0);
  const curH=_plages.reduce((s,p)=>s+diffH(p.deb,p.fin),0);
  const jourH=existH+curH;
  if(jourH>ccn.jourMax)alerts.push({sev:'err',msg:`JournÃ©e dÃ©passÃ©e : ${fmtDur(jourH)} (max ${ccn.jourMax}h â€” ${ccn.label})`});
  if(_plages.length===1&&curH>ccn.pauseApres)alerts.push({sev:'warn',msg:`Pause obligatoire requise aprÃ¨s ${ccn.pauseApres}h (cliquez "+ Coupure")`});
  if(!alerts.length)alerts.push({sev:'ok',msg:`âœ… Aucune infraction lÃ©gale (${ccn.label})`});
  el.innerHTML=alerts.map(a=>`<div class="alert-row ${a.sev}">${a.msg}</div>`).join('');
}

// â”€â”€ MULTI-DATES â”€â”€
function toggleMulti(open){
  _multiOpen=open;
  const panel=document.getElementById('multi-panel');
  const btn=document.getElementById('multi-toggle-btn');
  const arrow=document.getElementById('multi-arrow');
  const sub=document.getElementById('multi-toggle-sub');
  if(!panel)return;
  if(open){
    panel.classList.add('show');
    btn?.classList.add('on');
    if(arrow)arrow.style.transform='rotate(90deg)';
    if(sub)sub.textContent='Fermez pour saisie date unique';
    const dd=document.getElementById('m-deb');
    const cd=document.getElementById('cr-date')?.value;
    if(dd&&!dd.value&&cd)dd.value=cd;
    buildMultiPreview();
  } else {
    panel.classList.remove('show');
    btn?.classList.remove('on');
    if(arrow)arrow.style.transform='';
    if(sub)sub.textContent='Cliquez pour ouvrir';
    document.getElementById('multi-summary').style.display='none';
  }
}
window.toggleMulti=toggleMulti;

function getJoursFeries(year){
  const a=year%19,b=Math.floor(year/100),c=year%100;
  const d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25);
  const g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30;
  const i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7;
  const m2=Math.floor((a+11*h+22*l)/451);
  const month=Math.floor((h+l-7*m2+114)/31);
  const day=((h+l-7*m2+114)%31)+1;
  const p=new Date(year,month-1,day);
  const add=(d,n)=>{const r=new Date(d);r.setDate(r.getDate()+n);return r;};
  const iso=d=>d.toISOString().slice(0,10);
  return new Set([`${year}-01-01`,iso(add(p,1)),`${year}-05-01`,`${year}-05-08`,iso(add(p,39)),iso(add(p,50)),`${year}-07-14`,`${year}-08-15`,`${year}-11-01`,`${year}-11-11`,`${year}-12-25`]);
}

function buildMultiPreview(){
  const debStr=document.getElementById('m-deb')?.value;
  const finStr=document.getElementById('m-fin')?.value;
  const exclWE=document.getElementById('excl-we')?.checked;
  const exclFer=document.getElementById('excl-fer')?.checked;
  const exclDeja=document.getElementById('excl-deja')?.checked;
  const wrap=document.getElementById('multi-days-wrap');
  const list=document.getElementById('mday-list');
  if(!debStr||!finStr||finStr<debStr){if(wrap)wrap.style.display='none';updMultiSummary();return;}

  const deb=new Date(debStr+'T12:00:00'),fin=new Date(finStr+'T12:00:00');
  const years=new Set();
  for(let y=deb.getFullYear();y<=fin.getFullYear();y++)years.add(y);
  const feries=new Set();years.forEach(y=>getJoursFeries(y).forEach(d=>feries.add(d)));
  const JOURS=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
  const eid=document.getElementById('cr-emp')?.value;
  const days=[];
  const cur=new Date(deb);
  while(cur<=fin){
    const iso=fmt(cur);
    const dow=cur.getDay();
    const we=dow===0||dow===6;
    const fer=feries.has(iso);
    const deja=eid&&_cr[`${iso}_${eid}`]&&(_cr[`${iso}_${eid}`].items||[]).length>0;
    const autoExcl=(exclWE&&we)||(exclFer&&fer)||(exclDeja&&deja);
    days.push({iso,dow,we,fer,deja,autoExcl,lbl:JOURS[dow]});
    cur.setDate(cur.getDate()+1);
  }

  if(list)list.innerHTML=days.map((d,i)=>{
    const tag=d.we?'<span class="mday-tag tag-we">WE</span>':d.fer?'<span class="mday-tag tag-fer">FÃ©riÃ©</span>':d.deja?'<span class="mday-tag tag-deja">DÃ©jÃ  saisi</span>':'<span class="mday-tag tag-ouv">OuvrÃ©</span>';
    return `<div class="mday-row ${d.autoExcl?'off':''}" onclick="toggleDay(${i})">
      <input type="checkbox" class="mday-cb" id="mday-${i}" data-iso="${d.iso}" ${!d.autoExcl?'checked':''}/>
      <span class="mday-name">${d.lbl}</span>
      <span class="mday-date">${d.iso.split('-').reverse().join('/')}</span>
      ${tag}
    </div>`;
  }).join('');
  if(wrap)wrap.style.display='block';
  updMultiSummary();
}
window.buildMultiPreview=buildMultiPreview;

function toggleDay(i){const cb=document.getElementById(`mday-${i}`);if(cb){cb.checked=!cb.checked;updMultiSummary();}}
window.toggleDay=toggleDay;

function checkAll(v){document.querySelectorAll('.mday-cb').forEach(cb=>cb.checked=v);updMultiSummary();}
window.checkAll=checkAll;

function updMultiSummary(){
  const checked=document.querySelectorAll('.mday-cb:checked');
  const n=checked.length;
  const badge=document.getElementById('mday-count');if(badge)badge.textContent=n;
  const sum=document.getElementById('multi-summary');
  const sumN=document.getElementById('multi-sum-n');
  const sumD=document.getElementById('multi-sum-detail');
  const sumL=document.getElementById('multi-sum-label');
  if(sum){sum.style.display=n>0?'flex':'none';}
  if(sumN)sumN.textContent=n;
  if(sumL)sumL.textContent=`jour(s) de ${TYPE_LBL[_crType]||_crType}`;
  if(sumD&&n>0){
    const isos=[...checked].map(cb=>cb.dataset.iso).sort();
    sumD.textContent=isos.length===1?`Le ${isos[0].split('-').reverse().join('/')}`:
      `Du ${isos[0].split('-').reverse().join('/')} au ${isos[isos.length-1].split('-').reverse().join('/')}`;
  }
  // Bouton save
  const saveBtn=document.getElementById('save-btn');
  if(saveBtn){
    if(_multiOpen&&n>0)saveBtn.textContent=`ğŸ’¾ Enregistrer (${n} jour${n>1?'s':''})`;
    else saveBtn.textContent='ğŸ’¾ Enregistrer';
  }
}

function updMultiDur(){
  const deb=document.getElementById('mh-deb')?.value||'09:00';
  const fin=document.getElementById('mh-fin')?.value||'17:00';
  const dur=document.getElementById('mh-dur');
  if(dur)dur.textContent=fmtDur(diffH(deb,fin));
}
window.updMultiDur=updMultiDur;

// â”€â”€ RÃ‰CURRENCE â”€â”€
function onRecurChange(){
  const v=document.getElementById('cr-recur')?.value;
  const row=document.getElementById('recur-until-row');
  if(row)row.style.display=v?'block':'none';
}
document.getElementById('cr-recur')?.addEventListener('change',onRecurChange);

// â”€â”€ SAVE â”€â”€
async function saveCr(){
  const eid=document.getElementById('cr-emp')?.value;
  const type=_crType;
  const note=document.getElementById('cr-note')?.value||'';
  const showHrs=['travail','partiel','formation','astreinte'].includes(type);
  const plagesData=showHrs?_plages.filter(p=>p.deb&&p.fin):[];

  if(!eid){showToast('SÃ©lectionnez un employÃ©','warn');return;}

  // â”€â”€ MODE MULTI â”€â”€
  if(_multiOpen&&!_editId){
    const dates=[...document.querySelectorAll('.mday-cb:checked')].map(cb=>cb.dataset.iso).filter(Boolean);
    if(!dates.length){showToast('Aucun jour sÃ©lectionnÃ©','warn');return;}
    const btn=document.getElementById('save-btn');
    if(btn){btn.disabled=true;btn.textContent=`â³ 0/${dates.length}â€¦`;}
    const mDeb=document.getElementById('mh-deb')?.value||'09:00';
    const mFin=document.getElementById('mh-fin')?.value||'17:00';
    const mPlages=showHrs?[{deb:mDeb,fin:mFin}]:[];

    let saved=0;
    for(const date of dates){
      const k=`${date}_${eid}`;
      if(!_cr[k])_cr[k]={items:[]};
      const it={id:'c'+Date.now()+'_'+saved,type,deb:mPlages[0]?.deb||'',fin:mPlages[0]?.fin||'',plages:mPlages.length>0?mPlages:undefined,note};
      _cr[k].items.push(it);
      await saveKey(k,date);
      saved++;
      if(btn)btn.textContent=`â³ ${saved}/${dates.length}â€¦`;
    }

    // RÃ©currence
    const recur=document.getElementById('cr-recur')?.value;
    if(recur&&dates.length===1){await applyRecurrence(dates[0],eid,type,plagesData,note,recur);}

    closeCr();await loadCr();render();
    showToast(`âœ… ${saved} crÃ©neau(x) enregistrÃ©s`,'ok');
    return;
  }

  // â”€â”€ MODE DATE UNIQUE â”€â”€
  const date=document.getElementById('cr-date')?.value;
  if(!date){showToast('SÃ©lectionnez une date','warn');return;}
  const k=`${date}_${eid}`;
  if(!_cr[k])_cr[k]={items:[]};
  const it={id:'c'+Date.now(),type,deb:plagesData[0]?.deb||'',fin:plagesData[plagesData.length-1]?.fin||'',plages:plagesData.length>0?plagesData:undefined,note};

  if(_editId){
    const {k:ok,itemId}=_editId;
    if(ok!==k){
      _cr[ok].items=(_cr[ok].items||[]).filter(i=>i.id!==itemId);
      await saveKey(ok,ok.split('_')[0]);
      _cr[k].items.push({...it,id:itemId});
    } else {
      const idx=(_cr[k].items||[]).findIndex(i=>i.id===itemId);
      if(idx>=0)_cr[k].items[idx]={...it,id:itemId};
    }
  } else {
    _cr[k].items.push(it);
    // RÃ©currence
    const recur=document.getElementById('cr-recur')?.value;
    if(recur)await applyRecurrence(date,eid,type,plagesData,note,recur);
  }

  await saveKey(k,date);
  closeCr();await loadCr();render();
  showToast(_editId?'CrÃ©neau modifiÃ© âœ…':'CrÃ©neau ajoutÃ© âœ…','ok');
}
window.saveCr=saveCr;

async function applyRecurrence(startDate,eid,type,plages,note,recur){
  const until=document.getElementById('cr-recur-until')?.value;
  if(!until)return;
  const step=recur==='week'?7:14;
  let d=new Date(startDate+'T12:00:00');
  d.setDate(d.getDate()+step);
  const endD=new Date(until+'T12:00:00');
  while(d<=endD){
    const iso=fmt(d);
    const k=`${iso}_${eid}`;
    if(!_cr[k])_cr[k]={items:[]};
    _cr[k].items.push({id:'c'+Date.now()+Math.random().toString(36).slice(2),type,deb:plages[0]?.deb||'',fin:plages[plages.length-1]?.fin||'',plages:plages.length>0?plages:undefined,note});
    await saveKey(k,iso);
    d.setDate(d.getDate()+step);
  }
}

async function saveKey(k,date){
  try{
    const wk=weekKey(new Date((date||k.split('_')[0])+'T12:00:00'));
    await window._setDoc(window._doc(window._db,'rh',window._uid,wk,k),_cr[k]||{items:[]});
  }catch(e){console.error(e);showToast('Erreur Firebase');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POINTER-MOVE ENGINE â€” mouse + touch, sans HTML5 drag API
// Deux modes :
//   A) Gantt  : dÃ©placer une pill vers une autre cellule (changement date/employÃ©)
//   B) Timeline : glisser une barre horizontalement (dÃ©caler horaire au Â¼h)
//                 ou verticalement (changer d'employÃ©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TYPE_COLORS={
  travail:'#bbf7d0|#14532d',repos:'#f3f4f6|#6b7280',conge:'#bfdbfe|#1e3a8a',
  maladie:'#fecaca|#7f1d1d',formation:'#fde68a|#78350f',
  astreinte:'#ddd6fe|#3b0764',partiel:'#fed7aa|#7c2d12'
};

// â”€â”€ Ã‰tat global du drag â”€â”€
const _pm = {
  active:   false,
  mode:     null,   // 'gantt' | 'tl-move' | 'tl-emp'
  srcEl:    null,
  srcK:     null,
  srcId:    null,
  srcItem:  null,
  // Timeline move
  tlBwrap:  null,   // Ã©lÃ©ment .tl-bar-wrap conteneur
  tlSpan:   0,      // durÃ©e du crÃ©neau en minutes (fixe)
  tlOrigMin:0,      // dÃ©but original en minutes depuis START_H
  tlOrigX:  0,      // clientX au pointerdown
  tlStartH: 6,
  tlEndH:   23,
  // Gantt drop
  overEl:   null,
  overK:    null,
  // clic vs drag
  downX:    0,
  downY:    0,
  moved:    false,
};
const DRAG_THRESHOLD = 6; // px avant de considÃ©rer un drag

function _ghost(){ return document.getElementById('dnd-ghost'); }
function _tip(){ return document.getElementById('tl-drag-tip'); }

function _showGhost(x,y,label,bg,fg){
  const g=_ghost();
  g.style.cssText=`display:block;position:fixed;top:${y-16}px;left:${x+14}px;z-index:9999;pointer-events:none;
    padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;
    font-family:'Plus Jakarta Sans',sans-serif;background:${bg};color:${fg};
    box-shadow:0 8px 28px rgba(0,0,0,.28);white-space:nowrap;
    transform:rotate(-2deg) scale(1.05);border:2px solid rgba(255,255,255,.5);`;
  g.textContent=label;
}
function _moveGhost(x,y){
  const g=_ghost();
  g.style.left=(x+14)+'px';
  g.style.top=(y-16)+'px';
}
function _hideGhost(){
  _ghost().style.display='none';
  _tip().style.display='none';
}

function _snapQ(minutes){ return Math.round(minutes/15)*15; } // arrondi Â¼h
function _minToStr(m){
  m=Math.max(0,Math.min(23*60+59,m));
  return String(Math.floor(m/60)).padStart(2,'0')+':'+String(m%60).padStart(2,'0');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// A) GANTT â€” pointerdown sur une pill
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pmGanttDown(ev, k, id){
  if(ev.button!==undefined && ev.button!==0) return;
  ev.stopPropagation();
  const item=(_cr[k]?.items||[]).find(i=>i.id===id);
  if(!item) return;

  _pm.mode   ='gantt';
  _pm.srcEl  = ev.currentTarget;
  _pm.srcK   = k;
  _pm.srcId  = id;
  _pm.srcItem= JSON.parse(JSON.stringify(item));
  _pm.downX  = ev.clientX;
  _pm.downY  = ev.clientY;
  _pm.moved  = false;
  _pm.active = false;

  ev.currentTarget.setPointerCapture(ev.pointerId);
  ev.currentTarget.addEventListener('pointermove', _pmGanttMove);
  ev.currentTarget.addEventListener('pointerup',   _pmGanttUp);
  ev.currentTarget.addEventListener('pointercancel',_pmGanttUp);
}

function _pmGanttMove(ev){
  const dx=Math.abs(ev.clientX-_pm.downX), dy=Math.abs(ev.clientY-_pm.downY);
  if(!_pm.active && dx*dx+dy*dy < DRAG_THRESHOLD*DRAG_THRESHOLD) return;

  if(!_pm.active){
    _pm.active=true;
    _pm.srcEl.classList.add('pm-dragging');
    const item=_pm.srcItem;
    const emp=_emps.find(e=>e.id===(_pm.srcK||'').split('_')[1]);
    const plages=item.plages?.length>0?item.plages:(item.deb?[{deb:item.deb,fin:item.fin}]:[]);
    const timeTxt=plages[0]?`${plages[0].deb}â€“${plages[0].fin}`:'';
    const [bg,fg]=(TYPE_COLORS[item.type]||'#f1f5f9|#374151').split('|');
    _showGhost(ev.clientX,ev.clientY,`${TYPE_ICO[item.type]||'ğŸ“‹'} ${emp?.prenom||'?'} Â· ${timeTxt}`,bg,fg);
  }

  _moveGhost(ev.clientX, ev.clientY);

  // Trouver la cellule cible sous le pointeur
  const els=document.elementsFromPoint(ev.clientX,ev.clientY);
  const cell=els.find(el=>el.classList.contains('gd-cell')&&el.dataset.dndTargetK);
  const targetK=cell?.dataset.dndTargetK||null;

  if(targetK!==_pm.overK){
    if(_pm.overEl){_pm.overEl.classList.remove('pm-over','pm-over-emp');}
    _pm.overK=targetK;
    _pm.overEl=cell||null;
    if(cell && targetK!==_pm.srcK){
      const srcEmpId=(_pm.srcK||'').split('_')[1];
      const tgtEmpId=targetK.split('_')[1];
      cell.classList.add(srcEmpId===tgtEmpId?'pm-over':'pm-over-emp');
    }
  }
}

async function _pmGanttUp(ev){
  ev.currentTarget.removeEventListener('pointermove',_pmGanttMove);
  ev.currentTarget.removeEventListener('pointerup',_pmGanttUp);
  ev.currentTarget.removeEventListener('pointercancel',_pmGanttUp);

  if(_pm.overEl){_pm.overEl.classList.remove('pm-over','pm-over-emp');}
  _pm.srcEl.classList.remove('pm-dragging');
  _hideGhost();

  if(!_pm.active){ _pm.active=false; return; } // c'Ã©tait un clic simple
  _pm.active=false;

  const targetK=_pm.overK;
  if(!targetK||targetK===_pm.srcK){_pm.overK=null;_pm.overEl=null;return;}

  const srcK=_pm.srcK, item=_pm.srcItem, id=_pm.srcId;
  const srcDate=srcK.split('_')[0], tgtDate=targetK.split('_')[0];
  const srcEmpId=srcK.split('_')[1], tgtEmpId=targetK.split('_')[1];

  if(!_cr[srcK])_cr[srcK]={items:[]};
  _cr[srcK].items=(_cr[srcK].items||[]).filter(i=>i.id!==id);
  if(!_cr[targetK])_cr[targetK]={items:[]};
  _cr[targetK].items.push({...item});
  render();

  try{
    await Promise.all([saveKey(srcK,srcDate),saveKey(targetK,tgtDate)]);
    checkLegal();updStats();
    const srcEmp=_emps.find(e=>e.id===srcEmpId), tgtEmp=_emps.find(e=>e.id===tgtEmpId);
    const tgtFmt=new Date(tgtDate+'T12:00:00').toLocaleDateString('fr-FR',{weekday:'short',day:'numeric',month:'short'});
    _showDndToast(srcEmpId===tgtEmpId?`âœ… DÃ©placÃ© â†’ ${tgtFmt}`:`âœ… ${srcEmp?.prenom||'?'} â†’ ${tgtEmp?.prenom||'?'} (${tgtFmt})`);
  }catch(e){
    console.error(e);await loadCr();render();
    _showDndToast('âŒ Erreur sauvegarde');
  }
  _pm.overK=null;_pm.overEl=null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// B) TIMELINE â€” pointerdown sur une barre
// DÃ©placement horizontal â†’ dÃ©cale l'heure (Â¼h)
// DÃ©placement vertical >30px â†’ change d'employÃ©
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pmTlDown(ev, k, id, deb, fin){
  if(ev.button!==undefined && ev.button!==0) return;
  ev.stopPropagation();
  ev.preventDefault();

  const item=(_cr[k]?.items||[]).find(i=>i.id===id);
  if(!item) return;

  const bwrap=ev.currentTarget.closest('.tl-bar-wrap');
  if(!bwrap) return;

  const debMin=(parseInt(deb)||0)*60+(parseInt(deb.split(':')[1])||0);
  const finMin=(parseInt(fin)||0)*60+(parseInt(fin.split(':')[1])||0);

  _pm.mode     ='tl-move';
  _pm.srcEl    = ev.currentTarget;
  _pm.srcK     = k;
  _pm.srcId    = id;
  _pm.srcItem  = JSON.parse(JSON.stringify(item));
  _pm.tlBwrap  = bwrap;
  _pm.tlSpan   = finMin-debMin;          // durÃ©e fixe
  _pm.tlOrigMin= debMin;                 // dÃ©but original
  _pm.tlOrigX  = ev.clientX;
  _pm.tlStartH = 6;
  _pm.tlEndH   = 23;
  _pm.downX    = ev.clientX;
  _pm.downY    = ev.clientY;
  _pm.moved    = false;
  _pm.active   = false;
  _pm.overEl   = null;
  _pm.overK    = null;

  ev.currentTarget.setPointerCapture(ev.pointerId);
  ev.currentTarget.addEventListener('pointermove',_pmTlMove);
  ev.currentTarget.addEventListener('pointerup',  _pmTlUp);
  ev.currentTarget.addEventListener('pointercancel',_pmTlUp);
}

function _pmTlMove(ev){
  const dx=ev.clientX-_pm.downX, dy=ev.clientY-_pm.downY;
  const dist=Math.sqrt(dx*dx+dy*dy);
  if(!_pm.active && dist < DRAG_THRESHOLD) return;

  if(!_pm.active){
    _pm.active=true;
    _pm.srcEl.classList.add('pm-dragging');
    const item=_pm.srcItem;
    const [bg,fg]=(TYPE_COLORS[item.type]||'#f1f5f9|#374151').split('|');
    const emp=_emps.find(e=>e.id===(_pm.srcK||'').split('_')[1]);
    _showGhost(ev.clientX,ev.clientY,`${TYPE_ICO[item.type]||'ğŸ“‹'} ${emp?.prenom||'?'}`,bg,fg);
  }

  // â”€â”€ Calcul dÃ©placement horizontal â†’ nouvelle heure â”€â”€
  const bwrap=_pm.tlBwrap;
  const rect=bwrap.getBoundingClientRect();
  const spanTot=(_pm.tlEndH-_pm.tlStartH)*60; // minutes total affichÃ©
  const pxToMin=(ev.clientX-_pm.tlOrigX)/rect.width*spanTot;
  let newDebMin=_snapQ(_pm.tlOrigMin+pxToMin);
  // Bornes
  newDebMin=Math.max(_pm.tlStartH*60, Math.min((_pm.tlEndH*60)-_pm.tlSpan, newDebMin));
  const newFinMin=newDebMin+_pm.tlSpan;
  const newDeb=_minToStr(newDebMin);
  const newFin=_minToStr(newFinMin);

  // Mettre Ã  jour visuellement la barre en live
  const pct=(m)=>Math.max(0,Math.min(100,(m-_pm.tlStartH*60)/spanTot*100));
  _pm.srcEl.style.left=pct(newDebMin)+'%';
  _pm.srcEl.style.width=Math.max(pct(newFinMin)-pct(newDebMin),1.5)+'%';
  const span=_pm.srcEl.querySelector('span');
  if(span)span.textContent=`${newDeb}â€“${newFin}`;

  // Tooltip heure
  const tip=_tip();
  tip.style.cssText=`display:block;position:fixed;top:${ev.clientY-34}px;left:${ev.clientX}px;z-index:9999;pointer-events:none;
    background:#1e293b;color:white;padding:3px 8px;border-radius:5px;
    font-size:11px;font-weight:700;font-family:'Plus Jakarta Sans',sans-serif;transform:translateX(-50%)`;
  tip.textContent=`${newDeb} â€“ ${newFin}`;

  _moveGhost(ev.clientX, ev.clientY);

  // â”€â”€ DÃ©placement vertical â†’ changer d'employÃ© â”€â”€
  const absDy=Math.abs(dy);
  if(absDy>28){
    const els=document.elementsFromPoint(ev.clientX,ev.clientY);
    const row=els.find(el=>el.classList.contains('tl-row')&&el.dataset.dndTargetK);
    const targetK=row?.dataset.dndTargetK||null;
    if(targetK!==_pm.overK){
      if(_pm.overEl){_pm.overEl.classList.remove('pm-over','pm-over-emp');}
      _pm.overK=targetK;
      _pm.overEl=row||null;
      if(row && targetK!==_pm.srcK){
        const srcEmpId=(_pm.srcK||'').split('_')[1];
        const tgtEmpId=targetK.split('_')[1];
        row.classList.add(srcEmpId===tgtEmpId?'pm-over':'pm-over-emp');
      }
    }
  }
}

async function _pmTlUp(ev){
  ev.currentTarget.removeEventListener('pointermove',_pmTlMove);
  ev.currentTarget.removeEventListener('pointerup',_pmTlUp);
  ev.currentTarget.removeEventListener('pointercancel',_pmTlUp);

  if(_pm.overEl){_pm.overEl.classList.remove('pm-over','pm-over-emp');}
  _pm.srcEl.classList.remove('pm-dragging');
  _hideGhost();

  if(!_pm.active){ _pm.active=false; return; } // clic simple â†’ editCr
  _pm.active=false;

  // â”€â”€ Calculer la nouvelle heure â”€â”€
  const bwrap=_pm.tlBwrap;
  const rect=bwrap.getBoundingClientRect();
  const spanTot=(_pm.tlEndH-_pm.tlStartH)*60;
  const pxToMin=(ev.clientX-_pm.tlOrigX)/rect.width*spanTot;
  let newDebMin=_snapQ(_pm.tlOrigMin+pxToMin);
  newDebMin=Math.max(_pm.tlStartH*60, Math.min((_pm.tlEndH*60)-_pm.tlSpan, newDebMin));
  const newFinMin=newDebMin+_pm.tlSpan;
  const newDeb=_minToStr(newDebMin);
  const newFin=_minToStr(newFinMin);

  const srcK=_pm.srcK, srcId=_pm.srcId;
  const targetK=_pm.overK; // null = mÃªme ligne, juste dÃ©calage horaire
  const finalK = targetK||srcK;
  const srcDate=srcK.split('_')[0];
  const finalDate=finalK.split('_')[0];

  // Mise Ã  jour de l'item dans _cr
  const destK=finalK;
  if(!_cr[destK])_cr[destK]={items:[]};

  // Trouver et modifier l'item
  const modItem = JSON.parse(JSON.stringify(_pm.srcItem));
  // Mettre Ã  jour toutes les plages en dÃ©calant
  const origDebMin=_pm.tlOrigMin;
  const delta=newDebMin-origDebMin;
  if(modItem.plages&&modItem.plages.length>0){
    modItem.plages=modItem.plages.map(p=>{
      const [ph,pm2]=p.deb.split(':').map(Number);
      const [fh2,fm2]=p.fin.split(':').map(Number);
      const pDebMin=ph*60+pm2+delta;
      const pFinMin=fh2*60+fm2+delta;
      return {deb:_minToStr(pDebMin),fin:_minToStr(pFinMin)};
    });
    modItem.deb=modItem.plages[0].deb;
    modItem.fin=modItem.plages[modItem.plages.length-1].fin;
  } else {
    modItem.deb=newDeb;
    modItem.fin=newFin;
  }

  if(destK!==srcK){
    // Changement d'employÃ© : retirer de srcK
    _cr[srcK].items=(_cr[srcK].items||[]).filter(i=>i.id!==srcId);
    _cr[destK].items.push(modItem);
  } else {
    // MÃªme ligne : juste modifier
    const idx=(_cr[srcK].items||[]).findIndex(i=>i.id===srcId);
    if(idx>=0)_cr[srcK].items[idx]=modItem;
  }

  render();

  try{
    const saves=[saveKey(srcK,srcDate)];
    if(destK!==srcK) saves.push(saveKey(destK,finalDate));
    await Promise.all(saves);
    checkLegal();updStats();
    const srcEmpId=srcK.split('_')[1], tgtEmpId=finalK.split('_')[1];
    if(srcEmpId!==tgtEmpId){
      const srcEmp=_emps.find(e=>e.id===srcEmpId),tgtEmp=_emps.find(e=>e.id===tgtEmpId);
      _showDndToast(`âœ… ${srcEmp?.prenom||'?'} â†’ ${tgtEmp?.prenom||'?'}`);
    } else {
      _showDndToast(`âœ… DÃ©placÃ© : ${newDeb}â€“${newFin}`);
    }
  }catch(e){
    console.error(e);await loadCr();render();
    _showDndToast('âŒ Erreur sauvegarde');
  }
  _pm.overK=null;_pm.overEl=null;
}

function _showDndToast(msg){
  const el=document.getElementById('dnd-toast');
  if(!el)return;
  el.textContent=msg;el.classList.add('show');
  clearTimeout(el._t);el._t=setTimeout(()=>el.classList.remove('show'),2800);
}

window.pmGanttDown=pmGanttDown;
window.pmTlDown=pmTlDown;
// CompatibilitÃ© anciens appels (ne font plus rien de dangereux)
function dndStart(){}function dndEnd(){}function dndOver(){}function dndLeave(){}function dndDrop(){}
window.dndStart=dndStart;window.dndEnd=dndEnd;window.dndOver=dndOver;window.dndLeave=dndLeave;window.dndDrop=dndDrop;

// â”€â”€ EDIT / DEL â”€â”€
function editCr(k,itemId){
  const items=(_cr[k]?.items||[]);
  const it=items.find(i=>i.id===itemId);
  if(!it)return;
  _editId={k,itemId};
  const[date,eid]=k.split('_');
  document.getElementById('cr-title').textContent='âœï¸ Modifier le crÃ©neau';
  document.getElementById('cr-del').style.display='block';
  document.getElementById('cr-emp').value=eid;
  document.getElementById('cr-date').value=date;
  document.getElementById('cr-note').value=it.note||'';
  _plages=it.plages?JSON.parse(JSON.stringify(it.plages)):[{deb:it.deb||'09:00',fin:it.fin||'17:00'}];
  setType(it.type||'travail',document.querySelector(`.type-btn[data-type="${it.type||'travail'}"]`));
  toggleMulti(false);
  onEmpChange();
  renderPresets();
  renderPlages();
  document.getElementById('modalCr').classList.add('show');
}
window.editCr=editCr;

async function delCr(){
  if(!_editId)return;
  const{k,itemId}=_editId;
  _cr[k].items=(_cr[k].items||[]).filter(i=>i.id!==itemId);
  await saveKey(k,k.split('_')[0]);
  closeCr();await loadCr();render();showToast('CrÃ©neau supprimÃ©');
}
window.delCr=delCr;

async function qDel(k,id){
  if(!_cr[k])return;
  _cr[k].items=(_cr[k].items||[]).filter(i=>i.id!==id);
  await saveKey(k,k.split('_')[0]);
  await loadCr();render();showToast('SupprimÃ©');
}
window.qDel=qDel;

// â”€â”€ IA â”€â”€
function openAI(){
  document.getElementById('ai-period-label').textContent=document.getElementById('week-label').textContent;
  document.getElementById('ai-res-wrap').style.display='none';
  document.getElementById('ai-apply-btn').style.display='none';
  _aiResult=null;
  document.getElementById('modalAI').classList.add('show');
}
window.openAI=openAI;
function closeAI(){document.getElementById('modalAI').classList.remove('show');}
window.closeAI=closeAI;

async function genAI(){
  const btn=document.getElementById('ai-gen-btn');
  btn.disabled=true;btn.textContent='â³â€¦';
  const days=_view==='mois'?[...Array(7)].map((_,i)=>{const d=new Date(_cur);d.setDate(1+i);return d;}):weekDays(_cur);

  const empStr=_emps.map(e=>{
    const comps=(e.competences||[]).map(c=>c.nom||c).join(', ');
    return `- ${e.prenom||''} ${e.nom||''} (${e.typeContrat||'CDI'}, ${e.heuresHebdo||35}h/sem, poste: ${e.poste||'non prÃ©cisÃ©'}${comps?', compÃ©tences: '+comps:''}, CCN: ${getCCN(e).label})`;
  }).join('\n');

  const prompt=`Tu es un assistant RH expert en planification. GÃ©nÃ¨re un planning optimisÃ© pour la pÃ©riode du ${days[0].toLocaleDateString('fr-FR')} au ${days[days.length-1].toLocaleDateString('fr-FR',{year:'numeric'})}.

Ã‰QUIPE :
${empStr||'Aucun employÃ© renseignÃ©'}

CONTRAINTES :
- Horaires d'activitÃ© : ${document.getElementById('ai-op').value} â†’ ${document.getElementById('ai-cl').value}
- Minimum ${document.getElementById('ai-ms').value} personne(s) par shift
- ${document.getElementById('ai-rd').value} jour(s) de repos par semaine par employÃ©
- Respecter les durÃ©es contractuelles
- Respecter les CCN (repos 11h inter-shift, pauses obligatoires)
- Prendre en compte les compÃ©tences pour la polyvalence
${document.getElementById('ai-inst').value?'\nINSTRUCTIONS SPÃ‰CIFIQUES :\n'+document.getElementById('ai-inst').value:''}

RÃ©ponds UNIQUEMENT en JSON valide sans markdown :
{"planning":[{"nom":"PrÃ©nom Nom","semaine":[{"jour":"lundi","date":"YYYY-MM-DD","type":"travail","deb":"HH:MM","fin":"HH:MM","note":"poste"},{"jour":"mardi","date":"YYYY-MM-DD","type":"repos"}]}],"resume":"rÃ©sumÃ© en 1 phrase","conseils":["conseil 1","conseil 2"]}`;

  const wrap=document.getElementById('ai-res-wrap');
  const box=document.getElementById('ai-res-content');
  wrap.style.display='block';
  box.innerHTML=`<div class="ai-think"><div class="ai-d"></div><div class="ai-d"></div><div class="ai-d"></div><span style="margin-left:8px">Analyse de l'Ã©quipe et gÃ©nÃ©ration du planningâ€¦</span></div>`;

  try{
    const res=await fetch('/api/rh-planning-ai',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt,max_tokens:3000})});
    if(!res.ok){const err=await res.json().catch(()=>({}));throw new Error(err.error||'Erreur serveur '+res.status);}
    const data=await res.json();
    const raw=(data.text||'').replace(/```json|```/g,'').trim();
    _aiResult=JSON.parse(raw);
    const TC={travail:'#dcfce7',repos:'#f3f4f6',conge:'#dbeafe',maladie:'#fee2e2',formation:'#fef3c7',astreinte:'#ede9fe'};
    const TT={travail:'#166534',repos:'#6b7280',conge:'#1e40af',maladie:'#991b1b',formation:'#92400e',astreinte:'#5b21b6'};

    let h=_aiResult.resume?`<div style="font-size:11px;color:rgba(255,255,255,.65);margin-bottom:10px;padding:8px 10px;background:rgba(255,255,255,.07);border-radius:6px">ğŸ“Š ${_aiResult.resume}</div>`:'';
    if(_aiResult.conseils?.length){
      h+=`<div style="margin-bottom:10px">${(_aiResult.conseils||[]).map(c=>`<div style="font-size:10px;color:rgba(255,255,255,.5);padding:3px 0">ğŸ’¡ ${c}</div>`).join('')}</div>`;
    }
    (_aiResult.planning||[]).forEach(ep=>{
      h+=`<div class="ai-emp-row"><div class="ai-emp-n">${ep.nom}</div><div class="ai-shifts">
        ${(ep.semaine||[]).map(s=>`<div class="ai-sp" style="background:${TC[s.type]||'#f3f4f6'};color:${TT[s.type]||'#374151'}" title="${s.jour} â€” ${s.type==='travail'?s.deb+'â†’'+s.fin:s.type}">${(s.jour||'').slice(0,2).toUpperCase()} ${s.type==='travail'?(s.deb+'â€“'+s.fin):s.type.slice(0,3).toUpperCase()}</div>`).join('')}
      </div></div>`;
    });
    box.innerHTML=h;
    document.getElementById('ai-apply-btn').style.display='block';
  }catch(e){box.innerHTML=`<div style="color:#f87171;font-size:12px">âŒ Erreur : ${e.message}. RÃ©essayez.</div>`;}
  btn.disabled=false;btn.textContent='âœ¨ RegÃ©nÃ©rer';
}
window.genAI=genAI;

async function applyAI(){
  if(!_aiResult)return;
  const btn=document.getElementById('ai-apply-btn');btn.textContent='â³â€¦';btn.disabled=true;
  let count=0;
  for(const ep of (_aiResult.planning||[])){
    const emp=_emps.find(e=>`${e.prenom||''} ${e.nom||''}`.trim()===ep.nom?.trim());
    if(!emp)continue;
    for(const s of (ep.semaine||[])){
      if(!s.date||s.type==='repos')continue;
      const k=`${s.date}_${emp.id}`;
      if(!_cr[k])_cr[k]={items:[]};
      _cr[k].items.push({id:'ai'+Date.now()+Math.random().toString(36).slice(2),type:s.type||'travail',deb:s.deb||'',fin:s.fin||'',note:s.note||''});
      await saveKey(k,s.date);count++;
    }
  }
  closeAI();await loadCr();render();showToast(`âœ… ${count} crÃ©neau(x) appliquÃ©s`,'ok');
}
window.applyAI=applyAI;

// â”€â”€ POLYVALENCE â”€â”€
function openPolyPanel(){
  const grid=document.getElementById('poly-grid-content');
  const matrix=document.getElementById('poly-matrix');
  if(!grid||!matrix)return;

  // Collecter tous les postes/compÃ©tences
  const postes=new Set();
  _emps.forEach(e=>(e.competences||[]).forEach(c=>postes.add(c.nom||c)));
  const postesList=[...postes].sort();

  // Cartes employÃ©s
  grid.innerHTML=_emps.map((e,i)=>{
    const cc=COLS[i%COLS.length];
    const comps=e.competences||[];
    const contrat=e.typeContrat||'CDI';
    const hebb=e.heuresHebdo||35;
    return `<div class="poly-emp-card">
      <div class="poly-emp-name">
        <div class="${cc} ge-av" style="width:26px;height:26px;font-size:10px">${(e.prenom||'?')[0]}${(e.nom||'')[0]||''}</div>
        ${e.prenom||''} ${e.nom||''}
        <span style="font-size:9px;font-weight:600;color:var(--muted);margin-left:4px">${contrat}Â·${hebb}h</span>
      </div>
      ${comps.length?`<div class="poly-comp-list">${comps.map(c=>`<div class="poly-comp-row">
        <span class="poly-comp-name">${c.nom||c}</span>
        <div class="poly-stars">${[1,2,3,4,5].map(n=>`<span class="poly-star ${(c.niveau||3)>=n?'on':''}">â˜…</span>`).join('')}</div>
      </div>`).join('')}</div>`
      :`<div style="font-size:11px;color:var(--muted);font-style:italic">Aucune compÃ©tence renseignÃ©e</div>`}
      <div class="poly-avail-bar" title="DisponibilitÃ© contractuelle"><div class="poly-avail-fill" style="width:${Math.min(hebb/40*100,100)}%"></div></div>
    </div>`;
  }).join('');

  // Matrice
  if(postesList.length>0){
    matrix.innerHTML=`<table style="border-collapse:collapse;font-size:11px;width:100%">
      <thead><tr>
        <th style="padding:6px 10px;text-align:left;border-bottom:1px solid var(--border);font-weight:700;color:var(--muted)">Poste</th>
        ${_emps.map(e=>`<th style="padding:6px 8px;text-align:center;border-bottom:1px solid var(--border);font-weight:700;color:var(--text);white-space:nowrap;font-size:10px">${e.prenom||''}</th>`).join('')}
        <th style="padding:6px 8px;text-align:center;border-bottom:1px solid var(--border);font-weight:700;color:var(--muted)">Couverture</th>
      </tr></thead>
      <tbody>${postesList.map(poste=>{
        const coverage=_emps.filter(e=>(e.competences||[]).some(c=>(c.nom||c)===poste));
        return `<tr>
          <td style="padding:7px 10px;font-weight:600;border-bottom:1px solid #f1f5f9">${poste}</td>
          ${_emps.map(e=>{
            const comp=(e.competences||[]).find(c=>(c.nom||c)===poste);
            return `<td style="text-align:center;padding:7px 8px;border-bottom:1px solid #f1f5f9">${comp?`<span style="color:${comp.niveau>=4?'var(--rh-main)':comp.niveau>=3?'var(--orange)':'var(--muted)'}">â˜…${comp.niveau||3}</span>`:'<span style="color:#e5e7eb">â€”</span>'}</td>`;
          }).join('')}
          <td style="text-align:center;padding:7px 8px;border-bottom:1px solid #f1f5f9">
            <span style="background:${coverage.length>=3?'#dcfce7':coverage.length>=2?'#fef3c7':'#fee2e2'};color:${coverage.length>=3?'#166534':coverage.length>=2?'#92400e':'#991b1b'};padding:2px 7px;border-radius:4px;font-weight:700;font-size:10px">${coverage.length} emp.</span>
          </td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  } else {
    matrix.innerHTML=`<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">Renseignez des compÃ©tences dans les fiches employÃ©s pour afficher la matrice.</div>`;
  }

  document.getElementById('modalPoly').classList.add('show');
}
window.openPolyPanel=openPolyPanel;
function closePoly(){document.getElementById('modalPoly').classList.remove('show');}
window.closePoly=closePoly;

// â”€â”€ EXPORT â”€â”€
function exportPDF(){
  const days=_view==='mois'?[...Array(7)].map((_,i)=>{const d=new Date(_cur);d.setDate(1+i);return d;}):weekDays(_cur);
  const vis=visibleEmps();
  let rows='';
  vis.forEach(e=>{
    rows+=`<tr><td style="font-weight:700;padding:6px 8px;border:1px solid #e2e8f0;background:#f8faff;white-space:nowrap">${e.prenom||''} ${e.nom||''}</td>`;
    days.forEach(d=>{
      const k=`${fmt(d)}_${e.id}`;
      const items=(_cr[k]?.items||[]);
      const txt=items.map(it=>{
        const plages=it.plages&&it.plages.length>0?it.plages:[{deb:it.deb,fin:it.fin}];
        const h=plages.reduce((s,p)=>s+diffH(p.deb,p.fin),0);
        if(it.type==='travail'||it.type==='partiel')return plages.map(p=>`${p.deb}â€“${p.fin}`).join('|')+(h>0?' '+fmtDur(h):'');
        return TYPE_LBL[it.type]||it.type;
      }).join('<br>');
      rows+=`<td style="padding:6px 8px;border:1px solid #e2e8f0;font-size:10px;min-width:60px">${txt||'â€”'}</td>`;
    });
    rows+=`</tr>`;
  });
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Planning RH</title>
  <style>body{font-family:sans-serif;padding:16px;font-size:12px}h1{font-size:16px;font-weight:800;color:#052e16;margin-bottom:3px}p{color:#6b7280;font-size:11px;margin-bottom:12px}table{width:100%;border-collapse:collapse}th{padding:6px 8px;background:#059669;color:white;font-size:10px;font-weight:700;border:1px solid #047857;text-align:left}@media print{@page{margin:.6cm;size:A4 landscape}}</style>
  </head><body>
  <h1>ğŸ“… Planning RH â€” ${document.getElementById('week-label').textContent}</h1>
  <p>ALTEORE Â· ${new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'})}</p>
  <table><thead><tr><th>EmployÃ©</th>${days.map(d=>`<th>${d.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric',month:'short'})}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table>
  <script>window.onload=()=>window.print()<\/script></body></html>`);
  w.document.close();
}
window.exportPDF=exportPDF;

// â”€â”€ UTILS â”€â”€
function showToast(m,t=''){const el=document.getElementById('toast');el.textContent=m;el.className='toast show '+(t||'');setTimeout(()=>el.className='toast',3200);}
function toggleMobileNav(){
  document.getElementById('sidebar')?.classList.toggle('open');
  document.getElementById('hamburger')?.classList.toggle('open');
  document.getElementById('navOverlay')?.classList.toggle('show');
}
async function handleLogout(){await window._signOut(window._auth);location.href='index.html';}
window.handleLogout=handleLogout;
window.toggleMobileNav=toggleMobileNav;
window.updLiveAlerts=updLiveAlerts;
</script>
<script src="nav.js"></script>
<script>
(function openRhNav(){
  var tries=0;
  var t=setInterval(function(){
    var sub=document.getElementById('rh-nav-sub');
    var nav=document.getElementById('alteore-nav');
    if(sub&&nav){clearInterval(t);sub.style.maxHeight='2000px';nav.classList.add('rh-mode');}
    if(++tries>50)clearInterval(t);
  },50);
})();
</script>
</body>
</html>
