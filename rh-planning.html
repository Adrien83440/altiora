<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>ALTEORE â€” Planning RH Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --rh-dark:#052e16;--rh-main:#059669;--rh-mid:#10b981;--rh-bright:#34d399;
  --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
  --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f0fdf7;--sidebar-w:252px;--radius:12px;
  --green:#10b981;--orange:#f59e0b;--red:#ef4444;--blue:#3b82f6;--purple:#6366f1;
  --t-travail:#dcfce7;--tc-travail:#166534;
  --t-repos:#f3f4f6;--tc-repos:#6b7280;
  --t-conge:#dbeafe;--tc-conge:#1e40af;
  --t-maladie:#fee2e2;--tc-maladie:#991b1b;
  --t-formation:#fef3c7;--tc-formation:#92400e;
  --t-astreinte:#ede9fe;--tc-astreinte:#5b21b6;
  --t-partiel:#fff7ed;--tc-partiel:#c2410c;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}
.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden;}

/* TOPBAR */
.topbar{background:white;border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;gap:8px;flex-wrap:wrap;}
.topbar-left h1{font-size:16px;font-weight:700;}
.topbar-left p{font-size:11px;color:var(--muted);}
.topbar-right{display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.18s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap;}
.btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-mid));color:white;box-shadow:0 2px 8px rgba(5,150,105,.25);}
.btn-rh:hover{opacity:.9;transform:translateY(-1px);}
.btn-outline{background:white;color:var(--text);border:1.5px solid var(--border);}
.btn-outline:hover{border-color:var(--rh-main);color:var(--rh-main);}
.btn-ai{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;box-shadow:0 2px 8px rgba(99,102,241,0.3);}
.btn-ai:hover{opacity:0.9;}
.btn-sm{padding:5px 11px;font-size:11px;}
.btn-xs{padding:3px 8px;font-size:10px;}
.btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}

/* PLAN NAV */
.plan-nav{background:white;border-bottom:1px solid var(--border);padding:0 20px;display:flex;align-items:center;gap:0;position:sticky;top:57px;z-index:40;flex-wrap:wrap;}
.plan-nav-week{display:flex;align-items:center;gap:6px;padding:8px 0;flex:1;min-width:180px;}
.wnav-btn{width:28px;height:28px;border:1.5px solid var(--border);border-radius:6px;background:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .15s;}
.wnav-btn:hover{border-color:var(--rh-main);color:var(--rh-main);}
.week-label{font-size:13px;font-weight:700;color:var(--text);min-width:160px;text-align:center;}
.today-btn{font-size:10px;font-weight:700;padding:3px 9px;border:1.5px solid var(--rh-border);border-radius:6px;background:var(--rh-ghost);color:var(--rh-main);cursor:pointer;}
.view-tabs{display:flex;gap:1px;padding:6px 0;}
.vtab{padding:5px 11px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;color:var(--muted);border:none;background:transparent;transition:all .15s;}
.vtab.active{background:var(--rh-ghost);color:var(--rh-main);}
.disp-tabs{display:flex;gap:1px;padding:6px 0;border-left:1px solid var(--border);margin-left:6px;padding-left:10px;}
.dtab{padding:5px 9px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;color:var(--muted);border:none;background:transparent;transition:all .15s;}
.dtab.active{background:#e0f2fe;color:#0369a1;}
.filter-sep{width:1px;height:24px;background:var(--border);margin:0 6px;}

/* STATS BAR */
.stats-bar{background:white;border-bottom:1px solid var(--border);padding:7px 20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;overflow-x:auto;}
.sitem{display:flex;align-items:center;gap:5px;font-size:11px;flex-shrink:0;}
.sdot{width:8px;height:8px;border-radius:50%;}
.sval{font-weight:700;}
.slbl{color:var(--muted);}
.infr-badge{background:#fef2f2;color:#dc2626;border:1px solid #fecaca;border-radius:6px;padding:2px 8px;font-size:10px;font-weight:700;cursor:pointer;margin-left:auto;}
.infr-badge:hover{background:#fee2e2;}

/* EMP LEGEND */
.emp-legend{background:white;border-bottom:1px solid var(--border);padding:7px 20px;display:flex;align-items:center;gap:6px;overflow-x:auto;}
.emp-legend::-webkit-scrollbar{height:2px;}
.leg-item{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600;color:var(--text);cursor:pointer;padding:3px 8px;border-radius:16px;border:1.5px solid var(--border);background:white;flex-shrink:0;transition:all .15s;}
.leg-item:hover{border-color:var(--rh-main);}
.leg-item.hidden{opacity:.3;}
.leg-item.active-filter{border-color:var(--rh-main);background:var(--rh-ghost);}
.leg-dot{width:8px;height:8px;border-radius:3px;flex-shrink:0;}
.leg-skills{font-size:9px;color:var(--muted);margin-left:2px;}

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘   PLANNING MENSUEL â€” GANTT HORIZONTAL   â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.plan-content{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;}

/* â• GANTT MOIS â• */
.gantt-wrap{min-width:1000px;}
.gantt-head{display:grid;background:white;border-bottom:2px solid var(--border);position:sticky;top:0;z-index:10;}
.gh-emp{padding:10px 14px;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;border-right:1px solid var(--border);display:flex;align-items:center;gap:6px;}
.gh-day{padding:5px 2px;text-align:center;border-right:1px solid var(--border);min-width:0;}
.gh-dname{font-size:8px;font-weight:700;color:var(--muted);text-transform:uppercase;}
.gh-dnum{font-size:13px;font-weight:800;line-height:1.2;}
.gh-day.today{background:var(--rh-ghost);}
.gh-day.today .gh-dnum{color:var(--rh-main);}
.gh-day.we{background:#fafafa;}
.gh-day.we .gh-dnum{color:#d1d5db;}
.gantt-row{display:grid;border-bottom:1px solid var(--border);min-height:52px;background:white;transition:background .1s;}
.gantt-row:hover{background:#fafffe;}
.ge-cell{padding:8px 12px;border-right:1px solid var(--border);display:flex;align-items:center;gap:7px;position:sticky;left:0;background:inherit;z-index:5;}
.ge-av{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white;flex-shrink:0;}
.ge-info{min-width:0;}
.ge-name{font-size:11px;font-weight:700;line-height:1.3;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ge-meta{font-size:9px;color:var(--muted);display:flex;align-items:center;gap:4px;flex-wrap:wrap;}
.ge-hbadge{background:var(--rh-ghost);color:var(--rh-main);padding:1px 5px;border-radius:4px;font-weight:700;font-size:9px;}
.ge-alert{background:#fef2f2;color:#dc2626;padding:1px 5px;border-radius:4px;font-weight:700;font-size:9px;}
.gd-cell{border-right:1px solid var(--border);padding:3px;cursor:pointer;min-height:52px;position:relative;transition:background .12s;display:flex;flex-direction:column;gap:2px;align-items:stretch;}
.gd-cell:hover{background:#f0fdf4;}
.gd-cell.today{background:#f7fff9;}
.gd-cell.we{background:#f9fafb;}
.gd-cell.we:hover{background:#f3f9f3;}

/* PILL */
.cr-pill{border-radius:5px;padding:3px 6px;cursor:pointer;transition:all .12s;position:relative;overflow:hidden;}
.cr-pill:hover{filter:brightness(.94);transform:translateY(-1px);box-shadow:0 2px 6px rgba(0,0,0,0.08);}
.cr-time{font-size:9px;font-weight:700;line-height:1.2;}
.cr-lbl{font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.cr-x{position:absolute;top:2px;right:3px;font-size:9px;opacity:0;cursor:pointer;background:rgba(0,0,0,0.15);border-radius:2px;width:12px;height:12px;display:flex;align-items:center;justify-content:center;}
.cr-pill:hover .cr-x{opacity:1;}
.add-hint{display:flex;align-items:center;justify-content:center;margin-top:auto;height:16px;font-size:12px;color:var(--rh-main);opacity:0;transition:opacity .15s;}
.gd-cell:hover .add-hint{opacity:1;}
.pill-sep{font-size:8px;color:rgba(0,0,0,.3);text-align:center;line-height:1;}

/* TYPE COLORS */
.t-travail{background:var(--t-travail);color:var(--tc-travail);}
.t-repos{background:var(--t-repos);color:var(--tc-repos);}
.t-conge{background:var(--t-conge);color:var(--tc-conge);}
.t-maladie{background:var(--t-maladie);color:var(--tc-maladie);}
.t-formation{background:var(--t-formation);color:var(--tc-formation);}
.t-astreinte{background:var(--t-astreinte);color:var(--tc-astreinte);}
.t-partiel{background:var(--t-partiel);color:var(--tc-partiel);}

/* COULEURS EMP */
.c0{background:#059669;}.c1{background:#3b82f6;}.c2{background:#8b5cf6;}
.c3{background:#f59e0b;}.c4{background:#ef4444;}.c5{background:#14b8a6;}
.c6{background:#f97316;}.c7{background:#6366f1;}.c8{background:#10b981;}.c9{background:#0ea5e9;}

/* POLYVALENCE BADGE */
.poly-badge{display:inline-flex;align-items:center;gap:2px;font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px;background:#fef3c7;color:#92400e;}

/* â• VUE SEMAINE TIMELINE (Shift view) â• */
.timeline-wrap{padding:16px 20px;min-width:900px;}
.timeline-head{display:flex;gap:0;margin-bottom:0;border-bottom:2px solid var(--border);background:white;position:sticky;top:0;z-index:5;}
.tl-emp-col{width:160px;flex-shrink:0;padding:8px 12px;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;}
.tl-hours{flex:1;display:flex;position:relative;overflow:hidden;}
.tl-hour{flex:1;text-align:center;font-size:10px;font-weight:600;color:var(--muted);padding:8px 0;border-left:1px solid var(--border);}
.tl-row{display:flex;border-bottom:1px solid var(--border);min-height:50px;background:white;}
.tl-row:hover{background:#fafffe;}
.tl-emp{width:160px;flex-shrink:0;padding:8px 12px;display:flex;align-items:center;gap:7px;position:sticky;left:0;background:inherit;z-index:2;}
.tl-bar-wrap{flex:1;position:relative;display:flex;align-items:center;}
.tl-grid-line{position:absolute;top:0;bottom:0;width:1px;background:var(--border);}
.tl-shift-bar{position:absolute;height:32px;top:50%;transform:translateY(-50%);border-radius:6px;padding:2px 6px;display:flex;flex-direction:column;justify-content:center;cursor:pointer;transition:all .12s;font-size:9px;font-weight:700;z-index:3;overflow:hidden;white-space:nowrap;}
.tl-shift-bar:hover{filter:brightness(.92);z-index:4;box-shadow:0 3px 10px rgba(0,0,0,0.12);}
.tl-now{position:absolute;top:0;bottom:0;width:2px;background:#ef4444;z-index:4;}
.tl-now::before{content:'';position:absolute;top:-4px;left:-4px;width:10px;height:10px;background:#ef4444;border-radius:50%;}

/* â• VUE MOIS CALENDRIER â• */
.month-wrap{padding:0;}
.month-grid{display:grid;grid-template-columns:repeat(7,1fr);border-left:1px solid var(--border);border-top:1px solid var(--border);}
.m-dhead{padding:7px;text-align:center;font-size:10px;font-weight:700;color:var(--muted);background:#f8faff;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.m-cell{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:5px;min-height:90px;cursor:pointer;transition:background .12s;position:relative;vertical-align:top;}
.m-cell:hover{background:#f0fdf4;}
.m-cell.m-today{background:#f0fdf9;}
.m-cell.m-other .m-dnum{color:#d1d5db;}
.m-cell.m-other{background:#fafafa;}
.m-cell.m-we{background:#f9fafb;}
.m-cell.m-ferme{background:repeating-linear-gradient(135deg,#fff1f2,#fff1f2 6px,#fafafa 6px,#fafafa 12px)!important;opacity:.78;}
.m-cell.m-ferme .m-dnum{color:#fca5a5;}
.m-ferme-badge{position:absolute;bottom:3px;right:3px;font-size:7px;font-weight:700;color:#ef4444;background:#fee2e2;padding:1px 4px;border-radius:3px;letter-spacing:.3px;}
.m-dnum{font-size:12px;font-weight:700;margin-bottom:3px;}
.m-dnum-circle{background:var(--rh-main);color:white;border-radius:50%;width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;font-size:11px;}
.m-pill{font-size:8px;font-weight:700;padding:2px 5px;border-radius:4px;margin-bottom:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;display:flex;align-items:center;gap:2px;}
.m-more{font-size:9px;color:var(--muted);font-weight:600;}
.m-total-badge{position:absolute;top:4px;right:4px;font-size:8px;font-weight:800;color:var(--rh-main);background:var(--rh-ghost);padding:1px 4px;border-radius:4px;}

/* â• VUE JOUR â• */
.day-wrap{padding:16px 20px;display:flex;gap:12px;flex-wrap:wrap;}
.day-card{background:white;border:1px solid var(--border);border-radius:12px;overflow:hidden;min-width:190px;max-width:220px;flex:1;}
.dc-head{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.dc-body{padding:8px 10px;}
.dc-footer{padding:6px 10px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.dc-skills{display:flex;gap:3px;flex-wrap:wrap;margin-top:4px;}
.dc-skill-chip{font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px;background:#f1f5f9;color:#475569;}
.dc-h{font-size:11px;font-weight:800;color:var(--rh-main);}
.dc-libre{font-size:11px;color:var(--muted);font-style:italic;}

/* POLYVALENCE PANEL */
.poly-panel{background:white;border:1px solid var(--border);border-radius:12px;overflow:hidden;margin:12px 20px;}
.poly-head{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:#fafbff;}
.poly-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:6px;}
.poly-grid{padding:14px 16px;display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;}
.poly-emp-card{border:1.5px solid var(--border);border-radius:10px;padding:12px;transition:border-color .15s;}
.poly-emp-card:hover{border-color:var(--rh-main);}
.poly-emp-name{font-size:12px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:6px;}
.poly-comp-list{display:flex;flex-direction:column;gap:4px;}
.poly-comp-row{display:flex;align-items:center;justify-content:space-between;font-size:11px;}
.poly-comp-name{color:var(--text);}
.poly-stars{display:flex;gap:2px;}
.poly-star{font-size:11px;color:#d1d5db;}
.poly-star.on{color:#f59e0b;}
.poly-avail-bar{margin-top:8px;height:4px;background:#f1f5f9;border-radius:99px;overflow:hidden;}
.poly-avail-fill{height:100%;background:var(--rh-main);border-radius:99px;}

/* â• INFR PANEL â• */
.infr-panel{display:none;background:#fef2f2;border-bottom:2px solid #fecaca;padding:10px 20px;}
.infr-panel.show{display:block;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(15,31,92,0.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;}
.overlay.show{display:flex;}
.modal{background:white;border-radius:16px;width:100%;max-width:500px;box-shadow:0 24px 60px rgba(0,0,0,0.15);overflow:hidden;max-height:95vh;display:flex;flex-direction:column;}
.modal-lg{max-width:680px;}
.modal-xl{max-width:820px;}
.modal-head{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.modal-head h3{font-size:14px;font-weight:700;}
.mclose{background:none;border:none;font-size:17px;cursor:pointer;color:var(--muted);}
.modal-body{padding:18px 20px;overflow-y:auto;flex:1;}
.modal-foot{padding:13px 20px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;flex-shrink:0;}
.mf{margin-bottom:13px;}
.ml{font-size:11px;font-weight:600;color:var(--muted);margin-bottom:5px;display:block;}
.mi{width:100%;padding:8px 11px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;background:white;}
.mi:focus{border-color:var(--rh-main);box-shadow:0 0 0 3px rgba(5,150,105,0.08);}
.mrow{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.mrow3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}

/* TYPE SELECTOR */
.type-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:14px;}
.type-btn{padding:8px 6px;border:2px solid var(--border);border-radius:8px;cursor:pointer;text-align:center;background:white;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
.type-btn:hover{border-color:var(--rh-main);}
.type-btn.active{border-color:var(--rh-main);background:var(--rh-ghost);}
.type-btn-icon{font-size:16px;margin-bottom:2px;}
.type-btn-lbl{font-size:9px;font-weight:700;color:var(--text);}

/* PRESET HORAIRES */
.preset-scroll{display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;margin-bottom:10px;}
.preset-scroll::-webkit-scrollbar{height:2px;}
.preset-btn{padding:5px 10px;border:1.5px solid var(--border);border-radius:6px;cursor:pointer;background:white;font-size:11px;font-weight:600;white-space:nowrap;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
.preset-btn:hover{border-color:var(--rh-main);background:var(--rh-ghost);color:var(--rh-main);}
.preset-btn.used{border-color:#c7d2fe;background:#eef2ff;color:#4338ca;}

/* PLAGES */
.plage-row{display:flex;align-items:center;gap:6px;margin-bottom:6px;}
.plage-sep{font-size:10px;font-weight:700;color:var(--muted);text-align:center;padding:0 2px;}
.plage-hl{border:1.5px solid var(--border);border-radius:7px;padding:7px 9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;color:var(--text);outline:none;width:100px;}
.plage-hl:focus{border-color:var(--rh-main);}
.plage-dur{font-size:10px;font-weight:700;color:var(--rh-main);background:var(--rh-ghost);padding:4px 7px;border-radius:5px;white-space:nowrap;}
.plage-del{width:22px;height:22px;border-radius:5px;border:1px solid #fecaca;background:#fef2f2;color:var(--red);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;}
.cr-total-dur{padding:8px 12px;background:var(--rh-ghost);border-radius:8px;font-size:12px;font-weight:700;color:var(--rh-main);display:flex;align-items:center;justify-content:space-between;}

/* ALERTES */
.alert-row{display:flex;align-items:flex-start;gap:6px;padding:7px 10px;border-radius:7px;font-size:11px;font-weight:600;margin-bottom:5px;}
.alert-row.err{background:#fee2e2;color:#dc2626;border-left:3px solid #dc2626;}
.alert-row.warn{background:#fef3c7;color:#92400e;border-left:3px solid #d97706;}
.alert-row.ok{background:#dcfce7;color:#166534;border-left:3px solid #16a34a;}

/* MULTI-DATES */
.multi-toggle{display:flex;align-items:center;gap:8px;padding:9px 12px;border-radius:9px;border:2px dashed #d1d5db;background:#fafbff;cursor:pointer;transition:all .2s;width:100%;}
.multi-toggle.on{border-style:solid;border-color:var(--rh-main);background:var(--rh-ghost);border-bottom:none;border-radius:9px 9px 0 0;}
.multi-panel{display:none;background:var(--rh-ghost);border:2px solid var(--rh-main);border-top:none;border-radius:0 0 9px 9px;padding:12px;}
.multi-panel.show{display:block;}
.multi-range-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:end;gap:8px;margin-bottom:10px;}
.multi-filters{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px;}
.chip{display:flex;align-items:center;gap:4px;padding:4px 9px;border-radius:16px;border:1.5px solid #e2e8f0;background:white;cursor:pointer;font-size:10px;font-weight:600;color:#374151;transition:all .15s;}
.chip input{display:none;}
.chip.on{border-color:var(--rh-main);background:white;color:var(--rh-main);}
.multi-days-wrap{border:1.5px solid #e2e8f0;border-radius:8px;overflow:hidden;background:white;margin-bottom:8px;}
.mday-head{display:flex;align-items:center;justify-content:space-between;padding:6px 10px;background:linear-gradient(90deg,#f0fdf7,#e8f5e9);border-bottom:1px solid #e2e8f0;}
.mday-list{max-height:160px;overflow-y:auto;}
.mday-row{display:flex;align-items:center;gap:8px;padding:5px 10px;border-bottom:1px solid #f1f5f9;cursor:pointer;transition:background .1s;}
.mday-row:hover{background:#f0fdf4;}
.mday-row.off{opacity:.4;}
.mday-cb{width:14px;height:14px;border-radius:3px;accent-color:var(--rh-main);flex-shrink:0;}
.mday-name{font-size:10px;font-weight:800;width:24px;}
.mday-date{font-size:10px;color:var(--muted);flex:1;}
.mday-tag{font-size:8px;font-weight:700;padding:1px 5px;border-radius:3px;}
.tag-we{color:#7c3aed;background:#ede9fe;}
.tag-fer{color:#92400e;background:#fef3c7;}
.tag-ouv{color:#065f46;background:#d1fae5;}
.tag-deja{color:#1e40af;background:#dbeafe;}
.multi-hrs{background:white;border:1.5px solid #e2e8f0;border-radius:8px;padding:10px;margin-bottom:8px;}

/* â• IA MODAL â• */
.ai-head-bg{background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%);padding:18px 20px;}
.ai-head-bg h3{color:white;font-size:15px;font-weight:700;}
.ai-head-bg p{color:rgba(255,255,255,.65);font-size:11px;margin-top:3px;}
.ai-sections{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.ai-sec{padding:10px 12px;border:1.5px solid var(--border);border-radius:9px;}
.ai-sec-lbl{font-size:10px;font-weight:700;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px;}
.ai-field{width:100%;border:none;outline:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;color:var(--text);}
.ai-res-box{background:#1e293b;border-radius:10px;padding:14px;color:white;max-height:260px;overflow-y:auto;margin-top:10px;}
.ai-think{display:flex;align-items:center;gap:6px;color:rgba(255,255,255,.5);font-size:12px;}
.ai-d{width:6px;height:6px;border-radius:50%;background:#6366f1;animation:ap 1.2s ease-in-out infinite;}
.ai-d:nth-child(2){animation-delay:.2s;}.ai-d:nth-child(3){animation-delay:.4s;}
@keyframes ap{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1.1)}}
.ai-emp-row{display:flex;align-items:flex-start;gap:8px;margin-bottom:8px;font-size:12px;}
.ai-emp-n{color:rgba(255,255,255,.9);font-weight:700;min-width:110px;flex-shrink:0;}
.ai-shifts{display:flex;flex-wrap:wrap;gap:3px;}
.ai-sp{padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700;}
.ai-apply-btn{width:100%;margin-top:10px;background:linear-gradient(135deg,#059669,#34d399);color:white;border:none;border-radius:8px;padding:10px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;}
.ai-apply-btn:hover{opacity:.9;}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:#1e293b;color:white;padding:11px 18px;border-radius:10px;font-size:12px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.ok{background:#059669;}
.toast.warn{background:#d97706;}

/* EMPTY */
.empty-plan{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 20px;text-align:center;color:var(--muted);}

/* MOBILE */
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:var(--rh-main);border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(15,31,92,.45);}
.hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;}
.hamburger.open span:nth-child(1){transform:translateY(7.5px) rotate(45deg);}
.hamburger.open span:nth-child(2){opacity:0;transform:scaleX(0);}
.hamburger.open span:nth-child(3){transform:translateY(-7.5px) rotate(-45deg);}
.nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;}
.nav-overlay.show{display:block;}

/* Spinner */
.spin{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--rh-main);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loader{display:flex;align-items:center;justify-content:center;gap:10px;padding:60px;color:var(--muted);}

@media(max-width:768px){
  .hamburger{display:flex!important;}
  .main{margin-left:0!important;width:100vw!important;}
  .topbar{padding:10px 10px 10px 62px!important;flex-wrap:wrap;}
  .plan-nav{padding:0 10px;}
  .plan-content{overflow-x:auto;}
  .mrow,.mrow3,.type-grid,.ai-sections{grid-template-columns:1fr 1fr!important;}
  .poly-grid{grid-template-columns:1fr!important;}
}
@media(max-width:480px){
  .mrow,.type-grid{grid-template-columns:1fr!important;}
}

/* Dropdown poste */
.poste-tag{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;background:#e0f2fe;color:#0369a1;}
.comp-stars{display:inline-flex;gap:2px;}

/* Motif pattern pour congÃ©s */
.t-conge{background:repeating-linear-gradient(-45deg,#dbeafe,#dbeafe 4px,#eff6ff 4px,#eff6ff 8px)!important;}

/* Highlight pole polyvalence */
.poly-highlight{box-shadow:0 0 0 2px #f59e0b!important;border-color:#f59e0b!important;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DRAG & DROP â€” pointer events (mouse + touch)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* Pills Gantt */
.cr-pill{cursor:grab;user-select:none;}
.cr-pill:active{cursor:grabbing;}
.cr-pill.pm-dragging{opacity:.3;pointer-events:none;}

/* Barres Timeline */
.tl-shift-bar{cursor:grab;user-select:none;touch-action:none;overflow:visible!important;}
/* PoignÃ©es resize aux extrÃ©mitÃ©s */
.tl-resize-l,.tl-resize-r{
  position:absolute;top:0;bottom:0;width:10px;
  cursor:ew-resize;z-index:6;touch-action:none;
  display:flex;align-items:center;justify-content:center;
  opacity:0;transition:opacity .15s;
}
.tl-shift-bar:hover .tl-resize-l,
.tl-shift-bar:hover .tl-resize-r{opacity:1;}
.tl-resize-l{left:-2px;border-radius:4px 0 0 4px;}
.tl-resize-r{right:-2px;border-radius:0 4px 4px 0;}
.tl-resize-l::after,.tl-resize-r::after{
  content:'';display:block;width:3px;height:16px;
  border-radius:2px;background:rgba(255,255,255,.9);
  box-shadow:0 0 3px rgba(0,0,0,.3);
}
/* Pendant resize : curseur global */
body.tl-resizing{cursor:ew-resize!important;}
body.tl-resizing *{pointer-events:none!important;}
body.tl-resizing .tl-resize-l,
body.tl-resizing .tl-resize-r{pointer-events:auto!important;}
.tl-shift-bar.pm-dragging{opacity:.25;pointer-events:none;}

/* Drop targets Gantt */
.gd-cell.pm-over{background:rgba(5,150,105,.14)!important;box-shadow:inset 0 0 0 2px var(--rh-main);border-radius:4px;}
.gd-cell.pm-over-emp{background:rgba(99,102,241,.12)!important;box-shadow:inset 0 0 0 2px #6366f1;border-radius:4px;}

/* Drop targets Timeline (changement d'employÃ©) */
.tl-row.pm-over{background:rgba(5,150,105,.08)!important;box-shadow:inset 0 0 0 2px var(--rh-main);}
.tl-row.pm-over-emp{background:rgba(99,102,241,.08)!important;box-shadow:inset 0 0 0 2px #6366f1;}

/* Ghost flottant */
#dnd-ghost{
  position:fixed;z-index:9999;pointer-events:none;
  padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;
  font-family:'Plus Jakarta Sans',sans-serif;
  box-shadow:0 8px 28px rgba(0,0,0,.28);
  display:none;white-space:nowrap;
  transform:rotate(-2deg) scale(1.05);
  border:2px solid rgba(255,255,255,.5);
}

/* Tooltip heure en cours de drag timeline */
#tl-drag-tip{
  position:fixed;z-index:9999;pointer-events:none;
  background:#1e293b;color:white;padding:4px 9px;border-radius:6px;
  font-size:11px;font-weight:700;font-family:'Plus Jakarta Sans',sans-serif;
  display:none;white-space:nowrap;
}

/* Toast confirmation */
.dnd-toast{
  position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(16px);
  background:#1e293b;color:white;padding:9px 18px;border-radius:10px;
  font-size:12px;font-weight:600;z-index:9998;opacity:0;
  transition:all .25s;pointer-events:none;white-space:nowrap;
}
.dnd-toast.show{opacity:1;transform:translateX(-50%) translateY(0);}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ZOOM / DENSITÃ‰ â€” pilotÃ© par data-zoom sur body
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â”€â”€ COMPACT â”€â”€ */
body[data-zoom="compact"] .gantt-row,
body[data-zoom="compact"] .gd-cell       { min-height:36px; }
body[data-zoom="compact"] .ge-av         { width:24px;height:24px;font-size:9px; }
body[data-zoom="compact"] .ge-name       { font-size:10px; }
body[data-zoom="compact"] .ge-meta       { display:none; }
body[data-zoom="compact"] .cr-pill       { padding:2px 4px; }
body[data-zoom="compact"] .cr-time       { font-size:8px; }
body[data-zoom="compact"] .cr-lbl        { font-size:9px; }
body[data-zoom="compact"] .m-cell        { min-height:60px; }
body[data-zoom="compact"] .m-pill        { font-size:7px;padding:1px 4px; }

/* â”€â”€ NORMAL (dÃ©faut) â”€â”€ */
body[data-zoom="normal"] .gantt-row,
body[data-zoom="normal"] .gd-cell        { min-height:52px; }

/* â”€â”€ CONFORTABLE â”€â”€ */
body[data-zoom="comfortable"] .gantt-row,
body[data-zoom="comfortable"] .gd-cell   { min-height:70px; }
body[data-zoom="comfortable"] .ge-av     { width:36px;height:36px;font-size:13px; }
body[data-zoom="comfortable"] .ge-name   { font-size:13px; }
body[data-zoom="comfortable"] .ge-meta   { font-size:10px; }
body[data-zoom="comfortable"] .ge-cell   { padding:10px 14px; }
body[data-zoom="comfortable"] .cr-pill   { padding:5px 8px; }
body[data-zoom="comfortable"] .cr-time   { font-size:10px; }
body[data-zoom="comfortable"] .cr-lbl    { font-size:11px; }
body[data-zoom="comfortable"] .m-cell    { min-height:120px; }
body[data-zoom="comfortable"] .m-pill    { font-size:9px;padding:3px 6px; }
body[data-zoom="comfortable"] .m-dnum   { font-size:14px; }

/* â”€â”€ LARGE â”€â”€ */
body[data-zoom="large"] .gantt-row,
body[data-zoom="large"] .gd-cell         { min-height:92px; }
body[data-zoom="large"] .ge-av           { width:44px;height:44px;font-size:15px; }
body[data-zoom="large"] .ge-name         { font-size:14px; }
body[data-zoom="large"] .ge-meta         { font-size:11px; }
body[data-zoom="large"] .ge-cell         { padding:12px 16px;gap:10px; }
body[data-zoom="large"] .ge-info         { display:flex;flex-direction:column;gap:4px; }
body[data-zoom="large"] .cr-pill         { padding:6px 10px; }
body[data-zoom="large"] .cr-time         { font-size:11px; }
body[data-zoom="large"] .cr-lbl          { font-size:12px; }
body[data-zoom="large"] .m-cell          { min-height:160px; }
body[data-zoom="large"] .m-pill          { font-size:10px;padding:4px 8px; }
body[data-zoom="large"] .m-dnum          { font-size:16px; }
body[data-zoom="large"] .gh-dnum         { font-size:16px; }
body[data-zoom="large"] .gh-dname        { font-size:10px; }

/* ZOOM CONTROLS */
.zoom-controls{display:flex;align-items:center;gap:3px;padding:4px 0;border-left:1px solid var(--border);margin-left:6px;padding-left:10px;}
.zoom-lbl{font-size:10px;font-weight:600;color:var(--muted);margin-right:2px;}
.zoom-btn{width:28px;height:24px;border:1.5px solid var(--border);border-radius:5px;background:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--muted);transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
.zoom-btn:hover{border-color:var(--rh-main);color:var(--rh-main);}
.zoom-btn.active{background:var(--rh-ghost);border-color:var(--rh-main);color:var(--rh-main);}
.zoom-sep-v{width:1px;height:14px;background:var(--border);margin:0 2px;}

/* Colonne employÃ© : largeur variable selon zoom */
body[data-zoom="compact"]    { --emp-col-w: 130px; }
body[data-zoom="normal"]     { --emp-col-w: 170px; }
body[data-zoom="comfortable"]{ --emp-col-w: 200px; }
body[data-zoom="large"]      { --emp-col-w: 220px; }

/* Week-end mieux visible */
.gd-cell.we{background:repeating-linear-gradient(135deg,#f9fafb,#f9fafb 8px,#f3f4f6 8px,#f3f4f6 16px);}
.gd-cell.we:hover{background:#f0fdf4;}
.gh-day.we{background:linear-gradient(180deg,#f3f4f6,#f9fafb);}
</style>
</head>
<body>

<div id="dnd-ghost"></div>
<div id="tl-drag-tip"></div>
<div class="dnd-toast" id="dnd-toast"></div>

<button class="hamburger" id="hamburger" onclick="toggleMobileNav()"><span></span><span></span><span></span></button>
<div class="nav-overlay" id="navOverlay" onclick="toggleMobileNav()"></div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>ğŸ“… Planning RH</h1>
      <p id="topbar-sub">Planning mensuel Â· Toutes vues Â· Polyvalence Â· IA</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="openPolyPanel()">ğŸ¯ Polyvalence</button>
      <button class="btn btn-outline btn-sm" onclick="openParamsEntreprise()" title="ParamÃ¨tres horaires de l'entreprise" style="border-color:#6366f1;color:#6366f1">âš™ï¸ ParamÃ¨tres</button>
      <button class="btn btn-outline btn-sm" onclick="exportPDF()">ğŸ–¨ï¸ Imprimer vue</button>
      <button class="btn btn-outline btn-sm" onclick="exportPlanningMensuelSalarie()" title="Planning mensuel individuel â€” une page par salariÃ© (portrait A4)">ğŸ‘¤ Planning individuel</button>
      <button class="btn btn-ai btn-sm" onclick="openAI()">âœ¨ IA Planning</button>
      <button class="btn btn-sm" style="background:linear-gradient(135deg,#1d4ed8,#60a5fa);color:white" onclick="openCongeRapide()">ğŸ–ï¸ CongÃ©s</button>
      <button class="btn btn-rh btn-sm" onclick="openCreneauModal()">+ CrÃ©neau</button>
    </div>
  </div>

  <!-- NAV PLANNING -->
  <div class="plan-nav">
    <div class="plan-nav-week">
      <button class="wnav-btn" onclick="navPrev()">â€¹</button>
      <div class="week-label" id="week-label">â€¦</div>
      <button class="wnav-btn" onclick="navNext()">â€º</button>
      <button class="today-btn" onclick="goToday()">Aujourd'hui</button>
    </div>
    <div class="view-tabs">
      <button class="vtab" id="vtab-mois" onclick="setView('mois')">Mois</button>
      <button class="vtab active" id="vtab-semaine" onclick="setView('semaine')">Semaine</button>
      <button class="vtab" id="vtab-jour" onclick="setView('jour')">Jour</button>
    </div>
    <div class="disp-tabs" id="disp-tabs">
      <button class="dtab active" id="dtab-gantt" onclick="setDisp('gantt')">â˜° Gantt</button>
      <button class="dtab" id="dtab-time" onclick="setDisp('timeline')">â± Timeline</button>
    </div>
    <div class="filter-sep"></div>
    <div style="display:flex;align-items:center;gap:6px;padding:4px 0">
      <select class="mi" id="filter-poste" onchange="applyFilters()" style="width:130px;padding:4px 8px;font-size:11px">
        <option value="">Tous postes</option>
      </select>
    </div>
    <div class="zoom-controls">
      <span class="zoom-lbl">Zoom :</span>
      <button class="zoom-btn" id="zbtn-compact"    onclick="setZoom('compact')"     title="Compact â€” max de salariÃ©s visibles">â€”</button>
      <button class="zoom-btn active" id="zbtn-normal"      onclick="setZoom('normal')"       title="Normal">â‰¡</button>
      <button class="zoom-btn" id="zbtn-comfortable" onclick="setZoom('comfortable')" title="Confortable â€” plus lisible">â˜°</button>
      <button class="zoom-btn" id="zbtn-large"       onclick="setZoom('large')"        title="Large â€” idÃ©al grand Ã©cran">âŠŸ</button>
    </div>
  </div>

  <!-- LÃ‰GENDE -->
  <div class="emp-legend" id="emp-legend">
    <div style="font-size:10px;font-weight:700;color:var(--muted);flex-shrink:0">Ã‰quipe :</div>
    <div style="font-size:11px;color:var(--muted)">Chargementâ€¦</div>
  </div>

  <!-- STATS -->
  <div class="stats-bar">
    <div class="sitem"><div class="sdot" style="background:var(--rh-main)"></div><span class="sval" id="s-h">â€”</span><span class="slbl"> h planifiÃ©es</span></div>
    <div class="sitem"><div class="sdot" style="background:#3b82f6"></div><span class="sval" id="s-act">â€”</span><span class="slbl"> actifs</span></div>
    <div class="sitem"><div class="sdot" style="background:#f59e0b"></div><span class="sval" id="s-cg">â€”</span><span class="slbl"> congÃ©s</span></div>
    <div class="sitem"><div class="sdot" style="background:#ef4444"></div><span class="sval" id="s-ab">â€”</span><span class="slbl"> absences</span></div>
    <div class="sitem" id="s-ec-wrap" style="display:none"><div class="sdot" style="background:#8b5cf6"></div><span class="sval" id="s-ec">â€”</span><span class="slbl"> ETP couverts</span></div>
    <div id="infr-trigger" style="display:none;margin-left:auto">
      <div class="infr-badge" onclick="toggleInfrPanel()">âš ï¸ <span id="s-infr">0</span> infraction(s)</div>
    </div>
  </div>

  <!-- INFRACTIONS -->
  <div class="infr-panel" id="infr-panel">
    <div style="font-size:12px;font-weight:700;color:#dc2626;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between">
      <span>âš ï¸ Infractions lÃ©gales cette pÃ©riode</span>
      <button onclick="toggleInfrPanel()" style="background:none;border:none;color:#dc2626;cursor:pointer">âœ•</button>
    </div>
    <div id="infr-list" style="display:flex;flex-direction:column;gap:4px"></div>
  </div>

  <!-- CONTENU -->
  <div class="plan-content" id="plan-content">
    <div class="loader"><div class="spin"></div><span>Chargement du planningâ€¦</span></div>
  </div>
</div>

<!-- MODAL CRÃ‰NEAU -->
<div class="overlay" id="modalCr">
  <div class="modal">
    <div class="modal-head">
      <h3 id="cr-title">â• Nouveau crÃ©neau</h3>
      <button class="mclose" onclick="closeCr()">âœ•</button>
    </div>
    <div class="modal-body">
      <!-- EMPLOYÃ‰ -->
      <div class="mf">
        <label class="ml">EmployÃ© *</label>
        <select class="mi" id="cr-emp" onchange="onEmpChange()"></select>
      </div>
      <div id="emp-skills-row" style="display:none;margin-bottom:12px">
        <div style="font-size:10px;font-weight:600;color:var(--muted);margin-bottom:4px">CompÃ©tences & Postes</div>
        <div id="emp-skills-display" style="display:flex;gap:4px;flex-wrap:wrap"></div>
      </div>

      <!-- TYPE SELECTOR -->
      <div class="mf">
        <label class="ml">Type de crÃ©neau</label>
        <div class="type-grid" id="type-grid">
          <button type="button" class="type-btn active" data-type="travail" onclick="setType('travail',this)"><div class="type-btn-icon">ğŸ’¼</div><div class="type-btn-lbl">Travail</div></button>
          <button type="button" class="type-btn" data-type="partiel" onclick="setType('partiel',this)"><div class="type-btn-icon">â°</div><div class="type-btn-lbl">Partiel</div></button>
          <button type="button" class="type-btn" data-type="conge" onclick="setType('conge',this)"><div class="type-btn-icon">ğŸ–ï¸</div><div class="type-btn-lbl">CongÃ©</div></button>
          <button type="button" class="type-btn" data-type="maladie" onclick="setType('maladie',this)"><div class="type-btn-icon">ğŸ¤’</div><div class="type-btn-lbl">Maladie</div></button>
          <button type="button" class="type-btn" data-type="formation" onclick="setType('formation',this)"><div class="type-btn-icon">ğŸ“š</div><div class="type-btn-lbl">Formation</div></button>
          <button type="button" class="type-btn" data-type="astreinte" onclick="setType('astreinte',this)"><div class="type-btn-icon">ğŸ””</div><div class="type-btn-lbl">Astreinte</div></button>
          <button type="button" class="type-btn" data-type="repos" onclick="setType('repos',this)"><div class="type-btn-icon">ğŸ˜´</div><div class="type-btn-lbl">Repos</div></button>
          <button type="button" class="type-btn" data-type="autre" onclick="setType('autre',this)"><div class="type-btn-icon">ğŸ“‹</div><div class="type-btn-lbl">Autre</div></button>
        </div>
      </div>

      <!-- DATE -->
      <div class="mrow" id="date-single-row">
        <div class="mf">
          <label class="ml">Date *</label>
          <input class="mi" type="date" id="cr-date" oninput="onDateChange()"/>
        </div>
        <div class="mf" id="poste-field">
          <label class="ml">Poste / Note</label>
          <input class="mi" id="cr-note" placeholder="Ex: Caisse, Cuisine, Accueilâ€¦"/>
        </div>
      </div>

      <!-- MULTI-DATES TOGGLE -->
      <div style="margin-bottom:14px">
        <button type="button" class="multi-toggle" id="multi-toggle-btn" onclick="toggleMulti(!_multiOpen)">
          <div id="multi-icon" style="font-size:16px">ğŸ“…</div>
          <div style="flex:1;text-align:left">
            <div style="font-size:11px;font-weight:700;color:var(--text)" id="multi-toggle-title">Saisir sur plusieurs jours</div>
            <div style="font-size:10px;color:var(--muted)" id="multi-toggle-sub">Cliquez pour ouvrir</div>
          </div>
          <div id="multi-arrow" style="font-size:14px;color:var(--muted);transition:transform .2s">â€º</div>
        </button>
        <div class="multi-panel" id="multi-panel">
          <div class="multi-range-row">
            <div class="mf" style="margin-bottom:0"><label class="ml">Du</label><input class="mi" type="date" id="m-deb" oninput="buildMultiPreview()"/></div>
            <div style="font-size:18px;color:var(--muted);padding-bottom:6px;align-self:end">â†’</div>
            <div class="mf" style="margin-bottom:0"><label class="ml">Au</label><input class="mi" type="date" id="m-fin" oninput="buildMultiPreview()"/></div>
          </div>
          <div class="multi-filters">
            <label class="chip on" onclick="this.classList.toggle('on');buildMultiPreview()"><input type="checkbox" id="excl-we" checked/>â›” Week-ends</label>
            <label class="chip on" onclick="this.classList.toggle('on');buildMultiPreview()"><input type="checkbox" id="excl-fer" checked/>ğŸ‰ FÃ©riÃ©s</label>
            <label class="chip" onclick="this.classList.toggle('on');buildMultiPreview()"><input type="checkbox" id="excl-deja"/>âš ï¸ DÃ©jÃ  saisis</label>
          </div>
          <div class="multi-days-wrap" id="multi-days-wrap" style="display:none">
            <div class="mday-head">
              <div style="font-size:10px;font-weight:700;color:var(--rh-main)">Jours sÃ©lectionnÃ©s <span id="mday-count" style="background:var(--rh-main);color:white;border-radius:8px;padding:1px 6px;margin-left:4px;font-size:10px">0</span></div>
              <div style="display:flex;gap:4px">
                <button type="button" class="btn btn-xs btn-outline" onclick="checkAll(true)">âœ“ Tout</button>
                <button type="button" class="btn btn-xs btn-outline" onclick="checkAll(false)">âœ• Aucun</button>
              </div>
            </div>
            <div class="mday-list" id="mday-list"></div>
          </div>
          <!-- Horaires multi -->
          <div class="multi-hrs" id="multi-hrs" style="display:none">
            <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:8px">â° Horaires appliquÃ©s Ã  chaque jour</div>
            <div style="display:flex;align-items:center;gap:8px">
              <input type="time" class="plage-hl" id="mh-deb" value="09:00" oninput="updMultiDur()"/>
              <span style="color:var(--muted)">â†’</span>
              <input type="time" class="plage-hl" id="mh-fin" value="17:00" oninput="updMultiDur()"/>
              <div class="plage-dur" id="mh-dur">8h</div>
            </div>
          </div>
          <!-- RÃ©sumÃ© -->
          <div id="multi-summary" style="display:none;background:#1a2035;border-radius:8px;padding:10px 12px;font-size:11px;color:rgba(255,255,255,.7);display:flex;align-items:center;gap:10px">
            <div style="font-size:22px;font-weight:800;color:white" id="multi-sum-n">0</div>
            <div style="width:1px;height:28px;background:rgba(255,255,255,.1)"></div>
            <div><div id="multi-sum-label" style="font-weight:700;color:white">jours Ã  enregistrer</div><div id="multi-sum-detail"></div></div>
          </div>
        </div>
      </div>

      <!-- PLAGES HORAIRES -->
      <div id="cr-hrs-section">
        <!-- PRESETS -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px">
          <label class="ml" style="margin:0">Plages horaires</label>
          <button type="button" onclick="addPlage()" class="btn btn-xs" style="background:var(--rh-ghost);color:var(--rh-main);border:1px solid var(--rh-border)">+ Coupure</button>
        </div>
        <div class="preset-scroll" id="preset-scroll"></div>
        <div id="cr-plages-wrap"></div>
        <div id="cr-total-dur" style="display:none" class="cr-total-dur">
          <span>â± Total</span><span id="cr-total-val">0h</span>
        </div>
      </div>

      <!-- ALERTES LIVE -->
      <div id="live-alerts" style="margin-top:10px"></div>

      <!-- RÃ‰CURRENCE -->
      <div class="mf" style="margin-top:10px">
        <label class="ml">RÃ©currence (optionnel)</label>
        <select class="mi" id="cr-recur">
          <option value="">Aucune</option>
          <option value="week">Toutes les semaines (mÃªme jour)</option>
          <option value="2week">Toutes les 2 semaines</option>
        </select>
        <div id="recur-until-row" style="display:none;margin-top:8px;background:#f0fdf4;padding:8px 10px;border-radius:8px;border:1px solid #bbf7d0">
          <label class="ml" style="color:#065f46;font-weight:700">ğŸ” RÃ©pÃ©ter jusqu'au <span style="font-size:10px;font-weight:400;color:#6b7280">(laisser vide = fin du mois)</span></label>
          <input class="mi" type="date" id="cr-recur-until" style="margin-top:4px"/>
          <div style="font-size:10px;color:#059669;margin-top:4px" id="recur-preview"></div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-danger btn-sm" id="cr-del" style="display:none;margin-right:auto" onclick="delCr()">ğŸ—‘ Supprimer</button>
      <button class="btn btn-outline" onclick="closeCr()">Annuler</button>
      <button class="btn btn-rh" id="save-btn" onclick="saveCr()">ğŸ’¾ Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL IA -->
<div class="overlay" id="modalAI">
  <div class="modal modal-lg">
    <div class="ai-head-bg">
      <h3>âœ¨ GÃ©nÃ©ration IA du planning</h3>
      <p id="ai-period-label">Analyse vos Ã©quipes, compÃ©tences et contraintes pour proposer un planning optimal</p>
    </div>
    <div class="modal-body">
      <div class="ai-sections">
        <div class="ai-sec"><div class="ai-sec-lbl">Ouverture</div><input class="ai-field" id="ai-op" type="time" value="08:00"/></div>
        <div class="ai-sec"><div class="ai-sec-lbl">Fermeture</div><input class="ai-field" id="ai-cl" type="time" value="20:00"/></div>
        <div class="ai-sec"><div class="ai-sec-lbl">Min. personnes / shift</div><input class="ai-field" id="ai-ms" type="number" min="1" value="2"/></div>
        <div class="ai-sec"><div class="ai-sec-lbl">Jours repos / semaine</div><input class="ai-field" id="ai-rd" type="number" min="1" max="3" value="2"/></div>
      </div>
      <div class="mf">
        <label class="ml">Instructions spÃ©cifiques</label>
        <textarea class="mi" id="ai-inst" rows="3" placeholder="Ex : Marie ne travaille pas le lundi. Pas d'ouverture le dimanche. PrÃ©fÃ©rer des shifts matin/soir en rotation. GÃ©rer la polyvalence caisse/cuisineâ€¦" style="resize:none;font-size:12px"></textarea>
      </div>
      <div id="ai-res-wrap" style="display:none">
        <div class="ai-res-box" id="ai-res-box">
          <div style="font-size:10px;font-weight:700;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">RÃ©sultat IA</div>
          <div id="ai-res-content"></div>
        </div>
        <button class="ai-apply-btn" id="ai-apply-btn" style="display:none" onclick="applyAI()">âœ… Appliquer ce planning</button>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeAI()">Fermer</button>
      <button class="btn btn-ai" id="ai-gen-btn" onclick="genAI()">âœ¨ GÃ©nÃ©rer</button>
    </div>
  </div>
</div>

<!-- MODAL POLYVALENCE -->
<div class="overlay" id="modalPoly">
  <div class="modal modal-xl">
    <div class="modal-head">
      <h3>ğŸ¯ Polyvalence & CompÃ©tences de l'Ã©quipe</h3>
      <button class="mclose" onclick="closePoly()">âœ•</button>
    </div>
    <div class="modal-body">
      <div style="font-size:12px;color:var(--muted);margin-bottom:16px">Visualisez les compÃ©tences de vos employÃ©s pour les positionner sur les bons crÃ©neaux. Renseignez les postes dans la fiche employÃ©.</div>
      <div id="poly-grid-content" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px"></div>
      <div style="margin-top:20px;padding:14px;background:#f8faff;border-radius:10px;border:1px solid var(--border)">
        <div style="font-size:12px;font-weight:700;margin-bottom:10px">ğŸ“Š Matrice de polyvalence (Postes Ã— EmployÃ©s)</div>
        <div id="poly-matrix" style="overflow-x:auto"></div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closePoly()">Fermer</button>
      <a href="rh-employes.html" class="btn btn-rh">âœï¸ Modifier les compÃ©tences</a>
    </div>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- MODAL PARAMÃˆTRES ENTREPRISE                                     -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="fermetureModal" style="display:none;position:fixed;inset:0;background:rgba(15,31,92,.5);backdrop-filter:blur(6px);z-index:400;align-items:flex-start;justify-content:center;padding:20px;overflow-y:auto">
  <div style="background:white;border-radius:18px;width:100%;max-width:620px;margin:auto;box-shadow:0 24px 80px rgba(15,31,92,.25);overflow:hidden">
    <!-- HEAD -->
    <div style="padding:20px 24px 16px;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#4f46e5 0%,#7c3aed 100%)">
      <div>
        <div style="font-size:16px;font-weight:800;color:white">âš™ï¸ ParamÃ¨tres de l'entreprise</div>
        <div style="font-size:11px;color:rgba(255,255,255,.65);margin-top:2px">Horaires d'ouverture, jours fÃ©riÃ©s, fermetures exceptionnelles</div>
      </div>
      <button onclick="closeFermetureModal()" style="background:rgba(255,255,255,.2);border:none;border-radius:8px;width:32px;height:32px;font-size:16px;cursor:pointer;color:white;display:flex;align-items:center;justify-content:center">âœ•</button>
    </div>
    <!-- BODY -->
    <div style="padding:22px 24px;display:flex;flex-direction:column;gap:20px;max-height:78vh;overflow-y:auto">

      <!-- JOURS D'OUVERTURE HEBDOMADAIRES -->
      <div>
        <div style="font-size:12px;font-weight:800;color:#1a1f36;margin-bottom:4px;display:flex;align-items:center;gap:6px">ğŸ“… Jours d'ouverture hebdomadaires <span style="font-size:10px;font-weight:400;color:#6b7280">(cliquer pour activer/dÃ©sactiver)</span></div>
        <div style="font-size:11px;color:#6b7280;margin-bottom:10px">Les jours non sÃ©lectionnÃ©s apparaÃ®tront en grisÃ© dans le planning</div>
        <div id="ferme-dow-grid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px"></div>
      </div>

      <!-- HORAIRES D'OUVERTURE -->
      <div style="background:#f8faff;border-radius:12px;padding:14px 16px">
        <div style="font-size:12px;font-weight:800;color:#1a1f36;margin-bottom:10px">ğŸ• Horaires d'ouverture par dÃ©faut</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <label style="font-size:11px;font-weight:600;color:#6b7280;display:block;margin-bottom:4px">Ouverture</label>
            <input type="time" id="params-heure-ouv" value="09:00" style="width:100%;padding:8px 10px;border:1.5px solid #e2e8f0;border-radius:8px;font-family:inherit;font-size:14px;font-weight:700;outline:none"/>
          </div>
          <div>
            <label style="font-size:11px;font-weight:600;color:#6b7280;display:block;margin-bottom:4px">Fermeture</label>
            <input type="time" id="params-heure-ferm" value="18:00" style="width:100%;padding:8px 10px;border:1.5px solid #e2e8f0;border-radius:8px;font-family:inherit;font-size:14px;font-weight:700;outline:none"/>
          </div>
        </div>
      </div>

      <!-- JOURS FÃ‰RIÃ‰S FRANÃ‡AIS -->
      <div>
        <div style="font-size:12px;font-weight:800;color:#1a1f36;margin-bottom:4px">ğŸ‡«ğŸ‡· Jours fÃ©riÃ©s nationaux</div>
        <div style="font-size:11px;color:#6b7280;margin-bottom:10px">SÃ©lectionnez les jours fÃ©riÃ©s applicables Ã  votre entreprise pour l'annÃ©e en cours</div>
        <div id="feries-grid" style="display:flex;flex-direction:column;gap:6px"></div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button onclick="selectAllFeries(true)" style="padding:5px 12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:7px;font-family:inherit;font-size:11px;font-weight:700;color:#059669;cursor:pointer">âœ“ Tout cocher</button>
          <button onclick="selectAllFeries(false)" style="padding:5px 12px;background:#fef2f2;border:1px solid #fecaca;border-radius:7px;font-family:inherit;font-size:11px;font-weight:700;color:#dc2626;cursor:pointer">âœ• Tout dÃ©cocher</button>
        </div>
      </div>

      <!-- FERMETURES PONCTUELLES -->
      <div>
        <div style="font-size:12px;font-weight:800;color:#1a1f36;margin-bottom:4px">ğŸ“Œ Fermetures exceptionnelles</div>
        <div style="font-size:11px;color:#6b7280;margin-bottom:10px">Vacances d'Ã©tÃ©, travaux, fermetures annuellesâ€¦</div>
        <!-- Ajout date unique -->
        <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
          <input type="date" id="ferme-date-input" style="flex:1;padding:8px 10px;border:1.5px solid #e2e8f0;border-radius:8px;font-family:inherit;font-size:13px;outline:none"/>
          <button onclick="addFermetureDate()" style="padding:8px 16px;background:#6366f1;color:white;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;white-space:nowrap">+ Ajouter</button>
        </div>
        <!-- Ajout plage de dates -->
        <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center;background:#f8faff;padding:10px;border-radius:8px;border:1px solid #e0e7ff">
          <span style="font-size:11px;font-weight:600;color:#6366f1;white-space:nowrap">ğŸ“† Plage :</span>
          <input type="date" id="ferme-range-deb" style="flex:1;padding:7px 8px;border:1.5px solid #e2e8f0;border-radius:7px;font-family:inherit;font-size:12px;outline:none"/>
          <span style="font-size:11px;color:#6b7280">â†’</span>
          <input type="date" id="ferme-range-fin" style="flex:1;padding:7px 8px;border:1.5px solid #e2e8f0;border-radius:7px;font-family:inherit;font-size:12px;outline:none"/>
          <button onclick="addFermeturePlage()" style="padding:7px 14px;background:#6366f1;color:white;border:none;border-radius:7px;font-size:11px;font-weight:700;cursor:pointer;white-space:nowrap">+ Plage</button>
        </div>
        <div id="ferme-dates-list" style="display:flex;flex-direction:column;gap:5px;max-height:180px;overflow-y:auto"></div>
      </div>

    </div>
    <!-- FOOT -->
    <div style="padding:14px 24px;border-top:1px solid #e2e8f0;display:flex;gap:10px;justify-content:space-between;align-items:center;background:#fafbff">
      <div style="font-size:11px;color:#6b7280">ğŸ’¾ SauvegardÃ© dans votre compte â€” visible sur tous vos appareils</div>
      <div style="display:flex;gap:8px">
        <button onclick="closeFermetureModal()" style="padding:9px 18px;background:white;color:#374151;border:1.5px solid #e2e8f0;border-radius:9px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit">Annuler</button>
        <button onclick="saveFermetures()" style="padding:9px 20px;background:linear-gradient(135deg,#4f46e5,#7c3aed);color:white;border:none;border-radius:9px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;box-shadow:0 3px 10px rgba(99,102,241,.3)">ğŸ’¾ Enregistrer</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import{getFirestore,doc,setDoc,getDoc,getDocs,deleteDoc,collection}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const app=initializeApp({apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",storageBucket:"altiora-70599.firebasestorage.app",messagingSenderId:"120905555746",appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"});
const auth=getAuth(app);const db=getFirestore(app);
window._auth=auth;window._db=db;window._doc=doc;window._setDoc=setDoc;window._getDoc=getDoc;
window._getDocs=getDocs;window._deleteDoc=deleteDoc;window._col=collection;window._signOut=signOut;
onAuthStateChanged(auth,u=>{
  if(!u){location.href='index.html';return;}
  window._uid=u.uid;
  const n=u.displayName||u.email.split('@')[0];
  const ua=document.getElementById('uname');const av=document.getElementById('av');
  if(ua)ua.textContent=n;if(av)av.textContent=n.charAt(0).toUpperCase();
  window._firebaseReady=true;
  window.initPlanning();
});
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//   PLANNING RH PRO â€” ALTEORE
//   Gestion ultra-complÃ¨te des horaires, polyvalence et IA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ STATE â”€â”€
let _emps=[], _cr={}, _view='semaine', _disp='gantt';
let _cur=new Date(), _editId=null, _hidden=new Set(), _aiResult=null;
let _zoom=localStorage.getItem('rh_zoom')||'normal';
let _joursFermes={hebdo:[0,6],ponctuels:[],heureOuv:'09:00',heureFerm:'18:00'};
function isFerme(d){
  const dow=d.getDay();
  if(_joursFermes.hebdo.includes(dow)) return true;
  return _joursFermes.ponctuels.includes(fmt(d));
}
let _multiOpen=false, _filterPoste='', _infractions={}, _ccnDefault='droit_commun';
let _plages=[{deb:'09:00',fin:'17:00'}], _crType='travail';

const COLS=['c0','c1','c2','c3','c4','c5','c6','c7','c8','c9'];
// Couleurs pills par salariÃ© (vue mois) â€” bg / texte / bordure gauche
const EMP_PILL_COLORS=[
  {bg:'#d1fae5',fg:'#065f46',bd:'#059669'}, // vert
  {bg:'#dbeafe',fg:'#1e3a8a',bd:'#3b82f6'}, // bleu
  {bg:'#ede9fe',fg:'#3b0764',bd:'#8b5cf6'}, // violet
  {bg:'#fef3c7',fg:'#78350f',bd:'#f59e0b'}, // orange
  {bg:'#fee2e2',fg:'#7f1d1d',bd:'#ef4444'}, // rouge
  {bg:'#ccfbf1',fg:'#134e4a',bd:'#14b8a6'}, // teal
  {bg:'#fce7f3',fg:'#831843',bd:'#ec4899'}, // rose
  {bg:'#e0f2fe',fg:'#0c4a6e',bd:'#0ea5e9'}, // bleu ciel
  {bg:'#f0fdf4',fg:'#166534',bd:'#22c55e'}, // vert clair
  {bg:'#fdf4ff',fg:'#581c87',bd:'#a855f7'}, // mauve
];
const TYPE_ICO={travail:'ğŸ’¼',partiel:'â°',conge:'ğŸ–ï¸',maladie:'ğŸ¤’',formation:'ğŸ“š',astreinte:'ğŸ””',repos:'ğŸ˜´',autre:'ğŸ“‹'};
const TYPE_LBL={travail:'Travail',partiel:'Tps partiel',conge:'CongÃ©',maladie:'Maladie',formation:'Formation',astreinte:'Astreinte',repos:'Repos',autre:'Autre'};

// PrÃ©sets horaires courants par secteur
const PRESETS=[
  {lbl:'Matin 9-17',plages:[{deb:'09:00',fin:'17:00'}]},
  {lbl:'Matin 8-16',plages:[{deb:'08:00',fin:'16:00'}]},
  {lbl:'Midi 12-20',plages:[{deb:'12:00',fin:'20:00'}]},
  {lbl:'Soir 14-22',plages:[{deb:'14:00',fin:'22:00'}]},
  {lbl:'Nuit 22-6',plages:[{deb:'22:00',fin:'06:00'}]},
  {lbl:'Coupure 9-14|17-21',plages:[{deb:'09:00',fin:'14:00'},{deb:'17:00',fin:'21:00'}]},
  {lbl:'Court 1h15',plages:[{deb:'09:00',fin:'10:15'}]},
  {lbl:'Demi 9-13',plages:[{deb:'09:00',fin:'13:00'}]},
  {lbl:'Ouverture 7-15',plages:[{deb:'07:00',fin:'15:00'}]},
  {lbl:'Fermeture 15-23',plages:[{deb:'15:00',fin:'23:00'}]},
];

// â”€â”€ CCN RULES â”€â”€
const CCN_RULES={
  droit_commun:{label:'Droit commun',jourMax:10,hebdoMax:48,reposMin:11,pauseApres:6,pauseMin:20},
  commerce:{label:'Commerce alimentaire',jourMax:10,hebdoMax:44,reposMin:11,pauseApres:6,pauseMin:20},
  restauration:{label:'Restauration rapide',jourMax:10,hebdoMax:43,reposMin:11,pauseApres:5,pauseMin:20},
  hotellerie:{label:'HÃ´tellerie-Restauration',jourMax:11,hebdoMax:48,reposMin:11,pauseApres:6,pauseMin:30},
  btp:{label:'BTP',jourMax:10,hebdoMax:46,reposMin:11,pauseApres:6,pauseMin:20},
  industrie:{label:'Industrie',jourMax:10,hebdoMax:48,reposMin:11,pauseApres:6,pauseMin:20},
  sap:{label:'Services Ã  la personne',jourMax:10,hebdoMax:35,reposMin:11,pauseApres:6,pauseMin:20},
};
function getCCN(emp){return CCN_RULES[emp.ccn||_ccnDefault]||CCN_RULES.droit_commun;}

// â”€â”€ HELPERS â”€â”€
function fmt(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
function isToday(d){const t=new Date();return fmt(d)===fmt(t);}
function isWE(d){const day=d.getDay();return day===0||day===6;}
function diffH(a,b){
  if(!a||!b)return 0;
  const[ah,am]=a.split(':').map(Number),[bh,bm]=b.split(':').map(Number);
  let mins=(bh*60+bm)-(ah*60+am);
  if(mins<0)mins+=24*60; // nuit
  return Math.max(0,mins/60);
}
function toMin(t){if(!t)return 0;const[h,m]=t.split(':').map(Number);return h*60+m;}
function itemH(it){
  if(it.plages&&it.plages.length>0)return it.plages.reduce((s,p)=>s+diffH(p.deb,p.fin),0);
  return diffH(it.deb,it.fin);
}
function fmtDur(h){
  const hh=Math.floor(h),mm=Math.round((h-hh)*60);
  return mm>0?`${hh}h${String(mm).padStart(2,'0')}`:`${hh}h`;
}
function monday(d){const dt=new Date(d),day=dt.getDay(),diff=(day===0)?-6:1-day;dt.setDate(dt.getDate()+diff);dt.setHours(12,0,0,0);return dt;}
function weekDays(d){const m=monday(d);return Array.from({length:7},(_,i)=>{const dd=new Date(m);dd.setDate(m.getDate()+i);return dd;});}
function monthDays(d){
  const year=d.getFullYear(),month=d.getMonth();
  const first=new Date(year,month,1);
  const last=new Date(year,month+1,0);
  const startDow=first.getDay()===0?6:first.getDay()-1;
  const days=[];
  for(let i=0;i<startDow;i++){const dd=new Date(year,month,1-startDow+i);days.push({date:dd,cur:false});}
  for(let i=1;i<=last.getDate();i++)days.push({date:new Date(year,month,i),cur:true});
  while(days.length%7!==0){const last2=days[days.length-1].date;const dd=new Date(last2);dd.setDate(dd.getDate()+1);days.push({date:dd,cur:false});}
  return days;
}

// ClÃ© de collection Firestore (par mois pour vue mois)
function crKey(d){return `plan_${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;}
function weekKey(d){return `plan_${fmt(monday(d)).replace(/-/g,'')}` ;}

// â”€â”€ INIT â”€â”€
async function initPlanning(){
  if(!window._uid){setTimeout(initPlanning,400);return;}
  // Appliquer le zoom sauvegardÃ©
  document.body.setAttribute('data-zoom',_zoom);
  ['compact','normal','comfortable','large'].forEach(k=>{
    document.getElementById('zbtn-'+k)?.classList.toggle('active',k===_zoom);
  });
  await loadRHParams();
  await loadEmps();
  await loadCr();
  render();
  // Migration one-shot : copier les donnÃ©es existantes vers rh_planning_public
  migrateToPublicIfNeeded();
}

// â”€â”€ MIGRATION rh_planning_public â”€â”€
// Copie les 3 derniers mois de planning vers rh_planning_public au 1er chargement.
// Silencieuse, non bloquante. Ne s'exÃ©cute qu'une fois (flag dans localStorage).
async function migrateToPublicIfNeeded(){
  const flag='rh_pub_migrated_v1_'+window._uid;
  if(localStorage.getItem(flag)) return;
  console.log('[migration] DÃ©but sync rh_planning_public...');
  try{
    // Collecter les semaines des 3 derniers mois + mois courant + mois prochain
    const weeks=new Set();
    const now=new Date();
    for(let mo=-3;mo<=2;mo++){
      const base=new Date(now.getFullYear(),now.getMonth()+mo,1);
      const nb=new Date(base.getFullYear(),base.getMonth()+1,0).getDate();
      for(let d=1;d<=nb;d++){
        const dt=new Date(base.getFullYear(),base.getMonth(),d);
        const mon=new Date(dt);
        const dow=mon.getDay(),diff=(dow===0)?-6:1-dow;
        mon.setDate(mon.getDate()+diff);mon.setHours(12,0,0,0);
        weeks.add(fmt(mon).replace(/-/g,''));
      }
    }
    let total=0;
    for(const wk of weeks){
      try{
        const snap=await window._getDocs(window._col(window._db,'rh',window._uid,'plan_'+wk));
        for(const docSnap of snap.docs){
          const data=docSnap.data();
          await window._setDoc(window._doc(window._db,'rh_planning_public',window._uid,'plan_'+wk,docSnap.id),data);
          total++;
        }
      }catch(e){}
    }
    localStorage.setItem(flag,'1');
    console.log('[migration] Sync terminÃ©e :', total, 'crÃ©neaux copiÃ©s vers rh_planning_public');
  }catch(e){
    console.warn('[migration] Erreur:', e.message);
  }
}
window.initPlanning=initPlanning;

async function loadRHParams(){
  try{
    const snap=await window._getDoc(window._doc(window._db,'rh_params',window._uid));
    if(snap.exists()){
      const d=snap.data();
      if(d.ccnDefault) _ccnDefault=d.ccnDefault;
      if(d.joursFermes) _joursFermes={hebdo:d.joursFermes.hebdo||[0,6],ponctuels:d.joursFermes.ponctuels||[],heureOuv:d.joursFermes.heureOuv||'09:00',heureFerm:d.joursFermes.heureFerm||'18:00'};
    }
  }catch(e){console.warn(e);}
}
async function saveJoursFermes(){
  try{
    await window._setDoc(window._doc(window._db,'rh_params',window._uid),{joursFermes:_joursFermes},{merge:true});
  }catch(e){console.error(e);}
}

async function loadEmps(){
  _emps=[];
  try{
    const s=await window._getDocs(window._col(window._db,'rh',window._uid,'employes'));
    s.forEach(d=>{const e=d.data();if(e.statut!=='archive')_emps.push({id:d.id,...e});});
    _emps.sort((a,b)=>(a.prenom||'').localeCompare(b.prenom||''));
  }catch(e){console.warn(e);}
  buildPosteFilter();
  renderLegend();
  fillEmpSel();
}

// Charge les crÃ©neaux pour la pÃ©riode affichÃ©e (semaine ou mois)
async function loadCr(){
  _cr={};
  try{
    if(_view==='mois'){
      // Utiliser TOUS les jours visibles dans la grille (y compris dÃ©bordements
      // des mois adjacents) pour ne rater aucune collection de semaine.
      // monthDays() retourne dÃ©jÃ  les jours padding avant/aprÃ¨s le mois.
      const keys=new Set();
      monthDays(_cur).forEach(({date})=>keys.add(weekKey(date)));
      for(const k of keys){
        const s=await window._getDocs(window._col(window._db,'rh',window._uid,k));
        s.forEach(doc=>{_cr[doc.id]=doc.data();});
      }
    } else {
      const k=weekKey(_cur);
      const s=await window._getDocs(window._col(window._db,'rh',window._uid,k));
      s.forEach(doc=>{_cr[doc.id]=doc.data();});
    }
  }catch(e){console.warn(e);}
}

// Charge toutes les semaines du mois d'une date donnÃ©e (pour aprÃ¨s rÃ©currence depuis vue semaine)
async function loadCrForMonth(dateStr, untilVal=''){
  try{
    const ref=new Date(dateStr+'T12:00:00');
    // untilVal passÃ© en paramÃ¨tre (DOM fermÃ© au moment de l'appel)
    const endRef=untilVal?new Date(untilVal+'T12:00:00'):new Date(ref.getFullYear(),ref.getMonth()+1,0,12,0,0);
    const keys=new Set();
    // Semaines de la pÃ©riode [ref â†’ endRef]
    let d=new Date(ref.getFullYear(),ref.getMonth(),1);
    const stop=new Date(endRef.getFullYear(),endRef.getMonth()+1,1);
    while(d<stop){
      keys.add(weekKey(d));
      d.setDate(d.getDate()+7);
    }
    // Aussi la semaine courante (pour ne pas perdre ce qui est affichÃ©)
    keys.add(weekKey(_cur));
    for(const k of keys){
      const s=await window._getDocs(window._col(window._db,'rh',window._uid,k));
      s.forEach(doc=>{_cr[doc.id]=doc.data();});
    }
  }catch(e){console.warn('[loadCrForMonth]',e);await loadCr();}
}

// â”€â”€ NAV â”€â”€
function navPrev(){
  if(_view==='mois')_cur.setMonth(_cur.getMonth()-1);
  else if(_view==='jour')_cur.setDate(_cur.getDate()-1);
  else _cur.setDate(_cur.getDate()-7);
  refresh();
}
function navNext(){
  if(_view==='mois')_cur.setMonth(_cur.getMonth()+1);
  else if(_view==='jour')_cur.setDate(_cur.getDate()+1);
  else _cur.setDate(_cur.getDate()+7);
  refresh();
}
function goToday(){_cur=new Date();refresh();}
window.navPrev=navPrev;window.navNext=navNext;window.goToday=goToday;

async function refresh(){await loadCr();render();}

function setView(v){
  _view=v;
  ['mois','semaine','jour'].forEach(k=>document.getElementById('vtab-'+k)?.classList.toggle('active',k===v));
  const dt=document.getElementById('disp-tabs');
  if(dt)dt.style.display=(v==='mois')?'none':'flex';
  refresh();
}
window.setView=setView;

function setDisp(d){
  _disp=d;
  ['gantt','timeline'].forEach(k=>document.getElementById('dtab-'+k)?.classList.toggle('active',k===d));
  render();
}
window.setDisp=setDisp;

function applyFilters(){
  _filterPoste=document.getElementById('filter-poste')?.value||'';
  render();
}
window.applyFilters=applyFilters;

// â”€â”€ ZOOM / DENSITÃ‰ â”€â”€
function setZoom(z){
  _zoom=z;
  localStorage.setItem('rh_zoom',z);
  document.body.setAttribute('data-zoom',z);
  ['compact','normal','comfortable','large'].forEach(k=>{
    document.getElementById('zbtn-'+k)?.classList.toggle('active',k===z);
  });
  render();
}
window.setZoom=setZoom;

// Applique le zoom sauvegardÃ© au dÃ©marrage
(function(){
  document.body.setAttribute('data-zoom',_zoom);
  // Activer le bon bouton une fois le DOM prÃªt
  document.addEventListener('DOMContentLoaded',()=>{
    ['compact','normal','comfortable','large'].forEach(k=>{
      document.getElementById('zbtn-'+k)?.classList.toggle('active',k===_zoom);
    });
  });
})();

// â”€â”€ RENDER â”€â”€
function render(){
  updLabel();
  checkLegal();
  updStats();
  if(_view==='mois')renderMois();
  else if(_view==='jour')renderJour();
  else if(_disp==='timeline'||((_view==='jour')&&_disp==='timeline'))renderTimeline();
  else renderGantt();
}

function updLabel(){
  const el=document.getElementById('week-label');
  const sub=document.getElementById('topbar-sub');
  if(_view==='mois'){
    const s=_cur.toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
    if(el)el.textContent=s.charAt(0).toUpperCase()+s.slice(1);
    if(sub)sub.textContent='Vue mensuelle Â· Planning complet';
  } else if(_view==='jour'){
    if(el)el.textContent=_cur.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});
    if(sub)sub.textContent='Vue journaliÃ¨re';
  } else {
    const days=weekDays(_cur);
    const s=`${days[0].toLocaleDateString('fr-FR',{day:'numeric',month:'short'})} â€“ ${days[6].toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'})}`;
    if(el)el.textContent=s;
    if(sub)sub.textContent=`Vue semaine Â· ${_disp==='timeline'?'Timeline':'Gantt'}`;
  }
}

// â”€â”€ GANTT SEMAINE â”€â”€
function renderGantt(){
  const days=weekDays(_cur);
  const vis=visibleEmps();
  const pc=document.getElementById('plan-content');
  const empW=({compact:130,normal:170,comfortable:200,large:220})[_zoom]||170;
  const cols=`${empW}px repeat(7,minmax(80px,1fr))`;

  let h=`<div class="gantt-wrap"><div class="gantt-head" style="display:grid;grid-template-columns:${cols}">
    <div class="gh-emp">EmployÃ© <span style="font-size:9px;font-weight:400;margin-left:4px">${vis.length}/${_emps.length}</span></div>
    ${days.map(d=>`<div class="gh-day ${isToday(d)?'today':''} ${isWE(d)?'we':''}">
      <div class="gh-dname">${d.toLocaleDateString('fr-FR',{weekday:'short'})}</div>
      <div class="gh-dnum">${d.getDate()}</div>
    </div>`).join('')}
  </div>`;

  if(!vis.length){
    h+=`<div class="empty-plan"><div style="font-size:42px;margin-bottom:12px">ğŸ‘¥</div><h3>Aucun employÃ© visible</h3><a href="rh-employes.html" style="color:var(--rh-main);font-weight:700;margin-top:8px">+ Ajouter des employÃ©s â†’</a></div>`;
  } else {
    vis.forEach((e,i)=>{
      const cc=COLS[i%COLS.length];
      const weekH=empWeekH(e.id,days);
      const ccn=getCCN(e);
      const infraCnt=Object.keys(_infractions).filter(k=>k.includes(e.id)).reduce((s,k)=>s+_infractions[k].length,0);
      // Nom affichÃ© selon le zoom
      const nomCourt=`${e.prenom||''} ${(e.nom||'')[0]||'.'}.`;
      const nomLong=`${e.prenom||''} ${e.nom||''}`;
      const nomAff=(_zoom==='comfortable'||_zoom==='large')?nomLong:nomCourt;
      const showPoste=(_zoom==='large')&&e.poste;
      h+=`<div class="gantt-row" style="display:grid;grid-template-columns:${cols}">
        <div class="ge-cell">
          <div class="ge-av ${cc}">${(e.prenom||'?')[0]}${(e.nom||'')[0]||''}</div>
          <div class="ge-info">
            <div class="ge-name">${nomAff}</div>
            <div class="ge-meta">
              <span class="ge-hbadge">${fmtDur(weekH)}</span>
              ${infraCnt>0?`<span class="ge-alert">âš ï¸${infraCnt}</span>`:''}
            </div>
            ${showPoste?`<div class="ge-meta" style="margin-top:2px;color:var(--muted)">${e.poste}</div>`:''}
            ${(_zoom==='comfortable'||_zoom==='large')&&e.competences&&e.competences.length>0?`<div class="ge-meta" style="margin-top:2px">${e.competences.slice(0,2).map(c=>`<span class="poste-tag">${c.nom||c}</span>`).join('')}</div>`:''}
          </div>
        </div>
        ${days.map(d=>{
          const k=`${fmt(d)}_${e.id}`;
          const items=(_cr[k]?.items||[]);
          const off=isFerme(d)&&!items.length;
          const infrs=_infractions[k]||[];
          return `<div class="gd-cell ${isToday(d)?'today':''} ${off?'we':''}"
            data-dnd-target-k="${k}"
            ondragover="dndOver(event,'${k}')"
            ondragleave="dndLeave(event)"
            ondrop="dndDrop(event,'${k}')"
            onclick="openCreneauModal('${e.id}','${fmt(d)}')">
            ${items.map(it=>pillGantt(it,k)).join('')}
            ${infrs.length?`<div style="font-size:8px;font-weight:700;color:#dc2626;padding:1px 3px;background:#fee2e2;border-radius:3px;margin-top:2px">âš ï¸</div>`:''}
            ${items.length?'':'<div class="add-hint">+</div>'}
          </div>`;
        }).join('')}
      </div>`;
    });
  }
  h+='</div>';
  pc.innerHTML=h;
}

function pillGantt(it,k){
  const plages=it.plages&&it.plages.length>0?it.plages:(it.deb&&it.fin?[{deb:it.deb,fin:it.fin}]:[]);
  const totalH=plages.reduce((s,p)=>s+diffH(p.deb,p.fin),0);
  const timeTxt=plages.length>1?plages.map(p=>`${p.deb}â€“${p.fin}`).join('|'):plages[0]?`${plages[0].deb}â€“${plages[0].fin}`:'';
  return `<div class="cr-pill t-${it.type}"
    data-dnd-k="${k}" data-dnd-id="${it.id}"
    onpointerdown="pmGanttDown(event,'${k}','${it.id}')"
    onclick="event.stopPropagation();editCr('${k}','${it.id}')">
    <div class="cr-time">${timeTxt}${totalH>0?' ('+fmtDur(totalH)+')':''}</div>
    <div class="cr-lbl">${TYPE_ICO[it.type]||'ğŸ“‹'} ${it.note||TYPE_LBL[it.type]||it.type}</div>
    <span class="cr-x" onclick="event.stopPropagation();qDel('${k}','${it.id}')">âœ•</span>
  </div>`;
}

// â”€â”€ TIMELINE SEMAINE â”€â”€
// â”€â”€ TIMELINE (vue par jour unique) â”€â”€
// Affiche une seule journÃ©e. Navigation par boutons jours quand vue=semaine.
// DnD : glisser une barre sur la ligne d'un autre employÃ© â†’ rÃ©affectation.
let _tlDay = null; // jour affichÃ© en timeline quand vue=semaine

function tl_setDay(dateStr){
  _tlDay = new Date(dateStr + 'T12:00:00');
  render();
}
window.tl_setDay = tl_setDay;

function renderTimeline(){
  // Jour Ã  afficher
  const d = (_view==='semaine') ? (_tlDay || weekDays(_cur)[0]) : _cur;
  if(_view==='semaine') _tlDay = d;

  const vis = visibleEmps();
  const pc  = document.getElementById('plan-content');
  if(!vis.length){
    pc.innerHTML=`<div class="empty-plan"><div style="font-size:42px">ğŸ‘¥</div><h3>Aucun employÃ© visible</h3></div>`;
    return;
  }

  const START_H=6, END_H=23, SPAN=END_H-START_H;
  const pct=(h,m=0)=>Math.max(0,Math.min(100,((h-START_H)*60+m)/(SPAN*60)*100));
  const now=new Date();
  const nowPct=isToday(d)?pct(now.getHours(),now.getMinutes()):null;
  const TICKS=[6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22];
  const empW=({compact:120,normal:155,comfortable:185,large:210})[_zoom]||155;

  // â”€â”€ Barre de sÃ©lection du jour (vue semaine) â”€â”€
  let dayNav='';
  if(_view==='semaine'){
    const days=weekDays(_cur);
    dayNav=`<div style="display:flex;align-items:center;gap:4px;padding:7px 16px;background:white;border-bottom:1px solid var(--border);overflow-x:auto;-webkit-overflow-scrolling:touch;flex-shrink:0">
      <span style="font-size:10px;font-weight:700;color:var(--muted);white-space:nowrap;margin-right:4px">Jour :</span>
      ${days.map(dd=>{
        const active=fmt(dd)===fmt(d);
        const we=isWE(dd);
        return `<button onclick="tl_setDay('${fmt(dd)}')" style="padding:4px 10px;border-radius:6px;border:1.5px solid ${active?'var(--rh-main)':'var(--border)'};background:${active?'var(--rh-ghost)':we?'#f9fafb':'white'};color:${active?'var(--rh-main)':we?'#9ca3af':'var(--text)'};font-family:'Plus Jakarta Sans',sans-serif;font-size:11px;font-weight:${active?700:500};cursor:pointer;white-space:nowrap;flex-shrink:0;transition:all .15s">${dd.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric'})}</button>`;
      }).join('')}
    </div>`;
  }

  // â”€â”€ En-tÃªte jour â”€â”€
  const dayHdr=`<div style="padding:9px 16px;background:white;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0">
    <span style="font-size:14px;font-weight:800;color:${isToday(d)?'var(--rh-main)':'var(--text)'}">${d.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'})}</span>
    ${isToday(d)?`<span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:10px;background:var(--rh-ghost);color:var(--rh-main)">Aujourd'hui</span>`:''}
    <span style="font-size:11px;color:var(--muted);margin-left:auto">â†” Glisser une barre pour changer l'employÃ©</span>
  </div>`;

  // â”€â”€ RÃ¨gle horaire â”€â”€
  const ruler=`<div style="display:flex;position:sticky;top:0;z-index:10;background:white;border-bottom:2px solid var(--border);box-shadow:0 2px 4px rgba(0,0,0,.04)">
    <div style="width:${empW}px;flex-shrink:0;padding:7px 12px;font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase">EmployÃ©</div>
    <div style="flex:1;position:relative;height:30px;min-width:0">
      ${TICKS.map(hh=>`
        <div style="position:absolute;left:${pct(hh)}%;top:0;bottom:0;width:1px;background:#f1f5f9;pointer-events:none"></div>
        <span style="position:absolute;left:${pct(hh)}%;top:7px;font-size:9px;font-weight:700;color:#94a3b8;transform:translateX(-50%)">${hh}h</span>
      `).join('')}
      ${nowPct!==null?`<div style="position:absolute;left:${nowPct}%;top:0;bottom:0;width:2px;background:#ef4444;z-index:3;pointer-events:none"><div style="position:absolute;top:-3px;left:-4px;width:10px;height:10px;background:#ef4444;border-radius:50%"></div></div>`:''}
    </div>
  </div>`;

  // â”€â”€ Lignes employÃ©s â”€â”€
  const rows=vis.map((e,i)=>{
    const cc=COLS[i%COLS.length];
    const k=`${fmt(d)}_${e.id}`;
    const items=(_cr[k]?.items||[]);
    const totalH=items.filter(it=>it.type==='travail'||it.type==='partiel').reduce((s,it)=>s+itemH(it),0);
    const infraCnt=(_infractions[k]||[]).length;

    const bars=items.map(it=>{
      const plages=it.plages&&it.plages.length>0?it.plages:(it.deb&&it.fin?[{deb:it.deb,fin:it.fin}]:[]);
      return plages.map(p=>{
        const [dh,dm]=(p.deb||'00:00').split(':').map(Number);
        const [fh,fm]=(p.fin||'00:00').split(':').map(Number);
        const left=pct(dh,dm);
        const width=Math.max(pct(fh,fm)-left, 1.5);
        const dur=diffH(p.deb,p.fin);
        if(left>100||left+width<0)return '';
        return `<div class="tl-shift-bar t-${it.type}"
          style="left:${left}%;width:${Math.max(width,2)}%;min-width:28px;z-index:3;position:absolute"
          data-dnd-k="${k}" data-dnd-id="${it.id}"
          data-deb="${p.deb}" data-fin="${p.fin}"
          onpointerdown="pmTlDown(event,'${k}','${it.id}','${p.deb}','${p.fin}')"
          onclick="event.stopPropagation();editCr('${k}','${it.id}')"
          title="${p.deb}â†’${p.fin} (${fmtDur(dur)})">
          <div class="tl-resize-l" onpointerdown="event.stopPropagation();pmResizeDown(event,'${k}','${it.id}','${p.deb}','${p.fin}','left')"></div>
          ${dur>=0.75?`<span style="font-size:9px;font-weight:700;pointer-events:none;user-select:none">${p.deb}â€“${p.fin}</span>`:''}
          ${it.note&&dur>=1?`<span style="opacity:.75;font-size:9px;pointer-events:none;user-select:none"> ${it.note}</span>`:''}
          <div class="tl-resize-r" onpointerdown="event.stopPropagation();pmResizeDown(event,'${k}','${it.id}','${p.deb}','${p.fin}','right')"></div>
        </div>`;
      }).join('');
    }).join('');

    return `<div class="tl-row" style="height:52px"
      data-dnd-target-k="${k}"
      ondragover="dndTlOver(event,'${k}',this)"
      ondragleave="dndTlLeave(event,this)"
      ondrop="dndDrop(event,'${k}')">
      <!-- Colonne employÃ© (sticky) -->
      <div class="tl-emp" style="width:${empW}px;position:sticky;left:0;background:inherit;z-index:4">
        <div class="${cc} ge-av" style="width:28px;height:28px;font-size:10px;flex-shrink:0">${(e.prenom||'?')[0]}${(e.nom||'')[0]||''}</div>
        <div style="min-width:0">
          <div style="font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${e.prenom||''} ${e.nom||''}</div>
          <div style="display:flex;gap:4px;align-items:center">
            ${totalH>0?`<span style="font-size:9px;font-weight:700;color:var(--rh-main)">${fmtDur(totalH)}</span>`:''}
            ${infraCnt>0?`<span style="font-size:9px;font-weight:700;color:#dc2626">âš ï¸</span>`:''}
          </div>
        </div>
      </div>
      <!-- Zone barres -->
      <div class="tl-bar-wrap" style="position:relative;flex:1;min-width:0;cursor:crosshair"
        onclick="tlBwrapClick(event,'${e.id}','${fmt(d)}')"
        data-start="${_pm.tlStartH||6}" data-span="${(_pm.tlEndH||23)-(_pm.tlStartH||6)}">
        ${TICKS.map(hh=>`<div class="tl-grid-line" style="left:${pct(hh)}%"></div>`).join('')}
        ${bars}
        ${!items.length?`<div style="position:absolute;inset:0;display:flex;align-items:center;padding-left:14px;pointer-events:none;color:#d1d5db;font-size:11px;font-weight:500">+ Cliquer pour ajouter</div>`:''}
      </div>
    </div>`;
  }).join('');

  pc.innerHTML=`<div style="display:flex;flex-direction:column;height:100%">
    ${dayNav}${dayHdr}
    <div style="flex:1;overflow:auto;-webkit-overflow-scrolling:touch">
      <div style="min-width:${empW+500}px;height:100%">
        ${ruler}${rows}
      </div>
    </div>
  </div>`;
}

// â”€â”€ Clic sur la zone horaire timeline â†’ crÃ©e directement un crÃ©neau 1h â”€â”€
async function tlBwrapClick(ev, empId, date){
  if(_pm.active || _pm._justDragged) return;
  // Ignorer si clic sur une barre ou ses enfants
  if(ev.target.classList.contains('tl-shift-bar') || ev.target.closest('.tl-shift-bar')) return;
  if(ev.target.classList.contains('tl-resize-l') || ev.target.classList.contains('tl-resize-r')) return;

  const bwrap = ev.currentTarget;
  const rect  = bwrap.getBoundingClientRect();
  const START_H = 6, END_H = 23, SPAN = (END_H - START_H) * 60;

  const ratio  = (ev.clientX - rect.left) / rect.width;
  const rawMin = ratio * SPAN + START_H * 60;
  const debMin = _snapQ(Math.max(START_H * 60, Math.min(END_H * 60 - 60, rawMin)));
  const finMin = Math.min(debMin + 60, END_H * 60);
  const debStr = _minToStr(debMin);
  const finStr = _minToStr(finMin);

  // CrÃ©ation directe sans modal â€” type travail par dÃ©faut
  const k = `${date}_${empId}`;
  if(!_cr[k]) _cr[k] = {items:[]};
  const newItem = {
    id: 'c'+Date.now(),
    type: 'travail',
    deb: debStr,
    fin: finStr,
    plages: [{deb: debStr, fin: finStr}],
    note: ''
  };
  _cr[k].items.push(newItem);
  render(); // affichage immÃ©diat optimiste
  try{
    await saveKey(k, date);
    checkLegal(); updStats();
    _showDndToast(`âœ… ${debStr}â€“${finStr} ajoutÃ©`);
  }catch(e){
    console.error(e);
    _cr[k].items = _cr[k].items.filter(i=>i.id!==newItem.id);
    render();
    _showDndToast('âŒ Erreur sauvegarde');
  }
}
window.tlBwrapClick = tlBwrapClick;

// dndTlOver/dndTlLeave supprimÃ©s (pointer-events engine)

// â”€â”€ VUE MOIS â”€â”€
function renderMois(){
  const days=monthDays(_cur);
  const vis=visibleEmps();
  const pc=document.getElementById('plan-content');
  const JOURS=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
  // Nombre de pills selon le zoom
  let h=`<div class="month-wrap"><div class="month-grid">
    ${JOURS.map(j=>`<div class="m-dhead">${j}</div>`).join('')}
    ${days.map(({date,cur})=>{
      const kp=fmt(date);
      // Grouper par salariÃ© : 1 ligne par personne prÃ©sente
      const empData=vis.map((e,empIdx)=>{
        const items=(_cr[`${kp}_${e.id}`]?.items||[]);
        if(!items.length)return null;
        const empCol=EMP_PILL_COLORS[empIdx%EMP_PILL_COLORS.length];
        const workItems=items.filter(it=>it.type==='travail'||it.type==='partiel');
        const h=workItems.reduce((s,it)=>s+itemH(it),0);
        // RÃ©sumÃ© : heure dÃ©but + durÃ©e ou type si pas travail
        const firstWork=workItems[0]||items[0];
        const plages=firstWork.plages&&firstWork.plages.length>0?firstWork.plages:(firstWork.deb?[{deb:firstWork.deb,fin:firstWork.fin}]:[]);
        const timeTxt=plages[0]?plages[0].deb:(TYPE_LBL[firstWork.type]||firstWork.type);
        const durTxt=h>0?` ${fmtDur(h)}`:'';
        // Indicateurs complÃ©mentaires (conges/maladie/etc)
        const hasConge=items.some(it=>it.type==='conge');
        const hasMal=items.some(it=>it.type==='maladie');
        const multiType=items.length>1?`+${items.length-1}`:'';
        const hasRecur=items.some(it=>it.recurId);
        return {e,empCol,timeTxt,durTxt,multiType,hasConge,hasMal,h,hasRecur};
      }).filter(Boolean);

      const totalH=empData.reduce((s,d)=>s+d.h,0);
      const ferme=isFerme(date);
      // Hauteur cellule adaptÃ©e au nombre de salariÃ©s
      const cellH=Math.max(82, 22 + empData.length*17);
      return `<div class="m-cell ${isToday(date)?'m-today':''} ${!cur?'m-other':''} ${isWE(date)?'m-we':''} ${ferme&&cur?'m-ferme':''}"
        style="min-height:${cellH}px"
        onclick="setView('jour');_cur=new Date(${date.getFullYear()},${date.getMonth()},${date.getDate()});render()">
        ${ferme&&cur&&!empData.length?'<div class="m-ferme-badge">FermÃ©</div>':''}
        <div class="m-dnum">
          <span ${isToday(date)?'class="m-dnum-circle"':''}>${date.getDate()}</span>
          ${(_zoom==='comfortable'||_zoom==='large')&&cur?`<span style="font-size:9px;font-weight:500;color:var(--muted);margin-left:4px">${date.toLocaleDateString('fr-FR',{weekday:'short'})}</span>`:''}
        </div>
        ${totalH>0?`<div class="m-total-badge">${fmtDur(totalH)}</div>`:''}
        ${empData.map(({e,empCol,timeTxt,durTxt,multiType,hasConge,hasMal,hasRecur})=>{
          const initials=`${(e.prenom||'?')[0]}${(e.nom||'')[0]||''}`.toUpperCase();
          const showName=(_zoom==='comfortable'||_zoom==='large');
          const nameTxt=showName?`${e.prenom||''} `:initials+' ';
          const icons=(hasConge?'ğŸ–':'')+(hasMal?'ğŸ¤’':'')+(hasRecur?'â†»':'');
          const extra=multiType?`<span style="opacity:.55;font-size:7px"> ${multiType}</span>`:'';
          const iconsHtml=icons?`<span style="font-size:7px;opacity:.7"> ${icons}</span>`:'';
          return `<div class="m-pill" style="background:${empCol.bg};color:${empCol.fg};border-left:2px solid ${empCol.bd}">${nameTxt}${timeTxt}${durTxt}${extra}${iconsHtml}</div>`;
        }).join('')}
        ${empData.length===0&&cur?`<div style="font-size:10px;color:#d1d5db;padding:4px 0">libre</div>`:''}
      </div>`;
    }).join('')}
  </div></div>`;
  pc.innerHTML=h;
}

// â”€â”€ VUE JOUR â”€â”€
function renderJour(){
  const vis=visibleEmps();
  const pc=document.getElementById('plan-content');
  const d=_cur;

  if(!vis.length){pc.innerHTML=`<div class="empty-plan"><div style="font-size:42px">ğŸ‘¥</div><h3>Aucun employÃ©</h3></div>`;return;}

  let h=`<div style="padding:14px 20px;font-size:14px;font-weight:800;color:var(--text)">${d.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
  <div class="day-wrap">`;

  vis.forEach((e,i)=>{
    const cc=COLS[i%COLS.length];
    const k=`${fmt(d)}_${e.id}`;
    const items=(_cr[k]?.items||[]);
    const totalH=items.filter(it=>it.type==='travail'||it.type==='partiel').reduce((s,it)=>s+itemH(it),0);
    const comps=(e.competences||[]).slice(0,4);

    h+=`<div class="day-card">
      <div class="dc-head">
        <div class="${cc} ge-av" style="width:30px;height:30px;font-size:11px">${(e.prenom||'?')[0]}${(e.nom||'')[0]||''}</div>
        <div style="min-width:0">
          <div style="font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${e.prenom||''} ${e.nom||''}</div>
          <div style="font-size:10px;color:var(--muted)">${e.typeContrat||'CDI'} Â· ${e.heuresHebdo||35}h</div>
        </div>
      </div>
      ${comps.length?`<div class="dc-skills">${comps.map(c=>`<span class="dc-skill-chip">${c.nom||c}</span>`).join('')}</div>`:''}
      <div class="dc-body">
        ${items.length?items.map(it=>pillGantt(it,k)).join(''):'<div class="dc-libre">Libre</div>'}
      </div>
      <div class="dc-footer">
        ${totalH>0?`<span class="dc-h">${fmtDur(totalH)}</span>`:'<span></span>'}
        <button class="btn btn-xs btn-rh" onclick="openCreneauModal('${e.id}','${fmt(d)}')">+</button>
      </div>
    </div>`;
  });

  h+=`</div>`;
  pc.innerHTML=h;
}

// â”€â”€ STATS + LÃ‰GALE â”€â”€
function updStats(){
  let totalH=0,actifs=0,conges=0,abs=0;
  const days=_view==='mois'?monthDays(_cur).filter(x=>x.cur).map(x=>x.date):_view==='jour'?[_cur]:weekDays(_cur);
  days.forEach(d=>{
    _emps.forEach(e=>{
      const k=`${fmt(d)}_${e.id}`;
      const items=(_cr[k]?.items||[]);
      items.forEach(it=>{
        if(it.type==='travail'||it.type==='partiel'){totalH+=itemH(it);actifs++;}
        else if(it.type==='conge')conges++;
        else if(it.type==='maladie')abs++;
      });
    });
  });
  const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
  set('s-h',fmtDur(totalH));set('s-act',actifs);set('s-cg',conges);set('s-ab',abs);
  const infraCnt=Object.values(_infractions).reduce((s,a)=>s+a.length,0);
  const ib=document.getElementById('infr-trigger');
  if(ib)ib.style.display=infraCnt>0?'block':'none';
  set('s-infr',infraCnt);
}

function checkLegal(){
  _infractions={};
  const days=_view==='mois'?monthDays(_cur).filter(x=>x.cur).map(x=>x.date):weekDays(_cur);
  _emps.forEach(e=>{
    const ccn=getCCN(e);
    days.forEach(d=>{
      const k=`${fmt(d)}_${e.id}`;
      const items=(_cr[k]?.items||[]).filter(it=>it.type==='travail'||it.type==='partiel');
      if(!items.length)return;
      const jourH=items.reduce((s,it)=>s+itemH(it),0);
      const alerts=[];
      if(jourH>ccn.jourMax)alerts.push({sev:'err',msg:`${e.prenom} : ${fmtDur(jourH)} > max ${ccn.jourMax}h (${fmt(d)})`});
      // Repos inter-shift
      const yesterday=new Date(d);yesterday.setDate(yesterday.getDate()-1);
      const yvK=`${fmt(yesterday)}_${e.id}`;
      const yvItems=(_cr[yvK]?.items||[]).filter(it=>it.type==='travail'||it.type==='partiel');
      if(yvItems.length){
        const lastFin=Math.max(...yvItems.map(it=>toMin(it.plages?.length?it.plages[it.plages.length-1].fin:it.fin||'00:00')));
        const firstDeb=Math.min(...items.map(it=>toMin(it.plages?.length?it.plages[0].deb:it.deb||'00:00')));
        const gapH=((24*60-lastFin)+firstDeb)/60;
        if(gapH<ccn.reposMin)alerts.push({sev:'err',msg:`${e.prenom} : repos inter-shift ${gapH.toFixed(1)}h < ${ccn.reposMin}h (${fmt(d)})`});
      }
      if(alerts.length)_infractions[k]=alerts;
    });
  });

  const list=document.getElementById('infr-list');
  if(list){
    const all=Object.values(_infractions).flat();
    list.innerHTML=all.map(a=>`<div class="alert-row ${a.sev}">${a.sev==='err'?'ğŸ”´':'ğŸŸ¡'} ${a.msg}</div>`).join('');
    if(!all.length)document.getElementById('infr-panel')?.classList.remove('show');
  }
}

function toggleInfrPanel(){document.getElementById('infr-panel')?.classList.toggle('show');}
window.toggleInfrPanel=toggleInfrPanel;

// â”€â”€ LÃ‰GENDE â”€â”€
function renderLegend(){
  const el=document.getElementById('emp-legend');
  if(!_emps.length){el.innerHTML=`<div style="font-size:11px;font-weight:700;color:var(--muted)">Ã‰quipe :</div><a href="rh-employes.html" style="font-size:11px;font-weight:700;color:var(--rh-main);text-decoration:none">+ Ajouter des employÃ©s â†’</a>`;return;}
  el.innerHTML=`<div style="font-size:10px;font-weight:700;color:var(--muted);flex-shrink:0">Ã‰quipe :</div>`+
  _emps.map((e,i)=>`<div class="leg-item ${_hidden.has(e.id)?'hidden':''}" onclick="toggleEmp('${e.id}')">
    <div class="leg-dot ${COLS[i%COLS.length]}"></div>${e.prenom||''} ${(e.nom||'')[0]||''}.
    ${(e.competences||[]).length?`<span class="leg-skills">(${(e.competences||[]).length} post.)</span>`:''}
  </div>`).join('');
}

function toggleEmp(id){_hidden.has(id)?_hidden.delete(id):_hidden.add(id);renderLegend();render();}
window.toggleEmp=toggleEmp;

function visibleEmps(){
  let list=_emps.filter(e=>!_hidden.has(e.id));
  if(_filterPoste)list=list.filter(e=>(e.competences||[]).some(c=>(c.nom||c)===_filterPoste));
  return list;
}

function buildPosteFilter(){
  const postes=new Set();
  _emps.forEach(e=>(e.competences||[]).forEach(c=>postes.add(c.nom||c)));
  const sel=document.getElementById('filter-poste');
  if(sel){
    sel.innerHTML=`<option value="">Tous postes</option>`+[...postes].sort().map(p=>`<option value="${p}">${p}</option>`).join('');
  }
}

function fillEmpSel(){
  const sel=document.getElementById('cr-emp');
  if(sel)sel.innerHTML=_emps.map(e=>`<option value="${e.id}">${e.prenom||''} ${e.nom||''}</option>`).join('');
}

function empWeekH(eid,days){
  let h=0;
  days.forEach(d=>{
    (_cr[`${fmt(d)}_${eid}`]?.items||[]).forEach(it=>{
      if(it.type==='travail'||it.type==='partiel')h+=itemH(it);
    });
  });
  return h;
}

// â”€â”€ MODAL CRÃ‰NEAU â”€â”€
function openCreneauModal(empId='',date='',defType='travail'){
  _editId=null;
  _plages=[{deb:'09:00',fin:'17:00'}];
  _crType=defType;
  document.getElementById('cr-title').textContent='â• Nouveau crÃ©neau';
  document.getElementById('cr-del').style.display='none';
  if(empId)document.getElementById('cr-emp').value=empId;
  if(date)document.getElementById('cr-date').value=date;
  else document.getElementById('cr-date').value=fmt(_cur);
  document.getElementById('cr-note').value='';
  document.getElementById('cr-recur').value='';
  document.getElementById('recur-until-row').style.display='none';
  setType(defType,document.querySelector(`.type-btn[data-type="${defType}"]`));
  toggleMulti(false);
  onEmpChange();
  renderPresets();
  renderPlages();
  document.getElementById('modalCr').classList.add('show');
}
window.openCreneauModal=openCreneauModal;

function openCongeRapide(){
  openCreneauModal('','','conge');
  setTimeout(()=>toggleMulti(true),60);
}
window.openCongeRapide=openCongeRapide;

function closeCr(){document.getElementById('modalCr').classList.remove('show');}
window.closeCr=closeCr;

function onEmpChange(){
  const eid=document.getElementById('cr-emp')?.value;
  const emp=_emps.find(e=>e.id===eid);
  const row=document.getElementById('emp-skills-row');
  const disp=document.getElementById('emp-skills-display');
  if(emp&&emp.competences&&emp.competences.length&&row&&disp){
    row.style.display='block';
    disp.innerHTML=emp.competences.map(c=>`<span class="poste-tag">â­ ${c.nom||c}</span>`).join('');
  } else if(row){row.style.display='none';}
  updLiveAlerts();
}
window.onEmpChange=onEmpChange;

function setType(type,btn){
  _crType=type;
  document.querySelectorAll('.type-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  const showHrs=['travail','partiel','formation','astreinte'].includes(type);
  document.getElementById('cr-hrs-section').style.display=showHrs?'block':'none';
  document.getElementById('multi-hrs').style.display=showHrs?'block':'none';
  renderPresets();
  if(showHrs)renderPlages();
  updLiveAlerts();
}
window.setType=setType;

function onDateChange(){updLiveAlerts();}
window.onDateChange=onDateChange;

// PrÃ©sets selon type
function renderPresets(){
  const wrap=document.getElementById('preset-scroll');
  if(!wrap)return;
  if(!['travail','partiel','astreinte'].includes(_crType)){wrap.innerHTML='';return;}
  wrap.innerHTML=PRESETS.map((p,i)=>`<button type="button" class="preset-btn" onclick="applyPreset(${i})">${p.lbl}</button>`).join('');
}
function applyPreset(i){
  _plages=PRESETS[i].plages.map(p=>({...p}));
  renderPlages();
}
window.applyPreset=applyPreset;

// â”€â”€ PLAGES â”€â”€
function renderPlages(){
  const wrap=document.getElementById('cr-plages-wrap');
  if(!wrap)return;
  wrap.innerHTML=_plages.map((p,i)=>`
    <div class="plage-row">
      ${i>0?`<div class="plage-sep" style="width:36px;text-align:center;font-size:9px;font-weight:700;color:var(--muted)">â†³ coupure</div>`:`<div style="width:36px"></div>`}
      <input type="time" class="plage-hl" value="${p.deb}" oninput="updPlage(${i},'deb',this.value)"/>
      <span style="color:var(--muted);font-size:14px">â†’</span>
      <input type="time" class="plage-hl" value="${p.fin}" oninput="updPlage(${i},'fin',this.value)"/>
      <div class="plage-dur">${fmtDur(diffH(p.deb,p.fin))}</div>
      ${_plages.length>1?`<button type="button" class="plage-del" onclick="removePlage(${i})">Ã—</button>`:`<div style="width:22px"></div>`}
    </div>`).join('');
  updTotalDur();
}

function addPlage(){
  const last=_plages[_plages.length-1];
  const [fh,fm]=(last.fin||'17:00').split(':').map(Number);
  const newDeb=`${String(fh+1).padStart(2,'0')}:${String(fm).padStart(2,'0')}`;
  const newFin=`${String(fh+3).padStart(2,'0')}:${String(fm).padStart(2,'0')}`;
  _plages.push({deb:newDeb,fin:newFin});
  renderPlages();
}
window.addPlage=addPlage;

function removePlage(i){if(_plages.length<=1)return;_plages.splice(i,1);renderPlages();}
window.removePlage=removePlage;

function updPlage(i,field,val){if(_plages[i])_plages[i][field]=val;updTotalDur();updLiveAlerts();}
window.updPlage=updPlage;

function updTotalDur(){
  const total=_plages.reduce((s,p)=>s+diffH(p.deb,p.fin),0);
  const el=document.getElementById('cr-total-dur');
  const val=document.getElementById('cr-total-val');
  if(el){el.style.display=total>0?'flex':'none';}
  if(val){val.textContent=fmtDur(total);}
  // Mettre Ã  jour les dur de chaque plage
  document.querySelectorAll('.plage-dur').forEach((el,i)=>{
    if(_plages[i])el.textContent=fmtDur(diffH(_plages[i].deb,_plages[i].fin));
  });
}

// â”€â”€ ALERTES LIVE â”€â”€
function updLiveAlerts(){
  const el=document.getElementById('live-alerts');
  if(!el)return;
  el.innerHTML='';
  const eid=document.getElementById('cr-emp')?.value;
  const date=document.getElementById('cr-date')?.value;
  if(!eid||!date||!['travail','partiel'].includes(_crType))return;
  const emp=_emps.find(e=>e.id===eid);
  if(!emp)return;
  const ccn=getCCN(emp);
  const alerts=[];
  const k=`${date}_${eid}`;
  const existH=(_cr[k]?.items||[]).filter(it=>it.type==='travail'||it.type==='partiel').reduce((s,it)=>s+itemH(it),0);
  const curH=_plages.reduce((s,p)=>s+diffH(p.deb,p.fin),0);
  const jourH=existH+curH;
  if(jourH>ccn.jourMax)alerts.push({sev:'err',msg:`JournÃ©e dÃ©passÃ©e : ${fmtDur(jourH)} (max ${ccn.jourMax}h â€” ${ccn.label})`});
  if(_plages.length===1&&curH>ccn.pauseApres)alerts.push({sev:'warn',msg:`Pause obligatoire requise aprÃ¨s ${ccn.pauseApres}h (cliquez "+ Coupure")`});
  if(!alerts.length)alerts.push({sev:'ok',msg:`âœ… Aucune infraction lÃ©gale (${ccn.label})`});
  el.innerHTML=alerts.map(a=>`<div class="alert-row ${a.sev}">${a.msg}</div>`).join('');
}

// â”€â”€ MULTI-DATES â”€â”€
function toggleMulti(open){
  _multiOpen=open;
  const panel=document.getElementById('multi-panel');
  const btn=document.getElementById('multi-toggle-btn');
  const arrow=document.getElementById('multi-arrow');
  const sub=document.getElementById('multi-toggle-sub');
  if(!panel)return;
  if(open){
    panel.classList.add('show');
    btn?.classList.add('on');
    if(arrow)arrow.style.transform='rotate(90deg)';
    if(sub)sub.textContent='Fermez pour saisie date unique';
    const dd=document.getElementById('m-deb');
    const cd=document.getElementById('cr-date')?.value;
    if(dd&&!dd.value&&cd)dd.value=cd;
    buildMultiPreview();
  } else {
    panel.classList.remove('show');
    btn?.classList.remove('on');
    if(arrow)arrow.style.transform='';
    if(sub)sub.textContent='Cliquez pour ouvrir';
    document.getElementById('multi-summary').style.display='none';
  }
}
window.toggleMulti=toggleMulti;

function getJoursFeries(year){
  const a=year%19,b=Math.floor(year/100),c=year%100;
  const d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25);
  const g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30;
  const i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7;
  const m2=Math.floor((a+11*h+22*l)/451);
  const month=Math.floor((h+l-7*m2+114)/31);
  const day=((h+l-7*m2+114)%31)+1;
  const p=new Date(year,month-1,day);
  const add=(d,n)=>{const r=new Date(d);r.setDate(r.getDate()+n);return r;};
  const iso=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  return new Set([`${year}-01-01`,iso(add(p,1)),`${year}-05-01`,`${year}-05-08`,iso(add(p,39)),iso(add(p,50)),`${year}-07-14`,`${year}-08-15`,`${year}-11-01`,`${year}-11-11`,`${year}-12-25`]);
}

function buildMultiPreview(){
  const debStr=document.getElementById('m-deb')?.value;
  const finStr=document.getElementById('m-fin')?.value;
  const exclWE=document.getElementById('excl-we')?.checked;
  const exclFer=document.getElementById('excl-fer')?.checked;
  const exclDeja=document.getElementById('excl-deja')?.checked;
  const wrap=document.getElementById('multi-days-wrap');
  const list=document.getElementById('mday-list');
  if(!debStr||!finStr||finStr<debStr){if(wrap)wrap.style.display='none';updMultiSummary();return;}

  const deb=new Date(debStr+'T12:00:00'),fin=new Date(finStr+'T12:00:00');
  const years=new Set();
  for(let y=deb.getFullYear();y<=fin.getFullYear();y++)years.add(y);
  const feries=new Set();years.forEach(y=>getJoursFeries(y).forEach(d=>feries.add(d)));
  const JOURS=['Dim','Lun','Mar','Mer','Jeu','Ven','Sam'];
  const eid=document.getElementById('cr-emp')?.value;
  const days=[];
  const cur=new Date(deb);
  while(cur<=fin){
    const iso=fmt(cur);
    const dow=cur.getDay();
    const we=dow===0||dow===6;
    const fer=feries.has(iso);
    const deja=eid&&_cr[`${iso}_${eid}`]&&(_cr[`${iso}_${eid}`].items||[]).length>0;
    const autoExcl=(exclWE&&we)||(exclFer&&fer)||(exclDeja&&deja);
    days.push({iso,dow,we,fer,deja,autoExcl,lbl:JOURS[dow]});
    cur.setDate(cur.getDate()+1);
  }

  if(list)list.innerHTML=days.map((d,i)=>{
    const tag=d.we?'<span class="mday-tag tag-we">WE</span>':d.fer?'<span class="mday-tag tag-fer">FÃ©riÃ©</span>':d.deja?'<span class="mday-tag tag-deja">DÃ©jÃ  saisi</span>':'<span class="mday-tag tag-ouv">OuvrÃ©</span>';
    return `<div class="mday-row ${d.autoExcl?'off':''}" onclick="toggleDay(${i})">
      <input type="checkbox" class="mday-cb" id="mday-${i}" data-iso="${d.iso}" ${!d.autoExcl?'checked':''}/>
      <span class="mday-name">${d.lbl}</span>
      <span class="mday-date">${d.iso.split('-').reverse().join('/')}</span>
      ${tag}
    </div>`;
  }).join('');
  if(wrap)wrap.style.display='block';
  updMultiSummary();
}
window.buildMultiPreview=buildMultiPreview;

function toggleDay(i){const cb=document.getElementById(`mday-${i}`);if(cb){cb.checked=!cb.checked;updMultiSummary();}}
window.toggleDay=toggleDay;

function checkAll(v){document.querySelectorAll('.mday-cb').forEach(cb=>cb.checked=v);updMultiSummary();}
window.checkAll=checkAll;

function updMultiSummary(){
  const checked=document.querySelectorAll('.mday-cb:checked');
  const n=checked.length;
  const badge=document.getElementById('mday-count');if(badge)badge.textContent=n;
  const sum=document.getElementById('multi-summary');
  const sumN=document.getElementById('multi-sum-n');
  const sumD=document.getElementById('multi-sum-detail');
  const sumL=document.getElementById('multi-sum-label');
  if(sum){sum.style.display=n>0?'flex':'none';}
  if(sumN)sumN.textContent=n;
  if(sumL)sumL.textContent=`jour(s) de ${TYPE_LBL[_crType]||_crType}`;
  if(sumD&&n>0){
    const isos=[...checked].map(cb=>cb.dataset.iso).sort();
    sumD.textContent=isos.length===1?`Le ${isos[0].split('-').reverse().join('/')}`:
      `Du ${isos[0].split('-').reverse().join('/')} au ${isos[isos.length-1].split('-').reverse().join('/')}`;
  }
  // Bouton save
  const saveBtn=document.getElementById('save-btn');
  if(saveBtn){
    if(_multiOpen&&n>0)saveBtn.textContent=`ğŸ’¾ Enregistrer (${n} jour${n>1?'s':''})`;
    else saveBtn.textContent='ğŸ’¾ Enregistrer';
  }
}

function updMultiDur(){
  const deb=document.getElementById('mh-deb')?.value||'09:00';
  const fin=document.getElementById('mh-fin')?.value||'17:00';
  const dur=document.getElementById('mh-dur');
  if(dur)dur.textContent=fmtDur(diffH(deb,fin));
}
window.updMultiDur=updMultiDur;

// â”€â”€ RÃ‰CURRENCE â”€â”€
function onRecurChange(){
  const v=document.getElementById('cr-recur')?.value;
  const row=document.getElementById('recur-until-row');
  if(!row) return;
  row.style.display=v?'block':'none';
  if(v){
    const inp=document.getElementById('cr-recur-until');
    if(inp&&!inp.value){
      // PrÃ©-remplir avec la fin du mois de la DATE DU CRÃ‰NEAU (pas _cur)
      const crDateVal=document.getElementById('cr-date')?.value;
      const ref=crDateVal?new Date(crDateVal+'T12:00:00'):_cur;
      const lastDay=new Date(ref.getFullYear(),ref.getMonth()+1,0);
      inp.value=fmt(lastDay);
      // Afficher un aperÃ§u du nombre de semaines
      updateRecurPreview();
    }
  }
}

function updateRecurPreview(){
  const preview=document.getElementById('recur-preview');
  if(!preview) return;
  const recur=document.getElementById('cr-recur')?.value;
  const untilVal=document.getElementById('cr-recur-until')?.value;
  const crDateVal=document.getElementById('cr-date')?.value;
  if(!recur||!untilVal||!crDateVal) return;
  const step=recur==='week'?7:14;
  let d=new Date(crDateVal+'T12:00:00');
  const endD=new Date(untilVal+'T12:00:00');
  let count=0;
  d.setDate(d.getDate()+step);
  while(d<=endD){ count++; d.setDate(d.getDate()+step); }
  if(count===0){
    preview.textContent='âš ï¸ Aucune occurrence dans cette pÃ©riode';
    preview.style.color='#dc2626';
  } else {
    preview.textContent=`âœ“ ${count} occurrence(s) seront crÃ©Ã©es`;
    preview.style.color='#059669';
  }
}
document.getElementById('cr-recur')?.addEventListener('change',onRecurChange);
document.getElementById('cr-recur-until')?.addEventListener('change',updateRecurPreview);

// â”€â”€ SAVE â”€â”€
async function saveCr(){
  const eid=document.getElementById('cr-emp')?.value;
  const type=_crType;
  const note=document.getElementById('cr-note')?.value||'';
  const showHrs=['travail','partiel','formation','astreinte'].includes(type);
  const plagesData=showHrs?_plages.filter(p=>p.deb&&p.fin):[];

  if(!eid){showToast('SÃ©lectionnez un employÃ©','warn');return;}

  // â”€â”€ MODE MULTI â”€â”€
  if(_multiOpen&&!_editId){
    const dates=[...document.querySelectorAll('.mday-cb:checked')].map(cb=>cb.dataset.iso).filter(Boolean);
    if(!dates.length){showToast('Aucun jour sÃ©lectionnÃ©','warn');return;}
    const btn=document.getElementById('save-btn');
    if(btn){btn.disabled=true;btn.textContent=`â³ 0/${dates.length}â€¦`;}
    const mDeb=document.getElementById('mh-deb')?.value||'09:00';
    const mFin=document.getElementById('mh-fin')?.value||'17:00';
    const mPlages=showHrs?[{deb:mDeb,fin:mFin}]:[];

    let saved=0;
    for(const date of dates){
      const k=`${date}_${eid}`;
      if(!_cr[k])_cr[k]={items:[]};
      const it={id:'c'+Date.now()+'_'+saved,type,deb:mPlages[0]?.deb||'',fin:mPlages[0]?.fin||'',plages:mPlages.length>0?mPlages:undefined,note};
      _cr[k].items.push(it);
      await saveKey(k,date);
      saved++;
      if(btn)btn.textContent=`â³ ${saved}/${dates.length}â€¦`;
    }

    // RÃ©currence (mode multi : s'applique si 1 seule date cochÃ©e)
    const recur=document.getElementById('cr-recur')?.value;
    if(recur&&dates.length===1){
      const untilVal=document.getElementById('cr-recur-until')?.value||'';
      await applyRecurrence(dates[0],eid,type,mPlages,note,recur,untilVal);
    }

    closeCr();await loadCr();render();
    showToast(`âœ… ${saved} crÃ©neau(x) enregistrÃ©s`,'ok');
    return;
  }

  // â”€â”€ MODE DATE UNIQUE â”€â”€
  const date=document.getElementById('cr-date')?.value;
  if(!date){showToast('SÃ©lectionnez une date','warn');return;}
  const k=`${date}_${eid}`;
  if(!_cr[k])_cr[k]={items:[]};
  const it={id:'c'+Date.now(),type,deb:plagesData[0]?.deb||'',fin:plagesData[plagesData.length-1]?.fin||'',plages:plagesData.length>0?plagesData:undefined,note};

  if(_editId){
    const {k:ok,itemId}=_editId;
    if(ok!==k){
      _cr[ok].items=(_cr[ok].items||[]).filter(i=>i.id!==itemId);
      await saveKey(ok,ok.split('_')[0]);
      _cr[k].items.push({...it,id:itemId});
    } else {
      const idx=(_cr[k].items||[]).findIndex(i=>i.id===itemId);
      if(idx>=0)_cr[k].items[idx]={...it,id:itemId};
    }
  } else {
    _cr[k].items.push(it);
    // Lire les valeurs de rÃ©currence AVANT closeCr() qui dÃ©truit le DOM
    const recur=document.getElementById('cr-recur')?.value;
    const untilForReload=document.getElementById('cr-recur-until')?.value||'';
    const hadRecur=!!recur;
    // Sauvegarder le crÃ©neau INITIAL d'abord (avant applyRecurrence pour Ã©viter doublons)
    await saveKey(k,date);
    if(recur) await applyRecurrence(date,eid,type,plagesData,note,recur,untilForReload);
    closeCr();
    if(hadRecur){
      await loadCrForMonth(date, untilForReload);
    } else {
      await loadCr();
    }
    render();
    showToast(_editId?'CrÃ©neau modifiÃ© âœ…':'CrÃ©neau ajoutÃ© âœ…','ok');
    return;
  }

  await saveKey(k,date);
  closeCr();
  await loadCr();
  render();
  showToast('CrÃ©neau modifiÃ© âœ…','ok');
}
window.saveCr=saveCr;

async function applyRecurrence(startDate,eid,type,plages,note,recur,untilVal=''){
  // GÃ©nÃ©rer un ID de groupe pour permettre la suppression groupÃ©e
  const recurId='r'+Date.now().toString(36)+Math.random().toString(36).slice(2,5);
  // Aussi marquer le crÃ©neau initial avec ce recurId
  const initKey=`${startDate}_${eid}`;
  if(_cr[initKey]?.items?.length){
    const lastItem=_cr[initKey].items[_cr[initKey].items.length-1];
    if(lastItem && !lastItem.recurId) lastItem.recurId=recurId;
    await saveKey(initKey,startDate);
  }
  // untilVal passÃ© en paramÃ¨tre â€” plus de lecture DOM (modal peut Ãªtre fermÃ©)
  let endD;
  if(untilVal){
    endD=new Date(untilVal+'T12:00:00');
  } else {
    // Fin du mois de la date de dÃ©part
    const sd=new Date(startDate+'T12:00:00');
    endD=new Date(sd.getFullYear(),sd.getMonth()+1,0,12,0,0);
  }
  const step=recur==='week'?7:14;
  let d=new Date(startDate+'T12:00:00');
  d.setDate(d.getDate()+step);
  if(d>endD){
    showToast('âš ï¸ Aucune occurrence : la date de fin est avant la prochaine rÃ©currence','warn');
    return;
  }
  let count=0;
  const saves=[];
  while(d<=endD){
    const iso=fmt(d);
    const k=`${iso}_${eid}`;
    if(!_cr[k])_cr[k]={items:[]};
    // ID unique : combinaison timestamp + counter + random pour Ã©viter collision
    const uid_item=`c${iso.replace(/-/g,'')}${eid.slice(-4)}${Math.random().toString(36).slice(2,6)}`;
    // Copie profonde des plages pour chaque occurrence
    const plagesCopy=plages.length>0?plages.map(p=>({deb:p.deb,fin:p.fin})):undefined;
    _cr[k].items.push({id:uid_item,type,deb:plages[0]?.deb||'',fin:plages[plages.length-1]?.fin||'',plages:plagesCopy,note,recurId});
    saves.push({k,iso});
    d.setDate(d.getDate()+step);
    count++;
  }
  // Sauvegarder toutes les occurrences
  if(saves.length){
    // Lire btn AVANT tout traitement (modal encore ouvert Ã  ce moment)
    const btn=document.getElementById('save-btn');
    if(btn){btn.disabled=true;btn.textContent=`â³ 0/${saves.length}â€¦`;}
    let done=0;
    try{
      for(const {k,iso} of saves){
        await saveKey(k,iso);
        done++;
        // btn peut avoir disparu si modal fermÃ© entre-temps â€” pas grave
        const b=document.getElementById('save-btn');
        if(b)b.textContent=`â³ ${done}/${saves.length}â€¦`;
      }
    } catch(err){
      console.error('[applyRecurrence saveKey]',err);
      showToast('Erreur sauvegarde rÃ©currence','warn');
    } finally {
      // Toujours restaurer le bouton (mÃªme si fermÃ© entre-temps)
      const b=document.getElementById('save-btn');
      if(b){b.disabled=false;b.textContent='ğŸ’¾ Enregistrer';}
    }
  }
  if(count>0) showToast(`ğŸ” RÃ©currence : ${count} occurrence(s) enregistrÃ©es âœ…`,'ok');
}

async function saveKey(k,date){
  try{
    const wk=weekKey(new Date((date||k.split('_')[0])+'T12:00:00'));
    const data=_cr[k]||{items:[]};
    // 1. Sauvegarder dans rh/{uid}/plan_{wk}/{k} (module admin)
    await window._setDoc(window._doc(window._db,'rh',window._uid,wk,k),data);
    // 2. Miroir public dans rh_planning_public/{uid}/{wk}/{k} (lecture espace salariÃ©)
    try{
      await window._setDoc(window._doc(window._db,'rh_planning_public',window._uid,wk,k),data);
    }catch(e2){console.warn('[planning public mirror]',e2.message);}
  }catch(e){console.error(e);showToast('Erreur Firebase');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POINTER-MOVE ENGINE â€” mouse + touch, sans HTML5 drag API
// Deux modes :
//   A) Gantt  : dÃ©placer une pill vers une autre cellule (changement date/employÃ©)
//   B) Timeline : glisser une barre horizontalement (dÃ©caler horaire au Â¼h)
//                 ou verticalement (changer d'employÃ©)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TYPE_COLORS={
  travail:'#bbf7d0|#14532d',repos:'#f3f4f6|#6b7280',conge:'#bfdbfe|#1e3a8a',
  maladie:'#fecaca|#7f1d1d',formation:'#fde68a|#78350f',
  astreinte:'#ddd6fe|#3b0764',partiel:'#fed7aa|#7c2d12'
};

// â”€â”€ Ã‰tat global du drag â”€â”€
const _pm = {
  active:   false,
  mode:     null,   // 'gantt' | 'tl-move' | 'tl-emp'
  srcEl:    null,
  srcK:     null,
  srcId:    null,
  srcItem:  null,
  // Timeline move
  tlBwrap:  null,   // Ã©lÃ©ment .tl-bar-wrap conteneur
  tlSpan:   0,      // durÃ©e du crÃ©neau en minutes (fixe)
  tlOrigMin:0,      // dÃ©but original en minutes depuis START_H
  tlOrigX:  0,      // clientX au pointerdown
  tlStartH: 6,
  tlEndH:   23,
  // Gantt drop
  overEl:   null,
  overK:    null,
  // clic vs drag
  downX:    0,
  downY:    0,
  moved:    false,
};
const DRAG_THRESHOLD = 6; // px avant de considÃ©rer un drag

function _ghost(){ return document.getElementById('dnd-ghost'); }
function _tip(){ return document.getElementById('tl-drag-tip'); }

function _showGhost(x,y,label,bg,fg){
  const g=_ghost();
  g.style.cssText=`display:block;position:fixed;top:${y-16}px;left:${x+14}px;z-index:9999;pointer-events:none;
    padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;
    font-family:'Plus Jakarta Sans',sans-serif;background:${bg};color:${fg};
    box-shadow:0 8px 28px rgba(0,0,0,.28);white-space:nowrap;
    transform:rotate(-2deg) scale(1.05);border:2px solid rgba(255,255,255,.5);`;
  g.textContent=label;
}
function _moveGhost(x,y){
  const g=_ghost();
  g.style.left=(x+14)+'px';
  g.style.top=(y-16)+'px';
}
function _hideGhost(){
  _ghost().style.display='none';
  _tip().style.display='none';
}

function _snapQ(minutes){ return Math.round(minutes/15)*15; } // arrondi Â¼h
function _minToStr(m){
  m=Math.max(0,Math.min(23*60+59,m));
  return String(Math.floor(m/60)).padStart(2,'0')+':'+String(m%60).padStart(2,'0');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// A) GANTT â€” pointerdown sur une pill
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pmGanttDown(ev, k, id){
  if(ev.button!==undefined && ev.button!==0) return;
  ev.stopPropagation();
  const item=(_cr[k]?.items||[]).find(i=>i.id===id);
  if(!item) return;

  _pm.mode   ='gantt';
  _pm.srcEl  = ev.currentTarget;
  _pm.srcK   = k;
  _pm.srcId  = id;
  _pm.srcItem= JSON.parse(JSON.stringify(item));
  _pm.downX  = ev.clientX;
  _pm.downY  = ev.clientY;
  _pm.moved  = false;
  _pm.active = false;

  ev.currentTarget.setPointerCapture(ev.pointerId);
  ev.currentTarget.addEventListener('pointermove', _pmGanttMove);
  ev.currentTarget.addEventListener('pointerup',   _pmGanttUp);
  ev.currentTarget.addEventListener('pointercancel',_pmGanttUp);
}

function _pmGanttMove(ev){
  const dx=Math.abs(ev.clientX-_pm.downX), dy=Math.abs(ev.clientY-_pm.downY);
  if(!_pm.active && dx*dx+dy*dy < DRAG_THRESHOLD*DRAG_THRESHOLD) return;

  if(!_pm.active){
    _pm.active=true;
    _pm.srcEl.classList.add('pm-dragging');
    const item=_pm.srcItem;
    const emp=_emps.find(e=>e.id===(_pm.srcK||'').split('_')[1]);
    const plages=item.plages?.length>0?item.plages:(item.deb?[{deb:item.deb,fin:item.fin}]:[]);
    const timeTxt=plages[0]?`${plages[0].deb}â€“${plages[0].fin}`:'';
    const [bg,fg]=(TYPE_COLORS[item.type]||'#f1f5f9|#374151').split('|');
    _showGhost(ev.clientX,ev.clientY,`${TYPE_ICO[item.type]||'ğŸ“‹'} ${emp?.prenom||'?'} Â· ${timeTxt}`,bg,fg);
  }

  _moveGhost(ev.clientX, ev.clientY);

  // Trouver la cellule cible sous le pointeur
  const els=document.elementsFromPoint(ev.clientX,ev.clientY);
  const cell=els.find(el=>el.classList.contains('gd-cell')&&el.dataset.dndTargetK);
  const targetK=cell?.dataset.dndTargetK||null;

  if(targetK!==_pm.overK){
    if(_pm.overEl){_pm.overEl.classList.remove('pm-over','pm-over-emp');}
    _pm.overK=targetK;
    _pm.overEl=cell||null;
    if(cell && targetK!==_pm.srcK){
      const srcEmpId=(_pm.srcK||'').split('_')[1];
      const tgtEmpId=targetK.split('_')[1];
      cell.classList.add(srcEmpId===tgtEmpId?'pm-over':'pm-over-emp');
    }
  }
}

async function _pmGanttUp(ev){
  ev.currentTarget.removeEventListener('pointermove',_pmGanttMove);
  ev.currentTarget.removeEventListener('pointerup',_pmGanttUp);
  ev.currentTarget.removeEventListener('pointercancel',_pmGanttUp);

  if(_pm.overEl){_pm.overEl.classList.remove('pm-over','pm-over-emp');}
  _pm.srcEl.classList.remove('pm-dragging');
  _hideGhost();

  if(!_pm.active){ _pm.active=false; return; } // c'Ã©tait un clic simple
  _pm.active=false;

  const targetK=_pm.overK;
  if(!targetK||targetK===_pm.srcK){_pm.overK=null;_pm.overEl=null;return;}

  const srcK=_pm.srcK, item=_pm.srcItem, id=_pm.srcId;
  const srcDate=srcK.split('_')[0], tgtDate=targetK.split('_')[0];
  const srcEmpId=srcK.split('_')[1], tgtEmpId=targetK.split('_')[1];

  if(!_cr[srcK])_cr[srcK]={items:[]};
  _cr[srcK].items=(_cr[srcK].items||[]).filter(i=>i.id!==id);
  if(!_cr[targetK])_cr[targetK]={items:[]};
  _cr[targetK].items.push({...item});
  render();

  try{
    await Promise.all([saveKey(srcK,srcDate),saveKey(targetK,tgtDate)]);
    checkLegal();updStats();
    const srcEmp=_emps.find(e=>e.id===srcEmpId), tgtEmp=_emps.find(e=>e.id===tgtEmpId);
    const tgtFmt=new Date(tgtDate+'T12:00:00').toLocaleDateString('fr-FR',{weekday:'short',day:'numeric',month:'short'});
    _showDndToast(srcEmpId===tgtEmpId?`âœ… DÃ©placÃ© â†’ ${tgtFmt}`:`âœ… ${srcEmp?.prenom||'?'} â†’ ${tgtEmp?.prenom||'?'} (${tgtFmt})`);
  }catch(e){
    console.error(e);await loadCr();render();
    _showDndToast('âŒ Erreur sauvegarde');
  }
  _pm.overK=null;_pm.overEl=null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// B) TIMELINE â€” pointerdown sur une barre
// DÃ©placement horizontal â†’ dÃ©cale l'heure (Â¼h)
// DÃ©placement vertical >30px â†’ change d'employÃ©
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function pmTlDown(ev, k, id, deb, fin){
  if(ev.button!==undefined && ev.button!==0) return;
  ev.stopPropagation();
  ev.preventDefault();

  const item=(_cr[k]?.items||[]).find(i=>i.id===id);
  if(!item) return;

  const bwrap=ev.currentTarget.closest('.tl-bar-wrap');
  if(!bwrap) return;

  const debMin=(parseInt(deb)||0)*60+(parseInt(deb.split(':')[1])||0);
  const finMin=(parseInt(fin)||0)*60+(parseInt(fin.split(':')[1])||0);

  _pm.mode     ='tl-move';
  _pm.srcEl    = ev.currentTarget;
  _pm.srcK     = k;
  _pm.srcId    = id;
  _pm.srcItem  = JSON.parse(JSON.stringify(item));
  _pm.tlBwrap  = bwrap;
  _pm.tlSpan   = finMin-debMin;          // durÃ©e fixe
  _pm.tlOrigMin= debMin;                 // dÃ©but original
  _pm.tlOrigX  = ev.clientX;
  _pm.tlStartH = 6;
  _pm.tlEndH   = 23;
  _pm.downX    = ev.clientX;
  _pm.downY    = ev.clientY;
  _pm.moved    = false;
  _pm.active   = false;
  _pm.overEl   = null;
  _pm.overK    = null;

  ev.currentTarget.setPointerCapture(ev.pointerId);
  ev.currentTarget.addEventListener('pointermove',_pmTlMove);
  ev.currentTarget.addEventListener('pointerup',  _pmTlUp);
  ev.currentTarget.addEventListener('pointercancel',_pmTlUp);
}

function _pmTlMove(ev){
  const dx=ev.clientX-_pm.downX, dy=ev.clientY-_pm.downY;
  const dist=Math.sqrt(dx*dx+dy*dy);
  if(!_pm.active && dist < DRAG_THRESHOLD) return;

  if(!_pm.active){
    _pm.active=true;
    _pm.srcEl.classList.add('pm-dragging');
    const item=_pm.srcItem;
    const [bg,fg]=(TYPE_COLORS[item.type]||'#f1f5f9|#374151').split('|');
    const emp=_emps.find(e=>e.id===(_pm.srcK||'').split('_')[1]);
    _showGhost(ev.clientX,ev.clientY,`${TYPE_ICO[item.type]||'ğŸ“‹'} ${emp?.prenom||'?'}`,bg,fg);
  }

  // â”€â”€ Calcul dÃ©placement horizontal â†’ nouvelle heure â”€â”€
  const bwrap=_pm.tlBwrap;
  const rect=bwrap.getBoundingClientRect();
  const spanTot=(_pm.tlEndH-_pm.tlStartH)*60; // minutes total affichÃ©
  const pxToMin=(ev.clientX-_pm.tlOrigX)/rect.width*spanTot;
  let newDebMin=_snapQ(_pm.tlOrigMin+pxToMin);
  // Bornes
  newDebMin=Math.max(_pm.tlStartH*60, Math.min((_pm.tlEndH*60)-_pm.tlSpan, newDebMin));
  const newFinMin=newDebMin+_pm.tlSpan;
  const newDeb=_minToStr(newDebMin);
  const newFin=_minToStr(newFinMin);

  // Mettre Ã  jour visuellement la barre en live
  const pct=(m)=>Math.max(0,Math.min(100,(m-_pm.tlStartH*60)/spanTot*100));
  _pm.srcEl.style.left=pct(newDebMin)+'%';
  _pm.srcEl.style.width=Math.max(pct(newFinMin)-pct(newDebMin),1.5)+'%';
  const span=_pm.srcEl.querySelector('span');
  if(span)span.textContent=`${newDeb}â€“${newFin}`;

  // Tooltip heure
  const tip=_tip();
  tip.style.cssText=`display:block;position:fixed;top:${ev.clientY-34}px;left:${ev.clientX}px;z-index:9999;pointer-events:none;
    background:#1e293b;color:white;padding:3px 8px;border-radius:5px;
    font-size:11px;font-weight:700;font-family:'Plus Jakarta Sans',sans-serif;transform:translateX(-50%)`;
  tip.textContent=`${newDeb} â€“ ${newFin}`;

  _moveGhost(ev.clientX, ev.clientY);

  // â”€â”€ DÃ©placement vertical â†’ changer d'employÃ© â”€â”€
  const absDy=Math.abs(dy);
  if(absDy>28){
    const els=document.elementsFromPoint(ev.clientX,ev.clientY);
    const row=els.find(el=>el.classList.contains('tl-row')&&el.dataset.dndTargetK);
    const targetK=row?.dataset.dndTargetK||null;
    if(targetK!==_pm.overK){
      if(_pm.overEl){_pm.overEl.classList.remove('pm-over','pm-over-emp');}
      _pm.overK=targetK;
      _pm.overEl=row||null;
      if(row && targetK!==_pm.srcK){
        const srcEmpId=(_pm.srcK||'').split('_')[1];
        const tgtEmpId=targetK.split('_')[1];
        row.classList.add(srcEmpId===tgtEmpId?'pm-over':'pm-over-emp');
      }
    }
  }
}

async function _pmTlUp(ev){
  ev.currentTarget.removeEventListener('pointermove',_pmTlMove);
  ev.currentTarget.removeEventListener('pointerup',_pmTlUp);
  ev.currentTarget.removeEventListener('pointercancel',_pmTlUp);

  if(_pm.overEl){_pm.overEl.classList.remove('pm-over','pm-over-emp');}
  _pm.srcEl.classList.remove('pm-dragging');
  _hideGhost();

  if(!_pm.active){ _pm.active=false; return; } // clic simple â†’ editCr
  _pm.active=false;
  _pm._justDragged=true; setTimeout(()=>_pm._justDragged=false,50);

  // â”€â”€ Calculer la nouvelle heure â”€â”€
  const bwrap=_pm.tlBwrap;
  const rect=bwrap.getBoundingClientRect();
  const spanTot=(_pm.tlEndH-_pm.tlStartH)*60;
  const pxToMin=(ev.clientX-_pm.tlOrigX)/rect.width*spanTot;
  let newDebMin=_snapQ(_pm.tlOrigMin+pxToMin);
  newDebMin=Math.max(_pm.tlStartH*60, Math.min((_pm.tlEndH*60)-_pm.tlSpan, newDebMin));
  const newFinMin=newDebMin+_pm.tlSpan;
  const newDeb=_minToStr(newDebMin);
  const newFin=_minToStr(newFinMin);

  const srcK=_pm.srcK, srcId=_pm.srcId;
  const targetK=_pm.overK; // null = mÃªme ligne, juste dÃ©calage horaire
  const finalK = targetK||srcK;
  const srcDate=srcK.split('_')[0];
  const finalDate=finalK.split('_')[0];

  // Mise Ã  jour de l'item dans _cr
  const destK=finalK;
  if(!_cr[destK])_cr[destK]={items:[]};

  // Trouver et modifier l'item
  const modItem = JSON.parse(JSON.stringify(_pm.srcItem));
  // Mettre Ã  jour toutes les plages en dÃ©calant
  const origDebMin=_pm.tlOrigMin;
  const delta=newDebMin-origDebMin;
  if(modItem.plages&&modItem.plages.length>0){
    modItem.plages=modItem.plages.map(p=>{
      const [ph,pm2]=p.deb.split(':').map(Number);
      const [fh2,fm2]=p.fin.split(':').map(Number);
      const pDebMin=ph*60+pm2+delta;
      const pFinMin=fh2*60+fm2+delta;
      return {deb:_minToStr(pDebMin),fin:_minToStr(pFinMin)};
    });
    modItem.deb=modItem.plages[0].deb;
    modItem.fin=modItem.plages[modItem.plages.length-1].fin;
  } else {
    modItem.deb=newDeb;
    modItem.fin=newFin;
  }

  if(destK!==srcK){
    // Changement d'employÃ© : retirer de srcK
    _cr[srcK].items=(_cr[srcK].items||[]).filter(i=>i.id!==srcId);
    _cr[destK].items.push(modItem);
  } else {
    // MÃªme ligne : juste modifier
    const idx=(_cr[srcK].items||[]).findIndex(i=>i.id===srcId);
    if(idx>=0)_cr[srcK].items[idx]=modItem;
  }

  render();

  try{
    const saves=[saveKey(srcK,srcDate)];
    if(destK!==srcK) saves.push(saveKey(destK,finalDate));
    await Promise.all(saves);
    checkLegal();updStats();
    const srcEmpId=srcK.split('_')[1], tgtEmpId=finalK.split('_')[1];
    if(srcEmpId!==tgtEmpId){
      const srcEmp=_emps.find(e=>e.id===srcEmpId),tgtEmp=_emps.find(e=>e.id===tgtEmpId);
      _showDndToast(`âœ… ${srcEmp?.prenom||'?'} â†’ ${tgtEmp?.prenom||'?'}`);
    } else {
      _showDndToast(`âœ… DÃ©placÃ© : ${newDeb}â€“${newFin}`);
    }
  }catch(e){
    console.error(e);await loadCr();render();
    _showDndToast('âŒ Erreur sauvegarde');
  }
  _pm.overK=null;_pm.overEl=null;
}

// â”€â”€ RESIZE ENGINE â€” Ã©tirer/rÃ©duire les barres timeline au Â¼h â”€â”€
const _rs = {
  active: false,
  el: null,         // la barre DOM
  k: null,
  id: null,
  side: null,       // 'left' | 'right'
  bwrap: null,
  origDeb: 0,       // minutes
  origFin: 0,
  origX: 0,
  startH: 6,
  endH: 23,
};

function pmResizeDown(ev, k, id, deb, fin, side){
  if(ev.button !== undefined && ev.button !== 0) return;
  ev.preventDefault();
  ev.stopPropagation();

  const bar = ev.currentTarget.closest('.tl-shift-bar');
  if(!bar) return;
  const bwrap = bar.closest('.tl-bar-wrap');
  if(!bwrap) return;

  const [dh,dm] = (deb||'00:00').split(':').map(Number);
  const [fh,fm] = (fin||'00:00').split(':').map(Number);

  _rs.active  = false;
  _rs.el      = bar;
  _rs.k       = k;
  _rs.id      = id;
  _rs.side    = side;
  _rs.bwrap   = bwrap;
  _rs.origDeb = dh*60+dm;
  _rs.origFin = fh*60+fm;
  _rs.origX   = ev.clientX;
  _rs.startH  = 6;
  _rs.endH    = 23;

  ev.currentTarget.setPointerCapture(ev.pointerId);
  ev.currentTarget.addEventListener('pointermove', _rsMove);
  ev.currentTarget.addEventListener('pointerup',   _rsUp);
  ev.currentTarget.addEventListener('pointercancel',_rsUp);
  document.body.classList.add('tl-resizing');
}

function _rsMove(ev){
  const rect = _rs.bwrap.getBoundingClientRect();
  const spanTot = (_rs.endH - _rs.startH) * 60;
  const pxToMin = (ev.clientX - _rs.origX) / rect.width * spanTot;
  const MIN_DUR = 15; // minimum 15 min

  let newDeb = _rs.origDeb;
  let newFin = _rs.origFin;

  if(_rs.side === 'left'){
    newDeb = _snapQ(Math.max(_rs.startH*60, Math.min(_rs.origFin - MIN_DUR, _rs.origDeb + pxToMin)));
  } else {
    newFin = _snapQ(Math.max(_rs.origDeb + MIN_DUR, Math.min(_rs.endH*60, _rs.origFin + pxToMin)));
  }

  // Mise Ã  jour visuelle live
  const pct = (m) => Math.max(0, Math.min(100, (m - _rs.startH*60) / spanTot * 100));
  _rs.el.style.left  = pct(newDeb) + '%';
  _rs.el.style.width = Math.max(pct(newFin) - pct(newDeb), 1.5) + '%';
  const span = _rs.el.querySelector('span');
  if(span) span.textContent = `${_minToStr(newDeb)}â€“${_minToStr(newFin)}`;

  // Tooltip
  const tip = _tip();
  tip.style.cssText = `display:block;position:fixed;top:${ev.clientY-34}px;left:${ev.clientX}px;z-index:9999;pointer-events:none;
    background:#1e293b;color:white;padding:3px 8px;border-radius:5px;
    font-size:11px;font-weight:700;font-family:'Plus Jakarta Sans',sans-serif;transform:translateX(-50%)`;
  tip.textContent = `${_minToStr(newDeb)} â€“ ${_minToStr(newFin)}`;

  _rs.active = true;
  _rs._newDeb = newDeb;
  _rs._newFin = newFin;
}

async function _rsUp(ev){
  ev.currentTarget.removeEventListener('pointermove', _rsMove);
  ev.currentTarget.removeEventListener('pointerup',   _rsUp);
  ev.currentTarget.removeEventListener('pointercancel',_rsUp);
  document.body.classList.remove('tl-resizing');
  _tip().style.display = 'none';

  if(!_rs.active){ _rs.active = false; return; }
  _rs.active = false;

  const newDeb = _rs._newDeb;
  const newFin = _rs._newFin;
  const newDebStr = _minToStr(newDeb);
  const newFinStr = _minToStr(newFin);

  const k = _rs.k, id = _rs.id;
  const date = k.split('_')[0];

  // Modifier l'item dans _cr
  const items = _cr[k]?.items || [];
  const idx = items.findIndex(i => i.id === id);
  if(idx < 0){ render(); return; }

  const item = JSON.parse(JSON.stringify(items[idx]));
  if(item.plages && item.plages.length > 0){
    // Resize la plage correspondante (deb/fin match)
    const origDebStr = _minToStr(_rs.origDeb);
    const origFinStr = _minToStr(_rs.origFin);
    const pi = item.plages.findIndex(p => p.deb === origDebStr && p.fin === origFinStr);
    if(pi >= 0){
      item.plages[pi].deb = newDebStr;
      item.plages[pi].fin = newFinStr;
    }
    // Recalcul deb/fin globaux
    item.deb = item.plages[0].deb;
    item.fin = item.plages[item.plages.length-1].fin;
  } else {
    item.deb = newDebStr;
    item.fin = newFinStr;
  }
  _cr[k].items[idx] = item;
  render();

  try{
    await saveKey(k, date);
    checkLegal(); updStats();
    _showDndToast(`âœ… ${newDebStr}â€“${newFinStr}`);
  }catch(e){
    console.error(e); await loadCr(); render();
    _showDndToast('âŒ Erreur sauvegarde');
  }
}

window.pmResizeDown = pmResizeDown;

function _showDndToast(msg){
  const el=document.getElementById('dnd-toast');
  if(!el)return;
  el.textContent=msg;el.classList.add('show');
  clearTimeout(el._t);el._t=setTimeout(()=>el.classList.remove('show'),2800);
}

window.pmGanttDown=pmGanttDown;
window.pmTlDown=pmTlDown;
// CompatibilitÃ© anciens appels (ne font plus rien de dangereux)
function dndStart(){}function dndEnd(){}function dndOver(){}function dndLeave(){}function dndDrop(){}
window.dndStart=dndStart;window.dndEnd=dndEnd;window.dndOver=dndOver;window.dndLeave=dndLeave;window.dndDrop=dndDrop;

// â”€â”€ EDIT / DEL â”€â”€
function editCr(k,itemId){
  const items=(_cr[k]?.items||[]);
  const it=items.find(i=>i.id===itemId);
  if(!it)return;
  _editId={k,itemId};
  const[date,eid]=k.split('_');
  document.getElementById('cr-title').textContent='âœï¸ Modifier le crÃ©neau';
  document.getElementById('cr-del').style.display='block';
  document.getElementById('cr-emp').value=eid;
  document.getElementById('cr-date').value=date;
  document.getElementById('cr-note').value=it.note||'';
  _plages=it.plages?JSON.parse(JSON.stringify(it.plages)):[{deb:it.deb||'09:00',fin:it.fin||'17:00'}];
  setType(it.type||'travail',document.querySelector(`.type-btn[data-type="${it.type||'travail'}"]`));
  toggleMulti(false);
  onEmpChange();
  renderPresets();
  renderPlages();
  document.getElementById('modalCr').classList.add('show');
}
window.editCr=editCr;

async function delCr(){
  if(!_editId)return;
  const{k,itemId}=_editId;
  const it=(_cr[k]?.items||[]).find(i=>i.id===itemId);
  // Si l'item fait partie d'une rÃ©currence, proposer les 2 options
  if(it?.recurId){
    showDelRecurModal(k,itemId,it.recurId);
    return;
  }
  _cr[k].items=(_cr[k].items||[]).filter(i=>i.id!==itemId);
  await saveKey(k,k.split('_')[0]);
  closeCr();await loadCr();render();showToast('CrÃ©neau supprimÃ©');
}
window.delCr=delCr;

// Modal de confirmation de suppression rÃ©currence
function showDelRecurModal(k,itemId,recurId){
  const existing=document.getElementById('delRecurModal');
  if(existing)existing.remove();
  const m=document.createElement('div');
  m.id='delRecurModal';
  m.style.cssText='position:fixed;inset:0;background:rgba(15,31,92,.5);backdrop-filter:blur(4px);z-index:400;display:flex;align-items:center;justify-content:center';
  m.innerHTML=`
    <div style="background:white;border-radius:16px;width:100%;max-width:380px;padding:24px;box-shadow:0 24px 60px rgba(0,0,0,.2)">
      <div style="font-size:22px;text-align:center;margin-bottom:12px">ğŸ”</div>
      <div style="font-size:15px;font-weight:800;text-align:center;margin-bottom:8px">Supprimer la rÃ©currence</div>
      <div style="font-size:13px;color:#6b7280;text-align:center;margin-bottom:20px">Ce crÃ©neau fait partie d'une sÃ©rie rÃ©currente. Que voulez-vous supprimer ?</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <button onclick="delSingleOccurrence('${k}','${itemId}')" 
          style="padding:12px;background:#fef2f2;border:2px solid #fecaca;border-radius:10px;cursor:pointer;font-family:inherit;font-size:13px;font-weight:700;color:#b91c1c;text-align:left">
          ğŸ—‘ Supprimer uniquement ce crÃ©neau
          <div style="font-size:11px;font-weight:400;color:#9ca3af;margin-top:2px">Les autres occurrences de la sÃ©rie restent</div>
        </button>
        <button onclick="delAllRecurrence('${recurId}')" 
          style="padding:12px;background:#fff7ed;border:2px solid #fed7aa;border-radius:10px;cursor:pointer;font-family:inherit;font-size:13px;font-weight:700;color:#c2410c;text-align:left">
          ğŸ—‘ğŸ—‘ Supprimer toute la sÃ©rie (${recurId.slice(0,6)}â€¦)
          <div style="font-size:11px;font-weight:400;color:#9ca3af;margin-top:2px">Supprime toutes les occurrences passÃ©es et futures</div>
        </button>
        <button onclick="document.getElementById('delRecurModal').remove()" 
          style="padding:10px;background:white;border:1.5px solid #e2e8f0;border-radius:10px;cursor:pointer;font-family:inherit;font-size:13px;color:#374151">
          Annuler
        </button>
      </div>
    </div>`;
  document.body.appendChild(m);
}
window.showDelRecurModal=showDelRecurModal;

async function delSingleOccurrence(k,itemId){
  document.getElementById('delRecurModal')?.remove();
  if(!_cr[k])return;
  _cr[k].items=(_cr[k].items||[]).filter(i=>i.id!==itemId);
  await saveKey(k,k.split('_')[0]);
  closeCr();await loadCr();render();showToast('CrÃ©neau supprimÃ©','ok');
}
window.delSingleOccurrence=delSingleOccurrence;

async function delAllRecurrence(recurId){
  document.getElementById('delRecurModal')?.remove();
  // Chercher TOUS les items avec ce recurId dans _cr (toutes semaines chargÃ©es)
  const toSave=new Set();
  Object.keys(_cr).forEach(k=>{
    const before=_cr[k].items?.length||0;
    _cr[k].items=(_cr[k].items||[]).filter(i=>i.recurId!==recurId);
    if(_cr[k].items.length!==before) toSave.add(k);
  });
  // Sauvegarder les clÃ©s modifiÃ©es + recharger le mois pour rattraper les semaines non chargÃ©es
  const btn=document.getElementById('save-btn');
  let done=0;
  for(const k of toSave){
    await saveKey(k,k.split('_')[0]);
    done++;
  }
  closeCr();
  // Recharger toutes les semaines du mois courant pour purger cÃ´tÃ© Firebase aussi
  await deleteRecurFromFirebase(recurId);
  await loadCr();render();
  showToast(`ğŸ—‘ SÃ©rie supprimÃ©e (${done} crÃ©neau(x))`, 'ok');
}
window.delAllRecurrence=delAllRecurrence;

// Purge Firebase : parcourt les semaines du mois courant et mois suivant
async function deleteRecurFromFirebase(recurId){
  try{
    const keys=new Set();
    // Mois courant + mois suivant (couvre la plupart des rÃ©currences)
    for(let m=0;m<3;m++){
      const ref=new Date(_cur.getFullYear(),_cur.getMonth()+m,1);
      let d=new Date(ref);
      const stop=new Date(ref.getFullYear(),ref.getMonth()+1,1);
      while(d<stop){ keys.add(weekKey(d)); d.setDate(d.getDate()+7); }
    }
    for(const wk of keys){
      const snap=await window._getDocs(window._col(window._db,'rh',window._uid,wk));
      for(const docSnap of snap.docs){
        const data=docSnap.data();
        const items=(data.items||[]);
        const filtered=items.filter(i=>i.recurId!==recurId);
        if(filtered.length!==items.length){
          const k=docSnap.id;
          _cr[k]={...(data),items:filtered};
          await window._setDoc(window._doc(window._db,'rh',window._uid,wk,k),{...data,items:filtered});
        }
      }
    }
  }catch(e){console.warn('[deleteRecurFromFirebase]',e);}
}
window.deleteRecurFromFirebase=deleteRecurFromFirebase;

async function qDel(k,id){
  if(!_cr[k])return;
  _cr[k].items=(_cr[k].items||[]).filter(i=>i.id!==id);
  await saveKey(k,k.split('_')[0]);
  await loadCr();render();showToast('SupprimÃ©');
}
window.qDel=qDel;

// â”€â”€ IA â”€â”€
function openAI(){
  document.getElementById('ai-period-label').textContent=document.getElementById('week-label').textContent;
  document.getElementById('ai-res-wrap').style.display='none';
  document.getElementById('ai-apply-btn').style.display='none';
  _aiResult=null;
  document.getElementById('modalAI').classList.add('show');
}
window.openAI=openAI;
function closeAI(){document.getElementById('modalAI').classList.remove('show');}
window.closeAI=closeAI;

async function genAI(){
  const btn=document.getElementById('ai-gen-btn');
  btn.disabled=true;btn.textContent='â³â€¦';
  const days=_view==='mois'?[...Array(7)].map((_,i)=>{const d=new Date(_cur);d.setDate(1+i);return d;}):weekDays(_cur);

  const empStr=_emps.map(e=>{
    const comps=(e.competences||[]).map(c=>c.nom||c).join(', ');
    return `- ${e.prenom||''} ${e.nom||''} (${e.typeContrat||'CDI'}, ${e.heuresHebdo||35}h/sem, poste: ${e.poste||'non prÃ©cisÃ©'}${comps?', compÃ©tences: '+comps:''}, CCN: ${getCCN(e).label})`;
  }).join('\n');

  const prompt=`Tu es un assistant RH expert en planification. GÃ©nÃ¨re un planning optimisÃ© pour la pÃ©riode du ${days[0].toLocaleDateString('fr-FR')} au ${days[days.length-1].toLocaleDateString('fr-FR',{year:'numeric'})}.

Ã‰QUIPE :
${empStr||'Aucun employÃ© renseignÃ©'}

CONTRAINTES :
- Horaires d'activitÃ© : ${document.getElementById('ai-op').value} â†’ ${document.getElementById('ai-cl').value}
- Minimum ${document.getElementById('ai-ms').value} personne(s) par shift
- ${document.getElementById('ai-rd').value} jour(s) de repos par semaine par employÃ©
- Respecter les durÃ©es contractuelles
- Respecter les CCN (repos 11h inter-shift, pauses obligatoires)
- Prendre en compte les compÃ©tences pour la polyvalence
${document.getElementById('ai-inst').value?'\nINSTRUCTIONS SPÃ‰CIFIQUES :\n'+document.getElementById('ai-inst').value:''}

RÃ©ponds UNIQUEMENT en JSON valide sans markdown :
{"planning":[{"nom":"PrÃ©nom Nom","semaine":[{"jour":"lundi","date":"YYYY-MM-DD","type":"travail","deb":"HH:MM","fin":"HH:MM","note":"poste"},{"jour":"mardi","date":"YYYY-MM-DD","type":"repos"}]}],"resume":"rÃ©sumÃ© en 1 phrase","conseils":["conseil 1","conseil 2"]}`;

  const wrap=document.getElementById('ai-res-wrap');
  const box=document.getElementById('ai-res-content');
  wrap.style.display='block';
  box.innerHTML=`<div class="ai-think"><div class="ai-d"></div><div class="ai-d"></div><div class="ai-d"></div><span style="margin-left:8px">Analyse de l'Ã©quipe et gÃ©nÃ©ration du planningâ€¦</span></div>`;

  try{
    const res=await fetch('/api/rh-planning-ai',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt,max_tokens:3000})});
    if(!res.ok){const err=await res.json().catch(()=>({}));throw new Error(err.error||'Erreur serveur '+res.status);}
    const data=await res.json();
    const raw=(data.text||'').replace(/```json|```/g,'').trim();
    _aiResult=JSON.parse(raw);
    const TC={travail:'#dcfce7',repos:'#f3f4f6',conge:'#dbeafe',maladie:'#fee2e2',formation:'#fef3c7',astreinte:'#ede9fe'};
    const TT={travail:'#166534',repos:'#6b7280',conge:'#1e40af',maladie:'#991b1b',formation:'#92400e',astreinte:'#5b21b6'};

    let h=_aiResult.resume?`<div style="font-size:11px;color:rgba(255,255,255,.65);margin-bottom:10px;padding:8px 10px;background:rgba(255,255,255,.07);border-radius:6px">ğŸ“Š ${_aiResult.resume}</div>`:'';
    if(_aiResult.conseils?.length){
      h+=`<div style="margin-bottom:10px">${(_aiResult.conseils||[]).map(c=>`<div style="font-size:10px;color:rgba(255,255,255,.5);padding:3px 0">ğŸ’¡ ${c}</div>`).join('')}</div>`;
    }
    (_aiResult.planning||[]).forEach(ep=>{
      h+=`<div class="ai-emp-row"><div class="ai-emp-n">${ep.nom}</div><div class="ai-shifts">
        ${(ep.semaine||[]).map(s=>`<div class="ai-sp" style="background:${TC[s.type]||'#f3f4f6'};color:${TT[s.type]||'#374151'}" title="${s.jour} â€” ${s.type==='travail'?s.deb+'â†’'+s.fin:s.type}">${(s.jour||'').slice(0,2).toUpperCase()} ${s.type==='travail'?(s.deb+'â€“'+s.fin):s.type.slice(0,3).toUpperCase()}</div>`).join('')}
      </div></div>`;
    });
    box.innerHTML=h;
    document.getElementById('ai-apply-btn').style.display='block';
  }catch(e){box.innerHTML=`<div style="color:#f87171;font-size:12px">âŒ Erreur : ${e.message}. RÃ©essayez.</div>`;}
  btn.disabled=false;btn.textContent='âœ¨ RegÃ©nÃ©rer';
}
window.genAI=genAI;

async function applyAI(){
  if(!_aiResult)return;
  const btn=document.getElementById('ai-apply-btn');btn.textContent='â³â€¦';btn.disabled=true;
  let count=0;
  for(const ep of (_aiResult.planning||[])){
    const emp=_emps.find(e=>`${e.prenom||''} ${e.nom||''}`.trim()===ep.nom?.trim());
    if(!emp)continue;
    for(const s of (ep.semaine||[])){
      if(!s.date||s.type==='repos')continue;
      const k=`${s.date}_${emp.id}`;
      if(!_cr[k])_cr[k]={items:[]};
      _cr[k].items.push({id:'ai'+Date.now()+Math.random().toString(36).slice(2),type:s.type||'travail',deb:s.deb||'',fin:s.fin||'',note:s.note||''});
      await saveKey(k,s.date);count++;
    }
  }
  closeAI();await loadCr();render();showToast(`âœ… ${count} crÃ©neau(x) appliquÃ©s`,'ok');
}
window.applyAI=applyAI;

// â”€â”€ POLYVALENCE â”€â”€
function openPolyPanel(){
  const grid=document.getElementById('poly-grid-content');
  const matrix=document.getElementById('poly-matrix');
  if(!grid||!matrix)return;

  // Collecter tous les postes/compÃ©tences
  const postes=new Set();
  _emps.forEach(e=>(e.competences||[]).forEach(c=>postes.add(c.nom||c)));
  const postesList=[...postes].sort();

  // Cartes employÃ©s
  grid.innerHTML=_emps.map((e,i)=>{
    const cc=COLS[i%COLS.length];
    const comps=e.competences||[];
    const contrat=e.typeContrat||'CDI';
    const hebb=e.heuresHebdo||35;
    return `<div class="poly-emp-card">
      <div class="poly-emp-name">
        <div class="${cc} ge-av" style="width:26px;height:26px;font-size:10px">${(e.prenom||'?')[0]}${(e.nom||'')[0]||''}</div>
        ${e.prenom||''} ${e.nom||''}
        <span style="font-size:9px;font-weight:600;color:var(--muted);margin-left:4px">${contrat}Â·${hebb}h</span>
      </div>
      ${comps.length?`<div class="poly-comp-list">${comps.map(c=>`<div class="poly-comp-row">
        <span class="poly-comp-name">${c.nom||c}</span>
        <div class="poly-stars">${[1,2,3,4,5].map(n=>`<span class="poly-star ${(c.niveau||3)>=n?'on':''}">â˜…</span>`).join('')}</div>
      </div>`).join('')}</div>`
      :`<div style="font-size:11px;color:var(--muted);font-style:italic">Aucune compÃ©tence renseignÃ©e</div>`}
      <div class="poly-avail-bar" title="DisponibilitÃ© contractuelle"><div class="poly-avail-fill" style="width:${Math.min(hebb/40*100,100)}%"></div></div>
    </div>`;
  }).join('');

  // Matrice
  if(postesList.length>0){
    matrix.innerHTML=`<table style="border-collapse:collapse;font-size:11px;width:100%">
      <thead><tr>
        <th style="padding:6px 10px;text-align:left;border-bottom:1px solid var(--border);font-weight:700;color:var(--muted)">Poste</th>
        ${_emps.map(e=>`<th style="padding:6px 8px;text-align:center;border-bottom:1px solid var(--border);font-weight:700;color:var(--text);white-space:nowrap;font-size:10px">${e.prenom||''}</th>`).join('')}
        <th style="padding:6px 8px;text-align:center;border-bottom:1px solid var(--border);font-weight:700;color:var(--muted)">Couverture</th>
      </tr></thead>
      <tbody>${postesList.map(poste=>{
        const coverage=_emps.filter(e=>(e.competences||[]).some(c=>(c.nom||c)===poste));
        return `<tr>
          <td style="padding:7px 10px;font-weight:600;border-bottom:1px solid #f1f5f9">${poste}</td>
          ${_emps.map(e=>{
            const comp=(e.competences||[]).find(c=>(c.nom||c)===poste);
            return `<td style="text-align:center;padding:7px 8px;border-bottom:1px solid #f1f5f9">${comp?`<span style="color:${comp.niveau>=4?'var(--rh-main)':comp.niveau>=3?'var(--orange)':'var(--muted)'}">â˜…${comp.niveau||3}</span>`:'<span style="color:#e5e7eb">â€”</span>'}</td>`;
          }).join('')}
          <td style="text-align:center;padding:7px 8px;border-bottom:1px solid #f1f5f9">
            <span style="background:${coverage.length>=3?'#dcfce7':coverage.length>=2?'#fef3c7':'#fee2e2'};color:${coverage.length>=3?'#166534':coverage.length>=2?'#92400e':'#991b1b'};padding:2px 7px;border-radius:4px;font-weight:700;font-size:10px">${coverage.length} emp.</span>
          </td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  } else {
    matrix.innerHTML=`<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">Renseignez des compÃ©tences dans les fiches employÃ©s pour afficher la matrice.</div>`;
  }

  document.getElementById('modalPoly').classList.add('show');
}
window.openPolyPanel=openPolyPanel;
function closePoly(){document.getElementById('modalPoly').classList.remove('show');}
window.closePoly=closePoly;

// â”€â”€ EXPORT â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IMPRESSION â€” moteur multi-vues
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Couleurs par type (fond, texte, bordure)
const PRINT_COLORS = {
  travail:   ['#d1fae5','#065f46','#6ee7b7'],
  partiel:   ['#fed7aa','#7c2d12','#fb923c'],
  conge:     ['#dbeafe','#1e3a8a','#93c5fd'],
  maladie:   ['#fee2e2','#7f1d1d','#fca5a5'],
  formation: ['#fef9c3','#713f12','#fde047'],
  astreinte: ['#ede9fe','#3b0764','#a78bfa'],
  repos:     ['#f3f4f6','#374151','#d1d5db'],
  autre:     ['#f0fdf4','#166534','#86efac'],
};

function _printItemLines(items){
  // Retourne les lignes HTML pour une cellule (tableau gantt/mois)
  if(!items.length) return '<span style="color:#d1d5db">â€”</span>';
  return items.map(it=>{
    const plages = it.plages&&it.plages.length>0 ? it.plages : (it.deb?[{deb:it.deb,fin:it.fin}]:[]);
    const h = plages.reduce((s,p)=>s+diffH(p.deb,p.fin),0);
    const [bg,fg,br] = PRINT_COLORS[it.type]||PRINT_COLORS.autre;
    const showH = ['travail','partiel','formation','astreinte'].includes(it.type);
    const timeStr = showH ? plages.map(p=>`${p.deb}â€“${p.fin}`).join(' | ') : (TYPE_LBL[it.type]||it.type);
    const durStr = h>0 ? ` <span style="opacity:.65;font-size:9px">${fmtDur(h)}</span>` : '';
    const note = it.note ? ` <span style="opacity:.6;font-size:9px;font-style:italic">${it.note}</span>` : '';
    return `<div style="margin:1px 0;padding:2px 5px;border-radius:4px;background:${bg};color:${fg};border-left:3px solid ${br};font-size:10px;font-weight:600;line-height:1.4">
      ${TYPE_ICO[it.type]||''} ${timeStr}${durStr}${note}
    </div>`;
  }).join('');
}

function _printDayTotal(items){
  const h = items.filter(it=>['travail','partiel'].includes(it.type)).reduce((s,it)=>s+itemH(it),0);
  return h>0 ? `<div style="font-size:9px;color:#6b7280;margin-top:2px;font-weight:600">${fmtDur(h)}</div>` : '';
}

function exportPDF(){
  const vis = visibleEmps();
  const now = new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'});
  const label = document.getElementById('week-label')?.textContent || '';
  const companyEl = document.getElementById('uname');
  const company = companyEl ? companyEl.textContent : 'ALTEORE';

  let pageTitle = `Planning RH â€” ${label}`;
  let body = '';
  let landscape = true;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // VUE SEMAINE GANTT + VUE MOIS
  // Tableau : employÃ©s en lignes, jours en colonnes
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(_view==='semaine' && _disp==='gantt' || _view==='mois'){
    const days = _view==='mois'
      ? monthDays(_cur).filter(x=>x.cur).map(x=>x.date)
      : weekDays(_cur);
    const isMois = _view==='mois';

    // Totaux hebdo par employÃ©
    const empTotals = {};
    vis.forEach(e=>{
      const h = days.reduce((s,d)=>{
        const items = (_cr[`${fmt(d)}_${e.id}`]?.items||[]);
        return s + items.filter(it=>['travail','partiel'].includes(it.type)).reduce((s2,it)=>s2+itemH(it),0);
      },0);
      empTotals[e.id] = h;
    });

    const thead = `<thead><tr>
      <th style="width:130px">EmployÃ©</th>
      ${days.map(d=>{
        const we = isWE(d);
        const today = isToday(d);
        return `<th style="${we?'background:#f1f5f9;color:#94a3b8':''}${today?'background:#ecfdf5;color:#059669':''}">${d.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric',month:isMois?'short':'short'})}</th>`;
      }).join('')}
      <th style="width:60px;background:#f8faff">Total</th>
    </tr></thead>`;

    const tbody = vis.map(e=>{
      const cells = days.map(d=>{
        const we=isWE(d);
        const items=(_cr[`${fmt(d)}_${e.id}`]?.items||[]);
        return `<td class="dcell" style="${we?'background:#fafafa':''}">
          ${_printItemLines(items)}
          ${_printDayTotal(items)}
        </td>`;
      }).join('');
      const tot = empTotals[e.id];
      const poste = e.poste||'';
      return `<tr>
        <td class="emp-cell">
          <div style="font-weight:800;font-size:11px">${e.prenom||''} ${e.nom||''}</div>
          ${poste?`<div style="font-size:9px;color:#6b7280;margin-top:1px">${poste}</div>`:''}
        </td>
        ${cells}
        <td style="text-align:center;background:#f0fdf4;font-weight:800;font-size:11px;color:#059669">${tot>0?fmtDur(tot):'â€”'}</td>
      </tr>`;
    }).join('');

    body = `<table class="main-table"><${thead}<tbody>${tbody}</tbody></table>`;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // VUE SEMAINE TIMELINE â†’ une page par jour
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  } else if(_view==='semaine' && _disp==='timeline'){
    const days = weekDays(_cur);
    const START_H=6, END_H=23, SPAN=(END_H-START_H);
    const ticks = [6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22];

    body = days.map((d,di)=>{
      const dayLabel = d.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});
      const we = isWE(d);
      const today = isToday(d);

      // RÃ¨gle horaire
      const ruler = `<div class="tl-ruler">
        <div class="tl-emp-col"></div>
        <div class="tl-hours-wrap">
          ${ticks.map(hh=>`
            <div class="tl-tick" style="left:${(hh-START_H)/SPAN*100}%">
              <div class="tl-tick-line"></div>
              <span class="tl-tick-lbl">${hh}h</span>
            </div>`).join('')}
        </div>
      </div>`;

      // Lignes employÃ©s
      const empRows = vis.map((e,i)=>{
        const k=`${fmt(d)}_${e.id}`;
        const items=(_cr[k]?.items||[]);
        const totalH=items.filter(it=>['travail','partiel'].includes(it.type)).reduce((s,it)=>s+itemH(it),0);

        const bars = items.map(it=>{
          const plages=it.plages&&it.plages.length>0?it.plages:(it.deb?[{deb:it.deb,fin:it.fin}]:[]);
          return plages.map(p=>{
            const [dh,dm]=(p.deb||'00:00').split(':').map(Number);
            const [fh,fm]=(p.fin||'00:00').split(':').map(Number);
            const left=(dh*60+dm-START_H*60)/(SPAN*60)*100;
            const width=(fh*60+fm-(dh*60+dm))/(SPAN*60)*100;
            if(left>100||left+width<0)return '';
            const [bg,fg,br]=PRINT_COLORS[it.type]||PRINT_COLORS.autre;
            const dur=diffH(p.deb,p.fin);
            return `<div style="position:absolute;left:${Math.max(0,left).toFixed(2)}%;width:${Math.max(0.5,width).toFixed(2)}%;top:4px;bottom:4px;
              background:${bg};border:1.5px solid ${br};border-radius:4px;overflow:hidden;
              display:flex;align-items:center;padding:0 4px;box-sizing:border-box">
              <span style="font-size:8px;font-weight:700;color:${fg};white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
                ${p.deb}â€“${p.fin}${dur>=1?' '+fmtDur(dur):''}${it.note?' Â· '+it.note:''}
              </span>
            </div>`;
          }).join('');
        }).join('');

        const bgRow = i%2===0?'#fff':'#fafafa';
        return `<div class="tl-row-print" style="background:${bgRow}">
          <div class="tl-emp-col">
            <div style="font-weight:700;font-size:10px;line-height:1.2">${e.prenom||''} ${(e.nom||'')[0]||''}.</div>
            ${totalH>0?`<div style="font-size:8px;color:#059669;font-weight:700">${fmtDur(totalH)}</div>`:''}
          </div>
          <div class="tl-bars-wrap" style="position:relative">${bars||'<div style="position:absolute;inset:0;display:flex;align-items:center;padding-left:8px"><span style="font-size:8px;color:#d1d5db">Repos</span></div>'}</div>
        </div>`;
      }).join('');

      const pageBreak = di>0 ? 'page-break-before:always;padding-top:12px;' : '';
      return `<div style="${pageBreak}">
        <div class="day-header" style="${we?'background:#f8faff':today?'background:#ecfdf5;border-color:#6ee7b7':''}">
          ${today?'<span class="today-badge">Aujourd\'hui</span>':''} ${dayLabel}
        </div>
        ${ruler}
        <div class="tl-body">${empRows}</div>
      </div>`;
    }).join('');
    landscape = false; // portrait pour timeline

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // VUE JOUR â€” dÃ©tail complet par employÃ©
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  } else if(_view==='jour'){
    const d = _cur;
    const dayLabel = d.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
    const START_H=6, END_H=23, SPAN=(END_H-START_H);
    const ticks=[6,8,10,12,14,16,18,20,22];

    const ruler = `<div class="tl-ruler" style="margin-bottom:4px">
      <div class="tl-emp-col" style="width:160px"></div>
      <div class="tl-hours-wrap">
        ${ticks.map(hh=>`
          <div class="tl-tick" style="left:${(hh-START_H)/SPAN*100}%">
            <div class="tl-tick-line"></div>
            <span class="tl-tick-lbl">${hh}h</span>
          </div>`).join('')}
      </div>
    </div>`;

    const empRows = vis.map((e,i)=>{
      const k=`${fmt(d)}_${e.id}`;
      const items=(_cr[k]?.items||[]);
      const totalH=items.filter(it=>['travail','partiel'].includes(it.type)).reduce((s,it)=>s+itemH(it),0);
      const poste=e.poste||'';

      const bars=items.map(it=>{
        const plages=it.plages&&it.plages.length>0?it.plages:(it.deb?[{deb:it.deb,fin:it.fin}]:[]);
        return plages.map(p=>{
          const [dh,dm]=(p.deb||'00:00').split(':').map(Number);
          const [fh,fm]=(p.fin||'00:00').split(':').map(Number);
          const left=(dh*60+dm-START_H*60)/(SPAN*60)*100;
          const width=(fh*60+fm-(dh*60+dm))/(SPAN*60)*100;
          if(left>100||left+width<0)return '';
          const [bg,fg,br]=PRINT_COLORS[it.type]||PRINT_COLORS.autre;
          const dur=diffH(p.deb,p.fin);
          return `<div style="position:absolute;left:${Math.max(0,left).toFixed(2)}%;width:${Math.max(1,width).toFixed(2)}%;
            top:6px;bottom:6px;background:${bg};border:1.5px solid ${br};border-radius:5px;
            display:flex;align-items:center;padding:0 6px;box-sizing:border-box">
            <span style="font-size:9px;font-weight:700;color:${fg};white-space:nowrap">
              ${p.deb}â€“${p.fin}${dur>=1?' ('+fmtDur(dur)+')':''}${it.note?' Â· '+it.note:''}
            </span>
          </div>`;
        }).join('');
      }).join('');

      return `<div class="tl-row-print jour-row" style="background:${i%2===0?'#fff':'#fafafa'};height:44px">
        <div class="tl-emp-col" style="width:160px">
          <div style="font-weight:800;font-size:11px">${e.prenom||''} ${e.nom||''}</div>
          ${poste?`<div style="font-size:8px;color:#6b7280">${poste}</div>`:''}
          ${totalH>0?`<div style="font-size:9px;color:#059669;font-weight:700">${fmtDur(totalH)}</div>`:''}
        </div>
        <div class="tl-bars-wrap" style="position:relative">${bars||'<div style="position:absolute;inset:0;display:flex;align-items:center;padding-left:8px"><span style="font-size:9px;color:#d1d5db">â€”</span></div>'}</div>
      </div>`;
    }).join('');

    body = `<div class="day-header jour">${dayLabel}</div>${ruler}<div class="tl-body">${empRows}</div>`;
    landscape = false;
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // LÃ©gende & stats globales
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const types = Object.keys(PRINT_COLORS);
  const legend = `<div class="legend">
    ${types.map(t=>{
      const [bg,fg,br]=PRINT_COLORS[t];
      return `<div class="leg-item"><span class="leg-dot" style="background:${bg};border:1.5px solid ${br};color:${fg}">${TYPE_ICO[t]||''}</span><span>${TYPE_LBL[t]||t}</span></div>`;
    }).join('')}
  </div>`;

  // Stats totales
  const allDays = _view==='mois'?monthDays(_cur).filter(x=>x.cur).map(x=>x.date):_view==='jour'?[_cur]:weekDays(_cur);
  const statRows = vis.map(e=>{
    const h=allDays.reduce((s,d)=>{
      return s+(_cr[`${fmt(d)}_${e.id}`]?.items||[]).filter(it=>['travail','partiel'].includes(it.type)).reduce((s2,it)=>s2+itemH(it),0);
    },0);
    const absences=allDays.reduce((s,d)=>s+(_cr[`${fmt(d)}_${e.id}`]?.items||[]).filter(it=>['conge','maladie'].includes(it.type)).length,0);
    return h>0||absences>0 ? `<tr><td>${e.prenom||''} ${e.nom||''}</td><td>${h>0?fmtDur(h):'â€”'}</td><td>${absences>0?absences+'j':'â€”'}</td></tr>` : '';
  }).filter(Boolean).join('');

  const stats = statRows ? `<div class="stats-block">
    <div class="stats-title">RÃ©capitulatif des heures</div>
    <table class="stats-table">
      <thead><tr><th>EmployÃ©</th><th>Heures travaillÃ©es</th><th>Absences</th></tr></thead>
      <tbody>${statRows}</tbody>
    </table>
  </div>` : '';

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CSS complet
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const css = `
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Segoe UI',Arial,sans-serif;font-size:11px;color:#1a1f36;background:#fff;padding:14px 16px;}
    .print-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid #e2e8f0;}
    .print-title{font-size:18px;font-weight:800;color:#052e16;}
    .print-sub{font-size:11px;color:#6b7280;margin-top:3px;}
    .print-company{font-size:12px;font-weight:700;color:#059669;}
    .print-date{font-size:10px;color:#94a3b8;margin-top:2px;text-align:right;}

    /* Tableau Gantt/Mois */
    .main-table{width:100%;border-collapse:collapse;font-size:10px;}
    .main-table th{padding:5px 6px;background:#059669;color:white;font-size:9px;font-weight:700;border:1px solid #047857;text-align:center;white-space:nowrap;}
    .main-table th:first-child{text-align:left;}
    .main-table td{border:1px solid #e2e8f0;vertical-align:top;padding:3px 4px;}
    .emp-cell{background:#f8faff;font-size:10px;white-space:nowrap;vertical-align:middle;padding:4px 8px!important;}
    .dcell{min-width:70px;}

    /* Timeline */
    .tl-ruler{display:flex;align-items:flex-end;height:20px;margin-bottom:2px;}
    .tl-emp-col{width:100px;flex-shrink:0;padding-right:6px;}
    .tl-hours-wrap{flex:1;position:relative;height:100%;}
    .tl-tick{position:absolute;height:100%;display:flex;flex-direction:column;align-items:center;}
    .tl-tick-line{width:1px;flex:1;background:#e2e8f0;}
    .tl-tick-lbl{font-size:7px;color:#94a3b8;font-weight:600;white-space:nowrap;transform:translateX(-50%);margin-top:1px;}
    .tl-body{border:1px solid #e2e8f0;border-radius:6px;overflow:hidden;}
    .tl-row-print{display:flex;align-items:stretch;border-bottom:1px solid #f1f5f9;min-height:34px;}
    .tl-row-print:last-child{border-bottom:none;}
    .jour-row{min-height:44px;}
    .tl-emp-col{width:100px;flex-shrink:0;padding:4px 6px;border-right:1px solid #f1f5f9;display:flex;flex-direction:column;justify-content:center;}
    .tl-bars-wrap{flex:1;position:relative;background:repeating-linear-gradient(90deg,transparent,transparent calc(${100/17}% - 1px),#f8faff calc(${100/17}% - 1px),#f8faff calc(${100/17}%));}

    /* Jour header */
    .day-header{font-size:13px;font-weight:800;color:#1a1f36;padding:6px 10px;background:#f8faff;border:1px solid #e2e8f0;border-radius:6px;margin-bottom:6px;display:flex;align-items:center;gap:8px;}
    .day-header.jour{font-size:16px;margin-bottom:10px;}
    .today-badge{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;background:#ecfdf5;color:#059669;border:1px solid #6ee7b7;}

    /* LÃ©gende */
    .legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;padding:8px 10px;background:#f8faff;border-radius:6px;border:1px solid #e2e8f0;}
    .leg-item{display:flex;align-items:center;gap:4px;font-size:9px;color:#374151;}
    .leg-dot{padding:1px 5px;border-radius:3px;font-size:9px;}

    /* Stats */
    .stats-block{margin-top:12px;page-break-inside:avoid;}
    .stats-title{font-size:11px;font-weight:700;color:#374151;margin-bottom:6px;}
    .stats-table{border-collapse:collapse;font-size:10px;}
    .stats-table th{padding:4px 10px;background:#f1f5f9;font-size:9px;font-weight:700;border:1px solid #e2e8f0;text-align:left;}
    .stats-table td{padding:4px 10px;border:1px solid #f1f5f9;}
    .stats-table tr:nth-child(even) td{background:#fafafa;}

    @media print{
      @page{margin:.6cm;size:A4 ${landscape?'landscape':'portrait'};}
      body{padding:0;}
      .no-print{display:none!important;}
    }
  `;

  const html = `<!DOCTYPE html><html lang="fr"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>${pageTitle}</title>
    <style>${css}</style>
  </head><body>
    <div class="print-header">
      <div>
        <div class="print-company">ALTEORE Â· ${company}</div>
        <div class="print-title">${pageTitle}</div>
        <div class="print-sub">${vis.length} employÃ©(s) Â· GÃ©nÃ©rÃ© le ${now}</div>
      </div>
      <div class="print-date">
        <button class="no-print" onclick="window.print()" style="padding:7px 16px;background:#059669;color:white;border:none;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit">ğŸ–¨ï¸ Imprimer / PDF</button>
        <div style="margin-top:6px;color:#94a3b8;font-size:10px">Ctrl+P ou Cmd+P</div>
      </div>
    </div>
    ${body}
    ${legend}
    ${stats}
    <script>
      // Auto-print aprÃ¨s chargement
      // DÃ©commentez si vous voulez l'impression automatique :
      // window.onload = () => window.print();
    <\/script>
  </body></html>`;

  const w = window.open('','_blank','width=1000,height=800');
  if(!w){ alert('Veuillez autoriser les pop-ups pour imprimer.'); return; }
  w.document.write(html);
  w.document.close();
}
window.exportPDF=exportPDF;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// IMPRESSION PLANNING MENSUEL INDIVIDUEL
// Une page A4 portrait par salariÃ© â€” tous les jours du mois
// avec horaires dÃ©taillÃ©s, totaux et rÃ©capitulatif
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportPlanningMensuelSalarie(){
  const vis = visibleEmps();
  if(!vis.length){ alert('Aucun employÃ© visible Ã  imprimer.'); return; }

  const refDate = new Date(_cur);
  const year = refDate.getFullYear();
  const month = refDate.getMonth();
  const monthLabel = refDate.toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
  const now = new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'});
  const companyEl = document.getElementById('uname');
  const company = companyEl ? companyEl.textContent : 'ALTEORE';

  // Tous les jours du mois (sans padding)
  const allDays = [];
  const tmp = new Date(year, month, 1);
  while(tmp.getMonth() === month){ allDays.push(new Date(tmp)); tmp.setDate(tmp.getDate()+1); }

  function buildEmpPage(e, isLast){
    // RÃ©cap mensuel
    let totalH=0, totalTravailJ=0, totalCongeJ=0, totalMaladieJ=0;
    allDays.forEach(d=>{
      const items=(_cr[`${fmt(d)}_${e.id}`]?.items||[]);
      const h=items.filter(it=>['travail','partiel'].includes(it.type)).reduce((s,it)=>s+itemH(it),0);
      totalH+=h;
      if(h>0) totalTravailJ++;
      if(items.some(it=>it.type==='conge')) totalCongeJ++;
      if(items.some(it=>it.type==='maladie')) totalMaladieJ++;
    });

    // Grouper par semaine lunâ†’dim avec padding
    const weeks=[];
    let week=[];
    allDays.forEach((d,i)=>{
      if(i===0){ const dow=d.getDay()===0?6:d.getDay()-1; for(let p=0;p<dow;p++) week.push(null); }
      week.push(d);
      const dow=d.getDay()===0?6:d.getDay()-1;
      if(dow===6){ weeks.push(week); week=[]; }
    });
    if(week.length){ while(week.length<7) week.push(null); weeks.push(week); }

    const headerHtml=`
      <div class="page-header">
        <div>
          <div class="emp-name">${e.prenom||''} ${e.nom||''}</div>
          <div class="emp-meta">${[e.poste,e.contrat].filter(Boolean).join(' Â· ')||'â€”'}</div>
        </div>
        <div style="text-align:right">
          <div class="month-label">ğŸ“… ${monthLabel.charAt(0).toUpperCase()+monthLabel.slice(1)}</div>
          <div class="company-lbl">ğŸ¢ ${company}</div>
          <div class="print-date-lbl">Ã‰ditÃ© le ${now}</div>
        </div>
      </div>`;

    const recapHtml=`
      <div class="recap-bar">
        <div class="recap-item green"><span class="recap-val">${fmtDur(totalH)}</span><span class="recap-lbl">Heures travaillÃ©es</span></div>
        <div class="recap-item blue"><span class="recap-val">${totalTravailJ}j</span><span class="recap-lbl">Jours travaillÃ©s</span></div>
        <div class="recap-item orange"><span class="recap-val">${totalCongeJ}j</span><span class="recap-lbl">CongÃ©s</span></div>
        <div class="recap-item red"><span class="recap-val">${totalMaladieJ}j</span><span class="recap-lbl">Absences maladie</span></div>
      </div>`;

    const DOW_LBL=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
    const tbodyHtml=weeks.map(wk=>{
      const cells=wk.map((d,i)=>{
        if(!d) return `<td class="empty-cell"></td>`;
        const we=i>=5, today=isToday(d);
        const items=(_cr[`${fmt(d)}_${e.id}`]?.items||[]);
        const hTot=items.filter(it=>['travail','partiel'].includes(it.type)).reduce((s,it)=>s+itemH(it),0);
        const dayNum=`<div class="day-num ${today?'today-num':''} ${we?'we-num':''}">${d.getDate()}</div>`;
        let contentHtml='';
        if(!items.length){
          contentHtml=we?`<div class="day-rest">WE</div>`:`<div class="day-rest">â€”</div>`;
        } else {
          contentHtml=items.map(it=>{
            const plages=it.plages&&it.plages.length>0?it.plages:(it.deb?[{deb:it.deb,fin:it.fin}]:[]);
            const [bg,fg,br]=PRINT_COLORS[it.type]||PRINT_COLORS.autre;
            const showTime=['travail','partiel','formation','astreinte'].includes(it.type);
            const timeLines=showTime?plages.map(p=>`<span class="plage-time">${p.deb}â€“${p.fin}</span>`).join(''):`<span class="type-lbl">${TYPE_LBL[it.type]||it.type}</span>`;
            const itH=plages.reduce((s,p)=>s+diffH(p.deb,p.fin),0);
            const durStr=showTime&&itH>0?`<span class="dur-lbl">${fmtDur(itH)}</span>`:'';
            const noteStr=it.note?`<span class="note-lbl">${it.note}</span>`:'';
            return `<div class="item-pill" style="background:${bg};border-left:2px solid ${br};color:${fg}">${TYPE_ICO[it.type]||''} ${timeLines}${durStr}${noteStr}</div>`;
          }).join('');
          if(hTot>0) contentHtml+=`<div class="day-total">${fmtDur(hTot)}</div>`;
        }
        return `<td class="day-cell ${we?'we-cell':''} ${today?'today-cell':''}">${dayNum}<div class="day-content">${contentHtml}</div></td>`;
      }).join('');
      const weekH=wk.filter(Boolean).reduce((s,d)=>s+(_cr[`${fmt(d)}_${e.id}`]?.items||[]).filter(it=>['travail','partiel'].includes(it.type)).reduce((s2,it)=>s2+itemH(it),0),0);
      return `<tr>${cells}<td class="week-total-cell">${weekH>0?fmtDur(weekH):'â€”'}</td></tr>`;
    }).join('');

    const tableHtml=`
      <div class="cal-wrap">
        <table class="cal-table">
          <thead><tr>${DOW_LBL.map((l,i)=>`<th class="${i>=5?'we-th':''}">${l}</th>`).join('')}<th class="week-total-th">Sem.</th></tr></thead>
          <tbody>${tbodyHtml}</tbody>
        </table>
      </div>`;

    const legendHtml=`
      <div class="legend-row">
        ${Object.keys(PRINT_COLORS).map(t=>{const [bg,,br]=PRINT_COLORS[t];return `<div class="leg-item"><span class="leg-dot" style="background:${bg};border:1px solid ${br}"></span>${TYPE_ICO[t]||''} ${TYPE_LBL[t]||t}</div>`;}).join('')}
      </div>`;

    return `<div class="emp-page" style="${isLast?'':'page-break-after:always;'}">${headerHtml}${recapHtml}${tableHtml}${legendHtml}</div>`;
  }

  const pagesHtml=vis.map((e,i)=>buildEmpPage(e,i===vis.length-1)).join('');

  const css=`
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Segoe UI',Arial,sans-serif;font-size:10px;color:#1a1f36;background:#fff;}
    .emp-page{padding:6px 8px;}
    .page-header{display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:5px;border-bottom:2px solid #059669;margin-bottom:5px;}
    .emp-name{font-size:15px;font-weight:800;color:#052e16;}
    .emp-meta{font-size:10px;color:#6b7280;margin-top:2px;}
    .month-label{font-size:12px;font-weight:800;color:#1a1f36;}
    .company-lbl{font-size:10px;color:#059669;font-weight:700;margin-top:2px;}
    .print-date-lbl{font-size:9px;color:#94a3b8;margin-top:2px;}
    .recap-bar{display:flex;gap:5px;margin-bottom:5px;}
    .recap-item{flex:1;padding:3px 5px;border-radius:5px;text-align:center;display:flex;flex-direction:column;gap:1px;}
    .recap-item.green{background:#d1fae5;border:1px solid #6ee7b7;}
    .recap-item.blue{background:#dbeafe;border:1px solid #93c5fd;}
    .recap-item.orange{background:#fed7aa;border:1px solid #fb923c;}
    .recap-item.red{background:#fee2e2;border:1px solid #fca5a5;}
    .recap-val{font-size:12px;font-weight:800;color:#1a1f36;}
    .recap-lbl{font-size:8px;color:#6b7280;font-weight:600;text-transform:uppercase;letter-spacing:.3px;}
    .cal-wrap{margin-bottom:4px;}
    .cal-table{width:100%;border-collapse:collapse;table-layout:fixed;}
    .cal-table th{padding:3px 2px;text-align:center;font-size:9px;font-weight:700;background:#059669;color:white;border:1px solid #047857;}
    .cal-table th.we-th{background:#4b5563;}
    .cal-table th.week-total-th{background:#1e3a8a;color:white;width:36px;font-size:8px;}
    .day-cell{border:1px solid #e2e8f0;vertical-align:top;padding:2px;height:60px;overflow:hidden;word-break:break-word;}
    .day-cell.we-cell{background:#f9fafb;}
    .day-cell.today-cell{background:#ecfdf5;border-color:#6ee7b7;}
    .empty-cell{border:1px solid #f1f5f9;background:#fafafa;}
    .week-total-cell{border:1px solid #e2e8f0;text-align:center;vertical-align:middle;font-size:10px;font-weight:800;color:#1e3a8a;background:#eff6ff;width:36px;}
    .day-num{font-size:10px;font-weight:800;color:#374151;margin-bottom:2px;line-height:1;}
    .day-num.today-num{color:#059669;}
    .day-num.we-num{color:#9ca3af;}
    .day-content{display:flex;flex-direction:column;gap:1px;}
    .item-pill{padding:1px 3px;border-radius:3px;font-size:8px;font-weight:600;line-height:1.3;display:flex;flex-wrap:wrap;align-items:center;gap:1px;word-break:break-word;overflow:hidden;}
    .plage-time{font-size:8px;font-weight:700;white-space:nowrap;}
    .type-lbl{font-size:8px;font-weight:600;}
    .dur-lbl{font-size:7.5px;opacity:.7;margin-left:1px;}
    .note-lbl{font-size:7px;font-style:italic;opacity:.7;width:100%;}
    .day-total{font-size:8px;font-weight:800;color:#059669;margin-top:1px;text-align:right;}
    .day-rest{font-size:8px;color:#d1d5db;font-weight:500;margin-top:2px;}
    .legend-row{display:flex;flex-wrap:wrap;gap:5px;padding:5px 6px;background:#f8faff;border-radius:5px;border:1px solid #e2e8f0;}
    .leg-item{display:flex;align-items:center;gap:3px;font-size:8px;color:#374151;}
    .leg-dot{width:8px;height:8px;border-radius:2px;flex-shrink:0;}
    @media print{
      @page{size:A4 portrait;margin:0.4cm 0.35cm 0.4cm 0.35cm;}
      body{padding:0;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
      .emp-page{padding:0;}
      .no-print{display:none!important;}
    }`;

  const html=`<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>Planning individuel â€” ${monthLabel}</title><style>${css}</style></head><body>
    <div class="no-print" style="position:fixed;bottom:16px;right:16px;z-index:999;display:flex;align-items:center;gap:10px;background:white;padding:8px 12px;border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,.15)">
      <span style="font-size:11px;color:#6b7280">${vis.length} salariÃ©(s)</span>
      <button onclick="window.print()" style="padding:9px 18px;background:#059669;color:white;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer">ğŸ–¨ï¸ Imprimer / PDF</button>
    </div>
    ${pagesHtml}
  </body></html>`;

  const w=window.open('','_blank','width=900,height=800');
  if(!w){ alert('Veuillez autoriser les pop-ups pour imprimer.'); return; }
  w.document.write(html);
  w.document.close();
}
window.exportPlanningMensuelSalarie=exportPlanningMensuelSalarie;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARAMÃˆTRES ENTREPRISE â€” JOURS FERMETURE & HORAIRES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Jours fÃ©riÃ©s franÃ§ais fixes (ajout automatique de l'annÃ©e courante)
function getFeriesAnnee(year){
  // Calcul PÃ¢ques (algorithme de Butcher)
  const a=year%19,b=Math.floor(year/100),c=year%100,d=Math.floor(b/4),e=b%4;
  const f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30;
  const i=Math.floor(c/4),k=c%4,l=(32+2*e+2*i-h-k)%7;
  const m=Math.floor((a+11*h+22*l)/451);
  const month=Math.floor((h+l-7*m+114)/31);
  const day=((h+l-7*m+114)%31)+1;
  const paques=new Date(year,month-1,day);
  const lPaques=new Date(paques); lPaques.setDate(paques.getDate()+1);
  const ascension=new Date(paques); ascension.setDate(paques.getDate()+39);
  const pentecote=new Date(paques); pentecote.setDate(paques.getDate()+50);
  return [
    {iso:`${year}-01-01`,label:"Jour de l'An"},
    {iso:fmtD(lPaques),label:"Lundi de PÃ¢ques"},
    {iso:`${year}-05-01`,label:"FÃªte du Travail"},
    {iso:`${year}-05-08`,label:"Victoire 1945"},
    {iso:fmtD(ascension),label:"Ascension"},
    {iso:fmtD(pentecote),label:"Lundi de PentecÃ´te"},
    {iso:`${year}-07-14`,label:"FÃªte Nationale"},
    {iso:`${year}-08-15`,label:"Assomption"},
    {iso:`${year}-11-01`,label:"Toussaint"},
    {iso:`${year}-11-11`,label:"Armistice"},
    {iso:`${year}-12-25`,label:"NoÃ«l"},
  ];
}
function fmtD(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}

const DOW_LABELS_PARAMS=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
const DOW_ORDER=[1,2,3,4,5,6,0]; // Lundi en premier

function openParamsEntreprise(){
  renderParamsModal();
  const m=document.getElementById('fermetureModal');
  if(m){m.style.display='flex';}
}
window.openParamsEntreprise=openParamsEntreprise;

// Alias pour compatibilitÃ©
function openFermetureModal(){ openParamsEntreprise(); }
window.openFermetureModal=openFermetureModal;

function closeFermetureModal(){
  const m=document.getElementById('fermetureModal');
  if(m)m.style.display='none';
}
window.closeFermetureModal=closeFermetureModal;

function renderParamsModal(){
  // Horaires
  const ouv=document.getElementById('params-heure-ouv');
  const ferm=document.getElementById('params-heure-ferm');
  if(ouv) ouv.value=_joursFermes.heureOuv||'09:00';
  if(ferm) ferm.value=_joursFermes.heureFerm||'18:00';

  // Grille jours semaine â€” Lundi Ã  Dimanche
  const grid=document.getElementById('ferme-dow-grid');
  if(grid) grid.innerHTML=DOW_ORDER.map((dow,i)=>{
    // Un jour est OUVERT si absent de hebdo (hebdo = jours FERMÃ‰S)
    const ferme=_joursFermes.hebdo.includes(dow);
    return `<button onclick="toggleFermeDow(${dow},this)"
      style="padding:8px 4px;border-radius:9px;border:2px solid ${ferme?'#e2e8f0':'#6366f1'};
      background:${ferme?'#f9fafb':'#eef2ff'};color:${ferme?'#9ca3af':'#4338ca'};
      font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;font-family:inherit;text-align:center">
      <div>${DOW_LABELS_PARAMS[i]}</div>
      <div style="font-size:9px;margin-top:2px;font-weight:600">${ferme?'FermÃ©':'Ouvert'}</div>
    </button>`;
  }).join('');

  // Jours fÃ©riÃ©s
  const year=new Date().getFullYear();
  const feries=getFeriesAnnee(year);
  const feriesGrid=document.getElementById('feries-grid');
  if(feriesGrid) feriesGrid.innerHTML=feries.map(f=>{
    const checked=_joursFermes.ponctuels.includes(f.iso);
    const dateLabel=new Date(f.iso+'T12:00:00').toLocaleDateString('fr-FR',{day:'numeric',month:'long'});
    return `<label style="display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:8px;background:${checked?'#eef2ff':'#f8faff'};border:1.5px solid ${checked?'#c7d2fe':'#e2e8f0'};cursor:pointer;transition:all .12s">
      <input type="checkbox" data-iso="${f.iso}" ${checked?'checked':''} onchange="toggleFerie(this)" style="width:15px;height:15px;accent-color:#6366f1;cursor:pointer;flex-shrink:0"/>
      <div>
        <div style="font-size:12px;font-weight:700;color:#1a1f36">${f.label}</div>
        <div style="font-size:10px;color:#6b7280">${dateLabel} ${year}</div>
      </div>
    </label>`;
  }).join('');

  renderFermeDatesList();
}

function toggleFermeDow(dow,btn){
  const idx=_joursFermes.hebdo.indexOf(dow);
  if(idx>=0) _joursFermes.hebdo.splice(idx,1); // Ã©tait fermÃ© â†’ ouvrir
  else _joursFermes.hebdo.push(dow);            // Ã©tait ouvert â†’ fermer
  const ferme=_joursFermes.hebdo.includes(dow);
  btn.style.border=`2px solid ${ferme?'#e2e8f0':'#6366f1'}`;
  btn.style.background=ferme?'#f9fafb':'#eef2ff';
  btn.style.color=ferme?'#9ca3af':'#4338ca';
  btn.innerHTML=`<div>${btn.querySelector('div').textContent}</div><div style="font-size:9px;margin-top:2px;font-weight:600">${ferme?'FermÃ©':'Ouvert'}</div>`;
}
window.toggleFermeDow=toggleFermeDow;

function toggleFerie(cb){
  const iso=cb.dataset.iso;
  if(cb.checked){
    if(!_joursFermes.ponctuels.includes(iso)) _joursFermes.ponctuels.push(iso);
  } else {
    _joursFermes.ponctuels=_joursFermes.ponctuels.filter(d=>d!==iso);
  }
  // Update label style
  const label=cb.closest('label');
  if(label){
    label.style.background=cb.checked?'#eef2ff':'#f8faff';
    label.style.border=`1.5px solid ${cb.checked?'#c7d2fe':'#e2e8f0'}`;
  }
}
window.toggleFerie=toggleFerie;

function selectAllFeries(val){
  const year=new Date().getFullYear();
  const feries=getFeriesAnnee(year);
  document.querySelectorAll('#feries-grid input[type=checkbox]').forEach(cb=>{
    cb.checked=val;
    toggleFerie(cb);
  });
}
window.selectAllFeries=selectAllFeries;

function addFermetureDate(){
  const val=document.getElementById('ferme-date-input')?.value;
  if(!val){showToast('SÃ©lectionnez une date','warn');return;}
  if(_joursFermes.ponctuels.includes(val)){showToast('Date dÃ©jÃ  ajoutÃ©e','warn');return;}
  _joursFermes.ponctuels.push(val);
  _joursFermes.ponctuels.sort();
  document.getElementById('ferme-date-input').value='';
  renderFermeDatesList();
}
window.addFermetureDate=addFermetureDate;

function addFermeturePlage(){
  const deb=document.getElementById('ferme-range-deb')?.value;
  const fin=document.getElementById('ferme-range-fin')?.value;
  if(!deb||!fin){showToast('SÃ©lectionnez dÃ©but et fin de plage','warn');return;}
  if(deb>fin){showToast('La date de dÃ©but doit Ãªtre avant la fin','warn');return;}
  let d=new Date(deb+'T12:00:00');
  const endD=new Date(fin+'T12:00:00');
  let added=0;
  while(d<=endD){
    const iso=fmtD(d);
    if(!_joursFermes.ponctuels.includes(iso)){_joursFermes.ponctuels.push(iso);added++;}
    d.setDate(d.getDate()+1);
  }
  _joursFermes.ponctuels.sort();
  document.getElementById('ferme-range-deb').value='';
  document.getElementById('ferme-range-fin').value='';
  renderFermeDatesList();
  showToast(`${added} jour(s) ajoutÃ©(s)`,'ok');
}
window.addFermeturePlage=addFermeturePlage;

function removeFermetureDate(iso){
  _joursFermes.ponctuels=_joursFermes.ponctuels.filter(d=>d!==iso);
  renderFermeDatesList();
}
window.removeFermetureDate=removeFermetureDate;

function renderFermeDatesList(){
  const list=document.getElementById('ferme-dates-list');
  if(!list) return;
  // Exclure les jours fÃ©riÃ©s de l'annÃ©e courante (affichÃ©s sÃ©parÃ©ment)
  const year=new Date().getFullYear();
  const feriesIsos=getFeriesAnnee(year).map(f=>f.iso);
  const custom=_joursFermes.ponctuels.filter(iso=>!feriesIsos.includes(iso));
  if(!custom.length){
    list.innerHTML='<div style="font-size:11px;color:#9ca3af;padding:8px 0;font-style:italic">Aucune fermeture exceptionnelle</div>';
    return;
  }
  // Grouper par mois
  const byMonth={};
  custom.forEach(iso=>{
    const m=iso.slice(0,7);
    if(!byMonth[m])byMonth[m]=[];
    byMonth[m].push(iso);
  });
  list.innerHTML=Object.keys(byMonth).sort().map(m=>{
    const [y,mo]=m.split('-');
    const monthLabel=new Date(+y,+mo-1,1).toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
    const dates=byMonth[m].map(iso=>{
      const d=new Date(iso+'T12:00:00');
      const lbl=d.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric'});
      return `<span onclick="removeFermetureDate('${iso}')" title="Cliquer pour supprimer"
        style="display:inline-flex;align-items:center;gap:3px;padding:3px 8px;background:#fee2e2;border:1px solid #fecaca;border-radius:20px;font-size:11px;font-weight:600;color:#b91c1c;cursor:pointer">
        ${lbl} <span style="font-size:10px">âœ•</span>
      </span>`;
    }).join('');
    return `<div style="margin-bottom:6px">
      <div style="font-size:10px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">${monthLabel}</div>
      <div style="display:flex;flex-wrap:wrap;gap:4px">${dates}</div>
    </div>`;
  }).join('');
}

async function saveFermetures(){
  // RÃ©cupÃ©rer horaires
  const ouv=document.getElementById('params-heure-ouv')?.value||'09:00';
  const ferm=document.getElementById('params-heure-ferm')?.value||'18:00';
  _joursFermes.heureOuv=ouv;
  _joursFermes.heureFerm=ferm;
  await saveJoursFermes();
  closeFermetureModal();
  render();
  showToast('âœ… ParamÃ¨tres enregistrÃ©s','ok');
}
window.saveFermetures=saveFermetures;

// â”€â”€ UTILS â”€â”€
function showToast(m,t=''){const el=document.getElementById('toast');el.textContent=m;el.className='toast show '+(t||'');setTimeout(()=>el.className='toast',3200);}
function toggleMobileNav(){
  document.getElementById('sidebar')?.classList.toggle('open');
  document.getElementById('hamburger')?.classList.toggle('open');
  document.getElementById('navOverlay')?.classList.toggle('show');
}
async function handleLogout(){await window._signOut(window._auth);location.href='index.html';}
window.handleLogout=handleLogout;
window.toggleMobileNav=toggleMobileNav;
window.updLiveAlerts=updLiveAlerts;
</script>
<script src="nav.js"></script>
<script>
(function openRhNav(){
  var tries=0;
  var t=setInterval(function(){
    var sub=document.getElementById('rh-nav-sub');
    var nav=document.getElementById('alteore-nav');
    if(sub&&nav){clearInterval(t);sub.style.maxHeight='2000px';nav.classList.add('rh-mode');}
    if(++tries>50)clearInterval(t);
  },50);
})();
</script>
</body>
</html>
