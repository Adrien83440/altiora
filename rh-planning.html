<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>ALTEORE ‚Äî Planning RH</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --rh-dark:#052e16;--rh-main:#059669;--rh-mid:#10b981;--rh-bright:#34d399;
      --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
  --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f0fdf7;--sidebar-w:252px;--radius:12px;
  --green:#10b981;--green-light:#d1fae5;--orange:#f59e0b;--red:#ef4444;--red-light:#fee2e2;
  
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}

/* SIDEBAR */
.sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#052e16 0%,#065f46 100%);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;}
.sidebar-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 22px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:10px;}
.sidebar-logo-icon{width:36px;height:36px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;}
.sidebar-logo-text{font-size:18px;font-weight:800;color:white;letter-spacing:1px;}
.nav-scroll-area{flex:1;overflow-y:auto;overflow-x:hidden;}
.nav-scroll-area::-webkit-scrollbar{width:3px;}
.nav-scroll-area::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15);border-radius:2px;}
.sidebar-section-label,.nav-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,0.3);letter-spacing:1.2px;text-transform:uppercase;padding:14px 20px 5px;}
.nav-item{display:flex;align-items:center;gap:11px;padding:10px 20px;color:rgba(255,255,255,0.6);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;user-select:none;text-decoration:none;}
.nav-item:hover{color:white;background:rgba(255,255,255,0.06);}
.nav-item.active{color:white;background:rgba(255,255,255,0.1);border-left-color:var(--rh-mid);}
.nav-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0;}
.nav-label{flex:1;}
.nav-chevron{font-size:11px;color:rgba(255,255,255,0.3);transition:transform 0.25s;margin-left:auto;}
.submenu{overflow:hidden;max-height:0;transition:max-height 0.35s ease;}
.submenu.open{max-height:500px;}
.sub-item{display:flex;align-items:center;gap:9px;padding:8px 20px 8px 44px;color:rgba(255,255,255,0.45);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;text-decoration:none;}
.sub-item:hover{color:rgba(255,255,255,0.8);background:rgba(255,255,255,0.05);}
.sub-item.active{color:white;background:rgba(16,185,129,0.15);border-left-color:rgba(16,185,129,0.7);}
.sub-dot{width:5px;height:5px;background:rgba(255,255,255,0.3);border-radius:50%;flex-shrink:0;}
.sub-item.active .sub-dot{background:#34d399;}
.sidebar-footer{padding:16px 20px 0;border-top:1px solid rgba(255,255,255,0.08);}
.user-card{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.07);border-radius:10px;}
.user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--rh-main),var(--rh-bright));border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
.user-name{font-size:12px;font-weight:600;color:white;}
.user-plan{font-size:10px;color:rgba(255,255,255,0.4);}
.logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:14px;padding:4px;}

/* MAIN */
.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden;}
.topbar{background:white;border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;gap:10px;flex-wrap:wrap;}
.topbar-left h1{font-size:17px;font-weight:700;}
.topbar-left p{font-size:12px;color:var(--muted);}
.topbar-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.18s;display:inline-flex;align-items:center;gap:6px;white-space:nowrap;}
.btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-mid));color:white;box-shadow:0 3px 10px rgba(5,150,105,.25);}
.btn-rh:hover{opacity:.9;transform:translateY(-1px);}

.btn-outline{background:white;color:var(--text);border:1.5px solid var(--border);}
.btn-outline:hover{border-color:var(--rh-main);color:var(--rh-main);}
.btn-ai{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;box-shadow:0 3px 10px rgba(99,102,241,0.3);}
.btn-ai:hover{opacity:0.9;transform:translateY(-1px);}
.btn-sm{padding:5px 12px;font-size:12px;}
.btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}

/* NAV PLANNING */
.plan-nav{background:white;border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;gap:0;position:sticky;top:57px;z-index:40;flex-wrap:wrap;}
.plan-nav-week{display:flex;align-items:center;gap:8px;padding:10px 0;flex:1;min-width:200px;}
.wnav-btn{width:30px;height:30px;border:1.5px solid var(--border);border-radius:7px;background:white;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all .15s;}
.wnav-btn:hover{border-color:var(--rh-main);color:var(--rh-main);}
.week-label{font-size:14px;font-weight:700;color:var(--text);min-width:180px;text-align:center;}
.today-btn{font-size:11px;font-weight:700;padding:4px 10px;border:1.5px solid var(--rh-border);border-radius:6px;background:var(--rh-ghost);color:var(--rh-main);cursor:pointer;white-space:nowrap;}
.view-tabs{display:flex;gap:2px;padding:8px 0;}
.vtab{padding:5px 12px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;color:var(--muted);border:none;background:transparent;transition:all .15s;}
.vtab.active{background:var(--rh-ghost);color:var(--rh-main);}
.vtab:hover:not(.active){background:#f8faff;}
.display-tabs{display:flex;gap:2px;padding:8px 0;border-left:1px solid var(--border);margin-left:8px;padding-left:12px;}
.dtab{padding:5px 10px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;color:var(--muted);border:none;background:transparent;transition:all .15s;}
.dtab.active{background:#e0f2fe;color:#0369a1;}

/* L√âGENDE + STATS */
.emp-legend{background:white;border-bottom:1px solid var(--border);padding:8px 24px;display:flex;align-items:center;gap:8px;overflow-x:auto;}
.emp-legend::-webkit-scrollbar{height:3px;}
.emp-legend::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}
.leg-item{display:flex;align-items:center;gap:6px;font-size:11px;font-weight:600;color:var(--text);cursor:pointer;padding:4px 10px;border-radius:20px;border:1.5px solid var(--border);background:white;flex-shrink:0;transition:all .15s;}
.leg-item:hover{border-color:var(--rh-main);}
.leg-item.hidden{opacity:.35;}
.leg-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0;}
.stats-bar{background:white;border-bottom:1px solid var(--border);padding:8px 24px;display:flex;align-items:center;gap:18px;flex-wrap:wrap;}
.sitem{display:flex;align-items:center;gap:5px;font-size:12px;}
.sdot{width:8px;height:8px;border-radius:50%;}
.sval{font-weight:700;}
.slbl{color:var(--muted);}

/* PLANNING SCROLL */
.plan-content{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;}

/* GANTT */
.g-wrap{min-width:800px;}
.g-head{display:grid;background:white;border-bottom:2px solid var(--border);position:sticky;top:0;z-index:10;}
.g-head-emp{padding:10px 16px;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;border-right:1px solid var(--border);}
.g-dhead{padding:8px 6px;text-align:center;border-right:1px solid var(--border);}
.g-dname{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;}
.g-dnum{font-size:18px;font-weight:800;line-height:1;}
.g-dhead.today .g-dnum{color:var(--rh-main);}
.g-dhead.today{background:var(--rh-ghost);}
.g-row{display:grid;border-bottom:1px solid var(--border);min-height:58px;background:white;transition:background .1s;}
.g-row:hover{background:#fafffe;}
.g-emp{padding:10px 14px;border-right:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.g-av{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:white;flex-shrink:0;}
.g-en{font-size:12px;font-weight:600;line-height:1.3;}
.g-eh{font-size:10px;color:var(--muted);}
.g-cell{border-right:1px solid var(--border);padding:5px;cursor:pointer;min-height:58px;position:relative;transition:background .12s;}
.g-cell:hover{background:#f0fdf4;}
.g-cell.tc{background:#f0fdf4;}
.g-cell.off{background:#f9fafb;cursor:default;}
.g-cell.off:hover{background:#f9fafb;}
.add-hint{position:absolute;bottom:4px;right:4px;width:18px;height:18px;border-radius:4px;background:var(--rh-ghost);border:1px dashed var(--rh-border);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--rh-main);opacity:0;transition:opacity .15s;}
.g-cell:hover .add-hint{opacity:1;}

/* CR√âNEAU PILL */
.cr-pill{border-radius:6px;padding:4px 7px;margin-bottom:3px;cursor:pointer;position:relative;transition:all .12s;}
.cr-pill:hover{filter:brightness(.95);transform:translateY(-1px);}
.cr-time{font-size:10px;font-weight:700;opacity:.8;}
.cr-lbl{font-size:11px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;}
.cr-x{position:absolute;top:3px;right:4px;font-size:10px;opacity:0;cursor:pointer;}
.cr-pill:hover .cr-x{opacity:.7;}

/* TYPE COLORS */
.t-travail{background:#dcfce7;color:#166534;}
.t-repos{background:#f3f4f6;color:#6b7280;}
.t-conge{background:#dbeafe;color:#1e40af;}
.t-maladie{background:#fee2e2;color:#991b1b;}
.t-formation{background:#fef3c7;color:#92400e;}
.t-astreinte{background:#ede9fe;color:#5b21b6;}

/* COULEURS EMP */
.c0{background:#059669;}.c1{background:#3b82f6;}.c2{background:#8b5cf6;}
.c3{background:#f59e0b;}.c4{background:#ef4444;}.c5{background:#14b8a6;}
.c6{background:#f97316;}.c7{background:#6366f1;}.c8{background:#10b981;}.c9{background:#0ea5e9;}

/* VUE JOUR */
.day-grid{display:flex;flex-wrap:wrap;gap:12px;padding:20px 24px;}
.day-emp-card{background:white;border:1px solid var(--border);border-radius:10px;overflow:hidden;width:200px;min-width:160px;}
.day-card-head{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.day-card-body{padding:8px 10px;}

/* VUE MOIS */
.month-wrap{padding:16px 24px;}
.month-grid{display:grid;grid-template-columns:repeat(7,1fr);border-left:1px solid var(--border);border-top:1px solid var(--border);}
.m-dhead{padding:8px;text-align:center;font-size:11px;font-weight:700;color:var(--muted);background:#f8faff;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.m-cell{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:6px;min-height:88px;cursor:pointer;transition:background .12s;}
.m-cell:hover{background:#f0fdf4;}
.m-cell.m-today{background:#f0fdf4;}
.m-cell.m-other .m-dnum{color:#d1d5db;}
.m-cell.m-other{background:#fafafa;}
.m-dnum{font-size:13px;font-weight:700;margin-bottom:4px;}
.m-pill{font-size:9px;font-weight:700;padding:2px 5px;border-radius:4px;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.m-more{font-size:10px;color:var(--muted);font-weight:600;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(15,31,92,0.4);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;}
.overlay.show{display:flex;}
.modal{background:white;border-radius:16px;width:100%;max-width:460px;box-shadow:0 24px 60px rgba(0,0,0,0.15);overflow:hidden;}
.modal-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.modal-head h3{font-size:15px;font-weight:700;}
.mclose{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);}
.modal-body{padding:20px 22px;max-height:75vh;overflow-y:auto;}
.modal-foot{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}
.mf{margin-bottom:14px;}
.ml{font-size:12px;font-weight:600;color:var(--muted);margin-bottom:5px;display:block;}
.mi{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;background:white;}
.mi:focus{border-color:var(--rh-main);box-shadow:0 0 0 3px rgba(5,150,105,0.1);}
.mrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;}

/* MODAL IA */
.modal-ai{max-width:620px;}
.ai-hd{background:linear-gradient(135deg,#4f46e5,#7c3aed);padding:20px 24px;}
.ai-hd h3{color:white;font-size:16px;font-weight:700;}
.ai-hd p{color:rgba(255,255,255,.7);font-size:12px;margin-top:3px;}
.ai-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.ai-item{padding:10px 12px;border:1.5px solid var(--border);border-radius:9px;}
.ai-item-lbl{font-size:11px;font-weight:600;color:var(--muted);margin-bottom:4px;}
.ai-item input{width:100%;border:none;outline:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:14px;font-weight:700;color:var(--text);}
.ai-res{background:#1e293b;border-radius:10px;padding:14px;color:white;margin-top:10px;max-height:280px;overflow-y:auto;}
.ai-res-title{font-size:10px;font-weight:700;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;}
.ai-think{display:flex;align-items:center;gap:6px;color:rgba(255,255,255,.5);font-size:12px;}
.ai-d{width:6px;height:6px;border-radius:50%;background:#6366f1;animation:ap 1.2s ease-in-out infinite;}
.ai-d:nth-child(2){animation-delay:.2s;}.ai-d:nth-child(3){animation-delay:.4s;}
@keyframes ap{0%,80%,100%{opacity:.3;transform:scale(.8)}40%{opacity:1;transform:scale(1.1)}}
.ai-emp-row{display:flex;align-items:flex-start;gap:8px;margin-bottom:10px;font-size:12px;}
.ai-emp-n{color:rgba(255,255,255,.9);font-weight:600;min-width:100px;flex-shrink:0;}
.ai-shifts{display:flex;flex-wrap:wrap;gap:4px;}
.ai-shift-pill{padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700;}
.ai-apply{background:linear-gradient(135deg,#059669,#34d399);color:white;border:none;border-radius:8px;padding:10px 20px;font-size:13px;font-weight:700;cursor:pointer;width:100%;margin-top:10px;font-family:'Plus Jakarta Sans',sans-serif;}
.ai-apply:hover{opacity:.9;}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;background:#1e293b;color:white;padding:12px 18px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.ok{background:#059669;}

/* LOADER */
.loader{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--muted);gap:10px;flex-direction:column;}
@keyframes spin{to{transform:rotate(360deg)}}
.spin{width:22px;height:22px;border:2px solid var(--border);border-top-color:var(--rh-main);border-radius:50%;animation:spin .7s linear infinite;}

/* MOBILE */
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:var(--rh-main);border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(15,31,92,.45);}
.hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;}
.hamburger.open span:nth-child(1){transform:translateY(7.5px) rotate(45deg);}
.hamburger.open span:nth-child(2){opacity:0;transform:scaleX(0);}
.hamburger.open span:nth-child(3){transform:translateY(-7.5px) rotate(-45deg);}
.nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;}
.nav-overlay.show{display:block;}
@media(max-width:768px){
  .hamburger{display:flex !important;}
  .sidebar{position:fixed !important;transform:translateX(-105%) !important;transition:transform .3s cubic-bezier(.4,0,.2,1) !important;z-index:1001 !important;}
  .sidebar.open{transform:translateX(0) !important;box-shadow:8px 0 32px rgba(0,0,0,.3) !important;}
  .main{margin-left:0 !important;width:100vw !important;}
  .topbar{padding:10px 10px 10px 62px !important;}
  .plan-nav{padding:0 10px;}
  .week-label{min-width:100px !important;font-size:12px !important;}
  .plan-content{overflow-x:auto;}
  .mrow{grid-template-columns:1fr !important;}
  .ai-grid{grid-template-columns:1fr !important;}
  .display-tabs{display:none !important;}
}
</style>
</head>
<body>

<button class="hamburger" id="hamburger" onclick="toggleMobileNav()">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="navOverlay" onclick="toggleMobileNav()"></div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon">üåø</div>
    <div class="sidebar-logo-text">ALTEORE</div>
  </div>
  <div class="nav-scroll-area" id="nav-scroll-area"></div>
  <div class="sidebar-footer">
    <div class="user-card">
      <div class="user-avatar" id="av">?</div>
      <div><div class="user-name" id="uname">‚Ä¶</div><div class="user-plan">Master</div></div>
      <button class="logout-btn" onclick="handleLogout()">‚èª</button>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>üìÖ Planning RH</h1>
      <p id="topbar-sub">Plannings d'√©quipe ¬∑ Vue semaine</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="exportPDF()">üñ®Ô∏è Imprimer</button>
      <button class="btn btn-ai btn-sm" onclick="openAI()">‚ú® G√©n√©rer avec IA</button>
      <button class="btn btn-rh btn-sm" onclick="openCreneauModal()">+ Cr√©neau</button>
    </div>
  </div>

  <!-- NAV PLANNING -->
  <div class="plan-nav">
    <div class="plan-nav-week">
      <button class="wnav-btn" onclick="navPrev()">‚Äπ</button>
      <div class="week-label" id="week-label">‚Ä¶</div>
      <button class="wnav-btn" onclick="navNext()">‚Ä∫</button>
      <button class="today-btn" onclick="goToday()">Aujourd'hui</button>
    </div>
    <div class="view-tabs">
      <button class="vtab active" id="vtab-semaine" onclick="setView('semaine')">Semaine</button>
      <button class="vtab" id="vtab-jour" onclick="setView('jour')">Jour</button>
      <button class="vtab" id="vtab-mois" onclick="setView('mois')">Mois</button>
    </div>
    <div class="display-tabs" id="display-tabs">
      <button class="dtab active" id="dtab-gantt" onclick="setDisplay('gantt')">‚ò∞ Gantt</button>
      <button class="dtab" id="dtab-cols" onclick="setDisplay('cols')">‚äû Colonnes</button>
    </div>
  </div>

  <!-- L√âGENDE -->
  <div class="emp-legend" id="emp-legend">
    <div style="font-size:11px;font-weight:700;color:var(--muted);flex-shrink:0">√âquipe :</div>
    <div style="font-size:12px;color:var(--muted)">Chargement‚Ä¶</div>
  </div>

  <!-- STATS -->
  <div class="stats-bar">
    <div class="sitem"><div class="sdot" style="background:var(--rh-main)"></div><span class="sval" id="s-h">‚Äî</span><span class="slbl"> h planifi√©es</span></div>
    <div class="sitem"><div class="sdot" style="background:#3b82f6"></div><span class="sval" id="s-act">‚Äî</span><span class="slbl"> actifs</span></div>
    <div class="sitem"><div class="sdot" style="background:#f59e0b"></div><span class="sval" id="s-cg">‚Äî</span><span class="slbl"> cong√©s</span></div>
    <div class="sitem"><div class="sdot" style="background:#ef4444"></div><span class="sval" id="s-ab">‚Äî</span><span class="slbl"> absences</span></div>
  </div>

  <!-- CONTENU -->
  <div class="plan-content" id="plan-content">
    <div class="loader"><div class="spin"></div><span>Chargement du planning‚Ä¶</span></div>
  </div>
</div>

<!-- MODAL CR√âNEAU -->
<div class="overlay" id="modalCr">
  <div class="modal">
    <div class="modal-head">
      <h3 id="cr-title">‚ûï Nouveau cr√©neau</h3>
      <button class="mclose" onclick="closeCr()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="mf"><label class="ml">Employ√©</label><select class="mi" id="cr-emp"></select></div>
      <div class="mrow">
        <div class="mf"><label class="ml">Date</label><input class="mi" type="date" id="cr-date"/></div>
        <div class="mf"><label class="ml">Type</label>
          <select class="mi" id="cr-type" onchange="onTypeChange()">
            <option value="travail">üíº Travail</option>
            <option value="conge">üèñÔ∏è Cong√©</option>
            <option value="maladie">ü§í Maladie</option>
            <option value="formation">üìö Formation</option>
            <option value="astreinte">üîî Astreinte</option>
            <option value="repos">üò¥ Repos</option>
          </select>
        </div>
      </div>
      <div id="cr-hrs">
        <div class="mrow">
          <div class="mf"><label class="ml">Heure d√©but</label><input class="mi" type="time" id="cr-deb" value="09:00" oninput="updDur()"/></div>
          <div class="mf"><label class="ml">Heure fin</label><input class="mi" type="time" id="cr-fin" value="17:00" oninput="updDur()"/></div>
        </div>
      </div>
      <div class="mf"><label class="ml">Note / Poste</label><input class="mi" id="cr-note" placeholder="Ex: Caisse, Cuisine‚Ä¶"/></div>
      <div id="cr-dur" style="display:none;font-size:12px;font-weight:600;color:var(--rh-main);padding:7px 10px;background:var(--rh-ghost);border-radius:7px;margin-top:-8px"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-danger btn-sm" id="cr-del" onclick="delCr()" style="display:none;margin-right:auto">üóë Supprimer</button>
      <button class="btn btn-outline" onclick="closeCr()">Annuler</button>
      <button class="btn btn-rh" onclick="saveCr()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL IA -->
<div class="overlay" id="modalAI">
  <div class="modal modal-ai">
    <div class="ai-hd">
      <h3>‚ú® G√©n√©ration IA du planning</h3>
      <p>L'IA analyse vos contraintes et g√©n√®re un planning optimis√©</p>
    </div>
    <div class="modal-body" style="padding:20px 24px">
      <div style="font-size:12px;font-weight:700;margin-bottom:12px;color:var(--muted)">SEMAINE : <span style="color:var(--rh-main)" id="ai-wk">‚Äî</span></div>
      <div class="ai-grid">
        <div class="ai-item"><div class="ai-item-lbl">Ouverture</div><input id="ai-op" value="08:00" type="time"/></div>
        <div class="ai-item"><div class="ai-item-lbl">Fermeture</div><input id="ai-cl" value="20:00" type="time"/></div>
        <div class="ai-item"><div class="ai-item-lbl">Min. personnes / shift</div><input id="ai-ms" value="2" type="number" min="1"/></div>
        <div class="ai-item"><div class="ai-item-lbl">Jours de repos / semaine</div><input id="ai-rd" value="2" type="number" min="1" max="3"/></div>
      </div>
      <div class="mf"><label class="ml">Instructions sp√©cifiques (optionnel)</label><textarea class="mi" id="ai-inst" rows="2" placeholder="Ex: Marie ne travaille pas le lundi, fermeture dimanche‚Ä¶" style="resize:none;font-size:12px"></textarea></div>
      <div id="ai-res-wrap" style="display:none">
        <div class="ai-res" id="ai-res-box"><div class="ai-res-title">R√©sultat</div><div id="ai-res-content"></div></div>
        <button class="ai-apply" id="ai-apply-btn" onclick="applyAI()" style="display:none">‚úÖ Appliquer ce planning</button>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeAI()">Fermer</button>
      <button class="btn btn-ai" id="ai-gen-btn" onclick="genAI()">‚ú® G√©n√©rer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import{getFirestore,doc,setDoc,getDocs,deleteDoc,collection}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const app=initializeApp({apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",storageBucket:"altiora-70599.firebasestorage.app",messagingSenderId:"120905555746",appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"});
const auth=getAuth(app);const db=getFirestore(app);
window._auth=auth;window._db=db;window._doc=doc;window._setDoc=setDoc;
window._getDocs=getDocs;window._deleteDoc=deleteDoc;window._col=collection;window._signOut=signOut;
onAuthStateChanged(auth,u=>{
  if(!u){location.href='index.html';return;}
  window._uid=u.uid;
  const n=u.displayName||u.email.split('@')[0];
  document.getElementById('uname').textContent=n;
  document.getElementById('av').textContent=n.charAt(0).toUpperCase();
  window._firebaseReady=true;
  window.initPlanning();
});
</script>

<script>
// ‚ïê‚ïê STATE ‚ïê‚ïê
let _emps=[], _cr={}, _view='semaine', _disp='gantt';
let _cur=new Date(), _editId=null, _hidden=new Set(), _aiResult=null;
const COLS=['c0','c1','c2','c3','c4','c5','c6','c7','c8','c9'];
const TYPE_ICO={travail:'üíº',conge:'üèñÔ∏è',maladie:'ü§í',formation:'üìö',astreinte:'üîî',repos:'üò¥'};
const TYPE_LBL={travail:'Travail',conge:'Cong√©',maladie:'Maladie',formation:'Formation',astreinte:'Astreinte',repos:'Repos'};

// ‚ïê‚ïê INIT ‚ïê‚ïê
async function initPlanning(){
  if(!window._uid){setTimeout(initPlanning,400);return;}
  await loadEmps();
  await loadCr();
  render();
}
window.initPlanning=initPlanning;

async function loadEmps(){
  _emps=[];
  try{
    const s=await window._getDocs(window._col(window._db,'rh',window._uid,'employes'));
    s.forEach(d=>{const e=d.data();if(e.statut!=='archive')_emps.push({id:d.id,...e});});
    _emps.sort((a,b)=>(a.prenom||'').localeCompare(b.prenom||''));
  }catch(e){console.warn(e);}
  renderLegend();
  fillEmpSel();
}

async function loadCr(){
  _cr={};
  try{
    const wk=weekKey(_cur);
    const s=await window._getDocs(window._col(window._db,'rh',window._uid,'plan_'+wk));
    s.forEach(d=>{_cr[d.id]=d.data();});
  }catch(e){console.warn(e);}
}

// ‚ïê‚ïê DATE UTILS ‚ïê‚ïê
function monday(d){const dt=new Date(d),day=dt.getDay(),diff=(day===0)?-6:1-day;dt.setDate(dt.getDate()+diff);dt.setHours(0,0,0,0);return dt;}
function weekDays(d){const m=monday(d);return Array.from({length:7},(_,i)=>{const dd=new Date(m);dd.setDate(m.getDate()+i);return dd;});}
function weekKey(d){return monday(d).toISOString().slice(0,10).replace(/-/g,'');}
function fmt(d){return d.toISOString().slice(0,10);}
function isToday(d){const t=new Date();return d.getFullYear()===t.getFullYear()&&d.getMonth()===t.getMonth()&&d.getDate()===t.getDate();}
function diffH(a,b){if(!a||!b)return 0;const[ah,am]=a.split(':').map(Number),[bh,bm]=b.split(':').map(Number);return Math.max(0,((bh*60+bm)-(ah*60+am))/60);}
function monthDays(d){
  const y=d.getFullYear(),m=d.getMonth(),first=new Date(y,m,1),last=new Date(y,m+1,0),days=[];
  const startDow=(first.getDay()+6)%7;
  for(let i=startDow;i>0;i--)days.push({date:new Date(y,m,1-i),cur:false});
  for(let i=1;i<=last.getDate();i++)days.push({date:new Date(y,m,i),cur:true});
  while(days.length%7!==0){const dd=new Date(days[days.length-1].date);dd.setDate(dd.getDate()+1);days.push({date:dd,cur:false});}
  return days;
}

// ‚ïê‚ïê NAVIGATION ‚ïê‚ïê
function navPrev(){if(_view==='mois')_cur.setMonth(_cur.getMonth()-1);else if(_view==='jour')_cur.setDate(_cur.getDate()-1);else _cur.setDate(_cur.getDate()-7);refresh();}
function navNext(){if(_view==='mois')_cur.setMonth(_cur.getMonth()+1);else if(_view==='jour')_cur.setDate(_cur.getDate()+1);else _cur.setDate(_cur.getDate()+7);refresh();}
function goToday(){_cur=new Date();refresh();}
window.navPrev=navPrev;window.navNext=navNext;window.goToday=goToday;

async function refresh(){await loadCr();render();}

function setView(v){
  _view=v;
  document.querySelectorAll('.vtab').forEach(t=>t.classList.remove('active'));
  document.getElementById('vtab-'+v).classList.add('active');
  document.getElementById('display-tabs').style.display=v==='semaine'?'flex':'none';
  document.getElementById('topbar-sub').textContent='Plannings d\'√©quipe ¬∑ Vue '+v;
  render();
}
window.setView=setView;

function setDisplay(d){
  _disp=d;
  document.querySelectorAll('.dtab').forEach(t=>t.classList.remove('active'));
  document.getElementById('dtab-'+d).classList.add('active');
  render();
}
window.setDisplay=setDisplay;

// ‚ïê‚ïê RENDER ‚ïê‚ïê
function render(){updLabel();updStats();if(_view==='semaine')renderSemaine();else if(_view==='jour')renderJour();else renderMois();}

function updLabel(){
  const el=document.getElementById('week-label');
  if(_view==='semaine'){const d=weekDays(_cur);el.textContent=d[0].toLocaleDateString('fr-FR',{day:'numeric',month:'short'})+' ‚Äì '+d[6].toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'});}
  else if(_view==='jour')el.textContent=_cur.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long'});
  else el.textContent=_cur.toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
}

function updStats(){
  let h=0,cg=0,ab=0;
  const act=_emps.filter(e=>!_hidden.has(e.id)).length;
  Object.values(_cr).forEach(c=>(c.items||[]).forEach(i=>{
    if(i.type==='travail')h+=diffH(i.deb,i.fin);
    if(i.type==='conge')cg++;
    if(i.type==='maladie')ab++;
  }));
  document.getElementById('s-h').textContent=h.toFixed(1);
  document.getElementById('s-act').textContent=act;
  document.getElementById('s-cg').textContent=cg;
  document.getElementById('s-ab').textContent=ab;
}

// ‚îÄ‚îÄ SEMAINE GANTT ‚îÄ‚îÄ
function renderSemaine(){
  const days=weekDays(_cur);
  const vis=_emps.filter(e=>!_hidden.has(e.id));
  const pc=document.getElementById('plan-content');
  const cols=`180px repeat(7,1fr)`;

  if(_disp==='gantt'){
    let h=`<div class="g-wrap"><div class="g-head" style="display:grid;grid-template-columns:${cols}">
      <div class="g-head-emp">Employ√©</div>
      ${days.map(d=>`<div class="g-dhead ${isToday(d)?'today':''}">
        <div class="g-dname">${d.toLocaleDateString('fr-FR',{weekday:'short'})}</div>
        <div class="g-dnum">${d.getDate()}</div>
      </div>`).join('')}
    </div>`;
    if(!vis.length){h+=`<div style="padding:40px;text-align:center;color:var(--muted);font-size:13px;background:white"><div style="font-size:38px;margin-bottom:10px">üë•</div>Aucun employ√©. <a href="rh-employes.html" style="color:var(--rh-main);font-weight:700">Ajouter des employ√©s ‚Üí</a></div>`;}
    else vis.forEach((e,i)=>{
      const cc=COLS[i%COLS.length],ewh=empWeekH(e.id,days);
      h+=`<div class="g-row" style="display:grid;grid-template-columns:${cols}">
        <div class="g-emp">
          <div class="g-av ${cc}">${(e.prenom||'?')[0]}${(e.nom||'')[0]||''}</div>
          <div><div class="g-en">${e.prenom||''} ${(e.nom||'')[0]||''}.</div><div class="g-eh">${ewh.toFixed(1)}h/sem</div></div>
        </div>
        ${days.map(d=>{
          const k=`${fmt(d)}_${e.id}`;const items=(_cr[k]?.items||[]);
          const off=d.getDay()===0&&!items.length;
          return `<div class="g-cell ${isToday(d)?'tc':''} ${off?'off':''}" onclick="openCreneauModal('${e.id}','${fmt(d)}')">
            ${items.map(it=>pill(it,k)).join('')}
            ${!items.length?`<div class="add-hint">+</div>`:''}
          </div>`;
        }).join('')}
      </div>`;
    });
    h+=`</div>`;
    pc.innerHTML=h;
  } else {
    // COLONNES
    const nc=vis.length||1;
    const cols2=`130px repeat(${nc},1fr)`;
    let h2=`<div class="g-wrap"><div class="g-head" style="display:grid;grid-template-columns:${cols2}">
      <div class="g-head-emp">Jour</div>
      ${vis.map((e,i)=>{const cc=COLS[i%COLS.length];return `<div style="padding:8px;text-align:center;border-right:1px solid var(--border)">
        <div class="${cc} g-av" style="width:26px;height:26px;font-size:11px;margin:0 auto 3px">${(e.prenom||'?')[0]}${(e.nom||'')[0]||''}</div>
        <div style="font-size:11px;font-weight:600">${e.prenom||''} ${(e.nom||'')[0]||''}.</div>
      </div>`;}).join('')}
    </div>`;
    days.forEach(d=>{
      h2+=`<div style="display:grid;grid-template-columns:${cols2};border-bottom:1px solid var(--border);background:white;min-height:52px">
        <div style="padding:8px 14px;border-right:1px solid var(--border);background:${isToday(d)?'var(--rh-ghost)':'#f8faff'}">
          <div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">${d.toLocaleDateString('fr-FR',{weekday:'short'})}</div>
          <div style="font-size:16px;font-weight:800;color:${isToday(d)?'var(--rh-main)':'var(--text)'}">${d.getDate()}</div>
        </div>
        ${vis.map(e=>{const k=`${fmt(d)}_${e.id}`;const items=(_cr[k]?.items||[]);
          return `<div class="g-cell ${isToday(d)?'tc':''}" onclick="openCreneauModal('${e.id}','${fmt(d)}')">
            ${items.map(it=>pill(it,k)).join('')}
            ${!items.length?`<span style="color:var(--muted);font-size:11px">+</span>`:''}
          </div>`;
        }).join('')}
      </div>`;
    });
    h2+=`</div>`;
    pc.innerHTML=h2;
  }
}

// ‚îÄ‚îÄ JOUR ‚îÄ‚îÄ
function renderJour(){
  const d=_cur,vis=_emps.filter(e=>!_hidden.has(e.id));
  let h=`<div style="padding:18px 24px;font-size:14px;font-weight:800;color:var(--text)">${_cur.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}</div>
  <div class="day-grid">`;
  if(!vis.length)h+=`<div style="color:var(--muted);font-size:13px;padding:20px">Aucun employ√©.</div>`;
  else vis.forEach((e,i)=>{
    const cc=COLS[i%COLS.length],k=`${fmt(d)}_${e.id}`,items=(_cr[k]?.items||[]);
    h+=`<div class="day-emp-card">
      <div class="day-card-head">
        <div class="${cc} g-av" style="width:28px;height:28px;font-size:11px">${(e.prenom||'?')[0]}${(e.nom||'')[0]||''}</div>
        <div><div style="font-size:12px;font-weight:700">${e.prenom||''} ${e.nom||''}</div>
        <div style="font-size:10px;color:var(--muted)">${items.length?items.reduce((s,it)=>s+diffH(it.deb,it.fin),0).toFixed(1)+'h':'Libre'}</div></div>
      </div>
      <div class="day-card-body">
        ${items.length?items.map(it=>pill(it,k)).join(''):
        `<div style="text-align:center;padding:8px 0;color:var(--muted);font-size:11px;cursor:pointer" onclick="openCreneauModal('${e.id}','${fmt(d)}')">+ Ajouter</div>`}
        <div style="margin-top:4px;text-align:center"><span style="font-size:10px;color:var(--rh-main);cursor:pointer;font-weight:600" onclick="openCreneauModal('${e.id}','${fmt(d)}')">+ Cr√©neau</span></div>
      </div>
    </div>`;
  });
  h+=`</div>`;
  document.getElementById('plan-content').innerHTML=h;
}

// ‚îÄ‚îÄ MOIS ‚îÄ‚îÄ
function renderMois(){
  const days=monthDays(_cur);
  const JOURS=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
  let h=`<div class="month-wrap"><div class="month-grid">
    ${JOURS.map(j=>`<div class="m-dhead">${j}</div>`).join('')}
    ${days.map(({date,cur})=>{
      const kp=fmt(date);
      const allItems=[];
      _emps.forEach(e=>(_cr[`${kp}_${e.id}`]?.items||[]).slice(0,1).forEach(it=>allItems.push({e,it})));
      const total=_emps.reduce((s,e)=>s+(_cr[`${kp}_${e.id}`]?.items||[]).length,0);
      return `<div class="m-cell ${isToday(date)?'m-today':''} ${!cur?'m-other':''}"
        onclick="setView('jour');_cur=new Date('${kp}T12:00:00');render()">
        <div class="m-dnum"><span style="${isToday(date)?'background:var(--rh-main);color:white;border-radius:50%;width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;font-size:11px':''}">${date.getDate()}</span></div>
        ${allItems.slice(0,2).map(({e,it})=>`<div class="m-pill t-${it.type}">${e.prenom||''} ${it.deb||''}${it.fin?'‚Üí'+it.fin:''}</div>`).join('')}
        ${total>2?`<div class="m-more">+${total-2}</div>`:''}
      </div>`;
    }).join('')}
  </div></div>`;
  document.getElementById('plan-content').innerHTML=h;
}

// ‚îÄ‚îÄ PILL ‚îÄ‚îÄ
function pill(it,k){
  const dur=it.deb&&it.fin?diffH(it.deb,it.fin).toFixed(1)+'h':'';
  return `<div class="cr-pill t-${it.type}" onclick="event.stopPropagation();editCr('${k}','${it.id}')">
    <div class="cr-time">${it.deb||''}${it.fin?' ‚Üí '+it.fin:''} ${dur?'('+dur+')':''}</div>
    <div class="cr-lbl">${TYPE_ICO[it.type]||'üìã'} ${it.note||TYPE_LBL[it.type]||it.type}</div>
    <span class="cr-x" onclick="event.stopPropagation();qDelCr('${k}','${it.id}')">‚úï</span>
  </div>`;
}

// ‚îÄ‚îÄ STATS EMP ‚îÄ‚îÄ
function empWeekH(eid,days){let h=0;days.forEach(d=>{(_cr[`${fmt(d)}_${eid}`]?.items||[]).forEach(i=>{if(i.type==='travail')h+=diffH(i.deb,i.fin);});});return h;}

// ‚ïê‚ïê L√âGENDE ‚ïê‚ïê
function renderLegend(){
  const el=document.getElementById('emp-legend');
  if(!_emps.length){el.innerHTML=`<div style="font-size:11px;font-weight:700;color:var(--muted)">√âquipe :</div><a href="rh-employes.html" style="font-size:11px;font-weight:700;color:var(--rh-main);text-decoration:none">+ Ajouter ‚Üí</a>`;return;}
  el.innerHTML=`<div style="font-size:11px;font-weight:700;color:var(--muted);flex-shrink:0">√âquipe :</div>`+
  _emps.map((e,i)=>`<div class="leg-item ${_hidden.has(e.id)?'hidden':''}" onclick="toggleEmp('${e.id}')">
    <div class="leg-dot ${COLS[i%COLS.length]}"></div>${e.prenom||''} ${(e.nom||'')[0]||''}.
  </div>`).join('');
}
function toggleEmp(id){_hidden.has(id)?_hidden.delete(id):_hidden.add(id);renderLegend();render();}
window.toggleEmp=toggleEmp;

function fillEmpSel(){document.getElementById('cr-emp').innerHTML=_emps.map(e=>`<option value="${e.id}">${e.prenom||''} ${e.nom||''}</option>`).join('');}

// ‚ïê‚ïê MODAL CR√âNEAU ‚ïê‚ïê
function openCreneauModal(empId='',date=''){
  _editId=null;
  document.getElementById('cr-title').textContent='‚ûï Nouveau cr√©neau';
  document.getElementById('cr-del').style.display='none';
  if(empId)document.getElementById('cr-emp').value=empId;
  if(date)document.getElementById('cr-date').value=date;
  else document.getElementById('cr-date').value=fmt(_cur);
  document.getElementById('cr-type').value='travail';
  document.getElementById('cr-deb').value='09:00';
  document.getElementById('cr-fin').value='17:00';
  document.getElementById('cr-note').value='';
  document.getElementById('cr-hrs').style.display='block';
  updDur();
  document.getElementById('modalCr').classList.add('show');
}
window.openCreneauModal=openCreneauModal;

function editCr(k,itemId){
  const items=(_cr[k]?.items||[]);const it=items.find(i=>i.id===itemId);if(!it)return;
  _editId={k,itemId};
  const[date,eid]=k.split('_');
  document.getElementById('cr-title').textContent='‚úèÔ∏è Modifier le cr√©neau';
  document.getElementById('cr-del').style.display='block';
  document.getElementById('cr-emp').value=eid;
  document.getElementById('cr-date').value=date;
  document.getElementById('cr-type').value=it.type||'travail';
  document.getElementById('cr-deb').value=it.deb||'09:00';
  document.getElementById('cr-fin').value=it.fin||'17:00';
  document.getElementById('cr-note').value=it.note||'';
  onTypeChange();updDur();
  document.getElementById('modalCr').classList.add('show');
}
window.editCr=editCr;

function closeCr(){document.getElementById('modalCr').classList.remove('show');}
window.closeCr=closeCr;

function onTypeChange(){
  const t=document.getElementById('cr-type').value;
  document.getElementById('cr-hrs').style.display=(t==='repos'||t==='conge')?'none':'block';
  updDur();
}
function updDur(){
  const d=document.getElementById('cr-deb').value,f=document.getElementById('cr-fin').value,h=diffH(d,f);
  const el=document.getElementById('cr-dur');
  if(h>0&&document.getElementById('cr-type').value==='travail'){el.textContent=`‚è± Dur√©e : ${h.toFixed(1)}h`;el.style.display='block';}
  else el.style.display='none';
}
window.updDur=updDur;window.onTypeChange=onTypeChange;

async function saveCr(){
  const eid=document.getElementById('cr-emp').value,date=document.getElementById('cr-date').value;
  if(!eid||!date){showToast('S√©lectionnez un employ√© et une date');return;}
  const k=`${date}_${eid}`;
  if(!_cr[k])_cr[k]={items:[]};
  const it={id:'c'+Date.now(),type:document.getElementById('cr-type').value,deb:document.getElementById('cr-deb').value,fin:document.getElementById('cr-fin').value,note:document.getElementById('cr-note').value};
  if(_editId){
    if(_editId.k!==k){
      _cr[_editId.k].items=(_cr[_editId.k].items||[]).filter(i=>i.id!==_editId.itemId);
      await saveKey(_editId.k);
      _cr[k].items.push({...it,id:_editId.itemId});
    } else {
      const idx=(_cr[k].items||[]).findIndex(i=>i.id===_editId.itemId);
      if(idx>=0)_cr[k].items[idx]={...it,id:_editId.itemId};
    }
  } else _cr[k].items.push(it);
  await saveKey(k);
  closeCr();render();showToast(_editId?'Cr√©neau modifi√©':'Cr√©neau ajout√©','ok');
}
window.saveCr=saveCr;

async function saveKey(k){
  const wk=weekKey(_cur);
  try{await window._setDoc(window._doc(window._db,'rh',window._uid,'plan_'+wk,k),_cr[k]||{items:[]});}
  catch(e){console.error(e);showToast('Erreur Firebase');}
}

async function delCr(){
  if(!_editId)return;
  _cr[_editId.k].items=(_cr[_editId.k].items||[]).filter(i=>i.id!==_editId.itemId);
  await saveKey(_editId.k);closeCr();render();showToast('Cr√©neau supprim√©');
}
window.delCr=delCr;

async function qDelCr(k,id){
  if(!_cr[k])return;
  _cr[k].items=(_cr[k].items||[]).filter(i=>i.id!==id);
  await saveKey(k);render();showToast('Supprim√©');
}
window.qDelCr=qDelCr;

// ‚ïê‚ïê IA ‚ïê‚ïê
function openAI(){
  document.getElementById('ai-wk').textContent=document.getElementById('week-label').textContent;
  document.getElementById('ai-res-wrap').style.display='none';
  document.getElementById('ai-apply-btn').style.display='none';
  _aiResult=null;
  document.getElementById('modalAI').classList.add('show');
}
window.openAI=openAI;
function closeAI(){document.getElementById('modalAI').classList.remove('show');}
window.closeAI=closeAI;

async function genAI(){
  const btn=document.getElementById('ai-gen-btn');
  btn.disabled=true;btn.textContent='‚è≥‚Ä¶';
  const days=weekDays(_cur);
  const empStr=_emps.map(e=>`- ${e.prenom||''} ${e.nom||''} (${e.typeContrat||'CDI'}, ${e.heuresHebdo||35}h/sem, poste: ${e.poste||'non pr√©cis√©'})`).join('\n');
  const prompt=`Tu es un assistant RH expert. G√©n√®re un planning pour la semaine du ${days[0].toLocaleDateString('fr-FR')} au ${days[6].toLocaleDateString('fr-FR',{year:'numeric'})}.

√âQUIPE:\n${empStr||'Aucun employ√©'}

CONTRAINTES:
- Horaires: ${document.getElementById('ai-op').value} ‚Üí ${document.getElementById('ai-cl').value}
- Min ${document.getElementById('ai-ms').value} personne(s)/shift
- ${document.getElementById('ai-rd').value} jours de repos/semaine
- Max 10h/jour, repos 11h entre shifts
${document.getElementById('ai-inst').value?'\nINSTRUCTIONS:\n'+document.getElementById('ai-inst').value:''}

R√©ponds UNIQUEMENT en JSON valide, sans markdown:
{"planning":[{"nom":"Pr√©nom Nom","semaine":[{"jour":"lundi","date":"YYYY-MM-DD","type":"travail","deb":"HH:MM","fin":"HH:MM","note":"poste"},{"jour":"mardi","date":"YYYY-MM-DD","type":"repos"}]}],"resume":"r√©sum√© 1 phrase"}`;

  const wrap=document.getElementById('ai-res-wrap'),box=document.getElementById('ai-res-content');
  wrap.style.display='block';
  box.innerHTML=`<div class="ai-think"><div class="ai-d"></div><div class="ai-d"></div><div class="ai-d"></div><span style="margin-left:6px">L'IA g√©n√®re votre planning‚Ä¶</span></div>`;
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:2000,messages:[{role:'user',content:prompt}]})});
    const data=await res.json();
    const raw=(data.content?.[0]?.text||'').replace(/```json|```/g,'').trim();
    _aiResult=JSON.parse(raw);
    const TC={'travail':'#dcfce7','repos':'#f3f4f6','conge':'#dbeafe','maladie':'#fee2e2','formation':'#fef3c7','astreinte':'#ede9fe'};
    const TT={'travail':'#166534','repos':'#374151','conge':'#1e40af','maladie':'#991b1b','formation':'#92400e','astreinte':'#5b21b6'};
    let h=_aiResult.resume?`<div style="font-size:11px;color:rgba(255,255,255,.6);margin-bottom:10px;padding:8px;background:rgba(255,255,255,.07);border-radius:6px">${_aiResult.resume}</div>`:'';
    (_aiResult.planning||[]).forEach(ep=>{
      h+=`<div class="ai-emp-row"><div class="ai-emp-n">${ep.nom}</div><div class="ai-shifts">
        ${(ep.semaine||[]).map(s=>`<div class="ai-shift-pill" style="background:${TC[s.type]||'#f3f4f6'};color:${TT[s.type]||'#374151'}" title="${s.jour}">${(s.jour||'').slice(0,2).toUpperCase()} ${s.type==='travail'?(s.deb+'‚Üí'+s.fin):(s.type.toUpperCase())}</div>`).join('')}
      </div></div>`;
    });
    box.innerHTML=h;
    document.getElementById('ai-apply-btn').style.display='block';
  }catch(e){box.innerHTML=`<div style="color:#f87171;font-size:12px">‚ùå Erreur: ${e.message}. R√©essayez.</div>`;}
  btn.disabled=false;btn.textContent='‚ú® Reg√©n√©rer';
}
window.genAI=genAI;

async function applyAI(){
  if(!_aiResult)return;
  const btn=document.getElementById('ai-apply-btn');btn.textContent='‚è≥‚Ä¶';btn.disabled=true;
  let count=0;
  for(const ep of (_aiResult.planning||[])){
    const emp=_emps.find(e=>`${e.prenom||''} ${e.nom||''}`.trim()===ep.nom.trim());
    if(!emp)continue;
    for(const s of (ep.semaine||[])){
      if(!s.date||s.type==='repos')continue;
      const k=`${s.date}_${emp.id}`;
      if(!_cr[k])_cr[k]={items:[]};
      _cr[k].items.push({id:'ai'+Date.now()+Math.random().toString(36).slice(2),type:s.type||'travail',deb:s.deb||'',fin:s.fin||'',note:s.note||''});
      await saveKey(k);count++;
    }
  }
  closeAI();render();showToast(`‚úÖ ${count} cr√©neaux appliqu√©s`,'ok');
}
window.applyAI=applyAI;

// ‚ïê‚ïê EXPORT PDF ‚ïê‚ïê
function exportPDF(){
  const days=_view==='mois'?weekDays(_cur):weekDays(_cur);
  const vis=_emps.filter(e=>!_hidden.has(e.id));
  let rows='';
  vis.forEach(e=>{
    rows+=`<tr><td style="font-weight:700;padding:7px 10px;border:1px solid #e2e8f0;background:#f8faff;white-space:nowrap">${e.prenom||''} ${e.nom||''}</td>`;
    days.forEach(d=>{
      const k=`${fmt(d)}_${e.id}`;const items=(_cr[k]?.items||[]);
      const txt=items.map(i=>i.type==='travail'?`${i.deb}‚Äì${i.fin}${i.note?' ('+i.note+')':''}`:TYPE_LBL[i.type]||i.type).join('<br>');
      rows+=`<td style="padding:7px 10px;border:1px solid #e2e8f0;font-size:11px;min-width:72px">${txt||'‚Äî'}</td>`;
    });
    rows+=`</tr>`;
  });
  const w=window.open('','_blank');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Planning</title>
  <style>body{font-family:sans-serif;padding:20px;font-size:13px}h1{font-size:17px;font-weight:800;color:#052e16;margin-bottom:4px}p{color:#6b7280;font-size:12px;margin-bottom:14px}table{width:100%;border-collapse:collapse}th{padding:7px 10px;background:#059669;color:white;font-size:11px;font-weight:700;border:1px solid #047857}@media print{@page{margin:.8cm}}</style>
  </head><body>
  <h1>üìÖ Planning ‚Äì ${document.getElementById('week-label').textContent}</h1>
  <p>ALTEORE RH ¬∑ ${new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'})}</p>
  <table><thead><tr><th>Employ√©</th>${days.map(d=>`<th>${d.toLocaleDateString('fr-FR',{weekday:'short',day:'numeric',month:'short'})}</th>`).join('')}</tr></thead><tbody>${rows}</tbody></table>
  <script>window.onload=()=>window.print()<\/script></body></html>`);
  w.document.close();
}
window.exportPDF=exportPDF;

// ‚ïê‚ïê UTILS ‚ïê‚ïê
function showToast(m,t=''){const el=document.getElementById('toast');el.textContent=m;el.className='toast show '+(t||'');setTimeout(()=>el.className='toast',3000);}
async function handleLogout(){await window._signOut(window._auth);location.href='index.html';}
window.handleLogout=handleLogout;
function toggleMobileNav(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('hamburger').classList.toggle('open');document.getElementById('navOverlay').classList.toggle('show');}
window.toggleMobileNav=toggleMobileNav;
</script>
<script src="nav.js"></script>
</body>
</html>
