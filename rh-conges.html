<!-- ALTEORE rh-conges v20260226-170854 - BUILD FORCE -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE ‚Äî Cong√©s & Absences</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --rh-dark:#052e16;--rh-main:#059669;--rh-mid:#10b981;--rh-bright:#34d399;
      --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f5f7ff;
      --sidebar-w:252px;--radius:12px;
      --red:#ef4444;--red-light:#fee2e2;
      --orange:#f59e0b;--orange-light:#fef3c7;
      --blue:#3b82f6;--blue-light:#dbeafe;
      --purple:#6366f1;--purple-light:#ede9fe;
      --teal:#0891b2;--teal-light:#e0f2fe;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}

    /* SIDEBAR */
    .sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#052e16 0%,#064e23 50%,#065f2c 100%);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;overflow-y:auto;}
    .sidebar-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 22px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:10px;}
    .sidebar-logo-icon{width:36px;height:36px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .sidebar-logo-text{font-size:18px;font-weight:800;color:white;letter-spacing:1px;}
    .sidebar-footer{margin-top:auto;padding:16px 20px 0;border-top:1px solid rgba(255,255,255,0.08);}
    .user-card{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.07);border-radius:10px;}
    .user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--rh-mid),#059669);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
    .user-name{font-size:12px;font-weight:600;color:white;}
    .user-plan{font-size:10px;color:rgba(255,255,255,0.4);}
    .logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:14px;}

    /* MAIN */
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-width:0;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;gap:12px;flex-wrap:wrap;}
    .topbar-left h1{font-size:17px;font-weight:700;}
    .topbar-left p{font-size:12px;color:var(--muted);}
    .topbar-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.18s;text-decoration:none;display:inline-flex;align-items:center;gap:5px;}
    .btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-mid));color:white;box-shadow:0 3px 10px rgba(5,150,105,.25);}
    .btn-rh:hover{opacity:.9;transform:translateY(-1px);}
    .btn-outline{background:white;color:var(--rh-main);border:1.5px solid var(--rh-border);}
    .btn-outline:hover{border-color:var(--rh-main);background:var(--rh-ghost);}
    .btn-sm{padding:5px 12px;font-size:12px;}
    .btn-xs{padding:3px 8px;font-size:11px;}
    .btn-approve{background:#dcfce7;color:#166534;border:1px solid #86efac;}
    .btn-approve:hover{background:#bbf7d0;}
    .btn-refuse{background:#fee2e2;color:#991b1b;border:1px solid #fca5a5;}
    .btn-refuse:hover{background:#fecaca;}

    /* TABS */
    .tabs-bar{background:white;border-bottom:1px solid var(--border);padding:0 28px;display:flex;gap:0;}
    .tab{padding:11px 18px;font-size:13px;font-weight:600;color:var(--muted);cursor:pointer;border-bottom:3px solid transparent;transition:all .15s;white-space:nowrap;}
    .tab:hover{color:var(--rh-main);}
    .tab.active{color:var(--rh-main);border-bottom-color:var(--rh-main);}
    .tab-badge{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;border-radius:9px;font-size:10px;font-weight:800;padding:0 4px;margin-left:5px;}
    .tab-badge.red{background:#fee2e2;color:#dc2626;}
    .tab-badge.green{background:#dcfce7;color:#166534;}

    /* CONTENT */
    .content{padding:22px 28px;flex:1;display:flex;flex-direction:column;gap:18px;}
    .tab-panel{display:none;}
    .tab-panel.active{display:flex;flex-direction:column;gap:18px;}

    /* KPI ROW */
    .kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
    .kpi-box{background:white;border:1px solid var(--border);border-radius:10px;padding:14px 16px;}
    .kpi-box.green{background:var(--rh-ghost);border-color:var(--rh-border);}
    .kpi-box.orange{background:var(--orange-light);border-color:#fcd34d;}
    .kpi-box.red{background:var(--red-light);border-color:#fca5a5;}
    .kpi-box.blue{background:var(--blue-light);border-color:#93c5fd;}
    .kpi-box.purple{background:var(--purple-light);border-color:#c4b5fd;}
    .kpi-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;}
    .kpi-val{font-size:20px;font-weight:800;color:var(--text);}
    .kpi-sub{font-size:10px;color:var(--muted);margin-top:3px;}

    /* SOLDES TABLE */
    .card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:#f8faff;}
    .card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px;}
    .table-wrap{overflow-x:auto;}
    table{width:100%;border-collapse:collapse;font-size:12px;}
    th{padding:9px 14px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;background:#f8faff;border-bottom:1px solid var(--border);white-space:nowrap;}
    th:not(:first-child){text-align:center;}
    td{padding:10px 14px;border-bottom:1px solid #f1f5f9;vertical-align:middle;}
    td:not(:first-child){text-align:center;}
    tr:last-child td{border-bottom:none;}
    tr:hover td{background:#fafbff;}
    .emp-cell{display:flex;align-items:center;gap:9px;}
    .emp-av{width:28px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:white;flex-shrink:0;}
    .emp-nm{font-size:12px;font-weight:600;}
    .emp-ps{font-size:10px;color:var(--muted);}
    .solde-bar{height:6px;background:#f1f5f9;border-radius:3px;overflow:hidden;margin-top:4px;min-width:60px;}
    .solde-fill{height:100%;border-radius:3px;transition:width .5s ease;}
    .solde-val{font-size:13px;font-weight:800;}
    .solde-val.good{color:var(--rh-main);}
    .solde-val.warn{color:var(--orange);}
    .solde-val.low{color:var(--red);}
    .badge{display:inline-flex;align-items:center;padding:3px 8px;border-radius:20px;font-size:10px;font-weight:700;}
    .badge-pending{background:#fef3c7;color:#92400e;}
    .badge-approved{background:#dcfce7;color:#166534;}
    .badge-refused{background:#fee2e2;color:#991b1b;}
    .badge-cancelled{background:#f3f4f6;color:#6b7280;}

    /* DEMANDES */
    .demande-card{background:white;border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;gap:14px;transition:box-shadow .15s;}
    .demande-card:hover{box-shadow:0 2px 12px rgba(0,0,0,.06);}
    .demande-card.pending{border-left:4px solid var(--orange);}
    .demande-card.approved{border-left:4px solid var(--rh-main);}
    .demande-card.refused{border-left:4px solid var(--red);}
    .dem-type-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
    .dem-info{flex:1;min-width:0;}
    .dem-name{font-size:12px;font-weight:700;margin-bottom:2px;}
    .dem-dates{font-size:11px;color:var(--muted);}
    .dem-jours{font-size:11px;font-weight:700;color:var(--rh-main);margin-left:6px;}
    .dem-actions{display:flex;gap:6px;flex-shrink:0;}
    .dem-motif{font-size:10px;color:var(--muted);margin-top:2px;font-style:italic;}

    /* CALENDRIER ABSENCES */
    .cal-grid{display:grid;grid-template-columns:120px repeat(31,1fr);gap:1px;background:var(--border);border-radius:8px;overflow:hidden;font-size:10px;}
    .cal-head{background:#f8faff;padding:5px 3px;text-align:center;font-weight:700;color:var(--muted);}
    .cal-emp{background:white;padding:6px 8px;font-size:11px;font-weight:600;display:flex;align-items:center;gap:5px;}
    .cal-cell{background:white;min-height:24px;position:relative;}
    .cal-cell.weekend{background:#f8faff;}
    .cal-cell.today{background:#f0fdf4;}
    .cal-dot{position:absolute;inset:2px;border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:white;}

    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(15,31,92,.4);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;padding:16px;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;width:100%;max-width:520px;box-shadow:0 24px 60px rgba(0,0,0,.18);overflow:hidden;max-height:90vh;display:flex;flex-direction:column;}
    .modal-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
    .modal-head h3{font-size:15px;font-weight:700;}
    .modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);padding:4px;}
    .modal-body{padding:20px 22px;overflow-y:auto;flex:1;}
    .modal-foot{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;flex-shrink:0;}
    .mfield{margin-bottom:13px;}
    .mlabel{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px;display:block;}
    .minput{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;transition:border-color .15s;}
    .minput:focus{border-color:var(--rh-main);box-shadow:0 0 0 3px rgba(5,150,105,.08);}
    .mrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .msep{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;padding:10px 0 6px;border-top:1px solid var(--border);margin-top:6px;}

    /* MODAL MOTIF REFUS */
    .refuse-modal .modal{max-width:400px;}

    /* FILTRE BAR */
    .filter-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .filter-select{padding:6px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;color:var(--text);outline:none;background:white;cursor:pointer;}
    .filter-select:focus{border-color:var(--rh-main);}
    .search-inp{padding:6px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;outline:none;width:180px;}
    .search-inp:focus{border-color:var(--rh-main);}

    /* EMPTY */
    .empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px;text-align:center;color:var(--muted);}
    .empty-icon{font-size:42px;margin-bottom:12px;}

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.ok{background:var(--rh-main);}
    .toast.err{background:var(--red);}

    .loader{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--muted);gap:10px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--rh-main);border-radius:50%;animation:spin .7s linear infinite;}

    /* HAMBURGER */
    .hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:#052e16;border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(5,46,22,.45);}
    .hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s;}
    .nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;}
    .nav-overlay.show{display:block;}
    @media(max-width:768px){
      .hamburger{display:flex!important;}
      .sidebar{position:fixed!important;top:0!important;left:0!important;height:100vh!important;width:min(280px,84vw)!important;z-index:1001!important;transform:translateX(-105%)!important;transition:transform .3s cubic-bezier(.4,0,.2,1)!important;}
      .sidebar.open{transform:translateX(0)!important;box-shadow:8px 0 32px rgba(0,0,0,.3)!important;}
      .main{margin-left:0!important;}
      .topbar{padding:10px 10px 10px 62px!important;}
      .content{padding:14px 12px!important;}
      .kpi-row{grid-template-columns:1fr 1fr!important;gap:8px!important;}
      .tabs-bar{padding:0 12px!important;overflow-x:auto!important;}
      .mrow{grid-template-columns:1fr!important;}
      .filter-bar{gap:6px!important;}
    }
  </style>
</head>
<body>

<button class="hamburger" id="hamburger-btn" onclick="toggleSidebar()">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="nav-overlay" onclick="closeSidebar()"></div>

<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>üèñÔ∏è Cong√©s & Absences</h1>
      <p>Suivi des soldes, validation des demandes et calendrier des absences</p>
    </div>
    <div class="topbar-right">
      <select class="filter-select" id="year-sel" onchange="onYearChange()"></select>
      <button class="btn btn-outline btn-sm" id="btn-refresh" onclick="reloadAll()" title="Recharger les employ√©s et demandes" style="min-width:36px">üîÑ</button>
      <button class="btn btn-outline btn-sm" onclick="openAjustModal()">‚öôÔ∏è Ajuster soldes</button>
      <button class="btn btn-rh btn-sm" onclick="openNewDemandeModal()">+ Demande</button>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs-bar">
    <div class="tab active" onclick="switchTab('soldes',this)">üìä Soldes <span class="tab-badge green" id="badge-emp">‚Äî</span></div>
    <div class="tab" onclick="switchTab('demandes',this)">üìã Demandes <span class="tab-badge red" id="badge-pending">‚Äî</span></div>
    <div class="tab" onclick="switchTab('calendrier',this)">üìÖ Calendrier √©quipe</div>
    <div class="tab" onclick="switchTab('historique',this)">üóÇÔ∏è Historique</div>
  </div>

  <div class="content">

    <!-- TAB : SOLDES -->
    <div class="tab-panel active" id="tab-soldes">
      <!-- KPIs globaux -->
      <div class="kpi-row" id="kpi-row">
        <div class="kpi-box green"><div class="kpi-label">Employ√©s actifs</div><div class="kpi-val" id="k-emp">‚Äî</div><div class="kpi-sub">avec suivi CP</div></div>
        <div class="kpi-box blue"><div class="kpi-label">CP acquis (total)</div><div class="kpi-val" id="k-acquis">‚Äî</div><div class="kpi-sub">sur toute l'√©quipe</div></div>
        <div class="kpi-box orange"><div class="kpi-label">CP pris (total)</div><div class="kpi-val" id="k-pris">‚Äî</div><div class="kpi-sub">cette p√©riode</div></div>
        <div class="kpi-box green"><div class="kpi-label">CP restants</div><div class="kpi-val" id="k-reste">‚Äî</div><div class="kpi-sub">√† solder</div></div>
        <div class="kpi-box red"><div class="kpi-label">En attente</div><div class="kpi-val" id="k-pending">‚Äî</div><div class="kpi-sub">demandes √† valider</div></div>
      </div>

      <!-- Table soldes par employ√© -->
      <div class="card">
        <div class="card-head">
          <div class="card-title">üë• Soldes par employ√©</div>
          <div class="filter-bar">
            <input class="search-inp" placeholder="üîç Rechercher‚Ä¶" oninput="filterSoldes(this.value)"/>
          </div>
        </div>
        <div class="table-wrap">
          <table id="soldes-table">
            <thead><tr>
              <th>Employ√©</th>
              <th>CP acquis</th>
              <th>CP pris</th>
              <th>CP restants</th>
              <th>RTT restants</th>
              <th>CSS</th>
              <th>R√©cup.</th>
              <th>Demandes</th>
              <th>Actions</th>
            </tr></thead>
            <tbody id="soldes-body">
              <tr><td colspan="9"><div class="loader"><div class="spin"></div></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- TAB : DEMANDES -->
    <div class="tab-panel" id="tab-demandes">
      <div class="filter-bar">
        <select class="filter-select" id="dem-filter-statut" onchange="renderDemandes()">
          <option value="">Tous les statuts</option>
          <option value="pending">‚è≥ En attente</option>
          <option value="approved">‚úÖ Approuv√©es</option>
          <option value="refused">‚ùå Refus√©es</option>
          <option value="cancelled">üö´ Annul√©es</option>
        </select>
        <select class="filter-select" id="dem-filter-type" onchange="renderDemandes()">
          <option value="">Tous les types</option>
          <option value="cp">üèñÔ∏è CP</option>
          <option value="rtt">‚è∞ RTT</option>
          <option value="css">üíº Cong√© sans solde</option>
          <option value="evenement">üéâ √âv√©nement familial</option>
          <option value="maladie">ü§í Maladie</option>
          <option value="recuperation">üîÑ R√©cup√©ration</option>
          <option value="formation">üìö Formation</option>
        </select>
        <select class="filter-select" id="dem-filter-emp" onchange="renderDemandes()">
          <option value="">Tous les employ√©s</option>
        </select>
        <input class="search-inp" placeholder="üîç Rechercher‚Ä¶" oninput="renderDemandes(this.value)"/>
      </div>
      <div id="demandes-list"><div class="loader"><div class="spin"></div></div></div>
    </div>

    <!-- TAB : CALENDRIER -->
    <div class="tab-panel" id="tab-calendrier">
      <div class="card">
        <div class="card-head">
          <div class="card-title">üìÖ Absences de l'√©quipe</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn btn-outline btn-sm" onclick="prevMonth()">‚Äπ</button>
            <span id="cal-label" style="font-size:13px;font-weight:700;min-width:140px;text-align:center"></span>
            <button class="btn btn-outline btn-sm" onclick="nextMonth()">‚Ä∫</button>
          </div>
        </div>
        <div style="padding:16px;overflow-x:auto">
          <div id="cal-content"></div>
          <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:14px;padding-top:12px;border-top:1px solid var(--border)">
            ${['cp','rtt','css','evenement','maladie','recuperation','formation'].map(t=>`
              <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted)">
                <div style="width:12px;height:12px;border-radius:3px;background:${TYPE_COLORS[t]||'#6b7280'}"></div>${TYPE_LBL[t]||t}
              </div>`).join('')}
          </div>
        </div>
      </div>
    </div>

    <!-- TAB : HISTORIQUE -->
    <div class="tab-panel" id="tab-historique">
      <div class="card">
        <div class="card-head">
          <div class="card-title">üóÇÔ∏è Historique complet</div>
          <button class="btn btn-outline btn-sm" onclick="exportCSV()">‚¨áÔ∏è Export CSV</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th>Employ√©</th><th>Type</th><th>Du</th><th>Au</th><th>Jours</th><th>Statut</th><th>Demand√© le</th><th>Trait√© par</th><th>Motif refus</th>
            </tr></thead>
            <tbody id="historique-body">
              <tr><td colspan="9"><div class="loader"><div class="spin"></div></div></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- MODAL NOUVELLE DEMANDE (manager) -->
<div class="modal-overlay" id="modal-demande">
  <div class="modal">
    <div class="modal-head">
      <h3 id="dem-modal-title">+ Nouvelle demande de cong√©</h3>
      <button class="modal-close" onclick="closeModal('modal-demande')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="mfield">
        <label class="mlabel">Employ√©</label>
        <select class="minput" id="d-emp" onchange="onEmpChange()"></select>
      </div>
      <div class="mrow">
        <div class="mfield">
          <label class="mlabel">Type de cong√©</label>
          <select class="minput" id="d-type" onchange="calcJours()">
            <option value="cp">üèñÔ∏è CP ‚Äî Cong√©s pay√©s</option>
            <option value="rtt">‚è∞ RTT</option>
            <option value="css">üíº Cong√© sans solde</option>
            <option value="evenement">üéâ √âv√©nement familial</option>
            <option value="maladie">ü§í Maladie / Arr√™t</option>
            <option value="recuperation">üîÑ R√©cup√©ration heures</option>
            <option value="formation">üìö Formation</option>
          </select>
        </div>
        <div class="mfield">
          <label class="mlabel">Statut initial</label>
          <select class="minput" id="d-statut">
            <option value="approved">‚úÖ Approuv√©e directement</option>
            <option value="pending">‚è≥ En attente de validation</option>
          </select>
        </div>
      </div>
      <div class="mrow">
        <div class="mfield">
          <label class="mlabel">Date de d√©but</label>
          <input class="minput" type="date" id="d-deb" oninput="calcJours()"/>
        </div>
        <div class="mfield">
          <label class="mlabel">Date de fin</label>
          <input class="minput" type="date" id="d-fin" oninput="calcJours()"/>
        </div>
      </div>
      <div id="d-jours-info" style="display:none;padding:10px 14px;background:var(--rh-ghost);border-radius:8px;font-size:12px;font-weight:600;color:var(--rh-main);margin-bottom:12px"></div>
      <div id="d-solde-warn" style="display:none;padding:10px 14px;background:var(--orange-light);border-radius:8px;font-size:12px;font-weight:600;color:#92400e;margin-bottom:12px"></div>
      <div class="mfield">
        <label class="mlabel">Motif / Note</label>
        <input class="minput" type="text" id="d-motif" placeholder="Ex: Vacances √©t√©, Mariage‚Ä¶"/>
      </div>
      <!-- √âV√âNEMENTS FAMILIAUX : dur√©es l√©gales -->
      <div id="d-evenement-info" style="display:none;padding:10px 14px;background:var(--blue-light);border-radius:8px;font-size:11px;color:#1e40af;margin-bottom:12px;line-height:1.6">
        <b>Dur√©es l√©gales des √©v√©nements familiaux (Code du travail) :</b><br>
        Mariage/PACS : 4j ¬∑ Mariage enfant : 1j ¬∑ Naissance/adoption : 3j ¬∑ D√©c√®s conjoint/enfant : 5j ¬∑ D√©c√®s parent/fr√®re/s≈ìur : 3j ¬∑ D√©c√®s beau-parent : 1j ¬∑ Annonce handicap enfant : 2j
      </div>
      <!-- JUSTIFICATIF : visible si maladie ou formation -->
      <div id="d-justif-wrap" style="display:none">
        <div class="mfield">
          <label class="mlabel">üìé Justificatif <span style="font-weight:400;color:var(--muted)">(arr√™t, ordonnance, convocation‚Ä¶)</span></label>
          <div id="d-justif-drop" onclick="document.getElementById('d-justif-input').click()" style="border:2px dashed var(--border);border-radius:10px;padding:16px;text-align:center;cursor:pointer;background:#fafafa;transition:all .15s" onmouseover="this.style.borderColor='#059669';this.style.background='#f0fdf4'" onmouseout="this.style.borderColor='var(--border)';this.style.background='#fafafa'">
            <div style="font-size:24px;margin-bottom:4px">üìÑ</div>
            <div style="font-size:12px;font-weight:600;color:var(--muted)">Cliquez pour s√©lectionner un fichier</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px">PDF, JPG, PNG ¬∑ Max 5 Mo</div>
          </div>
          <input type="file" id="d-justif-input" accept=".pdf,.jpg,.jpeg,.png" style="display:none" onchange="onJustifChange(this)"/>
          <div id="d-justif-preview" style="display:none;margin-top:8px;padding:8px 12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;display:none;align-items:center;gap:8px;font-size:12px">
            <span id="d-justif-name" style="flex:1;font-weight:600;color:#065f46;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
            <span id="d-justif-size" style="color:var(--muted);flex-shrink:0"></span>
            <button onclick="clearJustif()" style="background:none;border:none;cursor:pointer;color:var(--red);font-size:14px;padding:0 2px;flex-shrink:0">‚úï</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modal-demande')">Annuler</button>
      <button class="btn btn-rh" id="btn-save-dem" onclick="saveDemande()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL REFUS -->
<div class="modal-overlay refuse-modal" id="modal-refus">
  <div class="modal">
    <div class="modal-head">
      <h3>‚ùå Motif de refus</h3>
      <button class="modal-close" onclick="closeModal('modal-refus')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="mfield">
        <label class="mlabel">Motif (optionnel)</label>
        <input class="minput" type="text" id="refus-motif" placeholder="Ex: P√©riode charg√©e, chevauchement‚Ä¶"/>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modal-refus')">Annuler</button>
      <button class="btn btn-refuse" onclick="confirmRefus()">‚ùå Confirmer le refus</button>
    </div>
  </div>
</div>

<!-- MODAL AJUSTEMENT SOLDES -->
<div class="modal-overlay" id="modal-ajust">
  <div class="modal">
    <div class="modal-head">
      <h3>‚öôÔ∏è Ajuster les soldes</h3>
      <button class="modal-close" onclick="closeModal('modal-ajust')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="mfield">
        <label class="mlabel">Employ√©</label>
        <select class="minput" id="aj-emp" onchange="loadAjustForm()"></select>
      </div>
      <div class="msep">Soldes actuels</div>
      <div class="mrow">
        <div class="mfield"><label class="mlabel">CP acquis</label><input class="minput" type="number" id="aj-acquis" step="0.5" placeholder="0"/></div>
        <div class="mfield"><label class="mlabel">CP pris</label><input class="minput" type="number" id="aj-pris" step="0.5" placeholder="0"/></div>
      </div>
      <div class="mrow">
        <div class="mfield"><label class="mlabel">RTT restants</label><input class="minput" type="number" id="aj-rtt" step="0.5" placeholder="0"/></div>
        <div class="mfield"><label class="mlabel">R√©cup. restantes (h)</label><input class="minput" type="number" id="aj-recup" step="0.5" placeholder="0"/></div>
      </div>
      <div style="padding:10px 12px;background:#fef3c7;border-radius:8px;font-size:11px;color:#92400e;margin-top:4px">
        ‚ö†Ô∏è Ces valeurs sont des ajustements manuels. L'accumulation automatique continue √† partir de ces bases.
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modal-ajust')">Annuler</button>
      <button class="btn btn-rh" onclick="saveAjust()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc,
           collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth=getAuth(app); const db=getFirestore(app);
  window._auth=auth; window._db=db;
  window._doc=doc; window._getDoc=getDoc; window._setDoc=setDoc;
  window._addDoc=addDoc; window._updateDoc=updateDoc; window._deleteDoc=deleteDoc;
  window._col=collection;
  window._getDocs=getDocs; window._query=query; window._where=where; window._orderBy=orderBy;
  window._signOut=signOut;
  onAuthStateChanged(auth,user=>{
    if(!user){window.location.href='index.html';return;}
    window._uid=user.uid;
    const name=user.displayName||user.email.split('@')[0];
    ['uname'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=name;});
    ['av'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=name.charAt(0).toUpperCase();});
    window._firebaseReady=true;
    window.initConges();
  });
</script>

<script>
// ‚ïê‚ïê CONSTANTES ‚ïê‚ïê
const TYPE_COLORS = {cp:'#059669',rtt:'#3b82f6',css:'#f59e0b',evenement:'#8b5cf6',maladie:'#ef4444',recuperation:'#0891b2',formation:'#0e7490'};
const TYPE_LBL    = {cp:'CP',rtt:'RTT',css:'Sans solde',evenement:'√âv√©nement',maladie:'Maladie',recuperation:'R√©cup√©ration',formation:'Formation'};
const TYPE_ICO    = {cp:'üèñÔ∏è',rtt:'‚è∞',css:'üíº',evenement:'üéâ',maladie:'ü§í',recuperation:'üîÑ',formation:'üìö'};
const COLORS_EMP  = ['#059669','#3b82f6','#8b5cf6','#f59e0b','#ef4444','#0891b2','#db2777','#ea580c'];

// ‚ïê‚ïê √âTAT ‚ïê‚ïê
let _emps    = {};  // {id: {...data, soldes:{...}}}
let _demandes= [];  // [{id, empId, type, dateDebut, dateFin, nbJours, statut, motif, ...}]
let _params  = {};
let _year    = new Date().getFullYear();
let _calMonth= new Date();
let _editDemandeId = null;
let _refusId = null;

// ‚ïê‚ïê INIT ‚ïê‚ïê
window.initConges = async function() {
  buildYearSel();
  await loadParams();
  await loadEmps();
  await loadDemandes();
  renderAll();
  // Recharger automatiquement si l'onglet reprend le focus
  // (cas : manager ouvre rh-employes dans un autre onglet et cr√©e un employ√©)
  document.addEventListener('visibilitychange', ()=>{
    if(document.visibilityState==='visible' && window._uid && window._firebaseReady) reloadAll();
  });
};

function buildYearSel(){
  const sel=document.getElementById('year-sel');
  const cur=new Date().getFullYear();
  sel.innerHTML=[cur+1,cur,cur-1,cur-2].map(y=>`<option value="${y}" ${y===cur?'selected':''}>${y}</option>`).join('');
}
function onYearChange(){ _year=parseInt(document.getElementById('year-sel').value); renderAll(); }

async function loadParams(){
  try{
    const s=await window._getDoc(window._doc(window._db,'rh_params',window._uid));
    _params = s.exists() ? s.data() : {};
  }catch(e){_params={};}
}

async function loadEmps(){
  if(!window._uid || !window._firebaseReady) return;
  _emps={};
  try{
    const s=await window._getDocs(window._col(window._db,'rh',window._uid,'employes'));
    s.forEach(d=>{ if(d.data().statut!=='archive') _emps[d.id]={id:d.id,...d.data()}; });
    // Diagnostic : si aucun employ√© trouv√©, afficher un message d'aide
    if(Object.keys(_emps).length===0){
      console.info('[rh-conges] Aucun employ√© actif trouv√© dans rh/'+window._uid+'/employes');
    }
  }catch(e){
    console.error('[rh-conges] Erreur chargement employ√©s:', e.code, e.message);
    // Afficher l'erreur dans la table des soldes
    const tbody=document.getElementById('soldes-body');
    if(tbody) tbody.innerHTML=`<tr><td colspan="9">
      <div style="padding:20px;text-align:center;color:#b91c1c;background:#fef2f2;border-radius:8px;font-size:12px">
        <div style="font-size:20px;margin-bottom:6px">‚ö†Ô∏è</div>
        <b>Impossible de charger les employ√©s</b><br>
        Code : ${e.code||'inconnu'} ‚Äî ${e.message||''}<br>
        <span style="color:#6b7280;font-size:11px;margin-top:4px;display:block">V√©rifiez que les r√®gles Firestore sont bien publi√©es (onglet R√®gles dans la console Firebase).</span>
        <button onclick="reloadAll()" style="margin-top:8px;padding:5px 12px;background:#059669;color:white;border:none;border-radius:6px;cursor:pointer;font-size:12px">üîÑ R√©essayer</button>
      </div>
    </td></tr>`;
  }
}

// Rechargement complet (employ√©s + demandes + rendu)
async function reloadAll(){
  const btn=document.getElementById('btn-refresh');
  if(btn){btn.textContent='‚è≥';btn.disabled=true;}
  await loadParams();
  await loadEmps();
  await loadDemandes();
  renderAll();
  if(btn){btn.textContent='üîÑ';btn.disabled=false;}
  showToast('‚úÖ Donn√©es recharg√©es','ok');
}
window.reloadAll=reloadAll;

async function loadDemandes(){
  if(!window._uid || !window._firebaseReady) return;
  _demandes=[];
  try{
    const s=await window._getDocs(window._col(window._db,'rh_conges',window._uid,'demandes'));
    s.forEach(d=>_demandes.push({id:d.id,...d.data()}));
    _demandes.sort((a,b)=>b.createdAt?.localeCompare?.(a.createdAt)||0);
  }catch(e){console.warn(e);}
}

// ‚ïê‚ïê CALCULS SOLDES ‚ïê‚ïê
function getDateEntree(emp){
  if(emp.dateEntree) return new Date(emp.dateEntree+'T12:00:00');
  return new Date(new Date().getFullYear()-1,0,1);
}

function calcCPAcquis(emp, year){
  // Accumulation : 2.08j/mois depuis la date d'entr√©e jusqu'√† aujourd'hui (ou fin de p√©riode)
  // P√©riode de r√©f√©rence : 1er juin N-1 ‚Üí 31 mai N (standard) ou selon rh-params
  const cpAnnuels = _params.cpAnnuels || 25;
  const cpMode = _params.cpPeriode || '1juin';

  let periodeDebut, periodeFin;
  if(cpMode === '1janv'){
    periodeDebut = new Date(year,0,1);
    periodeFin   = new Date(year,11,31);
  } else {
    // Standard : 1er juin N-1 ‚Üí 31 mai N
    periodeDebut = new Date(year-1,5,1);
    periodeFin   = new Date(year,4,31);
  }

  const entree = getDateEntree(emp);
  const debut  = entree > periodeDebut ? entree : periodeDebut;
  const fin    = new Date() < periodeFin ? new Date() : periodeFin;

  if(debut > fin) return emp.cpAjustAcquis||0;

  // Mois complets entre debut et fin
  const moisTotal = (fin.getFullYear()-debut.getFullYear())*12 + (fin.getMonth()-debut.getMonth());
  const taux = cpAnnuels / 12; // j/mois
  const acquis = Math.round((moisTotal * taux + (emp.cpAjustAcquis||0)) * 10) / 10;
  return Math.max(0, acquis);
}

function calcCPPris(empId, year){
  // Somme des demandes approuv√©es de type CP pour cet employ√© cette ann√©e
  return _demandes
    .filter(d=> d.empId===empId && d.type==='cp' && d.statut==='approved'
      && d.dateDebut && new Date(d.dateDebut).getFullYear()===year)
    .reduce((s,d)=>s+(parseFloat(d.nbJours)||0), 0);
}

function getSoldes(emp){
  const year = _year;
  const cpAcquis = calcCPAcquis(emp, year);
  const cpPris   = calcCPPris(emp.id, year);
  const cpRestant= Math.max(0, cpAcquis - cpPris);
  const rttRestant = Math.max(0, (emp.rttAjust||(_params.rttAnnuels||0)) -
    _demandes.filter(d=>d.empId===emp.id&&d.type==='rtt'&&d.statut==='approved'
      &&new Date(d.dateDebut||0).getFullYear()===year).reduce((s,d)=>s+(d.nbJours||0),0));
  const recupRestant = emp.recupHeures||0;
  const pending = _demandes.filter(d=>d.empId===emp.id&&d.statut==='pending').length;
  return {cpAcquis, cpPris, cpRestant, rttRestant, recupRestant, pending};
}

// Calcul jours ouvr√©s entre deux dates
function joursOuvres(deb, fin){
  if(!deb||!fin) return 0;
  let d = new Date(deb+'T12:00:00');
  const f = new Date(fin+'T12:00:00');
  let count = 0;
  while(d <= f){
    const dow = d.getDay();
    if(dow!==0 && dow!==6) count++;
    d.setDate(d.getDate()+1);
  }
  return count;
}

// ‚ïê‚ïê RENDER ‚ïê‚ïê
function renderAll(){
  renderKPIs();
  renderSoldesTable();
  renderDemandes();
  renderCalendrier();
  renderHistorique();
  fillEmpSelects();
  updateBadges();
}

function renderKPIs(){
  const emps = Object.values(_emps);
  let totalAcquis=0, totalPris=0, pending=0;
  emps.forEach(e=>{
    const s=getSoldes(e);
    totalAcquis+=s.cpAcquis; totalPris+=s.cpPris;
    pending+=s.pending;
  });
  set('k-emp', emps.length);
  set('k-acquis', totalAcquis.toFixed(1)+'j');
  set('k-pris', totalPris.toFixed(1)+'j');
  set('k-reste', (totalAcquis-totalPris).toFixed(1)+'j');
  set('k-pending', pending);
}

function renderSoldesTable(filter=''){
  const tbody = document.getElementById('soldes-body');
  const emps = Object.values(_emps).filter(e=>
    !filter || (e.prenom+' '+e.nom).toLowerCase().includes(filter.toLowerCase())
  );
  if(!emps.length){
    tbody.innerHTML=`<tr><td colspan="9">
      <div class="empty" style="padding:30px;text-align:center">
        <div class="empty-icon">üë•</div>
        <div style="font-weight:700;color:var(--text);margin-bottom:6px">Aucun employ√© actif</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:12px">
          Ajoutez des employ√©s dans <b>RH ‚Üí Employ√©s</b> pour g√©rer leurs cong√©s.<br>
          Si vous venez d'en ajouter, cliquez sur üîÑ pour recharger.
        </div>
        <button onclick="reloadAll()" style="padding:7px 16px;background:#059669;color:white;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:600">üîÑ Recharger les donn√©es</button>
      </div>
    </td></tr>`;
    return;
  }
  tbody.innerHTML = emps.map(e=>{
    const s = getSoldes(e);
    const pct = s.cpAcquis>0 ? Math.min(s.cpPris/s.cpAcquis*100,100) : 0;
    const col = e.couleur || COLORS_EMP[Object.keys(_emps).indexOf(e.id)%COLORS_EMP.length];
    const solvCls = s.cpRestant>10?'good':s.cpRestant>5?'warn':'low';
    const demPending = _demandes.filter(d=>d.empId===e.id&&d.statut==='pending').length;
    return `<tr>
      <td><div class="emp-cell">
        <div class="emp-av" style="background:${col}">${(e.prenom||'?').charAt(0).toUpperCase()}</div>
        <div><div class="emp-nm">${e.prenom||''} ${e.nom||''}</div><div class="emp-ps">${e.poste||'‚Äî'}</div></div>
      </div></td>
      <td><div style="font-size:13px;font-weight:700">${s.cpAcquis.toFixed(1)}j</div><div style="font-size:9px;color:var(--muted)">${_params.cpAnnuels||25}j/an</div></td>
      <td><div style="font-size:13px;font-weight:700">${s.cpPris.toFixed(1)}j</div>
          <div class="solde-bar"><div class="solde-fill" style="width:${pct}%;background:var(--orange)"></div></div></td>
      <td><div class="solde-val ${solvCls}">${s.cpRestant.toFixed(1)}j</div>
          <div class="solde-bar"><div class="solde-fill" style="width:${100-pct}%;background:var(--rh-main)"></div></div></td>
      <td><span class="solde-val ${s.rttRestant>0?'good':'low'}">${s.rttRestant.toFixed(1)}j</span></td>
      <td><span style="font-size:12px;font-weight:600;color:var(--muted)">${
        _demandes.filter(d=>d.empId===e.id&&d.type==='css'&&d.statut==='approved'&&new Date(d.dateDebut||0).getFullYear()===_year)
                 .reduce((s,d)=>s+(d.nbJours||0),0)
      }j</span></td>
      <td><span style="font-size:12px;font-weight:600;color:var(--teal)">${s.recupRestant.toFixed?.(1)||0}h</span></td>
      <td>${demPending>0?`<span class="badge badge-pending">${demPending} en attente</span>`:'<span style="color:var(--muted);font-size:11px">‚Äî</span>'}</td>
      <td><div style="display:flex;gap:5px">
        <button class="btn btn-outline btn-xs" onclick="openEmpDetail('${e.id}')">üìã</button>
        <button class="btn btn-rh btn-xs" onclick="openNewDemandeModal('${e.id}')">+</button>
      </div></td>
    </tr>`;
  }).join('');
}

function filterSoldes(v){ renderSoldesTable(v); }

function renderDemandes(search=''){
  const list = document.getElementById('demandes-list');
  const filterStatut = document.getElementById('dem-filter-statut')?.value||'';
  const filterType   = document.getElementById('dem-filter-type')?.value||'';
  const filterEmp    = document.getElementById('dem-filter-emp')?.value||'';

  let items = _demandes.filter(d=>{
    if(filterStatut && d.statut!==filterStatut) return false;
    if(filterType   && d.type!==filterType) return false;
    if(filterEmp    && d.empId!==filterEmp) return false;
    if(search){
      const emp = _emps[d.empId];
      const name = emp?`${emp.prenom||''} ${emp.nom||''}`.trim():d.empId;
      if(!name.toLowerCase().includes(search.toLowerCase()) && !(d.motif||'').toLowerCase().includes(search.toLowerCase())) return false;
    }
    return true;
  });

  if(!items.length){
    list.innerHTML=`<div class="empty"><div class="empty-icon">üìã</div>Aucune demande trouv√©e.</div>`;
    return;
  }

  list.innerHTML = items.map(d=>{
    const emp = _emps[d.empId]||{};
    const col = emp.couleur || COLORS_EMP[Object.keys(_emps).indexOf(d.empId)%COLORS_EMP.length];
    const name = `${emp.prenom||''} ${emp.nom||''}`.trim() || '‚ö†Ô∏è Employ√© introuvable';
    const sourceBadge = d.source==='salarie' ? '<span style="font-size:9px;font-weight:700;background:#dbeafe;color:#1e40af;padding:1px 6px;border-radius:10px;margin-left:4px">üì± Portail</span>' : '';
    const bg = TYPE_COLORS[d.type]+'22'||'#f3f4f6';
    const debFmt = d.dateDebut ? new Date(d.dateDebut+'T12:00:00').toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'}) : '?';
    const finFmt = d.dateFin   ? new Date(d.dateFin+'T12:00:00').toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'}) : debFmt;
    return `<div class="demande-card ${d.statut||''}">
      <div class="dem-type-icon" style="background:${bg}">${TYPE_ICO[d.type]||'üìã'}</div>
      <div class="emp-av" style="background:${col};width:32px;height:32px;border-radius:8px;font-size:13px;font-weight:700;color:white;display:flex;align-items:center;justify-content:center;flex-shrink:0">${(emp.prenom||'?').charAt(0).toUpperCase()}</div>
      <div class="dem-info">
        <div class="dem-name">${name}${sourceBadge} ‚Äî <span style="color:${TYPE_COLORS[d.type]||'#374151'}">${TYPE_LBL[d.type]||d.type}</span><span class="dem-jours">${d.nbJours||0}j</span></div>
        <div class="dem-dates">üìÖ ${debFmt}${d.dateFin&&d.dateFin!==d.dateDebut?' ‚Üí '+finFmt:''}</div>
        ${d.motif?`<div class="dem-motif">"${d.motif}"</div>`:''}
        ${d.motifRefus?`<div class="dem-motif" style="color:var(--red)">Motif refus : ${d.motifRefus}</div>`:''}
        ${d.justificatif?`<div style="margin-top:4px"><a href="${d.justificatif.data}" download="${d.justificatif.name}" style="font-size:11px;color:#059669;font-weight:600;text-decoration:none;background:#f0fdf4;border:1px solid #bbf7d0;padding:2px 8px;border-radius:6px;display:inline-flex;align-items:center;gap:4px">üìé ${d.justificatif.name} <span style="color:var(--muted);font-weight:400">(${(d.justificatif.size/1024).toFixed(0)}Ko)</span></a></div>`:''}
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
        <span class="badge badge-${d.statut||'pending'}">${{pending:'‚è≥ Attente',approved:'‚úÖ Approuv√©',refused:'‚ùå Refus√©',cancelled:'üö´ Annul√©'}[d.statut]||d.statut}</span>
        <div class="dem-actions">
          ${d.statut==='pending'?`
            <button class="btn btn-approve btn-xs" onclick="approuver('${d.id}')">‚úÖ</button>
            <button class="btn btn-refuse btn-xs" onclick="openRefus('${d.id}')">‚ùå</button>`:
          d.statut==='approved'?`<button class="btn btn-refuse btn-xs" onclick="annuler('${d.id}')">Annuler</button>`:''}
          <button class="btn btn-outline btn-xs" onclick="deleteDemande('${d.id}')" title="Supprimer">üóë</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function renderCalendrier(){
  const year  = _calMonth.getFullYear();
  const month = _calMonth.getMonth();
  const nbDays= new Date(year,month+1,0).getDate();

  document.getElementById('cal-label').textContent =
    new Date(year,month,1).toLocaleDateString('fr-FR',{month:'long',year:'numeric'});

  const emps = Object.values(_emps);
  if(!emps.length){ document.getElementById('cal-content').innerHTML='<div class="empty"><div class="empty-icon">üë•</div>Aucun employ√©.</div>'; return; }

  // Construire map : empId ‚Üí [types par jour]
  const absMap = {};
  emps.forEach(e=>{ absMap[e.id]=new Array(nbDays+1).fill(null); });

  _demandes.filter(d=>d.statut==='approved'||d.statut==='pending').forEach(d=>{
    if(!d.dateDebut||!absMap[d.empId]) return;
    let cur = new Date(d.dateDebut+'T12:00:00');
    const fin = new Date((d.dateFin||d.dateDebut)+'T12:00:00');
    while(cur<=fin){
      if(cur.getFullYear()===year && cur.getMonth()===month){
        const day=cur.getDate();
        if(!absMap[d.empId][day]) absMap[d.empId][day]=d.type;
      }
      cur.setDate(cur.getDate()+1);
    }
  });

  // Header jours
  let html = `<div style="display:grid;grid-template-columns:100px repeat(${nbDays},1fr);gap:1px;background:var(--border);border-radius:8px;overflow:hidden;min-width:${100+nbDays*22}px">`;
  // Ligne header
  html += `<div style="background:#f8faff;padding:4px 6px;font-size:10px;font-weight:700;color:var(--muted)">Employ√©</div>`;
  for(let d=1;d<=nbDays;d++){
    const dow=new Date(year,month,d).getDay();
    const isWe=dow===0||dow===6;
    const isToday=d===new Date().getDate()&&month===new Date().getMonth()&&year===new Date().getFullYear();
    html+=`<div style="background:${isToday?'var(--rh-ghost)':isWe?'#f3f4f6':'#f8faff'};padding:4px 2px;text-align:center;font-size:10px;font-weight:700;color:${isToday?'var(--rh-main)':'var(--muted)'}">${d}</div>`;
  }
  // Ligne par employ√©
  emps.forEach(e=>{
    const col=e.couleur||COLORS_EMP[Object.keys(_emps).indexOf(e.id)%COLORS_EMP.length];
    html+=`<div style="background:white;padding:5px 7px;display:flex;align-items:center;gap:5px">
      <div style="width:20px;height:20px;border-radius:5px;background:${col};display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:white;flex-shrink:0">${(e.prenom||'?').charAt(0).toUpperCase()}</div>
      <span style="font-size:10px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${e.prenom||''}</span>
    </div>`;
    for(let d=1;d<=nbDays;d++){
      const dow=new Date(year,month,d).getDay();
      const isWe=dow===0||dow===6;
      const type=absMap[e.id][d];
      html+=`<div style="background:${isWe?'#f3f4f6':'white'};position:relative;min-height:22px">
        ${type?`<div style="position:absolute;inset:1px;border-radius:2px;background:${TYPE_COLORS[type]||'#6b7280'};opacity:.8;display:flex;align-items:center;justify-content:center;font-size:8px" title="${TYPE_LBL[type]||type}"></div>`:''}
      </div>`;
    }
  });
  html+='</div>';
  document.getElementById('cal-content').innerHTML=html;
}

function prevMonth(){ _calMonth.setMonth(_calMonth.getMonth()-1); renderCalendrier(); }
function nextMonth(){ _calMonth.setMonth(_calMonth.getMonth()+1); renderCalendrier(); }

function renderHistorique(){
  const tbody = document.getElementById('historique-body');
  if(!_demandes.length){
    tbody.innerHTML=`<tr><td colspan="9"><div class="empty"><div class="empty-icon">üóÇÔ∏è</div>Aucun historique.</div></td></tr>`;
    return;
  }
  tbody.innerHTML = _demandes.map(d=>{
    const emp=_emps[d.empId]||{};
    const name=`${emp.prenom||''} ${emp.nom||''}`.trim()||'?';
    const fmtD=s=>s?new Date(s+'T12:00:00').toLocaleDateString('fr-FR'):'‚Äî';
    return `<tr>
      <td><div class="emp-cell"><div class="emp-av" style="background:${emp.couleur||'#6b7280'};width:24px;height:24px;border-radius:6px;font-size:10px;font-weight:700;color:white;display:flex;align-items:center;justify-content:center">${(emp.prenom||'?').charAt(0).toUpperCase()}</div><span style="font-size:12px;font-weight:600">${name}</span></div></td>
      <td>${TYPE_ICO[d.type]||'üìã'} ${TYPE_LBL[d.type]||d.type}</td>
      <td>${fmtD(d.dateDebut)}</td>
      <td>${fmtD(d.dateFin)}</td>
      <td><b>${d.nbJours||0}j</b></td>
      <td><span class="badge badge-${d.statut||'pending'}">${{pending:'‚è≥',approved:'‚úÖ',refused:'‚ùå',cancelled:'üö´'}[d.statut]||''} ${d.statut||'?'}</span></td>
      <td style="font-size:11px;color:var(--muted)">${d.createdAt?new Date(d.createdAt).toLocaleDateString('fr-FR'):'‚Äî'}</td>
      <td style="font-size:11px;color:var(--muted)">${d.traitePar||'‚Äî'}</td>
      <td style="font-size:11px;color:var(--red)">${d.motifRefus||''}</td>
    </tr>`;
  }).join('');
}

function updateBadges(){
  const pending=_demandes.filter(d=>d.statut==='pending').length;
  const approved=Object.values(_emps).length;
  set('badge-pending', pending||'0');
  set('badge-emp', approved||'0');
}

function fillEmpSelects(){
  const opts = Object.values(_emps).map(e=>`<option value="${e.id}">${e.prenom||''} ${e.nom||''}</option>`).join('');
  ['d-emp','aj-emp','dem-filter-emp'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){
      const isFilter = id==='dem-filter-emp';
      el.innerHTML = (isFilter?'<option value="">Tous les employ√©s</option>':'')+opts;
    }
  });
}

// ‚ïê‚ïê MODAL NOUVELLE DEMANDE ‚ïê‚ïê
function openNewDemandeModal(empId=''){
  _editDemandeId=null;
  document.getElementById('dem-modal-title').textContent='+ Nouvelle demande de cong√©';
  document.getElementById('d-emp').value = empId||Object.keys(_emps)[0]||'';
  document.getElementById('d-type').value='cp';
  document.getElementById('d-statut').value='approved';
  document.getElementById('d-deb').value='';
  document.getElementById('d-fin').value='';
  document.getElementById('d-motif').value='';
  document.getElementById('d-jours-info').style.display='none';
  document.getElementById('d-solde-warn').style.display='none';
  document.getElementById('d-evenement-info').style.display='none';
  document.getElementById('d-justif-wrap').style.display='none';
  clearJustif();
  calcJours();
  document.getElementById('modal-demande').classList.add('show');
}
window.openNewDemandeModal=openNewDemandeModal;

function onEmpChange(){ calcJours(); }
function calcJours(){
  const deb=document.getElementById('d-deb')?.value;
  const fin=document.getElementById('d-fin')?.value;
  const type=document.getElementById('d-type')?.value;
  const infoEl=document.getElementById('d-jours-info');
  const warnEl=document.getElementById('d-solde-warn');
  const evEl=document.getElementById('d-evenement-info');

  // Afficher info √©v√©nements familiaux
  if(evEl) evEl.style.display = type==='evenement'?'':'none';

  // Afficher zone justificatif si maladie ou formation
  const justifWrap=document.getElementById('d-justif-wrap');
  if(justifWrap) justifWrap.style.display = (type==='maladie'||type==='formation')?'':'none';

  if(!deb){infoEl.style.display='none';return;}
  const finDate = fin||deb;
  const jours = joursOuvres(deb, finDate);
  if(jours>0){
    infoEl.textContent=`üìÖ ${jours} jour(s) ouvr√©(s)`;
    infoEl.style.display='block';
    // V√©rifier le solde si CP
    if(type==='cp'||type==='rtt'){
      const empId=document.getElementById('d-emp')?.value;
      const emp=_emps[empId];
      if(emp){
        const s=getSoldes(emp);
        const solde=type==='cp'?s.cpRestant:s.rttRestant;
        if(jours>solde){
          warnEl.textContent=`‚ö†Ô∏è Solde insuffisant : ${solde.toFixed(1)}j disponibles, ${jours}j demand√©s`;
          warnEl.style.display='block';
        } else {
          warnEl.style.display='none';
        }
      }
    } else {
      warnEl.style.display='none';
    }
  } else {
    infoEl.style.display='none';
    warnEl.style.display='none';
  }
}
window.calcJours=calcJours; window.onEmpChange=onEmpChange;

// Gestion fichier justificatif
let _justifBase64 = null;
let _justifMeta   = null;

function onJustifChange(input){
  const file = input.files[0];
  if(!file) return;
  if(file.size > 5*1024*1024){ showToast('Fichier trop lourd (max 5 Mo)','err'); return; }
  const reader = new FileReader();
  reader.onload = e => {
    _justifBase64 = e.target.result; // data:type;base64,...
    _justifMeta   = { name: file.name, size: file.size, type: file.type };
    // Afficher preview
    const prev = document.getElementById('d-justif-preview');
    const nm   = document.getElementById('d-justif-name');
    const sz   = document.getElementById('d-justif-size');
    if(nm) nm.textContent = file.name;
    if(sz) sz.textContent = (file.size/1024).toFixed(0)+'Ko';
    if(prev){ prev.style.display='flex'; }
    // Cacher la zone drop
    const drop = document.getElementById('d-justif-drop');
    if(drop) drop.style.display='none';
  };
  reader.readAsDataURL(file);
}
window.onJustifChange=onJustifChange;

function clearJustif(){
  _justifBase64=null; _justifMeta=null;
  const inp=document.getElementById('d-justif-input');
  if(inp) inp.value='';
  const prev=document.getElementById('d-justif-preview');
  if(prev) prev.style.display='none';
  const drop=document.getElementById('d-justif-drop');
  if(drop) drop.style.display='';
}
window.clearJustif=clearJustif;

async function saveDemande(){
  const empId=document.getElementById('d-emp')?.value;
  const type=document.getElementById('d-type')?.value;
  const deb=document.getElementById('d-deb')?.value;
  const fin=document.getElementById('d-fin')?.value||deb;
  const statut=document.getElementById('d-statut')?.value;
  const motif=document.getElementById('d-motif')?.value.trim();

  if(!empId||!deb){ showToast('Employ√© et date de d√©but requis','err'); return; }

  const jours = joursOuvres(deb, fin);
  const data={
    empId, type, dateDebut:deb, dateFin:fin, nbJours:jours,
    statut, motif:motif||null, createdAt:new Date().toISOString(),
    traitePar:document.getElementById('uname')?.textContent||'Manager'
  };

  // Ajouter le justificatif si pr√©sent (base64 stock√© en Firestore)
  if(_justifBase64 && _justifMeta){
    data.justificatif = { data: _justifBase64, name: _justifMeta.name, size: _justifMeta.size, type: _justifMeta.type };
  }

  const btn=document.getElementById('btn-save-dem');
  if(btn){btn.disabled=true;btn.textContent='‚è≥ Enregistrement...';}
  try{
    if(_editDemandeId){
      await window._updateDoc(window._doc(window._db,'rh_conges',window._uid,'demandes',_editDemandeId),data);
    } else {
      await window._addDoc(window._col(window._db,'rh_conges',window._uid,'demandes'),data);
    }
    clearJustif();
    closeModal('modal-demande');
    await loadDemandes();
    renderAll();
    showToast('‚úÖ Demande enregistr√©e','ok');
  }catch(e){ showToast('Erreur : '+e.message,'err'); }
  finally{ if(btn){btn.disabled=false;btn.textContent='üíæ Enregistrer';} }
}
window.saveDemande=saveDemande;

// ‚ïê‚ïê ACTIONS ‚ïê‚ïê
async function approuver(id){
  try{
    await window._updateDoc(window._doc(window._db,'rh_conges',window._uid,'demandes',id),
      {statut:'approved', traitePar:document.getElementById('uname')?.textContent||'Manager', traiteLe:new Date().toISOString()});
    const idx=_demandes.findIndex(d=>d.id===id);
    if(idx>=0){_demandes[idx].statut='approved';}
    renderAll();
    showToast('‚úÖ Demande approuv√©e','ok');
  }catch(e){ showToast('Erreur','err'); }
}
window.approuver=approuver;

function openRefus(id){ _refusId=id; document.getElementById('refus-motif').value=''; document.getElementById('modal-refus').classList.add('show'); }
window.openRefus=openRefus;

async function confirmRefus(){
  const motif=document.getElementById('refus-motif').value.trim();
  try{
    await window._updateDoc(window._doc(window._db,'rh_conges',window._uid,'demandes',_refusId),
      {statut:'refused', motifRefus:motif||null, traitePar:document.getElementById('uname')?.textContent||'Manager', traiteLe:new Date().toISOString()});
    const idx=_demandes.findIndex(d=>d.id===_refusId);
    if(idx>=0){_demandes[idx].statut='refused';_demandes[idx].motifRefus=motif||null;}
    closeModal('modal-refus');
    renderAll();
    showToast('‚ùå Demande refus√©e','ok');
  }catch(e){ showToast('Erreur','err'); }
}
window.confirmRefus=confirmRefus;

async function annuler(id){
  if(!confirm('Annuler cette demande approuv√©e ?')) return;
  try{
    await window._updateDoc(window._doc(window._db,'rh_conges',window._uid,'demandes',id),{statut:'cancelled'});
    const idx=_demandes.findIndex(d=>d.id===id);
    if(idx>=0) _demandes[idx].statut='cancelled';
    renderAll();
    showToast('Demande annul√©e','ok');
  }catch(e){ showToast('Erreur','err'); }
}
window.annuler=annuler;

async function deleteDemande(id){
  if(!confirm('Supprimer d√©finitivement cette demande ?')) return;
  try{
    await window._deleteDoc(window._doc(window._db,'rh_conges',window._uid,'demandes',id));
    _demandes=_demandes.filter(d=>d.id!==id);
    renderAll();
    showToast('Supprim√©','ok');
  }catch(e){ showToast('Erreur','err'); }
}
window.deleteDemande=deleteDemande;

// ‚ïê‚ïê AJUSTEMENT SOLDES ‚ïê‚ïê
function openAjustModal(){
  document.getElementById('modal-ajust').classList.add('show');
  loadAjustForm();
}
window.openAjustModal=openAjustModal;

function loadAjustForm(){
  const empId=document.getElementById('aj-emp')?.value;
  const emp=_emps[empId];
  if(!emp) return;
  const s=getSoldes(emp);
  setV('aj-acquis', emp.cpAjustAcquis||s.cpAcquis.toFixed(1));
  setV('aj-pris', s.cpPris.toFixed(1));
  setV('aj-rtt', emp.rttAjust||(_params.rttAnnuels||0));
  setV('aj-recup', emp.recupHeures||0);
}
window.loadAjustForm=loadAjustForm;

async function saveAjust(){
  const empId=document.getElementById('aj-emp')?.value;
  if(!empId) return;
  const data={
    cpAjustAcquis: parseFloat(document.getElementById('aj-acquis')?.value)||0,
    rttAjust:      parseFloat(document.getElementById('aj-rtt')?.value)||0,
    recupHeures:   parseFloat(document.getElementById('aj-recup')?.value)||0,
  };
  try{
    // Mise √† jour fiche priv√©e
    await window._updateDoc(window._doc(window._db,'rh',window._uid,'employes',empId),data);
    Object.assign(_emps[empId],data);
    // Synchroniser fiche publique (portail salari√©) si publicId existe
    const emp=_emps[empId];
    if(emp?.publicId){
      await window._updateDoc(window._doc(window._db,'rh_employes_public',emp.publicId),{
        cpAjustAcquis: data.cpAjustAcquis,
        rttAjust:      data.rttAjust,
        recupHeures:   data.recupHeures,
      });
    }
    closeModal('modal-ajust');
    renderAll();
    showToast('‚úÖ Soldes mis √† jour','ok');
  }catch(e){ showToast('Erreur : '+e.message,'err'); }
}
window.saveAjust=saveAjust;

// ‚ïê‚ïê D√âTAIL EMPLOY√â ‚ïê‚ïê
function openEmpDetail(id){
  // Basculer sur l'onglet demandes filtr√© par cet employ√©
  document.getElementById('dem-filter-emp').value=id;
  switchTab('demandes', document.querySelectorAll('.tab')[1]);
  renderDemandes();
}
window.openEmpDetail=openEmpDetail;

// ‚ïê‚ïê EXPORT CSV ‚ïê‚ïê
function exportCSV(){
  const rows=[['Employ√©','Type','Date d√©but','Date fin','Jours','Statut','Demand√© le','Motif']];
  _demandes.forEach(d=>{
    const emp=_emps[d.empId]||{};
    rows.push([`${emp.prenom||''} ${emp.nom||''}`,TYPE_LBL[d.type]||d.type,d.dateDebut||'',d.dateFin||'',d.nbJours||0,d.statut||'',d.createdAt?d.createdAt.slice(0,10):'',d.motif||'',d.justificatif?d.justificatif.name:'']);
  });
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent('\uFEFF'+csv);
  a.download=`conges_${_year}.csv`;
  a.click();
}
window.exportCSV=exportCSV;

// ‚ïê‚ïê TABS ‚ïê‚ïê
function switchTab(id, el){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+id)?.classList.add('active');
  el?.classList.add('active');
  if(id==='calendrier') renderCalendrier();
}
window.switchTab=switchTab;

// ‚ïê‚ïê UTILS ‚ïê‚ïê
function set(id,v){const el=document.getElementById(id);if(el)el.textContent=v;}
function setV(id,v){const el=document.getElementById(id);if(el)el.value=v;}
function closeModal(id){document.getElementById(id)?.classList.remove('show');}
window.closeModal=closeModal;
function showToast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(()=>t.className='toast',3200);}

function toggleSidebar(){document.querySelector('.sidebar')?.classList.toggle('open');document.getElementById('nav-overlay')?.classList.toggle('show');}
function closeSidebar(){document.querySelector('.sidebar')?.classList.remove('open');document.getElementById('nav-overlay')?.classList.remove('show');}
window.toggleSidebar=toggleSidebar;window.closeSidebar=closeSidebar;
</script>

<script src="nav.js"></script>
<script>
(function openRhNav(){
  var tries=0;
  var t=setInterval(function(){
    var sub=document.getElementById('rh-nav-sub');
    var nav=document.getElementById('alteore-nav');
    if(sub&&nav){clearInterval(t);sub.style.maxHeight='2000px';nav.classList.add('rh-mode');}
    if(++tries>50)clearInterval(t);
  },50);
})();
</script>
</body>
</html>
