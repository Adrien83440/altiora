<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE - Documents RH</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --blue-dark:#0f1f5c;--blue-main:#1a3dce;--blue-light:#4f7ef8;--blue-ghost:#f0f4ff;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f5f7ff;--sidebar-w:252px;--radius:12px;
      --green:#10b981;--green-light:#d1fae5;--orange:#f59e0b;--orange-light:#fef3c7;
      --red:#ef4444;--red-light:#fee2e2;--purple:#6366f1;--purple-light:#eef2ff;--teal:#14b8a6;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-width:0;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:17px;font-weight:700;}
    .topbar-left p{font-size:12px;color:var(--muted);margin-top:2px;}
    .topbar-right{display:flex;align-items:center;gap:10px;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.18s;}
    .btn-primary{background:linear-gradient(135deg,var(--blue-main),var(--blue-light));color:white;box-shadow:0 3px 10px rgba(26,61,206,0.25);}
    .btn-primary:hover{opacity:0.9;transform:translateY(-1px);}
    .btn-outline{background:white;color:var(--blue-main);border:1.5px solid var(--border);}
    .btn-outline:hover{border-color:var(--blue-main);background:var(--blue-ghost);}
    .btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}
    .btn-success{background:linear-gradient(135deg,#10b981,#34d399);color:white;}
    .btn-ai{background:linear-gradient(135deg,#7c3aed,#a855f7);color:white;box-shadow:0 3px 12px rgba(124,58,237,0.3);}
    .btn-ai:hover{opacity:0.9;transform:translateY(-1px);}
    .btn-sm{padding:5px 12px;font-size:12px;}
    .btn-xs{padding:3px 8px;font-size:11px;}
    .content{padding:22px 28px;flex:1;display:flex;gap:20px;min-height:0;}
    .left-panel{width:300px;flex-shrink:0;display:flex;flex-direction:column;gap:14px;}
    .right-panel{flex:1;min-width:0;display:flex;flex-direction:column;gap:16px;}
    .panel-card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .panel-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);}
    .panel-title{font-size:13px;font-weight:700;color:var(--text);}
    .search-wrap{padding:10px 12px;border-bottom:1px solid var(--border);}
    .search-input{width:100%;padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;outline:none;}
    .search-input:focus{border-color:var(--blue-main);}
    .cat-header{font-size:10px;font-weight:700;color:var(--muted);letter-spacing:0.8px;text-transform:uppercase;padding:10px 14px 4px;}
    .doc-item{display:flex;align-items:center;gap:10px;padding:9px 14px 9px 16px;cursor:pointer;border-left:3px solid transparent;transition:all 0.15s;}
    .doc-item:hover{background:#fafbff;border-left-color:#c7d2fe;}
    .doc-item.active{background:var(--blue-ghost);border-left-color:var(--blue-main);}
    .doc-icon{font-size:17px;width:22px;text-align:center;flex-shrink:0;}
    .doc-info{flex:1;min-width:0;}
    .doc-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .doc-sub{font-size:10px;color:var(--muted);}
    .doc-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:10px;flex-shrink:0;}
    .badge-legal{background:#dcfce7;color:#166534;}
    .badge-entretien{background:#dbeafe;color:#1e40af;}
    .badge-culture{background:#f3e8ff;color:#6b21a8;}
    .badge-admin{background:#fef3c7;color:#92400e;}
    .badge-disciplinaire{background:#fee2e2;color:#991b1b;}
    .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:500px;text-align:center;color:var(--muted);padding:40px;}
    .empty-icon{font-size:52px;margin-bottom:14px;}
    .doc-header{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:22px 24px;}
    .doc-big-title{font-size:20px;font-weight:800;display:flex;align-items:center;gap:10px;margin-bottom:6px;}
    .doc-desc{font-size:12px;color:var(--muted);line-height:1.6;margin-bottom:14px;}
    .doc-tags{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;}
    .doc-tag{font-size:11px;padding:4px 10px;border-radius:20px;font-weight:600;}
    .legal-banner{background:linear-gradient(135deg,#eff6ff,#f0fdf4);border:1px solid #bfdbfe;border-radius:10px;padding:12px 16px;display:flex;align-items:flex-start;gap:10px;}
    .legal-banner-icon{font-size:18px;flex-shrink:0;margin-top:1px;}
    .legal-banner-text{font-size:12px;color:#1e40af;line-height:1.5;}
    .form-section{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .form-section-head{padding:14px 18px;background:#f8faff;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
    .form-section-title{font-size:13px;font-weight:700;}
    .form-body{padding:18px;}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .form-field{display:flex;flex-direction:column;gap:5px;}
    .form-field.full{grid-column:1/-1;}
    .form-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.3px;}
    .form-label span{color:var(--red);margin-left:2px;}
    .form-input{padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;background:white;transition:border-color 0.15s;}
    .form-input:focus{border-color:var(--blue-main);box-shadow:0 0 0 3px rgba(79,126,248,0.1);}
    .form-textarea{resize:vertical;min-height:80px;line-height:1.5;}
    .form-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b7280' fill='none' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;padding-right:30px;}
    .generate-bar{background:linear-gradient(135deg,#1e1b4b,#312e81);border-radius:var(--radius);padding:20px 24px;display:flex;align-items:center;justify-content:space-between;gap:16px;}
    .generate-bar-text h3{font-size:14px;font-weight:700;color:white;margin-bottom:4px;}
    .generate-bar-text p{font-size:12px;color:rgba(255,255,255,0.6);}
    .generate-bar-actions{display:flex;gap:10px;flex-shrink:0;}
    .generated-doc{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .generated-doc-head{padding:14px 18px;background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-bottom:1px solid #bbf7d0;display:flex;align-items:center;justify-content:space-between;}
    .generated-doc-title{font-size:13px;font-weight:700;color:#166534;display:flex;align-items:center;gap:8px;}
    .doc-content-wrap{padding:28px 36px;min-height:300px;}
    .doc-content{font-size:13px;line-height:1.9;color:var(--text);}
    .doc-content h2{font-size:14px;font-weight:800;margin:22px 0 10px;color:var(--blue-dark);text-transform:uppercase;letter-spacing:0.5px;}
    .doc-content h3{font-size:13px;font-weight:700;margin:16px 0 8px;}
    .doc-content p{margin-bottom:10px;}
    .doc-content ul{margin:8px 0 10px 22px;}
    .doc-content li{margin-bottom:5px;}
    .field-blank{background:#fef9c3;border-bottom:1px solid #d97706;padding:0 4px;display:inline-block;min-width:80px;}
    .ai-loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 40px;gap:14px;text-align:center;}
    .ai-spinner{width:40px;height:40px;border:3px solid #e8eaf6;border-top-color:#7c3aed;border-radius:50%;animation:spin 0.8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .ai-loading-text{font-size:14px;font-weight:700;color:#6b21a8;}
    .ai-loading-sub{font-size:12px;color:var(--muted);}
    .hist-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s;}
    .hist-item:hover{background:#fafbff;}
    .hist-item:last-child{border-bottom:none;}
    .hist-icon{font-size:20px;flex-shrink:0;}
    .hist-info{flex:1;min-width:0;}
    .hist-name{font-size:12px;font-weight:600;}
    .hist-meta{font-size:10px;color:var(--muted);}
    .hist-del{background:none;border:none;cursor:pointer;color:var(--muted);font-size:14px;padding:4px;opacity:0;transition:opacity 0.15s;}
    .hist-item:hover .hist-del{opacity:1;}
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all 0.3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.success{background:#10b981;}
    .toast.warning{background:#f59e0b;}
    html,body{overflow-x:hidden;max-width:100vw;}
    .hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:#0f1f5c;border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(15,31,92,.45);}
    .hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;}
    .nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;}
    .nav-overlay.show{display:block;}
    @media(max-width:768px){
      .hamburger{display:flex!important;}
      nav,aside.sidebar,.sidebar{position:fixed!important;top:0!important;left:0!important;height:100vh!important;width:min(280px,84vw)!important;z-index:1001!important;transform:translateX(-105%)!important;transition:transform .3s cubic-bezier(.4,0,.2,1)!important;overflow-y:auto!important;}
      nav.open,aside.sidebar.open,.sidebar.open{transform:translateX(0)!important;box-shadow:8px 0 32px rgba(0,0,0,.3)!important;}
      .main{margin-left:0!important;width:100vw!important;}
      .topbar{padding:10px 10px 10px 62px!important;}
      .content{flex-direction:column!important;padding:12px 10px!important;}
      .left-panel{width:100%!important;}
      .form-grid{grid-template-columns:1fr!important;}
      .generate-bar{flex-direction:column!important;align-items:flex-start!important;}
    }
  </style>
</head>
<body>

<button class="hamburger" id="hamburger-btn" onclick="toggleMobileNav()" aria-label="Menu">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="nav-overlay" onclick="toggleMobileNav()"></div>

<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>üìÑ Documents RH</h1>
      <p>Bibliotheque de modeles - Generation IA - <strong style="color:#dc2626">ALTEORE n'est pas un logiciel juridique et ne se substitue pas a un juriste ou conseil juridique</strong></p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="showHistory()">üïê Historique</button>
      <button class="btn btn-ai btn-sm" onclick="openNewDoc()">‚ú® Nouveau document</button>
    </div>
  </div>

  <div class="content">
    <div class="left-panel">
      <div class="panel-card" style="flex:1;overflow-y:auto;max-height:calc(100vh - 100px)">
        <div class="panel-head">
          <div class="panel-title"> Catalogue</div>
          <span style="font-size:11px;color:var(--muted)" id="doc-count"></span>
        </div>
        <div class="search-wrap">
          <input class="search-input" id="search-docs" placeholder=" Rechercher..." oninput="filterDocs(this.value)"/>
        </div>
        <div id="doc-list"></div>
      </div>
    </div>

    <div class="right-panel" id="right-panel">
      <div class="empty-state">
        <div class="empty-icon"></div>
        <h3 style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px">Choisissez un modele</h3>
        <p style="font-size:13px;line-height:1.7;max-width:340px">Selectionnez un document dans la bibliotheque, renseignez les informations, et l'IA genere un modele base sur le droit du travail francais.</p>
        <div style="margin-top:14px;background:#fff7ed;border:1px solid #fed7aa;border-radius:10px;padding:12px 14px;max-width:400px;font-size:12px;color:#9a3412;line-height:1.5;text-align:left">
          <strong>Important :</strong> ALTEORE est un outil d'aide a la redaction. Nous ne sommes pas un logiciel juridique et ces modeles ne se substituent pas a l'avis d'un juriste ou d'un avocat specialise en droit du travail. Consultez un professionnel pour toute situation sensible.
        </div>
        <div style="display:flex;gap:12px;margin-top:20px;flex-wrap:wrap;justify-content:center">
          <button class="btn btn-primary" onclick="selectDoc('rupture-conventionnelle')"> Rupture conventionnelle</button>
          <button class="btn btn-outline" onclick="selectDoc('entretien-annuel')"> Entretien annuel</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL HISTORIQUE -->
<div id="hist-modal" style="position:fixed;inset:0;background:rgba(15,31,92,.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;">
  <div style="background:white;border-radius:16px;width:100%;max-width:560px;box-shadow:0 24px 60px rgba(15,31,92,.2);overflow:hidden;max-height:90vh;display:flex;flex-direction:column;">
    <div style="padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0">
      <h3 style="font-size:15px;font-weight:700"> Documents generes</h3>
      <button style="background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted)" onclick="closeHistModal()">x</button>
    </div>
    <div id="hist-list" style="overflow-y:auto;flex:1;"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth=getAuth(app); const db=getFirestore(app);
  window._auth=auth; window._db=db;
  window._doc=doc; window._setDoc=setDoc; window._getDoc=getDoc;
  window._collection=collection; window._getDocs=getDocs;
  window._deleteDoc=deleteDoc; window._addDoc=addDoc;
  window._signOut=signOut;
  onAuthStateChanged(auth, user=>{
    if(!user){window.location.href='index.html';return;}
    window._uid=user.uid;
    window._firebaseReady=true;
    function tryStart(){if(typeof window.startApp==='function')window.startApp();else setTimeout(tryStart,30);}
    tryStart();
  });
</script>

<script>
var DOCS_CATALOGUE=[
  {id:'avertissement',cat:'Mesures disciplinaires',icon:'‚ö†Ô∏è',name:'Avertissement',sub:'Sanction ecrite mineure',badge:'disciplinaire',
   legal:'L1331-1 a L1331-4 CT - Prescription 3 ans - Pas entretien prealable si faute mineure',
   tags:['Disciplinaire','Sanction'],
   fields:[
    {id:'emp_nom',label:'Nom complet du salarie',type:'text',required:true,placeholder:'Jean Dupont'},
    {id:'emp_poste',label:'Poste occupe',type:'text',required:true},
    {id:'emp_date_contrat',label:"Date d'embauche",type:'date',required:true},
    {id:'entreprise_nom',label:"Nom de l'entreprise",type:'text',required:true},
    {id:'signataire',label:'Nom du signataire',type:'text',required:true},
    {id:'date_faits',label:'Date des faits reproches',type:'date',required:true},
    {id:'description_faits',label:'Description precise des faits',type:'textarea',required:true,placeholder:'Date, lieu, comportement constate...'},
    {id:'date_doc',label:'Date du document',type:'date',required:true}
   ]
  },
  {id:'mise-en-demeure',cat:'Mesures disciplinaires',icon:'üö®',name:'Mise en demeure',sub:'Injonction formelle de respecter les obligations contractuelles',badge:'disciplinaire',
   legal:'Droit general des contrats + droit du travail - Constitue une preuve ecrite opposable',
   tags:['Disciplinaire','Lettre AR'],
   fields:[
    {id:'emp_nom',label:'Nom du salarie',type:'text',required:true},
    {id:'emp_poste',label:'Poste',type:'text',required:true},
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'signataire',label:'Signataire',type:'text',required:true},
    {id:'objet_demeure',label:'Objet de la mise en demeure',type:'select',required:true,options:['Retards repetes','Absences non justifiees','Non-respect du reglement interieur','Non-atteinte des objectifs','Insubordination','Autre']},
    {id:'detail_faits',label:'Detail des faits et manquements',type:'textarea',required:true},
    {id:'delai_reg',label:'Delai accorde pour regularisation',type:'select',options:['48 heures','72 heures','1 semaine','15 jours']},
    {id:'date_doc',label:'Date du document',type:'date',required:true}
   ]
  },
  {id:'mise-a-pied-conservatoire',cat:'Mesures disciplinaires',icon:'üîí',name:'Mise a pied conservatoire',sub:'Suspension immediate en cas de faute grave presumee',badge:'disciplinaire',
   legal:'L1332-3 CT - Mesure provisoire non disciplinaire - Doit etre suivie dans les 8 jours d\'une procedure disciplinaire',
   tags:['Disciplinaire','Mise a pied','Urgence'],
   fields:[
    {id:'emp_nom',label:'Nom du salarie',type:'text',required:true},
    {id:'emp_poste',label:'Poste',type:'text',required:true},
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'signataire',label:'Signataire',type:'text',required:true},
    {id:'date_faits',label:'Date et heure des faits',type:'text',required:true,placeholder:'Lundi 24 mars 2025 a 14h30'},
    {id:'nature_faute',label:'Nature de la faute presumee',type:'textarea',required:true},
    {id:'date_entretien',label:'Date convocation entretien disciplinaire',type:'date',required:true},
    {id:'date_doc',label:'Date du document',type:'date',required:true}
   ]
  },
  {id:'licenciement-faute-grave',cat:'Mesures disciplinaires',icon:'‚õî',name:'Licenciement - Faute grave',sub:'Sans preavis ni indemnite de licenciement',badge:'disciplinaire',
   legal:'L1234-1 CT - Entretien prealable obligatoire - Pas de preavis - Lettre LRAR apres entretien',
   tags:['Licenciement','Faute grave','LRAR'],
   fields:[
    {id:'emp_nom',label:'Nom du salarie',type:'text',required:true},
    {id:'emp_poste',label:'Poste',type:'text',required:true},
    {id:'emp_anciennete',label:"Date d'embauche",type:'date',required:true},
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'signataire',label:'Signataire',type:'text',required:true},
    {id:'date_entretien',label:"Date de l'entretien prealable",type:'date',required:true},
    {id:'nature_faute',label:'Nature et description precise de la faute grave',type:'textarea',required:true},
    {id:'date_faits',label:'Date des faits constitutifs',type:'date',required:true},
    {id:'date_doc',label:'Date du courrier',type:'date',required:true}
   ]
  },
  {id:'licenciement-cause-reelle',cat:'Mesures disciplinaires',icon:'üìã',name:'Licenciement - Cause reelle et serieuse',sub:'Motif personnel non disciplinaire',badge:'disciplinaire',
   legal:'L1232-1 CT - Entretien prealable obligatoire - Delai 2 jours ouvrables mini - Lettre LRAR',
   tags:['Licenciement','Motif personnel','LRAR'],
   fields:[
    {id:'emp_nom',label:'Nom du salarie',type:'text',required:true},
    {id:'emp_poste',label:'Poste',type:'text',required:true},
    {id:'emp_anciennete',label:"Date d'entree dans l'entreprise",type:'date',required:true},
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'signataire',label:'Signataire',type:'text',required:true},
    {id:'date_entretien',label:"Date de l'entretien prealable",type:'date',required:true},
    {id:'motif',label:'Motif detaille du licenciement',type:'textarea',required:true,placeholder:'Insuffisance professionnelle, absences repetees...'},
    {id:'preavis',label:'Duree du preavis',type:'select',options:['1 mois','2 mois','3 mois','Dispense de preavis (indemnite compensatrice)']},
    {id:'date_doc',label:'Date du courrier',type:'date',required:true}
   ]
  },
  {id:'rupture-conventionnelle',cat:'Ruptures de contrat',icon:'ü§ù',name:'Convention de rupture conventionnelle',sub:"Rupture d'un CDI a l'amiable (homologuee DREETS)",badge:'legal',
   legal:"L1237-11 a L1237-16 CT - 1 entretien min. - Cerfa 14598*01 - Delai retractation 15 jours cal. - Homologation DREETS 15 jours ouvrables",
   tags:['Rupture CDI','DREETS','Cerfa','Homologation'],
   fields:[
    {id:'emp_nom',label:'Nom complet du salarie',type:'text',required:true,placeholder:'Jean Dupont'},
    {id:'emp_adresse',label:'Adresse du salarie',type:'text',required:true},
    {id:'emp_poste',label:'Poste occupe',type:'text',required:true},
    {id:'emp_anciennete',label:"Date d'entree dans l'entreprise",type:'date',required:true},
    {id:'entreprise_nom',label:"Nom de l'entreprise",type:'text',required:true},
    {id:'entreprise_adresse',label:"Adresse de l'entreprise",type:'text',required:true},
    {id:'entreprise_siret',label:'SIRET',type:'text',required:false,placeholder:'XXX XXX XXX XXXXX'},
    {id:'signataire',label:"Representant de l'entreprise",type:'text',required:true},
    {id:'date_1er_entretien',label:'Date du 1er entretien',type:'date',required:true},
    {id:'date_rupture',label:'Date envisagee de rupture',type:'date',required:true},
    {id:'indemnite',label:'Indemnite specifique de rupture (EUR)',type:'number',required:true,placeholder:'Montant minimum legal'},
    {id:'motif_commun',label:'Contexte de la rupture (facultatif)',type:'textarea',required:false,placeholder:'Depart en retraite, reconversion, accord mutuel...'}
   ]
  },
  {id:'demission-accuse',cat:'Ruptures de contrat',icon:'üö™',name:'Accuse reception demission',sub:'Prise d acte ecrite de la demission',badge:'admin',
   legal:'Pas de formalisme legal - Recommande d\'accuser reception par ecrit - Preavis selon convention collective',
   tags:['Demission','Accuse reception'],
   fields:[
    {id:'emp_nom',label:'Nom du salarie',type:'text',required:true},
    {id:'emp_poste',label:'Poste',type:'text',required:true},
    {id:'date_demission',label:'Date de la lettre de demission',type:'date',required:true},
    {id:'preavis',label:'Duree du preavis',type:'select',options:['1 semaine','1 mois','2 mois','3 mois','Dispense par l\'employeur']},
    {id:'date_fin',label:'Date de fin de contrat prevue',type:'date',required:true},
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'signataire',label:'Signataire',type:'text',required:true},
    {id:'date_doc',label:'Date du document',type:'date',required:true}
   ]
  },
  {id:'periode-essai-rupture',cat:'Ruptures de contrat',icon:'‚ùå',name:'Rupture periode d essai',sub:'Fin de contrat pendant la periode d\'essai',badge:'admin',
   legal:'L1221-25 CT - Delai de prevenance obligatoire - Pas d\'indemnite legale - A l\'initiative employeur ou salarie',
   tags:['Periode essai','Rupture'],
   fields:[
    {id:'emp_nom',label:'Nom du salarie',type:'text',required:true},
    {id:'emp_poste',label:'Poste',type:'text',required:true},
    {id:'date_debut',label:'Date de debut periode d\'essai',type:'date',required:true},
    {id:'initiateur',label:'A l\'initiative de',type:'select',options:["L'employeur","Le salarie"]},
    {id:'motif',label:'Raison (interne, non obligatoire a mentionner)',type:'textarea',required:false},
    {id:'date_preavenir',label:'Date de notification',type:'date',required:true},
    {id:'date_fin',label:'Date de fin effective',type:'date',required:true},
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'signataire',label:'Signataire',type:'text',required:true}
   ]
  },
  {id:'convocation-entretien-embauche',cat:'Recrutement et embauche',icon:'üì©',name:"Convocation entretien d'embauche",sub:'Invitation officielle a un entretien de recrutement',badge:'admin',
   legal:'Pas d\'obligation legale de forme - Bonne pratique de formaliser - Respecter RGPD pour donnees collectees',
   tags:['Recrutement','Convocation'],
   fields:[
    {id:'candidat_nom',label:'Nom du candidat',type:'text',required:true},
    {id:'poste',label:'Poste a pourvoir',type:'text',required:true},
    {id:'date_entretien',label:"Date de l'entretien",type:'date',required:true},
    {id:'heure',label:'Heure de convocation',type:'text',required:true,placeholder:'10h00'},
    {id:'lieu',label:'Lieu (adresse ou lien visio)',type:'text',required:true},
    {id:'interlocuteur',label:'Interlocuteur(s) presents',type:'text',required:false},
    {id:'documents',label:'Documents a apporter',type:'textarea',required:false,placeholder:'CV, diplomes...'},
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'signataire',label:'Signataire',type:'text',required:true}
   ]
  },
  {id:'promesse-embauche',cat:'Recrutement et embauche',icon:'üéâ',name:'Promesse d embauche (offre ferme)',sub:'Engagement unilateral de l\'employeur',badge:'legal',
   legal:"Cass. Soc. 21/09/2017 - Promesse = offre ferme si poste + remuneration + date de prise de fonction precises - Rupture = licenciement sans cause reelle",
   tags:['Recrutement','Promesse','Offre ferme'],
   fields:[
    {id:'candidat_nom',label:'Nom du candidat',type:'text',required:true},
    {id:'poste',label:'Poste propose',type:'text',required:true},
    {id:'type_contrat',label:'Type de contrat',type:'select',options:['CDI','CDD','Alternance','Stage','Interim']},
    {id:'date_debut',label:'Date de prise de poste',type:'date',required:true},
    {id:'salaire',label:'Salaire brut mensuel (EUR)',type:'number',required:true},
    {id:'temps_travail',label:'Temps de travail',type:'select',options:['Temps plein (35h)','Temps partiel','Forfait jours cadre']},
    {id:'lieu_travail',label:'Lieu de travail',type:'text',required:true},
    {id:'avantages',label:'Avantages (optionnel)',type:'textarea',required:false,placeholder:'Tickets restaurant, mutuelle, prime...'},
    {id:'delai_reponse',label:'Delai de reponse attendu',type:'text',required:false},
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'signataire',label:'Signataire',type:'text',required:true},
    {id:'date_doc',label:'Date du document',type:'date',required:true}
   ]
  },
  {id:'entretien-annuel',cat:'Entretiens et evaluations',icon:'üéØ',name:"Entretien annuel d'evaluation",sub:'Grille complete pour piloter la performance',badge:'entretien',
   legal:'Pas d\'obligation legale - Differents de l\'entretien professionnel L6315-1 - Resultats peuvent fonder des decisions RH',
   tags:['Evaluation','Performance','Annuel'],
   fields:[
    {id:'emp_nom',label:'Nom du collaborateur',type:'text',required:true},
    {id:'emp_poste',label:'Poste',type:'text',required:true},
    {id:'emp_anciennete',label:"Date d'entree",type:'date',required:true},
    {id:'manager',label:'Nom du manager',type:'text',required:true},
    {id:'date_entretien',label:"Date de l'entretien",type:'date',required:true},
    {id:'periode_evaluee',label:'Periode evaluee',type:'text',required:true,placeholder:'Du 01/01/2025 au 31/12/2025'},
    {id:'objectifs_atteints',label:'Objectifs fixes et niveau d\'atteinte',type:'textarea',required:true,placeholder:'Objectif 1 : description -> Atteint / Partiellement / Non atteint'},
    {id:'points_forts',label:'Points forts et realisations marquantes',type:'textarea',required:true},
    {id:'axes_amelioration',label:"Axes d'amelioration identifies",type:'textarea',required:true},
    {id:'objectifs_n1',label:'Objectifs pour la prochaine periode',type:'textarea',required:true},
    {id:'formation',label:'Besoins en formation identifies',type:'textarea',required:false},
    {id:'evolution',label:'Souhaits d\'evolution du collaborateur',type:'textarea',required:false},
    {id:'note_globale',label:'Note globale (optionnel)',type:'select',required:false,options:['','Exceptionnel (5/5)','Tres bon (4/5)','Satisfaisant (3/5)','A ameliorer (2/5)','Insuffisant (1/5)']}
   ]
  },
  {id:'entretien-mi-annee',cat:'Entretiens et evaluations',icon:'üìä',name:'Entretien de mi-annee (check-in)',sub:'Point d\'etape sur les objectifs annuels',badge:'entretien',
   legal:'Bonne pratique manageriale - Pas de cadre legal specifique - Complete l\'entretien annuel',
   tags:['Check-in','Mi-annee','Objectifs'],
   fields:[
    {id:'emp_nom',label:'Collaborateur',type:'text',required:true},
    {id:'emp_poste',label:'Poste',type:'text',required:true},
    {id:'manager',label:'Manager',type:'text',required:true},
    {id:'date_entretien',label:'Date',type:'date',required:true},
    {id:'rappel_objectifs',label:'Rappel des objectifs annuels',type:'textarea',required:true},
    {id:'avancement',label:"Etat d'avancement des objectifs",type:'textarea',required:true},
    {id:'obstacles',label:'Obstacles rencontres',type:'textarea',required:false},
    {id:'soutien_manager',label:'Soutien attendu du manager',type:'textarea',required:false},
    {id:'ajustements',label:'Ajustements d\'objectifs si necessaire',type:'textarea',required:false},
    {id:'actions',label:'Actions decidees',type:'textarea',required:true}
   ]
  },
  {id:'entretien-professionnel',cat:'Entretiens et evaluations',icon:'üéì',name:'Entretien professionnel',sub:'Bilan parcours et formation (obligatoire tous les 2 ans)',badge:'legal',
   legal:'L6315-1 CT OBLIGATOIRE - Tous les 2 ans - Bilan tous les 6 ans - Abondement CPF si non respecte (3 000 EUR)',
   tags:['Formation','Obligatoire','CPF'],
   fields:[
    {id:'emp_nom',label:'Nom du salarie',type:'text',required:true},
    {id:'emp_poste',label:'Poste',type:'text',required:true},
    {id:'emp_anciennete',label:"Date d'entree",type:'date',required:true},
    {id:'date_entretien',label:"Date de l'entretien",type:'date',required:true},
    {id:'dernier_entretien',label:'Date du dernier entretien professionnel',type:'date',required:false},
    {id:'bilan_parcours',label:'Bilan du parcours professionnel',type:'textarea',required:true},
    {id:'formations_suivies',label:'Formations suivies depuis dernier entretien',type:'textarea',required:false},
    {id:'certifications',label:'Certifications obtenues',type:'textarea',required:false},
    {id:'projet_pro',label:'Projet professionnel du salarie',type:'textarea',required:true},
    {id:'besoins_formation',label:'Besoins en formation identifies',type:'textarea',required:true},
    {id:'cpf',label:'Information CPF delivree',type:'select',options:["Oui, le salarie a ete informe de son CPF","Non"]}
   ]
  },
  {id:'entretien-retour-absence',cat:'Entretiens et evaluations',icon:'üîÑ',name:'Entretien retour apres absence',sub:'Accueil et reintegration post-absence',badge:'entretien',
   legal:'Obligatoire apres AT/maladie pro - Fortement recommande apres toute absence longue',
   tags:['Retour','Reintegration','Absence'],
   fields:[
    {id:'emp_nom',label:'Collaborateur',type:'text',required:true},
    {id:'emp_poste',label:'Poste',type:'text',required:true},
    {id:'manager',label:'Manager',type:'text',required:true},
    {id:'date_retour',label:'Date de retour',type:'date',required:true},
    {id:'type_absence',label:"Type d'absence",type:'select',options:['Maladie ordinaire','Accident du travail','Maladie professionnelle','Conge maternite/paternite','Conge parental','Autre']},
    {id:'duree_absence',label:"Duree de l'absence",type:'text',required:true,placeholder:'3 semaines, 2 mois...'},
    {id:'etat_sante',label:'Amenagement necessaire ?',type:'textarea',required:false},
    {id:'missions_actuelles',label:'Point sur les missions et priorites immediates',type:'textarea',required:true},
    {id:'accompagnement',label:'Accompagnement mis en place',type:'textarea',required:false}
   ]
  },
  {id:'charte-valeurs',cat:'Culture et vision',icon:'‚≠ê',name:'Charte des valeurs de l\'entreprise',sub:'Formalise la vision, mission et valeurs fondatrices',badge:'culture',
   legal:'Document non contractuel - Renforce la marque employeur - Peut figurer dans onboarding et reglement interieur',
   tags:['Culture','Valeurs','Mission','Vision'],
   fields:[
    {id:'entreprise_nom',label:"Nom de l'entreprise",type:'text',required:true},
    {id:'secteur',label:"Secteur d'activite",type:'text',required:true,placeholder:'Commerce alimentaire, Conseil RH...'},
    {id:'fondee',label:'Annee de creation',type:'text',required:false},
    {id:'vision',label:'Vision (ou voulez-vous aller a long terme ?)',type:'textarea',required:true,placeholder:'Devenir la reference regionale en matiere de...'},
    {id:'mission',label:'Mission (pourquoi existez-vous ?)',type:'textarea',required:true,placeholder:'Notre raison d\'etre est d\'aider...'},
    {id:'valeurs',label:'Valeurs fondamentales (liste numerotee)',type:'textarea',required:true,placeholder:'1. Integrite\n2. Innovation\n3. Bienveillance\n...'},
    {id:'engagements',label:'Engagements envers les equipes',type:'textarea',required:false},
    {id:'comportements',label:'Comportements attendus au quotidien',type:'textarea',required:false},
    {id:'dirigeant',label:'Mot du dirigeant / Signataire',type:'text',required:true}
   ]
  },
  {id:'welcome-book',cat:'Culture et vision',icon:'üëã',name:'Guide de bienvenue (Welcome Book)',sub:'Livret d\'accueil complet pour les nouveaux',badge:'culture',
   legal:'Bonne pratique onboarding - Peut integrer reglement interieur et informations legales obligatoires',
   tags:['Onboarding','Welcome','Culture'],
   fields:[
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'secteur',label:'Secteur',type:'text',required:true},
    {id:'nb_employes',label:'Effectif',type:'select',options:['1-5','6-20','21-50','51-200','+200']},
    {id:'vision',label:'Vision et mission',type:'textarea',required:true},
    {id:'valeurs',label:'Valeurs cles',type:'textarea',required:true},
    {id:'organisation',label:"Structure de l'equipe",type:'textarea',required:false,placeholder:'Direction, services, qui fait quoi...'},
    {id:'pratiques',label:"Pratiques et rituels d'equipe",type:'textarea',required:false,placeholder:'Reunion hebdo le lundi, dejeuner mensuel...'},
    {id:'outils',label:'Outils et logiciels utilises',type:'textarea',required:false},
    {id:'infos_pratiques',label:'Infos pratiques (horaires, acces, parking...)',type:'textarea',required:false},
    {id:'contact_rh',label:'Contact RH / interlocuteur principal',type:'text',required:true}
   ]
  },
  {id:'teletravail-accord',cat:'Culture et vision',icon:'üè†',name:'Accord de teletravail',sub:'Cadre le teletravail pour un salarie ou l\'equipe',badge:'legal',
   legal:'L1222-9 CT - Accord individuel ou collectif - Droit a la deconnexion L2242-17 - Mentions obligatoires : jours, lieu, frais, equipement',
   tags:['Teletravail','Accord','Remote'],
   fields:[
    {id:'emp_nom',label:'Salarie concerne (ou "ensemble des salaries")',type:'text',required:true},
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'jours_teletravail',label:'Jours de teletravail autorises',type:'select',options:['1 jour/semaine','2 jours/semaine','3 jours/semaine','4 jours/semaine','Flexible']},
    {id:'lieu_teletravail',label:'Lieu de teletravail autorise',type:'text',required:true,placeholder:'Domicile principal / Tout lieu en France'},
    {id:'materiel',label:'Materiel fourni par l\'entreprise',type:'textarea',required:false},
    {id:'frais',label:'Indemnisation des frais',type:'textarea',required:false,placeholder:'10 EUR/mois forfait internet...'},
    {id:'plages_joignabilite',label:'Plages horaires de joignabilite',type:'text',required:true,placeholder:'9h-12h et 14h-17h'},
    {id:'date_debut',label:"Date d'entree en vigueur",type:'date',required:true},
    {id:'signataire',label:'Signataire',type:'text',required:true}
   ]
  },
  {id:'attestation-emploi',cat:'Documents administratifs',icon:'üìÉ',name:'Attestation de travail',sub:'Justificatif de la relation de travail en cours',badge:'admin',
   legal:'Pas de formalisme legal - Courrier a en-tete recommande - A remettre sur simple demande du salarie',
   tags:['Attestation','Justificatif','Administratif'],
   fields:[
    {id:'emp_nom',label:'Nom du salarie',type:'text',required:true},
    {id:'emp_poste',label:'Poste occupe',type:'text',required:true},
    {id:'emp_anciennete',label:"Date d'entree",type:'date',required:true},
    {id:'type_contrat',label:'Type de contrat',type:'select',options:['CDI','CDD','Alternance','Temps partiel CDI']},
    {id:'salaire_brut',label:'Salaire brut mensuel (optionnel)',type:'number',required:false},
    {id:'objet_attestation',label:'Objet de la demande (optionnel)',type:'text',required:false,placeholder:'Location immobiliere, dossier banque...'},
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'signataire',label:'Signataire',type:'text',required:true},
    {id:'date_doc',label:'Date du document',type:'date',required:true}
   ]
  },
  {id:'avenant-contrat',cat:'Documents administratifs',icon:'‚úèÔ∏è',name:'Avenant au contrat de travail',sub:'Modification d\'un element essentiel du contrat',badge:'legal',
   legal:'Tout element essentiel modifie (poste, salaire, lieu, duree) necessite avenant signe - Refus du salarie = maintien conditions initiales',
   tags:['Contrat','Avenant','Modification'],
   fields:[
    {id:'emp_nom',label:'Nom du salarie',type:'text',required:true},
    {id:'emp_poste_actuel',label:'Poste actuel',type:'text',required:true},
    {id:'date_contrat_initial',label:'Date du contrat initial',type:'date',required:true},
    {id:'objet_avenant',label:"Objet de l'avenant",type:'select',options:['Changement de poste','Modification de salaire','Changement de lieu de travail','Modification du temps de travail','Promotion / evolution','Autre modification']},
    {id:'ancienne_clause',label:'Ancienne clause / Situation actuelle',type:'textarea',required:true},
    {id:'nouvelle_clause',label:'Nouvelle clause / Nouvelle situation',type:'textarea',required:true},
    {id:'date_effet',label:"Date d'entree en vigueur",type:'date',required:true},
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'signataire',label:'Signataire',type:'text',required:true},
    {id:'date_doc',label:'Date du document',type:'date',required:true}
   ]
  },
  {id:'note-de-service',cat:'Documents administratifs',icon:'üì¢',name:'Note de service',sub:'Communication officielle interne a l\'entreprise',badge:'admin',
   legal:'Doit etre portee a la connaissance des salaries - Peut fonder une sanction si non respectee - Opposable si diffusion tracable',
   tags:['Communication','Interne','Note'],
   fields:[
    {id:'entreprise_nom',label:'Entreprise',type:'text',required:true},
    {id:'destinataires',label:'Destinataires',type:'text',required:true,placeholder:'Tout le personnel, Service commercial...'},
    {id:'objet',label:'Objet de la note',type:'text',required:true},
    {id:'contenu',label:'Contenu de la note',type:'textarea',required:true},
    {id:'date_application',label:"Date d'application",type:'date',required:false},
    {id:'signataire',label:'Signataire',type:'text',required:true},
    {id:'date_doc',label:'Date du document',type:'date',required:true}
   ]
  }
];

var _currentDoc=null;
var _generatedContent=null;
var _history=[];

window.startApp=function(){
  renderCatalogue();
  loadHistory();
};

function renderCatalogue(filter){
  var list=document.getElementById('doc-list');
  var cnt=document.getElementById('doc-count');
  var items=DOCS_CATALOGUE;
  if(filter){
    var q=filter.toLowerCase();
    items=DOCS_CATALOGUE.filter(function(d){return d.name.toLowerCase().includes(q)||d.cat.toLowerCase().includes(q)||d.sub.toLowerCase().includes(q);});
  }
  cnt.textContent=items.length+' modeles';
  var cats={};
  items.forEach(function(d){if(!cats[d.cat])cats[d.cat]=[];cats[d.cat].push(d);});
  var html='';
  Object.keys(cats).forEach(function(cat){
    html+='<div class="cat-header">'+cat+'</div>';
    cats[cat].forEach(function(d){
      var active=_currentDoc&&_currentDoc.id===d.id?' active':'';
      html+='<div class="doc-item'+active+'" onclick="selectDoc(\''+d.id+'\')">';
      html+='<span class="doc-icon">'+d.icon+'</span>';
      html+='<div class="doc-info"><div class="doc-name">'+d.name+'</div><div class="doc-sub">'+d.sub+'</div></div>';
      html+='<span class="doc-badge badge-'+d.badge+'">'+d.badge+'</span>';
      html+='</div>';
    });
  });
  if(!html)html='<div style="padding:24px;text-align:center;color:var(--muted);font-size:12px">Aucun modele</div>';
  list.innerHTML=html;
}

window.filterDocs=function(v){renderCatalogue(v||null);};

window.selectDoc=function(id){
  var d=DOCS_CATALOGUE.find(function(x){return x.id===id;});
  if(!d)return;
  _currentDoc=d;
  _generatedContent=null;
  renderCatalogue();
  renderForm(d);
};

function renderForm(doc){
  var right=document.getElementById('right-panel');
  var tagsHtml=doc.tags.map(function(t){
    var s='background:#f1f5f9;color:#475569';
    if(doc.badge==='legal')s='background:#dcfce7;color:#166534';
    if(doc.badge==='disciplinaire')s='background:#fee2e2;color:#991b1b';
    if(doc.badge==='entretien')s='background:#dbeafe;color:#1e40af';
    if(doc.badge==='culture')s='background:#f3e8ff;color:#6b21a8';
    return '<span class="doc-tag" style="'+s+'">'+t+'</span>';
  }).join('');

  var fieldsHtml=doc.fields.map(function(f){
    var fullCls=(f.type==='textarea')?' full':'';
    var inp='';
    if(f.type==='textarea'){
      inp='<textarea class="form-input form-textarea" id="f-'+f.id+'" placeholder="'+(f.placeholder||'')+'" rows="3"></textarea>';
    } else if(f.type==='select'){
      var opts=(f.options||[]).map(function(o){return '<option value="'+o+'">'+o+'</option>';}).join('');
      inp='<select class="form-input form-select" id="f-'+f.id+'"><option value="">-- Selectionner --</option>'+opts+'</select>';
    } else {
      inp='<input class="form-input" type="'+(f.type||'text')+'" id="f-'+f.id+'" placeholder="'+(f.placeholder||'')+'"/>';
    }
    var req=f.required?'<span style="color:var(--red)">*</span>':'';
    return '<div class="form-field'+fullCls+'"><label class="form-label">'+f.label+req+'</label>'+inp+'</div>';
  }).join('');

  right.innerHTML=
    '<div class="doc-header">'+
      '<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px">'+
        '<div class="doc-big-title">'+doc.icon+' '+doc.name+'</div>'+
        '<button class="btn btn-outline btn-sm" onclick="selectDoc(\''+doc.id+'\')">üîÑ Reinitialiser</button>'+
      '</div>'+
      '<p class="doc-desc">'+doc.sub+'</p>'+
      '<div class="doc-tags">'+tagsHtml+'</div>'+
      '<div class="legal-banner">'+
        '<div class="legal-banner-icon">‚öñÔ∏è</div>'+
        '<div class="legal-banner-text"><strong>Reference legale :</strong> '+doc.legal+'<br><span style="color:#92400e;font-size:11px;margin-top:4px;display:block"><strong>Rappel :</strong> ALTEORE n\'est pas un logiciel juridique. Ces modeles sont fournis a titre indicatif et ne remplacent pas l\'avis d\'un juriste ou d\'un avocat specialise en droit du travail.</span></div>'+
      '</div>'+
    '</div>'+
    '<div class="form-section">'+
      '<div class="form-section-head"><span>üìù</span><div class="form-section-title">Informations necessaires a la generation</div></div>'+
      '<div class="form-body"><div class="form-grid">'+fieldsHtml+'</div></div>'+
    '</div>'+
    '<div class="generate-bar">'+
      '<div class="generate-bar-text">'+
        '<h3>Generer le document avec l\'IA</h3>'+
        '<p>Document redige en conformite avec le droit du travail francais 2024-2025</p>'+
      '</div>'+
      '<div class="generate-bar-actions">'+
        '<button class="btn btn-sm" style="background:rgba(255,255,255,.15);color:white;border:1px solid rgba(255,255,255,.3)" onclick="fillExample()">üí° Exemple</button>'+
        '<button class="btn btn-ai" onclick="generateDocument()">‚ú® Generer le document</button>'+
      '</div>'+
    '</div>'+
    '<div id="generated-area"></div>';
}

window.fillExample=function(){
  if(!_currentDoc)return;
  var ex={
    emp_nom:'Jean Dupont',emp_poste:'Charge de clientele',emp_adresse:'12 rue de la Paix, 75001 Paris',
    emp_anciennete:'2022-03-15',emp_date_contrat:'2022-03-15',date_contrat_initial:'2022-03-15',
    entreprise_nom:'SARL Exemple Commerce',entreprise_adresse:'5 avenue du Commerce, 69001 Lyon',
    entreprise_siret:'123 456 789 00012',signataire:'Marie Martin',manager:'Paul Durand',
    date_doc:new Date().toISOString().split('T')[0],
    date_entretien:new Date().toISOString().split('T')[0],
    date_rupture:new Date(Date.now()+45*864e5).toISOString().split('T')[0],
    date_1er_entretien:new Date().toISOString().split('T')[0],
    date_debut:new Date(Date.now()+30*864e5).toISOString().split('T')[0],
    date_fin:new Date(Date.now()+30*864e5).toISOString().split('T')[0],
    date_faits:new Date(Date.now()-3*864e5).toISOString().split('T')[0],
    indemnite:'4500',salaire:'2800',salaire_brut:'2800',
    candidat_nom:'Sophie Bernard',poste:'Assistante commerciale',heure:'10h00',
    lieu:'5 avenue du Commerce, 69001 Lyon',
    vision:'Devenir la reference regionale en matiere de service client personnalise.',
    mission:'Accompagner les TPE et PME dans leur developpement commercial avec des outils simples.',
    valeurs:'1. Integrite et transparence\n2. Innovation au service du client\n3. Bienveillance et respect\n4. Excellence operationnelle',
    secteur:'Commerce de detail alimentaire',
    description_faits:'Le salarie s\'est presente en retard de plus de 2 heures le 21 mars 2025, sans prevenir. Il s\'agit du troisieme retard significatif du dernier trimestre.',
    nature_faute:'Le salarie a tenu des propos menacants envers un collegue devant plusieurs temoins, constituant une faute grave incompatible avec la poursuite du contrat.',
    objectifs_atteints:'Objectif CA : 150 000 EUR -> 162 000 EUR atteint (108%)\nObjectif NPS : 40 -> 52 atteint',
    points_forts:'Excellent relationnel client, autonomie, prise d\'initiatives sur le projet X',
    axes_amelioration:'Structuration des rapports, gestion des priorites en periode de forte activite',
    objectifs_n1:'1. Developper le portefeuille de 20% sur la region Sud\n2. Former 2 nouveaux commerciaux',
    periode_evaluee:'Du 01/01/2025 au 31/12/2025',
    objet:'Nouvelle procedure de gestion des conges',
    destinataires:'Tout le personnel',
    contenu:'A compter du 1er avril 2025, toute demande de conges devra etre effectuee via le module RH avec un delai minimum de 15 jours pour toute absence de plus de 3 jours.',
    nb_employes:'6-20',contact_rh:'Marie Martin - marie@exemple.fr',
    plages_joignabilite:'9h-12h et 14h-17h',
    lieu_teletravail:'Domicile principal',
    bilan_parcours:'Bonne progression depuis le dernier entretien, montee en competences sur les outils CRM',
    projet_pro:'Evoluer vers un poste de responsable commercial sur la region dans les 2 prochaines annees',
    besoins_formation:'Formation avancee CRM Salesforce, certification en negociation commerciale',
    missions_actuelles:'Reprendre le portefeuille clients en priorite et participer a la reunion d\'equipe lundi',
    duree_absence:'3 semaines'
  };
  _currentDoc.fields.forEach(function(f){
    var el=document.getElementById('f-'+f.id);
    if(!el)return;
    if(ex[f.id]){el.value=ex[f.id];}
    else if(f.type==='select'&&f.options&&f.options.length>0){el.value=f.options[0];}
  });
  showToast('Exemple rempli - ajustez si besoin','');
};

window.generateDocument=function(){
  if(!_currentDoc)return;
  var data={};
  var missing=[];
  _currentDoc.fields.forEach(function(f){
    var el=document.getElementById('f-'+f.id);
    if(!el)return;
    var val=el.value.trim();
    data[f.id]=val;
    if(f.required&&!val)missing.push(f.label);
  });
  if(missing.length>0){showToast('Champs requis : '+missing.slice(0,2).join(', ')+(missing.length>2?'...':''),'warning');return;}

  var area=document.getElementById('generated-area');
  area.innerHTML='<div class="generated-doc"><div class="ai-loading"><div class="ai-spinner"></div><div class="ai-loading-text">‚ú® Generation en cours...</div><div class="ai-loading-sub">Conformite droit du travail francais - Personnalisation en cours</div></div></div>';
  area.scrollIntoView({behavior:'smooth',block:'start'});

  var fieldsDesc=_currentDoc.fields.map(function(f){return f.label+' : '+(data[f.id]||'[non renseigne]');}).join('\n');
  var prompt='Tu es un expert en droit du travail francais. Genere un document RH professionnel et complet du type : "'+_currentDoc.name+'".\n\nInformations fournies :\n'+fieldsDesc+'\n\nReference legale : '+_currentDoc.legal+'\n\nINSTRUCTIONS :\n- Redige en francais juridique professionnel mais accessible\n- Conforme au droit du travail francais en vigueur (2024-2025)\n- Inclure toutes les mentions legales obligatoires\n- Utilise ## pour les titres de section\n- Inclure les formules de politesse et blocs de signatures\n- Pour les infos manquantes critiques utiliser [A COMPLETER]\n- Si delais legaux applicables les mentionner explicitement\n- Pour documents disciplinaires respecter scrupuleusement la procedure legale\n- Genere uniquement le corps du document sans commentaire ni explication\n- Commence directement par l\'en-tete du document';

  fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      model:'claude-sonnet-4-20250514',
      max_tokens:2500,
      system:'Tu es un expert juridique RH specialise dans le droit du travail francais. Tu generes des documents RH professionnels, conformes et adaptes a la situation specifique.',
      messages:[{role:'user',content:prompt}]
    })
  }).then(function(r){return r.json();}).then(function(resp){
    var text='';
    if(resp.content&&resp.content[0]&&resp.content[0].text){text=resp.content[0].text;}
    else{throw new Error('Reponse inattendue');}
    _generatedContent=text;
    renderGeneratedDoc(text);
    autoSave();
  }).catch(function(err){
    console.error(err);
    area.innerHTML='<div class="generated-doc"><div style="padding:30px;text-align:center;color:var(--red)"><div style="font-size:32px;margin-bottom:10px">‚ö†Ô∏è</div><div style="font-weight:700">Erreur de generation</div><div style="font-size:12px;color:var(--muted);margin-top:8px">Verifiez votre connexion et reessayez.</div><button class="btn btn-primary" style="margin-top:16px" onclick="generateDocument()">Reessayer</button></div></div>';
  });
};

function renderGeneratedDoc(text){
  var area=document.getElementById('generated-area');
  var html=text
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/\[A COMPLETER\]/g,'<span class="field-blank">[A COMPLETER]</span>')
    .replace(/\[A COMPLETER\]/g,'<span class="field-blank">[A COMPLETER]</span>')
    .replace(/^## (.+)$/gm,'<h2>$1</h2>')
    .replace(/^### (.+)$/gm,'<h3>$1</h3>')
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\n{2,}/g,'</p><p>')
    .replace(/\n/g,'<br>');
  html='<p>'+html+'</p>';
  var today=new Date().toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'});
  area.innerHTML=
    '<div class="generated-doc">'+
      '<div class="generated-doc-head">'+
        '<div class="generated-doc-title">Document genere : '+_currentDoc.name+'</div>'+
        '<div style="display:flex;gap:8px">'+
          '<button class="btn btn-outline btn-xs" onclick="copyDocument()">üìã Copier</button>'+
          '<button class="btn btn-outline btn-xs" onclick="printDocument()">üñ®Ô∏è Imprimer</button>'+
          '<button class="btn btn-success btn-xs" onclick="saveDocument()">üíæ Sauvegarder</button>'+
        '</div>'+
      '</div>'+
      '<div class="doc-content-wrap" id="doc-print-zone"><div class="doc-content">'+html+'</div></div>'+
      '<div style="padding:12px 20px;background:#fff7ed;border-top:1px solid #fed7aa;font-size:11px;color:#9a3412;line-height:1.6">'+
        '<strong>Avertissement :</strong> Document genere par IA le '+today+' a titre de modele indicatif. '+
        '<strong>ALTEORE n\'est pas un logiciel juridique et ne se substitue pas a un juriste ou a un avocat.</strong> '+
        'Ces modeles doivent etre relus, adaptes a votre situation et valides par un professionnel du droit avant toute utilisation dans un contexte sensible (licenciement, rupture conventionnelle, mesure disciplinaire...).'+
      '</div>'+
    '</div>';
}

window.copyDocument=function(){
  if(!_generatedContent)return;
  navigator.clipboard.writeText(_generatedContent).then(function(){showToast('Copie dans le presse-papiers','success');}).catch(function(){showToast('Impossible de copier','warning');});
};

window.printDocument=function(){
  var zone=document.getElementById('doc-print-zone');
  if(!zone)return;
  var win=window.open('','_blank');
  win.document.write('<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><title>'+(_currentDoc?_currentDoc.name:'Document RH')+'</title><style>body{font-family:Georgia,serif;font-size:12pt;line-height:1.8;margin:40px 60px;color:#1a1f36}h2{font-size:14pt;margin:20px 0 10px;text-transform:uppercase}h3{font-size:12pt;margin:16px 0 8px}p{margin-bottom:10px}.field-blank{border-bottom:1px solid #333;min-width:80px;display:inline-block;padding:0 4px}</style></head><body>'+zone.innerHTML+'</body></html>');
  win.document.close();win.focus();setTimeout(function(){win.print();},400);
};

window.openNewDoc=function(){
  document.getElementById('search-docs').value='';
  renderCatalogue();
  document.getElementById('right-panel').innerHTML='<div class="empty-state"><div class="empty-icon">üìÑ</div><h3 style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px">Choisissez un modele</h3><p style="font-size:13px;line-height:1.7;max-width:340px">Utilisez la recherche ou parcourez les categories dans la bibliotheque.</p></div>';
  _currentDoc=null;
};

async function loadHistory(){
  if(!window._uid)return;
  try{
    var snap=await window._getDocs(window._collection(window._db,'rh_docs_gen',window._uid,'items'));
    _history=[];
    snap.forEach(function(d){_history.push(Object.assign({_id:d.id},d.data()));});
    _history.sort(function(a,b){return(b.createdAt||0)-(a.createdAt||0);});
  }catch(e){console.warn('Historique:',e);}
}

async function autoSave(){
  if(!window._uid||!_currentDoc||!_generatedContent)return;
  try{
    var item={docId:_currentDoc.id,docName:_currentDoc.name,docIcon:_currentDoc.icon,content:_generatedContent,createdAt:Date.now()};
    var ref=await window._addDoc(window._collection(window._db,'rh_docs_gen',window._uid,'items'),item);
    _history.unshift(Object.assign({_id:ref.id},item));
  }catch(e){}
}

window.saveDocument=async function(){
  if(!window._uid||!_currentDoc||!_generatedContent)return;
  try{
    await window._addDoc(window._collection(window._db,'rh_docs_gen',window._uid,'items'),{docId:_currentDoc.id,docName:_currentDoc.name,docIcon:_currentDoc.icon,content:_generatedContent,createdAt:Date.now(),manual:true});
    showToast('Document sauvegarde dans l\'historique','success');
  }catch(e){showToast('Erreur : '+e.message,'warning');}
};

window.showHistory=function(){
  loadHistory().then(function(){
    var modal=document.getElementById('hist-modal');
    var list=document.getElementById('hist-list');
    if(_history.length===0){
      list.innerHTML='<div style="padding:30px;text-align:center;color:var(--muted)"><div style="font-size:32px;margin-bottom:10px">üì≠</div><div style="font-size:13px">Aucun document sauvegarde</div></div>';
    } else {
      list.innerHTML=_history.map(function(h){
        var date=h.createdAt?new Date(h.createdAt).toLocaleDateString('fr-FR'):'--';
        return '<div class="hist-item" onclick="loadHistItem(\''+h._id+'\')">'+
          '<span class="hist-icon">'+(h.docIcon||'üìÑ')+'</span>'+
          '<div class="hist-info"><div class="hist-name">'+(h.docName||'Document')+'</div><div class="hist-meta">'+date+'</div></div>'+
          '<button class="hist-del" onclick="delHistItem(event,\''+h._id+'\')" title="Supprimer">üóë</button>'+
        '</div>';
      }).join('');
    }
    modal.style.display='flex';
  });
};

window.closeHistModal=function(){document.getElementById('hist-modal').style.display='none';};

window.loadHistItem=function(id){
  var h=_history.find(function(x){return x._id===id;});
  if(!h)return;
  closeHistModal();
  var doc=DOCS_CATALOGUE.find(function(d){return d.id===h.docId;});
  if(doc){_currentDoc=doc;renderCatalogue();renderForm(doc);}
  _generatedContent=h.content;
  setTimeout(function(){
    var area=document.getElementById('generated-area');
    if(area)renderGeneratedDoc(h.content);
  },100);
};

window.delHistItem=async function(e,id){
  e.stopPropagation();
  if(!window._uid)return;
  try{
    await window._deleteDoc(window._doc(window._db,'rh_docs_gen',window._uid,'items',id));
    _history=_history.filter(function(h){return h._id!==id;});
    showHistory();
  }catch(e2){showToast('Erreur : '+e2.message,'warning');}
};

window.toggleMobileNav=function(){
  var sidebar=document.querySelector('.sidebar, nav, aside');
  var overlay=document.getElementById('nav-overlay');
  var btn=document.getElementById('hamburger-btn');
  if(!sidebar)return;
  sidebar.classList.toggle('open');
  if(overlay)overlay.classList.toggle('show');
  if(btn)btn.classList.toggle('open');
};

function showToast(msg,type){
  var t=document.getElementById('toast');
  t.textContent=msg;
  t.className='toast show '+(type||'');
  setTimeout(function(){t.className='toast';},3200);
}
</script>

<script src="nav.js"></script>
<script>
(function openRhNav(){
  var tries=0;
  var t=setInterval(function(){
    var sub=document.getElementById('rh-nav-sub');
    var nav=document.getElementById('alteore-nav');
    if(sub&&nav){clearInterval(t);sub.style.maxHeight='2000px';nav.classList.add('rh-mode');}
    if(++tries>50)clearInterval(t);
  },50);
})();
</script>
</body>
</html>
