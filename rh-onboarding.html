<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE ‚Äî Onboarding & Offboarding</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --rh-dark:#052e16;--rh-main:#059669;--rh-mid:#10b981;--rh-bright:#34d399;
      --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
      --on-main:#0ea5e9;--on-ghost:#f0f9ff;--on-border:#bae6fd;
      --off-main:#f59e0b;--off-ghost:#fffbeb;--off-border:#fde68a;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f0fdf7;--radius:12px;
      --red:#ef4444;--red-light:#fee2e2;--green:#10b981;--purple:#6366f1;
      --sidebar-w:250px;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-width:0;}

    /* TOPBAR */
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;gap:10px;flex-wrap:wrap;}
    .topbar-left h1{font-size:17px;font-weight:700;}
    .topbar-left p{font-size:12px;color:var(--muted);margin-top:2px;}
    .topbar-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}

    /* BUTTONS */
    .btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;gap:6px;}
    .btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-mid));color:white;box-shadow:0 3px 10px rgba(5,150,105,.25);}
    .btn-rh:hover{opacity:.9;transform:translateY(-1px);}
    .btn-on{background:linear-gradient(135deg,#0284c7,var(--on-main));color:white;box-shadow:0 3px 10px rgba(14,165,233,.25);}
    .btn-on:hover{opacity:.9;transform:translateY(-1px);}
    .btn-off{background:linear-gradient(135deg,#d97706,var(--off-main));color:white;box-shadow:0 3px 10px rgba(245,158,11,.25);}
    .btn-off:hover{opacity:.9;transform:translateY(-1px);}
    .btn-outline{background:white;color:var(--rh-main);border:1.5px solid var(--rh-border);}
    .btn-outline:hover{background:var(--rh-ghost);}
    .btn-ghost{background:transparent;color:var(--muted);border:1.5px solid var(--border);}
    .btn-ghost:hover{background:white;color:var(--text);}
    .btn-sm{padding:5px 11px;font-size:12px;}
    .btn-xs{padding:3px 8px;font-size:11px;}
    .btn-danger{background:#fee2e2;color:#dc2626;border:1px solid #fecaca;}
    .btn-danger:hover{background:#fecaca;}

    /* TABS */
    .tabs-bar{background:white;border-bottom:1px solid var(--border);padding:0 28px;display:flex;gap:0;}
    .tab-btn{padding:12px 20px;font-size:13px;font-weight:600;color:var(--muted);cursor:pointer;border:none;background:none;border-bottom:3px solid transparent;transition:all .18s;display:flex;align-items:center;gap:6px;}
    .tab-btn:hover{color:var(--text);}
    .tab-btn.on{color:var(--rh-main);border-bottom-color:var(--rh-main);}
    .tab-count{background:#f1f5f9;color:var(--muted);font-size:10px;font-weight:700;padding:2px 6px;border-radius:20px;}
    .tab-btn.on .tab-count{background:var(--rh-ghost);color:var(--rh-main);}

    /* LAYOUT */
    .content{padding:20px 28px;flex:1;display:flex;gap:18px;min-height:0;}
    .left-panel{width:280px;flex-shrink:0;display:flex;flex-direction:column;gap:12px;}
    .right-panel{flex:1;min-width:0;display:flex;flex-direction:column;gap:16px;}

    /* CARDS */
    .card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:13px 16px;border-bottom:1px solid var(--border);}
    .card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px;}

    /* DOSSIER LIST */
    .dossier-item{display:flex;align-items:center;gap:10px;padding:11px 14px;cursor:pointer;border-left:3px solid transparent;transition:all .15s;}
    .dossier-item:hover{background:#fafffe;}
    .dossier-item.active{background:var(--rh-ghost);border-left-color:var(--rh-main);}
    .dossier-item.active-on{background:var(--on-ghost);border-left-color:var(--on-main);}
    .dossier-item.active-off{background:var(--off-ghost);border-left-color:var(--off-main);}
    .doss-avatar{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:white;flex-shrink:0;}
    .doss-info{flex:1;min-width:0;}
    .doss-name{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .doss-meta{font-size:10px;color:var(--muted);margin-top:1px;}
    .doss-progress{display:flex;align-items:center;gap:5px;margin-top:4px;}
    .prog-bar{flex:1;height:4px;background:#f1f5f9;border-radius:99px;overflow:hidden;}
    .prog-fill{height:100%;border-radius:99px;transition:width .4s;}
    .prog-pct{font-size:10px;font-weight:700;color:var(--muted);}

    /* BADGE */
    .badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;}
    .badge-on{background:var(--on-ghost);color:var(--on-main);}
    .badge-off{background:var(--off-ghost);color:#d97706;}
    .badge-done{background:var(--rh-ghost);color:var(--rh-main);}
    .badge-wait{background:#f5f3ff;color:#6366f1;}
    .badge-red{background:#fee2e2;color:#dc2626;}

    /* KPI ROW */
    .kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
    .kpi-box{background:white;border:1px solid var(--border);border-radius:10px;padding:14px 16px;}
    .kpi-box.blue{background:var(--on-ghost);border-color:var(--on-border);}
    .kpi-box.amber{background:var(--off-ghost);border-color:var(--off-border);}
    .kpi-box.green{background:var(--rh-ghost);border-color:var(--rh-border);}
    .kpi-box.purple{background:#f5f3ff;border-color:#ddd6fe;}
    .kpi-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:4px;}
    .kpi-val{font-size:20px;font-weight:800;color:var(--text);}
    .kpi-val.blue{color:var(--on-main);}
    .kpi-val.amber{color:#d97706;}
    .kpi-val.green{color:var(--rh-main);}
    .kpi-sub{font-size:10px;color:var(--muted);margin-top:3px;}

    /* TIMELINE */
    .timeline-wrap{position:relative;padding-left:28px;}
    .timeline-wrap::before{content:'';position:absolute;left:10px;top:8px;bottom:8px;width:2px;background:linear-gradient(to bottom,var(--rh-border),var(--border));border-radius:2px;}
    .tl-phase{position:relative;margin-bottom:20px;}
    .tl-phase:last-child{margin-bottom:0;}
    .tl-dot{position:absolute;left:-24px;top:6px;width:14px;height:14px;border-radius:50%;border:2px solid white;box-shadow:0 0 0 2px var(--border);z-index:1;transition:all .2s;}
    .tl-dot.done{background:var(--rh-main);box-shadow:0 0 0 3px var(--rh-border);}
    .tl-dot.active{background:var(--on-main);box-shadow:0 0 0 3px var(--on-border);animation:pulse-dot 2s infinite;}
    .tl-dot.pending{background:#f1f5f9;box-shadow:0 0 0 2px var(--border);}
    .tl-dot.day-j{background:linear-gradient(135deg,var(--rh-main),var(--on-main));box-shadow:0 0 0 3px rgba(14,165,233,.3);width:16px;height:16px;left:-25px;}
    @keyframes pulse-dot{0%,100%{box-shadow:0 0 0 3px rgba(14,165,233,.3);}50%{box-shadow:0 0 0 6px rgba(14,165,233,.1);}}
    .tl-phase-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;cursor:pointer;padding:10px 14px;background:white;border:1px solid var(--border);border-radius:10px;transition:all .15s;}
    .tl-phase-head:hover{border-color:var(--rh-border);background:var(--rh-ghost);}
    .tl-phase-head.phase-on:hover{border-color:var(--on-border);background:var(--on-ghost);}
    .tl-phase-head.phase-off:hover{border-color:var(--off-border);background:var(--off-ghost);}
    .tl-phase-head.day-j-head{border-color:var(--rh-border);background:linear-gradient(135deg,var(--rh-ghost),var(--on-ghost));}
    .tl-phase-label{font-size:12px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .tl-phase-tag{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;}
    .tag-on{background:var(--on-ghost);color:var(--on-main);}
    .tag-rh{background:var(--rh-ghost);color:var(--rh-main);}
    .tag-off{background:var(--off-ghost);color:#d97706;}
    .tag-dayj{background:linear-gradient(135deg,var(--rh-ghost),var(--on-ghost));color:var(--rh-main);}
    .tl-prog-mini{font-size:10px;color:var(--muted);font-weight:600;}
    .tl-tasks{padding:10px 0 4px;display:flex;flex-direction:column;gap:6px;}
    .tl-task{display:flex;align-items:flex-start;gap:8px;padding:7px 10px;border-radius:8px;transition:background .15s;}
    .tl-task:hover{background:#f8faff;}
    .task-cb{width:16px;height:16px;border-radius:4px;border:2px solid var(--border);appearance:none;-webkit-appearance:none;cursor:pointer;flex-shrink:0;margin-top:1px;transition:all .15s;}
    .task-cb:checked{background:var(--rh-main);border-color:var(--rh-main);}
    .task-cb.cb-on:checked{background:var(--on-main);border-color:var(--on-main);}
    .task-cb.cb-off:checked{background:var(--off-main);border-color:var(--off-main);}
    .task-label{font-size:12px;color:var(--text);flex:1;line-height:1.4;}
    .task-label.done-label{color:var(--muted);text-decoration:line-through;}
    .task-note{font-size:10px;color:var(--muted);margin-top:2px;}

    /* DOCUMENTS */
    .doc-grid{display:flex;flex-direction:column;gap:6px;}
    .doc-row{display:flex;align-items:center;justify-content:space-between;padding:9px 14px;background:#fafffe;border:1px solid var(--border);border-radius:8px;gap:10px;}
    .doc-name{font-size:12px;font-weight:600;display:flex;align-items:center;gap:7px;}
    .doc-icon{font-size:15px;}
    .doc-status{display:flex;align-items:center;gap:6px;}
    .doc-badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;}
    .doc-ok{background:var(--rh-ghost);color:var(--rh-main);}
    .doc-missing{background:#fee2e2;color:#dc2626;}
    .doc-wait{background:#fef9c3;color:#92400e;}
    .doc-toggle{width:32px;height:18px;border-radius:99px;border:none;cursor:pointer;position:relative;transition:background .2s;flex-shrink:0;}
    .doc-toggle.on{background:var(--rh-main);}
    .doc-toggle.off{background:#d1d5db;}
    .doc-toggle::after{content:'';position:absolute;top:2px;width:14px;height:14px;border-radius:50%;background:white;transition:left .2s;}
    .doc-toggle.on::after{left:15px;}
    .doc-toggle.off::after{left:2px;}

    /* AUDIT CARD */
    .audit-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:18px;}
    .audit-title{font-size:13px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
    .audit-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
    .audit-field{display:flex;flex-direction:column;gap:4px;}
    .audit-label{font-size:11px;font-weight:600;color:var(--muted);}
    .audit-input,.audit-textarea{padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;}
    .audit-input:focus,.audit-textarea:focus{border-color:var(--rh-main);}
    .audit-textarea{resize:vertical;min-height:60px;}
    .audit-rating{display:flex;gap:6px;margin-top:4px;}
    .rating-btn{width:32px;height:32px;border-radius:8px;border:2px solid var(--border);background:white;cursor:pointer;font-size:12px;font-weight:700;transition:all .15s;}
    .rating-btn.active{background:var(--rh-main);border-color:var(--rh-main);color:white;}
    .rating-btn:hover{border-color:var(--rh-main);}

    /* SOLDE TOUT COMPTE */
    .stc-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;}
    .stc-field{display:flex;flex-direction:column;gap:4px;}
    .stc-label{font-size:11px;font-weight:600;color:var(--muted);}
    .stc-val{font-size:16px;font-weight:800;color:var(--text);}
    .stc-input{padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;font-weight:700;color:var(--text);outline:none;width:100%;}
    .stc-input:focus{border-color:var(--off-main);}
    .stc-total{background:var(--off-ghost);border:2px solid var(--off-border);border-radius:10px;padding:14px;display:flex;justify-content:space-between;align-items:center;}
    .stc-total-label{font-size:13px;font-weight:700;}
    .stc-total-val{font-size:22px;font-weight:800;color:#d97706;}

    /* SIGN SECTION */
    .sign-section{background:linear-gradient(135deg,#fefce8,#fffbeb);border:1.5px solid var(--off-border);border-radius:10px;padding:14px;}
    .sign-title{font-size:12px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
    .sign-docs{display:flex;flex-direction:column;gap:6px;}
    .sign-doc{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:white;border-radius:8px;border:1px solid var(--off-border);}
    .sign-doc-name{font-size:12px;font-weight:600;}
    .sign-doc-status{font-size:11px;font-weight:700;padding:2px 8px;border-radius:20px;}
    .sign-ok{background:var(--rh-ghost);color:var(--rh-main);}
    .sign-pending{background:#fef9c3;color:#92400e;}

    /* EMPTY STATE */
    .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:400px;text-align:center;color:var(--muted);padding:40px;}
    .empty-icon{font-size:52px;margin-bottom:14px;}

    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(15,31,92,.4);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;width:100%;max-width:520px;box-shadow:0 24px 60px rgba(0,0,0,.2);overflow:hidden;max-height:90vh;display:flex;flex-direction:column;}
    .modal-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
    .modal-head h3{font-size:15px;font-weight:700;}
    .modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);}
    .modal-body{padding:20px 22px;overflow-y:auto;}
    .modal-foot{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;flex-shrink:0;}
    .mfield{margin-bottom:13px;}
    .mlabel{font-size:12px;font-weight:600;color:var(--muted);margin-bottom:5px;display:block;}
    .minput,.mselect{width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;}
    .minput:focus,.mselect:focus{border-color:var(--rh-main);}
    .mrow{display:grid;grid-template-columns:1fr 1fr;gap:11px;}

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:12px 18px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.ok{background:var(--rh-main);}
    .toast.warn{background:#d97706;}
    .toast.err{background:#dc2626;}

    /* SECTION DIVIDER */
    .section-divider{display:flex;align-items:center;gap:10px;margin:18px 0 14px;}
    .section-divider span{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;white-space:nowrap;}
    .section-divider::before,.section-divider::after{content:'';flex:1;height:1px;background:var(--border);}

    /* INFO SALARI√â */
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .info-field{display:flex;flex-direction:column;gap:3px;}
    .info-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;}
    .info-val{font-size:13px;font-weight:600;color:var(--text);}
    .info-missing{color:#dc2626;font-style:italic;}

    /* PORTAIL LIEN */
    .portail-banner{background:linear-gradient(135deg,#0f172a,#1e3a5f);border-radius:12px;padding:16px 20px;display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;}
    .portail-url{font-family:monospace;font-size:12px;color:#7dd3fc;background:rgba(255,255,255,.07);padding:6px 12px;border-radius:6px;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .portail-actions{display:flex;gap:6px;flex-shrink:0;}
    .btn-portail{padding:7px 13px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;}
    .btn-portail.copy{background:#0ea5e9;color:white;}
    .btn-portail.copy:hover{background:#0284c7;}
    .btn-portail.mail{background:#10b981;color:white;}
    .btn-portail.mail:hover{background:#059669;}
    .btn-portail.open{background:rgba(255,255,255,.1);color:#e2e8f0;border:1px solid rgba(255,255,255,.15);}
    .btn-portail.open:hover{background:rgba(255,255,255,.2);}

    /* JOURNAL RH */
    .journal-wrap{max-height:320px;overflow-y:auto;display:flex;flex-direction:column;gap:8px;margin-bottom:12px;}
    .journal-entry{display:flex;gap:10px;align-items:flex-start;}
    .journal-dot{width:8px;height:8px;border-radius:50%;background:var(--rh-main);flex-shrink:0;margin-top:5px;}
    .journal-body{flex:1;background:#f8faff;border-radius:8px;padding:9px 12px;}
    .journal-meta{font-size:10px;color:var(--muted);margin-bottom:3px;display:flex;gap:6px;}
    .journal-text{font-size:12px;color:var(--text);line-height:1.5;}
    .journal-add{display:flex;gap:8px;align-items:flex-end;}
    .journal-input{flex:1;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;color:var(--text);outline:none;resize:none;}
    .journal-input:focus{border-color:var(--rh-main);}
    .journal-empty{text-align:center;padding:20px;color:var(--muted);font-size:12px;}

    /* OBJECTIFS */
    .obj-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px;}
    .obj-col{background:#f8faff;border:1px solid var(--border);border-radius:10px;padding:12px;}
    .obj-col-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;display:flex;align-items:center;gap:5px;}
    .obj-item{display:flex;align-items:flex-start;gap:6px;margin-bottom:5px;font-size:12px;}
    .obj-cb{margin-top:2px;flex-shrink:0;accent-color:var(--rh-main);}
    .obj-textarea{width:100%;padding:7px 9px;border:1.5px solid var(--border);border-radius:7px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;resize:vertical;outline:none;background:white;}
    .obj-textarea:focus{border-color:var(--rh-main);}

    /* EMAIL TEMPLATES */
    .tpl-bar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px;}
    .tpl-btn{padding:6px 12px;border:1.5px solid var(--on-border);border-radius:7px;background:var(--on-ghost);color:var(--on-main);font-family:'Plus Jakarta Sans',sans-serif;font-size:11px;font-weight:700;cursor:pointer;transition:all .15s;}
    .tpl-btn:hover{background:#bae6fd;border-color:#0ea5e9;}
    .tpl-btn.off-tpl{border-color:var(--off-border);background:var(--off-ghost);color:#d97706;}
    .tpl-btn.off-tpl:hover{background:#fde68a;}
    .email-preview{background:#f8faff;border:1px solid var(--border);border-radius:8px;padding:12px 14px;font-size:12px;line-height:1.7;color:var(--text);margin-bottom:10px;white-space:pre-wrap;max-height:200px;overflow-y:auto;}
    .email-subject{font-size:11px;font-weight:700;color:var(--muted);margin-bottom:6px;}

    /* EVAL PERIODE ESSAI (offboarding) */
    .pe-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .pe-field{display:flex;flex-direction:column;gap:4px;}
    .pe-label{font-size:11px;font-weight:600;color:var(--muted);}
    .pe-input{padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;outline:none;}
    .pe-input:focus{border-color:var(--off-main);}
    .pe-stars{display:flex;gap:4px;}
    .pe-star{font-size:22px;cursor:pointer;transition:transform .1s;color:#d1d5db;}
    .pe-star.lit{color:#f59e0b;}
    .pe-star:hover{transform:scale(1.2);}

    /* ALERTE DOCS */
    .alert-docs{background:#fff7ed;border:1.5px solid #fed7aa;border-radius:10px;padding:12px 16px;display:flex;align-items:flex-start;gap:10px;}
    .alert-docs-icon{font-size:18px;flex-shrink:0;}
    .alert-docs-body{flex:1;}
    .alert-docs-title{font-size:12px;font-weight:700;color:#c2410c;margin-bottom:4px;}
    .alert-docs-list{font-size:11px;color:#9a3412;line-height:1.7;}

    /* INFOS SALARI√â √âTENDU */
    .info-grid-ext{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
    .info-section-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin:14px 0 8px;display:flex;align-items:center;gap:6px;}
    .contact-urgence-card{background:#fff7ed;border:1px solid #fed7aa;border-radius:8px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px;}

    /* RESPONSIVE */
    @media(max-width:768px){
      .content{flex-direction:column;padding:12px;}
      .left-panel{width:100%;}
      .kpi-row{grid-template-columns:1fr 1fr;}
      .info-grid,.audit-grid,.stc-grid,.mrow,.pe-grid,.info-grid-ext{grid-template-columns:1fr;}
      .obj-grid{grid-template-columns:1fr;}
    }

    /* LOADER */
    .loader{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--muted);gap:10px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--rh-main);border-radius:50%;animation:spin .7s linear infinite;}
  </style>
</head>
<body>

<div class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-left">
      <h1>üöÄ Onboarding & Offboarding</h1>
      <p>Gestion de l'arriv√©e et du d√©part des salari√©s ¬∑ R√©tro-planning ¬∑ Documents ¬∑ Audit</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-ghost btn-sm" onclick="openModal('modal-off')">üö™ Nouveau offboarding</button>
      <button class="btn btn-on btn-sm" onclick="openModal('modal-on')">üéâ Nouvel onboarding</button>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs-bar">
    <button class="tab-btn on" data-tab="onboarding" onclick="switchTab('onboarding',this)">
      üü¢ Onboardings <span class="tab-count" id="cnt-on">0</span>
    </button>
    <button class="tab-btn" data-tab="offboarding" onclick="switchTab('offboarding',this)">
      üü° Offboardings <span class="tab-count" id="cnt-off">0</span>
    </button>
    <button class="tab-btn" data-tab="archives" onclick="switchTab('archives',this)">
      üì¶ Archiv√©s <span class="tab-count" id="cnt-arch">0</span>
    </button>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- LEFT PANEL -->
    <div class="left-panel">
      <div class="card" style="flex:1">
        <div class="card-head">
          <div class="card-title" id="list-title">üìã Dossiers</div>
          <button class="btn btn-rh btn-xs" onclick="openModal('modal-on')">+</button>
        </div>
        <div id="dossier-list">
          <div class="loader"><div class="spin"></div></div>
        </div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel" id="right-panel">
      <div class="empty-state">
        <div class="empty-icon">üöÄ</div>
        <h3 style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px">S√©lectionnez un dossier</h3>
        <p style="font-size:13px;line-height:1.7;max-width:300px">Cr√©ez un onboarding pour accompagner l'arriv√©e d'un salari√©, ou un offboarding pour g√©rer son d√©part sereinement.</p>
        <div style="display:flex;gap:8px;margin-top:16px">
          <button class="btn btn-on" onclick="openModal('modal-on')">üéâ Nouvel onboarding</button>
          <button class="btn btn-off" onclick="openModal('modal-off')">üö™ Nouveau offboarding</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- MODAL ONBOARDING -->
<div class="modal-overlay" id="modal-on">
  <div class="modal">
    <div class="modal-head">
      <h3>üéâ Nouvel onboarding</h3>
      <button class="modal-close" onclick="closeModal('modal-on')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="mrow">
        <div class="mfield">
          <label class="mlabel">Pr√©nom *</label>
          <input class="minput" id="on-prenom" placeholder="Marie"/>
        </div>
        <div class="mfield">
          <label class="mlabel">Nom *</label>
          <input class="minput" id="on-nom" placeholder="DUPONT"/>
        </div>
      </div>
      <div class="mrow">
        <div class="mfield">
          <label class="mlabel">Poste / Fonction *</label>
          <input class="minput" id="on-poste" placeholder="Responsable ventes"/>
        </div>
        <div class="mfield">
          <label class="mlabel">Type de contrat</label>
          <select class="mselect" id="on-contrat">
            <option value="CDI">CDI</option>
            <option value="CDD">CDD</option>
            <option value="Alternance">Alternance</option>
            <option value="Stage">Stage</option>
            <option value="Int√©rim">Int√©rim</option>
          </select>
        </div>
      </div>
      <div class="mrow">
        <div class="mfield">
          <label class="mlabel">üìÖ Date d'arriv√©e *</label>
          <input class="minput" id="on-date" type="date"/>
        </div>
        <div class="mfield">
          <label class="mlabel">Responsable accueil</label>
          <input class="minput" id="on-resp" placeholder="Jean Martin"/>
        </div>
      </div>
      <div class="mfield">
        <label class="mlabel">Email professionnel (√† cr√©er)</label>
        <input class="minput" id="on-email" placeholder="m.dupont@entreprise.fr" type="email"/>
      </div>
      <div class="mfield">
        <label class="mlabel">Notes / Particularit√©s</label>
        <textarea class="minput" id="on-notes" rows="2" placeholder="T√©l√©travail le vendredi, parking √† pr√©voir..."></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('modal-on')">Annuler</button>
      <button class="btn btn-on" onclick="createDossier('onboarding')">üéâ Cr√©er l'onboarding ‚Üí</button>
    </div>
  </div>
</div>

<!-- MODAL OFFBOARDING -->
<div class="modal-overlay" id="modal-off">
  <div class="modal">
    <div class="modal-head">
      <h3>üö™ Nouveau offboarding</h3>
      <button class="modal-close" onclick="closeModal('modal-off')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="mrow">
        <div class="mfield">
          <label class="mlabel">Pr√©nom *</label>
          <input class="minput" id="off-prenom" placeholder="Paul"/>
        </div>
        <div class="mfield">
          <label class="mlabel">Nom *</label>
          <input class="minput" id="off-nom" placeholder="MARTIN"/>
        </div>
      </div>
      <div class="mrow">
        <div class="mfield">
          <label class="mlabel">Poste occup√©</label>
          <input class="minput" id="off-poste" placeholder="Vendeur"/>
        </div>
        <div class="mfield">
          <label class="mlabel">Motif de d√©part</label>
          <select class="mselect" id="off-motif">
            <option value="demission">D√©mission</option>
            <option value="rupture">Rupture conventionnelle</option>
            <option value="licenciement">Licenciement</option>
            <option value="fin-cdd">Fin de CDD</option>
            <option value="retraite">D√©part en retraite</option>
            <option value="autre">Autre</option>
          </select>
        </div>
      </div>
      <div class="mrow">
        <div class="mfield">
          <label class="mlabel">üìÖ Date de d√©part *</label>
          <input class="minput" id="off-date" type="date"/>
        </div>
        <div class="mfield">
          <label class="mlabel">Dur√©e pr√©avis (jours)</label>
          <input class="minput" id="off-preavis" type="number" placeholder="30"/>
        </div>
      </div>
      <div class="mrow">
        <div class="mfield">
          <label class="mlabel">Solde cong√©s restants (j)</label>
          <input class="minput" id="off-conges" type="number" placeholder="12"/>
        </div>
        <div class="mfield">
          <label class="mlabel">Salaire brut mensuel (‚Ç¨)</label>
          <input class="minput" id="off-salaire" type="number" placeholder="2000"/>
        </div>
      </div>
      <div class="mfield">
        <label class="mlabel">Notes</label>
        <textarea class="minput" id="off-notes" rows="2" placeholder="Passation avec Jean, mat√©riel √† r√©cup√©rer..."></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('modal-off')">Annuler</button>
      <button class="btn btn-off" onclick="createDossier('offboarding')">üö™ Cr√©er l'offboarding ‚Üí</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth=getAuth(app);const db=getFirestore(app);
  window._auth=auth;window._db=db;window._doc=doc;window._setDoc=setDoc;
  window._getDoc=getDoc;window._collection=collection;window._getDocs=getDocs;
  window._deleteDoc=deleteDoc;window._signOut=signOut;
  onAuthStateChanged(auth,function(user){
    if(!user){window.location.href='index.html';return;}
    window._uid=user.uid;window._firebaseReady=true;
    window._authDisplayName = user.displayName || user.email.split('@')[0];
    window.initOnboarding();
  });
</script>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
var _dossiers={};
var _currentId=null;
var _currentTab='onboarding';
var _auditRating={integration:0,ambiance:0,formation:0};

// ‚îÄ‚îÄ TEMPLATES T√ÇCHES ‚îÄ‚îÄ

var TASKS_ONBOARDING=[
  {phase:'J-30',label:'30 jours avant',emoji:'üìã',color:'#0ea5e9',tag:'tag-on',tasks:[
    {id:'dpae',label:'DPAE envoy√©e √† l\'URSSAF',note:'D√©claration Pr√©alable √Ä l\'Embauche (obligatoire avant le 1er jour)'},
    {id:'contrat',label:'Contrat de travail r√©dig√© et envoy√© pour signature'},
    {id:'mutuelle',label:'Adh√©sion mutuelle / pr√©voyance transmise au salari√©'},
    {id:'pieces',label:'Collecte des pi√®ces justificatives (CNI, RIB, attestation SS)'},
    {id:'dossier-employe',label:'Cr√©ation du dossier salari√© dans le module Employ√©s'},
    {id:'visite-med',label:'Visite m√©dicale d\'embauche planifi√©e'},
    {id:'droit-image',label:'Droit √† l\'image : signature si l\'entreprise dispose de cam√©ras ou utilise des photos/vid√©os du salari√©',note:'Obligatoire si pr√©sence de cam√©ras de surveillance ou usage d\'images √† des fins de communication'}
  ]},
  {phase:'J-15',label:'15 jours avant',emoji:'üóì',color:'#6366f1',tag:'tag-on',tasks:[
    {id:'planning-j1',label:'Planning du 1er jour communiqu√© au salari√©'},
    {id:'poste',label:'Poste de travail pr√©par√© et √©quip√©'},
    {id:'acces',label:'Badge / cl√©s / acc√®s pr√©vus et command√©s'},
    {id:'outils',label:'Email professionnel et outils m√©tier cr√©√©s'},
    {id:'livret',label:'Livret d\'accueil imprim√© ou envoy√©'},
    {id:'equipe',label:'Pr√©sentation de l\'√©quipe organis√©e (planning de tourn√©e)'}
  ]},
  {phase:'J-7',label:'7 jours avant',emoji:'‚úÖ',color:'#10b981',tag:'tag-rh',tasks:[
    {id:'reglement',label:'R√®glement int√©rieur imprim√© en 2 exemplaires'},
    {id:'programme',label:'Programme J1 d√©taill√© finalis√©'},
    {id:'mentor',label:'Bin√¥me / mentor d√©sign√© pour l\'int√©gration'},
    {id:'reunion',label:'R√©union d\'√©quipe de bienvenue planifi√©e'}
  ]},
  {phase:'JOUR J',label:'Jour d\'arriv√©e üéâ',emoji:'üéâ',color:'#059669',tag:'tag-dayj',dayJ:true,tasks:[
    {id:'accueil',label:'Accueil et visite compl√®te des locaux'},
    {id:'presentation-equipe',label:'Pr√©sentation formelle √† toute l\'√©quipe'},
    {id:'signature-contrat',label:'Signature du contrat de travail'},
    {id:'signature-ri',label:'Signature du r√®glement int√©rieur'},
    {id:'consignes',label:'Formation aux consignes de s√©curit√©'},
    {id:'materiel',label:'Remise du mat√©riel, badges et acc√®s informatiques'},
    {id:'tour',label:'Tour des processus et outils internes'}
  ]},
  {phase:'J+7',label:'Audit J+7',emoji:'üìä',color:'#8b5cf6',tag:'tag-on',tasks:[
    {id:'entretien-suivi',label:'Entretien de suivi r√©alis√© (comment √ßa se passe ?)'},
    {id:'points-amelio',label:'Points d\'am√©lioration identifi√©s et not√©s'},
    {id:'formation-suite',label:'Plan de formation compl√©mentaire si besoin'},
    {id:'integration-ok',label:'Int√©gration valid√©e ‚Äî dossier marqu√© comme termin√© ‚úÖ'}
  ]}
];

var TASKS_OFFBOARDING=[
  {phase:'J-30',label:'30 jours avant le d√©part',emoji:'üìã',color:'#f59e0b',tag:'tag-off',tasks:[
    {id:'lettre',label:'Lettre de d√©mission / document de rupture re√ßu et archiv√©'},
    {id:'date-fin',label:'Date de fin de contrat confirm√©e et notifi√©e'},
    {id:'calcul-preavis',label:'Calcul du pr√©avis et de la date effective de sortie'},
    {id:'passation-plan',label:'Plan de passation des dossiers et clients √©tabli'},
    {id:'annonce',label:'Annonce du d√©part √† l\'√©quipe organis√©e'}
  ]},
  {phase:'J-15',label:'15 jours avant',emoji:'üìÑ',color:'#ef4444',tag:'tag-off',tasks:[
    {id:'attestation',label:'Attestation employeur pr√©par√©e'},
    {id:'certificat',label:'Certificat de travail r√©dig√©'},
    {id:'solde-calc',label:'Calcul du solde de cong√©s restants effectu√©'},
    {id:'stc-prep',label:'Re√ßu pour solde de tout compte pr√©par√©'},
    {id:'attestation-pe',label:'Attestation P√¥le Emploi (France Travail) pr√©par√©e'}
  ]},
  {phase:'J-7',label:'7 jours avant',emoji:'üîÑ',color:'#6366f1',tag:'tag-off',tasks:[
    {id:'passation-ok',label:'Passation des dossiers et clients termin√©e'},
    {id:'materiel-list',label:'Inventaire du mat√©riel √† r√©cup√©rer √©tabli'},
    {id:'acces-plan',label:'D√©sactivation des acc√®s programm√©e (J+1 dernier jour)'},
    {id:'entretien-sortie',label:'Entretien de sortie planifi√© (optionnel)'}
  ]},
  {phase:'DERNIER JOUR',label:'Dernier jour üö™',emoji:'üö™',color:'#dc2626',tag:'tag-off',dayJ:true,tasks:[
    {id:'materiel-rendu',label:'Remise du mat√©riel : cl√©s, badge, ordinateur, t√©l√©phone'},
    {id:'sign-cert',label:'Signature du certificat de travail (2 exemplaires)'},
    {id:'sign-stc',label:'Signature du re√ßu pour solde de tout compte'},
    {id:'remise-pe',label:'Remise de l\'attestation P√¥le Emploi / France Travail'},
    {id:'acces-off',label:'D√©sactivation imm√©diate de tous les acc√®s et emails'},
    {id:'entretien',label:'Entretien de sortie r√©alis√© (si souhait√©)'}
  ]}
];

var DOCS_ONBOARDING=[
  {id:'contrat-sign',label:'Contrat de travail sign√©',icon:'üìù'},
  {id:'dpae-envoi',label:'DPAE envoy√©e √† l\'URSSAF',icon:'üìÆ'},
  {id:'cni',label:'Copie CNI / Titre de s√©jour',icon:'ü™™'},
  {id:'rib',label:'RIB pour virement salaire',icon:'üè¶'},
  {id:'secu-soc',label:'Attestation S√©curit√© Sociale',icon:'üè•'},
  {id:'mutuelle-adh',label:'Adh√©sion mutuelle sign√©e',icon:'üíä'},
  {id:'reglement-sign',label:'R√®glement int√©rieur sign√©',icon:'üìã'},
  {id:'livret-acc',label:'Livret d\'accueil remis',icon:'üìñ'},
  {id:'declaration-conf',label:'D√©claration confidentialit√© sign√©e',icon:'üîí'}
];

var DOCS_OFFBOARDING=[
  {id:'lettre-dem',label:'Lettre de d√©mission / rupture',icon:'‚úâÔ∏è'},
  {id:'cert-travail',label:'Certificat de travail sign√©',icon:'üìÑ'},
  {id:'att-employ',label:'Attestation employeur',icon:'üìã'},
  {id:'stc-sign',label:'Re√ßu solde de tout compte sign√©',icon:'üí∞'},
  {id:'att-pe',label:'Attestation P√¥le Emploi remise',icon:'üè¢'},
  {id:'materiel-ok',label:'Retour mat√©riel confirm√©',icon:'üíª'},
  {id:'acces-off-conf',label:'D√©sactivation acc√®s confirm√©e',icon:'üîê'}
];

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
window.initOnboarding=async function(){
  if(!window._uid)return;
  await loadDossiers();
};

async function loadDossiers(){
  _dossiers={};
  try{
    var snap=await window._getDocs(window._collection(window._db,'rh_onboarding',window._uid,'dossiers'));
    snap.forEach(function(d){_dossiers[d.id]={id:d.id,...d.data()};});
  }catch(e){console.warn('Firestore:',e);}
  renderList();
  updateCounts();
}

// ‚îÄ‚îÄ RENDER LIST ‚îÄ‚îÄ
function renderList(){
  var tab=_currentTab;
  var items=Object.values(_dossiers).filter(function(d){
    if(tab==='archives') return d.archived;
    if(tab==='onboarding') return d.type==='onboarding'&&!d.archived;
    if(tab==='offboarding') return d.type==='offboarding'&&!d.archived;
    return false;
  }).sort(function(a,b){return(a.dateJ||'')-(b.dateJ||'');});

  var list=document.getElementById('dossier-list');
  var title=document.getElementById('list-title');
  if(tab==='onboarding') title.innerHTML='üéâ Onboardings';
  else if(tab==='offboarding') title.innerHTML='üö™ Offboardings';
  else title.innerHTML='üì¶ Archives';

  if(items.length===0){
    list.innerHTML='<div style="padding:24px;text-align:center;color:var(--muted);font-size:12px"><div style="font-size:32px;margin-bottom:8px">'+(tab==='onboarding'?'üéâ':'üö™')+'</div>Aucun dossier.<br>Cr√©ez-en un avec le bouton ci-dessus.</div>';
    return;
  }

  list.innerHTML=items.map(function(d){
    var pct=calcProgress(d);
    var colorClass=d.type==='onboarding'?'active-on':'active-off';
    var isActive=_currentId===d.id;
    var bg=d.type==='onboarding'?'linear-gradient(135deg,#0284c7,#0ea5e9)':'linear-gradient(135deg,#d97706,#f59e0b)';
    var fillColor=d.type==='onboarding'?'var(--on-main)':'var(--off-main)';
    var jLabel=d.type==='onboarding'?'Arriv√©e':'D√©part';
    var daysLeft=daysUntil(d.dateJ);
    var daysStr=daysLeft>0?'Dans '+daysLeft+' j':daysLeft===0?'Aujourd\'hui':'Il y a '+Math.abs(daysLeft)+' j';
    return '<div class="dossier-item '+(isActive?colorClass:'')+'" onclick="openDossier(\''+d.id+'\')">'
      +'<div class="doss-avatar" style="background:'+bg+'">'+initials(d.prenom,d.nom)+'</div>'
      +'<div class="doss-info">'
        +'<div class="doss-name">'+d.prenom+' '+d.nom+'</div>'
        +'<div class="doss-meta">'+d.poste+' ¬∑ '+jLabel+' : '+(d.dateJ?formatDate(d.dateJ):'‚Äî')+'</div>'
        +'<div class="doss-meta" style="color:'+(daysLeft<=0?'var(--red)':daysLeft<=7?'#d97706':'var(--rh-main)')+'">'+daysStr+'</div>'
        +'<div class="doss-progress"><div class="prog-bar"><div class="prog-fill" style="width:'+pct+'%;background:'+fillColor+'"></div></div><span class="prog-pct">'+pct+'%</span></div>'
      +'</div>'
      +'</div>';
  }).join('');
}

function updateCounts(){
  var on=Object.values(_dossiers).filter(function(d){return d.type==='onboarding'&&!d.archived;}).length;
  var off=Object.values(_dossiers).filter(function(d){return d.type==='offboarding'&&!d.archived;}).length;
  var arch=Object.values(_dossiers).filter(function(d){return d.archived;}).length;
  document.getElementById('cnt-on').textContent=on;
  document.getElementById('cnt-off').textContent=off;
  document.getElementById('cnt-arch').textContent=arch;
}

// ‚îÄ‚îÄ OPEN DOSSIER ‚îÄ‚îÄ
function openDossier(id){
  _currentId=id;
  renderList();
  var d=_dossiers[id];
  if(d.type==='onboarding') renderOnboarding(d);
  else renderOffboarding(d);
}

// ‚îÄ‚îÄ RENDER ONBOARDING ‚îÄ‚îÄ
function renderOnboarding(d){
  var pct=calcProgress(d);
  var tasksDone=countDone(d);
  var tasksTotal=countTotal('onboarding');
  var docsDone=countDocsDone(d,'onboarding');
  var daysLeft=daysUntil(d.dateJ);

  var rp=document.getElementById('right-panel');
  rp.innerHTML=
    // HEADER
    '<div class="card" style="padding:18px 22px">'
      +'<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:14px">'
        +'<div>'
          +'<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">'
            +'<div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#0284c7,#0ea5e9);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;color:white">'+initials(d.prenom,d.nom)+'</div>'
            +'<div>'
              +'<div style="font-size:18px;font-weight:800">'+d.prenom+' '+d.nom+'</div>'
              +'<div style="font-size:12px;color:var(--muted)">'+d.poste+' ¬∑ '+d.contrat+'</div>'
            +'</div>'
          +'</div>'
          +'<div style="display:flex;gap:6px;flex-wrap:wrap">'
            +'<span class="badge badge-on">üéâ Onboarding</span>'
            +(daysLeft>0?'<span class="badge badge-wait">‚è∞ J-'+daysLeft+'</span>':daysLeft===0?'<span class="badge badge-done">üéâ Aujourd\'hui !</span>':'<span class="badge badge-done">‚úÖ Arriv√©</span>')
            +(d.resp?'<span class="badge" style="background:#f5f3ff;color:#6366f1">üë§ '+d.resp+'</span>':'')
          +'</div>'
        +'</div>'
        +'<div style="display:flex;gap:6px">'
          +(d.empId?'<a href="rh-employes.html" class="btn btn-rh btn-sm" title="Voir la fiche employ√©">üë§ Fiche employ√©</a>':'<button class="btn btn-outline btn-sm" onclick="createEmployeBtn(\''+d.id+'\')">‚ûï Cr√©er fiche</button>')
          +'<button class="btn btn-ghost btn-sm" onclick="archiveDossier(\''+d.id+'\')">üì¶ Archiver</button>'
          +'<button class="btn btn-danger btn-sm" onclick="deleteDossier(\''+d.id+'\')">üóë</button>'
        +'</div>'
      +'</div>'
      // KPI
      +'<div class="kpi-row">'
        +'<div class="kpi-box blue">'
          +'<div class="kpi-lbl">Jours restants</div>'
          +'<div class="kpi-val blue">'+(daysLeft>0?daysLeft:daysLeft===0?'J0':'J+'+ Math.abs(daysLeft))+'</div>'
          +'<div class="kpi-sub">Arriv√©e : '+formatDate(d.dateJ)+'</div>'
        +'</div>'
        +'<div class="kpi-box green">'
          +'<div class="kpi-lbl">Avancement</div>'
          +'<div class="kpi-val green">'+pct+'%</div>'
          +'<div class="kpi-sub">'+tasksDone+'/'+tasksTotal+' t√¢ches</div>'
        +'</div>'
        +'<div class="kpi-box '+(docsDone===DOCS_ONBOARDING.length?'green':'amber')+'">'
          +'<div class="kpi-lbl">Documents</div>'
          +'<div class="kpi-val '+(docsDone===DOCS_ONBOARDING.length?'green':'amber')+'">'+docsDone+'/'+DOCS_ONBOARDING.length+'</div>'
          +'<div class="kpi-sub">'+(docsDone===DOCS_ONBOARDING.length?'Tous re√ßus ‚úÖ':'En attente')+'</div>'
        +'</div>'
        +'<div class="kpi-box purple">'
          +'<div class="kpi-lbl">Audit J+7</div>'
          +'<div class="kpi-val" style="color:#6366f1">'+(d.audit&&d.audit.done?'‚úÖ':'‚è≥')+'</div>'
          +'<div class="kpi-sub">'+(d.audit&&d.audit.done?'R√©alis√©':'√Ä r√©aliser J+7')+'</div>'
        +'</div>'
      +'</div>'
    +'</div>'
    // BANNI√àRE PORTAIL EMPLOY√â
    +(d.empId?
      '<div class="card" style="padding:16px 20px">'
        +'<div style="font-size:12px;font-weight:700;color:var(--text);margin-bottom:10px;display:flex;align-items:center;gap:6px">üîó Portail salari√© <span style="font-size:10px;font-weight:400;color:var(--muted)">‚Äî Envoyez ce lien au salari√© pour qu\'il compl√®te son profil</span></div>'
        +'<div class="portail-banner">'
          +'<span class="portail-url" id="portail-url-'+d.id+'">Chargement du lien...</span>'
          +'<div class="portail-actions">'
            +'<button class="btn-portail copy" onclick="copyPortailLink(\''+d.id+'\')">üìã Copier</button>'
            +'<button class="btn-portail mail" onclick="sendPortailEmail(\''+d.id+'\')">üìß Envoyer par email</button>'
            +'<button class="btn-portail open" onclick="openPortailLink(\''+d.id+'\')">‚Üó Ouvrir</button>'
          +'</div>'
        +'</div>'
        +'<div style="font-size:10px;color:#64748b;margin-top:8px">üí° Le salari√© peut compl√©ter ses informations personnelles (RIB, coordonn√©es, documents) directement depuis ce lien s√©curis√©</div>'
      +'</div>'
    :'<div class="card" style="padding:14px 20px;background:#f8faff;border:1.5px dashed var(--on-border)">'
      +'<div style="font-size:12px;color:var(--muted);text-align:center">‚ö†Ô∏è Fiche employ√© non cr√©√©e ‚Äî <button class="btn btn-on btn-sm" onclick="createEmployeBtn(\''+d.id+'\')">‚ûï Cr√©er la fiche maintenant</button></div>'
    +'</div>')
    // ALERTES DOCUMENTS MANQUANTS
    +(function(){
      var missingDocs=DOCS_ONBOARDING.filter(function(doc){return !d.docs||!d.docs[doc.id];});
      var dLeft=daysUntil(d.dateJ);
      if(missingDocs.length>0&&dLeft<=7&&dLeft>=0){
        return '<div class="alert-docs">'
          +'<div class="alert-docs-icon">‚ö†Ô∏è</div>'
          +'<div class="alert-docs-body">'
            +'<div class="alert-docs-title">'+missingDocs.length+' document(s) manquant(s) ¬∑ Arriv√©e dans '+dLeft+' jour(s) !</div>'
            +'<div class="alert-docs-list">'+missingDocs.map(function(doc){return '‚Ä¢ '+doc.icon+' '+doc.label;}).join('<br>')+'</div>'
          +'</div>'
        +'</div>';
      }
      return '';
    })()
    // R√âTRO-PLANNING
    +'<div class="card">'
      +'<div class="card-head"><div class="card-title">üìÖ R√©tro-planning</div>'
        +'<button class="btn btn-rh btn-xs" onclick="saveProgress(\''+d.id+'\')">üíæ Sauvegarder</button>'
      +'</div>'
      +'<div style="padding:18px">'
        +'<div class="timeline-wrap" id="timeline-'+d.id+'">'
          +TASKS_ONBOARDING.map(function(phase){
            var tasksDonePhase=countPhaseDone(d,phase.tasks);
            var phasePct=phase.tasks.length>0?Math.round(tasksDonePhase/phase.tasks.length*100):0;
            var dotClass=phasePct===100?'done':phasePct>0?'active':'pending';
            if(phase.dayJ) dotClass='day-j';
            return '<div class="tl-phase">'
              +'<div class="tl-dot '+dotClass+'"></div>'
              +'<div class="tl-phase-head '+(phase.dayJ?'day-j-head':'phase-on')+'" onclick="togglePhase(\'phase-'+d.id+'-'+phase.phase+'\')">'
                +'<div class="tl-phase-label">'
                  +'<span>'+phase.emoji+' '+phase.label+'</span>'
                  +'<span class="tl-phase-tag '+phase.tag+'">'+phase.phase+'</span>'
                +'</div>'
                +'<span class="tl-prog-mini">'+phasePct+'% ¬∑ '+tasksDonePhase+'/'+phase.tasks.length+'</span>'
              +'</div>'
              +'<div id="phase-'+d.id+'-'+phase.phase+'" class="tl-tasks" style="display:none">'
                +phase.tasks.map(function(t){
                  var checked=(d.tasks&&d.tasks[t.id])?'checked':'';
                  return '<div class="tl-task">'
                    +'<input type="checkbox" class="task-cb cb-on" id="cb-'+t.id+'" '
                      +'data-id="'+d.id+'" data-task="'+t.id+'" '+(checked?'checked':'')+' '
                      +'onchange="toggleTask(\''+d.id+'\',\''+t.id+'\',this.checked)"/>'
                    +'<div>'
                      +'<div class="task-label'+(checked?' done-label':'')+'">'+t.label+'</div>'
                      +(t.note?'<div class="task-note">üí° '+t.note+'</div>':'')
                    +'</div>'
                  +'</div>';
                }).join('')
              +'</div>'
            +'</div>';
          }).join('')
        +'</div>'
      +'</div>'
    +'</div>'
    // DOCUMENTS
    +'<div class="card">'
      +'<div class="card-head"><div class="card-title">üìé Documents √† collecter</div>'
        +'<span class="badge badge-'+(docsDone===DOCS_ONBOARDING.length?'done':'wait')+'">'+docsDone+'/'+DOCS_ONBOARDING.length+'</span>'
      +'</div>'
      +'<div style="padding:14px">'
        +'<div class="doc-grid">'
          +DOCS_ONBOARDING.map(function(doc){
            var ok=d.docs&&d.docs[doc.id];
            return '<div class="doc-row">'
              +'<div class="doc-name"><span class="doc-icon">'+doc.icon+'</span>'+doc.label+'</div>'
              +'<div class="doc-status">'
                +'<span class="doc-badge '+(ok?'doc-ok':'doc-missing')+'">'+(ok?'‚úÖ Re√ßu':'‚ö†Ô∏è Manquant')+'</span>'
                +'<button class="doc-toggle '+(ok?'on':'off')+'" onclick="toggleDoc(\''+d.id+'\',\''+doc.id+'\',this)" title="Marquer comme re√ßu"></button>'
              +'</div>'
            +'</div>';
          }).join('')
        +'</div>'
      +'</div>'
    +'</div>'
    // INFOS SALARI√â
    +'<div class="card">'
      +'<div class="card-head"><div class="card-title">üë§ Informations salari√©</div>'
        +'<span style="font-size:11px;color:var(--muted)">Synchronis√© avec le module Employ√©s</span>'
      +'</div>'
      +'<div style="padding:14px">'
        +'<div class="info-grid-ext">'
          +renderInfoField('Email pro',d.email,'√Ä cr√©er')
          +renderInfoField('T√©l√©phone',d.telephone||'','√Ä renseigner')
          +renderInfoField('Responsable',d.resp,'Non d√©fini')
          +renderInfoField('Contrat',d.contrat,'‚Äî')
          +renderInfoField('Date arriv√©e',d.dateJ?formatDate(d.dateJ):'‚Äî','')
          +renderInfoField('D√©partement / √âquipe',d.departement||'','Non d√©fini')
        +'</div>'
        +(d.contactUrgenceNom?
          '<div style="margin-top:10px">'
            +'<div class="info-section-title">üö® Contact d\'urgence</div>'
            +'<div class="contact-urgence-card">'
              +'<div><div style="font-size:13px;font-weight:700">'+d.contactUrgenceNom+'</div>'
              +'<div style="font-size:11px;color:var(--muted)">'+(d.contactUrgenceLien||'')+(d.contactUrgenceTel?' ¬∑ '+d.contactUrgenceTel:'')+'</div></div>'
              +(d.contactUrgenceTel?'<a href="tel:'+d.contactUrgenceTel+'" style="color:#d97706;font-size:12px;font-weight:700;text-decoration:none">üìû Appeler</a>':'')
            +'</div>'
          +'</div>'
        :'<div style="margin-top:10px"><button class="btn btn-ghost btn-xs" onclick="addContactUrgence(\''+d.id+'\')">‚ûï Ajouter un contact d\'urgence</button></div>')
        +(d.notes?'<div style="margin-top:10px;padding:10px;background:#f8faff;border-radius:8px;font-size:12px;color:var(--text)"><span style="font-weight:700;color:var(--muted)">Notes : </span>'+d.notes+'</div>':'')
      +'</div>'
    +'</div>'
    // TEMPLATES EMAILS
    +'<div class="card">'
      +'<div class="card-head"><div class="card-title">üìß Templates emails</div>'
        +'<span style="font-size:11px;color:var(--muted)">Envoi rapide depuis votre client mail</span>'
      +'</div>'
      +'<div style="padding:14px">'
        +'<div class="tpl-bar">'
          +'<button class="tpl-btn" onclick="showEmailTpl(\'bienvenue\',\''+d.id+'\')">üéâ Email de bienvenue</button>'
          +'<button class="tpl-btn" onclick="showEmailTpl(\'docs\',\''+d.id+'\')">üìé Documents manquants</button>'
          +'<button class="tpl-btn" onclick="showEmailTpl(\'j1\',\''+d.id+'\')">üóì Rappel J-1</button>'
          +'<button class="tpl-btn" onclick="showEmailTpl(\'portail\',\''+d.id+'\')">üîó Lien portail salari√©</button>'
        +'</div>'
        +'<div id="email-tpl-preview-'+d.id+'" style="display:none">'
          +'<div class="email-subject" id="email-tpl-subject-'+d.id+'"></div>'
          +'<div class="email-preview" id="email-tpl-body-'+d.id+'"></div>'
          +'<div style="display:flex;gap:8px">'
            +'<button class="btn btn-on btn-sm" onclick="sendEmailTpl(\''+d.id+'\')">üì§ Ouvrir dans le client mail</button>'
            +'<button class="btn btn-ghost btn-sm" onclick="copyEmailTpl(\''+d.id+'\')">üìã Copier le corps</button>'
          +'</div>'
        +'</div>'
      +'</div>'
    +'</div>'
    // OBJECTIFS INT√âGRATION
    +'<div class="card">'
      +'<div class="card-head"><div class="card-title">üéØ Objectifs d\'int√©gration</div>'
        +'<button class="btn btn-rh btn-xs" onclick="saveObjectifs(\''+d.id+'\')">üíæ Sauvegarder</button>'
      +'</div>'
      +'<div style="padding:16px">'
        +'<div class="obj-grid">'
          +'<div class="obj-col">'
            +'<div class="obj-col-title"><span style="color:var(--on-main)">‚óè</span> 1er mois</div>'
            +'<textarea class="obj-textarea" id="obj-m1-'+d.id+'" rows="5" placeholder="Ex: Ma√Ætriser les outils, conna√Ætre l\'√©quipe, comprendre les process...">'+(d.objectifs&&d.objectifs.m1?d.objectifs.m1:'')+'</textarea>'
          +'</div>'
          +'<div class="obj-col">'
            +'<div class="obj-col-title"><span style="color:#6366f1">‚óè</span> 3 mois</div>'
            +'<textarea class="obj-textarea" id="obj-m3-'+d.id+'" rows="5" placeholder="Ex: G√©rer en autonomie les clients, atteindre 80% des objectifs commerciaux...">'+(d.objectifs&&d.objectifs.m3?d.objectifs.m3:'')+'</textarea>'
          +'</div>'
          +'<div class="obj-col">'
            +'<div class="obj-col-title"><span style="color:var(--rh-main)">‚óè</span> 6 mois</div>'
            +'<textarea class="obj-textarea" id="obj-m6-'+d.id+'" rows="5" placeholder="Ex: Fin de p√©riode d\'essai, pleine autonomie, contribution aux projets...">'+(d.objectifs&&d.objectifs.m6?d.objectifs.m6:'')+'</textarea>'
          +'</div>'
        +'</div>'
      +'</div>'
    +'</div>'
    // AUDIT J+7
    +'<div class="audit-card">'
      +'<div class="audit-title">üìä Audit d\'int√©gration J+7</div>'
      +'<div class="audit-grid">'
        +'<div class="audit-field"><label class="audit-label">Date de l\'entretien</label>'
          +'<input class="audit-input" type="date" id="audit-date" value="'+(d.audit&&d.audit.date?d.audit.date:'')+'"/>'
        +'</div>'
        +'<div class="audit-field"><label class="audit-label">R√©alis√© par</label>'
          +'<input class="audit-input" id="audit-par" placeholder="Jean Martin" value="'+(d.audit&&d.audit.par?d.audit.par:'')+'"/>'
        +'</div>'
      +'</div>'
      +'<div class="audit-field" style="margin-bottom:10px"><label class="audit-label">Note d\'int√©gration (1-10)</label>'
        +'<div class="audit-rating" id="rating-integration">'
          +[1,2,3,4,5,6,7,8,9,10].map(function(n){
            return '<button class="rating-btn'+(d.audit&&d.audit.integration>=n?' active':'')+'" data-n="'+n+'" onclick="setRating(\'integration\','+n+',\''+d.id+'\')">'+n+'</button>';
          }).join('')
        +'</div>'
      +'</div>'
      +'<div class="audit-field" style="margin-bottom:10px"><label class="audit-label">Commentaires & points d\'am√©lioration</label>'
        +'<textarea class="audit-textarea" id="audit-comment" rows="3" placeholder="Comment se passe l\'int√©gration ? Points positifs, difficult√©s rencontr√©es...">'+(d.audit&&d.audit.comment?d.audit.comment:'')+'</textarea>'
      +'</div>'
      +'<div style="display:flex;gap:8px;justify-content:flex-end">'
        +'<button class="btn btn-rh" onclick="saveAudit(\''+d.id+'\')">üíæ Sauvegarder l\'audit</button>'
      +'</div>'
    +'</div>'
    // JOURNAL RH
    +'<div class="card">'
      +'<div class="card-head"><div class="card-title">üìì Journal RH <span style="font-size:10px;font-weight:400;color:var(--muted)">‚Äî Historique & notes de suivi</span></div></div>'
      +'<div style="padding:14px">'
        +'<div class="journal-wrap" id="journal-wrap-'+d.id+'">'
          +renderJournalEntries(d)
        +'</div>'
        +'<div class="journal-add">'
          +'<textarea class="journal-input" id="journal-input-'+d.id+'" rows="2" placeholder="Ajouter une note... (ex: Appel effectu√© avec le salari√©, documents relanc√©s...)"></textarea>'
          +'<button class="btn btn-rh btn-sm" onclick="addJournalEntry(\''+d.id+'\')">‚ûï Ajouter</button>'
        +'</div>'
      +'</div>'
    +'</div>'
    // ACTIONS
    +'<div style="display:flex;justify-content:flex-end;gap:8px;padding-bottom:20px">'
      +'<button class="btn btn-ghost" onclick="archiveDossier(\''+d.id+'\')">üì¶ Archiver le dossier</button>'
      +'<button class="btn btn-rh" onclick="saveProgress(\''+d.id+'\')">üíæ Tout sauvegarder</button>'
    +'</div>';

  // Ouvrir par d√©faut la phase active (prochaine non compl√®te)
  autoOpenActivePhase(d,'onboarding');
  // Charger le publicId pour afficher le lien portail
  if(d.empId) loadPortailLink(d);
}

// ‚îÄ‚îÄ RENDER OFFBOARDING ‚îÄ‚îÄ
function renderOffboarding(d){
  var pct=calcProgress(d);
  var tasksDone=countDone(d);
  var tasksTotal=countTotal('offboarding');
  var docsDone=countDocsDone(d,'offboarding');
  var daysLeft=daysUntil(d.dateJ);
  var salaire=parseFloat(d.salaire)||0;
  var conges=parseFloat(d.conges)||0;
  var congesVal=salaire>0&&conges>0?(salaire/30*conges).toFixed(2):0;
  var indemnites=parseFloat(d.indemnites)||0;
  var totalStc=(parseFloat(congesVal)+indemnites).toFixed(2);

  var rp=document.getElementById('right-panel');
  rp.innerHTML=
    // HEADER
    '<div class="card" style="padding:18px 22px">'
      +'<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:14px">'
        +'<div>'
          +'<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">'
            +'<div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#d97706,#f59e0b);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;color:white">'+initials(d.prenom,d.nom)+'</div>'
            +'<div>'
              +'<div style="font-size:18px;font-weight:800">'+d.prenom+' '+d.nom+'</div>'
              +'<div style="font-size:12px;color:var(--muted)">'+d.poste+' ¬∑ '+labelMotif(d.motif)+'</div>'
            +'</div>'
          +'</div>'
          +'<div style="display:flex;gap:6px;flex-wrap:wrap">'
            +'<span class="badge badge-off">üö™ Offboarding</span>'
            +(daysLeft>0?'<span class="badge badge-red">‚è∞ J-'+daysLeft+'</span>':daysLeft===0?'<span class="badge badge-red">üö™ Dernier jour !</span>':'<span class="badge badge-done">‚úÖ Parti</span>')
            +(d.preavis?'<span class="badge badge-wait">Pr√©avis '+d.preavis+' j</span>':'')
          +'</div>'
        +'</div>'
        +'<div style="display:flex;gap:6px">'
          +'<button class="btn btn-ghost btn-sm" onclick="archiveDossier(\''+d.id+'\')">üì¶ Archiver</button>'
          +'<button class="btn btn-danger btn-sm" onclick="deleteDossier(\''+d.id+'\')">üóë</button>'
        +'</div>'
      +'</div>'
      // KPI
      +'<div class="kpi-row">'
        +'<div class="kpi-box amber">'
          +'<div class="kpi-lbl">Jours restants</div>'
          +'<div class="kpi-val amber">'+(daysLeft>0?daysLeft:daysLeft===0?'J0':'Parti')+'</div>'
          +'<div class="kpi-sub">D√©part : '+formatDate(d.dateJ)+'</div>'
        +'</div>'
        +'<div class="kpi-box green">'
          +'<div class="kpi-lbl">Avancement</div>'
          +'<div class="kpi-val green">'+pct+'%</div>'
          +'<div class="kpi-sub">'+tasksDone+'/'+tasksTotal+' t√¢ches</div>'
        +'</div>'
        +'<div class="kpi-box '+(docsDone===DOCS_OFFBOARDING.length?'green':'amber')+'">'
          +'<div class="kpi-lbl">Documents</div>'
          +'<div class="kpi-val '+(docsDone===DOCS_OFFBOARDING.length?'green':'amber')+'">'+docsDone+'/'+DOCS_OFFBOARDING.length+'</div>'
          +'<div class="kpi-sub">'+(docsDone===DOCS_OFFBOARDING.length?'Tous sign√©s ‚úÖ':'En attente')+'</div>'
        +'</div>'
        +'<div class="kpi-box amber">'
          +'<div class="kpi-lbl">Solde total</div>'
          +'<div class="kpi-val amber">'+fmtE(parseFloat(totalStc))+'</div>'
          +'<div class="kpi-sub">Cong√©s + indemnit√©s</div>'
        +'</div>'
      +'</div>'
    +'</div>'
    // R√âTRO-PLANNING
    +'<div class="card">'
      +'<div class="card-head"><div class="card-title">üìÖ R√©tro-planning d√©part</div>'
        +'<button class="btn btn-off btn-xs" onclick="saveProgress(\''+d.id+'\')">üíæ Sauvegarder</button>'
      +'</div>'
      +'<div style="padding:18px">'
        +'<div class="timeline-wrap" id="timeline-'+d.id+'">'
          +TASKS_OFFBOARDING.map(function(phase){
            var tasksDonePhase=countPhaseDone(d,phase.tasks);
            var phasePct=phase.tasks.length>0?Math.round(tasksDonePhase/phase.tasks.length*100):0;
            var dotClass=phasePct===100?'done':phasePct>0?'active':'pending';
            if(phase.dayJ) dotClass='day-j';
            return '<div class="tl-phase">'
              +'<div class="tl-dot '+dotClass+'"></div>'
              +'<div class="tl-phase-head phase-off" onclick="togglePhase(\'phase-'+d.id+'-'+phase.phase+'\')">'
                +'<div class="tl-phase-label">'
                  +'<span>'+phase.emoji+' '+phase.label+'</span>'
                  +'<span class="tl-phase-tag '+phase.tag+'">'+phase.phase+'</span>'
                +'</div>'
                +'<span class="tl-prog-mini">'+phasePct+'% ¬∑ '+tasksDonePhase+'/'+phase.tasks.length+'</span>'
              +'</div>'
              +'<div id="phase-'+d.id+'-'+phase.phase+'" class="tl-tasks" style="display:none">'
                +phase.tasks.map(function(t){
                  var checked=(d.tasks&&d.tasks[t.id])?'checked':'';
                  return '<div class="tl-task">'
                    +'<input type="checkbox" class="task-cb cb-off" '
                      +'data-id="'+d.id+'" data-task="'+t.id+'" '+(checked?'checked':'')+' '
                      +'onchange="toggleTask(\''+d.id+'\',\''+t.id+'\',this.checked)"/>'
                    +'<div>'
                      +'<div class="task-label'+(checked?' done-label':'')+'">'+t.label+'</div>'
                      +(t.note?'<div class="task-note">üí° '+t.note+'</div>':'')
                    +'</div>'
                  +'</div>';
                }).join('')
              +'</div>'
            +'</div>';
          }).join('')
        +'</div>'
      +'</div>'
    +'</div>'
    // SOLDE DE TOUT COMPTE
    +'<div class="card">'
      +'<div class="card-head"><div class="card-title">üí∞ Solde de tout compte</div></div>'
      +'<div style="padding:18px">'
        +'<div class="stc-grid">'
          +'<div class="stc-field">'
            +'<div class="stc-label">Solde cong√©s restants</div>'
            +'<div style="font-size:11px;color:var(--muted);margin-bottom:4px">'+conges+' jour(s) ¬∑ '+(salaire>0?fmtE(salaire/30)+'/j':'‚Äî')+'</div>'
            +'<div class="stc-val">'+fmtE(parseFloat(congesVal))+'</div>'
          +'</div>'
          +'<div class="stc-field">'
            +'<div class="stc-label">Indemnit√©s de d√©part</div>'
            +'<input class="stc-input" type="number" id="stc-indemnites" placeholder="0.00" value="'+(d.indemnites||'')+'" oninput="updateStcTotal(\''+d.id+'\','+parseFloat(congesVal)+')" onchange="updateStcTotal(\''+d.id+'\','+parseFloat(congesVal)+')" style="border-color:var(--off-border)"/>'
          +'</div>'
          +'<div class="stc-field">'
            +'<div class="stc-label">Certificat de travail</div>'
            +'<span class="badge '+(d.docs&&d.docs['cert-travail']?'badge-done':'badge-red')+'">'+(d.docs&&d.docs['cert-travail']?'‚úÖ Sign√©':'‚ö†Ô∏è Non sign√©')+'</span>'
          +'</div>'
          +'<div class="stc-field">'
            +'<div class="stc-label">Re√ßu solde de tout compte</div>'
            +'<span class="badge '+(d.docs&&d.docs['stc-sign']?'badge-done':'badge-red')+'">'+(d.docs&&d.docs['stc-sign']?'‚úÖ Sign√©':'‚ö†Ô∏è Non sign√©')+'</span>'
          +'</div>'
        +'</div>'
        +'<div class="stc-total">'
          +'<div class="stc-total-label">üí∞ Total solde de tout compte</div>'
          +'<div class="stc-total-val" id="stc-total-display">'+fmtE(parseFloat(totalStc))+'</div>'
        +'</div>'
      +'</div>'
    +'</div>'
    // DOCUMENTS
    +'<div class="card">'
      +'<div class="card-head"><div class="card-title">üìé Documents de sortie</div>'
        +'<span class="badge badge-'+(docsDone===DOCS_OFFBOARDING.length?'done':'wait')+'">'+docsDone+'/'+DOCS_OFFBOARDING.length+'</span>'
      +'</div>'
      +'<div style="padding:14px">'
        +'<div class="doc-grid">'
          +DOCS_OFFBOARDING.map(function(doc){
            var ok=d.docs&&d.docs[doc.id];
            return '<div class="doc-row">'
              +'<div class="doc-name"><span class="doc-icon">'+doc.icon+'</span>'+doc.label+'</div>'
              +'<div class="doc-status">'
                +'<span class="doc-badge '+(ok?'doc-ok':'doc-missing')+'">'+(ok?'‚úÖ Sign√©':'‚ö†Ô∏è Manquant')+'</span>'
                +'<button class="doc-toggle '+(ok?'on':'off')+'" onclick="toggleDoc(\''+d.id+'\',\''+doc.id+'\',this)" title="Marquer comme fait"></button>'
              +'</div>'
            +'</div>';
          }).join('')
        +'</div>'
      +'</div>'
    +'</div>'
    // ACTIONS
    +'<div style="display:flex;justify-content:flex-end;gap:8px;padding-bottom:20px">'
      +'<button class="btn btn-ghost" onclick="archiveDossier(\''+d.id+'\')">üì¶ Archiver le dossier</button>'
      +'<button class="btn btn-off" onclick="saveProgress(\''+d.id+'\')">üíæ Tout sauvegarder</button>'
    +'</div>'
    // TEMPLATES EMAILS D√âPART
    +'<div class="card">'
      +'<div class="card-head"><div class="card-title">üìß Templates emails d√©part</div>'
        +'<span style="font-size:11px;color:var(--muted)">Envoi rapide depuis votre client mail</span>'
      +'</div>'
      +'<div style="padding:14px">'
        +'<div class="tpl-bar">'
          +'<button class="tpl-btn off-tpl" onclick="showEmailTpl(\'off-annonce\',\''+d.id+'\')">üì¢ Annonce d√©part √©quipe</button>'
          +'<button class="tpl-btn off-tpl" onclick="showEmailTpl(\'off-confirmation\',\''+d.id+'\')">üìÑ Confirmation date d√©part</button>'
          +'<button class="tpl-btn off-tpl" onclick="showEmailTpl(\'off-docs\',\''+d.id+'\')">üìé Documents disponibles</button>'
        +'</div>'
        +'<div id="email-tpl-preview-'+d.id+'" style="display:none">'
          +'<div class="email-subject" id="email-tpl-subject-'+d.id+'"></div>'
          +'<div class="email-preview" id="email-tpl-body-'+d.id+'"></div>'
          +'<div style="display:flex;gap:8px">'
            +'<button class="btn btn-off btn-sm" onclick="sendEmailTpl(\''+d.id+'\')">üì§ Ouvrir dans le client mail</button>'
            +'<button class="btn btn-ghost btn-sm" onclick="copyEmailTpl(\''+d.id+'\')">üìã Copier</button>'
          +'</div>'
        +'</div>'
      +'</div>'
    +'</div>'
    // √âVALUATION P√âRIODE D'ESSAI
    +'<div class="card">'
      +'<div class="card-head"><div class="card-title">‚≠ê √âvaluation & bilan de la p√©riode</div>'
        +'<button class="btn btn-ghost btn-xs" onclick="saveEvaluation(\''+d.id+'\')">üíæ Sauvegarder</button>'
      +'</div>'
      +'<div style="padding:16px">'
        +'<div class="pe-grid" style="margin-bottom:14px">'
          +'<div class="pe-field">'
            +'<label class="pe-label">Dur√©e dans l\'entreprise</label>'
            +'<input class="pe-input" id="pe-duree-'+d.id+'" placeholder="Ex: 2 ans 3 mois" value="'+(d.evaluation&&d.evaluation.duree?d.evaluation.duree:'')+'"/>'
          +'</div>'
          +'<div class="pe-field">'
            +'<label class="pe-label">√âvaluateur</label>'
            +'<input class="pe-input" id="pe-eval-'+d.id+'" placeholder="Pr√©nom NOM" value="'+(d.evaluation&&d.evaluation.evaluateur?d.evaluation.evaluateur:'')+'"/>'
          +'</div>'
        +'</div>'
        +'<div style="margin-bottom:12px">'
          +'<label class="pe-label">Note globale</label>'
          +'<div class="pe-stars" id="pe-stars-'+d.id+'">'
            +[1,2,3,4,5].map(function(n){
              return '<span class="pe-star'+(d.evaluation&&d.evaluation.note>=n?' lit':'')+'" data-n="'+n+'" onclick="setPeNote(\''+d.id+'\','+n+')">‚òÖ</span>';
            }).join('')
          +'</div>'
        +'</div>'
        +'<div class="pe-grid">'
          +'<div class="pe-field">'
            +'<label class="pe-label">Points forts</label>'
            +'<textarea class="pe-input" id="pe-forts-'+d.id+'" rows="3" placeholder="Comp√©tences et qualit√©s remarqu√©es...">'+(d.evaluation&&d.evaluation.forts?d.evaluation.forts:'')+'</textarea>'
          +'</div>'
          +'<div class="pe-field">'
            +'<label class="pe-label">Axes d\'am√©lioration</label>'
            +'<textarea class="pe-input" id="pe-axes-'+d.id+'" rows="3" placeholder="Points √† travailler pour l\'avenir...">'+(d.evaluation&&d.evaluation.axes?d.evaluation.axes:'')+'</textarea>'
          +'</div>'
        +'</div>'
        +'<div style="margin-top:12px"><label class="pe-label" style="margin-bottom:5px;display:block">Commentaire g√©n√©ral</label>'
          +'<textarea class="pe-input" id="pe-comment-'+d.id+'" rows="3" placeholder="Bilan g√©n√©ral du salari√©...">'+(d.evaluation&&d.evaluation.comment?d.evaluation.comment:'')+'</textarea>'
        +'</div>'
      +'</div>'
    +'</div>'
    // JOURNAL RH
    +'<div class="card">'
      +'<div class="card-head"><div class="card-title">üìì Journal RH <span style="font-size:10px;font-weight:400;color:var(--muted)">‚Äî Historique & notes de suivi</span></div></div>'
      +'<div style="padding:14px">'
        +'<div class="journal-wrap" id="journal-wrap-'+d.id+'">'
          +renderJournalEntries(d)
        +'</div>'
        +'<div class="journal-add">'
          +'<textarea class="journal-input" id="journal-input-'+d.id+'" rows="2" placeholder="Ajouter une note... (ex: Entretien de sortie effectu√©, passation termin√©e...)"></textarea>'
          +'<button class="btn btn-off btn-sm" onclick="addJournalEntry(\''+d.id+'\')">‚ûï Ajouter</button>'
        +'</div>'
      +'</div>'
    +'</div>'
    // ACTIONS FINALES
    +'<div style="display:flex;justify-content:flex-end;gap:8px;padding-bottom:20px">'
      +'<button class="btn btn-ghost" onclick="archiveDossier(\''+d.id+'\')">üì¶ Archiver le dossier</button>'
      +'<button class="btn btn-off" onclick="saveProgress(\''+d.id+'\')">üíæ Tout sauvegarder</button>'
    +'</div>';

  autoOpenActivePhase(d,'offboarding');
}

// ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ
function togglePhase(id){
  var el=document.getElementById(id);
  if(!el)return;
  el.style.display=el.style.display==='none'?'flex':'none';
}

function autoOpenActivePhase(d,type){
  var phases=type==='onboarding'?TASKS_ONBOARDING:TASKS_OFFBOARDING;
  for(var i=0;i<phases.length;i++){
    var phase=phases[i];
    var done=countPhaseDone(d,phase.tasks);
    if(done<phase.tasks.length){
      var el=document.getElementById('phase-'+d.id+'-'+phase.phase);
      if(el)el.style.display='flex';
      break;
    }
  }
}

function toggleTask(id,taskId,checked){
  if(!_dossiers[id])return;
  if(!_dossiers[id].tasks)_dossiers[id].tasks={};
  _dossiers[id].tasks[taskId]=checked;
  // Update label style
  var cb=document.querySelector('[data-id="'+id+'"][data-task="'+taskId+'"]');
  if(cb){
    var label=cb.parentElement.querySelector('.task-label');
    if(label){
      if(checked)label.classList.add('done-label');
      else label.classList.remove('done-label');
    }
  }
  // Update progress in list
  refreshProgressUI(id);
}

function toggleDoc(id,docId,btn){
  if(!_dossiers[id])return;
  if(!_dossiers[id].docs)_dossiers[id].docs={};
  var val=!_dossiers[id].docs[docId];
  _dossiers[id].docs[docId]=val;
  btn.className='doc-toggle '+(val?'on':'off');
  var badge=btn.previousElementSibling;
  if(badge){
    var type=_dossiers[id].type;
    badge.className='doc-badge '+(val?'doc-ok':'doc-missing');
    badge.textContent=val?(type==='onboarding'?'‚úÖ Re√ßu':'‚úÖ Sign√©'):'‚ö†Ô∏è Manquant';
  }
  refreshProgressUI(id);
}

function refreshProgressUI(id){
  var d=_dossiers[id];
  var pct=calcProgress(d);
  // Update in list
  var listItems=document.querySelectorAll('.dossier-item');
  listItems.forEach(function(item){
    if(item.getAttribute('onclick')&&item.getAttribute('onclick').includes("'"+id+"'")){
      var fill=item.querySelector('.prog-fill');
      var pctEl=item.querySelector('.prog-pct');
      if(fill)fill.style.width=pct+'%';
      if(pctEl)pctEl.textContent=pct+'%';
    }
  });
}

function setRating(type,n,id){
  _auditRating[type]=n;
  if(!_dossiers[id])return;
  if(!_dossiers[id].audit)_dossiers[id].audit={};
  _dossiers[id].audit[type]=n;
  document.querySelectorAll('#rating-'+type+' .rating-btn').forEach(function(btn){
    btn.classList.toggle('active',parseInt(btn.dataset.n)<=n);
  });
}

function updateStcTotal(id,congesVal){
  var inp=document.getElementById('stc-indemnites');
  var indemnites=parseFloat((inp?inp.value:0))||0;
  if(_dossiers[id])_dossiers[id].indemnites=indemnites;
  var total=congesVal+indemnites;
  var el=document.getElementById('stc-total-display');
  if(el)el.textContent=fmtE(total);
}

async function saveProgress(id){
  if(!window._uid||!_dossiers[id])return;
  var d=_dossiers[id];
  // R√©cup√©rer audit si pr√©sent
  var auditDate=document.getElementById('audit-date');
  var auditPar=document.getElementById('audit-par');
  var auditComment=document.getElementById('audit-comment');
  if(auditDate||auditPar||auditComment){
    if(!d.audit)d.audit={};
    if(auditDate)d.audit.date=auditDate.value;
    if(auditPar)d.audit.par=auditPar.value;
    if(auditComment)d.audit.comment=auditComment.value;
    if(d.audit.integration>0||d.audit.date)d.audit.done=true;
  }
  // Indemnit√©s
  var stcInp=document.getElementById('stc-indemnites');
  if(stcInp)d.indemnites=parseFloat(stcInp.value)||0;
  try{
    await window._setDoc(window._doc(window._db,'rh_onboarding',window._uid,'dossiers',id),d);
    showToast('‚úÖ Sauvegard√© !','ok');
    renderList();
  }catch(e){showToast('Erreur de sauvegarde','err');console.error(e);}
}

async function saveAudit(id){
  await saveProgress(id);
}

async function archiveDossier(id){
  if(!_dossiers[id])return;
  if(!confirm('Archiver ce dossier ?'))return;
  _dossiers[id].archived=true;
  try{
    await window._setDoc(window._doc(window._db,'rh_onboarding',window._uid,'dossiers',id),_dossiers[id]);
    _currentId=null;
    document.getElementById('right-panel').innerHTML='<div class="empty-state"><div class="empty-icon">üì¶</div><h3 style="font-size:15px;font-weight:700;color:var(--text)">Dossier archiv√©</h3></div>';
    renderList();updateCounts();
    showToast('üì¶ Dossier archiv√©','ok');
  }catch(e){showToast('Erreur','err');}
}

async function deleteDossier(id){
  if(!confirm('Supprimer d√©finitivement ce dossier ?'))return;
  try{
    await window._deleteDoc(window._doc(window._db,'rh_onboarding',window._uid,'dossiers',id));
    delete _dossiers[id];
    _currentId=null;
    document.getElementById('right-panel').innerHTML='<div class="empty-state"><div class="empty-icon">üóë</div><h3 style="font-size:15px;font-weight:700;color:var(--text)">Dossier supprim√©</h3></div>';
    renderList();updateCounts();
    showToast('Dossier supprim√©');
  }catch(e){showToast('Erreur','err');}
}

// ‚îÄ‚îÄ CREATE ‚îÄ‚îÄ
async function createDossier(type){
  var id='doss_'+Date.now();
  var d={};
  if(type==='onboarding'){
    var prenom=document.getElementById('on-prenom').value.trim();
    var nom=document.getElementById('on-nom').value.trim();
    if(!prenom||!nom){document.getElementById('on-prenom').focus();return;}
    d={id,type:'onboarding',prenom,nom,
      poste:document.getElementById('on-poste').value,
      contrat:document.getElementById('on-contrat').value,
      dateJ:document.getElementById('on-date').value,
      resp:document.getElementById('on-resp').value,
      email:document.getElementById('on-email').value,
      notes:document.getElementById('on-notes').value,
      tasks:{},docs:{},audit:{},archived:false,createdAt:new Date().toISOString()
    };
    closeModal('modal-on');
    clearModalOn();
    // ‚îÄ‚îÄ Cr√©ation automatique de la fiche employ√© ‚îÄ‚îÄ
    await createEmployeFromOnboarding(d, id);
  } else {
    var prenom=document.getElementById('off-prenom').value.trim();
    var nom=document.getElementById('off-nom').value.trim();
    if(!prenom||!nom){document.getElementById('off-prenom').focus();return;}
    d={id,type:'offboarding',prenom,nom,
      poste:document.getElementById('off-poste').value,
      motif:document.getElementById('off-motif').value,
      dateJ:document.getElementById('off-date').value,
      preavis:document.getElementById('off-preavis').value,
      conges:document.getElementById('off-conges').value,
      salaire:document.getElementById('off-salaire').value,
      notes:document.getElementById('off-notes').value,
      tasks:{},docs:{},indemnites:0,archived:false,createdAt:new Date().toISOString()
    };
    closeModal('modal-off');
    clearModalOff();
  }
  _dossiers[id]=d;
  try{
    await window._setDoc(window._doc(window._db,'rh_onboarding',window._uid,'dossiers',id),d);
    showToast('‚úÖ Dossier cr√©√© !','ok');
  }catch(e){showToast('Erreur de sauvegarde','err');console.error(e);}
  var tab=type==='onboarding'?'onboarding':'offboarding';
  if(_currentTab!==tab)switchTab(tab,document.querySelector('[data-tab="'+tab+'"]'));
  else renderList();
  updateCounts();
  openDossier(id);
}

// ‚îÄ‚îÄ CR√âATION AUTOMATIQUE FICHE EMPLOY√â ‚îÄ‚îÄ
async function createEmployeFromOnboarding(dossier, dossierId){
  if(!window._uid) return;
  var empId = 'emp_' + Date.now();
  var publicId = 'emp_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36);

  // Couleurs pour l'avatar (rotation)
  var colors=['#059669','#0ea5e9','#6366f1','#f59e0b','#ec4899','#14b8a6','#8b5cf6','#ef4444'];
  var couleur = colors[Math.floor(Math.random()*colors.length)];

  var empData={
    prenom: dossier.prenom,
    nom: dossier.nom,
    poste: dossier.poste||null,
    email: dossier.email||null,
    typeContrat: dossier.contrat||'CDI',
    dateEntree: dossier.dateJ||null,
    heuresHebdo: 35,
    frequence: 'mensuel',
    categoriePoste: 'employe',
    statut: 'actif',
    couleur: couleur,
    publicId: publicId,
    onboardingId: dossierId,   // lien retour vers le dossier onboarding
    periodeEssai: {active:false},
    documents: [],
    evaluations: [],
    createdAt: Date.now(),
    updatedAt: Date.now(),
    // Champs vides √† compl√©ter plus tard
    dateNaissance: null, nationalite: null, adresse: null,
    telephone: null, nss: null, departement: null,
    dateFinContrat: null, salaireBrut: null, salaireNet: null,
    salaireSuperBrut: null, iban: null, ccn: null,
    photoURL: null, noteMoyenne: null
  };

  var publicData={
    uid: window._uid,
    empId: empId,
    prenom: dossier.prenom||'',
    nom: dossier.nom||'',
    poste: dossier.poste||'',
    departement: '',
    typeContrat: dossier.contrat||'CDI',
    couleur: couleur,
    dateEntree: dossier.dateJ||'',
    cpAjustAcquis: 0,
    rttAjust: 0,
    recupHeures: 0
  };

  try{
    await window._setDoc(window._doc(window._db,'rh',window._uid,'employes',empId), empData);
    await window._setDoc(window._doc(window._db,'rh_employes_public',publicId), publicData);
    // Stocker l'empId dans le dossier pour lien retour
    _dossiers[dossierId].empId = empId;
    await window._setDoc(window._doc(window._db,'rh_onboarding',window._uid,'dossiers',dossierId), {empId: empId},{merge:true});
    showToast('üë§ Fiche employ√© cr√©√©e automatiquement','ok');
  }catch(e){
    console.error('Erreur cr√©ation employ√©:',e);
    showToast('‚ö†Ô∏è Dossier cr√©√©, fiche employ√© √† cr√©er manuellement','warn');
  }
}

// ‚îÄ‚îÄ CALCULS ‚îÄ‚îÄ
function calcProgress(d){
  var type=d.type;
  var allTasks=type==='onboarding'?TASKS_ONBOARDING:TASKS_OFFBOARDING;
  var total=0,done=0;
  allTasks.forEach(function(phase){
    phase.tasks.forEach(function(t){
      total++;
      if(d.tasks&&d.tasks[t.id])done++;
    });
  });
  var allDocs=type==='onboarding'?DOCS_ONBOARDING:DOCS_OFFBOARDING;
  allDocs.forEach(function(doc){
    total++;
    if(d.docs&&d.docs[doc.id])done++;
  });
  return total>0?Math.round(done/total*100):0;
}

function countDone(d){
  var tasks=d.tasks||{};
  return Object.values(tasks).filter(Boolean).length;
}

function countTotal(type){
  var allTasks=type==='onboarding'?TASKS_ONBOARDING:TASKS_OFFBOARDING;
  return allTasks.reduce(function(s,p){return s+p.tasks.length;},0);
}

function countDocsDone(d,type){
  var allDocs=type==='onboarding'?DOCS_ONBOARDING:DOCS_OFFBOARDING;
  return allDocs.filter(function(doc){return d.docs&&d.docs[doc.id];}).length;
}

function countPhaseDone(d,tasks){
  return tasks.filter(function(t){return d.tasks&&d.tasks[t.id];}).length;
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function initials(p,n){return((p||'').charAt(0)+(n||'').charAt(0)).toUpperCase();}
function formatDate(s){
  if(!s)return'‚Äî';
  var d=new Date(s);
  return d.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric'});
}
function daysUntil(dateStr){
  if(!dateStr)return999;
  var d=new Date(dateStr);d.setHours(0,0,0,0);
  var now=new Date();now.setHours(0,0,0,0);
  return Math.round((d-now)/(1000*60*60*24));
}
function fmtE(n){return (parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨';}
function labelMotif(m){
  return{demission:'D√©mission',rupture:'Rupture conventionnelle',licenciement:'Licenciement',
    'fin-cdd':'Fin de CDD',retraite:'D√©part en retraite',autre:'Autre'}[m]||m||'‚Äî';
}
function renderInfoField(label,val,fallback){
  var missing=!val;
  return '<div class="info-field"><div class="info-label">'+label+'</div><div class="info-val'+(missing?' info-missing':'')+'">'+(val||fallback||'‚Äî')+'</div></div>';
}

function switchTab(name,btn){
  _currentTab=name;
  _currentId=null;
  document.querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('on');});
  if(btn)btn.classList.add('on');
  document.getElementById('right-panel').innerHTML='<div class="empty-state"><div class="empty-icon">'+(name==='archives'?'üì¶':name==='onboarding'?'üéâ':'üö™')+'</div><h3 style="font-size:16px;font-weight:700;color:var(--text)">S√©lectionnez un dossier</h3></div>';
  var listBtn=document.querySelector('.card-head .btn-rh');
  if(listBtn)listBtn.style.display=name==='archives'?'none':'';
  renderList();
}

function openModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}

function clearModalOn(){
  ['on-prenom','on-nom','on-poste','on-resp','on-email','on-notes'].forEach(function(f){var el=document.getElementById(f);if(el)el.value='';});
  var d=document.getElementById('on-date');if(d)d.value='';
}
function clearModalOff(){
  ['off-prenom','off-nom','off-poste','off-preavis','off-conges','off-salaire','off-notes'].forEach(function(f){var el=document.getElementById(f);if(el)el.value='';});
  var d=document.getElementById('off-date');if(d)d.value='';
}

function showToast(msg,type){
  var t=document.getElementById('toast');
  t.textContent=msg;t.className='toast show '+(type||'');
  setTimeout(function(){t.className='toast';},3000);
}

// ‚îÄ‚îÄ PORTAIL SALARI√â ‚îÄ‚îÄ
var _portailLinks = {}; // cache publicId ‚Üí url

async function loadPortailLink(d){
  if(!d.empId) return;
  try{
    var snap = await window._getDoc(window._doc(window._db,'rh',window._uid,'employes',d.empId));
    if(snap.exists()){
      var empData = snap.data();
      var publicId = empData.publicId;
      if(publicId){
        _portailLinks[d.id] = publicId;
        var url = window.location.origin+'/portail-salarie.html?id='+publicId;
        var el = document.getElementById('portail-url-'+d.id);
        if(el) el.textContent = url;
      }
    }
  }catch(e){console.warn('loadPortailLink:',e);}
}

function getPortailUrl(id){
  var pid = _portailLinks[id];
  if(!pid) return null;
  return window.location.origin+'/portail-salarie.html?id='+pid;
}

function copyPortailLink(id){
  var url = getPortailUrl(id);
  if(!url){showToast('‚ö†Ô∏è Lien non disponible ‚Äî fiche employ√© non cr√©√©e','warn');return;}
  navigator.clipboard.writeText(url).then(function(){
    showToast('‚úÖ Lien copi√© dans le presse-papier !','ok');
  }).catch(function(){
    showToast('‚ö†Ô∏è Impossible de copier ‚Äî copiez manuellement','warn');
  });
}

function openPortailLink(id){
  var url = getPortailUrl(id);
  if(!url){showToast('‚ö†Ô∏è Lien non disponible','warn');return;}
  window.open(url,'_blank');
}

function sendPortailEmail(id){
  var d = _dossiers[id];
  if(!d) return;
  var url = getPortailUrl(id);
  if(!url){showToast('‚ö†Ô∏è Lien non disponible ‚Äî fiche employ√© non cr√©√©e','warn');return;}
  var sujet = encodeURIComponent('üîó Votre acc√®s portail salari√© ‚Äî ALTEORE RH');
  var corps = encodeURIComponent(
    'Bonjour '+d.prenom+',\n\n'+
    'Bienvenue dans notre √©quipe ! üéâ\n\n'+
    'Pour compl√©ter votre dossier salari√©, merci d\'acc√©der √† votre portail personnel via ce lien :\n\n'+
    url+'\n\n'+
    'Vous pourrez y renseigner :\n'+
    '‚Ä¢ Vos coordonn√©es et informations personnelles\n'+
    '‚Ä¢ Votre RIB pour le virement de salaire\n'+
    '‚Ä¢ Vos documents administratifs\n\n'+
    'En cas de questions, n\'h√©sitez pas √† nous contacter.\n\n'+
    'Bien cordialement,\n'+
    (d.resp||'Votre responsable RH')
  );
  var email = d.email||'';
  window.location.href = 'mailto:'+email+'?subject='+sujet+'&body='+corps;
}

// ‚îÄ‚îÄ CR√âER FICHE EMPLOY√â DEPUIS BOUTON ‚îÄ‚îÄ
async function createEmployeBtn(id){
  var d = _dossiers[id];
  if(!d||d.empId) return;
  await createEmployeFromOnboarding(d,id);
  openDossier(id); // re-render pour afficher la banni√®re
}

// ‚îÄ‚îÄ JOURNAL RH ‚îÄ‚îÄ
function renderJournalEntries(d){
  var entries = d.journal||[];
  if(entries.length===0) return '<div class="journal-empty">üìù Aucune note pour l\'instant. Ajoutez une note pour garder un suivi.</div>';
  return entries.slice().reverse().map(function(e){
    return '<div class="journal-entry">'
      +'<div class="journal-dot"></div>'
      +'<div class="journal-body">'
        +'<div class="journal-meta">'
          +'<span>üìÖ '+formatDate(e.date)+'</span>'
          +(e.author?'<span>¬∑ '+e.author+'</span>':'')
        +'</div>'
        +'<div class="journal-text">'+e.text+'</div>'
      +'</div>'
    +'</div>';
  }).join('');
}

async function addJournalEntry(id){
  var d = _dossiers[id];
  if(!d) return;
  var inp = document.getElementById('journal-input-'+id);
  if(!inp||!inp.value.trim()) return;
  if(!d.journal) d.journal=[];
  d.journal.push({
    text: inp.value.trim(),
    date: new Date().toISOString().split('T')[0],
    author: window._authDisplayName||'RH',
    ts: Date.now()
  });
  inp.value='';
  var wrap = document.getElementById('journal-wrap-'+id);
  if(wrap) wrap.innerHTML = renderJournalEntries(d);
  try{
    await window._setDoc(window._doc(window._db,'rh_onboarding',window._uid,'dossiers',id),{journal:d.journal},{merge:true});
    showToast('‚úÖ Note ajout√©e','ok');
  }catch(e){showToast('Erreur sauvegarde','err');}
}

// ‚îÄ‚îÄ OBJECTIFS ‚îÄ‚îÄ
async function saveObjectifs(id){
  var d = _dossiers[id];
  if(!d) return;
  d.objectifs = {
    m1: (document.getElementById('obj-m1-'+id)||{}).value||'',
    m3: (document.getElementById('obj-m3-'+id)||{}).value||'',
    m6: (document.getElementById('obj-m6-'+id)||{}).value||''
  };
  try{
    await window._setDoc(window._doc(window._db,'rh_onboarding',window._uid,'dossiers',id),{objectifs:d.objectifs},{merge:true});
    showToast('‚úÖ Objectifs sauvegard√©s','ok');
  }catch(e){showToast('Erreur','err');}
}

// ‚îÄ‚îÄ √âVALUATION P√âRIODE (offboarding) ‚îÄ‚îÄ
function setPeNote(id,n){
  var d = _dossiers[id];
  if(!d) return;
  if(!d.evaluation) d.evaluation={};
  d.evaluation.note = n;
  document.querySelectorAll('#pe-stars-'+id+' .pe-star').forEach(function(s){
    s.classList.toggle('lit',parseInt(s.dataset.n)<=n);
  });
}

async function saveEvaluation(id){
  var d = _dossiers[id];
  if(!d) return;
  if(!d.evaluation) d.evaluation={};
  d.evaluation.duree = (document.getElementById('pe-duree-'+id)||{}).value||'';
  d.evaluation.evaluateur = (document.getElementById('pe-eval-'+id)||{}).value||'';
  d.evaluation.forts = (document.getElementById('pe-forts-'+id)||{}).value||'';
  d.evaluation.axes = (document.getElementById('pe-axes-'+id)||{}).value||'';
  d.evaluation.comment = (document.getElementById('pe-comment-'+id)||{}).value||'';
  try{
    await window._setDoc(window._doc(window._db,'rh_onboarding',window._uid,'dossiers',id),{evaluation:d.evaluation},{merge:true});
    showToast('‚úÖ √âvaluation sauvegard√©e','ok');
  }catch(e){showToast('Erreur','err');}
}

// ‚îÄ‚îÄ EMAIL TEMPLATES ‚îÄ‚îÄ
var _emailTplCurrent = {subject:'',body:''};

function showEmailTpl(tpl, id){
  var d = _dossiers[id];
  if(!d) return;
  var nom = d.prenom+' '+d.nom;
  var poste = d.poste||'votre poste';
  var dateJ = d.dateJ?formatDate(d.dateJ):'‚Äî';
  var url = getPortailUrl(id)||'[lien portail non disponible - cr√©ez d\'abord la fiche employ√©]';
  var missingDocs = DOCS_ONBOARDING.filter(function(doc){return !d.docs||!d.docs[doc.id];});
  var resp = d.resp||'votre responsable';

  var tpls = {
    bienvenue:{
      subject:'üéâ Bienvenue chez nous, '+d.prenom+' !',
      body:'Bonjour '+d.prenom+',\n\n'
        +'Nous sommes ravis de vous accueillir dans notre √©quipe le '+dateJ+' en tant que '+poste+' !\n\n'
        +'üìÖ Votre premier jour :\n'
        +'‚Ä¢ Heure d\'arriv√©e : [√Ä pr√©ciser]\n'
        +'‚Ä¢ Lieu : [Adresse de l\'entreprise]\n'
        +'‚Ä¢ Votre r√©f√©rent : '+resp+'\n\n'
        +'üìé Documents √† apporter :\n'
        +'‚Ä¢ Pi√®ce d\'identit√© originale\n'
        +'‚Ä¢ RIB (pour le virement de salaire)\n'
        +'‚Ä¢ Carte Vitale\n\n'
        +'N\'h√©sitez pas √† nous contacter pour toute question.\n\n'
        +'√Ä tr√®s bient√¥t !\n\n'+resp
    },
    docs:{
      subject:'üìé Documents manquants ‚Äî Dossier d\'entr√©e '+nom,
      body:'Bonjour '+d.prenom+',\n\n'
        +'Votre dossier d\'entr√©e est en cours de constitution. Il nous manque encore les documents suivants :\n\n'
        +missingDocs.map(function(doc){return '‚Ä¢ '+doc.icon+' '+doc.label;}).join('\n')
        +'\n\nMerci de nous les transmettre d√®s que possible, avant votre arriv√©e le '+dateJ+'.\n\n'
        +'Vous pouvez √©galement les d√©poser directement sur votre portail salari√© :\n'+url+'\n\n'
        +'Cordialement,\n'+resp
    },
    j1:{
      subject:'üóì Rappel ‚Äî Votre arriv√©e demain, '+d.prenom+' !',
      body:'Bonjour '+d.prenom+',\n\n'
        +'Nous vous rappelons que votre premier jour est demain, le '+dateJ+' !\n\n'
        +'üìç Rendez-vous √† : [Adresse] √† [Heure]\n'
        +'üë§ Votre r√©f√©rent : '+resp+'\n\n'
        +'N\'oubliez pas d\'apporter :\n'
        +'‚Ä¢ Vos pi√®ces d\'identit√©\n'
        +'‚Ä¢ Votre RIB\n\n'
        +'Nous avons h√¢te de vous accueillir ! üéâ\n\n'+resp
    },
    portail:{
      subject:'üîó Votre acc√®s portail salari√©',
      body:'Bonjour '+d.prenom+',\n\n'
        +'Votre acc√®s au portail salari√© est disponible. Vous pouvez y compl√©ter vos informations personnelles et administratives :\n\n'
        +url+'\n\n'
        +'Sur ce portail, vous pouvez :\n'
        +'‚Ä¢ Renseigner vos coordonn√©es\n'
        +'‚Ä¢ Ajouter votre RIB\n'
        +'‚Ä¢ Consulter vos documents\n'
        +'‚Ä¢ G√©rer vos cong√©s\n\n'
        +'Cordialement,\n'+resp
    },
    'off-annonce':{
      subject:'üì¢ D√©part de '+nom+' ‚Äî Information √©quipe',
      body:'Bonjour √† tous,\n\n'
        +'Nous vous informons que '+nom+', '+poste+', quittera nos √©quipes le '+dateJ+'.\n\n'
        +'Nous remercions '+d.prenom+' pour sa contribution et lui souhaitons le meilleur pour la suite de sa carri√®re.\n\n'
        +'La passation des dossiers est en cours. Nous vous communiquerons prochainement l\'organisation mise en place.\n\n'
        +'Cordialement,\n'+resp
    },
    'off-confirmation':{
      subject:'üìÑ Confirmation de votre date de d√©part',
      body:'Bonjour '+d.prenom+',\n\n'
        +'Nous confirmons votre date de d√©part definitif au '+dateJ+'.\n\n'
        +(d.preavis?'Votre pr√©avis est de '+d.preavis+' jours.\n\n':'')
        +'Nous vous remettrons lors de votre dernier jour :\n'
        +'‚Ä¢ Votre certificat de travail\n'
        +'‚Ä¢ Votre attestation P√¥le Emploi / France Travail\n'
        +'‚Ä¢ Votre re√ßu pour solde de tout compte\n\n'
        +'Merci de finaliser la passation de vos dossiers d\'ici cette date.\n\n'
        +'Cordialement,\n'+resp
    },
    'off-docs':{
      subject:'üìé Vos documents de fin de contrat sont pr√™ts',
      body:'Bonjour '+d.prenom+',\n\n'
        +'Vos documents de fin de contrat sont pr√™ts et vous seront remis lors de votre dernier jour :\n\n'
        +'‚Ä¢ ‚úÖ Certificat de travail\n'
        +'‚Ä¢ ‚úÖ Attestation P√¥le Emploi / France Travail\n'
        +'‚Ä¢ ‚úÖ Re√ßu pour solde de tout compte\n\n'
        +'Ces documents devront √™tre sign√©s en 2 exemplaires lors de votre dernier jour le '+dateJ+'.\n\n'
        +'Cordialement,\n'+resp
    }
  };

  var t = tpls[tpl];
  if(!t) return;
  _emailTplCurrent = {id:id,email:d.email||'',subject:t.subject,body:t.body};

  var preview = document.getElementById('email-tpl-preview-'+id);
  var subjectEl = document.getElementById('email-tpl-subject-'+id);
  var bodyEl = document.getElementById('email-tpl-body-'+id);
  if(preview) preview.style.display='block';
  if(subjectEl) subjectEl.textContent = 'üì® Objet : '+t.subject;
  if(bodyEl) bodyEl.textContent = t.body;
}

function sendEmailTpl(id){
  if(!_emailTplCurrent.body) return;
  var href = 'mailto:'+(_emailTplCurrent.email||'')
    +'?subject='+encodeURIComponent(_emailTplCurrent.subject)
    +'&body='+encodeURIComponent(_emailTplCurrent.body);
  window.location.href = href;
}

function copyEmailTpl(id){
  if(!_emailTplCurrent.body){showToast('S√©lectionnez d\'abord un template','warn');return;}
  navigator.clipboard.writeText(_emailTplCurrent.body).then(function(){
    showToast('‚úÖ Corps de l\'email copi√© !','ok');
  });
}

// ‚îÄ‚îÄ CONTACT URGENCE ‚îÄ‚îÄ
function addContactUrgence(id){
  var d = _dossiers[id];
  if(!d) return;
  var nom = prompt('Nom du contact d\'urgence :');
  if(!nom) return;
  var lien = prompt('Lien (ex: Conjoint, Parent) :');
  var tel = prompt('T√©l√©phone :');
  d.contactUrgenceNom = nom;
  d.contactUrgenceLien = lien||'';
  d.contactUrgenceTel = tel||'';
  // Re-render
  openDossier(id);
  // Auto-save
  window._setDoc(window._doc(window._db,'rh_onboarding',window._uid,'dossiers',id),
    {contactUrgenceNom:nom,contactUrgenceLien:lien||'',contactUrgenceTel:tel||''},
    {merge:true}
  ).catch(function(e){console.warn(e);});
}

// Expose
window.switchTab=switchTab;window.openModal=openModal;window.closeModal=closeModal;
window.createDossier=createDossier;window.openDossier=openDossier;
window.togglePhase=togglePhase;window.toggleTask=toggleTask;window.toggleDoc=toggleDoc;
window.saveProgress=saveProgress;window.saveAudit=saveAudit;window.archiveDossier=archiveDossier;window.deleteDossier=deleteDossier;
window.setRating=setRating;window.updateStcTotal=updateStcTotal;
window.copyPortailLink=copyPortailLink;window.openPortailLink=openPortailLink;window.sendPortailEmail=sendPortailEmail;
window.addJournalEntry=addJournalEntry;window.saveObjectifs=saveObjectifs;
window.setPeNote=setPeNote;window.saveEvaluation=saveEvaluation;
window.showEmailTpl=showEmailTpl;window.sendEmailTpl=sendEmailTpl;window.copyEmailTpl=copyEmailTpl;
window.createEmployeBtn=createEmployeBtn;window.addContactUrgence=addContactUrgence;
</script>

<script src="nav.js"></script>
</body>
</html>
