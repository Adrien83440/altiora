<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <title>ALTEORE ‚Äî Paie & Salaires</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --rh-dark:#052e16;--rh-main:#059669;--rh-light:#10b981;--rh-bright:#34d399;
      --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f0fdf7;--radius:12px;
      --red:#ef4444;--red-light:#fee2e2;--orange:#f59e0b;--orange-light:#fef3c7;
      --blue:#1a3dce;--purple:#6366f1;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}
    .main{margin-left:250px;flex:1;display:flex;flex-direction:column;min-width:0;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:17px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .topbar-left p{font-size:12px;color:var(--muted);margin-top:2px;}
    .topbar-right{display:flex;align-items:center;gap:10px;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;display:flex;align-items:center;gap:6px;}
    .btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-light));color:white;box-shadow:0 3px 10px rgba(5,150,105,.3);}
    .btn-rh:hover{opacity:.9;transform:translateY(-1px);}
    .btn-outline{background:white;color:var(--rh-main);border:1.5px solid var(--rh-border);}
    .btn-outline:hover{background:var(--rh-ghost);}
    .btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}
    .btn-sm{padding:6px 12px;font-size:12px;}
    .btn-xs{padding:3px 9px;font-size:11px;}

    /* MOIS BAR */
    .mois-bar{background:white;border-bottom:1px solid var(--border);padding:10px 28px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
    .mois-nav{display:flex;align-items:center;gap:8px;}
    .mois-nav button{width:30px;height:30px;border:1.5px solid var(--border);background:white;border-radius:8px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
    .mois-nav button:hover{border-color:var(--rh-main);background:var(--rh-ghost);}
    .mois-label{font-size:14px;font-weight:700;min-width:130px;text-align:center;}
    .mois-today{padding:4px 12px;background:var(--rh-ghost);color:var(--rh-main);border:1px solid var(--rh-border);border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;}
    .mois-stats{display:flex;gap:14px;margin-left:auto;flex-wrap:wrap;}
    .mois-stat{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:5px;}
    .mois-stat strong{color:var(--text);font-weight:700;}
    .dot{width:7px;height:7px;border-radius:50%;}

    .content{padding:22px 28px;flex:1;display:flex;flex-direction:column;gap:20px;}

    /* KPI ROW */
    .kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
    .kpi-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;position:relative;overflow:hidden;}
    .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--rh-main),var(--rh-bright));}
    .kpi-card.orange::before{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
    .kpi-card.red::before{background:linear-gradient(90deg,#ef4444,#f87171);}
    .kpi-card.purple::before{background:linear-gradient(90deg,#6366f1,#a5b4fc);}
    .kpi-card.blue::before{background:linear-gradient(90deg,#1a3dce,#4f7ef8);}
    .kpi-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;}
    .kpi-val{font-size:20px;font-weight:800;color:var(--text);}
    .kpi-val.green{color:var(--rh-main);}
    .kpi-val.orange{color:var(--orange);}
    .kpi-val.red{color:var(--red);}
    .kpi-sub{font-size:10px;color:var(--muted);margin-top:3px;}

    /* TABLE */
    .table-card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .table-head{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);}
    .table-title{font-size:13px;font-weight:700;}
    .table-wrap{overflow-x:auto;}
    table{width:100%;border-collapse:collapse;font-size:12px;}
    thead th{padding:9px 14px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;background:#f8faff;border-bottom:1px solid var(--border);white-space:nowrap;}
    thead th:not(:first-child){text-align:right;}
    tbody td{padding:10px 14px;border-bottom:1px solid #f1f5f9;vertical-align:middle;}
    tbody td:not(:first-child){text-align:right;font-weight:600;}
    tbody tr:last-child td{border-bottom:none;}
    tbody tr:hover{background:#fafbff;}
    .emp-cell{display:flex;align-items:center;gap:10px;}
    .emp-avatar{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--rh-main),var(--rh-bright));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
    .emp-name{font-size:12px;font-weight:700;}
    .emp-poste{font-size:10px;color:var(--muted);}
    .badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;}
    .badge-green{background:var(--rh-ghost);color:var(--rh-main);}
    .badge-orange{background:#fef3c7;color:#92400e;}
    .badge-red{background:#fee2e2;color:#991b1b;}
    .badge-gray{background:#f1f5f9;color:var(--muted);}
    .badge-blue{background:#eff6ff;color:#1d4ed8;}
    .source-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:4px;}
    .source-planning{background:#f0fdf4;color:#059669;}
    .source-manuel{background:#eff6ff;color:#1d4ed8;}

    /* STATUS VALID√â */
    .td-pos{color:var(--rh-main);}
    .td-neg{color:var(--red);}
    .td-muted{color:var(--muted);font-weight:400!important;}

    /* ACTIONS COLONNE */
    .row-actions{display:flex;align-items:center;justify-content:flex-end;gap:6px;}
    .action-btn{padding:4px 10px;border-radius:6px;border:none;cursor:pointer;font-size:11px;font-weight:600;font-family:'Plus Jakarta Sans',sans-serif;transition:all .15s;}
    .action-btn.edit{background:#f0fdf4;color:var(--rh-main);}
    .action-btn.edit:hover{background:var(--rh-border);}
    .action-btn.pdf{background:#eff6ff;color:var(--blue);}
    .action-btn.pdf:hover{background:#dbeafe;}
    .action-btn.valid{background:#f0fdf4;color:var(--rh-main);border:1px solid var(--rh-border);}
    .action-btn.valid.done{background:#dcfce7;color:#166534;}

    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(5,46,22,.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;width:100%;max-width:700px;box-shadow:0 24px 60px rgba(5,46,22,.2);overflow:hidden;max-height:92vh;display:flex;flex-direction:column;}
    .modal-head{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
    .modal-head h3{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);}
    .modal-body{padding:20px 24px;overflow-y:auto;flex:1;}
    .modal-foot{padding:14px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;flex-shrink:0;}

    /* FICHE PAIE VISUELLE */
    .fiche-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;}
    .fiche-section{background:#f8faff;border:1px solid var(--border);border-radius:10px;padding:14px;}
    .fiche-section-title{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;display:flex;align-items:center;gap:6px;}
    .fiche-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border);}
    .fiche-row:last-child{border-bottom:none;}
    .fiche-row.total{font-weight:800;font-size:13px;padding-top:8px;border-top:2px solid var(--border);border-bottom:none;margin-top:4px;}
    .fiche-label{font-size:12px;color:var(--text);}
    .fiche-val{font-size:12px;font-weight:700;}
    .fiche-val.green{color:var(--rh-main);}
    .fiche-val.red{color:var(--red);}
    .fiche-val.muted{color:var(--muted);font-weight:400;}

    /* IMPORT PLANNING BANNER */
    .import-banner{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border:1px solid var(--rh-border);border-radius:10px;padding:12px 16px;display:flex;align-items:center;gap:12px;margin-bottom:14px;}
    .import-banner-icon{font-size:22px;}
    .import-banner-text{flex:1;font-size:12px;color:var(--rh-dark);}
    .import-banner-text strong{font-weight:700;}

    /* HEURES SECTION */
    .heures-section{background:linear-gradient(135deg,#1e293b,#0f172a);border-radius:12px;padding:18px;margin-bottom:14px;color:white;}
    .heures-title{font-size:11px;font-weight:600;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;}
    .heures-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
    .h-box{text-align:center;}
    .h-box-label{font-size:9px;color:rgba(255,255,255,.4);text-transform:uppercase;font-weight:600;margin-bottom:4px;}
    .h-box-val{font-size:18px;font-weight:800;}
    .h-box-val.green{color:#34d399;}
    .h-box-val.orange{color:#fbbf24;}
    .h-box-val.blue{color:#60a5fa;}
    .h-box-sub{font-size:10px;color:rgba(255,255,255,.3);margin-top:2px;}

    /* COTISATIONS TABLE */
    .cot-table{width:100%;border-collapse:collapse;font-size:11.5px;}
    .cot-table thead th{padding:7px 10px;background:#f8faff;border-bottom:1px solid var(--border);font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;}
    .cot-table thead th:not(:first-child){text-align:right;}
    .cot-table tbody td{padding:6px 10px;border-bottom:1px solid #f1f5f9;}
    .cot-table tbody td:not(:first-child){text-align:right;font-weight:600;}
    .cot-table tfoot td{padding:8px 10px;font-weight:800;font-size:12px;border-top:2px solid var(--border);}
    .cot-table tfoot td:not(:first-child){text-align:right;}
    .cot-cat{font-size:10px;font-weight:700;color:var(--muted);padding:8px 10px 3px;text-transform:uppercase;letter-spacing:.5px;border-bottom:none!important;}

    /* R√âSULTAT NET */
    .net-result{background:linear-gradient(135deg,var(--rh-main),#059669);border-radius:12px;padding:18px 24px;color:white;display:flex;align-items:center;justify-content:space-between;margin-top:14px;}
    .net-result-label{font-size:12px;font-weight:600;opacity:.8;}
    .net-result-val{font-size:28px;font-weight:800;}
    .net-result-sub{font-size:11px;opacity:.7;margin-top:2px;}

    /* INPUTS MODAL */
    .field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
    .field-row.triple{grid-template-columns:1fr 1fr 1fr;}
    .field-row.full{grid-template-columns:1fr;}
    .field{display:flex;flex-direction:column;gap:4px;}
    .field label{font-size:11px;font-weight:600;color:var(--muted);}
    .field input,.field select{padding:8px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;color:var(--text);outline:none;background:white;}
    .field input:focus,.field select:focus{border-color:var(--rh-main);}
    .field input[readonly]{background:#f8faff;color:var(--muted);}
    .field-hint{font-size:10px;color:var(--muted);margin-top:2px;}

    /* R√âCAPITULATIF TOTAL */
    .recap-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px 24px;}
    .recap-title{font-size:13px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
    .recap-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
    .recap-box{background:#f8faff;border-radius:10px;padding:14px;text-align:center;}
    .recap-box-label{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;margin-bottom:6px;}
    .recap-box-val{font-size:16px;font-weight:800;}

    /* LOADER */
    .loader{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--muted);gap:10px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--rh-main);border-radius:50%;animation:spin .7s linear infinite;}

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.ok{background:var(--rh-main);}
    .toast.err{background:var(--red);}
    .toast.warn{background:var(--orange);}

    /* HAMBURGER MOBILE */
    .hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:var(--rh-main);border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(5,150,105,.45);}
    .hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;}
    .nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;}
    .nav-overlay.show{display:block;}

    /* PDF PREVIEW */
    .pdf-preview{background:#fff;border:1px solid var(--border);border-radius:12px;padding:28px 32px;font-size:12px;color:#1a1f36;max-width:600px;margin:0 auto;}
    .pdf-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--rh-main);}
    .pdf-company{font-size:16px;font-weight:800;color:var(--rh-dark);}
    .pdf-period{font-size:11px;color:var(--muted);margin-top:3px;}
    .pdf-emp-block{background:#f8faff;border-radius:8px;padding:12px 16px;margin-bottom:16px;}
    .pdf-emp-name{font-size:14px;font-weight:800;}
    .pdf-emp-details{font-size:11px;color:var(--muted);margin-top:2px;}
    .pdf-table{width:100%;border-collapse:collapse;margin-bottom:12px;}
    .pdf-table th{background:#f1f5f9;padding:7px 10px;font-size:10px;font-weight:700;text-transform:uppercase;color:var(--muted);}
    .pdf-table th:not(:first-child){text-align:right;}
    .pdf-table td{padding:6px 10px;border-bottom:1px solid #f1f5f9;font-size:11.5px;}
    .pdf-table td:not(:first-child){text-align:right;}
    .pdf-table .section-head td{background:#fafafa;font-weight:700;font-size:10px;color:var(--muted);text-transform:uppercase;padding:8px 10px;}
    .pdf-total-row{background:#f0fdf4;}
    .pdf-total-row td{font-weight:800;border-top:2px solid var(--rh-border)!important;padding:9px 10px;}
    .pdf-net-box{background:linear-gradient(135deg,var(--rh-main),var(--rh-light));border-radius:10px;padding:14px 18px;color:white;display:flex;justify-content:space-between;align-items:center;margin-top:12px;}
    .pdf-net-label{font-size:11px;opacity:.85;}
    .pdf-net-val{font-size:22px;font-weight:800;}
    .pdf-footer{margin-top:16px;padding-top:12px;border-top:1px solid var(--border);font-size:10px;color:var(--muted);text-align:center;}

    /* EMPTY */
    .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;text-align:center;color:var(--muted);padding:40px;}
    .empty-icon{font-size:48px;margin-bottom:12px;}

    /* RESPONSIVE */
    @media(max-width:768px){
      .hamburger{display:flex!important;}
      .main{margin-left:0!important;width:100vw!important;}
      .topbar{padding:10px 10px 10px 62px!important;}
      .content{padding:12px 10px!important;}
      .kpi-row{grid-template-columns:1fr 1fr!important;gap:8px!important;}
      .fiche-grid{grid-template-columns:1fr!important;}
      .heures-grid{grid-template-columns:1fr 1fr!important;}
      .recap-grid{grid-template-columns:1fr 1fr!important;}
      .field-row{grid-template-columns:1fr!important;}
      .field-row.triple{grid-template-columns:1fr!important;}
      .modal{width:100%!important;max-width:100%!important;border-radius:18px 18px 0 0!important;max-height:92vh!important;}
      .modal-overlay{align-items:flex-end!important;}
      input,select{font-size:16px!important;}
    }
    @media(max-width:420px){
      .kpi-row{grid-template-columns:1fr!important;}
      .heures-grid{grid-template-columns:1fr!important;}
      .recap-grid{grid-template-columns:1fr!important;}
    }
  </style>
</head>
<body>

<button class="hamburger" id="hamburger" onclick="toggleMobileNav()" aria-label="Menu">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="navOverlay" onclick="toggleMobileNav()"></div>

<div class="main">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-left">
      <h1>üí∂ Paie & Salaires</h1>
      <p>Calcul automatique depuis le temps de travail ¬∑ Brut ‚Üí Net ¬∑ Fiches de paie</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="window.location.href='rh-temps.html'">‚è± Temps de travail</button>
      <button class="btn btn-outline btn-sm" id="btn-recap" onclick="showRecap()">üìä R√©capitulatif</button>
      <button class="btn btn-rh btn-sm" onclick="exportAllPDF()">üìÑ Exporter fiches</button>
    </div>
  </div>

  <!-- MOIS BAR -->
  <div class="mois-bar">
    <div class="mois-nav">
      <button onclick="prevMois()">‚Äπ</button>
      <div class="mois-label" id="moisLabel">‚Äî</div>
      <button onclick="nextMois()">‚Ä∫</button>
    </div>
    <div class="mois-today" onclick="goToday()">Aujourd'hui</div>
    <div class="mois-stats" id="moisStats">
      <div class="mois-stat"><span class="dot" style="background:var(--rh-main)"></span><strong id="stat-payes">0</strong> fiches g√©n√©r√©es</div>
      <div class="mois-stat"><span class="dot" style="background:var(--orange)"></span><strong id="stat-attente">0</strong> en attente</div>
      <div class="mois-stat"><span class="dot" style="background:var(--blue)"></span>Masse salariale : <strong id="stat-masse">‚Äî</strong></div>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- KPI ROW -->
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-lbl">Masse salariale brute</div>
        <div class="kpi-val green" id="kpi-brut-total">‚Äî</div>
        <div class="kpi-sub">Total bruts employ√©s</div>
      </div>
      <div class="kpi-card orange">
        <div class="kpi-lbl">Charges patronales</div>
        <div class="kpi-val orange" id="kpi-pat-total">‚Äî</div>
        <div class="kpi-sub">Co√ªt employeur total</div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-lbl">Co√ªt total employeur</div>
        <div class="kpi-val" id="kpi-superbrut-total">‚Äî</div>
        <div class="kpi-sub">Brut + charges pat.</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-lbl">Heures sup totales</div>
        <div class="kpi-val orange" id="kpi-sup-total">0h</div>
        <div class="kpi-sub">Ce mois</div>
      </div>
      <div class="kpi-card purple">
        <div class="kpi-lbl">Employ√©s saisis</div>
        <div class="kpi-val" id="kpi-emp-count">0 / 0</div>
        <div class="kpi-sub">Paies calcul√©es</div>
      </div>
    </div>

    <!-- TABLE EMPLOY√âS -->
    <div class="table-card">
      <div class="table-head">
        <div class="table-title">üë• R√©capitulatif de paie ‚Äî <span id="table-mois-label" style="color:var(--rh-main)"></span></div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn btn-outline btn-xs" onclick="importFromTemps()">üìÖ Importer depuis Temps</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="text-align:left">Employ√©</th>
              <th>H. contractuelles</th>
              <th>H. r√©elles</th>
              <th>H. sup</th>
              <th>Salaire brut</th>
              <th>Charges sal.</th>
              <th>Charges pat.</th>
              <th>Salaire net</th>
              <th>Statut</th>
              <th style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="paieTableBody">
            <tr><td colspan="10"><div class="loader"><div class="spin"></div></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- RECAP MASSE SALARIALE -->
    <div class="recap-card" id="recapCard" style="display:none">
      <div class="recap-title">üìä R√©capitulatif masse salariale</div>
      <div class="recap-grid" id="recapGrid"></div>
    </div>

  </div>
</div>

<!-- MODAL FICHE PAIE -->
<div class="modal-overlay" id="ficheModal">
  <div class="modal" style="max-width:720px">
    <div class="modal-head">
      <h3>üí∂ <span id="modal-emp-name">‚Äî</span></h3>
      <button class="modal-close" onclick="closeFicheModal()">‚úï</button>
    </div>
    <div class="modal-body" id="ficheModalBody">
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeFicheModal()">Fermer</button>
      <button class="btn btn-rh" onclick="saveFiche()">üíæ Sauvegarder</button>
      <button class="btn" style="background:#1e293b;color:white" onclick="printFiche()">üñ®Ô∏è Imprimer fiche</button>
    </div>
  </div>
</div>

<!-- MODAL PDF PREVIEW -->
<div class="modal-overlay" id="pdfModal">
  <div class="modal" style="max-width:680px">
    <div class="modal-head">
      <h3>üñ®Ô∏è Aper√ßu fiche de paie</h3>
      <button class="modal-close" onclick="closePdfModal()">‚úï</button>
    </div>
    <div class="modal-body" id="pdfModalBody"></div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closePdfModal()">Fermer</button>
      <button class="btn btn-rh" onclick="window.print()">üñ®Ô∏è Imprimer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- PRINT STYLE -->
<style id="printStyle">
@media print {
  body > *:not(#printArea) { display: none !important; }
  #printArea { display: block !important; }
}
</style>
<div id="printArea" style="display:none"></div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth = getAuth(app);
  const db   = getFirestore(app);
  window._auth = auth; window._db = db;
  window._doc = doc; window._setDoc = setDoc; window._getDoc = getDoc;
  window._collection = collection; window._getDocs = getDocs;
  window._deleteDoc = deleteDoc; window._signOut = signOut;

  onAuthStateChanged(auth, function(user) {
    if (!user) { window.location.href = 'index.html'; return; }
    window._uid = user.uid;
    window._firebaseReady = true;
    window.initPaie();
  });
</script>

<script>
// ‚ïê‚ïê CONSTANTES COTISATIONS 2025 ‚ïê‚ïê
const PMSS   = 3925;
const SMIC_H = 11.88;
const SMIC_M = SMIC_H * 35 * 52 / 12; // ~1801.80

function calcCotisations(brut, estCadre) {
  const b = parseFloat(brut) || 0;
  if (b <= 0) return { sal:0, pat:0, net:0, superbrut:0 };

  const assiette_csg = b * 0.9825;
  const plaf1 = Math.min(b, PMSS);

  // SALARIALES
  let sal = 0;
  sal += plaf1 * 0.0690;
  sal += b     * 0.0040;
  sal += assiette_csg * 0.0680;
  sal += assiette_csg * 0.0240;
  sal += assiette_csg * 0.0050;
  sal += plaf1 * 0.0315;
  if (b > PMSS) sal += Math.min(b - PMSS, 7 * PMSS) * 0.0864;
  if (estCadre) {
    sal += Math.min(b, 4 * PMSS) * 0.00024;
    if (b > PMSS) sal += Math.min(b - PMSS, 7 * PMSS) * 0.0014;
  }

  // PATRONALES
  let pat = 0;
  const seuil_am = 2.25 * SMIC_M;
  const seuil_af = 3.3  * SMIC_M;
  pat += b     * (b <= seuil_am ? 0.07 : 0.13);
  pat += b     * 0.015;
  pat += b     * (b <= seuil_af ? 0.0345 : 0.0525);
  pat += plaf1 * 0.0855;
  pat += b     * 0.0202;
  pat += Math.min(b, 4 * PMSS) * 0.04;
  pat += Math.min(b, 4 * PMSS) * 0.0025;
  pat += b     * 0.001;
  pat += plaf1 * 0.0472;
  if (b > PMSS) pat += Math.min(b - PMSS, 7 * PMSS) * 0.1295;
  pat += plaf1 * 0.0129;
  if (b > PMSS) pat += Math.min(b - PMSS, 7 * PMSS) * 0.0216;
  if (estCadre) {
    pat += Math.min(b, 4 * PMSS) * 0.015;
    pat += Math.min(b, 4 * PMSS) * 0.00036;
    if (b > PMSS) pat += Math.min(b - PMSS, 7 * PMSS) * 0.0021;
  }

  const net = Math.round((b - sal) * 100) / 100;
  return {
    sal: Math.round(sal * 100) / 100,
    pat: Math.round(pat * 100) / 100,
    net,
    superbrut: Math.round((b + pat) * 100) / 100
  };
}

// Calcul brut depuis heures r√©elles
function calcBrutFromHeures(emp, heuresReelles, heuresSup) {
  const tauxH  = parseFloat(emp.salaireBrut || 0) / parseFloat(emp.heuresHebdo || 35) / (52/12);
  const brutBase = tauxH * heuresReelles;
  // Heures sup : majoration 25% pour les 8 premi√®res, 50% au-del√†
  const sup8    = Math.min(heuresSup, 8);
  const supPlus = Math.max(heuresSup - 8, 0);
  const brutSup = tauxH * (sup8 * 1.25 + supPlus * 1.50);
  return Math.round((brutBase + brutSup) * 100) / 100;
}

// ‚ïê‚ïê STATE ‚ïê‚ïê
var _curMois   = new Date();
var _emps      = [];   // liste employ√©s
var _tempsData = {};   // { empId: { heures, jours, sup } }
var _paieData  = {};   // { empId: { brut, sal, pat, net, valide, ... } }
var _currentFicheEmpId = null;

function getMoisKey() {
  return _curMois.getFullYear() + '-' + String(_curMois.getMonth()+1).padStart(2,'0');
}
function getMoisLabel() {
  return _curMois.toLocaleDateString('fr-FR', { month:'long', year:'numeric' });
}
function fmtE(n) {
  return (parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨';
}
function fmtH(n) {
  const v = parseFloat(n)||0;
  return v.toFixed(1).replace('.',',')+'h';
}
function initials(emp) {
  return ((emp.prenom||'').charAt(0) + (emp.nom||'').charAt(0)).toUpperCase();
}

// ‚ïê‚ïê INIT ‚ïê‚ïê
window.initPaie = async function() {
  _curMois = new Date();
  _curMois.setDate(1);
  await loadAll();
};

async function loadAll() {
  updateMoisBar();
  document.getElementById('paieTableBody').innerHTML = '<tr><td colspan="10"><div class="loader"><div class="spin"></div></div></td></tr>';
  await loadEmps();
  await loadTemps();
  await loadPaie();
  render();
}

async function loadEmps() {
  _emps = [];
  try {
    const snap = await window._getDocs(window._collection(window._db, 'rh', window._uid, 'employes'));
    snap.forEach(function(d) { _emps.push({ id:d.id, ...d.data() }); });
  } catch(e) { console.error('loadEmps:', e); }
}

async function loadTemps() {
  _tempsData = {};
  var moisKey = getMoisKey();
  try {
    var snap = await window._getDocs(window._collection(window._db, 'rh', window._uid, 'temps'));
    snap.forEach(function(d) {
      var data = d.data();
      if (data.mois === moisKey) {
        _tempsData[data.employeId] = data;
      }
    });
  } catch(e) { console.error('loadTemps:', e); }
}

async function loadPaie() {
  _paieData = {};
  var moisKey = getMoisKey();
  try {
    var snap = await window._getDocs(window._collection(window._db, 'rh', window._uid, 'paie'));
    snap.forEach(function(d) {
      var data = d.data();
      if (data.mois === moisKey) {
        _paieData[data.employeId] = data;
      }
    });
  } catch(e) { console.error('loadPaie:', e); }
}

// ‚ïê‚ïê RENDER ‚ïê‚ïê
function updateMoisBar() {
  var label = getMoisLabel();
  document.getElementById('moisLabel').textContent = label;
  document.getElementById('table-mois-label').textContent = label;
  _curMois.setDate(1);
}

function render() {
  var tbody = document.getElementById('paieTableBody');
  if (!_emps.length) {
    tbody.innerHTML = '<tr><td colspan="10"><div class="empty-state"><div class="empty-icon">üë•</div><p>Aucun employ√© trouv√©. Cr√©ez des employ√©s dans <a href="rh-employes.html" style="color:var(--rh-main)">Employ√©s & Fiches</a>.</p></div></td></tr>';
    updateKpis();
    return;
  }

  var rows = _emps.map(function(emp) {
    var temps    = _tempsData[emp.id] || null;
    var paie     = _paieData[emp.id]  || null;
    var estCadre = emp.categoriePoste === 'cadre';

    // Heures
    var hContrat  = parseFloat(emp.heuresHebdo || 35) * (52/12);
    var hReelles  = temps ? parseFloat(temps.heuresTravaillees || 0) : 0;
    var hSup      = temps ? parseFloat(temps.heureSup || 0) : 0;
    var sourceTemps = temps ? (temps.source === 'planning' || temps.source === 'planning+ajust' ? 'planning' : 'manuel') : null;

    // Brut : si paie sauvegard√©e ‚Üí utiliser, sinon calculer
    var brutCalc  = emp.salaireBrut || 0;
    if (hReelles > 0 && emp.salaireBrut) {
      brutCalc = calcBrutFromHeures(emp, hReelles, hSup);
    }
    var brut = paie ? parseFloat(paie.brut || 0) : brutCalc;

    var cot      = calcCotisations(brut, estCadre);
    var valide   = paie ? !!paie.valide : false;

    // Couleur heures sup
    var supCls = hSup > 8 ? 'td-neg' : hSup > 0 ? '' : 'td-muted';

    return `<tr>
      <td>
        <div class="emp-cell">
          <div class="emp-avatar">${initials(emp)}</div>
          <div>
            <div class="emp-name">${emp.prenom||''} ${emp.nom||''}</div>
            <div class="emp-poste">${emp.poste||''} ¬∑ ${emp.typeContrat||'CDI'}</div>
          </div>
        </div>
      </td>
      <td class="td-muted">${fmtH(hContrat)}</td>
      <td style="color:${hReelles>0?'var(--rh-main)':'var(--muted)'}">
        ${hReelles > 0 ? fmtH(hReelles) : '<span class="td-muted">‚Äî</span>'}
        ${sourceTemps === 'planning' ? '<span class="source-badge source-planning" style="margin-left:4px">üìÖ</span>' : sourceTemps === 'manuel' ? '<span class="source-badge source-manuel">‚úèÔ∏è</span>' : ''}
      </td>
      <td class="${supCls}">${hSup > 0 ? '+'+fmtH(hSup) : '<span class="td-muted">‚Äî</span>'}</td>
      <td style="font-weight:700">${brut > 0 ? fmtE(brut) : '<span class="td-muted">‚Äî</span>'}</td>
      <td class="td-neg">${brut > 0 ? '‚àí'+fmtE(cot.sal) : '<span class="td-muted">‚Äî</span>'}</td>
      <td style="color:var(--orange)">${brut > 0 ? '+'+fmtE(cot.pat) : '<span class="td-muted">‚Äî</span>'}</td>
      <td class="td-pos" style="font-weight:800">${brut > 0 ? fmtE(cot.net) : '<span class="td-muted">‚Äî</span>'}</td>
      <td>
        ${valide
          ? '<span class="badge badge-green">‚úì Valid√©e</span>'
          : brut > 0
            ? '<span class="badge badge-orange">‚è≥ √Ä valider</span>'
            : '<span class="badge badge-gray">‚Äî Sans donn√©es</span>'
        }
      </td>
      <td>
        <div class="row-actions">
          <button class="action-btn edit" onclick="openFiche('${emp.id}')">‚úèÔ∏è √âditer</button>
          <button class="action-btn pdf" onclick="openPdfPreview('${emp.id}')">üñ®Ô∏è Fiche</button>
        </div>
      </td>
    </tr>`;
  }).join('');

  tbody.innerHTML = rows;
  updateKpis();
}

function updateKpis() {
  var totalBrut = 0, totalPat = 0, totalSuperBrut = 0, totalSup = 0;
  var nbCalc = 0, nbValide = 0;

  _emps.forEach(function(emp) {
    var temps  = _tempsData[emp.id] || null;
    var paie   = _paieData[emp.id]  || null;
    var estCadre = emp.categoriePoste === 'cadre';

    var hReelles = temps ? parseFloat(temps.heuresTravaillees || 0) : 0;
    var hSup     = temps ? parseFloat(temps.heureSup || 0) : 0;
    totalSup += hSup;

    var brut = 0;
    if (paie && paie.brut) {
      brut = parseFloat(paie.brut);
    } else if (hReelles > 0 && emp.salaireBrut) {
      brut = calcBrutFromHeures(emp, hReelles, hSup);
    } else if (emp.salaireBrut) {
      brut = parseFloat(emp.salaireBrut);
    }

    if (brut > 0) {
      var cot = calcCotisations(brut, estCadre);
      totalBrut += brut;
      totalPat  += cot.pat;
      totalSuperBrut += cot.superbrut;
      nbCalc++;
      if (paie && paie.valide) nbValide++;
    }
  });

  document.getElementById('kpi-brut-total').textContent    = totalBrut > 0 ? fmtE(totalBrut) : '‚Äî';
  document.getElementById('kpi-pat-total').textContent     = totalPat  > 0 ? fmtE(totalPat)  : '‚Äî';
  document.getElementById('kpi-superbrut-total').textContent = totalSuperBrut > 0 ? fmtE(totalSuperBrut) : '‚Äî';
  document.getElementById('kpi-sup-total').textContent     = fmtH(totalSup);
  document.getElementById('kpi-emp-count').textContent     = nbCalc + ' / ' + _emps.length;

  document.getElementById('stat-payes').textContent    = nbValide;
  document.getElementById('stat-attente').textContent  = Math.max(nbCalc - nbValide, 0);
  document.getElementById('stat-masse').textContent    = totalBrut > 0 ? fmtE(totalBrut) : '‚Äî';
}

// ‚ïê‚ïê IMPORT DEPUIS TEMPS ‚ïê‚ïê
async function importFromTemps() {
  await loadTemps();
  render();
  showToast('‚úÖ Donn√©es de temps recharg√©es', 'ok');
}
window.importFromTemps = importFromTemps;

// ‚ïê‚ïê NAVIGATION MOIS ‚ïê‚ïê
function prevMois() {
  _curMois.setMonth(_curMois.getMonth() - 1);
  loadAll();
}
function nextMois() {
  _curMois.setMonth(_curMois.getMonth() + 1);
  loadAll();
}
function goToday() {
  _curMois = new Date(); _curMois.setDate(1);
  loadAll();
}
window.prevMois = prevMois; window.nextMois = nextMois; window.goToday = goToday;

// ‚ïê‚ïê MODAL FICHE SAISIE ‚ïê‚ïê
function openFiche(empId) {
  var emp      = _emps.find(function(e) { return e.id === empId; });
  if (!emp) return;
  _currentFicheEmpId = empId;
  var temps    = _tempsData[empId] || {};
  var paie     = _paieData[empId]  || {};
  var estCadre = emp.categoriePoste === 'cadre';

  var hContrat = parseFloat(emp.heuresHebdo || 35) * (52/12);
  var hReelles = parseFloat(temps.heuresTravaillees || 0);
  var hSup     = parseFloat(temps.heureSup || 0);

  // Brut de base contrat
  var brutContrat = parseFloat(emp.salaireBrut || 0);
  // Brut calcul√© sur heures r√©elles
  var brutCalc = (hReelles > 0 && brutContrat > 0) ? calcBrutFromHeures(emp, hReelles, hSup) : brutContrat;
  // Brut final = paie sauvegard√©e OU calcul√©
  var brutFinal = paie.brut ? parseFloat(paie.brut) : brutCalc;

  var cot = calcCotisations(brutFinal, estCadre);
  var sourceTemps = temps.source === 'planning' || temps.source === 'planning+ajust' ? 'üìÖ Planning' : temps.heuresTravaillees ? '‚úèÔ∏è Manuel' : null;

  document.getElementById('modal-emp-name').textContent = (emp.prenom||'') + ' ' + (emp.nom||'');

  var body = document.getElementById('ficheModalBody');
  body.innerHTML = `
    <!-- IMPORT PLANNING -->
    ${sourceTemps ? `<div class="import-banner">
      <div class="import-banner-icon">üìÖ</div>
      <div class="import-banner-text">Heures import√©es depuis <strong>${sourceTemps}</strong> ‚Äî ${fmtH(hReelles)} travaill√©es ¬∑ ${fmtH(hSup)} suppl√©mentaires</div>
    </div>` : `<div class="import-banner" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:#fcd34d">
      <div class="import-banner-icon">‚ö†Ô∏è</div>
      <div class="import-banner-text">Aucune donn√©e de temps pour ce mois. Saisissez manuellement ou importez depuis <a href="rh-temps.html" style="color:#92400e;font-weight:700">Temps de travail</a>.</div>
    </div>`}

    <!-- HEURES -->
    <div class="heures-section">
      <div class="heures-title">‚è± Heures du mois</div>
      <div class="heures-grid">
        <div class="h-box">
          <div class="h-box-label">Contractuelles</div>
          <div class="h-box-val blue">${fmtH(hContrat)}</div>
          <div class="h-box-sub">${emp.heuresHebdo||35}h/sem</div>
        </div>
        <div class="h-box">
          <div class="h-box-label">R√©elles</div>
          <div class="h-box-val green" id="fiche-h-reelles">${fmtH(hReelles)}</div>
          <div class="h-box-sub">depuis temps de travail</div>
        </div>
        <div class="h-box">
          <div class="h-box-label">Suppl√©mentaires</div>
          <div class="h-box-val orange" id="fiche-h-sup">${fmtH(hSup)}</div>
          <div class="h-box-sub">major√©es 25%/50%</div>
        </div>
        <div class="h-box">
          <div class="h-box-label">√âcart</div>
          <div class="h-box-val ${hReelles>=hContrat?'green':'orange'}" id="fiche-h-ecart">${hReelles >= hContrat ? '+' : ''}${fmtH(hReelles - hContrat)}</div>
          <div class="h-box-sub">vs contrat</div>
        </div>
      </div>
    </div>

    <!-- SAISIE BRUT -->
    <div style="margin-bottom:14px">
      <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">üí∞ Salaire brut</div>
      <div class="field-row triple">
        <div class="field">
          <label>H. r√©elles (ajustement)</label>
          <input type="text" inputmode="decimal" id="fi-h-reelles" value="${hReelles||''}" placeholder="0" oninput="onFicheHInput(this.value,'${empId}')"/>
          <div class="field-hint">Modifiable si besoin</div>
        </div>
        <div class="field">
          <label>H. suppl√©mentaires</label>
          <input type="text" inputmode="decimal" id="fi-h-sup" value="${hSup||''}" placeholder="0" oninput="onFicheHInput(null,'${empId}')"/>
        </div>
        <div class="field">
          <label>Taux horaire (brut)</label>
          <input type="text" readonly id="fi-taux" value="${brutContrat && emp.heuresHebdo ? (brutContrat / (emp.heuresHebdo * 52/12)).toFixed(4).replace('.',',') : '‚Äî'}"/>
          <div class="field-hint">Calcul√© depuis fiche employ√©</div>
        </div>
      </div>
      <div class="field-row">
        <div class="field">
          <label>Salaire brut calcul√© (‚Ç¨)</label>
          <input type="text" inputmode="decimal" id="fi-brut" value="${brutFinal ? brutFinal.toFixed(2).replace('.',',') : ''}" placeholder="0,00" oninput="onFicheBrutInput(this.value,'${empId}')"/>
          <div class="field-hint">Modifiable manuellement</div>
        </div>
        <div class="field">
          <label>Prime / Compl√©ment (‚Ç¨)</label>
          <input type="text" inputmode="decimal" id="fi-prime" value="${paie.prime ? parseFloat(paie.prime).toFixed(2).replace('.',',') : ''}" placeholder="0,00" oninput="onFicheBrutInput(null,'${empId}')"/>
        </div>
      </div>
    </div>

    <!-- D√âTAIL COTISATIONS -->
    <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üìä D√©tail des cotisations 2025</div>
    <table class="cot-table" id="ficheCoTable">
      ${renderCotTable(brutFinal, estCadre)}
    </table>

    <!-- NET -->
    <div class="net-result" id="ficheNetResult">
      <div>
        <div class="net-result-label">Salaire net √† payer</div>
        <div class="net-result-sub">= Brut ‚àí Cotisations salariales</div>
      </div>
      <div class="net-result-val" id="ficheNetVal">${fmtE(cot.net)}</div>
    </div>

    <!-- NOTE -->
    <div class="field" style="margin-top:14px">
      <label>Note / Observation</label>
      <input type="text" id="fi-note" value="${paie.note||''}" placeholder="Cong√© pay√©, arr√™t maladie, prime exceptionnelle..."/>
    </div>

    <!-- VALIDATION -->
    <div style="margin-top:14px;display:flex;align-items:center;gap:10px">
      <input type="checkbox" id="fi-valide" ${paie.valide?'checked':''} style="width:16px;height:16px;accent-color:var(--rh-main);cursor:pointer"/>
      <label for="fi-valide" style="font-size:12px;font-weight:600;cursor:pointer">Marquer comme valid√©e (fiche de paie approuv√©e)</label>
    </div>

    <div style="font-size:10px;color:var(--muted);background:#f8faff;padding:10px;border-radius:8px;margin-top:12px">
      ‚ö†Ô∏è Estimation indicative bas√©e sur les taux l√©gaux URSSAF 2025 (PMSS = 3 925 ‚Ç¨). Hors r√©duction Fillon, mutuelle obligatoire et pr√©l√®vement √† la source.
    </div>
  `;

  document.getElementById('ficheModal').classList.add('show');
}
window.openFiche = openFiche;

function renderCotTable(brut, estCadre) {
  var b = parseFloat(brut) || 0;
  if (b <= 0) return '<tbody><tr><td colspan="3" style="text-align:center;padding:20px;color:var(--muted)">Saisissez un salaire brut pour voir le d√©tail</td></tr></tbody>';
  var assiette_csg = b * 0.9825;
  var plaf1 = Math.min(b, PMSS);
  var f2 = function(n) { return (Math.round(n*100)/100).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨'; };
  var fp = function(n) { return n.toFixed(2)+'%'; };

  var rows_sal = [
    ['Vieillesse plafonn√©e (6,90%)', fp(6.90), f2(plaf1 * 0.069)],
    ['Vieillesse d√©plafonn√©e (0,40%)', fp(0.40), f2(b * 0.004)],
    ['CSG d√©ductible (6,80%)', fp(6.80), f2(assiette_csg * 0.068)],
    ['CSG non d√©ductible (2,40%)', fp(2.40), f2(assiette_csg * 0.024)],
    ['CRDS (0,50%)', fp(0.50), f2(assiette_csg * 0.005)],
    ['Retraite compl√©mentaire T1 (3,15%)', fp(3.15), f2(plaf1 * 0.0315)],
  ];
  if (b > PMSS) rows_sal.push(['Retraite compl√©mentaire T2 (8,64%)', fp(8.64), f2(Math.min(b-PMSS,7*PMSS)*0.0864)]);

  var rows_pat = [
    ['Maladie ('+(b <= 2.25*SMIC_M?'7,00':'13,00')+'%)', fp(b<=2.25*SMIC_M?7.00:13.00), f2(b*(b<=2.25*SMIC_M?0.07:0.13))],
    ['AT/MP (1,50%)', fp(1.50), f2(b*0.015)],
    ['Alloc. familiales ('+(b<=3.3*SMIC_M?'3,45':'5,25')+'%)', fp(b<=3.3*SMIC_M?3.45:5.25), f2(b*(b<=3.3*SMIC_M?0.0345:0.0525))],
    ['Vieillesse plafonn√©e (8,55%)', fp(8.55), f2(plaf1*0.0855)],
    ['Vieillesse d√©plafonn√©e (2,02%)', fp(2.02), f2(b*0.0202)],
    ['Ch√¥mage (4,00%)', fp(4.00), f2(Math.min(b,4*PMSS)*0.04)],
    ['AGS (0,25%)', fp(0.25), f2(Math.min(b,4*PMSS)*0.0025)],
    ['FNAL (0,10%)', fp(0.10), f2(b*0.001)],
    ['Retraite comp T1 (4,72%)', fp(4.72), f2(plaf1*0.0472)],
  ];
  if (b > PMSS) rows_pat.push(['Retraite comp T2 (12,95%)', fp(12.95), f2(Math.min(b-PMSS,7*PMSS)*0.1295)]);

  var cot = calcCotisations(b, estCadre);

  return `<thead><tr>
    <th style="text-align:left">Cotisation</th>
    <th>Taux</th>
    <th>Montant</th>
  </tr></thead>
  <tbody>
    <tr class="cot-cat"><td colspan="3">COTISATIONS SALARIALES</td></tr>
    ${rows_sal.map(function(r){return `<tr><td>${r[0]}</td><td style="text-align:right;color:var(--muted)">${r[1]}</td><td style="text-align:right;color:var(--red)">${r[2]}</td></tr>`;}).join('')}
    <tr class="cot-cat"><td colspan="3">COTISATIONS PATRONALES</td></tr>
    ${rows_pat.map(function(r){return `<tr><td>${r[0]}</td><td style="text-align:right;color:var(--muted)">${r[1]}</td><td style="text-align:right;color:var(--orange)">${r[2]}</td></tr>`;}).join('')}
  </tbody>
  <tfoot>
    <tr><td><strong>Total salariales</strong></td><td style="text-align:right;color:var(--muted)">${(cot.sal/b*100).toFixed(1)}%</td><td style="text-align:right;color:var(--red)">‚àí${f2(cot.sal)}</td></tr>
    <tr><td><strong>Total patronales</strong></td><td style="text-align:right;color:var(--muted)">${(cot.pat/b*100).toFixed(1)}%</td><td style="text-align:right;color:var(--orange)">+${f2(cot.pat)}</td></tr>
    <tr style="background:#f0fdf4"><td><strong>Co√ªt total employeur</strong></td><td></td><td style="text-align:right;color:var(--rh-main)"><strong>${f2(cot.superbrut)}</strong></td></tr>
  </tfoot>`;
}

// Input heures dans modal
function onFicheHInput(val, empId) {
  var emp = _emps.find(function(e){ return e.id === empId; });
  if (!emp) return;
  var hReelles = parseFloat((document.getElementById('fi-h-reelles').value||'0').replace(',','.')) || 0;
  var hSup     = parseFloat((document.getElementById('fi-h-sup').value||'0').replace(',','.')) || 0;
  var brut     = emp.salaireBrut > 0 ? calcBrutFromHeures(emp, hReelles, hSup) : 0;
  var brutInput = document.getElementById('fi-brut');
  if (brutInput && !brutInput.dataset.manual) {
    brutInput.value = brut > 0 ? brut.toFixed(2).replace('.',',') : '';
  }
  refreshFicheCalc(brut, emp.categoriePoste === 'cadre');
}
window.onFicheHInput = onFicheHInput;

function onFicheBrutInput(val, empId) {
  var emp = _emps.find(function(e){ return e.id === empId; });
  var brutInput = document.getElementById('fi-brut');
  var primeInput = document.getElementById('fi-prime');
  brutInput.dataset.manual = '1';
  var brut  = parseFloat((brutInput.value||'0').replace(',','.')) || 0;
  var prime = parseFloat((primeInput.value||'0').replace(',','.')) || 0;
  refreshFicheCalc(brut + prime, emp ? emp.categoriePoste === 'cadre' : false);
}
window.onFicheBrutInput = onFicheBrutInput;

function refreshFicheCalc(brut, estCadre) {
  var cot = calcCotisations(brut, estCadre);
  var cotTable = document.getElementById('ficheCoTable');
  if (cotTable) cotTable.innerHTML = renderCotTable(brut, estCadre);
  var netVal = document.getElementById('ficheNetVal');
  if (netVal) netVal.textContent = fmtE(cot.net);
}

// SAVE FICHE
async function saveFiche() {
  var empId = _currentFicheEmpId;
  if (!empId || !window._uid) return;
  var emp = _emps.find(function(e){ return e.id === empId; });

  var brut   = parseFloat((document.getElementById('fi-brut').value||'0').replace(',','.')) || 0;
  var prime  = parseFloat((document.getElementById('fi-prime').value||'0').replace(',','.')) || 0;
  var hR     = parseFloat((document.getElementById('fi-h-reelles').value||'0').replace(',','.')) || 0;
  var hSup   = parseFloat((document.getElementById('fi-h-sup').value||'0').replace(',','.')) || 0;
  var note   = document.getElementById('fi-note').value;
  var valide = document.getElementById('fi-valide').checked;

  var cot = calcCotisations(brut + prime, emp ? emp.categoriePoste === 'cadre' : false);

  var data = {
    employeId:  empId,
    employeNom: emp ? (emp.prenom||'')+' '+(emp.nom||'') : '',
    mois:       getMoisKey(),
    brut:       brut,
    prime:      prime,
    brutTotal:  brut + prime,
    hReelles:   hR,
    hSup:       hSup,
    cotSal:     cot.sal,
    cotPat:     cot.pat,
    net:        cot.net,
    superbrut:  cot.superbrut,
    note:       note,
    valide:     valide,
    updatedAt:  new Date().toISOString()
  };

  try {
    var docId = getMoisKey() + '_' + empId;
    await window._setDoc(window._doc(window._db, 'rh', window._uid, 'paie', docId), data);
    _paieData[empId] = data;
    render();
    showToast('‚úÖ Paie sauvegard√©e', 'ok');
    closeFicheModal();
  } catch(e) {
    showToast('Erreur : ' + e.message, 'err');
    console.error(e);
  }
}
window.saveFiche = saveFiche;

function closeFicheModal() { document.getElementById('ficheModal').classList.remove('show'); _currentFicheEmpId = null; }
window.closeFicheModal = closeFicheModal;

// ‚ïê‚ïê PDF PREVIEW ‚ïê‚ïê
function openPdfPreview(empId) {
  var emp     = _emps.find(function(e){ return e.id === empId; });
  if (!emp) return;
  var paie    = _paieData[empId] || {};
  var temps   = _tempsData[empId] || {};
  var estCadre = emp.categoriePoste === 'cadre';

  var hContrat = parseFloat(emp.heuresHebdo || 35) * (52/12);
  var hReelles = parseFloat(paie.hReelles || temps.heuresTravaillees || 0);
  var hSup     = parseFloat(paie.hSup || temps.heureSup || 0);
  var brut     = parseFloat(paie.brutTotal || paie.brut || emp.salaireBrut || 0);
  var prime    = parseFloat(paie.prime || 0);
  var cot      = calcCotisations(brut, estCadre);

  var moisLabel = getMoisLabel();
  var empNom    = (emp.prenom||'')+' '+(emp.nom||'');

  var html = `
    <div class="pdf-preview" id="pdfContent">
      <div class="pdf-header">
        <div>
          <div class="pdf-company">ALTEORE</div>
          <div class="pdf-period">Bulletin de paie ‚Äî ${moisLabel}</div>
        </div>
        <div style="text-align:right;font-size:11px;color:var(--muted)">
          <div style="font-weight:700">Date d'√©mission</div>
          <div>${new Date().toLocaleDateString('fr-FR')}</div>
        </div>
      </div>

      <div class="pdf-emp-block">
        <div class="pdf-emp-name">${empNom}</div>
        <div class="pdf-emp-details">${emp.poste||''} ¬∑ ${emp.typeContrat||'CDI'} ¬∑ ${emp.categoriePoste||'Employ√©'} ¬∑ ${emp.heuresHebdo||35}h/sem</div>
        ${emp.dateEntree ? `<div class="pdf-emp-details" style="margin-top:2px">Entr√©e le ${new Date(emp.dateEntree).toLocaleDateString('fr-FR')}</div>` : ''}
      </div>

      <table class="pdf-table">
        <thead><tr><th style="text-align:left">D√©signation</th><th>Base</th><th>Taux</th><th>Montant</th></tr></thead>
        <tbody>
          <tr class="section-head"><td colspan="4">R√âMUN√âRATION</td></tr>
          <tr><td>Salaire de base</td><td style="text-align:right">${fmtH(hContrat)}</td><td style="text-align:right">${emp.salaireBrut && emp.heuresHebdo ? (emp.salaireBrut/(emp.heuresHebdo*52/12)).toFixed(4)+' ‚Ç¨/h' : '‚Äî'}</td><td style="text-align:right">${fmtE(brut - prime - (hSup > 0 && emp.salaireBrut && emp.heuresHebdo ? calcBrutFromHeures(emp, 0, hSup) - calcBrutFromHeures(emp, 0, 0) : 0))}</td></tr>
          ${hSup > 0 ? `<tr><td>Heures suppl√©mentaires (√ó${Math.min(hSup,8).toFixed(1)}h √† 25% + ${Math.max(hSup-8,0).toFixed(1)}h √† 50%)</td><td style="text-align:right">${fmtH(hSup)}</td><td style="text-align:right">+25%/50%</td><td style="text-align:right;color:var(--rh-main)">+${fmtE(emp.salaireBrut&&emp.heuresHebdo ? (emp.salaireBrut/(emp.heuresHebdo*52/12))*(Math.min(hSup,8)*0.25+Math.max(hSup-8,0)*0.50) : 0)}</td></tr>` : ''}
          ${prime > 0 ? `<tr><td>Prime / Compl√©ment</td><td></td><td></td><td style="text-align:right;color:var(--rh-main)">+${fmtE(prime)}</td></tr>` : ''}
          <tr class="pdf-total-row"><td><strong>SALAIRE BRUT</strong></td><td></td><td></td><td><strong>${fmtE(brut)}</strong></td></tr>

          <tr class="section-head"><td colspan="4">COTISATIONS SALARIALES</td></tr>
          <tr><td>Vieillesse (6,90% + 0,40%)</td><td style="text-align:right">${fmtE(brut)}</td><td style="text-align:right">7,30%</td><td style="text-align:right;color:var(--red)">‚àí${fmtE(Math.min(brut,PMSS)*0.069+brut*0.004)}</td></tr>
          <tr><td>CSG/CRDS (9,70% √ó 98,25%)</td><td style="text-align:right">${fmtE(brut*0.9825)}</td><td style="text-align:right">9,70%</td><td style="text-align:right;color:var(--red)">‚àí${fmtE(brut*0.9825*0.097)}</td></tr>
          <tr><td>Retraite compl√©mentaire</td><td style="text-align:right">${fmtE(Math.min(brut,PMSS))}</td><td style="text-align:right">3,15%</td><td style="text-align:right;color:var(--red)">‚àí${fmtE(Math.min(brut,PMSS)*0.0315)}</td></tr>
          <tr class="pdf-total-row"><td><strong>Total cotisations salariales</strong></td><td></td><td><strong>${(cot.sal/brut*100).toFixed(1)}%</strong></td><td><strong style="color:var(--red)">‚àí${fmtE(cot.sal)}</strong></td></tr>
        </tbody>
      </table>

      <div class="pdf-net-box">
        <div>
          <div class="pdf-net-label">NET √Ä PAYER</div>
          <div style="font-size:10px;opacity:.7">${moisLabel}</div>
        </div>
        <div class="pdf-net-val">${fmtE(cot.net)}</div>
      </div>

      <div style="margin-top:14px;background:#fff3cd;border:1px solid #fcd34d;border-radius:8px;padding:10px 14px;font-size:10px;color:#92400e">
        <strong>Charges patronales (info)</strong> : ${fmtE(cot.pat)} ¬∑ Co√ªt total employeur : ${fmtE(cot.superbrut)}
      </div>

      ${paie.note ? `<div style="margin-top:10px;background:#f8faff;border-radius:8px;padding:10px 14px;font-size:11px;color:var(--muted)">üìù ${paie.note}</div>` : ''}

      <div class="pdf-footer">
        Document √©tabli √† titre indicatif ¬∑ Taux URSSAF 2025 (PMSS = 3 925 ‚Ç¨) ¬∑ Hors r√©duction Fillon et PAS
      </div>
    </div>
  `;

  document.getElementById('pdfModalBody').innerHTML = html;
  document.getElementById('pdfModal').classList.add('show');
}
window.openPdfPreview = openPdfPreview;

function closePdfModal() { document.getElementById('pdfModal').classList.remove('show'); }
window.closePdfModal = closePdfModal;

// PRINT
function printFiche() {
  var empId = _currentFicheEmpId;
  if (!empId) return;
  openPdfPreview(empId);
  setTimeout(function() { window.print(); }, 200);
}
window.printFiche = printFiche;

// Export toutes fiches
function exportAllPDF() {
  showToast('üìÑ Utilisez le bouton üñ®Ô∏è Fiche sur chaque employ√©', 'warn');
}
window.exportAllPDF = exportAllPDF;

// RECAP
function showRecap() {
  var card = document.getElementById('recapCard');
  if (card.style.display !== 'none') { card.style.display = 'none'; return; }

  var totalBrut=0,totalPat=0,totalNet=0,totalSup=0,totalSuperBrut=0;
  _emps.forEach(function(emp) {
    var paie   = _paieData[emp.id]  || {};
    var temps  = _tempsData[emp.id] || {};
    var estCadre = emp.categoriePoste === 'cadre';
    var hR   = parseFloat(paie.hReelles || temps.heuresTravaillees || 0);
    var hSup = parseFloat(paie.hSup || temps.heureSup || 0);
    var brut = paie.brut ? parseFloat(paie.brut) : (hR > 0 && emp.salaireBrut ? calcBrutFromHeures(emp, hR, hSup) : parseFloat(emp.salaireBrut||0));
    var cot  = calcCotisations(brut, estCadre);
    totalBrut      += brut;
    totalPat       += cot.pat;
    totalNet       += cot.net;
    totalSup       += hSup;
    totalSuperBrut += cot.superbrut;
  });

  document.getElementById('recapGrid').innerHTML = `
    <div class="recap-box"><div class="recap-box-label">Masse brute</div><div class="recap-box-val" style="color:var(--rh-main)">${fmtE(totalBrut)}</div></div>
    <div class="recap-box"><div class="recap-box-label">Charges patronales</div><div class="recap-box-val" style="color:var(--orange)">${fmtE(totalPat)}</div></div>
    <div class="recap-box"><div class="recap-box-label">Masse nette</div><div class="recap-box-val">${fmtE(totalNet)}</div></div>
    <div class="recap-box"><div class="recap-box-label">Co√ªt total employeur</div><div class="recap-box-val" style="color:var(--blue)">${fmtE(totalSuperBrut)}</div></div>
  `;
  card.style.display = '';
  card.scrollIntoView({ behavior:'smooth' });
}
window.showRecap = showRecap;

// MOBILE NAV
function toggleMobileNav() {
  var hbg = document.getElementById('hamburger');
  var overlay = document.getElementById('navOverlay');
  var sidebar = document.querySelector('nav, aside.sidebar, .sidebar');
  if (sidebar) sidebar.classList.toggle('open');
  if (overlay) overlay.classList.toggle('show');
  if (hbg) hbg.classList.toggle('open');
}
window.toggleMobileNav = toggleMobileNav;

// TOAST
function showToast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + (type||'');
  setTimeout(function(){ t.className = 'toast'; }, 3200);
}

// PRINT STYLES
window.addEventListener('beforeprint', function() {
  var content = document.getElementById('pdfContent');
  var area = document.getElementById('printArea');
  if (content && area) { area.innerHTML = content.outerHTML; area.style.display='block'; }
});
window.addEventListener('afterprint', function() {
  document.getElementById('printArea').style.display='none';
  document.getElementById('printArea').innerHTML='';
});
</script>

<script src="nav.js"></script>
<script>
(function openRhNav(){
  var tries=0;
  var t=setInterval(function(){
    var sub=document.getElementById("rh-nav-sub");
    var nav=document.getElementById("alteore-nav");
    if(sub&&nav){clearInterval(t);sub.style.maxHeight="2000px";nav.classList.add("rh-mode");}
    if(++tries>50)clearInterval(t);
  },50);
})();
</script>
</body>
</html>
