<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE â€” Suivi CA & RÃ©sultats</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --blue-dark:#0f1f5c;--blue-main:#1a3dce;--blue-light:#4f7ef8;
      --blue-ghost:#f0f4ff;--white:#fff;--text:#1a1f36;--muted:#6b7280;
      --border:#e2e8f0;--bg:#f5f7ff;--sidebar-w:252px;--radius:12px;
      --green:#10b981;--orange:#f59e0b;--red:#ef4444;--purple:#6366f1;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}

    /* SIDEBAR */
    .sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#0f1f5c 0%,#162366 100%);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;overflow-y:auto;}
    .sidebar-logo{display:flex;align-items:center;gap:10px;padding:26px 20px 22px;border-bottom:1px solid rgba(255,255,255,0.08);margin-bottom:10px;}
    .sidebar-logo-icon{width:36px;height:36px;background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.2);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;}
    .sidebar-logo-text{font-size:18px;font-weight:800;color:white;letter-spacing:1px;}
    .sidebar-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,0.3);letter-spacing:1.2px;text-transform:uppercase;padding:14px 20px 5px;}
    .nav-item{display:flex;align-items:center;gap:11px;padding:10px 20px;color:rgba(255,255,255,0.6);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;user-select:none;}
    .nav-item:hover{color:white;background:rgba(255,255,255,0.06);}
    .nav-item.active{color:white;background:rgba(255,255,255,0.1);border-left-color:#4f7ef8;}
    .nav-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0;}
    .nav-label{flex:1;}
    .nav-chevron{font-size:11px;color:rgba(255,255,255,0.3);transition:transform 0.25s;margin-left:auto;}
    .nav-item.open .nav-chevron{transform:rotate(90deg);}
    .submenu{overflow:hidden;max-height:0;transition:max-height 0.3s ease;}
    .submenu.open{max-height:300px;}
    .sub-item{display:flex;align-items:center;gap:9px;padding:8px 20px 8px 44px;color:rgba(255,255,255,0.45);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.18s;}
    .sub-item:hover{color:rgba(255,255,255,0.8);background:rgba(255,255,255,0.05);}
    .sub-item.active{color:white;background:rgba(79,126,248,0.15);border-left-color:rgba(79,126,248,0.6);}
    .sub-dot{width:5px;height:5px;background:rgba(255,255,255,0.3);border-radius:50%;flex-shrink:0;}
    .sub-item.active .sub-dot{background:#4f7ef8;}
    .sub-year-badge{margin-left:auto;font-size:10px;color:rgba(255,255,255,0.25);font-weight:600;}
    .sidebar-footer{margin-top:auto;padding:16px 20px 0;border-top:1px solid rgba(255,255,255,0.08);}
    .user-card{display:flex;align-items:center;gap:10px;padding:10px;background:rgba(255,255,255,0.07);border-radius:10px;}
    .user-avatar{width:32px;height:32px;background:linear-gradient(135deg,var(--blue-light),#6366f1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;}
    .user-name{font-size:12px;font-weight:600;color:white;}
    .user-plan{font-size:10px;color:rgba(255,255,255,0.4);}
    .logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:14px;padding:4px;}

    /* MAIN */
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:17px;font-weight:700;}
    .topbar-left p{font-size:12px;color:var(--muted);}
    .topbar-right{display:flex;align-items:center;gap:10px;}
    .year-select{padding:7px 14px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;color:var(--blue-main);background:var(--blue-ghost);cursor:pointer;outline:none;}
    .year-select:focus{border-color:var(--blue-main);}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;}
    .btn-primary{background:linear-gradient(135deg,var(--blue-main),var(--blue-light));color:white;box-shadow:0 3px 10px rgba(26,61,206,0.3);}
    .btn-primary:hover{opacity:0.9;}

    .content{padding:22px 28px;flex:1;}

    /* KPI ANNUELS */
    .kpi-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:22px;}
    .kpi-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:18px;position:relative;overflow:hidden;}
    .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;}
    .kpi-card.blue::before{background:linear-gradient(90deg,var(--blue-main),var(--blue-light));}
    .kpi-card.green::before{background:linear-gradient(90deg,#10b981,#34d399);}
    .kpi-card.orange::before{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
    .kpi-card.red::before{background:linear-gradient(90deg,#ef4444,#f87171);}
    .kpi-card.purple::before{background:linear-gradient(90deg,#6366f1,#a5b4fc);}
    .kpi-label{font-size:11px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:5px;}
    .kpi-value{font-size:20px;font-weight:800;letter-spacing:-0.5px;margin-bottom:4px;}
    .kpi-value.positive{color:var(--green);}
    .kpi-value.negative{color:var(--red);}
    .kpi-sub{font-size:11px;color:var(--muted);}

    /* TABLEAU ANNUEL */
    .table-section{background:white;border:1px solid var(--border);border-radius:var(--radius);margin-bottom:22px;overflow:hidden;}
    .table-section-head{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;border-bottom:1px solid var(--border);}
    .table-section-title{font-size:14px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px;}
    .badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;}
    .badge-blue{background:var(--blue-ghost);color:var(--blue-main);}
    .badge-green{background:#f0fdf4;color:#10b981;}
    .badge-orange{background:#fffbeb;color:#f59e0b;}

    .annual-table{width:100%;border-collapse:collapse;font-size:12px;}
    .annual-table th{padding:9px 14px;text-align:right;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.4px;background:#f8faff;border-bottom:1px solid var(--border);white-space:nowrap;}
    .annual-table th:first-child{text-align:left;}
    .annual-table td{padding:8px 14px;text-align:right;border-bottom:1px solid #f1f5f9;font-weight:500;}
    .annual-table td:first-child{text-align:left;font-weight:600;color:var(--text);}
    .annual-table tr:last-child td{border-bottom:none;}
    .annual-table tr:hover td{background:#fafbff;}
    .annual-table tfoot td{padding:10px 14px;font-weight:800;background:#f0f4ff;border-top:2px solid var(--border);color:var(--blue-main);}
    .annual-table tfoot td:first-child{color:var(--text);}
    .td-positive{color:var(--green);font-weight:700;}
    .td-negative{color:var(--red);font-weight:700;}
    .td-muted{color:var(--muted);}
    .td-cumul{color:var(--purple);font-weight:700;}

    /* CHARTS */
    .charts-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:22px;}
    .charts-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;margin-bottom:22px;}
    .chart-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:20px;}
    .chart-card.full{grid-column:1/-1;}
    .chart-head{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;}
    .chart-title{font-size:13px;font-weight:700;color:var(--text);}
    .chart-sub{font-size:11px;color:var(--muted);margin-top:2px;}
    .chart-wrap{position:relative;}
    .chart-wrap.h200{height:200px;}
    .chart-wrap.h240{height:240px;}
    .chart-wrap.h280{height:280px;}

    /* LOADER */
    .loader{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--muted);gap:12px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--blue-main);border-radius:50%;animation:spin .7s linear infinite;}

    /* EMPTY STATE */
    .empty-state{text-align:center;padding:40px;color:var(--muted);}
    .empty-state .empty-icon{font-size:40px;margin-bottom:12px;}
    .empty-state p{font-size:13px;line-height:1.6;}

    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .content{animation:fadeIn 0.3s ease both;}
  .ucard:hover{background:rgba(255,255,255,.12);transform:translateY(-1px);transition:.15s}


/* â”€â”€ MOBILE UNIQUEMENT â”€â”€ */









/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘   ALTIORA â€” RESPONSIVE MOBILE (iPhone/Android)  â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* 1. RESET global overflow */
html, body { overflow-x: hidden; max-width: 100vw; }

/* 2. HAMBURGER â€” masquÃ© par dÃ©faut */
.hamburger {
  display: none;
  position: fixed;
  top: 14px; left: 14px;
  z-index: 1001;
  width: 44px; height: 44px;
  background: #0f1f5c;
  border: none; border-radius: 12px;
  cursor: pointer;
  flex-direction: column;
  align-items: center; justify-content: center;
  gap: 5px;
  box-shadow: 0 4px 16px rgba(15,31,92,.45);
  -webkit-tap-highlight-color: transparent;
  transition: background .2s;
}
.hamburger:active { background: #1a3dce; }
.hamburger span {
  display: block; width: 20px; height: 2.5px;
  background: #fff; border-radius: 2px;
  transition: all .25s ease;
  pointer-events: none;
}
.hamburger.open span:nth-child(1) { transform: translateY(7.5px) rotate(45deg); }
.hamburger.open span:nth-child(2) { opacity: 0; transform: scaleX(0); }
.hamburger.open span:nth-child(3) { transform: translateY(-7.5px) rotate(-45deg); }

/* 3. OVERLAY */
.nav-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.5); z-index: 1000;
  -webkit-tap-highlight-color: transparent;
}
.nav-overlay.show { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MOBILE â‰¤768px â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {

  /* HAMBURGER visible */
  .hamburger { display: flex !important; }

  /* SIDEBAR / NAV â†’ drawer */
  nav, aside.sidebar, .sidebar {
    position: fixed !important;
    top: 0 !important; left: 0 !important;
    height: 100vh !important;
    height: -webkit-fill-available !important;
    width: min(280px, 84vw) !important;
    z-index: 1001 !important;
    transform: translateX(-105%) !important;
    transition: transform .3s cubic-bezier(.4,0,.2,1) !important;
    overflow-y: auto !important;
    -webkit-overflow-scrolling: touch !important;
    margin: 0 !important;
    box-sizing: border-box !important;
  }
  nav.open, aside.sidebar.open, .sidebar.open {
    transform: translateX(0) !important;
    box-shadow: 8px 0 32px rgba(0,0,0,.3) !important;
  }

  /* MAIN CONTENT â†’ pleine largeur */
  .main, main, div.main, .main-content {
    margin-left: 0 !important;
    width: 100vw !important;
    overflow-x: hidden !important;
    box-sizing: border-box !important;
  }

  /* TOPBAR */
  .topbar {
    padding: 10px 10px 10px 62px !important;
    flex-wrap: wrap !important;
    gap: 6px !important;
    position: sticky !important;
    top: 0 !important; z-index: 50 !important;
    background: #fff !important;
    box-shadow: 0 1px 6px rgba(0,0,0,.08) !important;
    box-sizing: border-box !important;
    width: 100% !important;
  }
  .topbar h1, .topbar-left h1, .topbar-left h2 { font-size: 14px !important; }
  .topbar p, .topbar-left p { font-size: 10px !important; }
  .topbar-right, .tb-r {
    width: 100% !important;
    flex-wrap: wrap !important;
    gap: 6px !important;
  }
  .topbar-right .btn, .tb-r .btn,
  .topbar-right button, .tb-r button {
    flex: 1 1 auto !important;
    font-size: 11px !important;
    padding: 7px 8px !important;
    min-height: 36px !important;
    white-space: nowrap !important;
    min-width: 0 !important;
  }

  /* PAGE / CONTENT */
  .content, .page {
    padding: 12px 10px !important;
    overflow-x: hidden !important;
    width: 100% !important;
    box-sizing: border-box !important;
    gap: 12px !important;
  }
  .content > *, .page > * {
    box-sizing: border-box !important;
    max-width: 100% !important;
  }

  /* â”€â”€ TOUTES LES GRILLES â†’ 1 COLONNE â”€â”€ */
  /* Dashboard */
  .kpi-grid-4, .kpi-grid-5 { grid-template-columns: 1fr 1fr !important; gap: 8px !important; margin-bottom: 12px !important; }
  .charts-grid, .charts-grid-3 { grid-template-columns: 1fr !important; gap: 12px !important; }
  /* Suivi CA */
  .kpi-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .charts-grid-2 { grid-template-columns: 1fr !important; gap: 12px !important; }
  /* CoÃ»t de revient */
  .fiche-kpis { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .prix-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  /* Marges */
  .decomp-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .cle-grid { grid-template-columns: 1fr !important; gap: 8px !important; }
  .cle-inputs { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .sim-levers { grid-template-columns: 1fr !important; gap: 8px !important; }
  .sim-result-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .modal-row { grid-template-columns: 1fr !important; gap: 8px !important; }
  /* Pilotage */
  .summary-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; margin-bottom: 12px !important; }
  .sections-grid { grid-template-columns: 1fr !important; gap: 12px !important; }
  .tva-result { grid-template-columns: 1fr !important; gap: 8px !important; }
  .cashflow-grid { grid-template-columns: 1fr !important; gap: 8px !important; }
  /* Panier moyen */
  .fields-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .results-row { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .g2, .g3 { grid-template-columns: 1fr !important; gap: 12px !important; }
  .cats { grid-template-columns: 1fr !important; gap: 10px !important; }
  .sim-g { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .sim-rg { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  /* Dettes */
  .detail-grid { grid-template-columns: 1fr !important; gap: 10px !important; }
  .mgrid2 { grid-template-columns: 1fr !important; gap: 10px !important; }
  /* Profil */
  .plan-grid { grid-template-columns: 1fr !important; gap: 12px !important; }
  /* Universels */
  .kpi-row { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .type-grid { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .fact-kpis { grid-template-columns: 1fr 1fr !important; gap: 8px !important; }
  .calendar-grid { grid-template-columns: repeat(4, 1fr) !important; gap: 5px !important; }

  /* â”€â”€ KPI CARDS â€” texte lisible â”€â”€ */
  .kpi-card, .kpi, .summary-card, .fkpi {
    padding: 12px 10px !important;
    overflow: hidden !important;
    min-width: 0 !important;
  }
  .kpi-value, .kpi-val, .summary-value { font-size: 16px !important; letter-spacing: -0.3px !important; }
  .kpi-label, .kpi-lbl, .summary-label { font-size: 9px !important; line-height: 1.3 !important; }
  .kpi-sub { font-size: 10px !important; }

  /* â”€â”€ TABLEAUX â€” scroll interne propre â”€â”€ */
  .echeancier-wrap,
  div[style*="overflow-x"],
  .section-body, .section-content,
  .table-wrap, .table-card, .table-container,
  .card > div { overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; }
  table { min-width: 460px !important; font-size: 11px !important; }
  
  /* â”€â”€ INPUTS TOUCH (Ã©vite zoom iOS) â”€â”€ */
  input[type=text], input[type=number], input[type=email],
  input[type=date], input[type=tel], input[type=password],
  select, textarea {
    font-size: 16px !important;
    -webkit-appearance: none !important;
  }
  .field-wrap, .mfield-wrap, .sim-fw {
    min-height: 46px !important;
    padding: 10px 12px !important;
  }

  /* â”€â”€ BOUTONS â”€â”€ */
  .btn { min-height: 40px !important; }
  .btn-xs, .btn-sm { min-height: 34px !important; }

  /* â”€â”€ PILOTAGE SUMMARY CARDS â”€â”€ */
  .summary-card .kpi-value,
  .summary-card .summary-value { white-space: nowrap !important; overflow: hidden !important; text-overflow: ellipsis !important; }
  .summary-card .kpi-sub,
  .summary-card .summary-sub { white-space: normal !important; font-size: 10px !important; }

  /* â”€â”€ SECTION HEAD â”€â”€ */
  .section-head { flex-wrap: wrap !important; gap: 6px !important; padding: 10px 12px !important; }
  .section-head .btn, .section-head button { font-size: 10px !important; padding: 4px 8px !important; }

  /* â”€â”€ MONTH STRIP (panier moyen) â”€â”€ */
  .month-strip { overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; flex-wrap: nowrap !important; padding-bottom: 6px !important; }
  .mbtn { flex-shrink: 0 !important; }

  /* â”€â”€ YEAR BAR â”€â”€ */
  .yr-bar { overflow-x: auto !important; flex-wrap: nowrap !important; -webkit-overflow-scrolling: touch !important; }
  .yr { flex-shrink: 0 !important; }

  /* â”€â”€ TABS â”€â”€ */
  .tabs { overflow-x: auto !important; -webkit-overflow-scrolling: touch !important; flex-wrap: nowrap !important; width: 100% !important; }
  .tab { flex-shrink: 0 !important; white-space: nowrap !important; }

  /* â”€â”€ DETTE CARDS â”€â”€ */
  .dette-head { flex-wrap: wrap !important; gap: 8px !important; }
  .dette-stats { flex-direction: column !important; align-items: flex-start !important; gap: 4px !important; }

  /* â”€â”€ SAISIE (panier) â”€â”€ */
  .saisie-head { flex-direction: column !important; gap: 8px !important; align-items: flex-start !important; }

  /* â”€â”€ HERO (profil) â”€â”€ */
  .hero { flex-direction: column !important; text-align: center !important; padding: 16px !important; gap: 12px !important; }
  .hero-right { text-align: center !important; }
  .hero-tags { justify-content: center !important; }
  .hero-name { font-size: 17px !important; }

  /* â”€â”€ MODAL â†’ bottom sheet â”€â”€ */
  .overlay, .modal-overlay { align-items: flex-end !important; padding: 0 !important; }
  .modal {
    width: 100% !important; max-width: 100% !important;
    margin: 0 !important;
    border-radius: 18px 18px 0 0 !important;
    max-height: 92vh !important;
  }

  /* â”€â”€ CANVAS â”€â”€ */
  canvas { max-width: 100% !important; }

  /* â”€â”€ CONTEXT BAR (dashboard) â”€â”€ */
  .context-bar { flex-wrap: wrap !important; gap: 8px !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PETIT MOBILE â‰¤420px â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 420px) {
  .kpi-grid-4, .kpi-grid-5, .kpi-grid, .kpi-row,
  .fiche-kpis, .summary-grid, .fact-kpis,
  .type-grid, .results-row, .sim-g { grid-template-columns: 1fr !important; }
  .sim-rg, .sim-result-grid, .cle-inputs { grid-template-columns: 1fr !important; }
  .calendar-grid { grid-template-columns: repeat(3, 1fr) !important; }
}


    .nav-section-label{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 20px 4px}
</style>
</head>
<body>
  <button class="hamburger" id="hamburger" onclick="toggleSidebar()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>
  <div class="nav-overlay" id="navOverlay" onclick="closeSidebar()"></div>
<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="sidebar-logo-icon">ğŸ“Š</div>
    <div class="sidebar-logo-text">ALTEORE</div>
  </div>
  <div class="sidebar-section-label">Principal</div>
  <div class="nav-item" onclick="window.location.href='dashboard.html'"><span class="nav-icon">ğŸ </span><span class="nav-label">Tableau de bord</span></div>
  <div class="nav-item active"><span class="nav-icon">ğŸ“ˆ</span><span class="nav-label">Suivi CA & RÃ©sultats</span></div>
  <div class="nav-item" id="kpis-nav" onclick="toggleMenu('kpis-menu',this)"><span class="nav-icon">ğŸ¯</span><span class="nav-label">KPIs ClÃ©s</span><span class="nav-chevron">â€º</span></div>
  <div class="submenu open" id="kpis-menu">
    <div class="sub-item" onclick="window.location.href='cout-revient.html'"><span class="sub-dot"></span>CoÃ»t de revient</div>
    <div class="sub-item" onclick="window.location.href='marges.html'"><span class="sub-dot"></span>Marge brute & nette</div>
    <div class="sub-item"><span class="sub-dot"></span>Panier moyen</div>
  </div>
  <div class="nav-item" onclick="toggleMenu('pilotage-menu',this)"><span class="nav-icon">ğŸ§­</span><span class="nav-label">Pilotage</span><span class="nav-chevron">â€º</span></div>
  <div class="submenu" id="pilotage-menu">
    <div class="sub-item" onclick="window.location.href='pilotage.html?year=2025'"><span class="sub-dot"></span>Pilotage 2025<span class="sub-year-badge">2025</span></div>
    <div class="sub-item" onclick="window.location.href='pilotage.html?year=2026'"><span class="sub-dot"></span>Pilotage 2026<span class="sub-year-badge">2026</span></div>
    <div class="sub-item" onclick="window.location.href='pilotage.html?year=2027'"><span class="sub-dot"></span>Pilotage 2027<span class="sub-year-badge">2027</span></div>
  </div>
  <div class="nav-item" onclick="location.href='dettes.html'"><span class="nav-icon">ğŸ¦</span><span class="nav-label">Dettes & Emprunts</span></div>
  <div class="nav-section-label">FidÃ©lisation</div>
  <div class="nav-item" onclick="toggleFidNav(this)" style="justify-content:space-between">
    <span style="display:flex;align-items:center;gap:8px"><span class="nav-icon">ğŸ’</span><span class="nav-label">FidÃ©lisation</span></span>
    <span class="nav-chev" style="font-size:11px;color:rgba(255,255,255,.3);transition:transform .25s">â€º</span>
  </div>
  <div class="nav-fid-sub" style="overflow:hidden;max-height:0;transition:max-height .35s ease">
    <div class="nav-sub-item" onclick="location.href='fidelisation.html'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Dashboard fidÃ©litÃ©</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#clients'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Clients</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#carte'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Carte fidÃ©litÃ©</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#points'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Points & RÃ©compenses</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#coupons'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Coupons & Offres</div>
    <div class="nav-sub-item" onclick="location.href='fidelisation.html#campagnes'" style="display:flex;align-items:center;gap:7px;padding:7px 18px 7px 38px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s" onmouseover="this.style.color='rgba(255,255,255,.75)'" onmouseout="this.style.color='rgba(255,255,255,.4)'"><span style="width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25);display:inline-block;flex-shrink:0"></span>Campagnes</div>
  </div>
  <div class="nav-item" onclick="location.href='import.html'" style="border-top:1px solid rgba(255,255,255,.08);padding-top:10px"><span class="nav-icon">ğŸ“¥</span><span class="nav-label">Import de donnÃ©es</span></div>
  <div class="sidebar-footer">
    <div class="user-card" onclick="location.href='profil.html'" style="cursor:pointer;transition:.15s" title="Mon compte">
      <div class="user-avatar" id="userAvatar">A</div>
      <div><div class="user-name" id="userName">Utilisateur</div><div class="user-plan" id="uplan">Plan gratuit</div></div>
      <button class="logout-btn" onclick="handleLogout()">â‹</button>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1 id="topTitle">Suivi CA & RÃ©sultats 2026</h1>
      <p>DonnÃ©es consolidÃ©es depuis le Pilotage mensuel</p>
    </div>
    <div class="topbar-right">
      <select class="year-select" id="yearSelect" onchange="loadYear()">
        <option value="2025">2025</option>
        <option value="2026" selected>2026</option>
        <option value="2027">2027</option>
      </select>
      <button class="btn btn-primary" onclick="loadYear()">ğŸ”„ Actualiser</button>
    </div>
  </div>

  <div class="content" id="mainContent">
    <div class="loader"><div class="spin"></div> Chargement des donnÃ©es...</div>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth = getAuth(app);
  const db = getFirestore(app);
  window._auth=auth; window._db=db; window._doc=doc; window._getDoc=getDoc; window._signOut=signOut;

  onAuthStateChanged(auth, user=>{
    if(!user){window.location.href='index.html';return;}
    window._uid=user.uid;
    const name=user.displayName||user.email.split('@')[0];
    document.getElementById('userName').textContent=name;
    document.getElementById('userAvatar').textContent=name.charAt(0).toUpperCase();
    const urlYear=new URLSearchParams(window.location.search).get('year');
    if(urlYear)document.getElementById('yearSelect').value=urlYear;
    window._firebaseReady = true;
    window.loadYear();
  });
</script>

<script>
const MONTHS=['Janvier','FÃ©vrier','Mars','Avril','Mai','Juin','Juillet','AoÃ»t','Septembre','Octobre','Novembre','DÃ©cembre'];
const MONTHS_SHORT=['Jan','FÃ©v','Mar','Avr','Mai','Juin','Juil','AoÃ»','Sep','Oct','Nov','DÃ©c'];
let _charts=[];

function toggleMenu(id,el){document.getElementById(id).classList.toggle('open');el.classList.toggle('open');}
async function handleLogout(){await window._signOut(window._auth);window.location.href='index.html';}

async function loadYear(_tries){
  _tries = _tries||0;
  const year=parseInt(document.getElementById('yearSelect').value);
  document.getElementById('topTitle').textContent=`Suivi CA & RÃ©sultats ${year}`;
  document.getElementById('mainContent').innerHTML='<div class="loader"><div class="spin"></div> Chargement des donnÃ©es...</div>';

  // Destroy existing charts
  _charts.forEach(c=>{try{c.destroy();}catch(e){}});
  _charts=[];

  if(!window._uid){if(_tries<20){setTimeout(()=>loadYear(_tries+1),300);}return;}
  if(window._userPlan===undefined){
    if(_tries<30){setTimeout(()=>loadYear(_tries+1),100);}
    else{window._userPlan='pro';loadYear(31);}
    return;
  }
  const CAN=['trial','pro','max','master','dev'];
  if(!CAN.includes(window._userPlan)){return;}

  // Load all 12 months
  const months=[];
  for(let m=0;m<12;m++){
    const key=`${year}-${String(m+1).padStart(2,'0')}`;
    try{
      const snap=await window._getDoc(window._doc(window._db,'pilotage',window._uid,'months',key));
      months.push(snap.exists()?snap.data():null);
    }catch(e){months.push(null);}
  }

  // Compute per-month data
  const data=months.map((d,m)=>{
    if(!d)return{caHT:0,caTTC:0,tvaCollectee:0,fixesHT:0,varHT:0,creditsHT:0,leasingHT:0,chargesHT:0,resultat:0,cashflow:0,prevCA:0};
    // CA journalier
    const caHT_j=d.ca?d.ca.reduce((s,r)=>{
      const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;
      const multi=h055+h10+h20;
      return s+(multi>0?multi:(parseFloat(r.montantHT)||0));
    },0):0;
    const caTTC_j=d.ca?d.ca.reduce((s,r)=>{
      const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;
      const multi=h055*1.055+h10*1.10+h20*1.20;
      if(multi>0)return s+multi;
      const h=parseFloat(r.montantHT)||0;return s+h*(1+(r.tvaRate||0)/100);
    },0):0;
    const tva_j=d.ca?d.ca.reduce((s,r)=>{
      const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;
      const multi=h055*0.055+h10*0.10+h20*0.20;
      if(multi>0)return s+multi;
      const h=parseFloat(r.montantHT)||0;return s+h*(r.tvaRate||0)/100;
    },0):0;
    // Factures Pro
    const fp=d.facturesPro||[];
    const caHT_fp=fp.reduce((s,r)=>{const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;return s+h055+h10+h20;},0);
    const caTTC_fp=fp.reduce((s,r)=>{const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;return s+h055*1.055+h10*1.10+h20*1.20;},0);
    const tva_fp=fp.reduce((s,r)=>{const h055=parseFloat(r.ht055)||0,h10=parseFloat(r.ht10)||0,h20=parseFloat(r.ht20)||0;return s+h055*0.055+h10*0.10+h20*0.20;},0);
    const caHT=caHT_j+caHT_fp;
    const caTTC=caTTC_j+caTTC_fp;
    const tvaCollectee=tva_j+tva_fp;
    const rentrees=d.rentreesSupp?d.rentreesSupp.reduce((s,r)=>s+(parseFloat(r.montant)||0),0):0;
    const prevCA=d.previsionCA?d.previsionCA.reduce((s,r)=>s+(parseFloat(r.montant)||0),0):0;
    const fixesHT=d.chargesFixe?d.chargesFixe.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0):0;
    const varHT=d.chargesVar?d.chargesVar.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0):0;
    const leasingHT=d.leasing?d.leasing.reduce((s,r)=>s+(parseFloat(r.montantHT)||0),0):0;
    let creditsHT=0;
    if(d.credits)d.credits.forEach((r,i)=>{
      if(r.ligneType==='principal')creditsHT+=parseFloat(r.montant)||0;
      else{
        let mt=parseFloat(r.montant)||0;
        if(r.tvaAuto&&parseFloat(r.tauxInteret)>0){
          const p=d.credits.slice(0,i).reverse().find(c=>c.fournisseur===r.fournisseur&&c.ligneType==='principal');
          if(p)mt=(parseFloat(p.montant)||0)*parseFloat(r.tauxInteret)/100/12;
        }
        creditsHT+=mt;
      }
    });
    const chargesHT=fixesHT+varHT+creditsHT+leasingHT;
    const resultat=caHT+rentrees-chargesHT;
    const cashflow=caTTC+rentrees-(fixesHT*(1+0.2)+varHT*(1+0.2)+creditsHT+leasingHT*(1+0.2));
    return{caHT,caTTC,tvaCollectee,fixesHT,varHT,creditsHT,leasingHT,chargesHT,resultat,cashflow,prevCA,rentrees};
  });

  // Cumuls
  let cumulCA=0,cumulCharges=0,cumulResultat=0;
  const cumuls=data.map(d=>{
    cumulCA+=d.caHT;cumulCharges+=d.chargesHT;cumulResultat+=d.resultat;
    return{cumulCA,cumulCharges,cumulResultat,diff:cumulCA-cumulCharges};
  });

  // Totaux annuels
  const totCA=data.reduce((s,d)=>s+d.caHT,0);
  const totTTC=data.reduce((s,d)=>s+d.caTTC,0);
  const totCharges=data.reduce((s,d)=>s+d.chargesHT,0);
  const totResultat=data.reduce((s,d)=>s+d.resultat,0);
  const totCashflow=data.reduce((s,d)=>s+d.cashflow,0);
  const totFixes=data.reduce((s,d)=>s+d.fixesHT,0);
  const totVar=data.reduce((s,d)=>s+d.varHT,0);
  const totCredits=data.reduce((s,d)=>s+d.creditsHT,0);
  const totLeasing=data.reduce((s,d)=>s+d.leasingHT,0);
  const hasData=totCA>0||totCharges>0;

  document.getElementById('mainContent').innerHTML=`
    <!-- KPIs ANNUELS -->
    <div class="kpi-grid">
      <div class="kpi-card blue">
        <div class="kpi-label">CA Annuel HT</div>
        <div class="kpi-value">${fmtE(totCA)}</div>
        <div class="kpi-sub">TTC : ${fmtE(totTTC)}</div>
      </div>
      <div class="kpi-card orange">
        <div class="kpi-label">Total Charges HT</div>
        <div class="kpi-value">${fmtE(totCharges)}</div>
        <div class="kpi-sub">Fixes ${fmtE(totFixes)} Â· Var. ${fmtE(totVar)}</div>
      </div>
      <div class="kpi-card ${totResultat>=0?'green':'red'}">
        <div class="kpi-label">RÃ©sultat Annuel HT</div>
        <div class="kpi-value ${totResultat>=0?'positive':'negative'}">${fmtE(totResultat)}</div>
        <div class="kpi-sub">CA âˆ’ DÃ©penses totales</div>
      </div>
      <div class="kpi-card purple">
        <div class="kpi-label">Cashflow Total</div>
        <div class="kpi-value ${totCashflow>=0?'positive':'negative'}">${fmtE(totCashflow)}</div>
        <div class="kpi-sub">Flux de trÃ©sorerie annuel</div>
      </div>
      <div class="kpi-card ${(totResultat/Math.max(totCA,1)*100)>=0?'green':'red'}">
        <div class="kpi-label">Taux de RÃ©sultat</div>
        <div class="kpi-value ${totCA>0?(totResultat/totCA>=0?'positive':'negative'):''}">${totCA>0?fmtPct(totResultat/totCA*100):'â€” %'}</div>
        <div class="kpi-sub">RÃ©sultat / CA HT</div>
      </div>
    </div>

    <!-- TABLEAU CA ANNUEL -->
    <div class="table-section">
      <div class="table-section-head">
        <div class="table-section-title">ğŸ’° CA Annuel <span class="badge badge-blue">${year}</span></div>
      </div>
      <div style="overflow-x:auto">
      <table class="annual-table">
        <thead><tr><th>Mois</th><th>CA HT</th><th>CA TTC</th><th>TVA CollectÃ©e</th><th>RentrÃ©es Supp.</th><th>PrÃ©vision CA</th><th>Ã‰cart PrÃ©vi/RÃ©el</th></tr></thead>
        <tbody>${data.map((d,i)=>`<tr>
          <td>${MONTHS[i]}</td>
          <td>${d.caHT>0?fmtE(d.caHT):'<span class="td-muted">â€”</span>'}</td>
          <td>${d.caTTC>0?fmtE(d.caTTC):'<span class="td-muted">â€”</span>'}</td>
          <td>${d.tvaCollectee>0?fmtE(d.tvaCollectee):'<span class="td-muted">â€”</span>'}</td>
          <td>${d.rentrees>0?fmtE(d.rentrees):'<span class="td-muted">â€”</span>'}</td>
          <td>${d.prevCA>0?fmtE(d.prevCA):'<span class="td-muted">â€”</span>'}</td>
          <td>${d.prevCA>0?`<span class="${(d.caHT-d.prevCA)>=0?'td-positive':'td-negative'}">${fmtE(d.caHT-d.prevCA)}</span>`:'<span class="td-muted">â€”</span>'}</td>
        </tr>`).join('')}</tbody>
        <tfoot><tr><td>TOTAL ANNUEL</td><td>${fmtE(totCA)}</td><td>${fmtE(totTTC)}</td><td>${fmtE(data.reduce((s,d)=>s+d.tvaCollectee,0))}</td><td>${fmtE(data.reduce((s,d)=>s+d.rentrees,0))}</td><td>${fmtE(data.reduce((s,d)=>s+d.prevCA,0))}</td><td class="${(totCA-data.reduce((s,d)=>s+d.prevCA,0))>=0?'td-positive':'td-negative'}">${fmtE(totCA-data.reduce((s,d)=>s+d.prevCA,0))}</td></tr></tfoot>
      </table>
      </div>
    </div>

    <!-- TABLEAU CHARGES -->
    <div class="table-section">
      <div class="table-section-head">
        <div class="table-section-title">ğŸ§¾ Charges & RÃ©sultats par mois <span class="badge badge-orange">${year}</span></div>
      </div>
      <div style="overflow-x:auto">
      <table class="annual-table">
        <thead><tr><th>Mois</th><th>Charges Fixes HT</th><th>Charges Var. HT</th><th>Emprunts/CrÃ©dits</th><th>Leasing HT</th><th>Total Charges HT</th><th>RÃ©sultat HT</th><th>Cashflow</th><th>Cumul CAâˆ’DÃ©p.</th></tr></thead>
        <tbody>${data.map((d,i)=>`<tr>
          <td>${MONTHS[i]}</td>
          <td>${d.fixesHT>0?fmtE(d.fixesHT):'<span class="td-muted">â€”</span>'}</td>
          <td>${d.varHT>0?fmtE(d.varHT):'<span class="td-muted">â€”</span>'}</td>
          <td>${d.creditsHT>0?fmtE(d.creditsHT):'<span class="td-muted">â€”</span>'}</td>
          <td>${d.leasingHT>0?fmtE(d.leasingHT):'<span class="td-muted">â€”</span>'}</td>
          <td>${d.chargesHT>0?fmtE(d.chargesHT):'<span class="td-muted">â€”</span>'}</td>
          <td><span class="${d.resultat>=0?'td-positive':'td-negative'}">${d.caHT>0||d.chargesHT>0?fmtE(d.resultat):'<span class="td-muted">â€”</span>'}</span></td>
          <td><span class="${d.cashflow>=0?'td-positive':'td-negative'}">${d.caHT>0||d.chargesHT>0?fmtE(d.cashflow):'<span class="td-muted">â€”</span>'}</span></td>
          <td><span class="td-cumul">${cumuls[i].diff!==0?fmtE(cumuls[i].diff):'<span class="td-muted">â€”</span>'}</span></td>
        </tr>`).join('')}</tbody>
        <tfoot><tr><td>TOTAL ANNUEL</td><td>${fmtE(totFixes)}</td><td>${fmtE(totVar)}</td><td>${fmtE(totCredits)}</td><td>${fmtE(totLeasing)}</td><td>${fmtE(totCharges)}</td><td class="${totResultat>=0?'td-positive':'td-negative'}">${fmtE(totResultat)}</td><td class="${totCashflow>=0?'td-positive':'td-negative'}">${fmtE(totCashflow)}</td><td class="td-cumul">${fmtE(totCA-totCharges)}</td></tr></tfoot>
      </table>
      </div>
    </div>

    <!-- GRAPHIQUES ROW 1 -->
    <div class="charts-grid-2">
      <div class="chart-card">
        <div class="chart-head"><div><div class="chart-title">ğŸ“ˆ Ã‰volution CA mensuel</div><div class="chart-sub">HT et TTC sur ${year}</div></div></div>
        <div class="chart-wrap h240"><canvas id="chartCA"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-head"><div><div class="chart-title">ğŸ’¹ RÃ©sultat HT par mois</div><div class="chart-sub">CA âˆ’ Total Charges HT</div></div></div>
        <div class="chart-wrap h240"><canvas id="chartResultat"></canvas></div>
      </div>
    </div>

    <!-- GRAPHIQUES ROW 2 -->
    <div class="charts-grid-2">
      <div class="chart-card">
        <div class="chart-head"><div><div class="chart-title">ğŸ“Š RÃ©partition des charges</div><div class="chart-sub">Fixes / Variables / Emprunts / Leasing par mois</div></div></div>
        <div class="chart-wrap h240"><canvas id="chartCharges"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-head"><div><div class="chart-title">ğŸ’° Ã‰volution Cashflow</div><div class="chart-sub">Flux de trÃ©sorerie mensuel ${year}</div></div></div>
        <div class="chart-wrap h240"><canvas id="chartCashflow"></canvas></div>
      </div>
    </div>

    <!-- GRAPHIQUES ROW 3 -->
    <div class="charts-grid-2">
      <div class="chart-card full">
        <div class="chart-head"><div><div class="chart-title">ğŸ”µ CA vs DÃ©penses â€” Comparaison mensuelle</div><div class="chart-sub">DiffÃ©rence CA HT vs Total Charges HT mois par mois</div></div></div>
        <div class="chart-wrap h280"><canvas id="chartDiff"></canvas></div>
      </div>
    </div>

    <!-- GRAPHIQUE CUMUL -->
    <div class="charts-grid-2" style="margin-bottom:0">
      <div class="chart-card full">
        <div class="chart-head"><div><div class="chart-title">ğŸ“‰ Variation RÃ©sultat Annuel cumulÃ©</div><div class="chart-sub">Cumul CA HT âˆ’ Cumul Charges HT au fil des mois</div></div></div>
        <div class="chart-wrap h280"><canvas id="chartCumul"></canvas></div>
      </div>
    </div>
  `;

  // Build charts
  buildCharts(data,cumuls,year);
}

function buildCharts(data,cumuls,year){
  const labels=MONTHS_SHORT;
  const caHT=data.map(d=>d.caHT);
  const caTTC=data.map(d=>d.caTTC);
  const fixesHT=data.map(d=>d.fixesHT);
  const varHT=data.map(d=>d.varHT);
  const creditsHT=data.map(d=>d.creditsHT);
  const leasingHT=data.map(d=>d.leasingHT);
  const chargesHT=data.map(d=>d.chargesHT);
  const resultats=data.map(d=>d.resultat);
  const cashflows=data.map(d=>d.cashflow);
  const cumulDiff=cumuls.map(c=>c.diff);

  const font={size:11,family:'Plus Jakarta Sans'};
  const gridColor='#f1f5f9';
  const tickColor='#9ca3af';

  const baseOpts=(yCallback)=>({
    responsive:true,maintainAspectRatio:false,
    plugins:{legend:{position:'bottom',labels:{font,color:'#6b7280',padding:12,boxWidth:10}}},
    scales:{
      x:{grid:{display:false},ticks:{font,color:tickColor}},
      y:{grid:{color:gridColor},ticks:{font,color:tickColor,callback:yCallback||(v=>fmtK(v))}}
    }
  });

  // CA Chart
  const c1=new Chart(document.getElementById('chartCA'),{
    type:'bar',
    data:{labels,datasets:[
      {label:'CA HT',data:caHT,backgroundColor:'rgba(26,61,206,0.8)',borderRadius:5,order:2},
      {label:'CA TTC',data:caTTC,type:'line',borderColor:'#4f7ef8',borderWidth:2,pointRadius:3,pointBackgroundColor:'#4f7ef8',fill:false,tension:0.4,order:1}
    ]},
    options:baseOpts()
  });
  _charts.push(c1);

  // RÃ©sultat Chart
  const resultColors=resultats.map(v=>v>=0?'rgba(16,185,129,0.8)':'rgba(239,68,68,0.8)');
  const c2=new Chart(document.getElementById('chartResultat'),{
    type:'bar',
    data:{labels,datasets:[{label:'RÃ©sultat HT',data:resultats,backgroundColor:resultColors,borderRadius:5}]},
    options:{...baseOpts(),plugins:{legend:{display:false}}}
  });
  _charts.push(c2);

  // Charges stacked
  const c3=new Chart(document.getElementById('chartCharges'),{
    type:'bar',
    data:{labels,datasets:[
      {label:'Charges Fixes',data:fixesHT,backgroundColor:'rgba(26,61,206,0.85)',borderRadius:3,stack:'charges'},
      {label:'Charges Var.',data:varHT,backgroundColor:'rgba(79,126,248,0.85)',borderRadius:3,stack:'charges'},
      {label:'Emprunts',data:creditsHT,backgroundColor:'rgba(245,158,11,0.85)',borderRadius:3,stack:'charges'},
      {label:'Leasing',data:leasingHT,backgroundColor:'rgba(16,185,129,0.85)',borderRadius:3,stack:'charges'},
    ]},
    options:baseOpts()
  });
  _charts.push(c3);

  // Cashflow
  const cfColors=cashflows.map(v=>v>=0?'rgba(99,102,241,0.8)':'rgba(239,68,68,0.8)');
  const c4=new Chart(document.getElementById('chartCashflow'),{
    type:'bar',
    data:{labels,datasets:[
      {label:'Cashflow',data:cashflows,backgroundColor:cfColors,borderRadius:5},
    ]},
    options:{...baseOpts(),plugins:{legend:{display:false}}}
  });
  _charts.push(c4);

  // CA vs DÃ©penses
  const blueGrad=ctx=>{const g=ctx.createLinearGradient(0,0,0,280);g.addColorStop(0,'rgba(26,61,206,0.15)');g.addColorStop(1,'rgba(26,61,206,0)');return g;};
  const orangeGrad=ctx=>{const g=ctx.createLinearGradient(0,0,0,280);g.addColorStop(0,'rgba(245,158,11,0.15)');g.addColorStop(1,'rgba(245,158,11,0)');return g;};
  const c5ctx=document.getElementById('chartDiff').getContext('2d');
  const c5=new Chart(c5ctx,{
    type:'line',
    data:{labels,datasets:[
      {label:'CA HT',data:caHT,borderColor:'#1a3dce',borderWidth:2.5,backgroundColor:blueGrad(c5ctx),fill:true,tension:0.4,pointRadius:4,pointBackgroundColor:'#1a3dce'},
      {label:'DÃ©penses HT',data:chargesHT,borderColor:'#f59e0b',borderWidth:2.5,backgroundColor:orangeGrad(c5ctx),fill:true,tension:0.4,pointRadius:4,pointBackgroundColor:'#f59e0b'},
    ]},
    options:baseOpts()
  });
  _charts.push(c5);

  // Cumul rÃ©sultat
  const cumulColors=cumulDiff.map(v=>v>=0?'rgba(16,185,129,0.8)':'rgba(239,68,68,0.8)');
  const c6ctx=document.getElementById('chartCumul').getContext('2d');
  const gradCumul=c6ctx.createLinearGradient(0,0,0,280);
  gradCumul.addColorStop(0,'rgba(99,102,241,0.2)');gradCumul.addColorStop(1,'rgba(99,102,241,0)');
  const c6=new Chart(c6ctx,{
    type:'line',
    data:{labels,datasets:[
      {label:'Cumul CA âˆ’ Charges',data:cumulDiff,borderColor:'#6366f1',borderWidth:2.5,backgroundColor:gradCumul,fill:true,tension:0.4,pointRadius:4,pointBackgroundColor:cumulColors},
    ]},
    options:baseOpts()
  });
  _charts.push(c6);
}

function fmtE(n){return (parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' â‚¬';}
function fmtK(v){const n=parseFloat(v)||0;return Math.abs(n)>=1000?(n/1000).toFixed(1)+'kâ‚¬':n.toFixed(0)+'â‚¬';}
function fmtPct(n){return (parseFloat(n)||0).toFixed(1)+'%';}

window.loadYear=loadYear;
window.toggleMenu=toggleMenu;
window.handleLogout=handleLogout;
</script>

<script>
function toggleNav(subId, el) {
  const sub = document.getElementById(subId);
  const isOpen = sub.classList.contains('open');
  sub.classList.toggle('open');
  // rotate chevron
  const chevId = subId === 'kpis-sub' ? 'chev-kpis' : 'chev-pil';
  const chev = document.getElementById(chevId);
  if (chev) chev.style.transform = isOpen ? '' : 'rotate(90deg)';
}
function activatePage(pageId, openSub) {
  const el = document.getElementById(pageId);
  if (el) el.classList.add('on');
  if (openSub) {
    const sub = document.getElementById(openSub);
    if (sub) sub.classList.add('open');
    const chevId = openSub === 'kpis-sub' ? 'chev-kpis' : 'chev-pil';
    const chev = document.getElementById(chevId);
    if (chev) chev.style.transform = 'rotate(90deg)';
  }
}
</script>
<script>document.addEventListener('DOMContentLoaded',()=>activatePage('nav-suivi',null));</script>



<script>
(function(){
  function toggleSidebar(){
    var nav = document.querySelector('nav, aside.sidebar, .sidebar');
    var btn = document.getElementById('hamburger');
    var overlay = document.getElementById('navOverlay');
    var isOpen = nav.classList.contains('open');
    if(isOpen){ closeSidebar(); return; }
    nav.classList.add('open');
    btn.classList.add('open');
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';
  }
  function closeSidebar(){
    var nav = document.querySelector('nav, aside.sidebar, .sidebar');
    var btn = document.getElementById('hamburger');
    var overlay = document.getElementById('navOverlay');
    nav.classList.remove('open');
    btn.classList.remove('open');
    overlay.classList.remove('show');
    document.body.style.overflow = '';
  }
  window.toggleSidebar = toggleSidebar;
  window.closeSidebar = closeSidebar;
  document.addEventListener('DOMContentLoaded', function(){
    var nav = document.querySelector('nav, aside.sidebar, .sidebar');
    if(!nav) return;
    nav.querySelectorAll('.ni, .si, .nav-item, .sub-item').forEach(function(el){
      el.addEventListener('click', function(){
        if(window.innerWidth <= 768) closeSidebar();
      });
    });
  });
})();
</script>
<script>
(function(){
  function getSidebar(){ return document.querySelector('nav, aside.sidebar, .sidebar'); }
  function toggleSidebar(){
    var s=getSidebar(), b=document.getElementById('hamburger'), o=document.getElementById('navOverlay');
    var open=s.classList.contains('open');
    s.classList.toggle('open',!open); b.classList.toggle('open',!open);
    o.classList.toggle('show',!open);
    document.body.style.overflow = open ? '' : 'hidden';
  }
  function closeSidebar(){
    var s=getSidebar(), b=document.getElementById('hamburger'), o=document.getElementById('navOverlay');
    s.classList.remove('open'); b.classList.remove('open'); o.classList.remove('show');
    document.body.style.overflow='';
  }
  window.toggleSidebar=toggleSidebar; window.closeSidebar=closeSidebar;
  document.addEventListener('DOMContentLoaded',function(){
    var s=getSidebar(); if(!s) return;
    s.querySelectorAll('.ni,.si,.nav-item,.sub-item').forEach(function(el){
      el.addEventListener('click',function(){ if(window.innerWidth<=768) closeSidebar(); });
    });
  });
})();
</script>
<script>
function toggleFidNav(el){
  var sub=el.nextElementSibling;
  var chev=el.querySelector('.nav-chev');
  var open=sub.style.maxHeight&&sub.style.maxHeight!=='0px';
  sub.style.maxHeight=open?'0px':'300px';
  if(chev)chev.style.transform=open?'':'rotate(90deg)';
}
</script>
<script src="nav.js"></script>
</body>
</html>
