<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <title>ALTEORE ‚Äî Recrutement</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --rh-dark:#052e16;--rh-main:#059669;--rh-light:#10b981;--rh-bright:#34d399;
      --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f0fdf7;--radius:12px;
      --red:#ef4444;--red-light:#fee2e2;--orange:#f59e0b;--orange-light:#fef3c7;
      --blue:#1a3dce;--purple:#6366f1;--sidebar-w:250px;
    }
    html,body{overflow-x:hidden;max-width:100vw;}
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-width:0;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:17px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .topbar-left p{font-size:12px;color:var(--muted);margin-top:2px;}
    .topbar-right{display:flex;align-items:center;gap:10px;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;gap:6px;}
    .btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-light));color:white;box-shadow:0 3px 10px rgba(5,150,105,.3);}
    .btn-rh:hover{opacity:.9;transform:translateY(-1px);}
    .btn-outline{background:white;color:var(--rh-main);border:1.5px solid var(--rh-border);}
    .btn-outline:hover{background:var(--rh-ghost);}
    .btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}
    .btn-sm{padding:6px 12px;font-size:12px;}
    .btn-xs{padding:3px 9px;font-size:11px;}
    .content{padding:22px 28px;flex:1;display:flex;flex-direction:column;gap:20px;}
    /* TABS */
    .tabs-bar{display:flex;gap:4px;background:white;border:1px solid var(--border);border-radius:10px;padding:5px;width:fit-content;flex-wrap:wrap;}
    .tab-btn{padding:7px 16px;border-radius:7px;border:none;background:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;transition:all .18s;white-space:nowrap;}
    .tab-btn.on{background:linear-gradient(135deg,var(--rh-main),var(--rh-light));color:white;box-shadow:0 2px 8px rgba(5,150,105,.3);}
    .tab-btn:hover:not(.on){background:var(--rh-ghost);color:var(--rh-main);}
    .tab-panel{display:none;}
    .tab-panel.on{display:flex;flex-direction:column;gap:18px;}
    /* KPI */
    .kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;}
    .kpi-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;position:relative;overflow:hidden;transition:box-shadow .2s;}
    .kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--rh-main),var(--rh-bright));}
    .kpi-card.orange::before{background:linear-gradient(90deg,#f59e0b,#fbbf24);}
    .kpi-card.red::before{background:linear-gradient(90deg,#ef4444,#f87171);}
    .kpi-card.blue::before{background:linear-gradient(90deg,#1a3dce,#4f7ef8);}
    .kpi-card.purple::before{background:linear-gradient(90deg,#6366f1,#a5b4fc);}
    .kpi-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.6px;margin-bottom:5px;}
    .kpi-val{font-size:24px;font-weight:800;color:var(--text);line-height:1;}
    .kpi-sub{font-size:11px;color:var(--muted);margin-top:5px;}
    /* CARDS */
    .card{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:#fafffe;}
    .card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px;}
    .card-body{padding:16px 18px;}
    /* PIPELINE */
    .pipeline-wrap{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;min-height:400px;}
    .pipeline-col{background:#f8faff;border:1px solid var(--border);border-radius:10px;padding:12px;display:flex;flex-direction:column;gap:8px;min-width:0;}
    .pipeline-col-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;}
    .pipeline-col-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;}
    .pipeline-badge{font-size:11px;font-weight:800;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
    .pipeline-card{background:white;border:1px solid var(--border);border-radius:8px;padding:10px 12px;cursor:pointer;transition:all .18s;}
    .pipeline-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.08);transform:translateY(-1px);}
    .pipeline-card-name{font-size:12px;font-weight:700;margin-bottom:2px;}
    .pipeline-card-poste{font-size:11px;color:var(--muted);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .pipeline-card-foot{display:flex;align-items:center;justify-content:space-between;}
    .pipeline-card-date{font-size:10px;color:var(--muted);}
    .pipeline-card-score{font-size:11px;font-weight:700;padding:2px 7px;border-radius:20px;}
    .score-high{background:#d1fae5;color:#065f46;}
    .score-mid{background:#fef3c7;color:#92400e;}
    .score-low{background:#fee2e2;color:#991b1b;}
    .drag-over{background:#f0fdf4!important;border-color:var(--rh-light)!important;box-shadow:inset 0 0 0 2px var(--rh-light)!important;}
    /* CANDIDATS TABLE */
    .candidat-table{width:100%;border-collapse:collapse;}
    .candidat-table th{padding:9px 14px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;background:#f8fffe;border-bottom:1px solid var(--border);}
    .candidat-table td{padding:10px 14px;border-bottom:1px solid #f1f5f9;vertical-align:middle;}
    .candidat-table tr:hover td{background:#fafffe;}
    .c-av{width:32px;height:32px;border-radius:9px;background:linear-gradient(135deg,var(--rh-main),var(--rh-bright));display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:white;flex-shrink:0;}
    .c-name{font-size:12px;font-weight:700;}
    .c-sub{font-size:11px;color:var(--muted);}
    .status-badge{font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;white-space:nowrap;display:inline-block;}
    .st-nouveau{background:#e0f2fe;color:#0369a1;}
    .st-screening{background:#ede9fe;color:#6d28d9;}
    .st-entretien{background:#fef3c7;color:#92400e;}
    .st-test{background:#fff7ed;color:#c2410c;}
    .st-offre{background:#d1fae5;color:#065f46;}
    .st-rejete{background:#fee2e2;color:#991b1b;}
    .st-embauche{background:#d1fae5;color:#065f46;}
    /* OFFRES */
    .offre-card{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;display:flex;align-items:flex-start;gap:16px;transition:box-shadow .2s;}
    .offre-card:hover{box-shadow:0 4px 20px rgba(5,150,105,.1);}
    .offre-icon{width:44px;height:44px;border-radius:10px;background:var(--rh-ghost);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
    .offre-body{flex:1;min-width:0;}
    .offre-title{font-size:14px;font-weight:700;margin-bottom:4px;}
    .offre-tags{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;}
    .offre-tag{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;background:#f1f5f9;color:var(--muted);}
    .offre-tag.green{background:var(--rh-ghost);color:var(--rh-main);}
    .offre-tag.blue{background:#e0f2fe;color:#0369a1;}
    .offre-stats{display:flex;gap:16px;flex-wrap:wrap;}
    .offre-stat{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:4px;}
    .offre-stat span{font-weight:700;color:var(--text);}
    .offre-actions{display:flex;flex-direction:column;gap:6px;align-items:flex-end;flex-shrink:0;}
    .offre-status{font-size:11px;font-weight:700;padding:3px 10px;border-radius:20px;}
    .offre-active{background:#d1fae5;color:#065f46;}
    .offre-pause{background:#fef3c7;color:#92400e;}
    .offre-closed{background:#f1f5f9;color:var(--muted);}
    /* ENTRETIENS */
    .entretien-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #f1f5f9;}
    .entretien-row:last-child{border-bottom:none;}
    .entretien-time{flex-shrink:0;text-align:center;background:var(--rh-ghost);border-radius:8px;padding:6px 10px;min-width:64px;}
    .entretien-time-h{font-size:15px;font-weight:800;color:var(--rh-main);}
    .entretien-time-d{font-size:10px;color:var(--muted);}
    .entretien-info{flex:1;min-width:0;}
    .entretien-name{font-size:12px;font-weight:700;}
    .entretien-poste{font-size:11px;color:var(--muted);}
    .entretien-type{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;background:#ede9fe;color:#6d28d9;}
    /* ANALYTICS */
    .analytics-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
    .funnel-wrap{display:flex;flex-direction:column;gap:8px;}
    .funnel-row{display:flex;align-items:center;gap:12px;}
    .funnel-label{width:130px;font-size:12px;font-weight:600;flex-shrink:0;}
    .funnel-bar-bg{flex:1;height:28px;background:#f1f5f9;border-radius:8px;overflow:hidden;}
    .funnel-bar-fill{height:100%;border-radius:8px;display:flex;align-items:center;padding:0 10px;transition:width .6s ease;}
    .funnel-bar-text{font-size:11px;font-weight:700;color:white;white-space:nowrap;}
    .funnel-count{width:32px;text-align:right;font-size:13px;font-weight:800;}
    .funnel-pct{width:36px;text-align:right;font-size:11px;color:var(--muted);}
    .source-list{display:flex;flex-direction:column;gap:8px;}
    .source-row{display:flex;align-items:center;gap:10px;}
    .source-name{width:110px;font-size:12px;font-weight:600;}
    .source-bar-bg{flex:1;height:10px;background:#f1f5f9;border-radius:99px;overflow:hidden;}
    .source-bar-fill{height:100%;border-radius:99px;transition:width .5s ease;}
    .source-num{width:32px;text-align:right;font-size:12px;font-weight:700;}
    /* SCORE GRID */
    .score-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:5px;margin-bottom:10px;}
    .score-btn{padding:7px 4px;border:2px solid var(--border);border-radius:7px;background:white;cursor:pointer;text-align:center;font-size:12px;font-weight:700;transition:all .15s;font-family:'Plus Jakarta Sans',sans-serif;}
    .score-btn:hover{border-color:var(--rh-main);background:var(--rh-ghost);}
    .score-btn.on{border-color:var(--rh-main);background:var(--rh-main);color:white;}
    /* NOTES */
    .note-item{padding:10px 12px;border-radius:8px;background:#f8faff;border:1px solid var(--border);margin-bottom:8px;}
    .note-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;}
    .note-author{font-size:11px;font-weight:700;}
    .note-date{font-size:10px;color:var(--muted);}
    .note-text{font-size:12px;line-height:1.5;}
    /* SOURCE BADGE */
    .src-linkedin{background:#dbeafe;color:#1d4ed8;}
    .src-indeed{background:#fef9c3;color:#854d0e;}
    .src-cooptation{background:#d1fae5;color:#065f46;}
    .src-spontanee{background:#f3e8ff;color:#6b21a8;}
    .src-autre{background:#f1f5f9;color:var(--muted);}
    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(5,46,22,.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;width:100%;max-width:680px;box-shadow:0 24px 60px rgba(5,46,22,.2);overflow:hidden;max-height:92vh;display:flex;flex-direction:column;}
    .modal-head{padding:18px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
    .modal-head h3{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);}
    .modal-body{padding:20px 24px;overflow-y:auto;flex:1;}
    .modal-foot{padding:14px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end;flex-shrink:0;}
    .modal-field{margin-bottom:14px;}
    .modal-label{font-size:12px;font-weight:600;color:var(--muted);margin-bottom:5px;display:block;}
    .modal-input{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;}
    .modal-input:focus{border-color:var(--rh-main);}
    .modal-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .modal-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    textarea.modal-input{min-height:80px;resize:vertical;}
    .modal-section{font-size:12px;font-weight:700;color:var(--text);border-top:1px solid var(--border);padding-top:14px;margin-top:14px;margin-bottom:10px;}
    /* DETAIL */
    .detail-modal{max-width:820px!important;}
    .cand-hero{background:linear-gradient(135deg,var(--rh-main),#064e3b);border-radius:12px;padding:20px;color:white;display:flex;align-items:center;gap:16px;margin-bottom:18px;}
    .cand-av{width:56px;height:56px;border-radius:14px;background:rgba(255,255,255,.2);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;flex-shrink:0;}
    .cand-hero-name{font-size:20px;font-weight:800;}
    .cand-hero-poste{font-size:13px;opacity:.75;margin-bottom:6px;}
    .cand-hero-tags{display:flex;gap:6px;flex-wrap:wrap;}
    .cand-hero-tag{font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;background:rgba(255,255,255,.18);}
    .cand-score-display{margin-left:auto;text-align:center;flex-shrink:0;}
    .cand-score-num{font-size:36px;font-weight:800;line-height:1;}
    .cand-score-lbl{font-size:10px;opacity:.7;text-transform:uppercase;letter-spacing:.5px;}
    .cand-tabs{display:flex;gap:2px;margin-bottom:16px;border-bottom:2px solid var(--border);}
    .cand-tab{padding:8px 16px;background:none;border:none;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;transition:.15s;}
    .cand-tab.on{color:var(--rh-main);border-bottom-color:var(--rh-main);}
    .cand-panel{display:none;}
    .cand-panel.on{display:block;}
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
    .info-item{padding:10px 12px;background:#f8fffe;border-radius:8px;border:1px solid var(--rh-border);}
    .info-item-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:2px;}
    .info-item-val{font-size:13px;font-weight:600;}
    .competence-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px;}
    .competence-tag{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;background:var(--rh-ghost);color:var(--rh-main);border:1px solid var(--rh-border);}
    .timeline-wrap{position:relative;padding-left:24px;}
    .timeline-wrap::before{content:'';position:absolute;left:7px;top:0;bottom:0;width:2px;background:var(--rh-border);}
    .timeline-item{position:relative;margin-bottom:14px;}
    .timeline-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--rh-main);background:white;position:absolute;left:-24px;top:2px;}
    .timeline-item.done .timeline-dot{background:var(--rh-main);}
    .timeline-head{font-size:12px;font-weight:700;}
    .timeline-sub{font-size:11px;color:var(--muted);}
    /* EMPTY */
    .empty-col{text-align:center;padding:20px 8px;color:var(--muted);}
    .empty-col-icon{font-size:24px;margin-bottom:4px;}
    .empty-col-text{font-size:11px;}
    /* LOADER */
    .loader{display:flex;align-items:center;justify-content:center;padding:60px;color:var(--muted);gap:10px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--rh-main);border-radius:50%;animation:spin .7s linear infinite;}
    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.ok{background:var(--rh-main);}
    @media(max-width:768px){
      .main{margin-left:0!important;width:100vw!important;}
      .topbar{padding:10px 10px 10px 62px!important;}
      .content{padding:12px 10px!important;}
      .kpi-row{grid-template-columns:1fr 1fr!important;gap:8px!important;}
      .pipeline-wrap{grid-template-columns:1fr 1fr!important;}
      .analytics-grid{grid-template-columns:1fr!important;}
      .modal-row,.modal-row-3{grid-template-columns:1fr!important;}
      .modal{max-width:100%!important;border-radius:18px 18px 0 0!important;}
      .modal-overlay{align-items:flex-end!important;}
      input,select,textarea{font-size:16px!important;}
      .score-grid{grid-template-columns:repeat(5,1fr)!important;}
    }
    @media(max-width:480px){
      .kpi-row{grid-template-columns:1fr!important;}
      .pipeline-wrap{grid-template-columns:1fr!important;}
    }
  </style>
</head>
<body>
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>üéØ Recrutement</h1>
      <p>Pipeline candidats ¬∑ Offres d'emploi ¬∑ Entretiens ¬∑ D√©cisions</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="openModal('modal-offre')">üìã Nouvelle offre</button>
      <button class="btn btn-rh btn-sm" onclick="openModal('modal-candidat')">+ Ajouter un candidat</button>
    </div>
  </div>

  <div class="content">
    <!-- KPI ROW -->
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">Candidatures actives</div>
        <div class="kpi-val" id="kpi-actifs">‚Äî</div>
        <div class="kpi-sub" id="kpi-actifs-sub">En cours de traitement</div>
      </div>
      <div class="kpi-card blue">
        <div class="kpi-label">Offres ouvertes</div>
        <div class="kpi-val" id="kpi-offres">‚Äî</div>
        <div class="kpi-sub" id="kpi-offres-sub">Postes √† pourvoir</div>
      </div>
      <div class="kpi-card orange">
        <div class="kpi-label">Entretiens ce mois</div>
        <div class="kpi-val" id="kpi-entretiens">‚Äî</div>
        <div class="kpi-sub">Planifi√©s &amp; pass√©s</div>
      </div>
      <div class="kpi-card purple">
        <div class="kpi-label">D√©lai moyen</div>
        <div class="kpi-val" id="kpi-delai">‚Äî</div>
        <div class="kpi-sub">Jours candidature ‚Üí offre</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Taux conversion</div>
        <div class="kpi-val" id="kpi-taux">‚Äî</div>
        <div class="kpi-sub">Candidats ‚Üí Embauch√©s</div>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs-bar">
      <button class="tab-btn on" onclick="switchTab('pipeline',this)">üóÇ Pipeline</button>
      <button class="tab-btn" onclick="switchTab('candidats',this)">üë§ Candidats</button>
      <button class="tab-btn" onclick="switchTab('offres',this)">üìã Offres</button>
      <button class="tab-btn" onclick="switchTab('entretiens',this)">üóì Entretiens</button>
      <button class="tab-btn" onclick="switchTab('analytics',this)">üìä Analytics</button>
    </div>

    <!-- PIPELINE -->
    <div class="tab-panel on" id="tab-pipeline">
      <div class="card">
        <div class="card-head">
          <div class="card-title">üóÇ Pipeline de recrutement <span style="font-size:11px;color:var(--muted);font-weight:400;margin-left:6px">Glissez-d√©posez pour changer le statut</span></div>
          <div style="display:flex;gap:8px;align-items:center">
            <select class="modal-input" id="pipeline-filter-offre" style="width:180px;padding:5px 10px;font-size:12px" onchange="renderPipeline()">
              <option value="">Toutes les offres</option>
            </select>
            <button class="btn btn-outline btn-xs" onclick="renderPipeline()">üîÑ Actualiser</button>
          </div>
        </div>
        <div style="padding:16px;overflow-x:auto;">
          <div class="pipeline-wrap" id="pipeline-board" style="min-width:900px;"></div>
        </div>
      </div>
    </div>

    <!-- CANDIDATS -->
    <div class="tab-panel" id="tab-candidats">
      <div class="card">
        <div class="card-head">
          <div class="card-title">üë§ Tous les candidats</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input type="text" class="modal-input" id="search-candidat" placeholder="üîç Rechercher..." style="width:200px;padding:5px 10px;font-size:12px" oninput="renderCandidatTable()"/>
            <select class="modal-input" id="filter-statut" style="width:150px;padding:5px 10px;font-size:12px" onchange="renderCandidatTable()">
              <option value="">Tous les statuts</option>
              <option value="nouveau">Nouveau</option>
              <option value="screening">Screening</option>
              <option value="entretien">Entretien</option>
              <option value="test">Test technique</option>
              <option value="offre">Offre envoy√©e</option>
              <option value="embauche">Embauch√©</option>
              <option value="rejete">Rejet√©</option>
            </select>
            <select class="modal-input" id="filter-offre" style="width:180px;padding:5px 10px;font-size:12px" onchange="renderCandidatTable()">
              <option value="">Toutes les offres</option>
            </select>
          </div>
        </div>
        <div style="overflow-x:auto">
          <table class="candidat-table">
            <thead><tr>
              <th>Candidat</th><th>Poste</th><th>Statut</th><th>Source</th>
              <th>Score</th><th>Candidature</th><th>Priorit√©</th><th>Actions</th>
            </tr></thead>
            <tbody id="candidat-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- OFFRES -->
    <div class="tab-panel" id="tab-offres">
      <div id="offres-list" style="display:flex;flex-direction:column;gap:12px;"></div>
    </div>

    <!-- ENTRETIENS -->
    <div class="tab-panel" id="tab-entretiens">
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:18px;">
        <div class="card">
          <div class="card-head">
            <div class="card-title">üóì Entretiens planifi√©s</div>
            <button class="btn btn-outline btn-xs" onclick="openModal('modal-entretien')">+ Planifier</button>
          </div>
          <div class="card-body" id="entretiens-list"><div class="loader"><div class="spin"></div></div></div>
        </div>
        <div class="card">
          <div class="card-head"><div class="card-title">‚úÖ Cette semaine</div></div>
          <div class="card-body" id="entretiens-todo"></div>
        </div>
      </div>
    </div>

    <!-- ANALYTICS -->
    <div class="tab-panel" id="tab-analytics">
      <div class="kpi-row" style="grid-template-columns:repeat(4,1fr)">
        <div class="kpi-card"><div class="kpi-label">Total candidatures</div><div class="kpi-val" id="ana-total">0</div><div class="kpi-sub">Toutes p√©riodes</div></div>
        <div class="kpi-card orange"><div class="kpi-label">Rejet√©s</div><div class="kpi-val" id="ana-rejete">0</div><div class="kpi-sub" id="ana-rejete-pct">‚Äî</div></div>
        <div class="kpi-card"><div class="kpi-label">Embauch√©s</div><div class="kpi-val" id="ana-embauche">0</div><div class="kpi-sub" id="ana-embauche-pct">‚Äî</div></div>
        <div class="kpi-card blue"><div class="kpi-label">Score moyen</div><div class="kpi-val" id="ana-score">‚Äî</div><div class="kpi-sub">Sur 10 points</div></div>
      </div>
      <div class="analytics-grid">
        <div class="card">
          <div class="card-head"><div class="card-title">üìä Entonnoir de conversion</div></div>
          <div class="card-body" id="funnel-wrap"></div>
        </div>
        <div class="card">
          <div class="card-head"><div class="card-title">üì° Sources de candidatures</div></div>
          <div class="card-body" id="sources-wrap"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-head"><div class="card-title">‚è± Dur√©e par √©tape (jours moyens estim√©s)</div></div>
        <div class="card-body" id="duree-wrap" style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;"></div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL CANDIDAT -->
<div class="modal-overlay" id="modal-candidat">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modal-candidat-title">+ Nouveau candidat</h3>
      <button class="modal-close" onclick="closeModal('modal-candidat')">&#x2715;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="mc-id"/>
      <div class="modal-row">
        <div class="modal-field"><label class="modal-label">Pr√©nom *</label><input class="modal-input" id="mc-prenom" placeholder="Marie"/></div>
        <div class="modal-field"><label class="modal-label">Nom *</label><input class="modal-input" id="mc-nom" placeholder="Dupont"/></div>
      </div>
      <div class="modal-row">
        <div class="modal-field"><label class="modal-label">Email</label><input class="modal-input" id="mc-email" type="email" placeholder="marie.dupont@email.com"/></div>
        <div class="modal-field"><label class="modal-label">T√©l√©phone</label><input class="modal-input" id="mc-tel" placeholder="06 12 34 56 78"/></div>
      </div>
      <div class="modal-row">
        <div class="modal-field"><label class="modal-label">Poste souhait√©</label>
          <select class="modal-input" id="mc-offre"><option value="">--- S√©lectionner une offre ---</option></select>
        </div>
        <div class="modal-field"><label class="modal-label">Source</label>
          <select class="modal-input" id="mc-source">
            <option value="linkedin">LinkedIn</option><option value="indeed">Indeed</option>
            <option value="cooptation">Cooptation</option><option value="spontanee">Candidature spontan√©e</option>
            <option value="pole-emploi">France Travail</option><option value="autre">Autre</option>
          </select>
        </div>
      </div>
      <div class="modal-row">
        <div class="modal-field"><label class="modal-label">Statut</label>
          <select class="modal-input" id="mc-statut">
            <option value="nouveau">Nouveau</option><option value="screening">Screening</option>
            <option value="entretien">Entretien</option><option value="test">Test technique</option>
            <option value="offre">Offre envoy√©e</option><option value="embauche">Embauch√©</option><option value="rejete">Rejet√©</option>
          </select>
        </div>
        <div class="modal-field"><label class="modal-label">Priorit√©</label>
          <select class="modal-input" id="mc-priorite">
            <option value="haute">üî¥ Haute</option><option value="normale" selected>üü° Normale</option><option value="basse">‚ö´ Basse</option>
          </select>
        </div>
      </div>
      <div class="modal-section">üìã Profil</div>
      <div class="modal-row">
        <div class="modal-field"><label class="modal-label">Exp√©rience (ann√©es)</label><input class="modal-input" id="mc-exp" type="text" inputmode="decimal" placeholder="3"/></div>
        <div class="modal-field"><label class="modal-label">Pr√©tentions salariales (‚Ç¨/an)</label><input class="modal-input" id="mc-salaire" type="text" inputmode="decimal" placeholder="32000"/></div>
      </div>
      <div class="modal-field"><label class="modal-label">Comp√©tences cl√©s (s√©par√©es par des virgules)</label><input class="modal-input" id="mc-competences" placeholder="JavaScript, React, Gestion de projet..."/></div>
      <div class="modal-field"><label class="modal-label">Lien CV / Portfolio</label><input class="modal-input" id="mc-cv" placeholder="https://..."/></div>
      <div class="modal-section">‚≠ê √âvaluation</div>
      <div class="modal-label">Score global (1‚Äì10)</div>
      <div class="score-grid" id="score-grid">
        <button class="score-btn" onclick="setScore(1)">1</button><button class="score-btn" onclick="setScore(2)">2</button>
        <button class="score-btn" onclick="setScore(3)">3</button><button class="score-btn" onclick="setScore(4)">4</button>
        <button class="score-btn" onclick="setScore(5)">5</button><button class="score-btn" onclick="setScore(6)">6</button>
        <button class="score-btn" onclick="setScore(7)">7</button><button class="score-btn" onclick="setScore(8)">8</button>
        <button class="score-btn" onclick="setScore(9)">9</button><button class="score-btn" onclick="setScore(10)">10</button>
      </div>
      <input type="hidden" id="mc-score" value="0"/>
      <div class="modal-field" style="margin-top:12px"><label class="modal-label">Notes / Observations</label>
        <textarea class="modal-input" id="mc-notes" placeholder="Points forts, points faibles..."></textarea>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modal-candidat')">Annuler</button>
      <button class="btn btn-rh" onclick="saveCandidat()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL OFFRE -->
<div class="modal-overlay" id="modal-offre">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modal-offre-title">üìã Nouvelle offre d'emploi</h3>
      <button class="modal-close" onclick="closeModal('modal-offre')">&#x2715;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="mo-id"/>
      <div class="modal-row">
        <div class="modal-field"><label class="modal-label">Intitul√© du poste *</label><input class="modal-input" id="mo-titre" placeholder="D√©veloppeur web full-stack"/></div>
        <div class="modal-field"><label class="modal-label">D√©partement / Service</label><input class="modal-input" id="mo-dept" placeholder="Tech, Commerce, RH..."/></div>
      </div>
      <div class="modal-row-3">
        <div class="modal-field"><label class="modal-label">Type de contrat</label>
          <select class="modal-input" id="mo-contrat">
            <option>CDI</option><option>CDD</option><option>Alternance</option><option>Stage</option><option>Freelance</option><option>Int√©rim</option>
          </select>
        </div>
        <div class="modal-field"><label class="modal-label">Lieu</label><input class="modal-input" id="mo-lieu" placeholder="Lyon, t√©l√©travail..."/></div>
        <div class="modal-field"><label class="modal-label">Salaire (‚Ç¨/an brut)</label><input class="modal-input" id="mo-salaire" type="text" inputmode="decimal" placeholder="30000‚Äì40000"/></div>
      </div>
      <div class="modal-row">
        <div class="modal-field"><label class="modal-label">Date d'ouverture</label><input class="modal-input" id="mo-dateouv" type="date"/></div>
        <div class="modal-field"><label class="modal-label">Date de cl√¥ture souhait√©e</label><input class="modal-input" id="mo-dateclo" type="date"/></div>
      </div>
      <div class="modal-row">
        <div class="modal-field"><label class="modal-label">Nb postes</label><input class="modal-input" id="mo-nb" type="text" inputmode="decimal" placeholder="1"/></div>
        <div class="modal-field"><label class="modal-label">Statut</label>
          <select class="modal-input" id="mo-statut">
            <option value="active">üü¢ Active</option><option value="pause">‚è∏ En pause</option><option value="closed">üî¥ Ferm√©e</option>
          </select>
        </div>
      </div>
      <div class="modal-field"><label class="modal-label">Description du poste</label><textarea class="modal-input" id="mo-desc" rows="4" placeholder="Missions, responsabilit√©s, profil recherch√©..."></textarea></div>
      <div class="modal-field"><label class="modal-label">Comp√©tences requises</label><input class="modal-input" id="mo-competences" placeholder="JavaScript, Gestion de projet..."/></div>
      <div class="modal-field"><label class="modal-label">Emoji</label><input class="modal-input" id="mo-emoji" placeholder="üíº" maxlength="2"/></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-danger btn-sm" id="mo-btn-delete" style="display:none;margin-right:auto" onclick="deleteOffre()">üóë Supprimer</button>
      <button class="btn btn-outline" onclick="closeModal('modal-offre')">Annuler</button>
      <button class="btn btn-rh" onclick="saveOffre()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL ENTRETIEN -->
<div class="modal-overlay" id="modal-entretien">
  <div class="modal">
    <div class="modal-head">
      <h3>üóì Planifier un entretien</h3>
      <button class="modal-close" onclick="closeModal('modal-entretien')">&#x2715;</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="me-id"/>
      <div class="modal-row">
        <div class="modal-field"><label class="modal-label">Candidat *</label>
          <select class="modal-input" id="me-candidat"><option value="">--- S√©lectionner ---</option></select>
        </div>
        <div class="modal-field"><label class="modal-label">Type</label>
          <select class="modal-input" id="me-type">
            <option value="telephone">üìû T√©l√©phonique</option><option value="visio">üíª Visioconf√©rence</option>
            <option value="presentiel">üè¢ Pr√©sentiel</option><option value="technique">üß™ Technique</option>
            <option value="rh">üë• RH</option><option value="direction">‚≠ê Direction</option>
          </select>
        </div>
      </div>
      <div class="modal-row">
        <div class="modal-field"><label class="modal-label">Date *</label><input class="modal-input" id="me-date" type="date"/></div>
        <div class="modal-field"><label class="modal-label">Heure</label><input class="modal-input" id="me-heure" type="time"/></div>
      </div>
      <div class="modal-row">
        <div class="modal-field"><label class="modal-label">Dur√©e (min)</label><input class="modal-input" id="me-duree" type="text" inputmode="decimal" placeholder="60"/></div>
        <div class="modal-field"><label class="modal-label">Intervieweur(s)</label><input class="modal-input" id="me-interviewer" placeholder="Pr√©nom Nom"/></div>
      </div>
      <div class="modal-field"><label class="modal-label">Lieu / Lien visio</label><input class="modal-input" id="me-lieu" placeholder="Salle A ou https://meet.google.com/..."/></div>
      <div class="modal-field"><label class="modal-label">Notes pr√©paratoires</label><textarea class="modal-input" id="me-notes" placeholder="Questions √† poser, points √† v√©rifier..."></textarea></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modal-entretien')">Annuler</button>
      <button class="btn btn-rh" onclick="saveEntretien()">üìÖ Confirmer</button>
    </div>
  </div>
</div>

<!-- MODAL DETAIL -->
<div class="modal-overlay" id="modal-detail">
  <div class="modal detail-modal" style="max-width:820px">
    <div class="modal-head">
      <h3 id="detail-title">üìã Fiche candidat</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn btn-outline btn-xs" onclick="editCandidatFromDetail()">‚úèÔ∏è Modifier</button>
        <button class="modal-close" onclick="closeModal('modal-detail')">&#x2715;</button>
      </div>
    </div>
    <div class="modal-body" id="detail-body"></div>
    <div class="modal-foot">
      <button class="btn btn-danger btn-sm" onclick="deleteCandidatFromDetail()" style="margin-right:auto">üóë Supprimer</button>
      <div style="display:flex;gap:6px;align-items:center">
        <span style="font-size:12px;font-weight:600;color:var(--muted)">Passer √† :</span>
        <select class="modal-input" id="detail-statut-change" style="width:160px;padding:5px 10px;font-size:12px" onchange="changeStatutFromDetail(this.value)">
          <option value="">--- Changer statut ---</option>
          <option value="screening">Screening</option><option value="entretien">Entretien</option>
          <option value="test">Test technique</option><option value="offre">Offre envoy√©e</option>
          <option value="embauche">‚úÖ Embauch√©</option><option value="rejete">‚ùå Rejeter</option>
        </select>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth=getAuth(app);const db=getFirestore(app);
  window._auth=auth;window._db=db;window._doc=doc;window._setDoc=setDoc;
  window._getDoc=getDoc;window._collection=collection;window._getDocs=getDocs;
  window._deleteDoc=deleteDoc;window._signOut=signOut;
  onAuthStateChanged(auth,function(user){
    if(!user){window.location.href='index.html';return;}
    window._uid=user.uid;window._firebaseReady=true;
    var name=user.displayName||user.email.split('@')[0];
    var el=document.getElementById('uname');if(el)el.textContent=name;
    var av=document.getElementById('av');if(av)av.textContent=name.charAt(0).toUpperCase();
    // Charger le plan
    getDoc(doc(db,'users',user.uid)).then(function(d){
      var plan=d.exists()?d.data().plan:'‚Äî';
      var up=document.getElementById('uplan');if(up)up.textContent=plan||'free';
    }).catch(function(){});
    window.initRecrutement();
  });
</script>

<script>
var _offres={},_candidats={},_entretiens={},_scoreSelected=0,_detailCurrentId=null;

window.initRecrutement=async function(){
  if(!window._uid)return;
  await Promise.all([loadOffres(),loadCandidats(),loadEntretiens()]);
  renderAll();
};

async function loadOffres(){try{var s=await window._getDocs(window._collection(window._db,'rh_recrutement',window._uid,'offres'));_offres={};s.forEach(function(d){_offres[d.id]={id:d.id,...d.data()};});}catch(e){console.warn(e);}}
async function loadCandidats(){try{var s=await window._getDocs(window._collection(window._db,'rh_recrutement',window._uid,'candidats'));_candidats={};s.forEach(function(d){_candidats[d.id]={id:d.id,...d.data()};});}catch(e){console.warn(e);}}
async function loadEntretiens(){try{var s=await window._getDocs(window._collection(window._db,'rh_recrutement',window._uid,'entretiens'));_entretiens={};s.forEach(function(d){_entretiens[d.id]={id:d.id,...d.data()};});}catch(e){console.warn(e);}}

function renderAll(){refreshOffreSelects();renderKPIs();renderPipeline();renderCandidatTable();renderOffres();renderEntretiens();renderAnalytics();}

function renderKPIs(){
  var cands=Object.values(_candidats),offresA=Object.values(_offres).filter(function(o){return o.statut==='active';});
  var actifs=cands.filter(function(c){return!['embauche','rejete'].includes(c.statut);}).length;
  var embauches=cands.filter(function(c){return c.statut==='embauche';}).length;
  var taux=cands.length>0?(embauches/cands.length*100).toFixed(0):0;
  var moisDebut=new Date();moisDebut.setDate(1);moisDebut.setHours(0,0,0,0);
  var entretiensMois=Object.values(_entretiens).filter(function(e){return e.date&&new Date(e.date)>=moisDebut;}).length;
  var embauchesData=cands.filter(function(c){return c.statut==='embauche'&&c.dateCreation&&c.dateOffre;});
  var delaiMoyen='‚Äî';
  if(embauchesData.length>0){var tot=embauchesData.reduce(function(s,c){return s+(new Date(c.dateOffre)-new Date(c.dateCreation))/86400000;},0);delaiMoyen=Math.round(tot/embauchesData.length)+'j';}
  document.getElementById('kpi-actifs').textContent=actifs;
  document.getElementById('kpi-actifs-sub').textContent=cands.length+' candidats total';
  document.getElementById('kpi-offres').textContent=offresA.length;
  document.getElementById('kpi-offres-sub').textContent=Object.keys(_offres).length+' offres cr√©√©es';
  document.getElementById('kpi-entretiens').textContent=entretiensMois;
  document.getElementById('kpi-delai').textContent=delaiMoyen;
  document.getElementById('kpi-taux').textContent=taux+'%';
}

var PIPE_COLS=[
  {key:'nouveau',label:'Nouveau',color:'#64748b',bb:'#f1f5f9',bc:'#475569'},
  {key:'screening',label:'Screening',color:'#3b82f6',bb:'#dbeafe',bc:'#1d4ed8'},
  {key:'entretien',label:'Entretien',color:'#8b5cf6',bb:'#ede9fe',bc:'#6d28d9'},
  {key:'test',label:'Test technique',color:'#f59e0b',bb:'#fef3c7',bc:'#92400e'},
  {key:'offre',label:'Offre envoy√©e',color:'#10b981',bb:'#d1fae5',bc:'#065f46'},
  {key:'rejete',label:'Rejet√©',color:'#ef4444',bb:'#fee2e2',bc:'#991b1b'}
];

function renderPipeline(){
  var filterOff=document.getElementById('pipeline-filter-offre')?document.getElementById('pipeline-filter-offre').value:'';
  var board=document.getElementById('pipeline-board');if(!board)return;
  var cands=Object.values(_candidats).filter(function(c){return c.statut!=='embauche'&&(!filterOff||c.offreId===filterOff);});
  board.innerHTML=PIPE_COLS.map(function(col){
    var items=cands.filter(function(c){return c.statut===col.key;});
    return '<div class="pipeline-col" id="pcol-'+col.key+'" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="dropOnCol(event,''+col.key+'')">'
      +'<div class="pipeline-col-head"><div class="pipeline-col-title" style="color:'+col.color+'">'+col.label+'</div>'
      +'<div class="pipeline-badge" style="background:'+col.bb+';color:'+col.bc+'">'+items.length+'</div></div>'
      +(items.length===0?'<div class="empty-col"><div class="empty-col-icon">‚óã</div><div class="empty-col-text">Aucun</div></div>':'')
      +items.map(function(c){
        var sc=parseInt(c.score)||0,scCls=sc>=7?'score-high':sc>=4?'score-mid':sc>0?'score-low':'';
        var offre=_offres[c.offreId];
        return '<div class="pipeline-card" draggable="true" ondragstart="dragStart(event,''+c.id+'')" onclick="openDetail(''+c.id+'')">'
          +'<div class="pipeline-card-name">'+c.prenom+' '+c.nom+'</div>'
          +'<div class="pipeline-card-poste">'+(offre?offre.titre:'Poste non li√©')+'</div>'
          +'<div class="pipeline-card-foot"><div class="pipeline-card-date">'+formatDate(c.dateCreation)+'</div>'
          +(sc>0?'<div class="pipeline-card-score '+scCls+'">'+sc+'/10</div>':'')
          +'</div></div>';
      }).join('')
      +'</div>';
  }).join('');
}

var _dragId=null;
function dragStart(e,id){_dragId=id;e.dataTransfer.effectAllowed='move';}
async function dropOnCol(e,ns){
  e.preventDefault();document.querySelectorAll('.pipeline-col').forEach(function(c){c.classList.remove('drag-over');});
  if(!_dragId||!_candidats[_dragId])return;
  _candidats[_dragId].statut=ns;
  await saveRecord('candidats',_dragId,_candidats[_dragId]);
  renderPipeline();renderCandidatTable();renderKPIs();renderAnalytics();
  showToast('Statut mis √† jour','ok');_dragId=null;
}

function renderCandidatTable(){
  var tbody=document.getElementById('candidat-tbody');if(!tbody)return;
  var search=(document.getElementById('search-candidat')?document.getElementById('search-candidat').value:'').toLowerCase();
  var filterSt=document.getElementById('filter-statut')?document.getElementById('filter-statut').value:'';
  var filterOff=document.getElementById('filter-offre')?document.getElementById('filter-offre').value:'';
  var items=Object.values(_candidats).filter(function(c){
    var txt=(c.prenom+' '+c.nom+' '+(c.email||'')).toLowerCase();
    if(search&&!txt.includes(search))return false;
    if(filterSt&&c.statut!==filterSt)return false;
    if(filterOff&&c.offreId!==filterOff)return false;
    return true;
  }).sort(function(a,b){return(b.dateCreation||'')>(a.dateCreation||'')?1:-1;});
  if(items.length===0){tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--muted)"><div style="font-size:32px;margin-bottom:8px">üîç</div>Aucun candidat trouv√©</td></tr>';return;}
  var srcMap={linkedin:'src-linkedin',indeed:'src-indeed',cooptation:'src-cooptation',spontanee:'src-spontanee'};
  var prioIcon={haute:'üî¥',normale:'üü°',basse:'‚ö´'};
  tbody.innerHTML=items.map(function(c){
    var sc=parseInt(c.score)||0,scCls=sc>=7?'score-high':sc>=4?'score-mid':sc>0?'score-low':'';
    var offre=_offres[c.offreId],prio=c.priorite||'normale';
    return '<tr>'
      +'<td><div style="display:flex;align-items:center;gap:8px"><div class="c-av">'+((c.prenom||'?')[0].toUpperCase())+'</div>'
      +'<div><div class="c-name">'+c.prenom+' '+c.nom+'</div><div class="c-sub">'+(c.email||'‚Äî')+'</div></div></div></td>'
      +'<td style="font-size:12px;font-weight:600">'+(offre?offre.titre:'‚Äî')+'</td>'
      +'<td><span class="status-badge st-'+(c.statut||'nouveau')+'">'+statutLabel(c.statut)+'</span></td>'
      +'<td><span class="status-badge '+(srcMap[c.source]||'src-autre')+'">'+sourceLabel(c.source)+'</span></td>'
      +'<td>'+(sc>0?'<span class="pipeline-card-score '+scCls+'">'+sc+'/10</span>':'<span style="color:var(--muted);font-size:11px">‚Äî</span>')+'</td>'
      +'<td style="font-size:11px;color:var(--muted)">'+formatDate(c.dateCreation)+'</td>'
      +'<td>'+(prioIcon[prio]||'')+'</td>'
      +'<td><div style="display:flex;gap:4px"><button class="btn btn-outline btn-xs" onclick="openDetail(''+c.id+'')">&#x1f441; Voir</button>'
      +'<button class="btn btn-xs" style="background:#fee2e2;color:#991b1b;border:1px solid #fecaca" onclick="deleteCandidat(''+c.id+'')">&#x1f5d1;</button></div></td>'
      +'</tr>';
  }).join('');
}

function renderOffres(){
  var list=document.getElementById('offres-list');if(!list)return;
  var items=Object.values(_offres).sort(function(a,b){return(b.dateOuv||'')>(a.dateOuv||'')?1:-1;});
  if(items.length===0){
    list.innerHTML='<div style="text-align:center;padding:60px;background:white;border:1px solid var(--border);border-radius:var(--radius);color:var(--muted)">'
      +'<div style="font-size:48px;margin-bottom:12px">üìã</div>'
      +'<h3 style="font-size:15px;font-weight:700;color:var(--text);margin-bottom:8px">Aucune offre cr√©√©e</h3>'
      +'<p style="font-size:13px">Cr√©ez votre premi√®re offre d'emploi pour commencer.</p>'
      +'<button class="btn btn-rh" style="margin-top:16px" onclick="openModal('modal-offre')">+ Cr√©er une offre</button></div>';
    return;
  }
  var stMap={active:'offre-active',pause:'offre-pause',closed:'offre-closed'};
  var stLabel={active:'üü¢ Active',pause:'‚è∏ En pause',closed:'üî¥ Ferm√©e'};
  list.innerHTML=items.map(function(o){
    var cands=Object.values(_candidats).filter(function(c){return c.offreId===o.id;});
    var active=cands.filter(function(c){return!['embauche','rejete'].includes(c.statut);}).length;
    var tags=(o.competences||'').split(',').filter(Boolean).slice(0,4);
    return '<div class="offre-card">'
      +'<div class="offre-icon">'+(o.emoji||'üíº')+'</div>'
      +'<div class="offre-body">'
      +'<div class="offre-title">'+o.titre+'</div>'
      +'<div class="offre-tags">'
      +'<span class="offre-tag green">'+(o.contrat||'CDI')+'</span>'
      +(o.lieu?'<span class="offre-tag blue">üìç '+o.lieu+'</span>':'')
      +(o.salaire?'<span class="offre-tag">üí∞ '+o.salaire+' ‚Ç¨/an</span>':'')
      +tags.map(function(t){return'<span class="offre-tag">'+t.trim()+'</span>';}).join('')
      +'</div>'
      +'<div class="offre-stats">'
      +'<div class="offre-stat">üë§ <span>'+cands.length+'</span> candidature(s)</div>'
      +'<div class="offre-stat">‚ö° <span>'+active+'</span> actif(s)</div>'
      +(o.dateOuv?'<div class="offre-stat">üìÖ Ouvert le <span>'+formatDate(o.dateOuv)+'</span></div>':'')
      +(o.dateClo?'<div class="offre-stat">‚è∞ Cl√¥ture <span>'+formatDate(o.dateClo)+'</span></div>':'')
      +'</div></div>'
      +'<div class="offre-actions">'
      +'<span class="offre-status '+(stMap[o.statut]||'offre-active')+'">'+(stLabel[o.statut]||'üü¢ Active')+'</span>'
      +'<button class="btn btn-outline btn-xs" onclick="editOffre(''+o.id+'')">‚úèÔ∏è Modifier</button>'
      +'<button class="btn btn-rh btn-xs" onclick="openModal('modal-candidat');prefillOffre(''+o.id+'')">+ Candidat</button>'
      +'</div></div>';
  }).join('');
}

function prefillOffre(id){var sel=document.getElementById('mc-offre');if(sel)sel.value=id;}

function refreshOffreSelects(){
  var items=Object.values(_offres).sort(function(a,b){return(a.titre||'').localeCompare(b.titre||'');});
  var opts=items.map(function(o){return'<option value="'+o.id+'">'+o.titre+(o.contrat?' ('+o.contrat+')':'')+'</option>';}).join('');
  ['mc-offre','filter-offre','pipeline-filter-offre'].forEach(function(id){
    var el=document.getElementById(id);if(!el)return;
    var first=id==='mc-offre'?'<option value="">--- S√©lectionner une offre ---</option>':'<option value="">Toutes les offres</option>';
    el.innerHTML=first+opts;
  });
}

function renderEntretiens(){
  var list=document.getElementById('entretiens-list'),todo=document.getElementById('entretiens-todo');
  if(!list)return;
  var all=Object.values(_entretiens).sort(function(a,b){return((a.date||'')+(a.heure||''))>((b.date||'')+(b.heure||''))?1:-1;});
  var todayStr=new Date().toISOString().slice(0,10);
  var futur=all.filter(function(e){return e.date&&e.date>=todayStr;});
  var passe=all.filter(function(e){return e.date&&e.date<todayStr;});
  if(all.length===0){list.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted);font-size:12px"><div style="font-size:32px;margin-bottom:8px">üóì</div>Aucun entretien planifi√©</div>';}
  else{
    list.innerHTML=futur.map(function(e){return renderEntretienRow(e,'futur');}).join('')
      +(passe.length>0?'<div style="font-size:11px;font-weight:700;color:var(--muted);margin:12px 0 4px;padding-top:8px;border-top:1px solid var(--border)">PASS√âS</div>':'')
      +passe.slice(-5).map(function(e){return renderEntretienRow(e,'passe');}).join('');
  }
  var wd=new Date();wd.setDate(wd.getDate()-wd.getDay()+1);
  var wf=new Date(wd);wf.setDate(wd.getDate()+6);
  var semaine=futur.filter(function(e){var d=new Date(e.date);return d>=wd&&d<=wf;});
  if(todo){
    if(semaine.length===0)todo.innerHTML='<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">Aucun entretien cette semaine</div>';
    else todo.innerHTML=semaine.map(function(e){var c=_candidats[e.candidatId];return'<div style="padding:8px 0;border-bottom:1px solid #f1f5f9"><div style="font-size:12px;font-weight:700">'+(c?c.prenom+' '+c.nom:'Candidat')+'</div><div style="font-size:11px;color:var(--muted)">'+typeLabel(e.type)+' ¬∑ '+e.date+' '+(e.heure||'')+'</div></div>';}).join('');
  }
  var sel=document.getElementById('me-candidat');
  if(sel){var cands=Object.values(_candidats).filter(function(c){return!['embauche','rejete'].includes(c.statut);});sel.innerHTML='<option value="">--- S√©lectionner ---</option>'+cands.map(function(c){return'<option value="'+c.id+'">'+c.prenom+' '+c.nom+(_offres[c.offreId]?' ('+_offres[c.offreId].titre+')':'')+'</option>';}).join('');}
}

function renderEntretienRow(e,mode){
  var c=_candidats[e.candidatId],offre=c?_offres[c.offreId]:null;
  var typeIco={telephone:'üìû',visio:'üíª',presentiel:'üè¢',technique:'üß™',rh:'üë•',direction:'‚≠ê'};
  var op=mode==='passe'?'opacity:.55':'';
  return'<div class="entretien-row" style="'+op+'">'
    +'<div class="entretien-time"><div class="entretien-time-h">'+(e.heure||'‚Äî')+'</div><div class="entretien-time-d">'+formatDate(e.date)+'</div></div>'
    +'<div class="entretien-info"><div class="entretien-name">'+(c?c.prenom+' '+c.nom:'Candidat inconnu')+'</div>'
    +'<div class="entretien-poste">'+(offre?offre.titre:'‚Äî')+'</div></div>'
    +'<div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">'
    +'<span class="entretien-type">'+(typeIco[e.type]||'üìã')+' '+typeLabel(e.type)+'</span>'
    +(e.interviewer?'<div style="font-size:10px;color:var(--muted)">üë§ '+e.interviewer+'</div>':'')
    +'</div>'
    +'<button class="btn btn-danger btn-xs" style="margin-left:8px" onclick="deleteEntretien(''+e.id+'')">&#x1f5d1;</button></div>';
}

function renderAnalytics(){
  var cands=Object.values(_candidats),total=cands.length;
  var rejete=cands.filter(function(c){return c.statut==='rejete';}).length;
  var embauche=cands.filter(function(c){return c.statut==='embauche';}).length;
  var scored=cands.filter(function(c){return c.score>0;});
  var avgScore=scored.length>0?(scored.reduce(function(s,c){return s+(parseInt(c.score)||0);},0)/scored.length).toFixed(1):'‚Äî';
  document.getElementById('ana-total').textContent=total;
  document.getElementById('ana-rejete').textContent=rejete;
  document.getElementById('ana-rejete-pct').textContent=total>0?(rejete/total*100).toFixed(0)+'% du total':'‚Äî';
  document.getElementById('ana-embauche').textContent=embauche;
  document.getElementById('ana-embauche-pct').textContent=total>0?(embauche/total*100).toFixed(0)+'% de taux':'‚Äî';
  document.getElementById('ana-score').textContent=avgScore;
  var stages=[
    {label:'Candidatures',count:total,color:'#1a3dce'},
    {label:'Screening',count:cands.filter(function(c){return['screening','entretien','test','offre','embauche'].includes(c.statut);}).length,color:'#3b82f6'},
    {label:'Entretiens',count:cands.filter(function(c){return['entretien','test','offre','embauche'].includes(c.statut);}).length,color:'#8b5cf6'},
    {label:'Tests',count:cands.filter(function(c){return['test','offre','embauche'].includes(c.statut);}).length,color:'#f59e0b'},
    {label:'Offres',count:cands.filter(function(c){return['offre','embauche'].includes(c.statut);}).length,color:'#10b981'},
    {label:'Embauch√©s',count:embauche,color:'#065f46'}
  ];
  var fw=document.getElementById('funnel-wrap');
  if(fw)fw.innerHTML='<div class="funnel-wrap">'+stages.map(function(s){var pct=total>0?s.count/total*100:0;return'<div class="funnel-row"><div class="funnel-label">'+s.label+'</div><div class="funnel-bar-bg"><div class="funnel-bar-fill" style="width:'+pct+'%;background:'+s.color+'">'+(pct>12?'<span class="funnel-bar-text">'+s.count+'</span>':'')+'</div></div><div class="funnel-count">'+s.count+'</div><div class="funnel-pct">'+pct.toFixed(0)+'%</div></div>';}).join('')+'</div>';
  var srcCount={};cands.forEach(function(c){var s=c.source||'autre';srcCount[s]=(srcCount[s]||0)+1;});
  var srcColors={linkedin:'#3b82f6',indeed:'#f59e0b',cooptation:'#10b981',spontanee:'#8b5cf6','pole-emploi':'#0ea5e9',autre:'#94a3b8'};
  var srcSorted=Object.entries(srcCount).sort(function(a,b){return b[1]-a[1];});
  var maxSrc=srcSorted[0]?srcSorted[0][1]:1;
  var sw=document.getElementById('sources-wrap');
  if(sw)sw.innerHTML='<div class="source-list">'+srcSorted.map(function(e){return'<div class="source-row"><div class="source-name">'+sourceLabel(e[0])+'</div><div class="source-bar-bg"><div class="source-bar-fill" style="width:'+e[1]/maxSrc*100+'%;background:'+(srcColors[e[0]]||'#94a3b8')+'"></div></div><div class="source-num">'+e[1]+'</div></div>';}).join('')+'</div>';
  var steps2=['screening','entretien','test','offre','embauche'],stepD={screening:3,entretien:7,test:5,offre:3,embauche:2};
  var dw=document.getElementById('duree-wrap');
  if(dw)dw.innerHTML=steps2.map(function(s){return'<div style="background:#f8fffe;border:1px solid var(--rh-border);border-radius:10px;padding:14px;text-align:center"><div style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:6px">'+statutLabel(s)+'</div><div style="font-size:22px;font-weight:800;color:var(--rh-main)">'+stepD[s]+'j</div><div style="font-size:10px;color:var(--muted)">Dur√©e moy.</div></div>';}).join('');
}

function openDetail(id){
  var c=_candidats[id];if(!c)return;
  _detailCurrentId=id;
  var offre=_offres[c.offreId];
  var sc=parseInt(c.score)||0;
  document.getElementById('detail-title').textContent='üìã '+c.prenom+' '+c.nom;
  var compTags=(c.competences||'').split(',').filter(Boolean).map(function(t){return'<span class="competence-tag">'+t.trim()+'</span>';}).join('');
  var entretiensCand=Object.values(_entretiens).filter(function(e){return e.candidatId===id;}).sort(function(a,b){return a.date>b.date?-1:1;});
  document.getElementById('detail-body').innerHTML=
    '<div class="cand-hero">'
    +'<div class="cand-av">'+((c.prenom||'?')[0].toUpperCase())+'</div>'
    +'<div style="flex:1;min-width:0"><div class="cand-hero-name">'+c.prenom+' '+c.nom+'</div>'
    +'<div class="cand-hero-poste">'+(offre?offre.titre:'Poste non d√©fini')+'</div>'
    +'<div class="cand-hero-tags"><span class="cand-hero-tag">'+statutLabel(c.statut)+'</span>'
    +'<span class="cand-hero-tag">'+sourceLabel(c.source)+'</span>'
    +(offre?'<span class="cand-hero-tag">'+(offre.contrat||'CDI')+'</span>':'')
    +(c.exp?'<span class="cand-hero-tag">'+c.exp+' ans</span>':'')
    +'</div></div>'
    +(sc>0?'<div class="cand-score-display"><div class="cand-score-num" style="color:'+(sc>=7?'#34d399':sc>=4?'#fbbf24':'#f87171')+'">'+sc+'</div><div class="cand-score-lbl">Score /10</div></div>':'')
    +'</div>'
    +'<div class="cand-tabs">'
    +'<button class="cand-tab on" onclick="switchCandTab('info',this)">&#x2139;&#xfe0f; Infos</button>'
    +'<button class="cand-tab" onclick="switchCandTab('parcours',this)">üìã Parcours</button>'
    +'<button class="cand-tab" onclick="switchCandTab('entretiens',this)">üóì Entretiens</button>'
    +'<button class="cand-tab" onclick="switchCandTab('notes',this)">üìù Notes</button>'
    +'<button class="cand-tab" onclick="switchCandTab('decision',this)">‚öñÔ∏è D√©cision</button>'
    +'</div>'
    +'<div id="cand-panel-info" class="cand-panel on">'
    +'<div class="info-grid">'
    +'<div class="info-item"><div class="info-item-lbl">Email</div><div class="info-item-val">'+(c.email||'‚Äî')+'</div></div>'
    +'<div class="info-item"><div class="info-item-lbl">T√©l√©phone</div><div class="info-item-val">'+(c.tel||'‚Äî')+'</div></div>'
    +'<div class="info-item"><div class="info-item-lbl">Exp√©rience</div><div class="info-item-val">'+(c.exp?c.exp+' ans':'‚Äî')+'</div></div>'
    +'<div class="info-item"><div class="info-item-lbl">Pr√©tentions salariales</div><div class="info-item-val">'+(c.salaire?Number(c.salaire).toLocaleString('fr-FR')+' ‚Ç¨/an':'‚Äî')+'</div></div>'
    +'<div class="info-item"><div class="info-item-lbl">Priorit√©</div><div class="info-item-val">'+prioLabel(c.priorite)+'</div></div>'
    +'<div class="info-item"><div class="info-item-lbl">Candidature le</div><div class="info-item-val">'+formatDate(c.dateCreation)+'</div></div>'
    +'</div>'
    +(compTags?'<div style="font-size:12px;font-weight:700;margin-bottom:8px">Comp√©tences</div><div class="competence-wrap">'+compTags+'</div>':'')
    +(c.cv?'<a href="'+c.cv+'" target="_blank" class="btn btn-outline btn-sm">üìé Voir le CV</a>':'')
    +'</div>'
    +'<div id="cand-panel-parcours" class="cand-panel">'
    +'<div class="timeline-wrap">'+buildTimeline(c)+'</div></div>'
    +'<div id="cand-panel-entretiens" class="cand-panel">'
    +(entretiensCand.length===0?'<div style="text-align:center;padding:30px;color:var(--muted)"><div style="font-size:28px;margin-bottom:8px">üóì</div>Aucun entretien planifi√©<br><button class="btn btn-rh btn-sm" style="margin-top:12px" onclick="closeModal('modal-detail');openEntretienFor(''+id+'')">+ Planifier un entretien</button></div>'
    :entretiensCand.map(function(e){return'<div style="padding:12px;background:#f8fffe;border-radius:8px;border:1px solid var(--rh-border);margin-bottom:8px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="font-size:12px;font-weight:700">'+typeLabel(e.type)+'</div><div style="font-size:11px;color:var(--muted)">'+e.date+' '+(e.heure||'')+'</div></div>'+(e.interviewer?'<div style="font-size:11px;color:var(--muted)">üë§ '+e.interviewer+'</div>':'')+(e.lieu?'<div style="font-size:11px;color:var(--muted)">üìç '+e.lieu+'</div>':'')+(e.notes?'<div style="margin-top:6px;font-size:12px;padding:6px;background:#f0fdf4;border-radius:6px;border-left:3px solid var(--rh-main)">'+e.notes+'</div>':'')+'</div>';}).join(''))
    +'</div>'
    +'<div id="cand-panel-notes" class="cand-panel">'
    +'<div style="margin-bottom:12px"><textarea id="detail-note-input" class="modal-input" rows="3" placeholder="Ajouter une note..."></textarea>'
    +'<button class="btn btn-rh btn-sm" style="margin-top:8px" onclick="addNote(''+id+'')">&#x1f4ac; Ajouter la note</button></div>'
    +'<div id="notes-list-'+id+'">'
    +((c.notes_list||[]).map(function(n){return'<div class="note-item"><div class="note-head"><span class="note-author">'+(n.auteur||'Vous')+'</span><span class="note-date">'+formatDate(n.date)+'</span></div><div class="note-text">'+n.texte+'</div></div>';}).join('')||'<div style="color:var(--muted);font-size:12px;text-align:center;padding:20px">Aucune note</div>')
    +'</div>'
    +(c.notes?'<div class="note-item" style="background:#f0fdf4;border-color:var(--rh-border)"><div class="note-head"><span class="note-author">Note initiale</span></div><div class="note-text">'+c.notes+'</div></div>':'')
    +'</div>'
    +'<div id="cand-panel-decision" class="cand-panel">'
    +'<div style="background:#f8fffe;border:1px solid var(--rh-border);border-radius:10px;padding:16px;margin-bottom:16px">'
    +'<div style="font-size:13px;font-weight:700;margin-bottom:12px">‚öñÔ∏è Aide √† la d√©cision</div>'
    +buildDecisionHelp(c,offre)+'</div>'
    +'<div style="font-size:12px;font-weight:700;margin-bottom:8px">üìù Commentaire final</div>'
    +'<textarea id="decision-comment-'+id+'" class="modal-input" rows="3" placeholder="Justification de la d√©cision...">'+(c.decisionComment||'')+'</textarea>'
    +'<div style="display:flex;gap:8px;margin-top:12px">'
    +'<button class="btn btn-rh btn-sm" onclick="setDecision(''+id+'','embauche')">‚úÖ Embaucher</button>'
    +'<button class="btn btn-outline btn-sm" onclick="setDecision(''+id+'','offre')">üì® Envoyer une offre</button>'
    +'<button class="btn btn-danger btn-sm" onclick="setDecision(''+id+'','rejete')">‚ùå Rejeter</button>'
    +'</div></div>';
  openModal('modal-detail');
}

function buildTimeline(c){
  var steps=['nouveau','screening','entretien','test','offre','embauche'];
  var idx=steps.indexOf(c.statut);
  return steps.map(function(s,i){return'<div class="timeline-item '+(i<=idx&&c.statut!=='rejete'?'done':'')+'"><div class="timeline-dot"></div><div class="timeline-head">'+statutLabel(s)+'</div><div class="timeline-sub">'+(i<=idx&&c.statut!=='rejete'?'‚úì Compl√©t√©':'En attente')+'</div></div>';}).join('')
    +(c.statut==='rejete'?'<div class="timeline-item done" style="opacity:.5"><div class="timeline-dot" style="border-color:#ef4444;background:#ef4444"></div><div class="timeline-head" style="color:#ef4444">Rejet√©</div></div>':'');
}

function buildDecisionHelp(c,offre){
  var sc=parseInt(c.score)||0,exp=parseFloat(c.exp)||0;
  var salaire=parseInt((c.salaire||'0').toString().replace(/\D/g,''))||0;
  var offreSal=offre?parseInt((offre.salaire||'0').toString().replace(/[-‚Ç¨ kK]/g,'').split('‚Äì')[1]||offre.salaire)||0:0;
  var pts=[];
  if(sc>=7)pts.push({ok:true,txt:'Score √©lev√© : '+sc+'/10'});
  else if(sc>0)pts.push({ok:false,txt:'Score mod√©r√© : '+sc+'/10'});
  if(exp>=3)pts.push({ok:true,txt:'Exp√©rience suffisante : '+exp+' ans'});
  else if(exp>0)pts.push({ok:null,txt:'Exp√©rience limit√©e : '+exp+' ans'});
  if(offreSal>0&&salaire>0){if(salaire<=offreSal)pts.push({ok:true,txt:'Pr√©tentions compatibles avec l'offre'});else pts.push({ok:false,txt:'Pr√©tentions sup√©rieures au budget'});}
  var entrDone=Object.values(_entretiens).filter(function(e){return e.candidatId===c.id&&new Date(e.date)<new Date();}).length;
  if(entrDone>0)pts.push({ok:true,txt:entrDone+' entretien(s) r√©alis√©(s)'});
  else pts.push({ok:null,txt:'Aucun entretien r√©alis√©'});
  if(!pts.length)return'<div style="color:var(--muted);font-size:12px">Compl√©tez le profil pour obtenir des recommandations.</div>';
  return pts.map(function(p){return'<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><span style="font-size:14px">'+(p.ok===true?'‚úÖ':p.ok===false?'‚ö†Ô∏è':'‚ÑπÔ∏è')+'</span><span style="font-size:12px;color:'+(p.ok===true?'var(--rh-main)':p.ok===false?'var(--orange)':'var(--text)')+'">'+p.txt+'</span></div>';}).join('');
}

function switchCandTab(panel,btn){document.querySelectorAll('.cand-tab').forEach(function(b){b.classList.remove('on');});document.querySelectorAll('.cand-panel').forEach(function(p){p.classList.remove('on');});btn.classList.add('on');var el=document.getElementById('cand-panel-'+panel);if(el)el.classList.add('on');}

async function addNote(candId){
  var inp=document.getElementById('detail-note-input');if(!inp||!inp.value.trim())return;
  var c=_candidats[candId];if(!c)return;
  if(!c.notes_list)c.notes_list=[];
  c.notes_list.unshift({texte:inp.value.trim(),date:new Date().toISOString().slice(0,10),auteur:'Vous'});
  inp.value='';
  await saveRecord('candidats',candId,c);
  var nl=document.getElementById('notes-list-'+candId);
  if(nl)nl.innerHTML=c.notes_list.map(function(n){return'<div class="note-item"><div class="note-head"><span class="note-author">'+(n.auteur||'Vous')+'</span><span class="note-date">'+formatDate(n.date)+'</span></div><div class="note-text">'+n.texte+'</div></div>';}).join('');
  showToast('Note ajout√©e','ok');
}

async function setDecision(candId,decision){
  var c=_candidats[candId];if(!c)return;
  var comment=document.getElementById('decision-comment-'+candId)?document.getElementById('decision-comment-'+candId).value:'';
  c.statut=decision;c.decisionComment=comment;
  if(decision==='embauche')c.dateOffre=new Date().toISOString().slice(0,10);
  await saveRecord('candidats',candId,c);
  renderAll();closeModal('modal-detail');
  showToast(decision==='embauche'?'üéâ Embauch√© !':decision==='rejete'?'Candidat rejet√©':'Offre envoy√©e','ok');
}

async function changeStatutFromDetail(ns){
  if(!ns||!_detailCurrentId)return;
  var c=_candidats[_detailCurrentId];if(!c)return;
  c.statut=ns;await saveRecord('candidats',_detailCurrentId,c);
  renderAll();closeModal('modal-detail');showToast('Statut mis √† jour','ok');
}

function editCandidatFromDetail(){closeModal('modal-detail');if(_detailCurrentId)editCandidat(_detailCurrentId);}
async function deleteCandidatFromDetail(){if(!_detailCurrentId||!confirm('Supprimer ce candidat ?'))return;await deleteCandidat(_detailCurrentId);closeModal('modal-detail');}

async function saveRecord(coll,id,data){await window._setDoc(window._doc(window._db,'rh_recrutement',window._uid,coll,id),data);}

async function saveCandidat(){
  var prenom=document.getElementById('mc-prenom').value.trim(),nom=document.getElementById('mc-nom').value.trim();
  if(!prenom||!nom){showToast('Pr√©nom et nom obligatoires');return;}
  var id=document.getElementById('mc-id').value||'cand_'+Date.now();
  var data={id,prenom,nom,
    email:document.getElementById('mc-email').value.trim(),tel:document.getElementById('mc-tel').value.trim(),
    offreId:document.getElementById('mc-offre').value,source:document.getElementById('mc-source').value,
    statut:document.getElementById('mc-statut').value,priorite:document.getElementById('mc-priorite').value,
    exp:document.getElementById('mc-exp').value.replace(',','.'),salaire:document.getElementById('mc-salaire').value.replace(',','.'),
    competences:document.getElementById('mc-competences').value,cv:document.getElementById('mc-cv').value.trim(),
    score:parseInt(document.getElementById('mc-score').value)||0,notes:document.getElementById('mc-notes').value.trim(),
    dateCreation:(_candidats[id]&&_candidats[id].dateCreation)||new Date().toISOString().slice(0,10),
    notes_list:(_candidats[id]&&_candidats[id].notes_list)||[]};
  _candidats[id]=data;await saveRecord('candidats',id,data);
  closeModal('modal-candidat');renderAll();showToast('Candidat enregistr√©','ok');
}

function editCandidat(id){
  var c=_candidats[id];if(!c)return;
  document.getElementById('modal-candidat-title').textContent='‚úèÔ∏è Modifier le candidat';
  document.getElementById('mc-id').value=id;
  document.getElementById('mc-prenom').value=c.prenom||'';document.getElementById('mc-nom').value=c.nom||'';
  document.getElementById('mc-email').value=c.email||'';document.getElementById('mc-tel').value=c.tel||'';
  document.getElementById('mc-offre').value=c.offreId||'';document.getElementById('mc-source').value=c.source||'linkedin';
  document.getElementById('mc-statut').value=c.statut||'nouveau';document.getElementById('mc-priorite').value=c.priorite||'normale';
  document.getElementById('mc-exp').value=c.exp||'';document.getElementById('mc-salaire').value=c.salaire||'';
  document.getElementById('mc-competences').value=c.competences||'';document.getElementById('mc-cv').value=c.cv||'';
  document.getElementById('mc-notes').value=c.notes||'';setScore(c.score||0);openModal('modal-candidat');
}

async function deleteCandidat(id){
  if(!confirm('Supprimer ce candidat d√©finitivement ?'))return;
  delete _candidats[id];
  try{await window._deleteDoc(window._doc(window._db,'rh_recrutement',window._uid,'candidats',id));}catch(e){}
  renderAll();showToast('Candidat supprim√©');
}

async function saveOffre(){
  var titre=document.getElementById('mo-titre').value.trim();if(!titre){showToast('Intitul√© obligatoire');return;}
  var id=document.getElementById('mo-id').value||'offre_'+Date.now();
  var data={id,titre,dept:document.getElementById('mo-dept').value.trim(),contrat:document.getElementById('mo-contrat').value,
    lieu:document.getElementById('mo-lieu').value.trim(),salaire:document.getElementById('mo-salaire').value.trim(),
    dateOuv:document.getElementById('mo-dateouv').value,dateClo:document.getElementById('mo-dateclo').value,
    nb:parseInt(document.getElementById('mo-nb').value)||1,statut:document.getElementById('mo-statut').value,
    desc:document.getElementById('mo-desc').value.trim(),competences:document.getElementById('mo-competences').value.trim(),
    emoji:document.getElementById('mo-emoji').value||'üíº'};
  _offres[id]=data;await saveRecord('offres',id,data);
  closeModal('modal-offre');renderAll();showToast('Offre enregistr√©e','ok');
}

function editOffre(id){
  var o=_offres[id];if(!o)return;
  document.getElementById('modal-offre-title').textContent='‚úèÔ∏è Modifier l'offre';
  document.getElementById('mo-id').value=id;document.getElementById('mo-titre').value=o.titre||'';
  document.getElementById('mo-dept').value=o.dept||'';document.getElementById('mo-contrat').value=o.contrat||'CDI';
  document.getElementById('mo-lieu').value=o.lieu||'';document.getElementById('mo-salaire').value=o.salaire||'';
  document.getElementById('mo-dateouv').value=o.dateOuv||'';document.getElementById('mo-dateclo').value=o.dateClo||'';
  document.getElementById('mo-nb').value=o.nb||1;document.getElementById('mo-statut').value=o.statut||'active';
  document.getElementById('mo-desc').value=o.desc||'';document.getElementById('mo-competences').value=o.competences||'';
  document.getElementById('mo-emoji').value=o.emoji||'üíº';
  document.getElementById('mo-btn-delete').style.display='inline-flex';openModal('modal-offre');
}

async function deleteOffre(){
  var id=document.getElementById('mo-id').value;if(!id||!confirm('Supprimer cette offre ?'))return;
  delete _offres[id];try{await window._deleteDoc(window._doc(window._db,'rh_recrutement',window._uid,'offres',id));}catch(e){}
  closeModal('modal-offre');renderAll();showToast('Offre supprim√©e');
}

async function saveEntretien(){
  var candId=document.getElementById('me-candidat').value,date=document.getElementById('me-date').value;
  if(!candId||!date){showToast('Candidat et date obligatoires');return;}
  var id=document.getElementById('me-id').value||'entr_'+Date.now();
  var data={id,candidatId:candId,type:document.getElementById('me-type').value,date,
    heure:document.getElementById('me-heure').value,duree:parseInt(document.getElementById('me-duree').value)||60,
    interviewer:document.getElementById('me-interviewer').value.trim(),lieu:document.getElementById('me-lieu').value.trim(),
    notes:document.getElementById('me-notes').value.trim()};
  _entretiens[id]=data;await saveRecord('entretiens',id,data);
  closeModal('modal-entretien');renderEntretiens();renderKPIs();showToast('Entretien planifi√©','ok');
}

async function deleteEntretien(id){
  if(!confirm('Supprimer cet entretien ?'))return;
  delete _entretiens[id];try{await window._deleteDoc(window._doc(window._db,'rh_recrutement',window._uid,'entretiens',id));}catch(e){}
  renderEntretiens();renderKPIs();showToast('Entretien supprim√©');
}

function openEntretienFor(candId){var sel=document.getElementById('me-candidat');if(sel)sel.value=candId;openModal('modal-entretien');}

function setScore(n){_scoreSelected=n;document.getElementById('mc-score').value=n;document.querySelectorAll('#score-grid .score-btn').forEach(function(b,i){b.classList.toggle('on',i+1===n);});}
window.setScore=setScore;

function formatDate(d){if(!d)return'‚Äî';try{return new Date(d).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'});}catch(e){return d;}}
function statutLabel(s){return{nouveau:'Nouveau',screening:'Screening',entretien:'Entretien',test:'Test tech.',offre:'Offre envoy√©e',embauche:'Embauch√©',rejete:'Rejet√©'}[s]||s||'‚Äî';}
function sourceLabel(s){return{linkedin:'LinkedIn',indeed:'Indeed',cooptation:'Cooptation',spontanee:'Spontan√©e','pole-emploi':'France Travail',autre:'Autre'}[s]||s||'‚Äî';}
function typeLabel(t){return{telephone:'T√©l√©phonique',visio:'Visioconf√©rence',presentiel:'Pr√©sentiel',technique:'Technique',rh:'RH',direction:'Direction'}[t]||t||'‚Äî';}
function prioLabel(p){return{haute:'üî¥ Haute',normale:'üü° Normale',basse:'‚ö´ Basse'}[p]||'‚Äî';}

function openModal(id){
  if(id==='modal-candidat'&&!document.getElementById('mc-id').value){
    document.getElementById('modal-candidat-title').textContent='+ Nouveau candidat';
    ['mc-prenom','mc-nom','mc-email','mc-tel','mc-exp','mc-salaire','mc-competences','mc-cv','mc-notes'].forEach(function(f){var el=document.getElementById(f);if(el)el.value='';});
    setScore(0);document.getElementById('mc-statut').value='nouveau';document.getElementById('mc-priorite').value='normale';
  }
  if(id==='modal-offre'){document.getElementById('mo-btn-delete').style.display='none';}
  var el=document.getElementById(id);if(el)el.classList.add('show');
}
function closeModal(id){
  var el=document.getElementById(id);if(el)el.classList.remove('show');
  if(id==='modal-candidat')document.getElementById('mc-id').value='';
  if(id==='modal-offre'){document.getElementById('mo-id').value='';document.getElementById('mo-btn-delete').style.display='none';}
  if(id==='modal-entretien')document.getElementById('me-id').value='';
}

function switchTab(name,btn){document.querySelectorAll('.tab-btn').forEach(function(b){b.classList.remove('on');});document.querySelectorAll('.tab-panel').forEach(function(p){p.classList.remove('on');});btn.classList.add('on');var el=document.getElementById('tab-'+name);if(el)el.classList.add('on');}

function showToast(msg,type){var t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(function(){t.className='toast';},3200);}

window.openModal=openModal;window.closeModal=closeModal;window.switchTab=switchTab;
window.renderPipeline=renderPipeline;window.renderCandidatTable=renderCandidatTable;
window.dragStart=dragStart;window.dropOnCol=dropOnCol;
window.openDetail=openDetail;window.switchCandTab=switchCandTab;
window.changeStatutFromDetail=changeStatutFromDetail;window.editCandidatFromDetail=editCandidatFromDetail;
window.deleteCandidatFromDetail=deleteCandidatFromDetail;window.addNote=addNote;window.setDecision=setDecision;
window.saveCandidat=saveCandidat;window.editCandidat=editCandidat;window.deleteCandidat=deleteCandidat;
window.saveOffre=saveOffre;window.editOffre=editOffre;window.deleteOffre=deleteOffre;window.prefillOffre=prefillOffre;
window.saveEntretien=saveEntretien;window.deleteEntretien=deleteEntretien;window.openEntretienFor=openEntretienFor;
</script>

<script src="nav.js"></script>

</body>
</html>