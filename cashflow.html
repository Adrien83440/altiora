<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>ALTEORE ‚Äî Cashflow</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --nav:#0f1f5c;--blue:#1a3dce;--blue2:#4f7ef8;--bg:#f4f6fb;
  --border:#e2e8f0;--text:#1a1f36;--muted:#6b7280;
  --green:#10b981;--red:#ef4444;--orange:#f59e0b;--purple:#6366f1;
  --teal:#0d9488;--radius:14px;--sw:250px;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px}

/* ‚îÄ‚îÄ HAMBURGER ‚îÄ‚îÄ */
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:#0f1f5c;border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(15,31,92,.45)}
.hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;pointer-events:none}
.hamburger.open span:nth-child(1){transform:translateY(7.5px) rotate(45deg)}
.hamburger.open span:nth-child(2){opacity:0;transform:scaleX(0)}
.hamburger.open span:nth-child(3){transform:translateY(-7.5px) rotate(-45deg)}
.nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000}
.nav-overlay.show{display:block}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
nav{width:var(--sw);min-height:100vh;background:linear-gradient(180deg,#0f1f5c,#162366);position:fixed;top:0;left:0;display:flex;flex-direction:column;padding-bottom:20px;overflow-y:auto;z-index:99}
.logo{display:flex;align-items:center;gap:10px;padding:22px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
.logo-i{width:33px;height:33px;background:rgba(255,255,255,.14);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
.logo-t{font-size:17px;font-weight:800;color:#fff;letter-spacing:1px}
.ns{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 18px 4px}
.ni{display:flex;align-items:center;gap:9px;padding:9px 18px;color:rgba(255,255,255,.55);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.ni:hover{color:#fff;background:rgba(255,255,255,.06)}
.ni.on{color:#fff;background:rgba(255,255,255,.1);border-left-color:#4f7ef8}
.sub{overflow:hidden;max-height:0;transition:max-height .3s}
.sub.open{max-height:300px}
.si{display:flex;align-items:center;gap:7px;padding:7px 18px 7px 40px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.si:hover{color:rgba(255,255,255,.75);background:rgba(255,255,255,.04)}
.si.on{color:#fff;background:rgba(79,126,248,.15);border-left-color:rgba(79,126,248,.6)}
.dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25)}
.si.on .dot{background:#4f7ef8}
.nav-footer{margin-top:auto;padding:12px 18px 0;border-top:1px solid rgba(255,255,255,.08)}
.ucard{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,.07);border-radius:8px;cursor:pointer}
.ucard:hover{background:rgba(255,255,255,.1)}
.uav{width:29px;height:29px;background:linear-gradient(135deg,#4f7ef8,#6366f1);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
.un{font-size:11.5px;font-weight:600;color:#fff}
.upl{font-size:10px;color:rgba(255,255,255,.3)}
.lbtn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,.3);cursor:pointer;font-size:13px;padding:2px}
.lbtn:hover{color:#ef4444}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
main{margin-left:250px;flex:1;display:flex;flex-direction:column}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;gap:12px;flex-wrap:wrap}
.toggle-mode{background:none;border:none;padding:5px 11px;border-radius:7px;font-size:11.5px;font-weight:600;cursor:pointer;color:var(--muted);transition:.15s}
.toggle-mode.active{background:#fff;color:var(--blue);box-shadow:0 1px 4px rgba(0,0,0,.1)}
.topbar-left h1{font-size:17px;font-weight:800;display:flex;align-items:center;gap:8px}
.topbar-left p{font-size:11px;color:var(--muted);margin-top:2px}
.topbar-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:5px}
.btn-p{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;box-shadow:0 3px 10px rgba(26,61,206,.2)}
.btn-p:hover{opacity:.9}
.btn-o{background:#fff;color:var(--blue);border:1.5px solid var(--border)}
.btn-o:hover{border-color:var(--blue);background:#f0f4ff}
.year-sel{padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;background:#fff;cursor:pointer;color:var(--text)}

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
.content{padding:24px 28px;flex:1}

/* ‚îÄ‚îÄ KPI ROW ‚îÄ‚îÄ */
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:22px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:18px 16px;position:relative;overflow:hidden;transition:box-shadow .2s,transform .2s}
.kpi:hover{box-shadow:0 6px 24px rgba(26,61,206,.08);transform:translateY(-1px)}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi.blue::before{background:linear-gradient(90deg,var(--blue),var(--blue2))}
.kpi.green::before{background:linear-gradient(90deg,#10b981,#34d399)}
.kpi.red::before{background:linear-gradient(90deg,#ef4444,#f87171)}
.kpi.orange::before{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.kpi.teal::before{background:linear-gradient(90deg,#0d9488,#14b8a6)}
.kpi-icon{font-size:20px;margin-bottom:6px}
.kpi-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-bottom:5px}
.kpi-val{font-size:21px;font-weight:900;line-height:1;margin-bottom:4px}
.kpi-val.blue{color:var(--blue2)}
.kpi-val.green{color:var(--green)}
.kpi-val.red{color:var(--red)}
.kpi-val.orange{color:var(--orange)}
.kpi-val.teal{color:var(--teal)}
.kpi-sub{font-size:10px;color:var(--muted)}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.grid-3{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px}
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:8px}
.card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px}
.card-sub{font-size:11px;color:var(--muted);margin-top:1px}
.badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px}
.badge-blue{background:rgba(79,126,248,.1);color:var(--blue2)}
.badge-teal{background:rgba(13,148,136,.1);color:var(--teal)}
.badge-red{background:rgba(239,68,68,.1);color:var(--red)}

/* ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ */
.chart-wrap{position:relative;height:260px}
.chart-wrap-sm{position:relative;height:200px}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.mtable{width:100%;border-collapse:collapse;font-size:12px}
.mtable th{background:#f8f9fd;padding:8px 10px;text-align:left;font-weight:700;color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);white-space:nowrap}
.mtable td{padding:7px 10px;border-bottom:1px solid #f1f3f9;vertical-align:middle}
.mtable tr:last-child td{border-bottom:none}
.mtable tr:hover td{background:#f8f9fd}
.mtable .pos{color:var(--green);font-weight:700}
.mtable .neg{color:var(--red);font-weight:700}
.mtable .neu{color:var(--muted)}
.mtable tfoot td{font-weight:800;background:#f0f4ff;color:var(--blue);border-top:2px solid var(--border)}
.mlink{color:var(--blue2);text-decoration:none;font-weight:700;font-size:11px;padding:3px 8px;border:1px solid rgba(79,126,248,.2);border-radius:6px;transition:.15s}
.mlink:hover{background:rgba(79,126,248,.1)}

/* ‚îÄ‚îÄ SCORE ‚îÄ‚îÄ */
.score-wrap{display:flex;flex-direction:column;align-items:center;padding:8px 0 16px}
.score-ring{position:relative;width:110px;height:110px;margin:0 auto 10px}
.score-ring svg{transform:rotate(-90deg)}
.score-val{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.score-num{font-size:26px;font-weight:900;line-height:1}
.score-lbl{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-top:2px}
.score-cap{font-size:12px;font-weight:700;text-align:center}
.score-desc{font-size:10px;color:var(--muted);text-align:center;margin-top:4px;line-height:1.4;max-width:160px}

/* ‚îÄ‚îÄ R√âPARTITION ‚îÄ‚îÄ */
.rep-item{display:flex;align-items:center;gap:8px;margin-bottom:7px}
.rep-dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.rep-label{font-size:11px;flex:1}
.rep-pct{font-size:11px;font-weight:700}
.rep-val{font-size:10px;color:var(--muted);width:60px;text-align:right}

/* ‚îÄ‚îÄ ALERTES ‚îÄ‚îÄ */
.alert{border-radius:10px;padding:11px 14px;font-size:12px;line-height:1.5;display:flex;align-items:flex-start;gap:9px;margin-bottom:8px}
.alert:last-child{margin-bottom:0}
.alert.warn{background:#fffbeb;border:1px solid #fcd34d;color:#92400e}
.alert.danger{background:#fef2f2;border:1px solid #fecaca;color:#991b1b}
.alert.good{background:#f0fdf4;border:1px solid #86efac;color:#166534}
.alert.info{background:#f0f4ff;border:1px solid #c7d2fe;color:#3730a3}
.alert-icon{font-size:15px;flex-shrink:0;margin-top:1px}

/* ‚îÄ‚îÄ PR√âVISIONNEL ‚îÄ‚îÄ */
.prev-section{background:linear-gradient(135deg,#fffbf0 0%,#fff8e7 100%);border:1.5px solid #fcd34d;border-radius:var(--radius);padding:20px;margin-bottom:16px}
.prev-section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px}
.prev-title{font-size:14px;font-weight:800;color:#92400e;display:flex;align-items:center;gap:8px}
.prev-badge{font-size:10px;font-weight:700;background:#f59e0b;color:#fff;padding:2px 8px;border-radius:20px}
.prev-kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.prev-kpi{background:rgba(255,255,255,.8);border:1px solid #fcd34d;border-radius:10px;padding:14px}
.prev-kpi-lbl{font-size:10px;font-weight:700;color:#92400e;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.prev-kpi-val{font-size:19px;font-weight:900;margin-bottom:2px}
.prev-kpi-sub{font-size:10px;color:#b45309}
.prev-chart-row{display:grid;grid-template-columns:2fr 1fr;gap:14px;margin-bottom:14px}
.prev-table{width:100%;border-collapse:collapse;font-size:12px}
.prev-table th{background:rgba(245,158,11,.1);padding:7px 10px;text-align:left;font-weight:700;color:#92400e;font-size:10px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid #fcd34d}
.prev-table td{padding:7px 10px;border-bottom:1px solid rgba(252,211,77,.3);vertical-align:middle}
.prev-table tr:last-child td{border-bottom:none}
.prev-table tr:hover td{background:rgba(245,158,11,.04)}
.prev-table tfoot td{font-weight:800;background:rgba(245,158,11,.12);color:#92400e;border-top:1.5px solid #fcd34d}
.prev-pos{color:#059669;font-weight:700}
.prev-neg{color:#dc2626;font-weight:700}
.prev-neu{color:#b45309}

/* ‚îÄ‚îÄ TR√âSORERIE MODALE ‚îÄ‚îÄ */
.treso-modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9000;align-items:center;justify-content:center}
.treso-modal-bg.show{display:flex}
.treso-modal{background:#fff;border-radius:16px;padding:28px;width:100%;max-width:420px;box-shadow:0 20px 60px rgba(0,0,0,.25);margin:16px}
.treso-modal h3{font-size:16px;font-weight:800;margin-bottom:6px;display:flex;align-items:center;gap:8px}
.treso-modal p{font-size:12px;color:var(--muted);margin-bottom:18px;line-height:1.5}
.treso-modal label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:6px}
.treso-modal input{width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:16px;font-weight:700;color:var(--text);outline:none;transition:.2s;margin-bottom:6px}
.treso-modal input:focus{border-color:var(--blue2);box-shadow:0 0 0 3px rgba(79,126,248,.12)}
.treso-modal .treso-hint{font-size:10px;color:var(--muted);margin-bottom:18px}
.treso-modal-actions{display:flex;gap:8px;justify-content:flex-end}

/* ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ */
.loader-wrap{display:flex;align-items:center;justify-content:center;padding:80px;color:var(--muted);gap:10px;flex-direction:column}
.spin{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--blue2);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:768px){
  .hamburger{display:flex!important}
  nav{transform:translateX(-105%);transition:transform .3s cubic-bezier(.4,0,.2,1)}
  nav.open{transform:translateX(0)}
  main{margin-left:0}
  .kpi-row{grid-template-columns:repeat(2,1fr)!important}
  .grid-2,.grid-3{grid-template-columns:1fr}
  .prev-kpi-row{grid-template-columns:repeat(2,1fr)!important}
  .prev-chart-row{grid-template-columns:1fr!important}
}
@media(max-width:420px){
  .kpi-row{grid-template-columns:1fr!important}
  .prev-kpi-row{grid-template-columns:1fr!important}
}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
<!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
<main>
  <div class="topbar">
    <div class="topbar-left">
      <h1>üíß Cashflow</h1>
      <p id="topbar-sub">Analyse de la tr√©sorerie annuelle</p>
    </div>
    <div class="topbar-right">
      <div style="display:flex;align-items:center;gap:6px;background:#f4f6fb;border:1px solid #e2e8f0;border-radius:10px;padding:3px">
        <button id="btnCivil" class="toggle-mode active" onclick="setMode('civil')">üìÖ Civile</button>
        <button id="btnExerc" class="toggle-mode" onclick="setMode('exercice')">üìÜ Exercice</button>
      </div>
      <select id="exerciceStart" style="display:none;font-size:11.5px;border:1px solid #e2e8f0;border-radius:8px;padding:5px 8px;background:#fff;color:var(--text);font-family:inherit;cursor:pointer" onchange="onExerciceStartChange(this.value)">
        <option value="0">Jan</option><option value="1">F√©v</option><option value="2">Mar</option>
        <option value="3">Avr</option><option value="4" selected>Mai</option><option value="5">Jun</option>
        <option value="6">Jul</option><option value="7">Ao√ª</option><option value="8">Sep</option>
        <option value="9">Oct</option><option value="10">Nov</option><option value="11">D√©c</option>
      </select>
      <select class="year-sel" id="yearSelect" onchange="onYearChange()"></select>
      <button class="btn btn-o" onclick="location.href='pilotage.html'">üìä Pilotage</button>
    </div>
  </div>
  <div class="content" id="main-content">
    <div class="loader-wrap"><div class="spin"></div><span style="font-size:12px;color:var(--muted)">Chargement‚Ä¶</span></div>
  </div>
</main>

<!-- ‚îÄ‚îÄ TR√âSORERIE MODALE ‚îÄ‚îÄ -->
<div class="treso-modal-bg" id="tresoModalBg" onclick="if(event.target===this)closeTresoModal()">
  <div class="treso-modal">
    <h3>üí∞ Tr√©sorerie disponible</h3>
    <p>Indiquez le solde de votre compte bancaire professionnel √† ce jour. Cette valeur sert de point de d√©part pour calculer votre cashflow futur r√©el.</p>
    <label>Solde disponible (‚Ç¨)</label>
    <input type="text" inputmode="decimal" id="tresoInput" placeholder="Ex: 12 500" />
    <div class="treso-hint">Montant en euros ‚Äî peut √™tre n√©gatif (ex: d√©couvert)</div>
    <label>Date de mise √† jour</label>
    <input type="date" id="tresoDate" />
    <div style="height:12px"></div>
    <div class="treso-modal-actions">
      <button class="btn btn-o" onclick="closeTresoModal()">Annuler</button>
      <button class="btn btn-p" onclick="saveTresorerieDisponible()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });

  const auth = getAuth(app);
  const db   = getFirestore(app);

  window._db      = db;
  window._auth    = auth;
  window._doc     = doc;
  window._getDoc  = getDoc;
  window._setDoc  = setDoc;
  window._signOut = signOut;
  window._firebaseReady = true;

  onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = 'index.html'; return; }
    window._uid = user.uid;

    try {
      const snap = await getDoc(doc(db, 'users', user.uid));
      if (snap.exists()) {
        const d = snap.data();
        const initials = (d.prenom || d.email || 'U')[0].toUpperCase();
        document.getElementById('av').textContent = initials;
        document.getElementById('uname').textContent = d.prenom ? (d.prenom + ' ' + (d.nom||'')).trim() : d.email;
        // Charger les pr√©f√©rences de gestion
        if (d.fiscalStart !== undefined) _exerciceStartMonth = parseInt(d.fiscalStart);
        if (d.viewMode) {
          _mode = d.viewMode;
          // Appliquer le mode visuellement apr√®s le DOM
          setTimeout(function() {
            setMode(_mode);
            const exSel = document.querySelector('#exerciceStart select');
            if (exSel) exSel.value = _exerciceStartMonth;
          }, 50);
        }
      }
    } catch(e) {}

    initPage();
  });
</script>

<script>
/* ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ */
function fmt(n) {
  if (n === null || n === undefined || isNaN(n)) return '‚Äî';
  const abs = Math.abs(n);
  const sign = n < 0 ? '‚àí' : '';
  return sign + abs.toLocaleString('fr-FR', {minimumFractionDigits:0, maximumFractionDigits:0}) + ' ‚Ç¨';
}
function fmtK(n) {
  if (isNaN(n) || n === null) return '‚Äî';
  if (Math.abs(n) >= 1000) return (n < 0 ? '‚àí' : '') + (Math.abs(n)/1000).toFixed(1) + ' k‚Ç¨';
  return fmt(n);
}
function pf(v) { return parseFloat(('' + (v||0)).replace(',','.')) || 0; }

const MS = ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];
const ML = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];

function toggleSub(el) {
  const sub = el.nextElementSibling;
  if (sub && sub.classList.contains('sub')) {
    sub.classList.toggle('open');
  }
}
async function handleLogout() {
  await window._signOut(window._auth);
  window.location.href = 'index.html';
}

/* ‚îÄ‚îÄ MODE : civil | exercice ‚îÄ‚îÄ */
// Mois de d√©but exercice (0=Jan ‚Ä¶ 4=Mai) ‚Äî align√© sur suivi-CA
var _mode = 'civil';
var _exerciceStartMonth = 0; // Sera charg√© depuis Firebase

function setMode(mode) {
  _mode = mode;
  document.getElementById('btnCivil').classList.toggle('active', mode === 'civil');
  document.getElementById('btnExerc').classList.toggle('active', mode === 'exercice');
  document.getElementById('exerciceStart').style.display = mode === 'exercice' ? 'block' : 'none';
  onYearChange();
}

function onExerciceStartChange(val) {
  _exerciceStartMonth = parseInt(val);
  onYearChange();
}

function onYearChange() {
  const year = parseInt(document.getElementById('yearSelect').value);
  loadYear(year);
}

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
function initPage() {
  const now = new Date();
  const curYear = now.getFullYear();
  const sel = document.getElementById('yearSelect');
  for (let y = curYear - 2; y <= curYear + 1; y++) {
    const o = document.createElement('option');
    o.value = y; o.textContent = y;
    if (y === curYear) o.selected = true;
    sel.appendChild(o);
  }
  loadYear(curYear);
}

/* ‚îÄ‚îÄ CHARGER DONN√âES ‚îÄ‚îÄ */
async function loadYear(year) {
  window._currentYear = year;

  // Construire la liste des 12 mois selon le mode
  // Mode civil  : Jan‚ÜíD√©c de l'ann√©e s√©lectionn√©e
  // Mode exercice : du mois de d√©but jusqu'√† mois-1 de l'ann√©e suivante
  // ex: Mai 2025 ‚Üí Avr 2026 quand exercice d√©marre en Mai
  var monthKeys = [];
  if (_mode === 'civil') {
    for (var m = 0; m < 12; m++) {
      monthKeys.push({ m, key: year + '-' + String(m+1).padStart(2,'0') });
    }
  } else {
    // Exercice : d√©marre √† _exerciceStartMonth (ex: 4 = Mai)
    for (var i = 0; i < 12; i++) {
      var absM = _exerciceStartMonth + i;
      var y = year + Math.floor(absM / 12);
      var m = absM % 12;
      monthKeys.push({ m, key: y + '-' + String(m+1).padStart(2,'0') });
    }
  }

  var moisDebut = MS[monthKeys[0].m];
  var moisFin   = MS[monthKeys[11].m];
  var labelPeriode = _mode === 'civil'
    ? 'Ann√©e civile ' + year
    : 'Exercice ' + moisDebut + ' ' + year + ' ‚Äì ' + moisFin + ' ' + (year+1);

  document.getElementById('topbar-sub').textContent = 'Analyse de la tr√©sorerie ¬∑ ' + labelPeriode;
  document.getElementById('main-content').innerHTML =
    '<div class="loader-wrap"><div class="spin"></div><span style="font-size:12px;color:var(--muted)">Chargement‚Ä¶</span></div>';

  const uid = window._uid;
  const months = [];

  for (var ki = 0; ki < monthKeys.length; ki++) {
    var mk = monthKeys[ki];
    try {
      const snap = await window._getDoc(window._doc(window._db, 'pilotage', uid, 'months', mk.key));
      months.push({ m: mk.m, key: mk.key, raw: snap.exists() ? snap.data() : null });
    } catch(e) {
      months.push({ m: mk.m, key: mk.key, raw: null });
    }
  }

  // Dettes
  let dettes = [];
  try {
    const snap = await window._getDoc(window._doc(window._db, 'dettes', uid, 'data', 'all'));
    if (snap.exists()) {
      dettes = (snap.data().list || []).filter(x => x && (x.nom || x.montant));
    }
  } catch(e) {}

  // Tr√©sorerie disponible
  let tresorerieConfig = { solde: null, date: null };
  try {
    const snap = await window._getDoc(window._doc(window._db, 'cashflow', uid, 'config', 'tresorerie'));
    if (snap.exists()) {
      tresorerieConfig = snap.data();
    }
  } catch(e) {}
  window._tresorerieConfig = tresorerieConfig;

  // Labels X adapt√©s au mode
  var labels = monthKeys.map(function(mk) { return MS[mk.m]; });

  var nowKeyCF = (new Date()).getFullYear() + '-' + String((new Date()).getMonth()+1).padStart(2,'0');
  const computed = months.map(function(mo) {
    var r = calcMonth(mo.m, mo.raw, mo.key > nowKeyCF);
    r.key = mo.key;
    return r;
  });
  renderPage(computed, dettes, year, labels, labelPeriode, tresorerieConfig);
}

function calcMonth(m, raw, isFuture) {
  if (!raw) return { m, hasData:false, caHT:0, caTotal:0, rentreeSupp:0, prevCA:0, chargesHT:0, fixesHT:0, varHT:0, leasingHT:0, creditsPrincipal:0, creditsInteret:0, cashflow:0, tvaCollectee:0, tvaDed:0, tvaDue:0, prevCharges:0, isFuture:!!isFuture };

  // CA journalier
  let caHT = 0, tvaC = 0;
  (raw.ca||[]).forEach(r => {
    const a=pf(r.ht055),b=pf(r.ht10),c=pf(r.ht20);
    caHT += a+b+c;
    tvaC += a*0.055 + b*0.10 + c*0.20;
  });
  // Factures pro
  (raw.facturesPro||[]).forEach(r => {
    const ht=pf(r.montantHT), rate=pf(r.tvaRate||20);
    caHT += ht; tvaC += ht*rate/100;
  });
  // Rentr√©es supp
  let rentreeSupp = 0;
  (raw.rentreesSupp||[]).forEach(r => { rentreeSupp += pf(r.montant); });
  caHT += rentreeSupp;

  // Pr√©vision
  let prevCA = 0;
  (raw.previsionCA||[]).forEach(r => { prevCA += pf(r.montant); });

  // Charges fixes
  let fixesHT=0, tvaDedF=0;
  (raw.chargesFixe||[]).forEach(r => {
    const ht=pf(r.montantHT), rate=pf(r.tvaRate||20);
    fixesHT += ht;
    if (r.deductible !== 'Non') tvaDedF += ht*rate/100;
  });
  // Charges variables
  let varHT=0, tvaDedV=0;
  (raw.chargesVar||[]).forEach(r => {
    const ht=pf(r.montantHT), rate=pf(r.tvaRate||20);
    varHT += ht;
    if (r.deductible !== 'Non') tvaDedV += ht*rate/100;
  });
  // Leasing
  let leasingHT=0, tvaDedL=0;
  (raw.leasing||[]).forEach(r => {
    const ht=pf(r.montantHT), rate=pf(r.tvaRate||20);
    leasingHT += ht;
    if (r.deductible !== 'Non') tvaDedL += ht*rate/100;
  });
  // Cr√©dits
  let creditsPrincipal=0, creditsInteret=0, tvaDedCr=0;
  (raw.credits||[]).forEach((r,i) => {
    const arr = raw.credits;
    if (r.ligneType === 'principal') {
      creditsPrincipal += pf(r.montant);
    } else {
      let interet = pf(r.montant);
      if (r.tvaAuto) {
        const principal = arr.slice(0,i).reverse().find(c => c.fournisseur===r.fournisseur && c.ligneType==='principal');
        if (principal) interet = pf(principal.montant) * pf(r.tauxInteret) / 100 / 12;
      }
      creditsInteret += interet;
      tvaDedCr += interet * pf(r.tvaRate||20) / 100;
    }
  });

  const chargesHT = fixesHT + varHT + leasingHT + creditsPrincipal + creditsInteret;
  const tvaDed = tvaDedF + tvaDedV + tvaDedL + tvaDedCr;
  const tvaDue = tvaC - tvaDed;

  // Mois futur ‚Üí tout en pr√©visionnel
  const prevCharges  = isFuture ? chargesHT : 0;
  const prevCAFutur  = isFuture ? caHT : 0;
  const prevCAFinal  = isFuture ? (prevCA || prevCAFutur) : prevCA;
  const caHTReel     = isFuture ? 0 : (caHT - rentreeSupp);
  const caTotalReel  = isFuture ? 0 : caHT;
  const cashflow     = isFuture ? 0 : (caHT - chargesHT);

  return { m, hasData:true,
    caHT: caHTReel, caTotal: caTotalReel, rentreeSupp: isFuture?0:rentreeSupp,
    prevCA: prevCAFinal, prevCharges, isFuture: !!isFuture,
    chargesHT: isFuture?0:chargesHT,
    fixesHT: isFuture?0:fixesHT, varHT: isFuture?0:varHT,
    leasingHT: isFuture?0:leasingHT,
    creditsPrincipal: isFuture?0:creditsPrincipal, creditsInteret: isFuture?0:creditsInteret,
    cashflow, tvaCollectee: isFuture?0:tvaC, tvaDed: isFuture?0:tvaDed, tvaDue: isFuture?0:tvaDue };
}

/* ‚îÄ‚îÄ SECTION PR√âVISIONNELLE ‚îÄ‚îÄ */
function buildPrevSection(data, labels, year, tresoDisponible) {
  const futurMois = data.filter(d => d.isFuture);
  if (futurMois.length === 0) return '';

  const prevCA_tot     = futurMois.reduce((s,d) => s + (d.prevCA||0), 0);
  const prevCharges_tot= futurMois.reduce((s,d) => s + (d.prevCharges||0), 0);
  const prevResultat   = prevCA_tot - prevCharges_tot;
  const prevCF_tot     = futurMois.reduce((s,d) => s + (d.prevCA||0) - (d.prevCharges||0), 0);

  // Solde cumul√© r√©el √† fin du dernier mois r√©el
  const realMois = data.filter(d => !d.isFuture && d.hasData);
  const soldeCumulReel = realMois.reduce((s,d) => s + d.cashflow, 0);

  // Point de d√©part : tr√©sorerie r√©elle si renseign√©e, sinon cashflow cumul√©
  const startingBalance = tresoDisponible !== null && tresoDisponible !== undefined ? tresoDisponible : soldeCumulReel;
  const startingLabel = tresoDisponible !== null && tresoDisponible !== undefined
    ? `Tr√©sorerie r√©elle : ${fmtK(tresoDisponible)}`
    : `Cashflow cumul√© : ${fmtK(soldeCumulReel)}`;

  // Projection solde cumul√© avec pr√©visionnel
  let cumul = startingBalance;
  const cumulPrev = data.map(d => {
    if (!d.isFuture && d.hasData) { return null; }
    if (!d.isFuture && !d.hasData) return null;
    cumul += (d.prevCA||0) - (d.prevCharges||0);
    return cumul;
  });

  const soldeFinalProjet√© = startingBalance + prevCF_tot;

  const scoreColor = prevResultat > 0 ? '#059669' : prevResultat < 0 ? '#dc2626' : '#f59e0b';

  const rows = futurMois.map(d => {
    const res = (d.prevCA||0) - (d.prevCharges||0);
    const idx = data.indexOf(d);
    const mLabel = labels[idx] || MS[d.m];
    return `<tr>
      <td style="font-weight:700;color:#92400e">${mLabel}</td>
      <td class="${(d.prevCA||0)>0?'prev-pos':'prev-neu'}">${(d.prevCA||0)>0?fmt(d.prevCA):'<span style="color:#d1d5db">Non saisi</span>'}</td>
      <td class="prev-neu">${(d.prevCharges||0)>0?fmt(d.prevCharges):'‚Äî'}</td>
      <td class="${res>0?'prev-pos':res<0?'prev-neg':'prev-neu'}">${(d.prevCA||0)>0||(d.prevCharges||0)>0?fmt(res):'‚Äî'}</td>
      <td><a href="pilotage.html" style="color:#f59e0b;text-decoration:none;font-size:11px;font-weight:700">Saisir ‚Üí</a></td>
    </tr>`;
  }).join('');

  return `<div class="prev-section">
    <div class="prev-section-head">
      <div class="prev-title">üîÆ Projection pr√©visionnelle <span class="prev-badge">${futurMois.length} mois √† venir</span></div>
      <div style="font-size:11px;color:#b45309">Bas√© sur les charges saisies dans le Pilotage ¬∑ Saisir un CA pr√©visionnel pour affiner</div>
    </div>

    <div class="prev-kpi-row">
      <div class="prev-kpi">
        <div class="prev-kpi-lbl">CA pr√©visionnel</div>
        <div class="prev-kpi-val" style="color:#1a3dce">${prevCA_tot>0?fmtK(prevCA_tot):'<span style="color:#d1d5db;font-size:14px">Non saisi</span>'}</div>
        <div class="prev-kpi-sub">Objectifs CA restants</div>
      </div>
      <div class="prev-kpi">
        <div class="prev-kpi-lbl">Charges pr√©visionnelles</div>
        <div class="prev-kpi-val" style="color:#f59e0b">${prevCharges_tot>0?fmtK(prevCharges_tot):'<span style="color:#d1d5db;font-size:14px">‚Äî</span>'}</div>
        <div class="prev-kpi-sub">Fixes + Var + Cr√©dits + Leasing</div>
      </div>
      <div class="prev-kpi">
        <div class="prev-kpi-lbl">R√©sultat pr√©visionnel</div>
        <div class="prev-kpi-val" style="color:${scoreColor}">${prevCA_tot>0||prevCharges_tot>0?fmtK(prevResultat):'<span style="color:#d1d5db;font-size:14px">‚Äî</span>'}</div>
        <div class="prev-kpi-sub">CA pr√©vi ‚àí Charges pr√©vi</div>
      </div>
      <div class="prev-kpi">
        <div class="prev-kpi-lbl">Solde projet√© fin de p√©riode</div>
        <div class="prev-kpi-val" style="color:${soldeFinalProjet√©>=0?'#059669':'#dc2626'}">${fmtK(soldeFinalProjet√©)}</div>
        <div class="prev-kpi-sub">${startingLabel} + pr√©vi ${fmtK(prevCF_tot)}</div>
      </div>
    </div>

    <div class="prev-chart-row">
      <div style="background:rgba(255,255,255,.7);border:1px solid #fcd34d;border-radius:10px;padding:16px">
        <div style="font-size:12px;font-weight:700;color:#92400e;margin-bottom:12px">üìà Cashflow projet√© ‚Äî mois √† venir</div>
        <div style="height:200px;position:relative"><canvas id="prevChart"></canvas></div>
      </div>
      <div style="background:rgba(255,255,255,.7);border:1px solid #fcd34d;border-radius:10px;padding:16px">
        <div style="font-size:12px;font-weight:700;color:#92400e;margin-bottom:12px">üìä R√©partition pr√©vision</div>
        <div style="height:200px;position:relative"><canvas id="prevDoughnut"></canvas></div>
      </div>
    </div>

    <div style="overflow-x:auto">
      <table class="prev-table">
        <thead><tr><th>Mois</th><th>CA pr√©vi.</th><th>Charges pr√©vi.</th><th>R√©sultat pr√©vi.</th><th></th></tr></thead>
        <tbody>${rows}</tbody>
        <tfoot>
          <tr>
            <td>Total pr√©visionnel</td>
            <td>${prevCA_tot>0?fmt(prevCA_tot):'‚Äî'}</td>
            <td>${prevCharges_tot>0?fmt(prevCharges_tot):'‚Äî'}</td>
            <td class="${prevResultat>=0?'prev-pos':'prev-neg'}">${prevCA_tot>0||prevCharges_tot>0?fmt(prevResultat):'‚Äî'}</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>`;
}

/* ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ */
function renderPage(data, dettes, year, labels, labelPeriode, tresorerieConfig) {
  if (!labels) labels = MS; // fallback
  tresorerieConfig = tresorerieConfig || { solde: null, date: null };
  const tresoDisponible = tresorerieConfig.solde !== null && tresorerieConfig.solde !== undefined ? parseFloat(tresorerieConfig.solde) : null;
  const tresoDate = tresorerieConfig.date || null;
  // Mois courant : position dans le tableau data qui correspond au mois actuel
  const _now = new Date();
  const _curY = _now.getFullYear();
  const _curM = _now.getMonth();
  const curMonth = data.findIndex(d => {
    const parts = (d.key||'').split('-');
    return parseInt(parts[0])===_curY && parseInt(parts[1])-1===_curM;
  });
  const filled = data.filter(d => d.hasData);
  // filled = mois ayant des donn√©es (pass√©s uniquement pour les r√©els)
  const allFilled   = data.filter(d => d.hasData);
  const totCA       = filled.reduce((s,d) => s+d.caTotal, 0);
  const totCharges  = filled.reduce((s,d) => s+d.chargesHT, 0);
  const totCF       = filled.reduce((s,d) => s+d.cashflow, 0);
  const totTVA      = filled.reduce((s,d) => s+d.tvaDue, 0);
  const totPrev     = filled.reduce((s,d) => s+d.prevCA, 0);
  // Pr√©visionnel (mois futurs avec charges saisies)
  const totPrevCharges = data.reduce((s,d) => s+d.prevCharges, 0);
  const totPrevCA      = data.reduce((s,d) => s+(d.isFuture?(d.prevCA||0):0), 0);
  const totPrevResultat= totPrevCA - totPrevCharges;
  const delta       = totCA - totPrev;
  const totalFixe   = filled.reduce((s,d) => s+d.fixesHT, 0);
  const totalVar    = filled.reduce((s,d) => s+d.varHT, 0);
  const totalLeas   = filled.reduce((s,d) => s+d.leasingHT, 0);
  const totalCred   = filled.reduce((s,d) => s+d.creditsPrincipal+d.creditsInteret, 0);

  // Solde cumul√© ‚Äî part de la tr√©sorerie r√©elle si disponible
  let cumul = tresoDisponible !== null ? tresoDisponible : 0;
  const cumulBase = cumul;
  const cumulArr = data.map(d => { if (d.hasData) cumul += d.cashflow; return d.hasData ? cumul : null; });

  // Score sant√©
  const posM = filled.filter(d => d.cashflow > 0).length;
  const cfRatio = totCA > 0 ? totCF / totCA : 0;
  const score = filled.length === 0 ? 0 : Math.round(Math.min(100, Math.max(0,
    (posM / Math.max(filled.length,1)) * 50 +
    (cfRatio > 0 ? Math.min(cfRatio * 200, 40) : 0) +
    (totCA > 0 ? 10 : 0)
  )));
  const scoreColor = score >= 70 ? '#10b981' : score >= 40 ? '#f59e0b' : '#ef4444';
  const scoreLabel = score >= 70 ? 'Bonne sant√©' : score >= 40 ? '√Ä surveiller' : 'Fragile';
  const scoreDesc  = score >= 70 ? 'Tr√©sorerie saine sur cette p√©riode.' : score >= 40 ? 'Quelques mois n√©gatifs √† surveiller.' : 'Plusieurs mois en d√©ficit ‚Äî action recommand√©e.';

  // Alertes
  const alerts = [];
  const negM = filled.filter(d => d.cashflow < 0);
  if (negM.length >= 3)      alerts.push({type:'danger', icon:'üö®', txt:`${negM.length} mois avec cashflow n√©gatif (${negM.map(d=>MS[d.m]).join(', ')}). R√©visez vos charges.`});
  else if (negM.length >= 1) alerts.push({type:'warn',   icon:'‚ö†Ô∏è', txt:`${negM.length} mois avec cashflow n√©gatif (${negM.map(d=>MS[d.m]).join(', ')}). Surveillez ces p√©riodes.`});
  if (totPrev > 0 && totCA < totPrev * 0.85) alerts.push({type:'warn', icon:'üìâ', txt:`CA r√©el √† ${Math.round((totCA/totPrev)*100)}% des pr√©visions. V√©rifiez vos objectifs.`});
  if (totCF > 0 && filled.length > 0)        alerts.push({type:'good', icon:'‚úÖ', txt:`Cashflow annuel positif de ${fmt(totCF)}. Pensez √† constituer une r√©serve.`});
  if (filled.length === 0)                    alerts.push({type:'info', icon:'‚ÑπÔ∏è', txt:`Aucune donn√©e pour ${year}. Saisissez vos mois dans le Pilotage.`});

  const html = `
    <div class="kpi-row" style="grid-template-columns:repeat(6,1fr)">
      <div class="kpi ${tresoDisponible===null?'blue':tresoDisponible>=0?'green':'red'}" style="cursor:pointer" onclick="openTresoModal()" title="Cliquer pour mettre √† jour">
        <div class="kpi-icon">üè¶</div>
        <div class="kpi-label">Tr√©sorerie disponible <span style="font-size:9px;opacity:.6">‚úèÔ∏è</span></div>
        <div class="kpi-val ${tresoDisponible===null?'blue':tresoDisponible>=0?'green':'red'}">${tresoDisponible!==null?fmtK(tresoDisponible):'<span style="font-size:13px;color:#d1d5db">Non renseign√©</span>'}</div>
        <div class="kpi-sub">${tresoDate?'Mis √† jour le '+tresoDate:'Cliquer pour saisir votre solde'}</div>
      </div>
      <div class="kpi blue"><div class="kpi-icon">üí∞</div><div class="kpi-label">CA Total HT</div><div class="kpi-val blue">${fmtK(totCA)}</div><div class="kpi-sub">${filled.length} mois enregistr√©s</div></div>
      <div class="kpi ${totCharges>totCA?'red':'orange'}"><div class="kpi-icon">üì¶</div><div class="kpi-label">Charges r√©elles HT</div><div class="kpi-val ${totCharges>totCA?'red':'orange'}">${fmtK(totCharges)}</div><div class="kpi-sub">${totPrevCharges>0?`<span style="color:#b45309">+ ${fmtK(totPrevCharges)} pr√©vi</span>`:(totCA>0?Math.round((totCharges/totCA)*100)+'% du CA':'‚Äî')}</div></div>
      <div class="kpi ${totCF>=0?'green':'red'}"><div class="kpi-icon">üíß</div><div class="kpi-label">Cashflow Net</div><div class="kpi-val ${totCF>=0?'green':'red'}">${fmtK(totCF)}</div><div class="kpi-sub">${totCF>=0?'Exc√©dent':'D√©ficit'} annuel</div></div>
      <div class="kpi teal"><div class="kpi-icon">üßæ</div><div class="kpi-label">TVA ${totTVA>=0?'√† payer':'Cr√©dit'}</div><div class="kpi-val teal">${fmtK(Math.abs(totTVA))}</div><div class="kpi-sub">${totTVA>=0?'√† reverser √† l\'√âtat':'cr√©dit TVA'}</div></div>
      <div class="kpi ${totPrevCharges>0?(totPrevResultat>=0?'teal':'orange'):(delta>=0?'green':'red')}"><div class="kpi-icon">${totPrevCharges>0?'üîÆ':(delta>=0?'üéØ':'üìâ')}</div><div class="kpi-label">${totPrevCharges>0?'R√©sultat pr√©visionnel':'Delta Pr√©vi/R√©el'}</div><div class="kpi-val ${totPrevCharges>0?(totPrevResultat>=0?'teal':'orange'):(delta>=0?'green':'red')}">${totPrevCharges>0?fmtK(totPrevResultat):(totPrev>0?fmtK(delta):'‚Äî')}</div><div class="kpi-sub">${totPrevCharges>0?`Charges futures : ${fmtK(totPrevCharges)}`:(totPrev>0?'Pr√©vi : '+fmtK(totPrev):'Pas de pr√©vision')}</div></div>
    </div>

    <div class="grid-3">
      <div class="card">
        <div class="card-head"><div><div class="card-title">üíß Cashflow mensuel <span class="badge badge-blue">${year}</span></div><div class="card-sub">CA et cashflow mois par mois</div></div></div>
        <div class="chart-wrap"><canvas id="cfChart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-head"><div><div class="card-title">ü©∫ Score tr√©sorerie</div><div class="card-sub">Sant√© globale ${year}</div></div></div>
        <div class="score-wrap">
          <div class="score-ring">
            <svg width="110" height="110" viewBox="0 0 110 110">
              <circle cx="55" cy="55" r="46" fill="none" stroke="#f0f4ff" stroke-width="11"/>
              <circle cx="55" cy="55" r="46" fill="none" stroke="${scoreColor}" stroke-width="11"
                stroke-dasharray="${Math.round(289*score/100)} 289" stroke-linecap="round"/>
            </svg>
            <div class="score-val"><div class="score-num" style="color:${scoreColor}">${score}</div><div class="score-lbl">/ 100</div></div>
          </div>
          <div class="score-cap" style="color:${scoreColor}">${scoreLabel}</div>
          <div class="score-desc">${scoreDesc}</div>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:12px;margin-top:4px">
          <div style="font-size:11px;font-weight:700;margin-bottom:8px;color:var(--text)">R√©partition charges</div>
          ${totalFixe>0?`<div class="rep-item"><div class="rep-dot" style="background:#f59e0b"></div><div class="rep-label">Fixes</div><div class="rep-pct">${totCharges>0?Math.round((totalFixe/totCharges)*100)+'%':'‚Äî'}</div><div class="rep-val">${fmtK(totalFixe)}</div></div>`:''}
          ${totalVar>0?`<div class="rep-item"><div class="rep-dot" style="background:#10b981"></div><div class="rep-label">Variables</div><div class="rep-pct">${totCharges>0?Math.round((totalVar/totCharges)*100)+'%':'‚Äî'}</div><div class="rep-val">${fmtK(totalVar)}</div></div>`:''}
          ${totalLeas>0?`<div class="rep-item"><div class="rep-dot" style="background:#6366f1"></div><div class="rep-label">Leasing</div><div class="rep-pct">${totCharges>0?Math.round((totalLeas/totCharges)*100)+'%':'‚Äî'}</div><div class="rep-val">${fmtK(totalLeas)}</div></div>`:''}
          ${totalCred>0?`<div class="rep-item"><div class="rep-dot" style="background:#ef4444"></div><div class="rep-label">Cr√©dits</div><div class="rep-pct">${totCharges>0?Math.round((totalCred/totCharges)*100)+'%':'‚Äî'}</div><div class="rep-val">${fmtK(totalCred)}</div></div>`:''}
          ${totCharges===0?'<div style="text-align:center;color:var(--muted);font-size:11px;padding:8px 0">Aucune charge</div>':''}
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-head"><div><div class="card-title">üìà Solde cumul√© <span class="badge badge-teal">√âvolution</span></div><div class="card-sub">Tr√©sorerie accumul√©e sur l'ann√©e</div></div></div>
        <div class="chart-wrap-sm"><canvas id="cumulChart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-head"><div><div class="card-title">‚ö° Alertes &amp; Recommandations</div><div class="card-sub">Points d'attention</div></div></div>
        ${alerts.length===0
          ? '<div style="text-align:center;padding:30px;color:var(--muted)"><div style="font-size:36px;margin-bottom:8px">‚úÖ</div><p style="font-size:12px">Aucune alerte d√©tect√©e</p></div>'
          : alerts.map(a=>`<div class="alert ${a.type}"><span class="alert-icon">${a.icon}</span><span>${a.txt}</span></div>`).join('')
        }
      </div>
    </div>

    ${buildPrevSection(data, labels, year, tresoDisponible)}

    <div class="card" style="margin-bottom:16px">
      <div class="card-head">
        <div><div class="card-title">üóì D√©tail mensuel <span class="badge badge-blue">${year}</span></div><div class="card-sub">Vue compl√®te mois par mois</div></div>
        <a href="pilotage.html" class="btn btn-o" style="font-size:11px">üìä Saisir donn√©es</a>
      </div>
      <div style="overflow-x:auto">
        <table class="mtable">
          <thead><tr><th>Mois</th><th>CA R√©el HT</th><th>Pr√©vision</th><th>Charges HT</th><th>Fixes</th><th>Variables</th><th>Cr√©dits</th><th>Cashflow</th><th>TVA due</th><th>Solde cumul√©</th><th></th></tr></thead>
          <tbody>
            ${data.map((d,i) => {
              const cv = cumulArr[i];
              const isCur = i === curMonth;
              return `<tr style="${isCur?'background:#f0f4ff;font-weight:600':''}">
                <td style="font-weight:700">${isCur?'‚ñ∂ ':''}${labels[i]||MS[d.m]}</td>
                <td class="${d.hasData?(d.caTotal>0?'pos':'neu'):'neu'}">${d.hasData?fmt(d.caTotal):'<span style="color:#d1d5db">‚Äî</span>'}</td>
                <td class="neu">${d.hasData&&d.prevCA>0?fmt(d.prevCA):'<span style="color:#d1d5db">‚Äî</span>'}</td>
                <td class="${d.hasData?'neg':'neu'}">${d.hasData?fmt(d.chargesHT):'<span style="color:#d1d5db">‚Äî</span>'}</td>
                <td class="neu">${d.hasData&&d.fixesHT>0?fmt(d.fixesHT):'‚Äî'}</td>
                <td class="neu">${d.hasData&&d.varHT>0?fmt(d.varHT):'‚Äî'}</td>
                <td class="neu">${d.hasData&&(d.creditsPrincipal+d.creditsInteret)>0?fmt(d.creditsPrincipal+d.creditsInteret):'‚Äî'}</td>
                <td class="${!d.hasData?'neu':d.cashflow>=0?'pos':'neg'}">${d.hasData?fmt(d.cashflow):'<span style="color:#d1d5db">‚Äî</span>'}</td>
                <td style="${d.hasData&&d.tvaDue>0?'color:var(--teal)':''}">${d.hasData?fmt(Math.abs(d.tvaDue))+(d.tvaDue<0?' <span style="font-size:9px">(cr√©dit)</span>':''):'‚Äî'}</td>
                <td class="${cv===null?'neu':cv>=0?'pos':'neg'}">${cv!==null?fmt(cv):'‚Äî'}</td>
                <td><a href="pilotage.html?year=${year}" class="mlink">Voir ‚Üí</a></td>
              </tr>`;
            }).join('')}
          </tbody>
          <tfoot>
            <tr><td>TOTAL ${year}</td><td>${fmt(totCA)}</td><td>${totPrev>0?fmt(totPrev):'‚Äî'}</td><td>${fmt(totCharges)}</td><td>${fmt(totalFixe)}</td><td>${fmt(totalVar)}</td><td>${fmt(totalCred)}</td>
            <td class="${totCF>=0?'pos':'neg'}">${fmt(totCF)}</td>
            <td style="color:var(--teal)">${fmt(totTVA)}</td>
            <td class="${(cumulArr[11]||0)>=0?'pos':'neg'}">${cumulArr.filter(v=>v!==null).pop()!==undefined?fmt(cumulArr.filter(v=>v!==null).pop()):'‚Äî'}</td>
            <td></td></tr>
          </tfoot>
        </table>
      </div>
    </div>

    ${dettes.length>0?`
    <div class="card" style="margin-bottom:16px">
      <div class="card-head">
        <div><div class="card-title">üè¶ Engagements financiers <span class="badge badge-red">Dettes &amp; Emprunts</span></div><div class="card-sub">Impact sur votre tr√©sorerie</div></div>
        <a href="dettes.html" class="btn btn-o" style="font-size:11px">G√©rer ‚Üí</a>
      </div>
      ${dettes.slice(0,6).map(d=>`
        <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f3f9">
          <div><div style="font-size:12px;font-weight:600">${d.nom||d.fournisseur||'Emprunt'}</div><div style="font-size:10px;color:var(--muted)">${d.type||''} ${d.dateDebut?'¬∑ Depuis '+d.dateDebut:''}</div></div>
          <div style="text-align:right"><div style="font-size:13px;font-weight:800;color:var(--red)">${fmt(pf(d.montantRestant||d.montant||0))}</div><div style="font-size:10px;color:var(--muted)">${d.mensualite?fmt(pf(d.mensualite))+'/mois':''}</div></div>
        </div>`).join('')}
    </div>`:''}
  `;

  document.getElementById('main-content').innerHTML = html;

  // Chart cashflow ‚Äî r√©el + pr√©visionnel superpos√©
  const cfCtx = document.getElementById('cfChart');
  if (cfCtx) {
    const caReelData   = data.map(d => (!d.isFuture && d.hasData) ? d.caTotal : null);
    const caPreviData  = data.map(d => d.isFuture ? (d.prevCA||null) : null);
    const cfReelData   = data.map(d => (!d.isFuture && d.hasData) ? d.cashflow : null);
    const cfPreviData  = data.map(d => d.isFuture ? ((d.prevCA||0) - (d.prevCharges||0)) : null);

    new Chart(cfCtx, {
      data: {
        labels: labels,
        datasets: [
          { type:'line', label:'CA HT r√©el',     data: caReelData,  borderColor:'#4f7ef8', backgroundColor:'rgba(79,126,248,.06)',  borderWidth:2, pointRadius:4, pointBackgroundColor:'#4f7ef8', tension:.4, fill:false, spanGaps:false },
          { type:'line', label:'CA pr√©visionnel', data: caPreviData, borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,.08)', borderWidth:2, borderDash:[5,4], pointRadius:4, pointBackgroundColor:'#f59e0b', tension:.4, fill:false, spanGaps:false },
          { type:'bar',  label:'Cashflow r√©el',   data: cfReelData,  backgroundColor: data.map(d=>(!d.isFuture&&d.hasData)?(d.cashflow>=0?'rgba(16,185,129,.8)':'rgba(239,68,68,.8)'):'transparent'), borderRadius:5 },
          { type:'bar',  label:'Cashflow pr√©vi.', data: cfPreviData, backgroundColor: data.map(d=>d.isFuture?((d.prevCA||0)-(d.prevCharges||0)>=0?'rgba(245,158,11,.45)':'rgba(239,68,68,.35)'):'transparent'), borderRadius:5, borderWidth:1.5, borderColor: data.map(d=>d.isFuture?'#f59e0b':'transparent') }
        ]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ display:true, position:'top', labels:{ font:{ family:'Plus Jakarta Sans', size:11 }, boxWidth:12, padding:10 } }, tooltip:{ callbacks:{ label: ctx => ctx.raw!==null ? ctx.dataset.label+': '+ctx.raw.toLocaleString('fr-FR',{maximumFractionDigits:0})+' ‚Ç¨' : null, filter: item => item.raw !== null } } },
        scales:{ y:{ ticks:{ callback: v => Math.abs(v)>=1000?(v/1000).toFixed(0)+'k‚Ç¨':v+'‚Ç¨', font:{size:10} }, grid:{color:'#f0f4ff'} }, x:{ ticks:{font:{size:11}}, grid:{display:false} } }
      }
    });
  }

  // Chart solde cumul√©
  const cumulCtx = document.getElementById('cumulChart');
  if (cumulCtx) {
    new Chart(cumulCtx, {
      type:'line',
      data: {
        labels: labels,
        datasets:[{ label:'Solde cumul√©', data:cumulArr, borderColor:'#0d9488', backgroundColor:'rgba(13,148,136,.08)', borderWidth:2.5, pointRadius:5, pointBackgroundColor: cumulArr.map(v=>v===null?'transparent':v>=0?'#0d9488':'#ef4444'), tension:.4, fill:true, spanGaps:false }]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ label: ctx => ctx.raw!==null ? 'Solde: '+ctx.raw.toLocaleString('fr-FR',{maximumFractionDigits:0})+' ‚Ç¨' : '‚Äî' } } },
        scales:{ y:{ ticks:{ callback: v => Math.abs(v)>=1000?(v/1000).toFixed(0)+'k‚Ç¨':v+'‚Ç¨', font:{size:10} }, grid:{color:'#f0f4ff'} }, x:{ ticks:{font:{size:11}}, grid:{display:false} } }
      }
    });
  }

  // Graphique pr√©visionnel (si section visible)
  const prevCtx = document.getElementById('prevChart');
  if (prevCtx) {
    const futurMois = data.filter(d => d.isFuture);
    const futurLabels = futurMois.map((d,i) => labels[data.indexOf(d)] || MS[d.m]);
    const caP = futurMois.map(d => d.prevCA||0);
    const chP = futurMois.map(d => d.prevCharges||0);
    const cfP = futurMois.map(d => (d.prevCA||0) - (d.prevCharges||0));
    new Chart(prevCtx, {
      data: {
        labels: futurLabels,
        datasets: [
          { type:'bar',  label:'CA pr√©vi.',      data:caP, backgroundColor:'rgba(59,130,246,.65)', borderRadius:5 },
          { type:'bar',  label:'Charges pr√©vi.', data:chP, backgroundColor:'rgba(245,158,11,.65)', borderRadius:5 },
          { type:'line', label:'R√©sultat pr√©vi.', data:cfP, borderColor: cfP.map(v=>v>=0?'#059669':'#dc2626'), borderWidth:2, pointRadius:5, pointBackgroundColor:cfP.map(v=>v>=0?'#059669':'#dc2626'), fill:false, tension:.3, order:1 }
        ]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{ display:true, position:'bottom', labels:{ font:{family:'Plus Jakarta Sans',size:10}, boxWidth:10, padding:8 } }, tooltip:{ callbacks:{ label: ctx => ctx.raw!==null?ctx.dataset.label+': '+ctx.raw.toLocaleString('fr-FR',{maximumFractionDigits:0})+' ‚Ç¨':null } } },
        scales:{ y:{ ticks:{ callback: v=>Math.abs(v)>=1000?(v/1000).toFixed(0)+'k‚Ç¨':v+'‚Ç¨', font:{size:10} }, grid:{color:'rgba(252,211,77,.3)'} }, x:{ ticks:{font:{size:10}}, grid:{display:false} } }
      }
    });
  }

  // Doughnut pr√©visionnel
  const prevDCtx = document.getElementById('prevDoughnut');
  if (prevDCtx) {
    const futurMois = data.filter(d => d.isFuture);
    const prevCA_tot = futurMois.reduce((s,d)=>s+(d.prevCA||0),0);
    const prevCharges_tot = futurMois.reduce((s,d)=>s+(d.prevCharges||0),0);
    const prevResultat = prevCA_tot - prevCharges_tot;
    new Chart(prevDCtx, {
      type:'doughnut',
      data:{
        labels:['CA pr√©visionnel','Charges pr√©vi.','R√©sultat pr√©vi.'],
        datasets:[{
          data: [prevCA_tot, prevCharges_tot, Math.max(prevResultat,0)],
          backgroundColor:['#3b82f6','#f59e0b', prevResultat>=0?'#10b981':'#ef4444'],
          borderWidth:0, hoverOffset:6
        }]
      },
      options:{
        responsive:true, maintainAspectRatio:false, cutout:'60%',
        plugins:{ legend:{ position:'bottom', labels:{ font:{family:'Plus Jakarta Sans',size:10}, boxWidth:10, padding:8 } } }
      }
    });
  }
}
/* ‚îÄ‚îÄ TR√âSORERIE MODALE ‚îÄ‚îÄ */
function openTresoModal() {
  const cfg = window._tresorerieConfig || {};
  document.getElementById('tresoInput').value = cfg.solde !== null && cfg.solde !== undefined ? cfg.solde : '';
  // Set date to today if not set
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('tresoDate').value = cfg.date || today;
  document.getElementById('tresoModalBg').classList.add('show');
  setTimeout(() => document.getElementById('tresoInput').focus(), 100);
}
function closeTresoModal() {
  document.getElementById('tresoModalBg').classList.remove('show');
}
async function saveTresorerieDisponible() {
  const raw = document.getElementById('tresoInput').value.replace(',', '.').replace(/\s/g, '');
  const solde = parseFloat(raw);
  if (isNaN(solde) && raw !== '' && raw !== '-') {
    document.getElementById('tresoInput').style.borderColor = '#ef4444';
    return;
  }
  document.getElementById('tresoInput').style.borderColor = '';
  const date = document.getElementById('tresoDate').value;
  const cfg = { solde: isNaN(solde) ? null : solde, date: date || new Date().toISOString().split('T')[0] };
  try {
    await window._setDoc(window._doc(window._db, 'cashflow', window._uid, 'config', 'tresorerie'), cfg);
    window._tresorerieConfig = cfg;
    closeTresoModal();
    // Recharger la page
    const year = parseInt(document.getElementById('yearSelect').value);
    loadYear(year);
  } catch(e) {
    alert('Erreur lors de la sauvegarde : ' + e.message);
  }
}
// Fermer avec Escape
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeTresoModal();
});
</script>
<script src="nav.js"></script>
</body>
</html>
