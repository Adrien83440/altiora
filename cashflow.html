<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>ALTEORE ‚Äî Cashflow</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --nav:#0f1f5c;--blue:#1a3dce;--blue2:#4f7ef8;--bg:#f4f6fb;
  --border:#e2e8f0;--text:#1a1f36;--muted:#6b7280;
  --green:#10b981;--red:#ef4444;--orange:#f59e0b;--purple:#6366f1;
  --teal:#0d9488;--cyan:#06b6d4;
  --radius:14px;--sw:250px;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px}

/* NAV */
nav{width:var(--sw);min-height:100vh;background:linear-gradient(180deg,#0f1f5c,#162366);position:fixed;top:0;left:0;display:flex;flex-direction:column;padding-bottom:20px;overflow-y:auto;z-index:99}
.logo{display:flex;align-items:center;gap:10px;padding:22px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
.logo-i{width:33px;height:33px;background:rgba(255,255,255,.14);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
.logo-t{font-size:17px;font-weight:800;color:#fff;letter-spacing:1px}
.ns{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 18px 4px}
.ni{display:flex;align-items:center;gap:9px;padding:9px 18px;color:rgba(255,255,255,.55);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.ni:hover{color:#fff;background:rgba(255,255,255,.06)}
.ni.on{color:#fff;background:rgba(255,255,255,.1);border-left-color:#4f7ef8}
.sub{overflow:hidden;max-height:0;transition:max-height .3s}
.sub.open{max-height:300px}
.si{display:flex;align-items:center;gap:7px;padding:7px 18px 7px 40px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.si:hover{color:rgba(255,255,255,.75);background:rgba(255,255,255,.04)}
.si.on{color:#fff;background:rgba(79,126,248,.15);border-left-color:rgba(79,126,248,.6)}
.dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25)}
.si.on .dot{background:#4f7ef8}
.nav-footer{margin-top:auto;padding:12px 18px 0;border-top:1px solid rgba(255,255,255,.08)}
.ucard{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,.07);border-radius:8px;cursor:pointer}
.ucard:hover{background:rgba(255,255,255,.1)}
.uav{width:29px;height:29px;background:linear-gradient(135deg,#4f7ef8,#6366f1);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
.un{font-size:11.5px;font-weight:600;color:#fff}
.upl{font-size:10px;color:rgba(255,255,255,.3)}
.lbtn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,.3);cursor:pointer;font-size:13px;padding:2px}
.lbtn:hover{color:#ef4444}

/* MAIN */
main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;gap:12px;flex-wrap:wrap}
.topbar-left h1{font-size:17px;font-weight:800;display:flex;align-items:center;gap:8px}
.topbar-left p{font-size:11px;color:var(--muted);margin-top:2px}
.topbar-right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

.btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:5px}
.btn-p{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;box-shadow:0 3px 10px rgba(26,61,206,.2)}
.btn-p:hover{opacity:.9}
.btn-o{background:#fff;color:var(--blue);border:1.5px solid var(--border)}
.btn-o:hover{border-color:var(--blue);background:#f0f4ff}
.year-select{padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;background:#fff;cursor:pointer;color:var(--text)}

/* CONTENT */
.content{padding:24px 28px;flex:1}

/* KPI ROW */
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:22px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:18px 16px;position:relative;overflow:hidden;transition:box-shadow .2s,transform .2s}
.kpi:hover{box-shadow:0 6px 24px rgba(26,61,206,.08);transform:translateY(-1px)}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi.blue::before{background:linear-gradient(90deg,var(--blue),var(--blue2))}
.kpi.green::before{background:linear-gradient(90deg,#10b981,#34d399)}
.kpi.red::before{background:linear-gradient(90deg,#ef4444,#f87171)}
.kpi.orange::before{background:linear-gradient(90deg,#f59e0b,#fbbf24)}
.kpi.teal::before{background:linear-gradient(90deg,#0d9488,#14b8a6)}
.kpi-icon{font-size:22px;margin-bottom:8px}
.kpi-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.7px;margin-bottom:6px}
.kpi-val{font-size:22px;font-weight:900;line-height:1;margin-bottom:4px}
.kpi-val.blue{color:var(--blue2)}
.kpi-val.green{color:var(--green)}
.kpi-val.red{color:var(--red)}
.kpi-val.orange{color:var(--orange)}
.kpi-val.teal{color:var(--teal)}
.kpi-sub{font-size:10px;color:var(--muted)}

/* GRID */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px}
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.card.full{grid-column:1/-1}
.card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:8px}
.card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px}
.card-sub{font-size:11px;color:var(--muted);margin-top:1px}
.badge{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px}
.badge-blue{background:rgba(79,126,248,.1);color:var(--blue2)}
.badge-green{background:rgba(16,185,129,.1);color:var(--green)}
.badge-orange{background:rgba(245,158,11,.1);color:var(--orange)}
.badge-red{background:rgba(239,68,68,.1);color:var(--red)}
.badge-teal{background:rgba(13,148,136,.1);color:var(--teal)}

/* WATERFALL */
.wf-chart-wrap{position:relative;height:280px}

/* MENSUEL TABLE */
.month-table{width:100%;border-collapse:collapse;font-size:12px}
.month-table th{background:#f8f9fd;padding:8px 10px;text-align:left;font-weight:700;color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border);white-space:nowrap}
.month-table td{padding:7px 10px;border-bottom:1px solid #f1f3f9;vertical-align:middle}
.month-table tr:last-child td{border-bottom:none}
.month-table tr:hover td{background:#f8f9fd}
.month-table .positive{color:var(--green);font-weight:700}
.month-table .negative{color:var(--red);font-weight:700}
.month-table .neutral{color:var(--muted)}
.month-table .total-row td{font-weight:800;background:#f0f4ff;color:var(--blue)}
.month-link{color:var(--blue2);text-decoration:none;font-weight:700;font-size:11px;padding:3px 8px;border:1px solid rgba(79,126,248,.2);border-radius:6px;transition:.15s}
.month-link:hover{background:rgba(79,126,248,.1)}

/* TREND BARS */
.trend-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.trend-label{font-size:11px;font-weight:600;color:var(--text);width:80px;flex-shrink:0}
.trend-bar-wrap{flex:1;background:#f0f4ff;border-radius:20px;height:10px;overflow:hidden}
.trend-bar{height:100%;border-radius:20px;transition:width .6s ease}
.trend-bar.green{background:linear-gradient(90deg,#10b981,#34d399)}
.trend-bar.red{background:linear-gradient(90deg,#ef4444,#f87171)}
.trend-bar.blue{background:linear-gradient(90deg,var(--blue),var(--blue2))}
.trend-val{font-size:11px;font-weight:700;width:70px;text-align:right;flex-shrink:0}

/* SOLDE CUMUL√â */
.cumul-chart-wrap{position:relative;height:220px}

/* DETTES WIDGET */
.debt-item{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f1f3f9}
.debt-item:last-child{border-bottom:none}
.debt-name{font-size:12px;font-weight:600}
.debt-meta{font-size:10px;color:var(--muted);margin-top:1px}
.debt-amount{font-size:13px;font-weight:800;color:var(--red)}
.debt-monthly{font-size:10px;color:var(--muted);text-align:right;margin-top:1px}

/* ALERT BOXES */
.alert{border-radius:10px;padding:12px 16px;font-size:12px;line-height:1.5;display:flex;align-items:flex-start;gap:10px;margin-bottom:10px}
.alert:last-child{margin-bottom:0}
.alert.warn{background:#fffbeb;border:1px solid #fcd34d;color:#92400e}
.alert.danger{background:#fef2f2;border:1px solid #fecaca;color:#991b1b}
.alert.good{background:#f0fdf4;border:1px solid #86efac;color:#166534}
.alert.info{background:#f0f4ff;border:1px solid #c7d2fe;color:#3730a3}
.alert-icon{font-size:16px;flex-shrink:0;margin-top:-1px}

/* LOADER */
.loader-wrap{display:flex;align-items:center;justify-content:center;padding:80px;color:var(--muted);gap:10px;flex-direction:column}
.spin{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--blue2);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* EMPTY STATE */
.empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
.empty-state .es-icon{font-size:40px;margin-bottom:12px}
.empty-state p{font-size:12px;line-height:1.6}

/* SCORE GAUGE */
.score-wrap{display:flex;flex-direction:column;align-items:center;padding:10px 0}
.score-ring{position:relative;width:120px;height:120px;margin:0 auto 12px}
.score-ring svg{transform:rotate(-90deg)}
.score-val{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center}
.score-num{font-size:28px;font-weight:900;line-height:1}
.score-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-top:2px}
.score-caption{font-size:12px;font-weight:700;text-align:center}
.score-desc{font-size:10px;color:var(--muted);text-align:center;margin-top:4px;line-height:1.4}

/* REPARTITION */
.rep-item{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.rep-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.rep-label{font-size:12px;flex:1}
.rep-pct{font-size:12px;font-weight:700;color:var(--text)}
.rep-val{font-size:11px;color:var(--muted);width:70px;text-align:right}

/* RESPONSIVE */
@media(max-width:1200px){.kpi-row{grid-template-columns:repeat(3,1fr)}.grid-3{grid-template-columns:1fr 1fr}}
@media(max-width:900px){.kpi-row{grid-template-columns:repeat(2,1fr)}.grid-2,.grid-3{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
<nav>
  <div class="logo">
    <div class="logo-i">
      <svg width="18" height="18" viewBox="0 0 200 200"><polygon points="100,28 165,145 35,145" fill="none" stroke="white" stroke-width="12" stroke-linejoin="round"/><rect x="35" y="145" width="130" height="11" rx="5.5" fill="white"/><circle cx="100" cy="28" r="9" fill="white"/></svg>
    </div>
    <div class="logo-t">Alteore</div>
  </div>

  <div class="ns">Navigation</div>
  <div class="ni" onclick="location.href='dashboard.html'"><span>üè†</span> Dashboard</div>

  <div class="ns">Financier</div>
  <div class="ni" onclick="toggleSub(this)"><span>üìä</span> Pilotage <span style="margin-left:auto;font-size:11px;color:rgba(255,255,255,.3)">‚Ä∫</span></div>
  <div class="sub">
    <div class="si" onclick="location.href='pilotage.html'"><div class="dot"></div> Pilotage mensuel</div>
    <div class="si on"><div class="dot"></div> Cashflow</div>
    <div class="si" onclick="location.href='suivi-ca.html'"><div class="dot"></div> Suivi CA</div>
    <div class="si" onclick="location.href='marges.html'"><div class="dot"></div> Marges</div>
    <div class="si" onclick="location.href='panier-moyen.html'"><div class="dot"></div> Panier moyen</div>
    <div class="si" onclick="location.href='cout-revient.html'"><div class="dot"></div> Co√ªt de revient</div>
    <div class="si" onclick="location.href='dettes.html'"><div class="dot"></div> Dettes & Emprunts</div>
  </div>

  <div class="ns">Clients</div>
  <div class="ni" onclick="location.href='fidelisation.html'"><span>üíé</span> Fid√©lisation</div>
  <div class="ni" onclick="location.href='client-fidelite.html'"><span>üë•</span> Clients</div>

  <div class="ns">Outils</div>
  <div class="ni" onclick="location.href='import.html'"><span>üì•</span> Import / Export</div>

  <div class="nav-footer">
    <div class="ucard" onclick="location.href='profil.html'">
      <div class="uav" id="nav-avatar">A</div>
      <div>
        <div class="un" id="nav-name">Chargement‚Ä¶</div>
        <div class="upl" id="uplan">‚Äî</div>
      </div>
      <button class="lbtn" onclick="event.stopPropagation();handleLogout()" title="D√©connexion">‚èª</button>
    </div>
  </div>
</nav>

<!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
<main>
  <div class="topbar">
    <div class="topbar-left">
      <h1>üíß Cashflow</h1>
      <p id="topbar-sub">Analyse de la tr√©sorerie sur l'ann√©e</p>
    </div>
    <div class="topbar-right">
      <select class="year-select" id="yearSelect" onchange="loadYear(parseInt(this.value))"></select>
      <button class="btn btn-o" onclick="location.href='pilotage.html'">üìä Pilotage</button>
      <button class="btn btn-p" onclick="window.print()">‚¨á Exporter</button>
    </div>
  </div>

  <div class="content" id="main-content">
    <div class="loader-wrap">
      <div class="spin"></div>
      <span style="font-size:12px;color:var(--muted)">Chargement des donn√©es‚Ä¶</span>
    </div>
  </div>
</main>

<!-- ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
  import { getFirestore, doc, getDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyBLPMNJlNvVJsMWLLi98o1GBqEHLbkFmQI",
    authDomain: "alteore-app.firebaseapp.com",
    projectId: "alteore-app",
    storageBucket: "alteore-app.appspot.com",
    messagingSenderId: "461372895749",
    appId: "1:461372895749:web:e5afd9a5f6b1c3e8a2d4f1"
  };

  // Essayer de r√©cup√©rer la config depuis window (d√©finie dans d'autres pages)
  let app, auth, db;
  try {
    // Utiliser la m√™me app si d√©j√† initialis√©e
    app = initializeApp(firebaseConfig, 'cashflow-page');
  } catch(e) {
    app = initializeApp(firebaseConfig);
  }
  auth = getAuth(app);
  db = getFirestore(app);

  window._db = db;
  window._auth = auth;
  window._doc = doc;
  window._getDoc = getDoc;
  window._getDocs = getDocs;
  window._collection = collection;
  window._signOut = signOut;
  window._firebaseReady = true;

  onAuthStateChanged(auth, async (user) => {
    if (!user) { window.location.href = 'index.html'; return; }
    window._uid = user.uid;
    window._userEmail = user.email;

    // Charger infos user
    try {
      const snap = await getDoc(doc(db, 'users', user.uid));
      if (snap.exists()) {
        const d = snap.data();
        const initials = (d.prenom || d.email || 'U')[0].toUpperCase();
        document.getElementById('nav-avatar').textContent = initials;
        document.getElementById('nav-name').textContent = d.prenom ? d.prenom + ' ' + (d.nom || '') : d.email;
      }
    } catch(e) {}

    initPage();
  });
</script>

<script>
// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function fmt(n) {
  if (n === null || n === undefined || isNaN(n)) return '‚Äî';
  const sign = n < 0 ? '‚àí' : '';
  return sign + Math.abs(n).toLocaleString('fr-FR', {minimumFractionDigits:0, maximumFractionDigits:0}) + ' ‚Ç¨';
}
function fmtK(n) {
  if (isNaN(n)) return '‚Äî';
  if (Math.abs(n) >= 1000) return (n/1000).toFixed(1) + ' k‚Ç¨';
  return fmt(n);
}
function pf(v) { return parseFloat((v||'').toString().replace(',','.')) || 0; }

const MONTHS = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
const MONTHS_SHORT = ['Jan','F√©v','Mar','Avr','Mai','Jun','Jul','Ao√ª','Sep','Oct','Nov','D√©c'];

function toggleSub(el) {
  const sub = el.nextElementSibling;
  if (!sub || !sub.classList.contains('sub')) return;
  sub.classList.toggle('open');
  el.classList.toggle('open');
}

async function handleLogout() {
  await window._signOut(window._auth);
  window.location.href = 'index.html';
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
function initPage() {
  const now = new Date();
  const curYear = now.getFullYear();

  // Remplir s√©lecteur ann√©es
  const sel = document.getElementById('yearSelect');
  for (let y = curYear - 2; y <= curYear + 1; y++) {
    const opt = document.createElement('option');
    opt.value = y;
    opt.textContent = y;
    if (y === curYear) opt.selected = true;
    sel.appendChild(opt);
  }

  // Ouvrir sous-menu pilotage par d√©faut
  document.querySelectorAll('.ni').forEach(el => {
    if (el.textContent.trim().startsWith('üìä')) {
      el.classList.add('open');
      const sub = el.nextElementSibling;
      if (sub) sub.classList.add('open');
    }
  });

  loadYear(curYear);
}

// ‚îÄ‚îÄ CHARGER DONN√âES ANNUELLES ‚îÄ‚îÄ
async function loadYear(year) {
  window._currentYear = year;
  document.getElementById('topbar-sub').textContent = `Analyse de la tr√©sorerie ¬∑ Ann√©e ${year}`;
  document.getElementById('main-content').innerHTML = `
    <div class="loader-wrap"><div class="spin"></div><span style="font-size:12px;color:var(--muted)">Chargement des donn√©es ${year}‚Ä¶</span></div>
  `;

  const uid = window._uid;
  const db = window._db;
  const doc = window._doc;
  const getDoc = window._getDoc;

  const monthsData = [];

  // Charger les 12 mois de pilotage
  for (let m = 0; m < 12; m++) {
    const key = year + '-' + String(m + 1).padStart(2, '0');
    try {
      const snap = await getDoc(doc(db, 'pilotage', uid, 'months', key));
      const raw = snap.exists() ? snap.data() : null;
      monthsData.push({ month: m, key, raw });
    } catch(e) {
      monthsData.push({ month: m, key, raw: null });
    }
  }

  // Charger dettes
  let dettes = [];
  try {
    const snap = await getDoc(doc(db, 'dettes', uid));
    if (snap.exists()) {
      const d = snap.data();
      dettes = (d.items || d.dettes || []).filter(x => x && (x.nom || x.montant));
    }
  } catch(e) {}

  // Calculer m√©triques par mois
  const computed = monthsData.map(({ month, key, raw }) => {
    if (!raw) return { month, key, hasData: false, caHT: 0, caReelHT: 0, chargesHT: 0, chargesTTC: 0, cashflow: 0, prevCA: 0, tvaDue: 0, tvaCollectee: 0, tvaDed: 0, creditsPrincipal: 0, creditsInteret: 0, leasingHT: 0, rentreeSupp: 0 };

    // CA r√©el (lignes journali√®res)
    let caHT = 0, tvaCollectee = 0;
    (raw.lignes || []).forEach(r => {
      const h055 = pf(r.ht055), h10 = pf(r.ht10), h20 = pf(r.ht20);
      caHT += h055 + h10 + h20;
      tvaCollectee += h055*0.055 + h10*0.10 + h20*0.20;
    });

    // CA Factures pro
    (raw.facturesPro || []).forEach(r => {
      const ht = pf(r.montantHT);
      const rate = pf(r.tvaRate || 20);
      caHT += ht;
      tvaCollectee += ht * rate / 100;
    });

    // Rentr√©es suppl√©mentaires
    let rentreeSupp = 0;
    (raw.rentreesSupp || []).forEach(r => { rentreeSupp += pf(r.montant); });
    caHT += rentreeSupp;

    // Pr√©vision CA
    let prevCA = 0;
    (raw.previsionCA || []).forEach(r => { prevCA += pf(r.montant); });

    // Charges Fixes
    let fixesHT = 0, tvaDedFix = 0;
    (raw.chargesFixe || []).forEach(r => {
      const ht = pf(r.montantHT);
      const rate = pf(r.tvaRate || 20);
      fixesHT += ht;
      if (r.deductible !== 'Non') tvaDedFix += ht * rate / 100;
    });

    // Charges Variables
    let varHT = 0, tvaDedVar = 0;
    (raw.chargesVar || []).forEach(r => {
      const ht = pf(r.montantHT);
      const rate = pf(r.tvaRate || 20);
      varHT += ht;
      if (r.deductible !== 'Non') tvaDedVar += ht * rate / 100;
    });

    // Leasing
    let leasingHT = 0, tvaDedLeas = 0;
    (raw.leasing || []).forEach(r => {
      const ht = pf(r.montantHT);
      const rate = pf(r.tvaRate || 20);
      leasingHT += ht;
      if (r.deductible !== 'Non') tvaDedLeas += ht * rate / 100;
    });

    // Cr√©dits
    let creditsPrincipal = 0, creditsInteret = 0, creditsTVA = 0;
    (raw.credits || []).forEach(r => {
      const m = pf(r.montant);
      if (r.ligneType === 'principal') {
        creditsPrincipal += m;
      } else {
        let interet = m;
        if (r.tvaAuto) {
          const idx = (raw.credits || []).indexOf(r);
          const principal = (raw.credits || []).slice(0, idx).reverse().find(c => c.fournisseur === r.fournisseur && c.ligneType === 'principal');
          if (principal) interet = pf(principal.montant) * pf(r.tauxInteret) / 100 / 12;
        }
        creditsInteret += interet;
        creditsTVA += interet * pf(r.tvaRate || 20) / 100;
      }
    });

    const chargesHT = fixesHT + varHT + leasingHT + creditsPrincipal + creditsInteret;
    const tvaDed = tvaDedFix + tvaDedVar + tvaDedLeas + creditsTVA;
    const tvaDue = tvaCollectee - tvaDed;
    const cashflow = caHT - chargesHT;

    return {
      month, key, hasData: true,
      caHT: caHT - rentreeSupp, rentreeSupp, caTotal: caHT,
      prevCA, chargesHT, fixesHT, varHT, leasingHT,
      creditsPrincipal, creditsInteret,
      cashflow, tvaCollectee, tvaDed, tvaDue
    };
  });

  renderPage(computed, dettes, year);
}

// ‚îÄ‚îÄ RENDER PAGE ‚îÄ‚îÄ
function renderPage(data, dettes, year) {
  const now = new Date();
  const currentMonth = now.getFullYear() === year ? now.getMonth() : (year < now.getFullYear() ? 11 : -1);

  // Totaux annuels (mois avec donn√©es)
  const filled = data.filter(d => d.hasData);
  const totCA = filled.reduce((s, d) => s + d.caTotal, 0);
  const totCharges = filled.reduce((s, d) => s + d.chargesHT, 0);
  const totCF = filled.reduce((s, d) => s + d.cashflow, 0);
  const totTVA = filled.reduce((s, d) => s + d.tvaDue, 0);
  const totPrev = filled.reduce((s, d) => s + d.prevCA, 0);
  const delta = totCA - totPrev;

  // Solde cumul√©
  let cumul = 0;
  const cumulArr = data.map(d => {
    if (d.hasData) cumul += d.cashflow;
    return d.hasData ? cumul : null;
  });

  // Score sant√© tr√©so (0-100)
  const posMonths = filled.filter(d => d.cashflow > 0).length;
  const cfRatio = totCA > 0 ? totCF / totCA : 0;
  const healthScore = filled.length === 0 ? 0 : Math.round(
    Math.min(100, Math.max(0,
      (posMonths / Math.max(filled.length, 1)) * 50 +
      (cfRatio > 0 ? Math.min(cfRatio * 200, 40) : 0) +
      (totCA > 0 ? 10 : 0)
    ))
  );
  const scoreColor = healthScore >= 70 ? '#10b981' : healthScore >= 40 ? '#f59e0b' : '#ef4444';
  const scoreLabel = healthScore >= 70 ? 'Bonne sant√©' : healthScore >= 40 ? '√Ä surveiller' : 'Fragile';
  const scoreDesc = healthScore >= 70 ? 'Votre tr√©sorerie est saine sur cette p√©riode.' : healthScore >= 40 ? 'Quelques mois n√©gatifs √† surveiller.' : 'Plusieurs mois en d√©ficit ‚Äî action recommand√©e.';

  // Alertes
  const alerts = [];
  const negMonths = filled.filter(d => d.cashflow < 0);
  if (negMonths.length >= 3) alerts.push({ type: 'danger', icon: 'üö®', text: `${negMonths.length} mois avec cashflow n√©gatif cette ann√©e. R√©visez vos charges ou cherchez de nouvelles sources de revenus.` });
  else if (negMonths.length >= 1) alerts.push({ type: 'warn', icon: '‚ö†Ô∏è', text: `${negMonths.length} mois avec cashflow n√©gatif (${negMonths.map(d => MONTHS_SHORT[d.month]).join(', ')}). Surveillez vos charges sur ces p√©riodes.` });
  if (totPrev > 0 && totCA < totPrev * 0.85) alerts.push({ type: 'warn', icon: 'üìâ', text: `CA r√©el en retard vs pr√©visions (${Math.round((totCA/totPrev)*100)}% r√©alis√©). V√©rifiez vos objectifs commerciaux.` });
  if (totCF > 0 && filled.length > 0) alerts.push({ type: 'good', icon: '‚úÖ', text: `Cashflow annuel positif de ${fmt(totCF)}. Pensez √† constituer une r√©serve de tr√©sorerie.` });
  if (filled.length === 0) alerts.push({ type: 'info', icon: '‚ÑπÔ∏è', text: `Aucune donn√©e pour ${year}. Renseignez vos mois dans le module Pilotage pour voir l'analyse.` });

  // R√©partition charges
  const totalFixe = filled.reduce((s, d) => s + d.fixesHT, 0);
  const totalVar = filled.reduce((s, d) => s + d.varHT, 0);
  const totalLeas = filled.reduce((s, d) => s + d.leasingHT, 0);
  const totalCred = filled.reduce((s, d) => s + d.creditsPrincipal + d.creditsInteret, 0);

  const html = `
    <!-- KPI ROW -->
    <div class="kpi-row">
      <div class="kpi blue">
        <div class="kpi-icon">üí∞</div>
        <div class="kpi-label">CA Total HT</div>
        <div class="kpi-val blue">${fmtK(totCA)}</div>
        <div class="kpi-sub">${filled.length} mois enregistr√©s</div>
      </div>
      <div class="kpi ${totCharges > totCA ? 'red' : 'orange'}">
        <div class="kpi-icon">üì¶</div>
        <div class="kpi-label">Charges HT</div>
        <div class="kpi-val ${totCharges > totCA ? 'red' : 'orange'}">${fmtK(totCharges)}</div>
        <div class="kpi-sub">${totCA > 0 ? Math.round((totCharges/totCA)*100) + '% du CA' : '‚Äî'}</div>
      </div>
      <div class="kpi ${totCF >= 0 ? 'green' : 'red'}">
        <div class="kpi-icon">üíß</div>
        <div class="kpi-label">Cashflow Net</div>
        <div class="kpi-val ${totCF >= 0 ? 'green' : 'red'}">${fmtK(totCF)}</div>
        <div class="kpi-sub">${totCF >= 0 ? 'Exc√©dent annuel' : 'D√©ficit annuel'}</div>
      </div>
      <div class="kpi ${totTVA >= 0 ? 'teal' : 'green'}">
        <div class="kpi-icon">üßæ</div>
        <div class="kpi-label">TVA Annuelle</div>
        <div class="kpi-val ${totTVA >= 0 ? 'teal' : 'green'}">${fmtK(Math.abs(totTVA))}</div>
        <div class="kpi-sub">${totTVA >= 0 ? '√† reverser' : 'cr√©dit TVA'}</div>
      </div>
      <div class="kpi ${delta >= 0 ? 'green' : 'red'}">
        <div class="kpi-icon">${delta >= 0 ? 'üéØ' : 'üìâ'}</div>
        <div class="kpi-label">Delta Pr√©vi/R√©el</div>
        <div class="kpi-val ${delta >= 0 ? 'green' : 'red'}">${totPrev > 0 ? fmtK(delta) : '‚Äî'}</div>
        <div class="kpi-sub">${totPrev > 0 ? 'Pr√©vision : ' + fmtK(totPrev) : 'Pas de pr√©vision'}</div>
      </div>
    </div>

    <!-- WATERFALL + SCORE -->
    <div class="grid-3" style="margin-bottom:16px">
      <div class="card" style="grid-column:span 2">
        <div class="card-head">
          <div>
            <div class="card-title">üíß Cashflow mensuel <span class="badge badge-blue">${year}</span></div>
            <div class="card-sub">Entr√©es ‚àí Sorties par mois</div>
          </div>
        </div>
        <div class="wf-chart-wrap"><canvas id="cfChart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title">ü©∫ Score Tr√©sorerie</div>
            <div class="card-sub">Sant√© globale sur ${year}</div>
          </div>
        </div>
        <div class="score-wrap">
          <div class="score-ring">
            <svg width="120" height="120" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="50" fill="none" stroke="#f0f4ff" stroke-width="12"/>
              <circle cx="60" cy="60" r="50" fill="none" stroke="${scoreColor}" stroke-width="12"
                stroke-dasharray="${Math.round(314 * healthScore / 100)} 314"
                stroke-linecap="round" style="transition:stroke-dasharray .8s ease"/>
            </svg>
            <div class="score-val">
              <div class="score-num" style="color:${scoreColor}">${healthScore}</div>
              <div class="score-label">/ 100</div>
            </div>
          </div>
          <div class="score-caption" style="color:${scoreColor}">${scoreLabel}</div>
          <div class="score-desc">${scoreDesc}</div>
        </div>
        <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:14px">
          <div class="card-title" style="margin-bottom:10px;font-size:12px">üìä R√©partition charges</div>
          ${totalFixe > 0 ? `<div class="rep-item"><div class="rep-dot" style="background:#f59e0b"></div><div class="rep-label">Fixes</div><div class="rep-pct">${totCharges>0?Math.round((totalFixe/totCharges)*100)+'%':'‚Äî'}</div><div class="rep-val" style="color:var(--orange)">${fmtK(totalFixe)}</div></div>` : ''}
          ${totalVar > 0 ? `<div class="rep-item"><div class="rep-dot" style="background:#10b981"></div><div class="rep-label">Variables</div><div class="rep-pct">${totCharges>0?Math.round((totalVar/totCharges)*100)+'%':'‚Äî'}</div><div class="rep-val" style="color:var(--green)">${fmtK(totalVar)}</div></div>` : ''}
          ${totalLeas > 0 ? `<div class="rep-item"><div class="rep-dot" style="background:#6366f1"></div><div class="rep-label">Leasing</div><div class="rep-pct">${totCharges>0?Math.round((totalLeas/totCharges)*100)+'%':'‚Äî'}</div><div class="rep-val" style="color:var(--purple)">${fmtK(totalLeas)}</div></div>` : ''}
          ${totalCred > 0 ? `<div class="rep-item"><div class="rep-dot" style="background:#ef4444"></div><div class="rep-label">Cr√©dits</div><div class="rep-pct">${totCharges>0?Math.round((totalCred/totCharges)*100)+'%':'‚Äî'}</div><div class="rep-val" style="color:var(--red)">${fmtK(totalCred)}</div></div>` : ''}
          ${totCharges === 0 ? '<div style="text-align:center;color:var(--muted);font-size:11px;padding:8px 0">Aucune charge enregistr√©e</div>' : ''}
        </div>
      </div>
    </div>

    <!-- SOLDE CUMUL√â + ALERTES -->
    <div class="grid-2" style="margin-bottom:16px">
      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title">üìà Solde cumul√© <span class="badge badge-teal">√âvolution</span></div>
            <div class="card-sub">Tr√©sorerie accumul√©e mois apr√®s mois</div>
          </div>
        </div>
        <div class="cumul-chart-wrap"><canvas id="cumulChart"></canvas></div>
      </div>
      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title">‚ö° Alertes & Recommandations</div>
            <div class="card-sub">Points d'attention sur votre tr√©sorerie</div>
          </div>
        </div>
        ${alerts.length === 0
          ? '<div class="empty-state"><div class="es-icon">‚úÖ</div><p>Aucune alerte d√©tect√©e.<br>Votre tr√©sorerie semble saine.</p></div>'
          : alerts.map(a => `<div class="alert ${a.type}"><span class="alert-icon">${a.icon}</span><span>${a.text}</span></div>`).join('')
        }
        ${filled.length > 0 ? `
        <div style="margin-top:14px;border-top:1px solid var(--border);padding-top:14px">
          <div class="card-title" style="margin-bottom:10px;font-size:12px">üìä Tendances CA vs Charges</div>
          ${data.filter(d => d.hasData).slice(-6).map(d => {
            const maxVal = Math.max(d.caTotal, d.chargesHT, 1);
            return `
              <div style="margin-bottom:10px">
                <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                  <span style="font-size:11px;font-weight:700">${MONTHS_SHORT[d.month]}</span>
                  <span class="${d.cashflow >= 0 ? 'positive' : 'negative'}" style="font-size:11px;font-weight:700">${fmt(d.cashflow)}</span>
                </div>
                <div class="trend-bar-wrap" style="height:7px;margin-bottom:3px"><div class="trend-bar blue" style="width:${Math.min((d.caTotal/maxVal)*100,100)}%"></div></div>
                <div class="trend-bar-wrap" style="height:7px"><div class="trend-bar ${d.chargesHT > d.caTotal ? 'red' : 'orange'}" style="width:${Math.min((d.chargesHT/maxVal)*100,100)}%"></div></div>
              </div>
            `;
          }).join('')}
          <div style="display:flex;gap:14px;margin-top:8px">
            <div style="display:flex;align-items:center;gap:5px"><div style="width:10px;height:4px;background:var(--blue2);border-radius:2px"></div><span style="font-size:10px;color:var(--muted)">CA</span></div>
            <div style="display:flex;align-items:center;gap:5px"><div style="width:10px;height:4px;background:var(--orange);border-radius:2px"></div><span style="font-size:10px;color:var(--muted)">Charges</span></div>
          </div>
        </div>
        ` : ''}
      </div>
    </div>

    <!-- TABLEAU MENSUEL D√âTAILL√â -->
    <div class="card" style="margin-bottom:16px">
      <div class="card-head">
        <div>
          <div class="card-title">üóì Tableau mensuel d√©taill√© <span class="badge badge-blue">${year}</span></div>
          <div class="card-sub">Vue ligne par ligne de votre tr√©sorerie</div>
        </div>
        <a href="pilotage.html" class="btn btn-o" style="font-size:11px">üìä Saisir donn√©es</a>
      </div>
      <div style="overflow-x:auto">
        <table class="month-table">
          <thead>
            <tr>
              <th>Mois</th>
              <th>CA R√©el HT</th>
              <th>Pr√©vision</th>
              <th>Charges HT</th>
              <th>Fixes</th>
              <th>Variables</th>
              <th>Cr√©dits</th>
              <th>Cashflow</th>
              <th>TVA due</th>
              <th>Solde cumul√©</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            ${data.map((d, i) => {
              const cumVal = cumulArr[i];
              const isCurrentMonth = i === currentMonth;
              return `<tr style="${isCurrentMonth ? 'background:#f0f4ff;font-weight:600' : ''}">
                <td style="font-weight:700">${isCurrentMonth ? '‚ñ∂ ' : ''}${MONTHS_SHORT[d.month]}</td>
                <td class="${d.hasData ? (d.caTotal > 0 ? 'positive' : 'neutral') : 'neutral'}">${d.hasData ? fmt(d.caTotal) : '<span style="color:#d1d5db">‚Äî</span>'}</td>
                <td class="neutral">${d.hasData && d.prevCA > 0 ? fmt(d.prevCA) : '<span style="color:#d1d5db">‚Äî</span>'}</td>
                <td class="${d.hasData ? 'negative' : 'neutral'}">${d.hasData ? fmt(d.chargesHT) : '<span style="color:#d1d5db">‚Äî</span>'}</td>
                <td class="neutral">${d.hasData && d.fixesHT > 0 ? fmt(d.fixesHT) : '‚Äî'}</td>
                <td class="neutral">${d.hasData && d.varHT > 0 ? fmt(d.varHT) : '‚Äî'}</td>
                <td class="neutral">${d.hasData && (d.creditsPrincipal + d.creditsInteret) > 0 ? fmt(d.creditsPrincipal + d.creditsInteret) : '‚Äî'}</td>
                <td class="${!d.hasData ? 'neutral' : d.cashflow >= 0 ? 'positive' : 'negative'}">${d.hasData ? fmt(d.cashflow) : '<span style="color:#d1d5db">‚Äî</span>'}</td>
                <td class="${!d.hasData ? 'neutral' : d.tvaDue >= 0 ? '' : 'positive'}" style="${d.hasData && d.tvaDue > 0 ? 'color:var(--teal)' : ''}">${d.hasData ? fmt(Math.abs(d.tvaDue)) + (d.tvaDue < 0 ? ' <span style="font-size:9px">(cr√©dit)</span>' : '') : '‚Äî'}</td>
                <td class="${cumVal === null ? 'neutral' : cumVal >= 0 ? 'positive' : 'negative'}">${cumVal !== null ? fmt(cumVal) : '‚Äî'}</td>
                <td><a href="pilotage.html?month=${i}&year=${year}" class="month-link">Voir ‚Üí</a></td>
              </tr>`;
            }).join('')}
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td>TOTAL ${year}</td>
              <td>${fmt(totCA)}</td>
              <td>${totPrev > 0 ? fmt(totPrev) : '‚Äî'}</td>
              <td>${fmt(totCharges)}</td>
              <td>${fmt(totalFixe)}</td>
              <td>${fmt(totalVar)}</td>
              <td>${fmt(totalCred)}</td>
              <td class="${totCF >= 0 ? 'positive' : 'negative'}">${fmt(totCF)}</td>
              <td style="color:var(--teal)">${fmt(totTVA)}</td>
              <td class="${cumulArr[cumulArr.length-1] >= 0 ? 'positive' : 'negative'}">${cumulArr[cumulArr.length-1] !== null ? fmt(cumulArr[cumulArr.length-1]) : '‚Äî'}</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>

    ${dettes.length > 0 ? `
    <!-- DETTES -->
    <div class="card" style="margin-bottom:16px">
      <div class="card-head">
        <div>
          <div class="card-title">üè¶ Engagements financiers <span class="badge badge-red">Dettes & Emprunts</span></div>
          <div class="card-sub">Impact mensuel sur votre tr√©sorerie</div>
        </div>
        <a href="dettes.html" class="btn btn-o" style="font-size:11px">G√©rer ‚Üí</a>
      </div>
      <div>
        ${dettes.slice(0, 6).map(d => `
          <div class="debt-item">
            <div>
              <div class="debt-name">${d.nom || d.fournisseur || 'Emprunt'}</div>
              <div class="debt-meta">${d.type || ''} ${d.dateDebut ? '¬∑ Depuis ' + d.dateDebut : ''} ${d.dateFin ? '¬∑ Jusqu\'au ' + d.dateFin : ''}</div>
            </div>
            <div style="text-align:right">
              <div class="debt-amount">${fmt(pf(d.montantRestant || d.montant || 0))}</div>
              <div class="debt-monthly">${d.mensualite ? fmt(pf(d.mensualite)) + '/mois' : ''}</div>
            </div>
          </div>
        `).join('')}
        ${dettes.length > 6 ? `<div style="text-align:center;padding:10px;font-size:11px;color:var(--muted)">+${dettes.length - 6} autres engagements ¬∑ <a href="dettes.html" style="color:var(--blue2)">Voir tous</a></div>` : ''}
      </div>
    </div>
    ` : ''}
  `;

  document.getElementById('main-content').innerHTML = html;

  // ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ

  // Chart cashflow mensuel
  const cfCtx = document.getElementById('cfChart');
  if (cfCtx) {
    const labels = data.map(d => MONTHS_SHORT[d.month]);
    const vals = data.map(d => d.hasData ? d.cashflow : null);
    const colors = vals.map(v => v === null ? 'rgba(0,0,0,0)' : v >= 0 ? 'rgba(16,185,129,0.85)' : 'rgba(239,68,68,0.85)');
    const colorsHover = vals.map(v => v === null ? 'rgba(0,0,0,0)' : v >= 0 ? '#10b981' : '#ef4444');

    new Chart(cfCtx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: 'CA HT',
            data: data.map(d => d.hasData ? d.caTotal : null),
            type: 'line',
            borderColor: '#4f7ef8',
            backgroundColor: 'rgba(79,126,248,.1)',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: '#4f7ef8',
            tension: 0.4,
            fill: false,
            yAxisID: 'y'
          },
          {
            label: 'Cashflow',
            data: vals,
            backgroundColor: colors,
            hoverBackgroundColor: colorsHover,
            borderRadius: 6,
            yAxisID: 'y'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top', labels: { font: { family: 'Plus Jakarta Sans', size: 11 }, boxWidth: 12 } },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.raw !== null ? ctx.raw.toLocaleString('fr-FR', {maximumFractionDigits:0}) + ' ‚Ç¨' : 'Pas de donn√©es'}`
            }
          }
        },
        scales: {
          y: { ticks: { callback: v => v >= 1000 ? (v/1000).toFixed(0)+'k‚Ç¨' : v+'‚Ç¨', font: { size: 10 } }, grid: { color: '#f0f4ff' } },
          x: { ticks: { font: { size: 11 } }, grid: { display: false } }
        }
      }
    });
  }

  // Chart solde cumul√©
  const cumulCtx = document.getElementById('cumulChart');
  if (cumulCtx) {
    const validCumul = cumulArr.map((v, i) => ({ x: MONTHS_SHORT[i], y: v })).filter(p => p.y !== null);
    new Chart(cumulCtx, {
      type: 'line',
      data: {
        labels: data.map(d => MONTHS_SHORT[d.month]),
        datasets: [{
          label: 'Solde cumul√©',
          data: cumulArr,
          borderColor: '#0d9488',
          backgroundColor: 'rgba(13,148,136,.08)',
          borderWidth: 2.5,
          pointRadius: 5,
          pointBackgroundColor: cumulArr.map(v => v === null ? 'transparent' : v >= 0 ? '#0d9488' : '#ef4444'),
          tension: 0.4,
          fill: true,
          spanGaps: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `Solde: ${ctx.raw !== null ? ctx.raw.toLocaleString('fr-FR', {maximumFractionDigits:0}) + ' ‚Ç¨' : '‚Äî'}`
            }
          }
        },
        scales: {
          y: {
            ticks: { callback: v => v >= 1000 ? (v/1000).toFixed(0)+'k‚Ç¨' : v+'‚Ç¨', font: { size: 10 } },
            grid: { color: '#f0f4ff' }
          },
          x: { ticks: { font: { size: 11 } }, grid: { display: false } }
        }
      }
    });
  }
}
</script>

<script src="nav.js"></script>
</body>
</html>
