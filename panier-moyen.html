<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ALTIORA ‚Äî Panier Moyen</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --blue-dark:#0f1f5c;--blue-main:#1a3dce;--blue-light:#4f7ef8;--blue-ghost:#f0f4ff;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f5f7ff;--sidebar-w:252px;--radius:12px;
      --green:#10b981;--orange:#f59e0b;--red:#ef4444;--purple:#6366f1;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}

    /* SIDEBAR */
    .sidebar{width:var(--sidebar-w);min-height:100vh;background:linear-gradient(180deg,#0f1f5c,#162366);display:flex;flex-direction:column;position:fixed;left:0;top:0;z-index:100;padding-bottom:24px;overflow-y:auto;}
    .logo{display:flex;align-items:center;gap:10px;padding:24px 20px;border-bottom:1px solid rgba(255,255,255,0.08);}
    .logo-icon{width:34px;height:34px;background:rgba(255,255,255,0.15);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;}
    .logo-text{font-size:17px;font-weight:800;color:white;letter-spacing:1px;}
    .nav-section{font-size:10px;font-weight:700;color:rgba(255,255,255,0.3);letter-spacing:1px;text-transform:uppercase;padding:14px 20px 4px;}
    .nav-item{display:flex;align-items:center;gap:10px;padding:9px 20px;color:rgba(255,255,255,0.55);font-size:13px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:all 0.15s;}
    .nav-item:hover{color:white;background:rgba(255,255,255,0.06);}
    .nav-item.active{color:white;background:rgba(255,255,255,0.1);border-left-color:#4f7ef8;}
    .nav-chevron{margin-left:auto;font-size:11px;color:rgba(255,255,255,0.3);}
    .submenu{overflow:hidden;max-height:0;transition:max-height 0.3s;}
    .submenu.open{max-height:200px;}
    .sub-item{display:flex;align-items:center;gap:8px;padding:7px 20px 7px 42px;color:rgba(255,255,255,0.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;}
    .sub-item:hover{color:rgba(255,255,255,0.75);background:rgba(255,255,255,0.04);}
    .sub-item.active{color:white;background:rgba(79,126,248,0.15);border-left-color:rgba(79,126,248,0.6);}
    .sub-dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,0.25);flex-shrink:0;}
    .sub-item.active .sub-dot{background:#4f7ef8;}
    .sidebar-footer{margin-top:auto;padding:14px 20px 0;border-top:1px solid rgba(255,255,255,0.08);}
    .user-row{display:flex;align-items:center;gap:9px;padding:9px;background:rgba(255,255,255,0.07);border-radius:9px;}
    .avatar{width:30px;height:30px;background:linear-gradient(135deg,#4f7ef8,#6366f1);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:white;}
    .user-name{font-size:12px;font-weight:600;color:white;}
    .user-plan{font-size:10px;color:rgba(255,255,255,0.35);}
    .logout-btn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,0.3);cursor:pointer;font-size:13px;}

    /* MAIN */
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;}
    .topbar{background:white;border-bottom:1px solid var(--border);padding:13px 26px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar h1{font-size:16px;font-weight:700;}
    .topbar p{font-size:11px;color:var(--muted);}
    .topbar-right{display:flex;align-items:center;gap:10px;}
    .year-bar{display:flex;gap:6px;}
    .yr-btn{padding:6px 14px;border:1.5px solid var(--border);border-radius:7px;background:white;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;color:var(--muted);transition:all 0.15s;}
    .yr-btn.active{background:var(--blue-main);color:white;border-color:var(--blue-main);}
    .btn{padding:7px 15px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.15s;}
    .btn-primary{background:linear-gradient(135deg,var(--blue-main),var(--blue-light));color:white;}
    .btn-outline{background:white;color:var(--blue-main);border:1.5px solid var(--border);}
    .btn-sm{padding:5px 12px;font-size:11px;}
    .btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}
    .ht-badge{font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;background:#dbeafe;color:#1d4ed8;}

    /* CONTENT */
    .content{padding:20px 26px;display:flex;flex-direction:column;gap:18px;}

    /* ZONE SAISIE */
    .saisie-zone{background:white;border:2px solid var(--blue-light);border-radius:14px;overflow:hidden;box-shadow:0 4px 20px rgba(79,126,248,0.1);}
    .saisie-header{background:linear-gradient(135deg,#eff6ff,#e0eaff);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #c7d2fe;}
    .saisie-title{font-size:14px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .saisie-hint{font-size:11px;color:var(--muted);margin-top:2px;}
    .legend{display:flex;gap:14px;font-size:11px;}
    .legend-item{display:flex;align-items:center;gap:5px;}
    .legend-dot{width:10px;height:10px;border-radius:3px;}

    /* TABLE */
    table{width:100%;border-collapse:collapse;}
    thead th{padding:10px 12px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:0.4px;white-space:nowrap;}
    th.col-saisie{background:#eff6ff;color:var(--blue-main);border-bottom:2px solid var(--blue-main);}
    th.col-calc{background:#f0fdf4;color:#166534;border-bottom:2px solid var(--green);}
    th.col-month{background:#f8faff;color:var(--muted);border-bottom:2px solid var(--border);text-align:left;}
    tbody tr{border-bottom:1px solid #f1f5f9;}
    tbody tr:hover{background:#fafbff;}
    tbody tr.highlight{background:linear-gradient(90deg,#fffbeb,white);}
    .month-cell{padding:9px 12px;font-weight:700;font-size:12px;white-space:nowrap;min-width:110px;}
    .month-cell.cur{color:var(--blue-main);}
    .input-cell{background:#eff6ff;}
    .input-cell input{width:100%;padding:9px 10px;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;color:var(--blue-main);text-align:right;outline:none;}
    .input-cell input:focus{background:#dbeafe;}
    .input-cell input::placeholder{color:#93c5fd;font-weight:400;}
    .calc-cell{background:#f0fdf4;padding:9px 12px;text-align:right;font-weight:700;font-size:12px;}
    .calc-cell.blue{color:var(--blue-main);}
    .calc-cell.green{color:var(--green);}
    .calc-cell.muted{color:var(--muted);}
    .evo-pos{color:var(--green);}
    .evo-neg{color:var(--red);}

    /* KPI */
    .kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
    .kpi{background:white;border:1px solid var(--border);border-radius:12px;padding:14px 16px;}
    .kpi.blue{background:#eff6ff;border-color:#bfdbfe;}
    .kpi.green{background:#f0fdf4;border-color:#bbf7d0;}
    .kpi.orange{background:#fffbeb;border-color:#fde68a;}
    .kpi.purple{background:#f5f3ff;border-color:#ddd6fe;}
    .kpi-icon{font-size:18px;margin-bottom:6px;}
    .kpi-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:0.4px;}
    .kpi-val{font-size:20px;font-weight:800;margin-top:3px;}
    .kpi-sub{font-size:10px;color:var(--muted);margin-top:2px;}
    .kpi-trend{font-size:11px;font-weight:700;margin-top:3px;}
    .kpi-trend.up{color:var(--green);}
    .kpi-trend.down{color:var(--red);}

    /* CHARTS */
    .charts-2{display:grid;grid-template-columns:2fr 1fr;gap:14px;}
    .charts-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}
    .card{background:white;border:1px solid var(--border);border-radius:12px;padding:16px;}
    .card-title{font-size:13px;font-weight:700;margin-bottom:12px;}
    .card-sub{font-size:11px;color:var(--muted);font-weight:400;margin-left:4px;}

    /* CAT√âGORIES */
    .cats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
    .cat-card{background:white;border:1px solid var(--border);border-radius:12px;overflow:hidden;}
    .cat-top{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;}
    .cat-color-bar{width:4px;height:28px;border-radius:2px;flex-shrink:0;}
    .cat-name{font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;color:var(--text);border:none;outline:none;background:transparent;flex:1;}
    .cat-body{padding:12px 14px;display:flex;flex-direction:column;gap:8px;}
    .cat-row{display:flex;justify-content:space-between;align-items:center;font-size:12px;}
    .cat-input{width:90px;padding:5px 8px;border:1.5px solid var(--border);border-radius:6px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;text-align:right;outline:none;color:var(--text);}
    .cat-input:focus{border-color:var(--blue-main);}
    .cat-result{font-weight:700;}
    .cat-result.blue{color:var(--blue-main);}
    .cat-result.green{color:var(--green);}
    .cat-divider{height:1px;background:var(--border);margin:4px 0;}
    .add-cat{display:flex;align-items:center;justify-content:center;gap:6px;padding:14px;border:2px dashed var(--border);border-radius:12px;cursor:pointer;color:var(--muted);font-size:13px;font-weight:600;background:white;transition:all 0.15s;}
    .add-cat:hover{border-color:var(--blue-main);color:var(--blue-main);background:var(--blue-ghost);}

    /* SIMULATEUR */
    .sim-card{background:white;border:1px solid var(--border);border-radius:12px;overflow:hidden;}
    .sim-head{padding:16px 22px;background:linear-gradient(135deg,#4f46e5,#7c3aed);display:flex;align-items:center;justify-content:space-between;}
    .sim-head-title{font-size:14px;font-weight:700;color:white;}
    .sim-body{padding:20px 22px;}
    .sim-levers{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:18px;}
    .sim-lever{background:#f8faff;border:1.5px solid #e8eaf6;border-radius:10px;padding:14px;}
    .sim-lever-lbl{font-size:11px;font-weight:700;color:var(--text);margin-bottom:10px;}
    .sim-input-wrap{display:flex;align-items:center;gap:6px;padding:8px 10px;background:white;border:2px solid #e2e8f0;border-radius:8px;}
    .sim-input-wrap:focus-within{border-color:var(--blue-main);box-shadow:0 0 0 3px rgba(79,126,248,0.1);}
    .sim-input{flex:1;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:16px;font-weight:800;color:#1a1f36;outline:none;min-width:0;}
    .sim-input::placeholder{color:#cbd5e1;}
    .sim-unit{font-size:11px;font-weight:700;color:var(--muted);}
    .sim-result{background:linear-gradient(135deg,#1a1f36,#2d3561);border-radius:12px;padding:20px;color:white;}
    .sim-res-title{font-size:10px;font-weight:600;color:rgba(255,255,255,0.45);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:14px;}
    .sim-res-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
    .sim-res-item{text-align:center;}
    .sim-res-lbl{font-size:10px;color:rgba(255,255,255,0.4);font-weight:600;text-transform:uppercase;margin-bottom:5px;}
    .sim-res-cur{font-size:11px;color:rgba(255,255,255,0.35);margin-bottom:2px;}
    .sim-res-new{font-size:17px;font-weight:800;}
    .pos{color:#34d399;} .neg{color:#f87171;}
    .sim-res-delta{font-size:11px;font-weight:700;margin-top:2px;}
    .dpos{color:#6ee7b7;} .dneg{color:#fca5a5;}

    .toast{position:fixed;bottom:20px;right:20px;padding:11px 18px;border-radius:9px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(60px);opacity:0;transition:all 0.3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.ok{background:#10b981;color:white;}
    .toast.err{background:#ef4444;color:white;}
  </style>
</head>
<body>

<aside class="sidebar">
  <div class="logo"><div class="logo-icon">üìä</div><div class="logo-text">ALTIORA</div></div>
  <div class="nav-section">Principal</div>
  <div class="nav-item" onclick="location.href='dashboard.html'"><span>üè†</span><span>Tableau de bord</span></div>
  <div class="nav-item" onclick="location.href='suivi-ca.html'"><span>üìà</span><span>Suivi CA & R√©sultats</span></div>
  <div class="nav-item active" id="kpis-nav">
    <span>üéØ</span><span style="flex:1" onclick="toggleMenu()">KPIs Cl√©s</span>
    <span class="nav-chevron" id="chevron" onclick="toggleMenu()">‚Ä∫</span>
  </div>
  <div class="submenu open" id="kpis-menu">
    <div class="sub-item" onclick="location.href='cout-revient.html'"><span class="sub-dot"></span>Co√ªt de revient</div>
    <div class="sub-item" onclick="location.href='marges.html'"><span class="sub-dot"></span>Marge brute & nette</div>
    <div class="sub-item active"><span class="sub-dot"></span>Panier moyen</div>
  </div>
  <div class="nav-item" onclick="togglePilotage(this)"><span>üß≠</span><span style="flex:1">Pilotage</span><span class="nav-chevron">‚Ä∫</span></div>
  <div class="submenu" id="pilotage-menu">
    <div class="sub-item" onclick="location.href='pilotage.html?year=2025'"><span class="sub-dot"></span>Pilotage 2025</div>
    <div class="sub-item" onclick="location.href='pilotage.html?year=2026'"><span class="sub-dot"></span>Pilotage 2026</div>
  </div>
  <div class="nav-item"><span>üè¶</span><span>Dettes & Emprunts</span></div>
  <div class="sidebar-footer">
    <div class="user-row">
      <div class="avatar" id="av">A</div>
      <div><div class="user-name" id="uname">Utilisateur</div><div class="user-plan">Plan gratuit</div></div>
      <button class="logout-btn" onclick="doLogout()">‚éã</button>
    </div>
  </div>
</aside>

<div class="main">
  <div class="topbar">
    <div>
      <h1>Panier moyen <span class="ht-badge">HT</span></h1>
      <p>Toutes les valeurs sont en HT ‚Äî Saisissez vos donn√©es mensuelles, les calculs se font automatiquement</p>
    </div>
    <div class="topbar-right">
      <div class="year-bar" id="yearBar"></div>
      <button class="btn btn-primary btn-sm" onclick="saveData()">üíæ Sauvegarder</button>
    </div>
  </div>

  <div class="content">

    <!-- 1. SAISIE MENSUELLE -->
    <div class="saisie-zone">
      <div class="saisie-header">
        <div>
          <div class="saisie-title">‚úèÔ∏è Saisie mensuelle <span class="ht-badge">HT</span></div>
          <div class="saisie-hint">Remplissez les <strong style="color:var(--blue-main)">3 colonnes bleues</strong> ¬∑ Le reste est calcul√© automatiquement</div>
        </div>
        <div class="legend">
          <div class="legend-item"><div class="legend-dot" style="background:#bfdbfe;border:1.5px solid var(--blue-main)"></div><span>√Ä saisir</span></div>
          <div class="legend-item"><div class="legend-dot" style="background:#bbf7d0;border:1.5px solid var(--green)"></div><span>Calcul√© auto</span></div>
        </div>
      </div>
      <div style="overflow-x:auto">
        <table id="mainTable">
          <thead>
            <tr>
              <th class="col-month" style="text-align:left;min-width:120px">Mois</th>
              <th class="col-saisie" style="text-align:right;min-width:100px">üë• Nb clients</th>
              <th class="col-saisie" style="text-align:right;min-width:130px">üí∂ CA HT (‚Ç¨)</th>
              <th class="col-saisie" style="text-align:right;min-width:110px">üîÑ Nb ventes</th>
              <th class="col-calc" style="text-align:right;min-width:130px">üõí Panier/vente HT</th>
              <th class="col-calc" style="text-align:right;min-width:130px">üë§ Panier/client HT</th>
              <th class="col-calc" style="text-align:right;min-width:100px">üîÅ Ventes/client</th>
              <th class="col-calc" style="text-align:right;min-width:90px">üìà √âvolution</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- 2. KPIs -->
    <div class="kpi-row">
      <div class="kpi blue"><div class="kpi-icon">üõí</div><div class="kpi-lbl">Panier moy./commande HT</div><div class="kpi-val" id="k-pm-cmd">‚Äî</div><div class="kpi-sub">CA √∑ nb transactions</div><div class="kpi-trend" id="k-pm-cmd-t"></div></div>
      <div class="kpi green"><div class="kpi-icon">üë§</div><div class="kpi-lbl">Panier moy./client HT</div><div class="kpi-val" id="k-pm-cli">‚Äî</div><div class="kpi-sub">CA √∑ nb clients</div><div class="kpi-trend" id="k-pm-cli-t"></div></div>
      <div class="kpi"><div class="kpi-icon">üí∂</div><div class="kpi-lbl">CA total HT (ann√©e)</div><div class="kpi-val" id="k-ca">‚Äî</div><div class="kpi-sub">Cumul annuel</div></div>
      <div class="kpi orange"><div class="kpi-icon">üîÑ</div><div class="kpi-lbl">Ventes / mois (moy.)</div><div class="kpi-val" id="k-txn">‚Äî</div><div class="kpi-sub">Moyenne mensuelle</div></div>
      <div class="kpi purple"><div class="kpi-icon">üë•</div><div class="kpi-lbl">Clients / mois (moy.)</div><div class="kpi-val" id="k-cli">‚Äî</div><div class="kpi-sub">Moyenne mensuelle</div></div>
    </div>

    <!-- 3. GRAPHIQUES -->
    <div class="charts-2">
      <div class="card">
        <div class="card-title">üìà √âvolution panier moyen HT<span class="card-sub">par commande et par client</span></div>
        <div style="height:200px"><canvas id="cEvol"></canvas></div>
      </div>
      <div class="card">
        <div class="card-title">üç© CA par cat√©gorie HT</div>
        <div style="height:200px"><canvas id="cCat"></canvas></div>
      </div>
    </div>
    <div class="charts-3">
      <div class="card"><div class="card-title">üë• √âvolution clients</div><div style="height:140px"><canvas id="cCli"></canvas></div></div>
      <div class="card"><div class="card-title">üîÑ √âvolution transactions</div><div style="height:140px"><canvas id="cTxn"></canvas></div></div>
      <div class="card"><div class="card-title">üí∂ √âvolution CA HT</div><div style="height:140px"><canvas id="cCA"></canvas></div></div>
    </div>

    <!-- 4. CAT√âGORIES -->
    <div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div>
          <div style="font-size:14px;font-weight:700">üì¶ Panier moyen par cat√©gorie <span class="ht-badge">HT</span></div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">Ajoutez vos cat√©gories (produits, services‚Ä¶) et comparez les paniers</div>
        </div>
        <button class="btn btn-outline btn-sm" onclick="addCat()">+ Ajouter</button>
      </div>
      <div class="cats-grid" id="catsGrid"></div>
    </div>

    <!-- 5. SIMULATEUR -->
    <div class="sim-card">
      <div class="sim-head">
        <div class="sim-head-title">üîÆ Simulateur d'impact CA <span style="font-size:11px;opacity:0.6;font-weight:400">‚Äî valeurs HT</span></div>
        <button class="btn btn-sm" style="background:rgba(255,255,255,0.15);color:white;border:1px solid rgba(255,255,255,0.25)" onclick="resetSim()">‚Ü∫ R√©initialiser</button>
      </div>
      <div class="sim-body">
        <div class="sim-levers">
          <div class="sim-lever">
            <div class="sim-lever-lbl">üõí Panier moyen/commande HT</div>
            <div class="sim-input-wrap"><input class="sim-input" id="s-pm" type="number" placeholder="0" oninput="calcSim()" onchange="calcSim()"/><span class="sim-unit">‚Ç¨</span></div>
          </div>
          <div class="sim-lever">
            <div class="sim-lever-lbl">üîÑ Nb transactions / mois</div>
            <div class="sim-input-wrap"><input class="sim-input" id="s-txn" type="number" placeholder="0" oninput="calcSim()" onchange="calcSim()"/><span class="sim-unit">ventes</span></div>
          </div>
          <div class="sim-lever">
            <div class="sim-lever-lbl">üë• Nb clients / mois</div>
            <div class="sim-input-wrap"><input class="sim-input" id="s-cli" type="number" placeholder="0" oninput="calcSim()" onchange="calcSim()"/><span class="sim-unit">clients</span></div>
          </div>
          <div class="sim-lever">
            <div class="sim-lever-lbl">üìÖ P√©riode simul√©e</div>
            <div class="sim-input-wrap"><input class="sim-input" id="s-mois" type="number" placeholder="12" value="12" oninput="calcSim()" onchange="calcSim()"/><span class="sim-unit">mois</span></div>
          </div>
        </div>
        <div class="sim-result">
          <div class="sim-res-title">üìä R√©sultat simul√© vs situation actuelle (moyennes HT)</div>
          <div class="sim-res-grid">
            <div class="sim-res-item"><div class="sim-res-lbl">Panier/commande HT</div><div class="sim-res-cur" id="r-pm-cur">‚Äî</div><div class="sim-res-new" id="r-pm-new">‚Äî</div><div class="sim-res-delta" id="r-pm-d"></div></div>
            <div class="sim-res-item"><div class="sim-res-lbl">CA mensuel HT</div><div class="sim-res-cur" id="r-ca-m-cur">‚Äî</div><div class="sim-res-new" id="r-ca-m-new">‚Äî</div><div class="sim-res-delta" id="r-ca-m-d"></div></div>
            <div class="sim-res-item"><div class="sim-res-lbl">CA annuel HT</div><div class="sim-res-cur" id="r-ca-a-cur">‚Äî</div><div class="sim-res-new" id="r-ca-a-new">‚Äî</div><div class="sim-res-delta" id="r-ca-a-d"></div></div>
            <div class="sim-res-item"><div class="sim-res-lbl">Panier/client HT</div><div class="sim-res-cur" id="r-pc-cur">‚Äî</div><div class="sim-res-new" id="r-pc-new">‚Äî</div><div class="sim-res-delta" id="r-pc-d"></div></div>
            <div class="sim-res-item"><div class="sim-res-lbl">Ventes/client</div><div class="sim-res-cur" id="r-tc-cur">‚Äî</div><div class="sim-res-new" id="r-tc-new">‚Äî</div><div class="sim-res-delta" id="r-tc-d"></div></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ CONSTANTES ‚îÄ‚îÄ
const MONTHS = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
const COLORS = ['#4f7ef8','#10b981','#f59e0b','#ef4444','#6366f1','#14b8a6','#ec4899','#8b5cf6'];
let _year = new Date().getFullYear();
let _charts = {};

// ‚îÄ‚îÄ DONN√âES : localStorage uniquement, pas de Firebase pour le rendu ‚îÄ‚îÄ
function key(y){ return 'altiora_panier_' + y; }
function catKey(y){ return 'altiora_panier_cats_' + y; }

function loadMonths(y){
  try{ const d = localStorage.getItem(key(y)); if(d) return JSON.parse(d); }catch(e){}
  return Array(12).fill(null).map(()=>({cli:'',ca:'',txn:''}));
}
function saveMonths(y,data){ localStorage.setItem(key(y), JSON.stringify(data)); }

function loadCats(y){
  try{ const d = localStorage.getItem(catKey(y)); if(d) return JSON.parse(d); }catch(e){}
  return [];
}
function saveCats(y,cats){ localStorage.setItem(catKey(y), JSON.stringify(cats)); }

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let months = loadMonths(_year);
let cats = loadCats(_year);

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function fe(n){ return (parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨'; }
function fi(n){ return Math.round(parseFloat(n)||0).toLocaleString('fr-FR'); }
function set(id,v){ const e=document.getElementById(id); if(e) e.textContent=v; }
function cls(id,c){ const e=document.getElementById(id); if(e) e.className=c; }

function toggleMenu(){
  document.getElementById('kpis-menu').classList.toggle('open');
  document.getElementById('kpis-nav').classList.toggle('active');
}
function togglePilotage(el){
  document.getElementById('pilotage-menu').classList.toggle('open');
  el.classList.toggle('active');
}
async function doLogout(){
  try{ if(window._signOut&&window._auth) await window._signOut(window._auth); }catch(e){}
  location.href='index.html';
}

// ‚îÄ‚îÄ CALCULS MOIS ‚îÄ‚îÄ
function calcRow(m){
  const cli=parseFloat(m.cli)||0, ca=parseFloat(m.ca)||0, txn=parseFloat(m.txn)||0;
  return { cli, ca, txn, pmCmd: txn>0?ca/txn:0, pmCli: cli>0?ca/cli:0, vpc: cli>0?txn/cli:0 };
}

// ‚îÄ‚îÄ RENDER TABLE ‚îÄ‚îÄ
function renderTable(){
  const now = new Date();
  const curM = now.getFullYear()===_year ? now.getMonth() : -1;
  let prevPm = 0;
  const rows = months.map((m,i)=>{
    const c = calcRow(m);
    const isCur = i === curM;
    let evoHtml = '<span class="calc-cell muted" style="display:block;text-align:right;padding:9px 12px">‚Äî</span>';
    if(prevPm>0 && c.pmCmd>0){
      const pct = (c.pmCmd - prevPm)/prevPm*100;
      evoHtml = `<span class="${pct>=0?'evo-pos':'evo-neg'}" style="display:block;text-align:right;padding:9px 12px;font-weight:700">${pct>=0?'‚ñ≤':'‚ñº'} ${Math.abs(pct).toFixed(1)}%</span>`;
    }
    if(c.pmCmd>0) prevPm = c.pmCmd;
    return `<tr class="${isCur?'highlight':''}">
      <td><div class="month-cell ${isCur?'cur'}">${MONTHS[i]} ${_year}${isCur?' üìç':''}</div></td>
      <td class="input-cell"><input type="number" placeholder="0" value="${m.cli}" oninput="upd(${i},'cli',this.value)" onchange="upd(${i},'cli',this.value)"/></td>
      <td class="input-cell"><input type="number" placeholder="0.00" value="${m.ca}" oninput="upd(${i},'ca',this.value)" onchange="upd(${i},'ca',this.value)"/></td>
      <td class="input-cell"><input type="number" placeholder="0" value="${m.txn}" oninput="upd(${i},'txn',this.value)" onchange="upd(${i},'txn',this.value)"/></td>
      <td class="calc-cell blue">${c.pmCmd>0?fe(c.pmCmd):'‚Äî'}</td>
      <td class="calc-cell green">${c.pmCli>0?fe(c.pmCli):'‚Äî'}</td>
      <td class="calc-cell muted">${c.vpc>0?c.vpc.toFixed(2):'‚Äî'}</td>
      <td class="calc-cell" style="background:#f0fdf4">${evoHtml}</td>
    </tr>`;
  }).join('');
  document.getElementById('tbody').innerHTML = rows;
}

function upd(i, field, val){
  months[i][field] = val;
  renderTable();
  renderKPIs();
  renderCharts();
  prefillSim();
}

// ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ
function getStats(){
  const active = months.map((m,i)=>({...calcRow(m),i})).filter(m=>m.ca>0||m.cli>0||m.txn>0);
  if(!active.length) return null;
  const caT = active.reduce((s,m)=>s+m.ca,0);
  const txnT = active.reduce((s,m)=>s+m.txn,0);
  const cliT = active.reduce((s,m)=>s+m.cli,0);
  const n = active.length;
  return { pmCmd: txnT>0?caT/txnT:0, pmCli: cliT>0?caT/cliT:0, caTotal: caT, txnAvg: txnT/n, cliAvg: cliT/n, active };
}

function renderKPIs(){
  const s = getStats();
  if(!s){ ['k-pm-cmd','k-pm-cli','k-ca','k-txn','k-cli'].forEach(id=>set(id,'‚Äî')); return; }
  set('k-pm-cmd', fe(s.pmCmd));
  set('k-pm-cli', fe(s.pmCli));
  set('k-ca', fe(s.caTotal));
  set('k-txn', fi(s.txnAvg));
  set('k-cli', fi(s.cliAvg));
  // Tendance 2 derniers mois
  const a = s.active;
  if(a.length>=2){
    const last=a[a.length-1], prev=a[a.length-2];
    if(prev.pmCmd>0){
      const d=(last.pmCmd-prev.pmCmd)/prev.pmCmd*100;
      document.getElementById('k-pm-cmd-t').innerHTML=`<span class="${d>=0?'up':'down'}">${d>=0?'‚ñ≤':'‚ñº'} ${Math.abs(d).toFixed(1)}% vs mois pr√©c.</span>`;
      document.getElementById('k-pm-cmd-t').className='kpi-trend '+(d>=0?'up':'down');
    }
    if(prev.pmCli>0){
      const d=(last.pmCli-prev.pmCli)/prev.pmCli*100;
      document.getElementById('k-pm-cli-t').innerHTML=`<span class="${d>=0?'up':'down'}">${d>=0?'‚ñ≤':'‚ñº'} ${Math.abs(d).toFixed(1)}% vs mois pr√©c.</span>`;
    }
  }
}

// ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ
function destroyChart(id){ if(_charts[id]){ try{_charts[id].destroy();}catch(e){} delete _charts[id]; } }

function renderCharts(){
  const pmCmdData = months.map(m=>calcRow(m).pmCmd||null);
  const pmCliData = months.map(m=>calcRow(m).pmCli||null);
  const cliData   = months.map(m=>parseFloat(m.cli)||null);
  const txnData   = months.map(m=>parseFloat(m.txn)||null);
  const caData    = months.map(m=>parseFloat(m.ca)||null);

  // Evolution paniers
  destroyChart('cEvol');
  const c1 = document.getElementById('cEvol'); if(c1){
    _charts['cEvol'] = new Chart(c1,{type:'line',data:{labels:MONTHS,datasets:[
      {label:'Panier/commande HT',data:pmCmdData,borderColor:'#4f7ef8',backgroundColor:'#4f7ef822',tension:0.4,fill:true,pointRadius:4,borderWidth:2.5,spanGaps:true},
      {label:'Panier/client HT',data:pmCliData,borderColor:'#10b981',backgroundColor:'#10b98122',tension:0.4,fill:true,pointRadius:4,borderWidth:2.5,spanGaps:true},
    ]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{position:'bottom',labels:{font:{size:11},boxWidth:11}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v+'‚Ç¨'}}}}});
  }

  // Camembert cat√©gories
  destroyChart('cCat');
  const c2 = document.getElementById('cCat'); if(c2){
    const catData = cats.map(c=>parseFloat(c.ca)||0).filter(v=>v>0);
    const catLabels = cats.filter(c=>parseFloat(c.ca)>0).map(c=>c.nom||'Sans nom');
    if(catData.length){
      _charts['cCat'] = new Chart(c2,{type:'doughnut',data:{labels:catLabels,datasets:[{data:catData,backgroundColor:COLORS.slice(0,catData.length),borderWidth:2,borderColor:'white',hoverOffset:5}]},options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{position:'bottom',labels:{font:{size:11},boxWidth:10}}}}});
    } else {
      _charts['cCat'] = new Chart(c2,{type:'doughnut',data:{labels:['Aucune cat√©gorie'],datasets:[{data:[1],backgroundColor:['#e2e8f0']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}}});
    }
  }

  // Bar clients
  destroyChart('cCli');
  const c3=document.getElementById('cCli'); if(c3){
    _charts['cCli']=new Chart(c3,{type:'bar',data:{labels:MONTHS,datasets:[{label:'Clients',data:cliData,backgroundColor:'#6366f1bb',borderRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
  }

  // Bar txn
  destroyChart('cTxn');
  const c4=document.getElementById('cTxn'); if(c4){
    _charts['cTxn']=new Chart(c4,{type:'bar',data:{labels:MONTHS,datasets:[{label:'Transactions',data:txnData,backgroundColor:'#f59e0bbb',borderRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
  }

  // Area CA
  destroyChart('cCA');
  const c5=document.getElementById('cCA'); if(c5){
    _charts['cCA']=new Chart(c5,{type:'line',data:{labels:MONTHS,datasets:[{data:caData,borderColor:'#4f7ef8',backgroundColor:'#4f7ef822',fill:true,tension:0.4,pointRadius:3,borderWidth:2,spanGaps:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v+'‚Ç¨'}}}}});
  }
}

// ‚îÄ‚îÄ CAT√âGORIES ‚îÄ‚îÄ
function renderCats(){
  const grid = document.getElementById('catsGrid');
  grid.innerHTML = cats.map((c,i)=>{
    const pmCmd = (parseFloat(c.txn)||0)>0 ? fe((parseFloat(c.ca)||0)/(parseFloat(c.txn)||1)) : '‚Äî';
    const pmCli = (parseFloat(c.cli)||0)>0 ? fe((parseFloat(c.ca)||0)/(parseFloat(c.cli)||1)) : '‚Äî';
    const vpc   = (parseFloat(c.cli)||0)>0 ? ((parseFloat(c.txn)||0)/(parseFloat(c.cli)||1)).toFixed(2) : '‚Äî';
    return `<div class="cat-card" style="border-top:3px solid ${COLORS[i%COLORS.length]}">
      <div class="cat-top">
        <div class="cat-color-bar" style="background:${COLORS[i%COLORS.length]}"></div>
        <input class="cat-name" value="${c.nom||''}" placeholder="Nom cat√©gorie..." oninput="updCat(${i},'nom',this.value)"/>
        <button class="btn btn-danger" style="padding:3px 8px;font-size:11px" onclick="delCat(${i})">‚úï</button>
      </div>
      <div class="cat-body">
        <div class="cat-row"><span>CA mensuel HT (‚Ç¨)</span><input class="cat-input" type="number" placeholder="0" value="${c.ca||''}" oninput="updCat(${i},'ca',this.value)" onchange="updCat(${i},'ca',this.value)"/></div>
        <div class="cat-row"><span>Nb ventes/mois</span><input class="cat-input" type="number" placeholder="0" value="${c.txn||''}" oninput="updCat(${i},'txn',this.value)" onchange="updCat(${i},'txn',this.value)"/></div>
        <div class="cat-row"><span>Nb clients/mois</span><input class="cat-input" type="number" placeholder="0" value="${c.cli||''}" oninput="updCat(${i},'cli',this.value)" onchange="updCat(${i},'cli',this.value)"/></div>
        <div class="cat-divider"></div>
        <div class="cat-row"><span>üõí Panier/commande HT</span><div class="cat-result blue">${pmCmd}</div></div>
        <div class="cat-row"><span>üë§ Panier/client HT</span><div class="cat-result green">${pmCli}</div></div>
        <div class="cat-row"><span>üîÅ Ventes/client</span><div class="cat-result">${vpc}</div></div>
      </div>
    </div>`;
  }).join('') + `<div class="add-cat" onclick="addCat()"><span style="font-size:18px">+</span> Nouvelle cat√©gorie</div>`;
}

function addCat(){ cats.push({nom:'',ca:'',txn:'',cli:''}); renderCats(); renderCharts(); }
function delCat(i){ cats.splice(i,1); renderCats(); renderCharts(); }
function updCat(i,f,v){ cats[i][f]=v; renderCats(); renderCharts(); }

// ‚îÄ‚îÄ SIMULATEUR ‚îÄ‚îÄ
function prefillSim(){
  const s = getStats();
  if(!s) return;
  document.getElementById('s-pm').placeholder = s.pmCmd.toFixed(2);
  document.getElementById('s-txn').placeholder = Math.round(s.txnAvg);
  document.getElementById('s-cli').placeholder = Math.round(s.cliAvg);
  // Valeurs actuelles
  const caMens = s.pmCmd * s.txnAvg;
  set('r-pm-cur', s.pmCmd>0?fe(s.pmCmd):'‚Äî');
  set('r-ca-m-cur', caMens>0?fe(caMens):'‚Äî');
  set('r-ca-a-cur', fe(s.caTotal));
  set('r-pc-cur', s.pmCli>0?fe(s.pmCli):'‚Äî');
  const tc = s.cliAvg>0?s.txnAvg/s.cliAvg:0;
  set('r-tc-cur', tc>0?tc.toFixed(2):'‚Äî');
}

function calcSim(){
  const s = getStats();
  const pmS  = parseFloat(document.getElementById('s-pm').value)  || (s?s.pmCmd:0);
  const txnS = parseFloat(document.getElementById('s-txn').value) || (s?s.txnAvg:0);
  const cliS = parseFloat(document.getElementById('s-cli').value) || (s?s.cliAvg:0);
  const mois = parseFloat(document.getElementById('s-mois').value)|| 12;
  const caMensS = pmS * txnS;
  const caAnS   = caMensS * mois;
  const pcS = cliS>0 ? caMensS/cliS : 0;
  const tcS = cliS>0 ? txnS/cliS : 0;
  const caMensC = s ? s.pmCmd*s.txnAvg : 0;
  const caAnC   = s ? s.caTotal : 0;

  function renderRes(newId, deltaId, newVal, curVal, isEur=true){
    const delta = newVal-curVal;
    const pos = delta>=0;
    const fmt = isEur ? fe : (v=>v.toFixed(2));
    const el = document.getElementById(newId);
    if(el){ el.textContent=fmt(newVal); el.className='sim-res-new '+(newVal<0?'neg':(pos?'pos':'')); }
    const del = document.getElementById(deltaId);
    if(del){ del.textContent=(pos?'+':'')+fmt(delta); del.className='sim-res-delta '+(pos?'dpos':'dneg'); }
  }
  renderRes('r-pm-new','r-pm-d', pmS, s?s.pmCmd:0);
  renderRes('r-ca-m-new','r-ca-m-d', caMensS, caMensC);
  renderRes('r-ca-a-new','r-ca-a-d', caAnS, caAnC);
  renderRes('r-pc-new','r-pc-d', pcS, s?s.pmCli:0);
  renderRes('r-tc-new','r-tc-d', tcS, s?s.txnAvg/Math.max(s.cliAvg,1):0, false);
}

function resetSim(){
  ['s-pm','s-txn','s-cli'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('s-mois').value='12';
  calcSim();
}

// ‚îÄ‚îÄ YEAR BAR ‚îÄ‚îÄ
function buildYearBar(){
  document.getElementById('yearBar').innerHTML = [2024,2025,2026,2027].map(y=>
    `<button class="yr-btn ${y===_year?'active':''}" onclick="switchYear(${y})">${y}</button>`
  ).join('');
}

function switchYear(y){
  saveMonths(_year, months); saveCats(_year, cats);
  _year=y; months=loadMonths(y); cats=loadCats(y);
  buildYearBar(); renderTable(); renderKPIs(); renderCharts(); renderCats(); prefillSim();
}

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
function saveData(){
  saveMonths(_year, months); saveCats(_year, cats);
  // Sync Firebase en arri√®re-plan si dispo
  if(window._uid && window._setDoc && window._doc && window._db){
    window._setDoc(window._doc(window._db,'panier',window._uid,'data','all'),{
      [`y${_year}`]: {months, cats}
    },{merge:true}).catch(e=>console.warn(e));
  }
  showToast('‚úÖ Sauvegard√© !','ok');
}

function showToast(msg, type){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast show '+(type||'');
  setTimeout(()=>t.className='toast',3000);
}

// ‚îÄ‚îÄ FIREBASE (en arri√®re plan, optionnel) ‚îÄ‚îÄ
async function tryLoadFirebase(){
  if(!window._uid || !window._getDoc) return;
  try{
    const snap = await window._getDoc(window._doc(window._db,'panier',window._uid,'data','all'));
    if(snap.exists()){
      const d = snap.data()[`y${_year}`];
      if(d && d.months){ months=d.months; if(d.cats) cats=d.cats; renderTable(); renderKPIs(); renderCharts(); renderCats(); prefillSim(); }
    }
    const uname = window._auth?.currentUser?.displayName || window._auth?.currentUser?.email?.split('@')[0] || '';
    if(uname){ document.getElementById('uname').textContent=uname; document.getElementById('av').textContent=uname[0].toUpperCase(); }
  }catch(e){ console.warn('Firebase:', e); }
}

// ‚îÄ‚îÄ D√âMARRAGE IMM√âDIAT ‚îÄ‚îÄ
buildYearBar();
renderTable();
renderKPIs();
renderCharts();
renderCats();
prefillSim();

// Firebase en arri√®re-plan
setTimeout(tryLoadFirebase, 800);
</script>

<!-- Firebase en arri√®re-plan -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",storageBucket:"altiora-70599.firebasestorage.app",messagingSenderId:"120905555746",appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"});
  const auth=getAuth(app); const db=getFirestore(app);
  window._auth=auth; window._db=db; window._doc=doc; window._setDoc=setDoc; window._getDoc=getDoc; window._signOut=signOut;
  onAuthStateChanged(auth, user=>{
    if(!user){ location.href='index.html'; return; }
    window._uid=user.uid;
    tryLoadFirebase();
  });
</script>
</body>
</html>
