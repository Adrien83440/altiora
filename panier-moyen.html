<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>ALTIORA ‚Äî Panier Moyen</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --nav:#0f1f5c;--blue:#1a3dce;--blue2:#4f7ef8;--bg:#f4f6fb;--white:#fff;
  --border:#e2e8f0;--text:#1a1f36;--muted:#6b7280;--green:#10b981;--red:#ef4444;
  --orange:#f59e0b;--purple:#6366f1;--radius:14px;--sw:250px;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px}

/* NAV */
nav{width:var(--sw);min-height:100vh;background:linear-gradient(180deg,#0f1f5c,#162366);position:fixed;top:0;left:0;display:flex;flex-direction:column;padding-bottom:20px;overflow-y:auto;z-index:99}
.logo{display:flex;align-items:center;gap:10px;padding:22px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
.logo-i{width:33px;height:33px;background:rgba(255,255,255,.14);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
.logo-t{font-size:17px;font-weight:800;color:#fff;letter-spacing:1px}
.ns{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 18px 4px}
.ni{display:flex;align-items:center;gap:9px;padding:9px 18px;color:rgba(255,255,255,.55);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.ni:hover{color:#fff;background:rgba(255,255,255,.06)}
.ni.on{color:#fff;background:rgba(255,255,255,.1);border-left-color:#4f7ef8}
.sub{overflow:hidden;max-height:0;transition:max-height .3s}
.sub.open{max-height:200px}
.si{display:flex;align-items:center;gap:7px;padding:7px 18px 7px 40px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.si:hover{color:rgba(255,255,255,.75);background:rgba(255,255,255,.04)}
.si.on{color:#fff;background:rgba(79,126,248,.15);border-left-color:rgba(79,126,248,.6)}
.dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25)}
.si.on .dot{background:#4f7ef8}
.nav-footer{margin-top:auto;padding:12px 18px 0;border-top:1px solid rgba(255,255,255,.08)}
.ucard{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,.07);border-radius:8px}
.uav{width:29px;height:29px;background:linear-gradient(135deg,#4f7ef8,#6366f1);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
.un{font-size:11.5px;font-weight:600;color:#fff}
.up{font-size:10px;color:rgba(255,255,255,.3)}
.lbtn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,.3);cursor:pointer;font-size:13px}

/* MAIN */
main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.topbar h1{font-size:16px;font-weight:700}
.topbar p{font-size:11px;color:var(--muted)}
.tb-right{display:flex;align-items:center;gap:8px}
.yr-bar{display:flex;gap:5px}
.yr{padding:5px 12px;border:1.5px solid var(--border);border-radius:7px;background:#fff;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;color:var(--muted);transition:.15s}
.yr.on{background:var(--blue);color:#fff;border-color:var(--blue)}
.btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:.15s}
.btn-p{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff}
.btn-o{background:#fff;color:var(--blue);border:1.5px solid var(--border)}
.btn-xs{padding:4px 9px;font-size:11px}
.btn-d{background:#fef2f2;color:var(--red);border:1px solid #fecaca}
.badge{font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;background:#dbeafe;color:#1d4ed8;vertical-align:middle}

/* PAGE CONTENT */
.page{padding:20px 24px;display:flex;flex-direction:column;gap:18px}

/* MONTH PICKER */
.month-strip{display:flex;gap:6px;flex-wrap:wrap}
.mbtn{padding:6px 13px;border:1.5px solid var(--border);border-radius:8px;background:#fff;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;color:var(--muted);transition:.15s;position:relative}
.mbtn:hover{border-color:var(--blue2);color:var(--blue)}
.mbtn.on{background:var(--blue);color:#fff;border-color:var(--blue)}
.mbtn.has-data::after{content:'';position:absolute;top:4px;right:4px;width:5px;height:5px;border-radius:50%;background:var(--green)}
.mbtn.on.has-data::after{background:#fff}

/* SAISIE CARD */
.saisie{background:#fff;border:2px solid var(--blue2);border-radius:var(--radius);overflow:hidden;box-shadow:0 4px 20px rgba(79,126,248,.1)}
.saisie-head{background:linear-gradient(135deg,#eff6ff,#e8f0ff);padding:14px 20px;border-bottom:1px solid #c7d2fe;display:flex;align-items:center;justify-content:space-between}
.saisie-title{font-size:14px;font-weight:700}
.saisie-month{font-size:13px;font-weight:700;color:var(--blue);background:#dbeafe;padding:4px 12px;border-radius:20px}
.saisie-body{padding:20px}
.fields-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px}
.field{display:flex;flex-direction:column;gap:6px}
.field-lbl{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:5px}
.field-icon{font-size:13px}
.field-wrap{display:flex;align-items:center;gap:8px;padding:10px 14px;border:2px solid var(--border);border-radius:10px;background:#f8faff;transition:.15s}
.field-wrap:focus-within{border-color:var(--blue2);background:#fff;box-shadow:0 0 0 3px rgba(79,126,248,.1)}
.field-input{flex:1;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:17px;font-weight:800;color:var(--text);outline:none;min-width:0}
.field-input::placeholder{color:#cbd5e1;font-weight:400;font-size:14px}
.field-unit{font-size:12px;font-weight:700;color:var(--muted)}
.results-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.res-box{background:#f8faff;border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;text-align:center}
.res-box.highlight{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-color:#86efac}
.res-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px}
.res-val{font-size:20px;font-weight:800;color:var(--text)}
.res-val.green{color:var(--green)}
.res-val.blue{color:var(--blue)}
.res-hint{font-size:10px;color:var(--muted);margin-top:2px}

/* KPI CARDS */
.kpi-row{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
.kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px 16px}
.kpi.blue{background:#eff6ff;border-color:#bfdbfe}
.kpi.green{background:#f0fdf4;border-color:#bbf7d0}
.kpi.orange{background:#fffbeb;border-color:#fde68a}
.kpi.purple{background:#f5f3ff;border-color:#ddd6fe}
.kpi-ico{font-size:18px;margin-bottom:5px}
.kpi-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.kpi-val{font-size:19px;font-weight:800;margin-top:2px}
.kpi-sub{font-size:10px;color:var(--muted);margin-top:1px}
.kpi-trend{font-size:11px;font-weight:700;margin-top:3px}
.up{color:var(--green)}.down{color:var(--red)}

/* GRAPHIQUES */
.g2{display:grid;grid-template-columns:2fr 1fr;gap:14px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px}
.card-t{font-size:13px;font-weight:700;margin-bottom:12px}
.card-s{font-size:11px;color:var(--muted);font-weight:400;margin-left:4px}

/* CAT√âGORIES */
.cats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.cat{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.cat-top{padding:11px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.cat-bar{width:4px;height:26px;border-radius:2px;flex-shrink:0}
.cat-name{font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;border:none;outline:none;background:transparent;flex:1;color:var(--text)}
.cat-body{padding:12px 14px;display:flex;flex-direction:column;gap:7px}
.cat-row{display:flex;justify-content:space-between;align-items:center;font-size:12px}
.cat-in{width:88px;padding:5px 8px;border:1.5px solid var(--border);border-radius:6px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;text-align:right;outline:none;color:var(--text)}
.cat-in:focus{border-color:var(--blue2)}
.cat-r{font-weight:700}.cat-r.blue{color:var(--blue)}.cat-r.green{color:var(--green)}
.cat-div{height:1px;background:var(--border);margin:2px 0}
.add-cat{display:flex;align-items:center;justify-content:center;gap:6px;padding:14px;border:2px dashed var(--border);border-radius:12px;cursor:pointer;color:var(--muted);font-size:13px;font-weight:600;background:#fff;transition:.15s}
.add-cat:hover{border-color:var(--blue2);color:var(--blue);background:#eff6ff}

/* SIMULATEUR */
.sim{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.sim-h{padding:15px 20px;background:linear-gradient(135deg,#4f46e5,#7c3aed);display:flex;align-items:center;justify-content:space-between}
.sim-ht{font-size:14px;font-weight:700;color:#fff}
.sim-b{padding:18px 20px}
.sim-g{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.sim-lev{background:#f8faff;border:1.5px solid #e8eaf6;border-radius:10px;padding:14px}
.sim-ll{font-size:11px;font-weight:700;color:var(--text);margin-bottom:8px}
.sim-fw{display:flex;align-items:center;gap:6px;padding:8px 10px;background:#fff;border:2px solid #e2e8f0;border-radius:8px}
.sim-fw:focus-within{border-color:var(--blue2);box-shadow:0 0 0 3px rgba(79,126,248,.1)}
.sim-fi{flex:1;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:16px;font-weight:800;color:var(--text);outline:none;min-width:0}
.sim-fi::placeholder{color:#cbd5e1}
.sim-fu{font-size:11px;font-weight:700;color:var(--muted)}
.sim-res{background:linear-gradient(135deg,#1a1f36,#2d3561);border-radius:12px;padding:18px;color:#fff}
.sim-rt{font-size:10px;font-weight:600;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px}
.sim-rg{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.sim-ri{text-align:center}
.sim-rl{font-size:10px;color:rgba(255,255,255,.4);font-weight:600;text-transform:uppercase;margin-bottom:4px}
.sim-rc{font-size:11px;color:rgba(255,255,255,.3);margin-bottom:2px}
.sim-rn{font-size:16px;font-weight:800}
.sim-rn.pos{color:#34d399}.sim-rn.neg{color:#f87171}
.sim-rd{font-size:11px;font-weight:700;margin-top:2px}
.sim-rd.pos{color:#6ee7b7}.sim-rd.neg{color:#fca5a5}

.toast{position:fixed;bottom:18px;right:18px;padding:10px 16px;border-radius:9px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(60px);opacity:0;transition:.3s}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{background:#10b981;color:#fff}
.ucard:hover{background:rgba(255,255,255,.12);transform:translateY(-1px);transition:.15s}
</style>
</head>
<body>

<nav>
  <div class="logo"><div class="logo-i">üìä</div><div class="logo-t">ALTIORA</div></div>
  <div class="ns">Principal</div>
  <div class="ni" id="nav-dashboard" onclick="location.href='dashboard.html'"><span>üè†</span><span>Tableau de bord</span></div>
  <div class="ni" id="nav-suivi" onclick="location.href='suivi-ca.html'"><span>üìà</span><span>Suivi CA & R√©sultats</span></div>
  <div class="ni" id="nav-kpis" onclick="toggleNav('kpis-sub',this)"><span>üéØ</span><span style="flex:1">KPIs Cl√©s</span><span class="chev" id="chev-kpis">‚Ä∫</span></div>
  <div class="sub" id="kpis-sub">
    <div class="si" id="nav-cout" onclick="location.href='cout-revient.html'"><span class="dot"></span>Co√ªt de revient</div>
    <div class="si" id="nav-marges" onclick="location.href='marges.html'"><span class="dot"></span>Marge brute &amp; nette</div>
    <div class="si" id="nav-panier" onclick="location.href='panier-moyen.html'"><span class="dot"></span>Panier moyen</div>
  </div>
  <div class="ni" id="nav-pilotage" onclick="toggleNav('pil-sub',this)"><span>üß≠</span><span style="flex:1">Pilotage</span><span class="chev" id="chev-pil">‚Ä∫</span></div>
  <div class="sub" id="pil-sub">
    <div class="si" onclick="location.href='pilotage.html?year=2025'"><span class="dot"></span>Pilotage 2025</div>
    <div class="si" onclick="location.href='pilotage.html?year=2026'"><span class="dot"></span>Pilotage 2026</div>
    <div class="si" onclick="location.href='pilotage.html?year=2027'"><span class="dot"></span>Pilotage 2027</div>
  </div>
  <div class="ni" id="nav-dettes" onclick="location.href='dettes.html'"><span>üè¶</span><span>Dettes &amp; Emprunts</span></div>
  <div class="ns">Mon espace</div>
  <div class="ni" onclick="location.href='compte.html'"><span>üë§</span><span>Mon compte</span></div>
  <div class="nav-footer">
    <div class="ucard" onclick="location.href='profil.html'" style="cursor:pointer;transition:.15s" title="Mon compte">
      <div class="uav" id="av">A</div>
      <div><div class="un" id="uname">Utilisateur</div><div class="upl">Plan gratuit</div></div>
      <button class="lbtn" onclick="doLogout()">‚éã</button>
    </div>
  </div>
</nav>

<main>
  <div class="topbar">
    <div>
      <h1>Panier moyen <span class="badge">HT</span></h1>
      <p>S√©lectionnez un mois ¬∑ Saisissez vos donn√©es ¬∑ Les calculs sont automatiques</p>
    </div>
    <div class="tb-right">
      <div class="yr-bar" id="yrBar"></div>
      <button class="btn btn-p" onclick="saveData()">üíæ Sauvegarder</button>
    </div>
  </div>

  <div class="page">

    <!-- S√âLECTEUR DE MOIS -->
    <div>
      <div style="font-size:12px;font-weight:700;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px">üìÖ Choisissez le mois √† saisir</div>
      <div class="month-strip" id="monthStrip"></div>
    </div>

    <!-- ZONE DE SAISIE -->
    <div class="saisie">
      <div class="saisie-head">
        <div class="saisie-title">‚úèÔ∏è Donn√©es du mois <span class="badge">HT</span></div>
        <div class="saisie-month" id="selectedMonthLabel">Janvier 2026</div>
      </div>
      <div class="saisie-body">
        <div class="fields-grid">
          <div class="field">
            <div class="field-lbl"><span class="field-icon">üë•</span> Nombre de clients</div>
            <div class="field-wrap">
              <input class="field-input" id="f-cli" type="number" placeholder="ex: 45" oninput="onInput()" onchange="onInput()"/>
              <span class="field-unit">clients</span>
            </div>
          </div>
          <div class="field">
            <div class="field-lbl"><span class="field-icon">üí∂</span> Chiffre d'affaires HT</div>
            <div class="field-wrap">
              <input class="field-input" id="f-ca" type="number" placeholder="ex: 4500" oninput="onInput()" onchange="onInput()"/>
              <span class="field-unit">‚Ç¨ HT</span>
            </div>
          </div>
          <div class="field">
            <div class="field-lbl"><span class="field-icon">üîÑ</span> Nombre de ventes</div>
            <div class="field-wrap">
              <input class="field-input" id="f-txn" type="number" placeholder="ex: 60" oninput="onInput()" onchange="onInput()"/>
              <span class="field-unit">transactions</span>
            </div>
          </div>
        </div>
        <!-- R√âSULTATS AUTO -->
        <div class="results-row">
          <div class="res-box highlight">
            <div class="res-label">üõí Panier/vente HT</div>
            <div class="res-val green" id="r-pv">‚Äî</div>
            <div class="res-hint">CA √∑ nb ventes</div>
          </div>
          <div class="res-box highlight">
            <div class="res-label">üë§ Panier/client HT</div>
            <div class="res-val green" id="r-pc">‚Äî</div>
            <div class="res-hint">CA √∑ nb clients</div>
          </div>
          <div class="res-box">
            <div class="res-label">üîÅ Ventes/client</div>
            <div class="res-val blue" id="r-vc">‚Äî</div>
            <div class="res-hint">nb ventes √∑ nb clients</div>
          </div>
          <div class="res-box">
            <div class="res-label">üìà √âvol. panier/vente</div>
            <div class="res-val" id="r-evo">‚Äî</div>
            <div class="res-hint">vs mois pr√©c√©dent</div>
          </div>
        </div>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpi-row">
      <div class="kpi blue"><div class="kpi-ico">üõí</div><div class="kpi-lbl">Panier moy./vente HT</div><div class="kpi-val" id="k-pv">‚Äî</div><div class="kpi-sub">Moy. annuelle</div><div class="kpi-trend" id="k-pv-t"></div></div>
      <div class="kpi green"><div class="kpi-ico">üë§</div><div class="kpi-lbl">Panier moy./client HT</div><div class="kpi-val" id="k-pc">‚Äî</div><div class="kpi-sub">Moy. annuelle</div><div class="kpi-trend" id="k-pc-t"></div></div>
      <div class="kpi"><div class="kpi-ico">üí∂</div><div class="kpi-lbl">CA total HT (ann√©e)</div><div class="kpi-val" id="k-ca">‚Äî</div><div class="kpi-sub">Cumul annuel</div></div>
      <div class="kpi orange"><div class="kpi-ico">üîÑ</div><div class="kpi-lbl">Ventes / mois (moy.)</div><div class="kpi-val" id="k-txn">‚Äî</div><div class="kpi-sub">Moy. mensuelle</div></div>
      <div class="kpi purple"><div class="kpi-ico">üë•</div><div class="kpi-lbl">Clients / mois (moy.)</div><div class="kpi-val" id="k-cli">‚Äî</div><div class="kpi-sub">Moy. mensuelle</div></div>
    </div>

    <!-- GRAPHIQUES -->
    <div class="g2">
      <div class="card"><div class="card-t">üìà √âvolution panier moyen HT<span class="card-s">par vente et par client</span></div><div style="height:190px"><canvas id="cEvol"></canvas></div></div>
      <div class="card"><div class="card-t">üç© CA par cat√©gorie HT</div><div style="height:190px"><canvas id="cCat"></canvas></div></div>
    </div>
    <div class="g3">
      <div class="card"><div class="card-t">üë• Clients / mois</div><div style="height:130px"><canvas id="cCli"></canvas></div></div>
      <div class="card"><div class="card-t">üîÑ Transactions / mois</div><div style="height:130px"><canvas id="cTxn"></canvas></div></div>
      <div class="card"><div class="card-t">üí∂ CA mensuel HT</div><div style="height:130px"><canvas id="cCA"></canvas></div></div>
    </div>

    <!-- CAT√âGORIES -->
    <div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div>
          <div style="font-size:14px;font-weight:700">üì¶ Panier par cat√©gorie <span class="badge">HT</span></div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">Comparez vos cat√©gories de produits ou services</div>
        </div>
        <button class="btn btn-o btn-xs" onclick="addCat()">+ Ajouter</button>
      </div>
      <div class="cats" id="catsGrid"></div>
    </div>

    <!-- SIMULATEUR -->
    <div class="sim">
      <div class="sim-h">
        <div class="sim-ht">üîÆ Simulateur d'impact CA <span style="font-size:11px;opacity:.6;font-weight:400">‚Äî HT</span></div>
        <button class="btn btn-xs" style="background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.25)" onclick="resetSim()">‚Ü∫ R√©initialiser</button>
      </div>
      <div class="sim-b">
        <div class="sim-g">
          <div class="sim-lev"><div class="sim-ll">üõí Panier/vente HT</div><div class="sim-fw"><input class="sim-fi" id="s-pv" type="number" placeholder="0" oninput="calcSim()" onchange="calcSim()"/><span class="sim-fu">‚Ç¨</span></div></div>
          <div class="sim-lev"><div class="sim-ll">üîÑ Nb ventes / mois</div><div class="sim-fw"><input class="sim-fi" id="s-txn" type="number" placeholder="0" oninput="calcSim()" onchange="calcSim()"/><span class="sim-fu">ventes</span></div></div>
          <div class="sim-lev"><div class="sim-ll">üë• Nb clients / mois</div><div class="sim-fw"><input class="sim-fi" id="s-cli" type="number" placeholder="0" oninput="calcSim()" onchange="calcSim()"/><span class="sim-fu">clients</span></div></div>
          <div class="sim-lev"><div class="sim-ll">üìÖ P√©riode</div><div class="sim-fw"><input class="sim-fi" id="s-mois" type="number" value="12" oninput="calcSim()" onchange="calcSim()"/><span class="sim-fu">mois</span></div></div>
        </div>
        <div class="sim-res">
          <div class="sim-rt">üìä R√©sultat simul√© vs situation actuelle ‚Äî HT</div>
          <div class="sim-rg">
            <div class="sim-ri"><div class="sim-rl">Panier/vente HT</div><div class="sim-rc" id="sr-pv-c">‚Äî</div><div class="sim-rn" id="sr-pv-n">‚Äî</div><div class="sim-rd" id="sr-pv-d"></div></div>
            <div class="sim-ri"><div class="sim-rl">CA mensuel HT</div><div class="sim-rc" id="sr-cam-c">‚Äî</div><div class="sim-rn" id="sr-cam-n">‚Äî</div><div class="sim-rd" id="sr-cam-d"></div></div>
            <div class="sim-ri"><div class="sim-rl">CA annuel HT</div><div class="sim-rc" id="sr-caa-c">‚Äî</div><div class="sim-rn" id="sr-caa-n">‚Äî</div><div class="sim-rd" id="sr-caa-d"></div></div>
            <div class="sim-ri"><div class="sim-rl">Panier/client HT</div><div class="sim-rc" id="sr-pc-c">‚Äî</div><div class="sim-rn" id="sr-pc-n">‚Äî</div><div class="sim-rd" id="sr-pc-d"></div></div>
            <div class="sim-ri"><div class="sim-rl">Ventes/client</div><div class="sim-rc" id="sr-vc-c">‚Äî</div><div class="sim-rn" id="sr-vc-n">‚Äî</div><div class="sim-rd" id="sr-vc-d"></div></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</main>

<div class="toast" id="toast"></div>

<script>
const MN=['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
const COLORS=['#4f7ef8','#10b981','#f59e0b','#ef4444','#6366f1','#14b8a6','#ec4899','#8b5cf6'];
let _yr=new Date().getFullYear(), _mi=new Date().getMonth(), _charts={};

// ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ
function lk(y){return'altiora_pm_'+y}
function ck(y){return'altiora_pm_cats_'+y}
function loadM(y){try{const d=localStorage.getItem(lk(y));if(d)return JSON.parse(d)}catch(e){}return Array(12).fill(null).map(()=>({cli:'',ca:'',txn:''}))}
function saveM(y,d){localStorage.setItem(lk(y),JSON.stringify(d))}
function loadC(y){try{const d=localStorage.getItem(ck(y));if(d)return JSON.parse(d)}catch(e){}return[]}
function saveC(y,d){localStorage.setItem(ck(y),JSON.stringify(d))}

let months=loadM(_yr), cats=loadC(_yr);

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function fe(n){return(parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨'}
function fi(n){return Math.round(parseFloat(n)||0).toLocaleString('fr-FR')}
function set(id,v){const e=document.getElementById(id);if(e)e.textContent=v}
function setC(id,cls){const e=document.getElementById(id);if(e)e.className=cls}
function calc(m){const c=parseFloat(m.cli)||0,a=parseFloat(m.ca)||0,t=parseFloat(m.txn)||0;return{c,a,t,pv:t>0?a/t:0,pc:c>0?a/c:0,vc:c>0?t/c:0}}
function toggleSub(){document.getElementById('ksub').classList.toggle('open')}
function togglePil(el){document.getElementById('psub').classList.toggle('open');el.classList.toggle('on')}
async function doLogout(){try{if(window._signOut&&window._auth)await window._signOut(window._auth)}catch(e){}location.href='index.html'}

// ‚îÄ‚îÄ YEAR BAR ‚îÄ‚îÄ
function buildYr(){
  document.getElementById('yrBar').innerHTML=[2024,2025,2026,2027].map(y=>
    `<button class="yr ${y===_yr?'on':''}" onclick="switchYr(${y})">${y}</button>`).join('');
}
function switchYr(y){saveM(_yr,months);saveC(_yr,cats);_yr=y;months=loadM(y);cats=loadC(y);buildYr();buildStrip();renderAll()}

// ‚îÄ‚îÄ MONTH STRIP ‚îÄ‚îÄ
function buildStrip(){
  document.getElementById('monthStrip').innerHTML=MN.map((m,i)=>{
    const d=months[i];const hasData=d&&(d.cli||d.ca||d.txn);
    return`<button class="mbtn ${i===_mi?'on':''} ${hasData?'has-data':''}" onclick="selMonth(${i})">${m.slice(0,3)}</button>`;
  }).join('');
  document.getElementById('selectedMonthLabel').textContent=MN[_mi]+' '+_yr;
}
function selMonth(i){_mi=i;buildStrip();fillForm()}

// ‚îÄ‚îÄ FORM ‚îÄ‚îÄ
function fillForm(){
  const m=months[_mi];
  document.getElementById('f-cli').value=m.cli||'';
  document.getElementById('f-ca').value=m.ca||'';
  document.getElementById('f-txn').value=m.txn||'';
  updateResults();
}

function onInput(){
  months[_mi].cli=document.getElementById('f-cli').value;
  months[_mi].ca=document.getElementById('f-ca').value;
  months[_mi].txn=document.getElementById('f-txn').value;
  updateResults();
  buildStrip();
  renderKPIs();
  renderCharts();
  prefillSim();
}

function updateResults(){
  const m=months[_mi];
  const c=calc(m);
  // Panier/vente
  set('r-pv', c.pv>0?fe(c.pv):'‚Äî');
  set('r-pc', c.pc>0?fe(c.pc):'‚Äî');
  set('r-vc', c.vc>0?c.vc.toFixed(2):'‚Äî');
  // √âvolution vs mois pr√©c√©dent
  const prev=months[_mi>0?_mi-1:0];
  const cp=calc(prev);
  const rEvo=document.getElementById('r-evo');
  if(_mi>0&&cp.pv>0&&c.pv>0){
    const d=(c.pv-cp.pv)/cp.pv*100;
    rEvo.textContent=(d>=0?'‚ñ≤ +':'‚ñº ')+Math.abs(d).toFixed(1)+'%';
    rEvo.className='res-val '+(d>=0?'green':'down');
  } else { rEvo.textContent='‚Äî'; rEvo.className='res-val'; }
}

// ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ
function getStats(){
  const active=months.map((m,i)=>({...calc(m),i})).filter(m=>m.a>0||m.c>0||m.t>0);
  if(!active.length)return null;
  const caT=active.reduce((s,m)=>s+m.a,0),txnT=active.reduce((s,m)=>s+m.t,0),cliT=active.reduce((s,m)=>s+m.c,0),n=active.length;
  return{pv:txnT>0?caT/txnT:0,pc:cliT>0?caT/cliT:0,caTotal:caT,txnAvg:txnT/n,cliAvg:cliT/n,active};
}

function renderKPIs(){
  const s=getStats();
  if(!s){['k-pv','k-pc','k-ca','k-txn','k-cli'].forEach(id=>set(id,'‚Äî'));return}
  set('k-pv',fe(s.pv)); set('k-pc',fe(s.pc)); set('k-ca',fe(s.caTotal));
  set('k-txn',fi(s.txnAvg)); set('k-cli',fi(s.cliAvg));
  const a=s.active;
  if(a.length>=2){
    const l=a[a.length-1],p=a[a.length-2];
    if(p.pv>0){const d=(l.pv-p.pv)/p.pv*100;document.getElementById('k-pv-t').innerHTML=`<span class="${d>=0?'up':'down'}">${d>=0?'‚ñ≤':'‚ñº'} ${Math.abs(d).toFixed(1)}%</span>`}
    if(p.pc>0){const d=(l.pc-p.pc)/p.pc*100;document.getElementById('k-pc-t').innerHTML=`<span class="${d>=0?'up':'down'}">${d>=0?'‚ñ≤':'‚ñº'} ${Math.abs(d).toFixed(1)}%</span>`}
  }
}

// ‚îÄ‚îÄ CHARTS ‚îÄ‚îÄ
function dc(id){if(_charts[id]){try{_charts[id].destroy()}catch(e){}delete _charts[id]}}
function renderCharts(){
  const pvD=months.map(m=>calc(m).pv||null);
  const pcD=months.map(m=>calc(m).pc||null);
  const cliD=months.map(m=>parseFloat(m.cli)||null);
  const txnD=months.map(m=>parseFloat(m.txn)||null);
  const caD=months.map(m=>parseFloat(m.ca)||null);

  dc('cEvol');const e=document.getElementById('cEvol');if(e)_charts.cEvol=new Chart(e,{type:'line',data:{labels:MN,datasets:[
    {label:'Panier/vente HT',data:pvD,borderColor:'#4f7ef8',backgroundColor:'#4f7ef822',tension:.4,fill:true,pointRadius:4,borderWidth:2.5,spanGaps:true},
    {label:'Panier/client HT',data:pcD,borderColor:'#10b981',backgroundColor:'#10b98122',tension:.4,fill:true,pointRadius:4,borderWidth:2.5,spanGaps:true},
  ]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{position:'bottom',labels:{font:{size:11},boxWidth:11}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v+'‚Ç¨'}}}}});

  dc('cCat');const cat=document.getElementById('cCat');if(cat){
    const cd=cats.map(c=>parseFloat(c.ca)||0).filter(v=>v>0);
    const cl=cats.filter(c=>parseFloat(c.ca)>0).map(c=>c.nom||'Sans nom');
    _charts.cCat=new Chart(cat,{type:'doughnut',data:{labels:cd.length?cl:['Aucune cat√©gorie'],datasets:[{data:cd.length?cd:[1],backgroundColor:cd.length?COLORS.slice(0,cd.length):['#e2e8f0'],borderWidth:2,borderColor:'#fff',hoverOffset:5}]},options:{responsive:true,maintainAspectRatio:false,cutout:'55%',plugins:{legend:{position:'bottom',labels:{font:{size:11},boxWidth:10}}}}});
  }

  function bar(id,data,color){dc(id);const el=document.getElementById(id);if(el)_charts[id]=new Chart(el,{type:'bar',data:{labels:MN,datasets:[{data,backgroundColor:color+'bb',borderRadius:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}})}
  bar('cCli',cliD,'#6366f1'); bar('cTxn',txnD,'#f59e0b');
  dc('cCA');const ca=document.getElementById('cCA');if(ca)_charts.cCA=new Chart(ca,{type:'line',data:{labels:MN,datasets:[{data:caD,borderColor:'#4f7ef8',backgroundColor:'#4f7ef822',fill:true,tension:.4,pointRadius:3,borderWidth:2,spanGaps:true}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v+'‚Ç¨'}}}}});
}

// ‚îÄ‚îÄ CAT√âGORIES ‚îÄ‚îÄ
function renderCats(){
  const grid=document.getElementById('catsGrid');
  grid.innerHTML=cats.map((c,i)=>{
    const a=parseFloat(c.ca)||0,t=parseFloat(c.txn)||0,cl=parseFloat(c.cli)||0;
    const pv=t>0?fe(a/t):'‚Äî',pc=cl>0?fe(a/cl):'‚Äî',vc=cl>0?(t/cl).toFixed(2):'‚Äî';
    return`<div class="cat" style="border-top:3px solid ${COLORS[i%8]}">
      <div class="cat-top"><div class="cat-bar" style="background:${COLORS[i%8]}"></div>
        <input class="cat-name" value="${c.nom||''}" placeholder="Nom cat√©gorie..." oninput="updCat(${i},'nom',this.value)"/>
        <button class="btn btn-d btn-xs" onclick="delCat(${i})">‚úï</button></div>
      <div class="cat-body">
        <div class="cat-row"><span>CA mensuel HT</span><input class="cat-in" type="number" placeholder="0" value="${c.ca||''}" oninput="updCat(${i},'ca',this.value)" onchange="updCat(${i},'ca',this.value)"/> <span class="cat-r" style="font-size:10px;color:var(--muted)">‚Ç¨</span></div>
        <div class="cat-row"><span>Nb ventes/mois</span><input class="cat-in" type="number" placeholder="0" value="${c.txn||''}" oninput="updCat(${i},'txn',this.value)" onchange="updCat(${i},'txn',this.value)"/></div>
        <div class="cat-row"><span>Nb clients/mois</span><input class="cat-in" type="number" placeholder="0" value="${c.cli||''}" oninput="updCat(${i},'cli',this.value)" onchange="updCat(${i},'cli',this.value)"/></div>
        <div class="cat-div"></div>
        <div class="cat-row"><span>üõí Panier/vente HT</span><div class="cat-r blue">${pv}</div></div>
        <div class="cat-row"><span>üë§ Panier/client HT</span><div class="cat-r green">${pc}</div></div>
        <div class="cat-row"><span>üîÅ Ventes/client</span><div class="cat-r">${vc}</div></div>
      </div></div>`;
  }).join('')+`<div class="add-cat" onclick="addCat()"><span style="font-size:18px">+</span> Nouvelle cat√©gorie</div>`;
}
function addCat(){cats.push({nom:'',ca:'',txn:'',cli:''});renderCats();renderCharts()}
function delCat(i){cats.splice(i,1);renderCats();renderCharts()}
function updCat(i,f,v){cats[i][f]=v;renderCats();renderCharts()}

// ‚îÄ‚îÄ SIMULATEUR ‚îÄ‚îÄ
function prefillSim(){
  const s=getStats();if(!s)return;
  document.getElementById('s-pv').placeholder=s.pv.toFixed(2);
  document.getElementById('s-txn').placeholder=Math.round(s.txnAvg);
  document.getElementById('s-cli').placeholder=Math.round(s.cliAvg);
  const cam=s.pv*s.txnAvg;
  set('sr-pv-c',s.pv>0?fe(s.pv):'‚Äî'); set('sr-cam-c',cam>0?fe(cam):'‚Äî');
  set('sr-caa-c',fe(s.caTotal)); set('sr-pc-c',s.pc>0?fe(s.pc):'‚Äî');
  const vc=s.cliAvg>0?s.txnAvg/s.cliAvg:0; set('sr-vc-c',vc>0?vc.toFixed(2):'‚Äî');
}
function calcSim(){
  const s=getStats();
  const pv=parseFloat(document.getElementById('s-pv').value)||(s?s.pv:0);
  const txn=parseFloat(document.getElementById('s-txn').value)||(s?s.txnAvg:0);
  const cli=parseFloat(document.getElementById('s-cli').value)||(s?s.cliAvg:0);
  const mois=parseFloat(document.getElementById('s-mois').value)||12;
  const camS=pv*txn, caaS=camS*mois, pcS=cli>0?camS/cli:0, vcS=cli>0?txn/cli:0;
  const camC=s?s.pv*s.txnAvg:0;
  function rr(nId,dId,nv,cv,isE=true){
    const d=nv-cv,pos=d>=0,fmt=isE?fe:(v=>v.toFixed(2));
    const en=document.getElementById(nId);if(en){en.textContent=fmt(nv);en.className='sim-rn '+(nv<0?'neg':pos?'pos':'')}
    const ed=document.getElementById(dId);if(ed){ed.textContent=(pos?'+':'')+fmt(d);ed.className='sim-rd '+(pos?'pos':'neg')}
  }
  rr('sr-pv-n','sr-pv-d',pv,s?s.pv:0);
  rr('sr-cam-n','sr-cam-d',camS,camC);
  rr('sr-caa-n','sr-caa-d',caaS,s?s.caTotal:0);
  rr('sr-pc-n','sr-pc-d',pcS,s?s.pc:0);
  rr('sr-vc-n','sr-vc-d',vcS,s&&s.cliAvg>0?s.txnAvg/s.cliAvg:0,false);
}
function resetSim(){['s-pv','s-txn','s-cli'].forEach(id=>document.getElementById(id).value='');document.getElementById('s-mois').value='12';calcSim()}

// ‚îÄ‚îÄ SAVE ‚îÄ‚îÄ
function saveData(){
  saveM(_yr,months);saveC(_yr,cats);
  if(window._uid&&window._setDoc)window._setDoc(window._doc(window._db,'panier',window._uid,'data','all'),{[`y${_yr}`]:{months,cats}},{merge:true}).catch(()=>{});
  showToast('‚úÖ Sauvegard√© !','ok');
}
function showToast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'');setTimeout(()=>t.className='toast',3000)}

function renderAll(){buildStrip();fillForm();renderKPIs();renderCharts();renderCats();prefillSim()}
async function tryFirebase(){
  if(!window._uid||!window._getDoc)return;
  try{
    const snap=await window._getDoc(window._doc(window._db,'panier',window._uid,'data','all'));
    if(snap.exists()){const d=snap.data()[`y${_yr}`];if(d&&d.months){months=d.months;if(d.cats)cats=d.cats;renderAll()}}
    const u=window._auth?.currentUser;if(u){const n=u.displayName||u.email?.split('@')[0]||'';document.getElementById('uname').textContent=n;document.getElementById('av').textContent=n[0]?.toUpperCase()||'A'}
  }catch(e){}
}

// ‚îÄ‚îÄ START IMM√âDIAT ‚îÄ‚îÄ
buildYr(); renderAll();
setTimeout(tryFirebase,500);
</script>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import{getFirestore,doc,setDoc,getDoc}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
const app=initializeApp({apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",storageBucket:"altiora-70599.firebasestorage.app",messagingSenderId:"120905555746",appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"});
const auth=getAuth(app),db=getFirestore(app);
window._auth=auth;window._db=db;window._doc=doc;window._setDoc=setDoc;window._getDoc=getDoc;window._signOut=signOut;
onAuthStateChanged(auth,user=>{if(!user){location.href='index.html';return}window._uid=user.uid;tryFirebase()});
</script>

<script>
function toggleNav(subId, el) {
  const sub = document.getElementById(subId);
  const isOpen = sub.classList.contains('open');
  sub.classList.toggle('open');
  // rotate chevron
  const chevId = subId === 'kpis-sub' ? 'chev-kpis' : 'chev-pil';
  const chev = document.getElementById(chevId);
  if (chev) chev.style.transform = isOpen ? '' : 'rotate(90deg)';
}
function activatePage(pageId, openSub) {
  const el = document.getElementById(pageId);
  if (el) el.classList.add('on');
  if (openSub) {
    const sub = document.getElementById(openSub);
    if (sub) sub.classList.add('open');
    const chevId = openSub === 'kpis-sub' ? 'chev-kpis' : 'chev-pil';
    const chev = document.getElementById(chevId);
    if (chev) chev.style.transform = 'rotate(90deg)';
  }
}
</script>
<script>document.addEventListener('DOMContentLoaded',()=>activatePage('nav-panier','kpis-sub'));</script>
</body>
</html>
