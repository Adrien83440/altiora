<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE ‚Äî Entretiens annuels</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --rh-dark:#052e16;--rh-main:#059669;--rh-mid:#10b981;--rh-bright:#34d399;
      --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f0fdf7;--radius:12px;
      --red:#ef4444;--red-light:#fee2e2;--orange:#f59e0b;--orange-light:#fef3c7;
      --blue:#1a3dce;--purple:#6366f1;--sidebar-w:250px;
      --star:#f59e0b;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-width:0;}

    /* TOPBAR */
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar h1{font-size:17px;font-weight:700;}
    .topbar p{font-size:12px;color:var(--muted);}
    .topbar-right{display:flex;align-items:center;gap:10px;}
    .btn{padding:8px 16px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;}
    .btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-mid));color:white;box-shadow:0 3px 10px rgba(5,150,105,.25);}
    .btn-rh:hover{opacity:.9;transform:translateY(-1px);}
    .btn-outline{background:white;color:var(--rh-main);border:1.5px solid var(--rh-border);}
    .btn-outline:hover{background:var(--rh-ghost);}
    .btn-danger{background:#fef2f2;color:var(--red);border:1px solid #fecaca;}
    .btn-sm{padding:5px 12px;font-size:12px;}
    .btn-xs{padding:3px 8px;font-size:11px;}

    /* LAYOUT */
    .content{display:flex;flex:1;overflow:hidden;height:calc(100vh - 57px);}

    /* LEFT PANEL */
    .left-panel{width:300px;flex-shrink:0;border-right:1px solid var(--border);background:white;display:flex;flex-direction:column;overflow:hidden;}
    .lp-head{padding:14px;}
    .search-wrap{display:flex;gap:6px;margin-bottom:8px;}
    .search-input{flex:1;padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;outline:none;color:var(--text);}
    .search-input:focus{border-color:var(--rh-main);}
    .filter-row{display:flex;gap:6px;}
    .filter-sel{flex:1;padding:5px 8px;border:1.5px solid var(--border);border-radius:7px;font-family:'Plus Jakarta Sans',sans-serif;font-size:11px;color:var(--text);outline:none;background:white;cursor:pointer;}
    .emp-list{flex:1;overflow-y:auto;padding:0 8px 8px;}
    .emp-item{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:10px;cursor:pointer;border:1.5px solid transparent;margin-bottom:4px;transition:all .15s;}
    .emp-item:hover{background:#f8fffe;}
    .emp-item.active{background:var(--rh-ghost);border-color:var(--rh-border);}
    .emp-avatar{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:white;flex-shrink:0;}
    .emp-info{flex:1;min-width:0;}
    .emp-name{font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .emp-sub{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .emp-badge-mini{font-size:10px;font-weight:700;padding:2px 6px;border-radius:20px;white-space:nowrap;flex-shrink:0;}
    .b-ok{background:#d1fae5;color:#065f46;}
    .b-todo{background:#fef3c7;color:#92400e;}
    .b-none{background:#f1f5f9;color:var(--muted);}
    .lp-stats{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:12px;}
    .lp-stat{flex:1;text-align:center;}
    .lp-stat-val{font-size:16px;font-weight:800;color:var(--rh-main);}
    .lp-stat-lbl{font-size:10px;color:var(--muted);}

    /* RIGHT PANEL */
    .right-panel{flex:1;overflow-y:auto;background:var(--bg);padding:20px 24px;display:flex;flex-direction:column;gap:16px;}

    /* EMPTY STATE */
    .empty-state{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:500px;text-align:center;color:var(--muted);}
    .empty-icon{font-size:52px;margin-bottom:14px;}

    /* SECTIONS */
    .section{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .sec-head{display:flex;align-items:center;justify-content:space-between;padding:13px 18px;background:#fafffe;border-bottom:1px solid var(--border);}
    .sec-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px;}
    .sec-body{padding:16px 18px;}

    /* EMP HERO */
    .emp-hero{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:18px 22px;display:flex;align-items:center;gap:16px;}
    .hero-avatar{width:52px;height:52px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;color:white;flex-shrink:0;}
    .hero-name{font-size:20px;font-weight:800;}
    .hero-sub{font-size:13px;color:var(--muted);margin-top:2px;}
    .hero-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-left:auto;}
    .hkpi{padding:10px 14px;border-radius:9px;background:var(--rh-ghost);border:1px solid var(--rh-border);text-align:center;}
    .hkpi-val{font-size:17px;font-weight:800;color:var(--rh-main);}
    .hkpi-lbl{font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;margin-top:2px;}

    /* HISTORY LIST */
    .hist-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border:1.5px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:all .15s;}
    .hist-item:hover{border-color:var(--rh-border);background:var(--rh-ghost);}
    .hist-item.active{border-color:var(--rh-main);background:var(--rh-ghost);}
    .hist-year{font-size:14px;font-weight:800;color:var(--rh-main);min-width:40px;}
    .hist-date{font-size:11px;color:var(--muted);}
    .hist-note{display:flex;align-items:center;gap:3px;font-size:12px;font-weight:700;}
    .hist-status{font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;margin-left:auto;}
    .s-done{background:#d1fae5;color:#065f46;}
    .s-draft{background:#fef3c7;color:#92400e;}
    .hist-chevron{font-size:12px;color:var(--muted);}

    /* NOTATION √âTOILES */
    .stars-input{display:flex;gap:4px;cursor:pointer;}
    .star{font-size:22px;color:#e2e8f0;transition:color .1s;cursor:pointer;}
    .star.active{color:var(--star);}
    .star:hover{color:var(--star);}

    /* GRILLE OBJECTIFS */
    .obj-grid{display:flex;flex-direction:column;gap:10px;}
    .obj-row{display:grid;grid-template-columns:1fr 120px 80px 36px;gap:8px;align-items:center;}
    .obj-input{padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;outline:none;width:100%;}
    .obj-input:focus{border-color:var(--rh-main);}
    .obj-select{padding:7px 8px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;outline:none;background:white;cursor:pointer;}
    .obj-pct{padding:7px 8px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;outline:none;text-align:center;width:100%;}
    .btn-del-row{width:28px;height:28px;border:1px solid #fecaca;border-radius:7px;background:#fef2f2;color:var(--red);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;}
    .btn-add-row{padding:7px 14px;border:1.5px dashed var(--border);border-radius:8px;background:white;color:var(--muted);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;width:100%;margin-top:6px;}
    .btn-add-row:hover{border-color:var(--rh-main);color:var(--rh-main);background:var(--rh-ghost);}

    /* TEXTAREA */
    .rh-textarea{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;line-height:1.6;outline:none;resize:vertical;min-height:80px;color:var(--text);}
    .rh-textarea:focus{border-color:var(--rh-main);box-shadow:0 0 0 3px rgba(5,150,105,.08);}
    .rh-input{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;outline:none;color:var(--text);}
    .rh-input:focus{border-color:var(--rh-main);}
    .field-label{font-size:12px;font-weight:700;color:var(--text);margin-bottom:5px;display:block;}
    .field-hint{font-size:11px;color:var(--muted);margin-top:4px;}
    .field-wrap{margin-bottom:14px;}
    .form-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    .form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;}

    /* RATING SECTION */
    .rating-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .rating-item{padding:12px 14px;border:1.5px solid var(--border);border-radius:10px;background:#fafffe;}
    .rating-label{font-size:12px;font-weight:700;color:var(--text);margin-bottom:8px;display:flex;align-items:center;gap:6px;}
    .rating-label .emoji{font-size:16px;}

    /* PROGR√àS OBJECTIFS */
    .prog-bar-wrap{height:6px;background:#f1f5f9;border-radius:99px;overflow:hidden;margin-top:4px;}
    .prog-bar-fill{height:100%;border-radius:99px;transition:width .4s ease;}

    /* SCORE GLOBAL */
    .score-globe{background:linear-gradient(135deg,var(--rh-main),var(--rh-mid));color:white;border-radius:var(--radius);padding:20px 24px;display:flex;align-items:center;gap:20px;}
    .score-num{font-size:52px;font-weight:800;line-height:1;}
    .score-max{font-size:18px;opacity:.6;margin-top:8px;}
    .score-details{flex:1;}
    .score-label{font-size:13px;font-weight:600;opacity:.8;margin-bottom:6px;}
    .score-breakdown{display:flex;flex-direction:column;gap:5px;}
    .score-line{display:flex;align-items:center;gap:8px;font-size:12px;}
    .score-line-bar{flex:1;height:5px;background:rgba(255,255,255,.2);border-radius:99px;overflow:hidden;}
    .score-line-fill{height:100%;background:rgba(255,255,255,.8);border-radius:99px;}

    /* BADGES NOTE */
    .note-badge{display:inline-flex;align-items:center;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:700;}
    .note-5{background:#d1fae5;color:#065f46;}
    .note-4{background:#dcfce7;color:#166534;}
    .note-3{background:#fef3c7;color:#92400e;}
    .note-2{background:#fed7aa;color:#9a3412;}
    .note-1{background:#fee2e2;color:#991b1b;}

    /* TIMELINE HISTORIQUE */
    .timeline{position:relative;padding-left:20px;}
    .timeline::before{content:'';position:absolute;left:6px;top:6px;bottom:6px;width:2px;background:var(--rh-border);}
    .tl-item{position:relative;padding-bottom:20px;}
    .tl-dot{position:absolute;left:-20px;top:4px;width:12px;height:12px;border-radius:50%;background:var(--rh-main);border:2px solid white;box-shadow:0 0 0 2px var(--rh-border);}
    .tl-year{font-size:11px;font-weight:700;color:var(--rh-main);margin-bottom:4px;}
    .tl-card{background:#fafffe;border:1px solid var(--rh-border);border-radius:9px;padding:10px 12px;cursor:pointer;transition:all .15s;}
    .tl-card:hover{border-color:var(--rh-main);background:var(--rh-ghost);}

    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(15,31,92,.45);backdrop-filter:blur(4px);z-index:200;display:none;align-items:center;justify-content:center;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;width:100%;max-width:580px;max-height:90vh;box-shadow:0 24px 60px rgba(5,150,105,.2);overflow:hidden;display:flex;flex-direction:column;}
    .modal-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#f0fdf4,#dcfce7);flex-shrink:0;}
    .modal-body{padding:20px 22px;overflow-y:auto;}
    .modal-foot{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;flex-shrink:0;}
    .modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);}
    .minput{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;}
    .minput:focus{border-color:var(--rh-main);}

    /* SAVE BAR */
    .save-bar{position:sticky;bottom:0;background:white;border-top:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;z-index:20;box-shadow:0 -4px 20px rgba(0,0,0,.06);}
    .save-status{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:6px;}
    .save-dot{width:8px;height:8px;border-radius:50%;background:#e2e8f0;}
    .save-dot.saving{background:var(--orange);animation:pulse .8s infinite;}
    .save-dot.saved{background:var(--rh-main);}

    /* TABS ENTRETIEN */
    .etab-bar{display:flex;gap:4px;background:#f8faff;border:1px solid var(--border);border-radius:10px;padding:4px;margin-bottom:16px;}
    .etab{padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;transition:all .15s;color:var(--muted);white-space:nowrap;}
    .etab.active{background:white;color:var(--rh-main);box-shadow:0 1px 4px rgba(0,0,0,.1);}
    .etab-panel{display:none;}
    .etab-panel.active{display:block;}

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#1a1f36;color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.success{background:var(--rh-main);}
    .toast.warning{background:var(--orange);}

    /* PRINT */
    @media print{
      .sidebar,.topbar,.save-bar,.btn,.topbar-right{display:none!important;}
      .main{margin-left:0!important;}
      .right-panel{overflow:visible;padding:10px;}
      .content{height:auto;overflow:visible;}
    }

    /* RESPONSIVE */
    html,body{overflow-x:hidden;}
    .hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:#052e16;border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(5,46,22,.45);}
    .hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s ease;}
    .nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;}
    .nav-overlay.show{display:block;}
    @media(max-width:768px){
      .hamburger{display:flex!important;}
      nav,aside.sidebar,.sidebar{position:fixed!important;top:0!important;left:0!important;height:100vh!important;width:min(280px,84vw)!important;z-index:1001!important;transform:translateX(-105%)!important;transition:transform .3s cubic-bezier(.4,0,.2,1)!important;overflow-y:auto!important;}
      nav.open,aside.sidebar.open,.sidebar.open{transform:translateX(0)!important;box-shadow:8px 0 32px rgba(0,0,0,.3)!important;}
      .main,.main-content{margin-left:0!important;width:100vw!important;}
      .topbar{padding:10px 10px 10px 62px!important;flex-wrap:wrap;}
      .content{flex-direction:column;height:auto;overflow:auto;}
      .left-panel{width:100%!important;height:auto!important;max-height:240px;border-right:none;border-bottom:1px solid var(--border);}
      .right-panel{padding:14px 12px;}
      .hero-kpis{grid-template-columns:1fr 1fr;margin-left:0;margin-top:12px;width:100%;}
      .emp-hero{flex-direction:column;align-items:flex-start;}
      .form-grid-2,.form-grid-3{grid-template-columns:1fr;}
      .rating-grid{grid-template-columns:1fr;}
      .obj-row{grid-template-columns:1fr 90px 70px 36px;}
      .score-globe{flex-direction:column;text-align:center;}
    }
  </style>
</head>
<body>

<button class="hamburger" id="hamburger" onclick="toggleSidebar()">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="nav-overlay" onclick="closeSidebar()"></div>

<!-- SIDEBAR inject√©e par nav.js -->

<div class="main">
  <!-- TOPBAR -->
  <div class="topbar">
    <div>
      <h1>üéØ Entretiens annuels</h1>
      <p>Suivi des evaluations, objectifs et developpement des collaborateurs</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="window.location.href='rh-employes.html'">üë• Employes</button>
      <button class="btn btn-rh btn-sm" onclick="openNewEntretien()">+ Nouvel entretien</button>
    </div>
  </div>

  <div class="content">
    <!-- LEFT PANEL : Liste des employ√©s -->
    <div class="left-panel">
      <div class="lp-head">
        <div class="search-wrap">
          <input class="search-input" id="emp-search" placeholder="üîç Chercher un employe..." oninput="filterEmps(this.value)"/>
        </div>
        <div class="filter-row">
          <select class="filter-sel" id="f-dept" onchange="filterEmps()">
            <option value="">Tous les services</option>
          </select>
          <select class="filter-sel" id="f-status" onchange="filterEmps()">
            <option value="">Tous</option>
            <option value="done">Fait cette annee</option>
            <option value="todo">A faire</option>
          </select>
        </div>
      </div>
      <div class="emp-list" id="emp-list">
        <div style="padding:30px;text-align:center;color:var(--muted)"><div style="font-size:24px;margin-bottom:6px">‚è≥</div>Chargement...</div>
      </div>
      <div class="lp-stats">
        <div class="lp-stat"><div class="lp-stat-val" id="stat-total">‚Äî</div><div class="lp-stat-lbl">Employ√©s</div></div>
        <div class="lp-stat"><div class="lp-stat-val" id="stat-done">‚Äî</div><div class="lp-stat-lbl">R√©alis√©s</div></div>
        <div class="lp-stat"><div class="lp-stat-val" id="stat-todo">‚Äî</div><div class="lp-stat-lbl">A faire</div></div>
        <div class="lp-stat"><div class="lp-stat-val" id="stat-moy">‚Äî</div><div class="lp-stat-lbl">Note moy.</div></div>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel" id="right-panel">
      <div class="empty-state">
        <div class="empty-icon">üéØ</div>
        <h3 style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px">Entretiens annuels</h3>
        <p style="font-size:13px;line-height:1.7;max-width:340px">Selectionnez un collaborateur pour voir son historique d'entretiens, consulter ses evaluations et saisir un nouvel entretien annuel.</p>
        <button class="btn btn-rh" style="margin-top:16px" onclick="openNewEntretien()">+ D√©marrer un entretien</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL NOUVEL ENTRETIEN -->
<div class="modal-overlay" id="modal-new">
  <div class="modal">
    <div class="modal-head">
      <h3>üéØ Nouvel entretien annuel</h3>
      <button class="modal-close" onclick="closeModalNew()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="field-wrap">
        <label class="field-label">Collaborateur *</label>
        <select class="minput" id="new-emp-select">
          <option value="">-- Choisir un collaborateur --</option>
        </select>
      </div>
      <div class="form-grid-2">
        <div class="field-wrap">
          <label class="field-label">Date de l'entretien *</label>
          <input class="minput" type="date" id="new-date"/>
        </div>
        <div class="field-wrap">
          <label class="field-label">Annee evaluee</label>
          <select class="minput" id="new-annee"></select>
        </div>
      </div>
      <div class="field-wrap">
        <label class="field-label">Evaluateur / Manager</label>
        <input class="minput" id="new-evaluateur" placeholder="Nom du responsable qui conduit l'entretien"/>
      </div>
      <div class="field-wrap">
        <label class="field-label">Type d'entretien</label>
        <select class="minput" id="new-type">
          <option value="annuel">Entretien annuel d'evaluation</option>
          <option value="mi-annee">Entretien de mi-annee</option>
          <option value="professionnel">Entretien professionnel (bilan formation)</option>
          <option value="retour">Entretien de retour</option>
        </select>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModalNew()">Annuler</button>
      <button class="btn btn-rh" onclick="createEntretien()">Cr√©er et saisir ‚Üí</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- FIREBASE -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, initializeFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth=getAuth(app);
  // experimentalAutoDetectLongPolling : corrige l'erreur CORS sur Safari/WebKit
  const db=initializeFirestore(app,{experimentalAutoDetectLongPolling:true});
  window._auth=auth; window._db=db;
  window._doc=doc; window._setDoc=setDoc; window._getDoc=getDoc;
  window._collection=collection; window._getDocs=getDocs;
  window._deleteDoc=deleteDoc; window._updateDoc=updateDoc; window._addDoc=addDoc;
  window._signOut=signOut;
  onAuthStateChanged(auth,user=>{
    if(!user){window.location.href='index.html';return;}
    window._uid=user.uid;
    window._firebaseReady=true;
    window.initApp();
  });
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var _employes = {};       // { id: {...} }
var _currentEmpId = null;
var _currentEntId = null; // entretien en cours d'√©dition
var _entretiens = {};     // cache entretiens charg√©s par empId
var _saveTimer = null;
var _saveDirty = false;

var COLORS = ['#059669','#3b82f6','#8b5cf6','#f59e0b','#ef4444','#14b8a6','#6366f1','#ec4899'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.initApp = async function(){
  populateAnneeSelect();
  await loadEmployes();
  renderEmpList();
  renderStats();
  // Ouverture directe depuis fiche salari√© (?empId=xxx)
  var params = new URLSearchParams(window.location.search);
  var empIdFromUrl = params.get('empId');
  if(empIdFromUrl && _employes[empIdFromUrl]){
    openNewEntretienForEmp(empIdFromUrl);
  } else if(empIdFromUrl){
    // L'employ√© peut ne pas √™tre encore charg√© ‚Äî attendre un tick
    setTimeout(()=>{
      if(_employes[empIdFromUrl]) openNewEntretienForEmp(empIdFromUrl);
    }, 800);
  }
};

function populateAnneeSelect(){
  var s = document.getElementById('new-annee');
  var y = new Date().getFullYear();
  for(var i=0;i<5;i++){
    var o=document.createElement('option');
    o.value=y-i; o.textContent=y-i;
    if(i===1) o.selected=true; // ann√©e pr√©c√©dente par d√©faut
    s.appendChild(o);
  }
}

async function loadEmployes(){
  if(!window._uid)return;
  try{
    var snap = await window._getDocs(window._collection(window._db,'rh',window._uid,'employes'));
    _employes={};
    snap.forEach(d=>{ _employes[d.id]=Object.assign({id:d.id},d.data()); });
    // Remplir le select de la modal
    var sel=document.getElementById('new-emp-select');
    sel.innerHTML='<option value="">-- Choisir un collaborateur --</option>';
    Object.values(_employes).sort((a,b)=>((a.prenom||'')+(a.nom||'')).localeCompare((b.prenom||'')+(b.nom||'')))
      .forEach(e=>{
        var o=document.createElement('option');
        o.value=e.id;
        o.textContent=((e.prenom||'')+' '+(e.nom||'')).trim()+(e.poste?' ‚Äî '+e.poste:'');
        sel.appendChild(o);
      });
    // Remplir les filtres d√©partement
    var depts=[...new Set(Object.values(_employes).map(e=>e.departement).filter(Boolean))].sort();
    var fd=document.getElementById('f-dept');
    depts.forEach(d=>{var o=document.createElement('option');o.value=d;o.textContent=d;fd.appendChild(o);});
  }catch(e){console.error(e);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHARGER ENTRETIENS D'UN EMPLOYE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadEntretiensForEmp(empId){
  if(_entretiens[empId]) return _entretiens[empId]; // cache
  try{
    var snap = await window._getDocs(window._collection(window._db,'rh',window._uid,'entretiens_annuels',empId,'sessions'));
    var list=[];
    snap.forEach(d=>list.push(Object.assign({id:d.id},d.data())));
    list.sort((a,b)=>(b.annee||0)-(a.annee||0));
    _entretiens[empId]=list;
    return list;
  }catch(e){console.error(e);return [];}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER LISTE EMPLOY√âS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderEmpList(filter){
  var list=document.getElementById('emp-list');
  var search=(document.getElementById('emp-search')?.value||'').toLowerCase();
  var dept=document.getElementById('f-dept')?.value||'';
  var status=document.getElementById('f-status')?.value||'';
  var thisYear=new Date().getFullYear();

  var items=Object.values(_employes).filter(e=>{
    var nom=((e.prenom||'')+' '+(e.nom||'')).toLowerCase();
    if(search&&!nom.includes(search)&&!(e.poste||'').toLowerCase().includes(search))return false;
    if(dept&&e.departement!==dept)return false;
    return true;
  }).sort((a,b)=>((a.prenom||'')+(a.nom||'')).localeCompare((b.prenom||'')+(b.nom||'')));

  // Charger les entretiens pour avoir le statut
  var html='';
  for(var i=0;i<items.length;i++){
    var e=items[i];
    var ents=await loadEntretiensForEmp(e.id);
    var hasThisYear=ents.some(x=>x.annee==thisYear||(x.date||'').startsWith(thisYear));
    if(status==='done'&&!hasThisYear)continue;
    if(status==='todo'&&hasThisYear)continue;
    var lastEnt=ents[0];
    var lastNote=lastEnt?.noteGlobale;
    var idx=Object.values(_employes).indexOf(e);
    var color=COLORS[idx%COLORS.length];
    var init=((e.prenom||'?').charAt(0)+(e.nom||'').charAt(0)).toUpperCase();
    var badgeText=hasThisYear?'‚úì Fait':'√Ä faire';
    var badgeCls=hasThisYear?'b-ok':'b-todo';
    if(ents.length===0)badgeCls='b-none';
    var active=_currentEmpId===e.id?' active':'';
    html+=`<div class="emp-item${active}" onclick="openEmployee('${e.id}')">
      <div class="emp-avatar" style="background:${color}">${init}</div>
      <div class="emp-info">
        <div class="emp-name">${(e.prenom||'')+' '+(e.nom||'')}</div>
        <div class="emp-sub">${e.poste||'‚Äî'}${e.departement?' ¬∑ '+e.departement:''}</div>
      </div>
      <div>
        ${lastNote?`<div style="font-size:11px;font-weight:700;color:var(--rh-main);text-align:right">${lastNote}/5</div>`:''}
        <span class="emp-badge-mini ${badgeCls}">${badgeText}</span>
      </div>
    </div>`;
  }
  if(!html)html='<div style="padding:24px;text-align:center;color:var(--muted);font-size:12px">Aucun employ√© trouv√©</div>';
  list.innerHTML=html;
  renderStats();
}

function filterEmps(){renderEmpList();}

function renderStats(){
  var total=Object.keys(_employes).length;
  var thisYear=new Date().getFullYear();
  var done=0,notes=[];
  Object.keys(_employes).forEach(empId=>{
    var ents=_entretiens[empId]||[];
    if(ents.some(x=>x.annee==thisYear)){done++;}
    ents.forEach(x=>{if(x.noteGlobale)notes.push(parseFloat(x.noteGlobale)||0);});
  });
  var moy=notes.length>0?(notes.reduce((s,v)=>s+v,0)/notes.length).toFixed(1):'‚Äî';
  document.getElementById('stat-total').textContent=total;
  document.getElementById('stat-done').textContent=done;
  document.getElementById('stat-todo').textContent=total-done;
  document.getElementById('stat-moy').textContent=moy;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OUVRIR UN EMPLOY√â
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openEmployee = async function(empId){
  _currentEmpId=empId;
  _currentEntId=null;
  renderEmpList();
  var e=_employes[empId];
  var ents=await loadEntretiensForEmp(empId);
  var thisYear=new Date().getFullYear();
  var idx=Object.values(_employes).indexOf(e);
  var color=COLORS[idx%COLORS.length];
  var init=((e.prenom||'?').charAt(0)+(e.nom||'').charAt(0)).toUpperCase();
  var anc=e.dateEntree?calcAnciennete(e.dateEntree):'‚Äî';
  var lastEnt=ents[0];
  var notesMoy=ents.filter(x=>x.noteGlobale).length>0?(ents.filter(x=>x.noteGlobale).reduce((s,x)=>s+(parseFloat(x.noteGlobale)||0),0)/ents.filter(x=>x.noteGlobale).length).toFixed(1):'‚Äî';
  var hasThisYear=ents.some(x=>x.annee==thisYear);

  var histHtml=ents.map(ent=>`
    <div class="hist-item ${_currentEntId===ent.id?'active':''}" onclick="openEntretien('${empId}','${ent.id}')">
      <div class="hist-year">${ent.annee||'‚Äî'}</div>
      <div style="flex:1">
        <div style="font-size:12px;font-weight:600">${ent.type==='annuel'?'Entretien annuel':ent.type==='mi-annee'?'Mi-ann√©e':ent.type==='professionnel'?'Entretien professionnel':'Entretien de retour'}</div>
        <div class="hist-date">${ent.date?fmtDate(ent.date):'‚Äî'}${ent.evaluateur?' ¬∑ '+ent.evaluateur:''}</div>
      </div>
      ${ent.noteGlobale?`<div class="hist-note">${renderStarsMini(parseFloat(ent.noteGlobale))} <span style="font-size:12px;font-weight:700;color:var(--rh-main);margin-left:4px">${ent.noteGlobale}/5</span></div>`:''}
      <span class="hist-status ${ent.statut==='finalise'?'s-done':'s-draft'}">${ent.statut==='finalise'?'Finalis√©':'Brouillon'}</span>
      <span class="hist-chevron">‚Ä∫</span>
    </div>
  `).join('');

  if(!histHtml)histHtml=`<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px"><div style="font-size:28px;margin-bottom:8px">üìã</div>Aucun entretien enregistr√©</div>`;

  var rightPanel=document.getElementById('right-panel');
  rightPanel.innerHTML=`
    <!-- HERO -->
    <div class="emp-hero">
      <div class="hero-avatar" style="background:${color}">${init}</div>
      <div>
        <div class="hero-name">${(e.prenom||'')+' '+(e.nom||'')}</div>
        <div class="hero-sub">${e.poste||'‚Äî'}${e.departement?' ¬∑ '+e.departement:''} ¬∑ Anciennet√© : ${anc}</div>
      </div>
      <div class="hero-kpis">
        <div class="hkpi"><div class="hkpi-val">${ents.length}</div><div class="hkpi-lbl">Entretiens</div></div>
        <div class="hkpi"><div class="hkpi-val">${notesMoy}</div><div class="hkpi-lbl">Moy. notes</div></div>
        <div class="hkpi"><div class="hkpi-val">${hasThisYear?'‚úì':'‚Äî'}</div><div class="hkpi-lbl">${thisYear}</div></div>
        <div class="hkpi"><div class="hkpi-val">${e.salaireBrut?fmtK(e.salaireBrut):'‚Äî'}</div><div class="hkpi-lbl">Salaire brut</div></div>
      </div>
    </div>

    <!-- HISTORIQUE + BOUTON -->
    <div class="section">
      <div class="sec-head">
        <div class="sec-title">üìã Historique des entretiens</div>
        <button class="btn btn-rh btn-sm" onclick="openNewEntretienForEmp('${empId}')">+ Nouvel entretien</button>
      </div>
      <div class="sec-body">${histHtml}</div>
    </div>

    <!-- √âVOLUTION -->
    ${ents.filter(x=>x.noteGlobale).length>=2?`
    <div class="section">
      <div class="sec-head"><div class="sec-title">üìà Evolution des notes</div></div>
      <div class="sec-body" style="height:180px"><canvas id="chart-evo"></canvas></div>
    </div>`:''}
  `;

  // Graphe √©volution
  if(ents.filter(x=>x.noteGlobale).length>=2){
    setTimeout(()=>{
      var data=ents.filter(x=>x.noteGlobale).slice().reverse();
      var ctx=document.getElementById('chart-evo');
      if(!ctx)return;
      new Chart(ctx,{
        type:'line',
        data:{
          labels:data.map(x=>x.annee||''),
          datasets:[{
            label:'Note globale',
            data:data.map(x=>parseFloat(x.noteGlobale)||0),
            borderColor:'#059669',backgroundColor:'rgba(5,150,105,.1)',
            tension:.4,pointRadius:5,pointBackgroundColor:'#059669',fill:true,borderWidth:2
          }]
        },
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{min:0,max:5,ticks:{stepSize:1}}}}
      });
    },80);
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OUVRIR/SAISIR UN ENTRETIEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openEntretien = async function(empId, entId){
  _currentEmpId=empId;
  _currentEntId=entId;
  // Rafra√Æchir la liste pour mettre √† jour l'actif
  var ents=_entretiens[empId]||[];
  var ent=ents.find(x=>x.id===entId);
  if(!ent){
    // Recharger depuis Firebase
    try{
      var snap=await window._getDoc(window._doc(window._db,'rh',window._uid,'entretiens_annuels',empId,'sessions',entId));
      if(snap.exists())ent=Object.assign({id:entId},snap.data());
    }catch(e){}
  }
  if(!ent){showToast('Entretien introuvable','warning');return;}
  renderEntretienForm(empId,ent);
};

function renderEntretienForm(empId, ent){
  var e=_employes[empId]||{};
  var idx=Object.values(_employes).indexOf(e);
  var color=COLORS[idx%COLORS.length];
  var init=((e.prenom||'?').charAt(0)+(e.nom||'').charAt(0)).toUpperCase();

  var rightPanel=document.getElementById('right-panel');
  rightPanel.innerHTML=`
    <!-- BREADCRUMB -->
    <div style="display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)">
      <button style="background:none;border:none;cursor:pointer;color:var(--rh-main);font-weight:600;font-size:13px;font-family:'Plus Jakarta Sans',sans-serif;" onclick="openEmployee('${empId}')">‚Üê ${(e.prenom||'')+' '+(e.nom||'')}</button>
      <span>‚Ä∫</span>
      <span style="font-weight:700;color:var(--text)">Entretien ${ent.annee||''} ‚Äî ${typeLabel(ent.type)}</span>
      <span class="hist-status ${ent.statut==='finalise'?'s-done':'s-draft'}" style="margin-left:8px">${ent.statut==='finalise'?'‚úÖ Finalis√©':'üìù Brouillon'}</span>
    </div>

    <!-- SCORE GLOBAL (si des notes existent) -->
    <div id="score-global-wrap"></div>

    <!-- ONGLETS -->
    <div class="etab-bar" id="etab-bar">
      <div class="etab active" onclick="switchTab('bilan')">üìä Bilan N-1</div>
      <div class="etab" onclick="switchTab('objectifs')">üéØ Objectifs N+1</div>
      <div class="etab" onclick="switchTab('competences')">‚≠ê Comp√©tences</div>
      <div class="etab" onclick="switchTab('remuneration')">üí∞ R√©mun√©ration</div>
      <div class="etab" onclick="switchTab('formation')">üéì Formation</div>
      <div class="etab" onclick="switchTab('synthese')">üìã Synth√®se</div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB BILAN N-1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="etab-panel active" id="tab-bilan">
      <div class="section">
        <div class="sec-head"><div class="sec-title">üìä Bilan de l'ann√©e √©coul√©e (${ent.annee||'N-1'})</div></div>
        <div class="sec-body">
          <div class="field-wrap">
            <label class="field-label">Rappel du poste et du r√¥le</label>
            <textarea class="rh-textarea" id="f-role" rows="2" oninput="autoSave()" placeholder="Description du poste, principales responsabilit√©s...">${ent.role||''}</textarea>
          </div>
          <div class="field-wrap">
            <label class="field-label">R√©alisations et succ√®s marquants</label>
            <textarea class="rh-textarea" id="f-realisations" rows="3" oninput="autoSave()" placeholder="Projets accomplis, r√©sultats obtenus, initiatives prises...">${ent.realisations||''}</textarea>
          </div>
          <div class="field-wrap">
            <label class="field-label">Points forts identifi√©s</label>
            <textarea class="rh-textarea" id="f-points_forts" rows="3" oninput="autoSave()" placeholder="Qualit√©s, expertises, comportements exemplaires...">${ent.points_forts||''}</textarea>
          </div>
          <div class="field-wrap">
            <label class="field-label">Axes d'am√©lioration</label>
            <textarea class="rh-textarea" id="f-axes_amelioration" rows="3" oninput="autoSave()" placeholder="Points √† travailler, lacunes identifi√©es, difficult√©s rencontr√©es...">${ent.axes_amelioration||''}</textarea>
          </div>
          <div class="field-wrap">
            <label class="field-label">Appr√©ciation g√©n√©rale de la p√©riode</label>
            <textarea class="rh-textarea" id="f-appreciation" rows="2" oninput="autoSave()" placeholder="Vision globale du manager sur l'ann√©e...">${ent.appreciation||''}</textarea>
          </div>
        </div>
      </div>

      <!-- Bilan des objectifs N-1 -->
      <div class="section">
        <div class="sec-head">
          <div class="sec-title">üéØ Bilan des objectifs fix√©s</div>
        </div>
        <div class="sec-body">
          <div style="font-size:11px;color:var(--muted);margin-bottom:10px">Evaluez le niveau d'atteinte de chaque objectif fix√© l'ann√©e pr√©c√©dente</div>
          <div class="obj-grid" id="bilan-obj-grid">
            ${renderBilanObjRows(ent.bilan_objectifs||[])}
          </div>
          <button class="btn-add-row" onclick="addBilanObjRow()">+ Ajouter un objectif √©valu√©</button>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB OBJECTIFS N+1 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="etab-panel" id="tab-objectifs">
      <div class="section">
        <div class="sec-head">
          <div class="sec-title">üéØ Objectifs ${(ent.annee||new Date().getFullYear())+1}</div>
        </div>
        <div class="sec-body">
          <div style="font-size:11px;color:var(--muted);margin-bottom:10px">D√©finissez des objectifs SMART (Sp√©cifique, Mesurable, Atteignable, R√©aliste, Temporel)</div>
          <div style="display:grid;grid-template-columns:1fr 100px 80px 80px 36px;gap:8px;margin-bottom:6px;padding:0 4px">
            <span style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">Objectif</span>
            <span style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">Priorit√©</span>
            <span style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">Ech√©ance</span>
            <span style="font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase">Mesure</span>
            <span></span>
          </div>
          <div id="new-obj-grid">
            ${renderNewObjRows(ent.nouveaux_objectifs||[])}
          </div>
          <button class="btn-add-row" onclick="addNewObjRow()">+ Ajouter un objectif</button>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB COMP√âTENCES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="etab-panel" id="tab-competences">
      <div class="section">
        <div class="sec-head"><div class="sec-title">‚≠ê √âvaluation des comp√©tences</div></div>
        <div class="sec-body">
          <div class="rating-grid" id="rating-grid">
            ${renderRatingGrid(ent)}
          </div>
          <div style="margin-top:16px">
            <label class="field-label">Commentaire sur les comp√©tences</label>
            <textarea class="rh-textarea" id="f-comment_comp" rows="3" oninput="autoSave()" placeholder="Observations globales sur les comp√©tences du collaborateur...">${ent.comment_comp||''}</textarea>
          </div>
        </div>
      </div>

      <!-- Note globale -->
      <div class="section">
        <div class="sec-head"><div class="sec-title">üåü Note globale de l'entretien</div></div>
        <div class="sec-body">
          <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap">
            <div>
              <div class="field-label" style="margin-bottom:8px">Note sur 5</div>
              <div class="stars-input" id="note-stars" onclick="handleStarClick(event)">
                ${renderStarsInput(parseFloat(ent.noteGlobale)||0)}
              </div>
            </div>
            <div style="flex:1">
              <div class="field-label" style="margin-bottom:5px">Appr√©ciation</div>
              <select class="rh-input" id="f-appreciation_finale" onchange="autoSave()" style="width:auto;min-width:220px">
                <option value="">S√©lectionner...</option>
                <option value="exceptionnel" ${ent.appreciation_finale==='exceptionnel'?'selected':''}>‚≠ê‚≠ê‚≠ê Exceptionnel</option>
                <option value="tres_bien" ${ent.appreciation_finale==='tres_bien'?'selected':''}>‚≠ê‚≠ê Tr√®s bien</option>
                <option value="bien" ${ent.appreciation_finale==='bien'?'selected':''}>‚≠ê Bien / Satisfaisant</option>
                <option value="ameliorer" ${ent.appreciation_finale==='ameliorer'?'selected':''}>‚ö†Ô∏è A am√©liorer</option>
                <option value="insuffisant" ${ent.appreciation_finale==='insuffisant'?'selected':''}>‚ùå Insuffisant</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB REMUNERATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="etab-panel" id="tab-remuneration">
      <div class="section">
        <div class="sec-head"><div class="sec-title">üí∞ R√©mun√©ration & avantages</div></div>
        <div class="sec-body">
          <div class="form-grid-3" style="margin-bottom:14px">
            <div class="field-wrap" style="margin-bottom:0">
              <label class="field-label">Salaire brut actuel (‚Ç¨/mois)</label>
              <input class="rh-input" id="f-salaire_actuel" type="text" inputmode="decimal" oninput="autoSave()" value="${ent.salaire_actuel||e.salaireBrut||''}" placeholder="2 500"/>
            </div>
            <div class="field-wrap" style="margin-bottom:0">
              <label class="field-label">Augmentation propos√©e</label>
              <input class="rh-input" id="f-augmentation" type="text" inputmode="decimal" oninput="autoSave();calcNouveauSalaire()" value="${ent.augmentation||''}" placeholder="3%"/>
            </div>
            <div class="field-wrap" style="margin-bottom:0">
              <label class="field-label">Nouveau salaire brut</label>
              <input class="rh-input" id="f-nouveau_salaire" type="text" inputmode="decimal" oninput="autoSave()" value="${ent.nouveau_salaire||''}" placeholder="Calcul auto"/>
            </div>
          </div>
          <div class="form-grid-2">
            <div class="field-wrap">
              <label class="field-label">Date d'effet</label>
              <input class="rh-input" id="f-date_effet" type="date" oninput="autoSave()" value="${ent.date_effet||''}"/>
            </div>
            <div class="field-wrap">
              <label class="field-label">Prime exceptionnelle</label>
              <input class="rh-input" id="f-prime" type="text" inputmode="decimal" oninput="autoSave()" value="${ent.prime||''}" placeholder="500 ‚Ç¨"/>
            </div>
          </div>
          <div class="field-wrap">
            <label class="field-label">Avantages en nature / autres</label>
            <textarea class="rh-textarea" id="f-avantages" rows="2" oninput="autoSave()" placeholder="Voiture de fonction, mutuelle renforc√©e, participation...">${ent.avantages||''}</textarea>
          </div>
          <div class="field-wrap">
            <label class="field-label">Commentaires sur la r√©mun√©ration</label>
            <textarea class="rh-textarea" id="f-comment_remun" rows="2" oninput="autoSave()" placeholder="Justification, contexte, accord ou refus...">${ent.comment_remun||''}</textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB FORMATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="etab-panel" id="tab-formation">
      <div class="section">
        <div class="sec-head"><div class="sec-title">üéì Besoins en formation & d√©veloppement</div></div>
        <div class="sec-body">
          <div class="field-wrap">
            <label class="field-label">Formations suivies sur la p√©riode √©coul√©e</label>
            <textarea class="rh-textarea" id="f-formations_suivies" rows="2" oninput="autoSave()" placeholder="Intitul√©, dur√©e, organisme...">${ent.formations_suivies||''}</textarea>
          </div>
          <div class="field-wrap">
            <label class="field-label">Besoins en formation identifi√©s</label>
            <textarea class="rh-textarea" id="f-besoins_formation" rows="3" oninput="autoSave()" placeholder="Comp√©tences √† d√©velopper, formations souhait√©es, certifications vis√©es...">${ent.besoins_formation||''}</textarea>
          </div>
          <div class="form-grid-2">
            <div class="field-wrap">
              <label class="field-label">Priorit√© formation</label>
              <select class="rh-input" id="f-priorite_formation" onchange="autoSave()">
                <option value="">S√©lectionner...</option>
                <option value="urgente" ${ent.priorite_formation==='urgente'?'selected':''}>üî¥ Urgente (6 mois)</option>
                <option value="normale" ${ent.priorite_formation==='normale'?'selected':''}>üü° Normale (12 mois)</option>
                <option value="secondaire" ${ent.priorite_formation==='secondaire'?'selected':''}>üü¢ Secondaire (2 ans)</option>
              </select>
            </div>
            <div class="field-wrap">
              <label class="field-label">Budget estim√©</label>
              <input class="rh-input" id="f-budget_formation" type="text" inputmode="decimal" oninput="autoSave()" value="${ent.budget_formation||''}" placeholder="1 500 ‚Ç¨"/>
            </div>
          </div>
          <div class="field-wrap">
            <label class="field-label">Projet professionnel du collaborateur</label>
            <textarea class="rh-textarea" id="f-projet_pro" rows="3" oninput="autoSave()" placeholder="Aspirations, souhait d'√©volution, mobilit√©...">${ent.projet_pro||''}</textarea>
          </div>
          <div class="field-wrap">
            <label class="field-label">Evolution de poste envisag√©e</label>
            <select class="rh-input" id="f-evolution_poste" onchange="autoSave()">
              <option value="">S√©lectionner...</option>
              <option value="maintien" ${ent.evolution_poste==='maintien'?'selected':''}>Maintien dans le poste actuel</option>
              <option value="enrichissement" ${ent.evolution_poste==='enrichissement'?'selected':''}>Enrichissement du poste</option>
              <option value="promotion" ${ent.evolution_poste==='promotion'?'selected':''}>Promotion / Avancement</option>
              <option value="mobilite" ${ent.evolution_poste==='mobilite'?'selected':''}>Mobilit√© interne</option>
              <option value="non_envisagee" ${ent.evolution_poste==='non_envisagee'?'selected':''}>Non envisag√©e</option>
            </select>
          </div>
          <div class="field-wrap">
            <label class="field-label">Information CPF d√©livr√©e</label>
            <select class="rh-input" id="f-cpf" onchange="autoSave()">
              <option value="">S√©lectionner...</option>
              <option value="oui" ${ent.cpf==='oui'?'selected':''}>‚úÖ Oui, le salari√© a √©t√© inform√© de ses droits CPF</option>
              <option value="non" ${ent.cpf==='non'?'selected':''}>Non</option>
            </select>
            <div class="field-hint">Obligation l√©gale art. L6315-1 CT ‚Äî √† renseigner syst√©matiquement</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TAB SYNTH√àSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="etab-panel" id="tab-synthese">
      <div id="score-synthese-wrap"></div>

      <div class="section">
        <div class="sec-head"><div class="sec-title">üìã Synth√®se et conclusions</div></div>
        <div class="sec-body">
          <div class="field-wrap">
            <label class="field-label">Conclusions de l'entretien</label>
            <textarea class="rh-textarea" id="f-conclusions" rows="4" oninput="autoSave()" placeholder="R√©sum√© des √©changes, d√©cisions prises, engagements mutuels...">${ent.conclusions||''}</textarea>
          </div>
          <div class="form-grid-2">
            <div class="field-wrap">
              <label class="field-label">Prochaine √©tape / suivi</label>
              <textarea class="rh-textarea" id="f-prochaine_etape" rows="2" oninput="autoSave()" placeholder="Date de suivi, actions concr√®tes...">${ent.prochaine_etape||''}</textarea>
            </div>
            <div class="field-wrap">
              <label class="field-label">Observations du collaborateur</label>
              <textarea class="rh-textarea" id="f-observations_salarie" rows="2" oninput="autoSave()" placeholder="Remarques ou r√©serves du salari√©...">${ent.observations_salarie||''}</textarea>
            </div>
          </div>
          <div class="form-grid-2" style="margin-top:6px">
            <div class="field-wrap">
              <label class="field-label">Date signature employeur</label>
              <input class="rh-input" id="f-date_sign_emp" type="date" oninput="autoSave()" value="${ent.date_sign_emp||''}"/>
            </div>
            <div class="field-wrap">
              <label class="field-label">Date signature salari√©</label>
              <input class="rh-input" id="f-date_sign_sal" type="date" oninput="autoSave()" value="${ent.date_sign_sal||''}"/>
            </div>
          </div>
        </div>
      </div>

      <!-- ACTIONS -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;padding-bottom:8px">
        <button class="btn btn-rh" onclick="saveNow('${empId}','${ent.id}')">üíæ Sauvegarder</button>
        <button class="btn btn-outline" onclick="printEntretien('${empId}','${ent.id}')">üñ®Ô∏è Imprimer</button>
        ${ent.statut!=='finalise'?`<button class="btn" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white" onclick="finaliserEntretien('${empId}','${ent.id}')">‚úÖ Finaliser l'entretien</button>`:''}
        <button class="btn btn-danger btn-sm" style="margin-left:auto" onclick="deleteEntretien('${empId}','${ent.id}')">üóë Supprimer</button>
      </div>
    </div>

    <!-- SAVE BAR -->
    <div class="save-bar">
      <div class="save-status">
        <div class="save-dot" id="save-dot"></div>
        <span id="save-text">Modifications non sauvegard√©es</span>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-outline btn-sm" onclick="switchTab('synthese');setTimeout(()=>document.getElementById('tab-synthese').scrollIntoView({behavior:'smooth'}),100)">üìã Synth√®se</button>
        <button class="btn btn-rh btn-sm" onclick="saveNow('${empId}','${ent.id}')">üíæ Enregistrer</button>
      </div>
    </div>
  `;

  _saveDirty=false;
  updateSaveDot('saved');
  updateScoreGlobal(ent);
  // Initialiser les √©toiles
  if(ent.noteGlobale) setStarsDisplay(parseFloat(ent.noteGlobale)||0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDERING HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBilanObjRows(rows){
  if(!rows||rows.length===0) rows=[{obj:'',atteinte:'',pct:''}];
  return rows.map((r,i)=>`
    <div class="obj-row" id="bobj-row-${i}">
      <input class="obj-input" placeholder="Objectif fix√© l'ann√©e pr√©c√©dente..." value="${r.obj||''}" oninput="autoSave()"/>
      <select class="obj-select" oninput="autoSave()" style="font-size:12px">
        <option value="">R√©sultat...</option>
        <option value="atteint" ${r.atteinte==='atteint'?'selected':''}>‚úÖ Atteint</option>
        <option value="partiel" ${r.atteinte==='partiel'?'selected':''}>‚ö†Ô∏è Partiel</option>
        <option value="non_atteint" ${r.atteinte==='non_atteint'?'selected':''}>‚ùå Non atteint</option>
        <option value="na" ${r.atteinte==='na'?'selected':''}>‚Äî Sans objet</option>
      </select>
      <input class="obj-pct" placeholder="%" type="text" inputmode="decimal" value="${r.pct||''}" oninput="autoSave()" style="text-align:center"/>
      <button class="btn-del-row" onclick="delBilanObjRow(${i})">‚úï</button>
    </div>
  `).join('');
}

function renderNewObjRows(rows){
  if(!rows||rows.length===0) rows=[{obj:'',priorite:'',echeance:'',mesure:''}];
  return rows.map((r,i)=>`
    <div style="display:grid;grid-template-columns:1fr 100px 80px 80px 36px;gap:8px;align-items:center;margin-bottom:8px" id="nobj-row-${i}">
      <input class="obj-input" placeholder="Objectif SMART..." value="${r.obj||''}" oninput="autoSave()"/>
      <select class="obj-select" oninput="autoSave()">
        <option value="">Priorit√©...</option>
        <option value="haute" ${r.priorite==='haute'?'selected':''}>üî¥ Haute</option>
        <option value="moyenne" ${r.priorite==='moyenne'?'selected':''}>üü° Moyenne</option>
        <option value="basse" ${r.priorite==='basse'?'selected':''}>üü¢ Basse</option>
      </select>
      <input class="obj-pct" placeholder="T4 2025" type="text" value="${r.echeance||''}" oninput="autoSave()"/>
      <input class="obj-pct" placeholder="KPI" type="text" value="${r.mesure||''}" oninput="autoSave()"/>
      <button class="btn-del-row" onclick="delNewObjRow(${i})">‚úï</button>
    </div>
  `).join('');
}

var COMPETENCES=[
  {id:'perf_technique',label:'Ma√Ætrise technique / m√©tier',emoji:'üîß'},
  {id:'organisation',label:'Organisation & gestion des priorit√©s',emoji:'üìÖ'},
  {id:'communication',label:'Communication & relations',emoji:'üí¨'},
  {id:'initiative',label:'Initiative & autonomie',emoji:'üí°'},
  {id:'esprit_equipe',label:'Esprit d\'√©quipe',emoji:'ü§ù'},
  {id:'leadership',label:'Leadership & encadrement',emoji:'üëë'},
  {id:'adaptation',label:'Capacit√© d\'adaptation',emoji:'üîÑ'},
  {id:'qualite',label:'Qualit√© du travail rendu',emoji:'‚úÖ'},
];

function renderRatingGrid(ent){
  return COMPETENCES.map(c=>`
    <div class="rating-item">
      <div class="rating-label"><span class="emoji">${c.emoji}</span> ${c.label}</div>
      <div class="stars-input" data-comp="${c.id}" onclick="handleCompStarClick(event,'${c.id}')">
        ${renderStarsInput(parseFloat(ent[c.id])||0,'comp-'+c.id)}
      </div>
      <div class="prog-bar-wrap"><div class="prog-bar-fill" id="prog-${c.id}" style="width:${(parseFloat(ent[c.id])||0)/5*100}%;background:${getStarColor(parseFloat(ent[c.id])||0)}"></div></div>
    </div>
  `).join('');
}

function renderStarsInput(val, prefix){
  var html='';
  for(var i=1;i<=5;i++){
    html+=`<span class="star${i<=val?' active':''}" data-val="${i}">${i<=val?'‚òÖ':'‚òÜ'}</span>`;
  }
  return html;
}

function renderStarsMini(val){
  var html='';
  for(var i=1;i<=5;i++) html+=`<span style="color:${i<=val?'#f59e0b':'#e2e8f0'};font-size:12px">${i<=val?'‚òÖ':'‚òÜ'}</span>`;
  return html;
}

function getStarColor(val){
  if(val>=4.5) return '#059669';
  if(val>=3.5) return '#10b981';
  if(val>=2.5) return '#f59e0b';
  if(val>=1.5) return '#f97316';
  return '#ef4444';
}

function typeLabel(t){
  return {annuel:'Entretien annuel',
    'mi-annee':'Mi-ann√©e',
    professionnel:'Entretien professionnel',
    retour:'Entretien de retour'}[t]||t||'Entretien';
}

function updateScoreGlobal(ent){
  var vals=COMPETENCES.map(c=>parseFloat(ent[c.id])||0).filter(v=>v>0);
  var moy=vals.length>0?(vals.reduce((s,v)=>s+v,0)/vals.length):0;
  var noteG=parseFloat(ent.noteGlobale)||0;
  var wrap=document.getElementById('score-global-wrap');
  if(!wrap||(!moy&&!noteG))return;
  var displayNote=noteG||moy.toFixed(1);
  wrap.innerHTML=`
    <div class="score-globe">
      <div style="text-align:center">
        <div class="score-num">${parseFloat(displayNote).toFixed(1)}</div>
        <div class="score-max">/5</div>
        <div style="font-size:11px;opacity:.7;margin-top:4px">${renderStarsMini(parseFloat(displayNote))}</div>
      </div>
      <div class="score-details">
        <div class="score-label">√âvaluation globale ‚Äî ${typeLabel(ent.type)} ${ent.annee||''}</div>
        <div class="score-breakdown">
          ${COMPETENCES.filter(c=>ent[c.id]).slice(0,5).map(c=>`
            <div class="score-line">
              <span style="font-size:11px;opacity:.8;min-width:160px">${c.label}</span>
              <div class="score-line-bar"><div class="score-line-fill" style="width:${(parseFloat(ent[c.id])||0)/5*100}%"></div></div>
              <span style="font-size:11px;font-weight:700;opacity:.9;min-width:24px;text-align:right">${ent[c.id]}/5</span>
            </div>
          `).join('')}
        </div>
      </div>
    </div>`;
  // Aussi dans synth√®se
  var s=document.getElementById('score-synthese-wrap');
  if(s)s.innerHTML=wrap.innerHTML;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ONGLETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.switchTab=function(tab){
  document.querySelectorAll('.etab').forEach((el,i)=>{
    var tabs=['bilan','objectifs','competences','remuneration','formation','synthese'];
    el.classList.toggle('active',tabs[i]===tab);
  });
  document.querySelectorAll('.etab-panel').forEach(el=>{
    el.classList.toggle('active',el.id==='tab-'+tab);
  });
  if(tab==='synthese')updateScoreGlobal(getCurrentEntData());
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GESTION √âTOILES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.handleStarClick=function(e){
  var star=e.target.closest('.star');
  if(!star)return;
  var val=parseInt(star.dataset.val);
  var wrap=document.getElementById('note-stars');
  if(!wrap)return;
  wrap.querySelectorAll('.star').forEach((s,i)=>{
    s.classList.toggle('active',i<val);
    s.textContent=i<val?'‚òÖ':'‚òÜ';
  });
  wrap.dataset.val=val;
  autoSave();
};

window.handleCompStarClick=function(e,compId){
  var star=e.target.closest('.star');
  if(!star)return;
  var val=parseInt(star.dataset.val);
  var wrap=e.currentTarget;
  wrap.querySelectorAll('.star').forEach((s,i)=>{
    s.classList.toggle('active',i<val);
    s.textContent=i<val?'‚òÖ':'‚òÜ';
  });
  wrap.dataset.val=val;
  // Mettre √† jour la barre de progression
  var prog=document.getElementById('prog-'+compId);
  if(prog){prog.style.width=(val/5*100)+'%';prog.style.background=getStarColor(val);}
  autoSave();
  // Recalculer le score global
  setTimeout(()=>updateScoreGlobal(getCurrentEntData()),100);
};

function setStarsDisplay(val){
  var wrap=document.getElementById('note-stars');
  if(!wrap)return;
  wrap.querySelectorAll('.star').forEach((s,i)=>{
    s.classList.toggle('active',i<val);
    s.textContent=i<val?'‚òÖ':'‚òÜ';
  });
  wrap.dataset.val=val;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OBJECTIFS ROWS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addBilanObjRow=function(){
  var grid=document.getElementById('bilan-obj-grid');
  if(!grid)return;
  var rows=getBilanObjRows();
  rows.push({obj:'',atteinte:'',pct:''});
  grid.innerHTML=renderBilanObjRows(rows);
};
window.delBilanObjRow=function(i){
  var rows=getBilanObjRows();
  rows.splice(i,1);
  if(rows.length===0)rows=[{obj:'',atteinte:'',pct:''}];
  document.getElementById('bilan-obj-grid').innerHTML=renderBilanObjRows(rows);
  autoSave();
};
function getBilanObjRows(){
  var grid=document.getElementById('bilan-obj-grid');
  if(!grid)return[];
  var rows=[];
  grid.querySelectorAll('.obj-row').forEach(row=>{
    var inputs=row.querySelectorAll('input,select');
    rows.push({obj:inputs[0]?.value||'',atteinte:inputs[1]?.value||'',pct:inputs[2]?.value||''});
  });
  return rows;
}
window.addNewObjRow=function(){
  var grid=document.getElementById('new-obj-grid');
  if(!grid)return;
  var rows=getNewObjRows();
  rows.push({obj:'',priorite:'',echeance:'',mesure:''});
  grid.innerHTML=renderNewObjRows(rows);
};
window.delNewObjRow=function(i){
  var rows=getNewObjRows();
  rows.splice(i,1);
  if(rows.length===0)rows=[{obj:'',priorite:'',echeance:'',mesure:''}];
  document.getElementById('new-obj-grid').innerHTML=renderNewObjRows(rows);
  autoSave();
};
function getNewObjRows(){
  var grid=document.getElementById('new-obj-grid');
  if(!grid)return[];
  var rows=[];
  grid.querySelectorAll('[id^="nobj-row-"]').forEach(row=>{
    var inputs=row.querySelectorAll('input,select');
    rows.push({obj:inputs[0]?.value||'',priorite:inputs[1]?.value||'',echeance:inputs[2]?.value||'',mesure:inputs[3]?.value||''});
  });
  return rows;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COLLECTE DES DONN√âES DU FORMULAIRE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getCurrentEntData(){
  var get=function(id){var el=document.getElementById('f-'+id);return el?el.value.trim():undefined;};
  var noteStars=document.getElementById('note-stars');
  var noteGlobale=noteStars?parseFloat(noteStars.dataset.val)||0:0;
  // Comp√©tences
  var compData={};
  COMPETENCES.forEach(function(c){
    var wrap=document.querySelector('[data-comp="'+c.id+'"]');
    if(wrap&&wrap.dataset.val) compData[c.id]=parseInt(wrap.dataset.val)||0;
  });
  // Calculer note auto si pas de note manuelle
  var compVals=Object.values(compData).filter(v=>v>0);
  var noteMoyComp=compVals.length>0?(compVals.reduce((s,v)=>s+v,0)/compVals.length):0;
  var noteFin=noteGlobale||parseFloat(noteMoyComp.toFixed(1));
  return Object.assign({
    role:get('role'),
    realisations:get('realisations'),
    points_forts:get('points_forts'),
    axes_amelioration:get('axes_amelioration'),
    appreciation:get('appreciation'),
    bilan_objectifs:getBilanObjRows(),
    nouveaux_objectifs:getNewObjRows(),
    comment_comp:get('comment_comp'),
    noteGlobale:noteFin||null,
    appreciation_finale:get('appreciation_finale'),
    salaire_actuel:get('salaire_actuel'),
    augmentation:get('augmentation'),
    nouveau_salaire:get('nouveau_salaire'),
    date_effet:get('date_effet'),
    prime:get('prime'),
    avantages:get('avantages'),
    comment_remun:get('comment_remun'),
    formations_suivies:get('formations_suivies'),
    besoins_formation:get('besoins_formation'),
    priorite_formation:get('priorite_formation'),
    budget_formation:get('budget_formation'),
    projet_pro:get('projet_pro'),
    evolution_poste:get('evolution_poste'),
    cpf:get('cpf'),
    conclusions:get('conclusions'),
    prochaine_etape:get('prochaine_etape'),
    observations_salarie:get('observations_salarie'),
    date_sign_emp:get('date_sign_emp'),
    date_sign_sal:get('date_sign_sal'),
    updatedAt:new Date().toISOString(),
  }, compData);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTOSAVE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.autoSave=function(){
  if(!_currentEntId||!_currentEmpId)return;
  _saveDirty=true;
  updateSaveDot('saving');
  if(_saveTimer)clearTimeout(_saveTimer);
  _saveTimer=setTimeout(()=>saveNow(_currentEmpId,_currentEntId,true),1800);
};

window.saveNow=async function(empId,entId,silent){
  if(!window._uid||!entId)return;
  updateSaveDot('saving');
  var data=getCurrentEntData();
  try{
    await window._setDoc(window._doc(window._db,'rh',window._uid,'entretiens_annuels',empId,'sessions',entId),data,{merge:true});
    // Mettre √† jour le cache
    if(_entretiens[empId]){
      var idx=_entretiens[empId].findIndex(x=>x.id===entId);
      if(idx>=0) _entretiens[empId][idx]=Object.assign(_entretiens[empId][idx],data);
    }
    // Mettre √† jour noteMoyenne sur la fiche employ√©
    var ents=_entretiens[empId]||[];
    var notes=ents.filter(x=>x.noteGlobale).map(x=>parseFloat(x.noteGlobale)||0);
    if(notes.length>0){
      var moy=(notes.reduce((s,v)=>s+v,0)/notes.length).toFixed(1);
      try{await window._setDoc(window._doc(window._db,'rh',window._uid,'employes',empId),{noteMoyEnt:parseFloat(moy)},{merge:true});}catch(e){}
    }
    updateSaveDot('saved');
    _saveDirty=false;
    if(!silent)showToast('‚úÖ Enregistr√©','success');
  }catch(e){
    updateSaveDot('error');
    showToast('Erreur de sauvegarde','warning');
    console.error(e);
  }
};

function updateSaveDot(state){
  var dot=document.getElementById('save-dot');
  var txt=document.getElementById('save-text');
  if(!dot)return;
  dot.className='save-dot '+state;
  if(txt)txt.textContent={saving:'Enregistrement...',saved:'Enregistr√© ‚úì',error:'Erreur ‚Äî R√©essayez'}[state]||'';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CALC SALAIRE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.calcNouveauSalaire=function(){
  var actuel=parseFloat((document.getElementById('f-salaire_actuel')?.value||'').replace(',','.'))||0;
  var augStr=(document.getElementById('f-augmentation')?.value||'').replace('%','').replace(',','.');
  var pct=parseFloat(augStr)||0;
  var nouveau=document.getElementById('f-nouveau_salaire');
  if(actuel>0&&pct>0&&nouveau){
    nouveau.value=(actuel*(1+pct/100)).toFixed(2);
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CR√âER UN ENTRETIEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openNewEntretien=function(){
  document.getElementById('new-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('modal-new').classList.add('show');
};
window.openNewEntretienForEmp=function(empId){
  document.getElementById('new-emp-select').value=empId;
  document.getElementById('new-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('modal-new').classList.add('show');
};
window.closeModalNew=function(){document.getElementById('modal-new').classList.remove('show');};

window.createEntretien=async function(){
  var empId=document.getElementById('new-emp-select').value;
  var date=document.getElementById('new-date').value;
  var annee=parseInt(document.getElementById('new-annee').value)||new Date().getFullYear()-1;
  var evaluateur=document.getElementById('new-evaluateur').value.trim();
  var type=document.getElementById('new-type').value;
  if(!empId){showToast('S√©lectionner un collaborateur','warning');return;}
  if(!date){showToast('Indiquer une date','warning');return;}
  var emp=_employes[empId]||{};
  var data={
    empId,date,annee,evaluateur,type,
    statut:'brouillon',
    empNom:((emp.prenom||'')+' '+(emp.nom||'')).trim(),
    empPoste:emp.poste||'',
    createdAt:new Date().toISOString(),
    updatedAt:new Date().toISOString(),
    bilan_objectifs:[],
    nouveaux_objectifs:[],
  };
  try{
    var ref=await window._addDoc(window._collection(window._db,'rh',window._uid,'entretiens_annuels',empId,'sessions'),data);
    data.id=ref.id;
    if(!_entretiens[empId])_entretiens[empId]=[];
    _entretiens[empId].unshift(data);
    _entretiens[empId].sort((a,b)=>(b.annee||0)-(a.annee||0));
    closeModalNew();
    showToast('‚úÖ Entretien cr√©√©','success');
    await openEmployee(empId);
    openEntretien(empId,ref.id);
  }catch(e){showToast('Erreur : '+e.message,'warning');console.error(e);}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FINALISER / SUPPRIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.finaliserEntretien=async function(empId,entId){
  if(!confirm('Finaliser cet entretien ? Il ne sera plus modifiable.'))return;
  try{
    await saveNow(empId,entId,true);
    await window._setDoc(window._doc(window._db,'rh',window._uid,'entretiens_annuels',empId,'sessions',entId),{statut:'finalise',finalisedAt:new Date().toISOString()},{merge:true});
    if(_entretiens[empId]){
      var idx=_entretiens[empId].findIndex(x=>x.id===entId);
      if(idx>=0)_entretiens[empId][idx].statut='finalise';
    }
    showToast('‚úÖ Entretien finalis√©','success');
    openEmployee(empId);
  }catch(e){showToast('Erreur','warning');}
};

window.deleteEntretien=async function(empId,entId){
  if(!confirm('Supprimer d√©finitivement cet entretien ?'))return;
  try{
    await window._deleteDoc(window._doc(window._db,'rh',window._uid,'entretiens_annuels',empId,'sessions',entId));
    if(_entretiens[empId])_entretiens[empId]=_entretiens[empId].filter(x=>x.id!==entId);
    _currentEntId=null;
    showToast('Entretien supprim√©','ok');
    openEmployee(empId);
  }catch(e){showToast('Erreur','warning');}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMPRESSION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.printEntretien=async function(empId,entId){
  await saveNow(empId,entId,true);
  var ent=_entretiens[empId]?.find(x=>x.id===entId)||{};
  var e=_employes[empId]||{};
  var nom=((e.prenom||'')+' '+(e.nom||'')).trim();
  var compRows=COMPETENCES.filter(c=>ent[c.id]).map(c=>`
    <tr><td>${c.emoji} ${c.label}</td><td style="text-align:center;font-weight:700">${ent[c.id]}/5</td><td>${'‚òÖ'.repeat(parseInt(ent[c.id]))}${'‚òÜ'.repeat(5-parseInt(ent[c.id]))}</td></tr>
  `).join('');
  var objBilanRows=(ent.bilan_objectifs||[]).filter(r=>r.obj).map(r=>`
    <tr><td>${r.obj}</td><td>${r.atteinte==='atteint'?'‚úÖ Atteint':r.atteinte==='partiel'?'‚ö†Ô∏è Partiel':r.atteinte==='non_atteint'?'‚ùå Non atteint':'‚Äî'}</td><td>${r.pct?r.pct+'%':'‚Äî'}</td></tr>
  `).join('');
  var objNewRows=(ent.nouveaux_objectifs||[]).filter(r=>r.obj).map(r=>`
    <tr><td>${r.obj}</td><td>${r.priorite==='haute'?'üî¥ Haute':r.priorite==='moyenne'?'üü° Moyenne':'üü¢ Basse'}</td><td>${r.echeance||'‚Äî'}</td><td>${r.mesure||'‚Äî'}</td></tr>
  `).join('');
  var win=window.open('','_blank');
  win.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Entretien ${nom} ${ent.annee}</title>
  <style>
    body{font-family:'Segoe UI',sans-serif;font-size:13px;color:#1a1f36;padding:24px;max-width:900px;margin:0 auto;}
    h1{font-size:20px;font-weight:800;margin-bottom:4px;}
    .sub{font-size:13px;color:#6b7280;margin-bottom:20px;}
    h2{font-size:14px;font-weight:700;margin:20px 0 8px;padding:8px 12px;background:#f0fdf4;border-left:3px solid #059669;border-radius:0 6px 6px 0;}
    p{margin:0 0 8px;line-height:1.6;}
    table{width:100%;border-collapse:collapse;margin:0 0 12px;font-size:12px;}
    th{background:#f0fdf4;padding:7px 10px;text-align:left;font-size:11px;font-weight:700;color:#065f46;}
    td{padding:7px 10px;border-bottom:1px solid #e2e8f0;}
    .score{font-size:28px;font-weight:800;color:#059669;}
    .sign-row{display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:30px;}
    .sign-box{border-top:1px solid #1a1f36;padding-top:6px;font-size:12px;color:#6b7280;}
    @media print{body{padding:12px;}}
  </style></head><body>
  <h1>Entretien annuel ‚Äî ${nom}</h1>
  <div class="sub">${typeLabel(ent.type)} ¬∑ Ann√©e √©valu√©e : ${ent.annee||'‚Äî'} ¬∑ Date : ${ent.date?fmtDate(ent.date):'‚Äî'} ¬∑ Evaluateur : ${ent.evaluateur||'‚Äî'}</div>
  <div class="sub">Poste : ${e.poste||'‚Äî'} ¬∑ Anciennet√© : ${e.dateEntree?calcAnciennete(e.dateEntree):'‚Äî'}</div>
  ${ent.noteGlobale?`<div>Note globale : <span class="score">${ent.noteGlobale}/5</span></div>`:''}
  <h2>üìä Bilan de l'ann√©e</h2>
  ${ent.realisations?`<p><strong>R√©alisations :</strong> ${ent.realisations}</p>`:''}
  ${ent.points_forts?`<p><strong>Points forts :</strong> ${ent.points_forts}</p>`:''}
  ${ent.axes_amelioration?`<p><strong>Axes d'am√©lioration :</strong> ${ent.axes_amelioration}</p>`:''}
  ${objBilanRows?`<h2>üéØ Bilan objectifs</h2><table><thead><tr><th>Objectif</th><th>R√©sultat</th><th>%</th></tr></thead><tbody>${objBilanRows}</tbody></table>`:''}
  ${compRows?`<h2>‚≠ê Comp√©tences √©valu√©es</h2><table><thead><tr><th>Comp√©tence</th><th>Note</th><th>√âtoiles</th></tr></thead><tbody>${compRows}</tbody></table>`:''}
  ${objNewRows?`<h2>üéØ Objectifs ${(ent.annee||new Date().getFullYear())+1}</h2><table><thead><tr><th>Objectif</th><th>Priorit√©</th><th>√âch√©ance</th><th>Mesure</th></tr></thead><tbody>${objNewRows}</tbody></table>`:''}
  ${ent.besoins_formation?`<h2>üéì Besoins en formation</h2><p>${ent.besoins_formation}</p>`:''}
  ${ent.salaire_actuel||ent.augmentation?`<h2>üí∞ R√©mun√©ration</h2><p>Salaire actuel : ${ent.salaire_actuel||'‚Äî'} ‚Ç¨ ¬∑ Augmentation : ${ent.augmentation||'0'}% ¬∑ Nouveau salaire : ${ent.nouveau_salaire||'‚Äî'} ‚Ç¨</p>`:''}
  ${ent.conclusions?`<h2>üìã Conclusions</h2><p>${ent.conclusions}</p>`:''}
  <div class="sign-row">
    <div class="sign-box">Signature de l'employeur<br>${ent.date_sign_emp?fmtDate(ent.date_sign_emp):'Date :'}</div>
    <div class="sign-box">Signature du salari√©<br>${ent.date_sign_sal?fmtDate(ent.date_sign_sal):'Date :'}</div>
  </div>
  <p style="font-size:10px;color:#9ca3af;margin-top:24px;text-align:center">Document g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} ¬∑ ALTEORE ‚Äî Confidentiel RH</p>
  </body></html>`);
  win.document.close();
  setTimeout(()=>win.print(),400);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITAIRES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function fmtDate(d){
  if(!d)return'‚Äî';
  try{var dt=new Date(d);return dt.toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric'});}catch(e){return d;}
}
function calcAnciennete(d){
  if(!d)return'‚Äî';
  var diff=Date.now()-new Date(d).getTime();
  var ans=Math.floor(diff/31557600000);
  var mois=Math.floor((diff%31557600000)/2629800000);
  if(ans>=1)return ans+' an'+(ans>1?'s':'')+(mois>0?' '+mois+' mois':'');
  return mois+' mois';
}
function fmtK(v){
  var n=parseFloat(v)||0;
  return n>=1000?(n/1000).toFixed(1)+'k ‚Ç¨':n+' ‚Ç¨';
}
function showToast(msg,type){
  var t=document.getElementById('toast');
  t.textContent=msg;t.className='toast show '+(type||'');
  setTimeout(()=>t.className='toast',3000);
}
function toggleSidebar(){
  var s=document.querySelector('.sidebar');
  var h=document.getElementById('hamburger');
  var o=document.getElementById('nav-overlay');
  if(s){s.classList.toggle('open');h.classList.toggle('open');o.classList.toggle('show');}
}
function closeSidebar(){
  var s=document.querySelector('.sidebar');
  var h=document.getElementById('hamburger');
  var o=document.getElementById('nav-overlay');
  if(s){s.classList.remove('open');h.classList.remove('open');o.classList.remove('show');}
}
</script>

<script src="nav.js"></script>
</body>
</html>
