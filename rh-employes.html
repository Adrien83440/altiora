<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
  <title>ALTEORE ‚Äî Employ√©s</title>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
    :root{
      --rh-dark:#052e16;--rh-main:#059669;--rh-mid:#10b981;--rh-bright:#34d399;
      --rh-ghost:#f0fdf4;--rh-border:#d1fae5;
      --text:#1a1f36;--muted:#6b7280;--border:#e2e8f0;--bg:#f0fdf7;--radius:12px;
      --red:#ef4444;--red-light:#fee2e2;--orange:#f59e0b;--orange-light:#fef3c7;
      --blue:#1a3dce;--purple:#6366f1;--sidebar-w:250px;
    }
    body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px;}
    .main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-width:0;}

    /* TOPBAR */
    .topbar{background:white;border-bottom:1px solid var(--border);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50;}
    .topbar-left h1{font-size:17px;font-weight:700;}
    .topbar-left p{font-size:12px;color:var(--muted);margin-top:2px;}
    .topbar-right{display:flex;align-items:center;gap:8px;}
    .btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .18s;display:inline-flex;align-items:center;gap:6px;}
    .btn-rh{background:linear-gradient(135deg,var(--rh-main),var(--rh-mid));color:white;box-shadow:0 3px 10px rgba(5,150,105,.25);}
    .btn-rh:hover{opacity:.9;transform:translateY(-1px);}
    .btn-outline{background:white;color:var(--rh-main);border:1.5px solid var(--rh-border);}
    .btn-outline:hover{background:var(--rh-ghost);}
    .btn-danger{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;}
    .btn-danger:hover{background:#fecaca;}
    .btn-sm{padding:5px 11px;font-size:12px;}
    .btn-xs{padding:3px 8px;font-size:11px;}

    /* LAYOUT 2 PANNEAUX */
    .workspace{display:flex;flex:1;overflow:hidden;height:calc(100vh - 57px);}

    /* PANEL GAUCHE */
    .left-panel{width:300px;flex-shrink:0;border-right:1px solid var(--border);background:white;display:flex;flex-direction:column;overflow:hidden;}
    .lp-head{padding:12px 14px;border-bottom:1px solid var(--border);}
    .search-wrap{display:flex;gap:7px;margin-bottom:8px;}
    .search-input{flex:1;padding:7px 10px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;outline:none;color:var(--text);}
    .search-input:focus{border-color:var(--rh-main);}
    .filter-row{display:flex;gap:6px;}
    .filter-sel{flex:1;padding:5px 8px;border:1.5px solid var(--border);border-radius:7px;font-family:'Plus Jakarta Sans',sans-serif;font-size:11px;color:var(--text);outline:none;background:white;cursor:pointer;}
    .filter-sel:focus{border-color:var(--rh-main);}
    .emp-list{flex:1;overflow-y:auto;}
    .emp-item{display:flex;align-items:center;gap:9px;padding:10px 14px;cursor:pointer;border-left:3px solid transparent;transition:all .15s;}
    .emp-item[draggable="true"]{user-select:none;}
    .emp-item.drag-over{background:#e0f2fe;border-left-color:#0ea5e9;transform:scale(1.01);}
    .emp-item.dragging{opacity:0.4;background:#f0fdf4;}
    .drag-handle{font-size:14px;color:#d1d5db;cursor:grab;flex-shrink:0;padding:0 2px;transition:color .15s;}
    .drag-handle:hover{color:#6b7280;}
    .drag-handle:active{cursor:grabbing;}
    .emp-item:hover{background:#fafffe;}
    .emp-item.active{background:var(--rh-ghost);border-left-color:var(--rh-main);}
    .emp-av{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;flex-shrink:0;position:relative;}
    .emp-av img{width:34px;height:34px;border-radius:10px;object-fit:cover;}
    .emp-av-fallback{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;border-radius:10px;font-size:13px;font-weight:700;color:white;}
    .emp-info{flex:1;min-width:0;}
    .emp-name{font-size:12px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .emp-sub{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .emp-badge{font-size:9px;font-weight:700;padding:2px 6px;border-radius:20px;white-space:nowrap;flex-shrink:0;}
    .b-cdi{background:#d1fae5;color:#065f46;}
    .b-cdd{background:#fef3c7;color:#92400e;}
    .b-stage{background:#e0f2fe;color:#075985;}
    .b-alternance{background:#eef2ff;color:#3730a3;}
    .b-freelance{background:#fce7f3;color:#9d174d;}
    .b-expire{background:#fee2e2;color:#991b1b;}
    .lp-footer{padding:10px 14px;border-top:1px solid var(--border);font-size:11px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;}

    /* PANEL DROIT */
    .right-panel{flex:1;overflow-y:auto;background:var(--bg);}
    .empty-fiche{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--muted);text-align:center;padding:40px;}
    .empty-fiche .icon{font-size:52px;margin-bottom:16px;}

    /* FICHE */
    .fiche{padding:22px 26px;display:flex;flex-direction:column;gap:18px;}

    /* HERO FICHE */
    .fiche-hero{background:white;border:1px solid var(--border);border-radius:var(--radius);padding:22px 24px;}
    .fiche-hero-top{display:flex;align-items:flex-start;gap:18px;margin-bottom:16px;}
    .fiche-big-av{width:72px;height:72px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:800;color:white;flex-shrink:0;position:relative;cursor:pointer;overflow:hidden;}
    .fiche-big-av:hover .av-overlay{opacity:1;}
    .av-overlay{position:absolute;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;opacity:0;transition:.2s;border-radius:16px;font-size:18px;color:white;}
    .fiche-big-av img{width:72px;height:72px;object-fit:cover;border-radius:16px;}
    .fiche-hero-info{flex:1;}
    .fiche-hero-name{font-size:22px;font-weight:800;line-height:1.1;margin-bottom:4px;}
    .fiche-hero-poste{font-size:14px;color:var(--muted);margin-bottom:10px;}
    .fiche-hero-badges{display:flex;flex-wrap:wrap;gap:6px;}
    .hbadge{font-size:11px;font-weight:600;padding:3px 10px;border-radius:20px;}
    .fiche-hero-actions{display:flex;gap:8px;align-items:flex-start;flex-shrink:0;}
    .fiche-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
    .fkpi{padding:11px 14px;border-radius:9px;background:var(--rh-ghost);border:1px solid var(--rh-border);}
    .fkpi.orange{background:#fef9c3;border-color:#fde68a;}
    .fkpi.red{background:#fee2e2;border-color:#fecaca;}
    .fkpi-label{font-size:9px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px;}
    .fkpi-val{font-size:15px;font-weight:800;color:var(--text);}
    .fkpi-sub{font-size:10px;color:var(--muted);margin-top:2px;}

    /* TABS */
    .tabs{display:flex;gap:2px;background:#f1f5f9;border-radius:10px;padding:3px;}
    .tab{padding:7px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;color:var(--muted);transition:.15s;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;}
    .tab.active{background:white;color:var(--rh-main);box-shadow:0 1px 4px rgba(0,0,0,.08);}

    /* SECTIONS FICHE */
    .fiche-section{background:white;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .sec-head{display:flex;align-items:center;justify-content:space-between;padding:13px 18px;background:#fafffe;border-bottom:1px solid var(--border);}
    .sec-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px;}
    .sec-body{padding:16px 18px;}
    .info-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .info-field{display:flex;flex-direction:column;gap:3px;}
    .info-label{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;}
    .info-val{font-size:13px;font-weight:600;color:var(--text);}
    .info-val.muted{color:var(--muted);font-weight:400;}

    /* DOCUMENTS */
    .doc-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border:1px solid var(--border);border-radius:9px;margin-bottom:8px;transition:.15s;}
    .doc-item:last-child{margin-bottom:0;}
    .doc-item:hover{background:#fafffe;border-color:var(--rh-border);}
    .doc-ico{width:34px;height:34px;border-radius:8px;background:var(--rh-ghost);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
    .doc-name{font-size:12px;font-weight:600;flex:1;}
    .doc-date{font-size:11px;color:var(--muted);}
    .doc-actions{display:flex;gap:5px;}

    /* √âVALUATIONS */
    .eval-item{padding:12px 14px;border:1px solid var(--border);border-radius:9px;margin-bottom:8px;}
    .eval-item:last-child{margin-bottom:0;}
    .eval-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;}
    .eval-date{font-size:11px;color:var(--muted);}
    .eval-note{display:flex;align-items:center;gap:4px;}
    .eval-note-val{font-size:14px;font-weight:800;color:var(--rh-main);}
    .eval-comment{font-size:12px;color:var(--text);line-height:1.5;}
    .eval-by{font-size:10px;color:var(--muted);margin-top:4px;}
    .stars{display:flex;gap:1px;}
    .star-on{color:#f59e0b;font-size:13px;}
    .star-off{color:#e2e8f0;font-size:13px;}

    /* UPLOAD ZONE */
    .upload-zone{border:2px dashed var(--rh-border);border-radius:10px;padding:16px;text-align:center;cursor:pointer;transition:.15s;color:var(--muted);font-size:12px;}
    .upload-zone:hover{border-color:var(--rh-main);background:var(--rh-ghost);}
    .upload-zone input{display:none;}

    /* BOUTONS MODE SALAIRE */
    .sal-mode-btn{padding:6px 11px;border:1.5px solid var(--rh-border);border-radius:7px;font-family:'Plus Jakarta Sans',sans-serif;font-size:11px;font-weight:600;cursor:pointer;background:white;color:var(--muted);transition:.15s;}
    .sal-mode-btn:hover{border-color:var(--rh-main);color:var(--rh-main);}
    .sal-mode-btn.active{background:var(--rh-ghost);border-color:var(--rh-main);color:var(--rh-main);}

    /* P√âRIODE D'ESSAI */
    #pe-bloc{transition:opacity .2s;}
    #pe-bloc.disabled{opacity:.4;pointer-events:none;}

    /* MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(5,46,22,.4);backdrop-filter:blur(4px);z-index:300;display:none;align-items:center;justify-content:center;padding:16px;}
    .modal-overlay.show{display:flex;}
    .modal{background:white;border-radius:16px;width:100%;max-width:600px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 24px 60px rgba(5,46,22,.2);}
    .modal-head{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#f0fdf4,#dcfce7);flex-shrink:0;}
    .modal-head h3{font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
    .modal-close{background:none;border:none;font-size:18px;cursor:pointer;color:var(--muted);padding:2px;}
    .modal-body{padding:20px 22px;overflow-y:auto;flex:1;}
    .modal-foot{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;flex-shrink:0;}
    .mfield{margin-bottom:14px;}
    .mfield label{display:block;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px;}
    .minput{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;color:var(--text);outline:none;transition:.15s;}
    .minput:focus{border-color:var(--rh-main);box-shadow:0 0 0 3px rgba(5,150,105,.08);}
    .mrow{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    .mrow-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
    .msep{font-size:12px;font-weight:700;color:var(--text);padding:8px 0 4px;border-top:1px solid var(--border);margin-top:4px;}

    /* TOAST */
    .toast{position:fixed;bottom:24px;right:24px;background:#052e16;color:white;padding:11px 18px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(80px);opacity:0;transition:all .3s;}
    .toast.show{transform:translateY(0);opacity:1;}
    .toast.ok{background:#065f46;}
    .toast.err{background:#991b1b;}

    .loader{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--muted);gap:8px;}
    @keyframes spin{to{transform:rotate(360deg)}}
    .spin{width:16px;height:16px;border:2px solid var(--rh-border);border-top-color:var(--rh-main);border-radius:50%;animation:spin .7s linear infinite;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
    .fiche{animation:fadeIn .2s ease both;}

    /* ARCHIV√â */
    .emp-item.archived{opacity:.5;}
    .emp-item.archived .emp-name{text-decoration:line-through;}

    /* HAMBURGER MOBILE */
    .hamburger{display:none;}
    @media(max-width:768px){
      .main{margin-left:0!important;}
      .hamburger{display:flex!important;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:#052e16;border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;}
      .hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;}
      .workspace{flex-direction:column;height:auto;}
      .left-panel{width:100%;height:auto;border-right:none;border-bottom:1px solid var(--border);}
      .emp-list{max-height:280px;}
      .topbar{padding:10px 10px 10px 62px!important;flex-wrap:wrap;gap:6px;}
      .topbar-right{width:100%;flex-wrap:wrap;}
      .topbar-right .btn{flex:1;font-size:11px;padding:6px 8px;}
      .fiche-kpis{grid-template-columns:1fr 1fr!important;}
      .mrow,.mrow-3{grid-template-columns:1fr!important;}
      .info-grid{grid-template-columns:1fr!important;}
      .fiche-hero-top{flex-direction:column;align-items:flex-start;}
      .fiche-hero-actions{width:100%;justify-content:flex-start;}
      .modal{max-width:100%;margin:0;border-radius:18px 18px 0 0;max-height:92vh;}
      .modal-overlay{align-items:flex-end;padding:0;}
    }
    @media(max-width:420px){
      .fiche-kpis{grid-template-columns:1fr!important;}
    }
  </style>
</head>
<body>

<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h1>üë§ Employ√©s</h1>
      <p id="emp-count-top">Gestion des fiches employ√©s</p>
    </div>
    <div class="topbar-right">
      <button class="btn btn-outline btn-sm" onclick="location.href='rh-dashboard.html'">‚Üê Dashboard RH</button>
      <button class="btn btn-outline btn-sm" id="btn-show-archived" onclick="toggleArchived()">üëÅ Archiv√©s</button>
      <button class="btn btn-rh btn-sm" onclick="openModalNouvelEmploye()">+ Nouvel employ√©</button>
    </div>
  </div>

  <div class="workspace">
    <!-- LISTE -->
    <div class="left-panel">
      <div class="lp-head">
        <div class="search-wrap">
          <input class="search-input" id="search-emp" placeholder="üîç Rechercher..." oninput="filterEmployes()"/>
        </div>
        <div class="filter-row">
          <select class="filter-sel" id="filter-contrat" onchange="filterEmployes()">
            <option value="">Tous contrats</option>
            <option value="CDI">CDI</option>
            <option value="CDD">CDD</option>
            <option value="Stage">Stage</option>
            <option value="Alternance">Alternance</option>
            <option value="Freelance">Freelance</option>
          </select>
          <select class="filter-sel" id="filter-dept" onchange="filterEmployes()">
            <option value="">Tous d√©partements</option>
          </select>
          <select class="filter-sel" id="filter-statut" onchange="filterEmployes()">
            <option value="actif">Actifs</option>
            <option value="all">Tous</option>
            <option value="archive">Archiv√©s</option>
          </select>
        </div>
      </div>
      <div class="emp-list" id="emp-list">
        <div class="loader"><div class="spin"></div></div>
      </div>
      <div class="lp-footer">
        <span id="emp-list-count">0 employ√©(s)</span>
        <button class="btn btn-rh btn-xs" onclick="openModalNouvelEmploye()">+ Nouveau</button>
      </div>
    </div>

    <!-- FICHE DROITE -->
    <div class="right-panel" id="right-panel">
      <div class="empty-fiche">
        <div class="icon">üë§</div>
        <h3 style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:8px">S√©lectionnez un employ√©</h3>
        <p style="font-size:13px;line-height:1.7;max-width:300px;color:var(--muted)">Cliquez sur un employ√© dans la liste pour afficher sa fiche compl√®te.</p>
        <button class="btn btn-rh" style="margin-top:16px" onclick="openModalNouvelEmploye()">+ Cr√©er un employ√©</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL NOUVEL EMPLOY√â / √âDITION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modalEmploye">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modal-emp-title">üë§ Nouvel employ√©</h3>
      <button class="modal-close" onclick="closeModal('modalEmploye')">‚úï</button>
    </div>
    <div class="modal-body">
      <!-- Identit√© -->
      <div class="msep">üë§ Identit√©</div>
      <div class="mrow">
        <div class="mfield"><label>Pr√©nom *</label><input class="minput" id="f-prenom" placeholder="Marie"/></div>
        <div class="mfield"><label>Nom *</label><input class="minput" id="f-nom" placeholder="DUPONT"/></div>
      </div>
      <div class="mrow">
        <div class="mfield"><label>Date de naissance</label><input class="minput" id="f-naissance" type="date"/></div>
        <div class="mfield"><label>Nationalit√©</label><input class="minput" id="f-nationalite" placeholder="Fran√ßaise"/></div>
      </div>
      <div class="mfield"><label>Adresse</label><input class="minput" id="f-adresse" placeholder="12 rue des Fleurs, 75001 Paris"/></div>
      <div class="mrow">
        <div class="mfield"><label>T√©l√©phone</label><input class="minput" id="f-tel" placeholder="06 12 34 56 78"/></div>
        <div class="mfield"><label>Email</label><input class="minput" id="f-email" type="email" placeholder="marie@email.com"/></div>
      </div>
      <div class="mfield"><label>N¬∞ S√©curit√© sociale</label><input class="minput" id="f-nss" placeholder="1 85 05 75 001 001 01"/></div>

      <!-- Contrat -->
      <div class="msep">üìã Contrat</div>
      <div class="mrow">
        <div class="mfield"><label>Type de contrat *</label>
          <select class="minput" id="f-contrat" onchange="onContratChange()">
            <option value="CDI">CDI</option><option value="CDD">CDD</option>
            <option value="Stage">Stage</option><option value="Alternance">Alternance</option>
            <option value="Freelance">Freelance</option>
          </select>
        </div>
        <div class="mfield"><label>Cat√©gorie *</label>
          <select class="minput" id="f-categorie" onchange="onContratChange()">
            <option value="employe">üë∑ Employ√© / Ouvrier</option>
            <option value="agent_maitrise">üîß Agent de ma√Ætrise / Technicien</option>
            <option value="cadre">üíº Cadre</option>
          </select>
        </div>
      </div>
      <div class="mrow">
        <div class="mfield"><label>Poste / Intitul√© *</label><input class="minput" id="f-poste" placeholder="D√©veloppeur, Vendeur..."/></div>
        <div class="mfield"><label>D√©partement</label><input class="minput" id="f-dept" placeholder="Vente, Production..."/></div>
      </div>
      <div class="mrow">
        <div class="mfield"><label>Date d'entr√©e *</label><input class="minput" id="f-entree" type="date" oninput="onContratChange()"/></div>
        <div class="mfield"><label>Date de fin (CDD/Stage)</label><input class="minput" id="f-fin" type="date" oninput="onContratChange()"/></div>
      </div>

      <!-- P√âRIODE D'ESSAI (affichage conditionnel) -->
      <div id="pe-bloc" style="background:#f0fdf4;border:1.5px solid #d1fae5;border-radius:10px;padding:14px 16px;margin-bottom:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div style="font-size:12px;font-weight:700;color:#059669;display:flex;align-items:center;gap:6px">‚è≥ P√©riode d'essai</div>
          <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px;font-weight:600;color:var(--text)">
            <input type="checkbox" id="pe-active" onchange="onPEChange()" style="accent-color:#059669;width:15px;height:15px;cursor:pointer"/>
            Activer
          </label>
        </div>
        <div id="pe-details" style="display:none">
          <div class="mrow" style="margin-bottom:10px">
            <div class="mfield">
              <label>Dur√©e l√©gale sugg√©r√©e</label>
              <div id="pe-legal-info" style="padding:7px 10px;background:white;border:1.5px solid #d1fae5;border-radius:8px;font-size:12px;font-weight:700;color:#059669">‚Äî</div>
            </div>
            <div class="mfield">
              <label>Dur√©e choisie</label>
              <div style="display:flex;align-items:center;gap:6px">
                <input class="minput" id="pe-duree" type="text" inputmode="decimal" placeholder="2" style="width:60px;text-align:center;font-weight:700" oninput="calcPEFin()"/>
                <select class="minput" id="pe-unite" onchange="calcPEFin()" style="flex:1">
                  <option value="jours">jours</option>
                  <option value="semaines">semaines</option>
                  <option value="mois" selected>mois</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mrow">
            <div class="mfield">
              <label>Renouvellement</label>
              <select class="minput" id="pe-renouv">
                <option value="non">Non pr√©vu</option>
                <option value="oui">Oui (√ó 1)</option>
              </select>
            </div>
            <div class="mfield">
              <label>Date de fin estim√©e</label>
              <div id="pe-fin-info" style="padding:7px 10px;background:white;border:1.5px solid #d1fae5;border-radius:8px;font-size:12px;font-weight:700;color:var(--text)">‚Äî</div>
            </div>
          </div>
          <div id="pe-warn" style="display:none;margin-top:8px;padding:7px 10px;background:#fef3c7;border:1px solid #fde68a;border-radius:7px;font-size:11px;color:#92400e"></div>
        </div>
      </div>

      <div class="mfield"><label>Statut</label>
        <select class="minput" id="f-statut">
          <option value="actif">Actif</option><option value="essai">En p√©riode d'essai</option>
          <option value="archive">Archiv√©</option>
        </select>
      </div>

      <!-- Salaire -->
      <div class="msep">üí∂ R√©mun√©ration <span style="font-size:10px;font-weight:400;color:var(--muted)">‚Äî Saisissez l'un des montants, les autres se calculent automatiquement</span></div>

      <!-- S√©lecteur mode de saisie -->
      <div style="display:flex;gap:6px;margin-bottom:12px" id="sal-mode-btns">
        <button type="button" class="sal-mode-btn active" data-mode="brut" onclick="setSalMode('brut')">üí∞ Brut ‚Üí Net</button>
        <button type="button" class="sal-mode-btn" data-mode="net" onclick="setSalMode('net')">üí≥ Net ‚Üí Brut</button>
        <button type="button" class="sal-mode-btn" data-mode="superbrut" onclick="setSalMode('superbrut')">üè¢ Super-brut ‚Üí Brut</button>
      </div>

      <!-- Les 3 cases toujours visibles -->
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px">
        <div class="mfield">
          <label style="display:flex;align-items:center;justify-content:space-between">
            <span>Super-brut (co√ªt employeur)</span>
            <span style="font-size:9px;background:#f1f5f9;color:#64748b;padding:1px 5px;border-radius:4px;font-weight:600">‚âà brut √ó 1,42</span>
          </label>
          <div style="position:relative">
            <input class="minput" id="f-superbrut" type="text" inputmode="decimal" placeholder="3 550" oninput="calcSalaire('superbrut')"/>
            <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:11px;color:var(--muted);pointer-events:none">‚Ç¨</span>
          </div>
        </div>
        <div class="mfield">
          <label style="display:flex;align-items:center;justify-content:space-between">
            <span>Salaire brut *</span>
            <span style="font-size:9px;background:#d1fae5;color:#065f46;padding:1px 5px;border-radius:4px;font-weight:600">R√©f√©rence</span>
          </label>
          <div style="position:relative">
            <input class="minput" id="f-brut" type="text" inputmode="decimal" placeholder="2 500" oninput="calcSalaire('brut')" style="border-color:#d1fae5;background:#f0fdf4"/>
            <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:11px;color:var(--muted);pointer-events:none">‚Ç¨</span>
          </div>
        </div>
        <div class="mfield">
          <label style="display:flex;align-items:center;justify-content:space-between">
            <span>Salaire net</span>
            <span style="font-size:9px;background:#e0f2fe;color:#075985;padding:1px 5px;border-radius:4px;font-weight:600">‚âà brut √ó 0,77</span>
          </label>
          <div style="position:relative">
            <input class="minput" id="f-net" type="text" inputmode="decimal" placeholder="1 925" oninput="calcSalaire('net')"/>
            <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:11px;color:var(--muted);pointer-events:none">‚Ç¨</span>
          </div>
        </div>
      </div>

      <!-- R√©capitulatif dynamique des cotisations -->
      <div id="sal-recap" style="display:none;background:#1e293b;border-radius:10px;padding:14px 16px;margin-bottom:12px;color:white">
        <div style="font-size:10px;font-weight:700;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">üìä D√©tail des cotisations 2025 ‚Äî <span id="sal-recap-statut" style="color:#34d399"></span></div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
          <div style="text-align:center">
            <div style="font-size:9px;color:rgba(255,255,255,.4);margin-bottom:2px">COTIS. SALARIALES</div>
            <div id="rc-sal" style="font-size:15px;font-weight:800;color:#f87171">‚Äî</div>
            <div id="rc-sal-pct" style="font-size:10px;color:rgba(255,255,255,.4)">~22‚Äì23%</div>
          </div>
          <div style="text-align:center;border-left:1px solid rgba(255,255,255,.1);border-right:1px solid rgba(255,255,255,.1)">
            <div style="font-size:9px;color:rgba(255,255,255,.4);margin-bottom:2px">COTIS. PATRONALES</div>
            <div id="rc-pat" style="font-size:15px;font-weight:800;color:#fb923c">‚Äî</div>
            <div id="rc-pat-pct" style="font-size:10px;color:rgba(255,255,255,.4)">~40‚Äì42%</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:9px;color:rgba(255,255,255,.4);margin-bottom:2px">NET PER√áU</div>
            <div id="rc-net" style="font-size:15px;font-weight:800;color:#34d399">‚Äî</div>
            <div id="rc-net-pct" style="font-size:10px;color:rgba(255,255,255,.4)">~77% du brut</div>
          </div>
        </div>
        <div style="margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,.1);font-size:10px;color:rgba(255,255,255,.35)">
          ‚ö†Ô∏è Estimation indicative bas√©e sur les taux l√©gaux 2025 (URSSAF). Hors r√©duction Fillon, convention collective, mutuelle obligatoire et pr√©l√®vement √† la source.
        </div>
      </div>

      <!-- Ligne du bas : fr√©quence + heures + IBAN -->
      <div class="mrow-3">
        <div class="mfield"><label>Fr√©quence</label>
          <select class="minput" id="f-freq">
            <option value="mensuel">Mensuel</option><option value="annuel">Annuel</option>
            <option value="horaire">Horaire</option>
          </select>
        </div>
        <div class="mfield"><label>Heures / semaine</label><input class="minput" id="f-heures" type="text" inputmode="decimal" placeholder="35"/></div>
        <div class="mfield"><label>IBAN</label><input class="minput" id="f-iban" placeholder="FR76 ..."/></div>
      </div>

      <!-- Administratif & Conformit√© -->
      <div class="msep">üè¶ Administratif &amp; Conformit√©</div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:10px;padding:7px 10px;background:#f0fdf4;border-radius:8px;border:1px solid #d1fae5">
        üîí Ces champs alimentent les v√©rifications de conformit√© RH.
      </div>
      <div class="mrow">
        <div class="mfield">
          <label>Mutuelle (nom + n¬∞ adh√©rent)</label>
          <input class="minput" id="f-mutuelle" placeholder="Ex : Harmonie Mutuelle ‚Äî N¬∞ 123456"/>
        </div>
        <div class="mfield">
          <label>Date DPAE effectu√©e</label>
          <input class="minput" id="f-dpae" type="date"/>
          <div style="font-size:10px;color:var(--muted);margin-top:3px">D√©claration Pr√©alable √† l'Embauche (URSSAF)</div>
        </div>
      </div>
      <div class="mrow">
        <div class="mfield">
          <label>Visite m√©dicale d'embauche</label>
          <input class="minput" id="f-visite-embauche" type="date"/>
        </div>
        <div class="mfield">
          <label>Prochaine visite m√©dicale</label>
          <input class="minput" id="f-visite-prochaine" type="date"/>
        </div>
      </div>
      <div class="mfield">
        <label>Documents re√ßus √† l'embauche</label>
        <div style="display:flex;flex-wrap:wrap;gap:10px;padding:10px 12px;border:1.5px solid var(--border);border-radius:8px;background:#fafbff">
          <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:12px;font-weight:500;color:var(--text);text-transform:none;letter-spacing:0;min-width:160px">
            <input type="checkbox" id="f-doc-cni" style="accent-color:#059669;width:15px;height:15px"/> ü™™ CNI / Passeport
          </label>
          <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:12px;font-weight:500;color:var(--text);text-transform:none;letter-spacing:0;min-width:160px">
            <input type="checkbox" id="f-doc-rib" style="accent-color:#059669;width:15px;height:15px"/> üè¶ RIB original
          </label>
          <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:12px;font-weight:500;color:var(--text);text-transform:none;letter-spacing:0;min-width:160px">
            <input type="checkbox" id="f-doc-vitale" style="accent-color:#059669;width:15px;height:15px"/> üíö Carte Vitale
          </label>
          <label style="display:flex;align-items:center;gap:7px;cursor:pointer;font-size:12px;font-weight:500;color:var(--text);text-transform:none;letter-spacing:0;min-width:160px">
            <input type="checkbox" id="f-doc-contrat" style="accent-color:#059669;width:15px;height:15px"/> üìã Contrat sign√©
          </label>
        </div>
      </div>

      <!-- Convention collective -->
      <div class="msep">‚öñÔ∏è Convention collective <span style="font-size:10px;font-weight:400;color:var(--muted)">‚Äî Laisser vide pour utiliser le d√©faut entreprise</span></div>
      <div class="mrow">
        <div class="mfield" style="grid-column:1/-1">
          <label>Convention collective applicable</label>
          <select class="minput" id="f-ccn" onchange="onCCNChange()">
            <option value="">‚Äî D√©faut entreprise ‚Äî</option>
          </select>
          <div id="f-ccn-note" style="display:none;font-size:11px;color:var(--muted);padding:5px 8px;background:#f8faff;border-radius:6px;margin-top:4px;line-height:1.5"></div>
        </div>
      </div>

      <!-- Divers -->
      <div class="msep">üìù Divers</div>
      <div class="mrow">
        <div class="mfield"><label>Note de bienvenue</label><input class="minput" id="f-note" type="text" inputmode="decimal" placeholder="Note /5"/></div>
        <div class="mfield"><label>Emoji / couleur</label>
          <select class="minput" id="f-couleur">
            <option value="#059669">üü¢ Vert</option><option value="#0891b2">üîµ Bleu</option>
            <option value="#7c3aed">üü£ Violet</option><option value="#db2777">ü©∑ Rose</option>
            <option value="#ea580c">üü† Orange</option><option value="#ca8a04">üü° Jaune</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modalEmploye')">Annuler</button>
      <button class="btn btn-rh" onclick="saveEmploye()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL NOUVELLE √âVALUATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modalEval">
  <div class="modal" style="max-width:440px">
    <div class="modal-head">
      <h3>‚≠ê Nouvelle √©valuation</h3>
      <button class="modal-close" onclick="closeModal('modalEval')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="mfield">
        <label>Note (1 √† 5)</label>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
          <input class="minput" id="eval-note" type="text" inputmode="decimal" placeholder="4.5" style="width:80px"/>
          <div id="eval-stars-preview" style="display:flex;gap:2px;font-size:18px;color:#f59e0b">‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ</div>
        </div>
      </div>
      <div class="mfield"><label>Date</label><input class="minput" id="eval-date" type="date"/></div>
      <div class="mfield"><label>Commentaire</label><textarea class="minput" id="eval-comment" rows="3" placeholder="Points forts, axes d'am√©lioration..."></textarea></div>
      <div class="mfield"><label>√âvaluateur</label><input class="minput" id="eval-by" placeholder="Nom du responsable"/></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modalEval')">Annuler</button>
      <button class="btn btn-rh" onclick="saveEval()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL UPLOAD DOC -->
<div class="modal-overlay" id="modalDoc">
  <div class="modal" style="max-width:420px">
    <div class="modal-head">
      <h3>üìé Ajouter un document</h3>
      <button class="modal-close" onclick="closeModal('modalDoc')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="mfield"><label>Nom du document *</label><input class="minput" id="doc-nom" placeholder="Contrat de travail, CNI..."/></div>
      <div class="mfield"><label>Type</label>
        <select class="minput" id="doc-type">
          <option value="contrat">üìã Contrat de travail</option>
          <option value="cni">ü™™ Pi√®ce d'identit√©</option>
          <option value="rib">üè¶ RIB</option>
          <option value="diplome">üéì Dipl√¥me</option>
          <option value="medical">üè• Certificat m√©dical</option>
          <option value="autre">üìÑ Autre</option>
        </select>
      </div>
      <div class="mfield"><label>Date du document</label><input class="minput" id="doc-date" type="date"/></div>
      <div class="mfield">
        <label>Fichier (r√©f√©rence)</label>
        <input class="minput" id="doc-ref" placeholder="Nom du fichier ou lien Drive"/>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">üí° Renseignez le nom ou le lien vers le document stock√© dans votre espace.</div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modalDoc')">Annuler</button>
      <button class="btn btn-rh" onclick="saveDoc()">Ajouter</button>
    </div>
  </div>
</div>

<!-- MODAL PHOTO -->
<div class="modal-overlay" id="modalPhoto">
  <div class="modal" style="max-width:380px">
    <div class="modal-head">
      <h3>üì∏ Photo de profil</h3>
      <button class="modal-close" onclick="closeModal('modalPhoto')">‚úï</button>
    </div>
    <div class="modal-body" style="text-align:center">
      <div id="photo-preview" style="width:100px;height:100px;border-radius:20px;margin:0 auto 16px;overflow:hidden;background:var(--rh-ghost);display:flex;align-items:center;justify-content:center;font-size:32px"></div>
      <label class="upload-zone">
        <input type="file" id="photo-input" accept="image/*" onchange="previewPhoto(this)"/>
        <div style="font-size:22px;margin-bottom:6px">üì∑</div>
        <div style="font-weight:600">Cliquez pour choisir une photo</div>
        <div style="font-size:11px;margin-top:3px">JPG, PNG ‚Äì max 2Mo</div>
      </label>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modalPhoto')">Annuler</button>
      <button class="btn btn-danger btn-sm" onclick="removePhoto()">Supprimer</button>
      <button class="btn btn-rh" onclick="savePhoto()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODAL ARCHIVAGE -->
<div class="modal-overlay" id="modalArchive">
  <div class="modal" style="max-width:400px">
    <div class="modal-head">
      <h3 id="modal-arch-title">üì¶ Archiver l'employ√©</h3>
      <button class="modal-close" onclick="closeModal('modalArchive')">‚úï</button>
    </div>
    <div class="modal-body">
      <p style="font-size:13px;line-height:1.7;color:var(--muted)">L'employ√© sera marqu√© comme archiv√© et masqu√© par d√©faut. Les donn√©es sont conserv√©es.</p>
      <div class="mfield" style="margin-top:14px"><label>Motif de d√©part</label>
        <select class="minput" id="arch-motif">
          <option value="fin_cdd">Fin de CDD</option>
          <option value="demission">D√©mission</option>
          <option value="licenciement">Licenciement</option>
          <option value="retraite">Retraite</option>
          <option value="rupture">Rupture conventionnelle</option>
          <option value="autre">Autre</option>
        </select>
      </div>
      <div class="mfield"><label>Date de sortie</label><input class="minput" id="arch-date" type="date"/></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('modalArchive')">Annuler</button>
      <button class="btn btn-danger" onclick="confirmArchive()">üì¶ Archiver</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE ‚ïê‚ïê‚ïê -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore, initializeFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp({
    apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",
    authDomain:"altiora-70599.firebaseapp.com",
    projectId:"altiora-70599",
    storageBucket:"altiora-70599.firebasestorage.app",
    messagingSenderId:"120905555746",
    appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"
  });
  const auth = getAuth(app);
  // experimentalAutoDetectLongPolling : corrige l'erreur CORS sur Safari/WebKit
  const db = initializeFirestore(app, { experimentalAutoDetectLongPolling: true });
  window._auth=auth; window._db=db;
  window._doc=doc; window._setDoc=setDoc; window._getDoc=getDoc;
  window._collection=collection; window._getDocs=getDocs;
  window._deleteDoc=deleteDoc; window._updateDoc=updateDoc;

  onAuthStateChanged(auth, user => {
    if (!user) { window.location.href='index.html'; return; }
    window._uid = user.uid;
    window._firebaseReady = true;
    window.initEmployes();
  });
</script>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê APP JS ‚ïê‚ïê‚ïê -->
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// √âTAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _employes    = {};   // { id: {...data} }
let _currentId   = null;
let _editId      = null; // null = nouveau, sinon ID
let _showArchived = false;
let _photoDataURL = null;
let _photoFile    = null;

const COLORS = ['#059669','#0891b2','#7c3aed','#db2777','#ea580c','#ca8a04'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.initEmployes = async function() {
  await loadRHParams();
  await loadEmployes();
};

// Charger les param√®tres RH entreprise (CCN d√©faut, etc.)
async function loadRHParams() {
  try {
    const snap = await window._getDoc(window._doc(window._db,'rh_params',window._uid));
    if(snap.exists()) {
      const d = snap.data();
      if(d.ccnDefault) _ccnDefaultEntreprise = d.ccnDefault;
    }
  } catch(e) { console.warn('Params RH non charg√©s', e); }
}

async function loadEmployes() {
  try {
    const snap = await window._getDocs(window._collection(window._db,'rh',window._uid,'employes'));
    _employes = {};
    snap.forEach(d => { _employes[d.id] = { id:d.id, ...d.data() }; });
    buildDeptFilter();
    renderList();
  } catch(e) {
    console.error(e);
    showToast('Erreur chargement','err');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LISTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildDeptFilter() {
  const depts = [...new Set(Object.values(_employes).map(e=>e.departement).filter(Boolean))];
  const sel = document.getElementById('filter-dept');
  const cur = sel.value;
  sel.innerHTML = '<option value="">Tous d√©partements</option>' +
    depts.map(d=>`<option value="${d}" ${d===cur?'selected':''}>${d}</option>`).join('');
}

function filterEmployes() { renderList(); }

function renderList() {
  const search  = (document.getElementById('search-emp')?.value||'').toLowerCase();
  const contrat = document.getElementById('filter-contrat')?.value||'';
  const dept    = document.getElementById('filter-dept')?.value||'';
  const statut  = document.getElementById('filter-statut')?.value||'actif';

  let items = Object.values(_employes).filter(e => {
    const nom = `${e.prenom||''} ${e.nom||''}`.toLowerCase();
    const matchSearch = !search || nom.includes(search) || (e.poste||'').toLowerCase().includes(search);
    const matchContrat = !contrat || e.typeContrat === contrat;
    const matchDept = !dept || e.departement === dept;
    const matchStatut = statut==='all' ? true : statut==='archive' ? e.statut==='archive' : e.statut!=='archive';
    return matchSearch && matchContrat && matchDept && matchStatut;
  });

  // Trier : actifs d'abord, puis alphab√©tique
  items.sort((a,b)=>{
    if (a.statut==='archive' && b.statut!=='archive') return 1;
    if (a.statut!=='archive' && b.statut==='archive') return -1;
    return `${a.prenom} ${a.nom}`.localeCompare(`${b.prenom} ${b.nom}`);
  });

  const list = document.getElementById('emp-list');
  const count = document.getElementById('emp-list-count');
  const topCount = document.getElementById('emp-count-top');
  const total = Object.values(_employes).filter(e=>e.statut!=='archive').length;
  count.textContent = `${items.length} employ√©(s)`;
  topCount.textContent = `${total} employ√©${total>1?'s':''} actif${total>1?'s':''}`;

  if (items.length === 0) {
    list.innerHTML = `<div style="padding:24px;text-align:center;color:var(--muted);font-size:12px">
      <div style="font-size:28px;margin-bottom:8px">üë§</div>Aucun employ√© trouv√©.<br>
      <button class="btn btn-rh btn-sm" style="margin-top:12px" onclick="openModalNouvelEmploye()">+ Ajouter</button></div>`;
    return;
  }

  list.innerHTML = items.map(e => {
    const nom = `${e.prenom||''} ${e.nom||''}`.trim()||'Employ√©';
    const init = nom.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
    const color = e.couleur || COLORS[0];
    const badgeCls = getBadgeCls(e.typeContrat);
    const archived = e.statut==='archive';

    // CDD expirant ?
    let expireSoon = false;
    if (e.typeContrat==='CDD' && e.dateFinContrat) {
      const j = Math.ceil((new Date(e.dateFinContrat)-Date.now())/86400000);
      if (j>=0 && j<=30) expireSoon = true;
    }

    return `<div class="emp-item ${_currentId===e.id?'active':''} ${archived?'archived':''}"
      draggable="true"
      data-id="${e.id}"
      onclick="handleEmpItemClick(event,'${e.id}')"
      ondragstart="onDragStart(event,'${e.id}')"
      ondragover="onDragOver(event)"
      ondragleave="onDragLeave(event)"
      ondrop="onDrop(event,'${e.id}')">
      <span class="drag-handle" title="D√©placer" onclick="event.stopPropagation()">‚†ø</span>
      <div class="emp-av" style="background:${color}">
        ${e.photoURL ? `<img src="${e.photoURL}" alt="${nom}" onerror="this.style.display='none'"/>` : ''}
        <div class="emp-av-fallback" style="background:${color}">${init}</div>
      </div>
      <div class="emp-info">
        <div class="emp-name">${nom}</div>
        <div class="emp-sub">${e.poste||'‚Äî'}${e.departement?' ¬∑ '+e.departement:''}</div>
      </div>
      <span class="emp-badge ${expireSoon?'b-expire':badgeCls}">${expireSoon?'‚ö†Ô∏è CDD':e.typeContrat||'CDI'}</span>
    </div>`;
  }).join('');
}

function getBadgeCls(type) {
  return {CDI:'b-cdi',CDD:'b-cdd',Stage:'b-stage',Alternance:'b-alternance',Freelance:'b-freelance'}[type]||'b-cdi';
}

function toggleArchived() {
  _showArchived = !_showArchived;
  const sel = document.getElementById('filter-statut');
  sel.value = _showArchived ? 'all' : 'actif';
  document.getElementById('btn-show-archived').style.background = _showArchived ? 'var(--rh-ghost)' : '';
  renderList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FICHE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _dragId = null;
let _dragOrder = []; // ordre personnalis√© [{id, order}]

function handleEmpItemClick(e, id) {
  if (e.target.classList.contains('drag-handle')) return;
  openFiche(id);
}

function onDragStart(e, id) {
  _dragId = id;
  e.currentTarget.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', id);
}

function onDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  const item = e.currentTarget;
  if (!item.classList.contains('dragging')) {
    item.classList.add('drag-over');
  }
}

function onDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}

function onDrop(e, targetId) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (!_dragId || _dragId === targetId) { _dragId = null; return; }

  // R√©organiser l'ordre dans _employes
  const list = document.getElementById('emp-list');
  const allItems = [...list.querySelectorAll('.emp-item[data-id]')];
  const ids = allItems.map(el => el.dataset.id);

  const fromIdx = ids.indexOf(_dragId);
  const toIdx   = ids.indexOf(targetId);
  if (fromIdx === -1 || toIdx === -1) { _dragId = null; return; }

  // Appliquer le nouvel ordre
  ids.splice(fromIdx, 1);
  ids.splice(toIdx, 0, _dragId);

  // Persister l'ordre localement + mettre √† jour l'affichage
  _empOrder = ids;
  _dragId = null;

  // Re-render avec le nouvel ordre
  renderListOrdered(ids);
}

// Ordre personnalis√© (stock√© en m√©moire ‚Äî reset au reload)
let _empOrder = null;

function renderListOrdered(orderedIds) {
  const list = document.getElementById('emp-list');
  const ordered = orderedIds.map(id => _employes[id]).filter(Boolean);

  // Recr√©er les items dans le nouvel ordre
  list.innerHTML = ordered.map(e => {
    const nom = `${e.prenom||''} ${e.nom||''}`.trim()||'Employ√©';
    const init = nom.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
    const color = e.couleur || COLORS[0];
    const badgeCls = getBadgeCls(e.typeContrat);
    const archived = e.statut==='archive';
    let expireSoon = false;
    if (e.typeContrat==='CDD' && e.dateFinContrat) {
      const j = Math.ceil((new Date(e.dateFinContrat)-Date.now())/86400000);
      if (j>=0 && j<=30) expireSoon = true;
    }
    return `<div class="emp-item ${_currentId===e.id?'active':''} ${archived?'archived':''}"
      draggable="true" data-id="${e.id}"
      onclick="handleEmpItemClick(event,'${e.id}')"
      ondragstart="onDragStart(event,'${e.id}')"
      ondragover="onDragOver(event)"
      ondragleave="onDragLeave(event)"
      ondrop="onDrop(event,'${e.id}')">
      <span class="drag-handle" title="D√©placer" onclick="event.stopPropagation()">‚†ø</span>
      <div class="emp-av" style="background:${color}">
        ${e.photoURL ? `<img src="${e.photoURL}" alt="${nom}" onerror="this.style.display='none'"/>` : ''}
        <div class="emp-av-fallback" style="background:${color}">${init}</div>
      </div>
      <div class="emp-info">
        <div class="emp-name">${nom}</div>
        <div class="emp-sub">${e.poste||'‚Äî'}${e.departement?' ¬∑ '+e.departement:''}</div>
      </div>
      <span class="emp-badge ${expireSoon?'b-expire':badgeCls}">${expireSoon?'‚ö†Ô∏è CDD':e.typeContrat||'CDI'}</span>
    </div>`;
  }).join('');

  // R√©activer fin de drag
  list.querySelectorAll('.emp-item[draggable]').forEach(el => {
    el.addEventListener('dragend', () => el.classList.remove('dragging'));
  });
}

window.handleEmpItemClick = handleEmpItemClick;
window.onDragStart = onDragStart;
window.onDragOver = onDragOver;
window.onDragLeave = onDragLeave;
window.onDrop = onDrop;



// ‚îÄ‚îÄ TOGGLE DOC RE√áU (clic direct sur badge) ‚îÄ‚îÄ
async function toggleDocRecu(empId, field, currentVal) {
  if (!window._uid || !window._updateDoc || !window._doc || !window._db) return;
  const newVal = !currentVal;
  try {
    await window._updateDoc(
      window._doc(window._db, 'rh', window._uid, 'employes', empId),
      { [field]: newVal }
    );
    // Mettre √† jour l'√©tat local et re-render
    if (_employes[empId]) {
      _employes[empId][field] = newVal;
      renderFiche(_employes[empId]);
    }
  } catch(e) {
    console.error('toggleDocRecu error:', e);
  }
}
window.toggleDocRecu = toggleDocRecu;

function openFiche(id) {
  _currentId = id;
  renderList(); // update active state
  const e = _employes[id];
  if (!e) return;
  renderFiche(e);
}

function renderFiche(e) {
  const nom = `${e.prenom||''} ${e.nom||''}`.trim()||'Employ√©';
  const init = nom.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
  const color = e.couleur || COLORS[0];
  const badgeCls = getBadgeCls(e.typeContrat);

  // Anciennet√©
  const anc = e.dateEntree ? calcAnciennete(e.dateEntree) : '‚Äî';

  // Jours avant fin CDD
  let cddWarning = '';
  if (e.typeContrat==='CDD' && e.dateFinContrat) {
    const j = Math.ceil((new Date(e.dateFinContrat)-Date.now())/86400000);
    if (j>=0 && j<=30) cddWarning = `<span style="background:#fee2e2;color:#991b1b;font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px">‚ö†Ô∏è Expire dans ${j}j</span>`;
  }

  // Note moyenne
  const evals = e.evaluations||[];
  const noteMoy = evals.length>0 ? (evals.reduce((s,ev)=>s+(parseFloat(ev.note)||0),0)/evals.length).toFixed(1) : null;

  const rp = document.getElementById('right-panel');
  rp.innerHTML = `
  <div class="fiche" id="fiche-content">

    <!-- HERO -->
    <div class="fiche-hero">
      <div class="fiche-hero-top">
        <div class="fiche-big-av" style="background:${color}" onclick="openModalPhoto('${e.id}')">
          ${e.photoURL ? `<img src="${e.photoURL}" alt="${nom}" onerror="this.style.display='none'"/>` : ''}
          <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:800;color:white;${e.photoURL?'opacity:0':''};" id="av-initiales">${init}</div>
          <div class="av-overlay">üì∑</div>
        </div>
        <div class="fiche-hero-info">
          <div class="fiche-hero-name">${nom}</div>
          <div class="fiche-hero-poste">${e.poste||'Poste non renseign√©'}${e.departement?' ¬∑ '+e.departement:''}</div>
          <div class="fiche-hero-badges">
            <span class="hbadge ${badgeCls}">${e.typeContrat||'CDI'}</span>
            ${e.statut==='essai'?'<span class="hbadge" style="background:#e0f2fe;color:#075985">P√©riode d\'essai</span>':''}
            ${e.statut==='archive'?'<span class="hbadge" style="background:#f1f5f9;color:#64748b">Archiv√©</span>':''}
            ${cddWarning}
            ${noteMoy?`<span class="hbadge" style="background:#fef9c3;color:#92400e">‚≠ê ${noteMoy}/5</span>`:''}
          </div>
        </div>
        <div class="fiche-hero-actions">
          <button class="btn btn-outline btn-sm" onclick="openModalEdit('${e.id}')">‚úèÔ∏è Modifier</button>
          <button class="btn btn-outline btn-sm" onclick="exportPDF('${e.id}')">üìÑ PDF</button>
          <button class="btn btn-danger btn-sm" onclick="${e.statut==='archive'?`restoreEmploye('${e.id}')`:`openModalArchive('${e.id}')`}">${e.statut==='archive'?'‚ôªÔ∏è Restaurer':'üì¶ Archiver'}</button>
        </div>
      </div>

      <!-- KPIs RAPIDES -->
      <div class="fiche-kpis">
        <div class="fkpi">
          <div class="fkpi-label">Salaire net</div>
          <div class="fkpi-val">${e.salaireNet?fmtE(e.salaireNet):'‚Äî'}</div>
          <div class="fkpi-sub">${e.frequence||'mensuel'}</div>
        </div>
        <div class="fkpi">
          <div class="fkpi-label">Co√ªt employeur</div>
          <div class="fkpi-val">${e.salaireSuperBrut?fmtE(e.salaireSuperBrut):'‚Äî'}</div>
          <div class="fkpi-sub">Super-brut</div>
        </div>
        <div class="fkpi ${e.typeContrat==='CDD'&&e.dateFinContrat?'orange':''}">
          <div class="fkpi-label">Fin de contrat</div>
          <div class="fkpi-val">${e.dateFinContrat||'CDI'}</div>
          <div class="fkpi-sub">${e.typeContrat||'‚Äî'} ¬∑ ${e.categoriePoste==='cadre'?'Cadre':e.categoriePoste==='agent_maitrise'?'Agent ma√Ætrise':'Employ√©'}</div>
        </div>
        <div class="fkpi ${e.periodeEssai?.active?'orange':''}">
          <div class="fkpi-label">P√©riode d'essai</div>
          <div class="fkpi-val">${e.periodeEssai?.active?`${e.periodeEssai.duree} ${e.periodeEssai.unite}`:'‚Äî'}</div>
          <div class="fkpi-sub">${e.periodeEssai?.active?`Fin : ${e.periodeEssai.finEstimee||'‚Äî'}`:'Non configur√©e'}</div>
        </div>
      </div>
    </div>

    <!-- TABS -->
    <div class="tabs" id="fiche-tabs">
      <button class="tab active" onclick="showTab('infos',this)">üë§ Infos</button>
      <button class="tab" onclick="showTab('contrat',this)">üìã Contrat</button>
      <button class="tab" onclick="showTab('docs',this)">üìé Documents</button>
      <button class="tab" onclick="showTab('evals',this)">‚≠ê √âvaluations</button>
      <button class="tab" onclick="showTab('entretiens',this);loadEntretiensTab('${e.id}')">üéØ Entretiens</button>
    </div>

    <!-- TAB INFOS -->
    <div class="fiche-section" id="tab-infos">
      <div class="sec-head"><div class="sec-title">üë§ Informations personnelles</div><button class="btn btn-outline btn-xs" onclick="openModalEdit('${e.id}')">‚úèÔ∏è</button></div>
      <div class="sec-body">
        <div class="info-grid">
          ${infoField('Pr√©nom',e.prenom)}
          ${infoField('Nom',e.nom)}
          ${infoField('Date de naissance',fmtDate(e.dateNaissance))}
          ${infoField('Nationalit√©',e.nationalite)}
          ${infoField('T√©l√©phone',e.telephone)}
          ${infoField('Email',e.email)}
          ${infoField('Adresse',e.adresse,true)}
          ${infoField('N¬∞ S√©curit√© sociale',e.nss ? maskNSS(e.nss) : null)}
        </div>
      </div>
    </div>

    <!-- TAB CONTRAT -->
    <div class="fiche-section" id="tab-contrat" style="display:none">
      <div class="sec-head"><div class="sec-title">üìã Informations contractuelles</div><button class="btn btn-outline btn-xs" onclick="openModalEdit('${e.id}')">‚úèÔ∏è</button></div>
      <div class="sec-body">
        <div class="info-grid">
          ${infoField('Type de contrat',e.typeContrat)}
          ${infoField('Statut',e.statut)}
          ${infoField('Poste',e.poste)}
          ${infoField('D√©partement',e.departement)}
          ${infoField('Date d\'entr√©e',fmtDate(e.dateEntree))}
          ${infoField('Date de fin',fmtDate(e.dateFinContrat))}
          ${e.ccn && CCN_RULES[e.ccn] ? infoField('Convention collective','<span style="font-size:11px">'+CCN_RULES[e.ccn].label+(CCN_RULES[e.ccn].idcc?' <span style=\'color:var(--muted);font-weight:400\'>(IDCC '+CCN_RULES[e.ccn].idcc+')</span>':'')+'</span>') : infoField('Convention collective','‚Äî D√©faut entreprise ‚Äî')}
        </div>
        <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">
          <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">üí∂ R√©mun√©ration</div>
          <div class="info-grid">
            ${infoField('Salaire brut',e.salaireBrut?fmtE(e.salaireBrut):null)}
            ${infoField('Salaire net',e.salaireNet?fmtE(e.salaireNet):null)}
            ${infoField('Fr√©quence',e.frequence||'mensuel')}
            ${infoField('Heures hebdo',(e.heuresHebdo||35)+'h')}
            ${infoField('IBAN',e.iban ? maskIBAN(e.iban) : null)}
          </div>
        </div>
        <!-- Administratif & Conformit√© -->
        <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">
          <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">üè¶ Administratif &amp; Conformit√©</div>
          <div class="info-grid">
            ${infoField('Mutuelle', e.mutuelle)}
            ${infoField('DPAE effectu√©e', e.dpaeDate ? fmtDate(e.dpaeDate) : null)}
            ${infoField('Visite m√©dicale embauche', e.dateVisiteMedicale ? fmtDate(e.dateVisiteMedicale) : null)}
            ${infoField('Prochaine visite', e.prochaineSuiviMedical ? fmtDate(e.prochaineSuiviMedical) : null)}
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:10px">
            ${[
              {key:'docCniRecu',   src:'cni',     icon:'ü™™', label:'CNI'},
              {key:'docRibRecu',   src:'rib',     icon:'üè¶', label:'RIB'},
              {key:'docVitaleRecu',src:'vitale',  icon:'üíö', label:'Carte Vitale'},
              {key:'docContratRecu',src:'contrat',icon:'üìã', label:'Contrat sign√©'},
            ].map(d => {
              const ok = e[d.key] || (e.documents||[]).some(doc=>doc.type===d.src);
              return '<button onclick="toggleDocRecu(\'' + e.id + '\',\'' + d.key + '\',' + (ok?'true':'false') + ')" title="Cliquer pour '+(ok?'marquer comme non re√ßu':'marquer comme re√ßu')+'" style="font-size:11px;font-weight:600;padding:4px 10px;border-radius:20px;background:'+(ok?'#dcfce7':'#fef2f2')+';color:'+(ok?'#166534':'#991b1b')+';border:1.5px solid '+(ok?'#6ee7b7':'#fca5a5')+';cursor:pointer;transition:all .15s" onmouseover="this.style.opacity=.75" onmouseout="this.style.opacity=1">'+(ok?'‚úÖ':'‚ùå')+' '+d.icon+' '+d.label+'</button>';
            }).join('')}
          </div>
          </div>
        </div>

        <!-- LIEN PORTAIL SALARI√â -->
        <div style="margin-top:14px;padding:13px 15px;background:#f0fdf4;border:1.5px solid #bbf7d0;border-radius:10px">
          <div style="font-size:11px;font-weight:700;color:#065f46;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üîó Portail salari√© ‚Äî Espace cong√©s</div>
          ${e.publicId ? `
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
              <code id="lien-sal-${e.id}" style="font-size:11px;background:white;border:1px solid #d1fae5;padding:5px 9px;border-radius:6px;color:#047857;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">https://alteore.com/espace-salarie.html?id=${e.publicId}</code>
              <button class="btn btn-rh btn-xs" style="flex-shrink:0" onclick="copyLienSalarie('${e.id}','${e.publicId}')">üìã Copier</button>
            </div>
            <div style="font-size:10px;color:#6b7280;margin-top:5px">Envoyez ce lien √† l\'employ√© ¬∑ Il acc√®de √† ses soldes et peut faire ses demandes de cong√©s.</div>
          ` : `
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
              <div style="font-size:12px;color:#6b7280">Cet employ√© n\'a pas encore de lien portail (cr√©√© avant la mise √† jour).</div>
              <button class="btn btn-rh btn-xs" style="flex-shrink:0" onclick="genererLienSalarie('${e.id}')">üîó G√©n√©rer le lien</button>
            </div>
          `}
        </div>
      </div>
    </div>

    <!-- TAB DOCUMENTS -->
    <div class="fiche-section" id="tab-docs" style="display:none">
      <div class="sec-head">
        <div class="sec-title">üìé Documents RH</div>
        <button class="btn btn-rh btn-xs" onclick="openModalDoc('${e.id}')">+ Ajouter</button>
      </div>
      <div class="sec-body" id="docs-body-${e.id}">
        ${renderDocs(e)}
      </div>
    </div>

    <!-- TAB √âVALUATIONS -->
    <div class="fiche-section" id="tab-evals" style="display:none">
      <div class="sec-head">
        <div class="sec-title">‚≠ê √âvaluations <span style="font-size:10px;font-weight:400;color:var(--muted)">${evals.length} entr√©e${evals.length>1?'s':''}</span></div>
        <button class="btn btn-rh btn-xs" onclick="openModalEval('${e.id}')">+ √âvaluer</button>
      </div>
      <div class="sec-body" id="evals-body-${e.id}">
        ${renderEvals(e)}
      </div>
    </div>

    <!-- TAB ENTRETIENS ANNUELS -->
    <div class="fiche-section" id="tab-entretiens" style="display:none">
      <div class="sec-head">
        <div class="sec-title">üéØ Entretiens annuels</div>
        <div style="display:flex;gap:6px">
          <a href="rh-entretiens.html" class="btn btn-outline btn-xs" style="text-decoration:none">üìÇ Module entretiens</a>
          <button class="btn btn-rh btn-xs" onclick="createEntretienFromFiche('${e.id}')">+ Nouvel entretien</button>
        </div>
      </div>
      <div class="sec-body" id="entretiens-body-${e.id}">
        <div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">
          <div style="font-size:24px;margin-bottom:6px">‚è≥</div>Chargement...
        </div>
      </div>
    </div>

  </div>`;
}

function showTab(tab, btn) {
  ['infos','contrat','docs','evals','entretiens'].forEach(t => {
    const el = document.getElementById('tab-'+t);
    if (el) el.style.display = t===tab ? '' : 'none';
  });
  document.querySelectorAll('#fiche-tabs .tab').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
}

function infoField(label, val, full=false) {
  return `<div class="info-field${full?' style="grid-column:1/-1"':''}">
    <div class="info-label">${label}</div>
    <div class="info-val ${!val?'muted':''}">${val||'Non renseign√©'}</div>
  </div>`;
}

function renderDocs(e) {
  const docs = e.documents||[];
  if (docs.length===0) return `<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">
    <div style="font-size:24px;margin-bottom:6px">üìé</div>Aucun document.<br>
    <button class="btn btn-outline btn-sm" style="margin-top:10px" onclick="openModalDoc('${e.id}')">+ Ajouter un document</button></div>`;

  const docIcons = {contrat:'üìã',cni:'ü™™',rib:'üè¶',diplome:'üéì',medical:'üè•',autre:'üìÑ'};
  return docs.map((d,i)=>`
    <div class="doc-item">
      <div class="doc-ico">${docIcons[d.type]||'üìÑ'}</div>
      <div style="flex:1;min-width:0">
        <div class="doc-name">${d.nom||'Document'}</div>
        <div class="doc-date">${d.date?fmtDate(d.date):''} ${d.ref?'¬∑ '+d.ref:''}</div>
      </div>
      <div class="doc-actions">
        <button class="btn btn-danger btn-xs" onclick="deleteDoc('${e.id}',${i})">üóë</button>
      </div>
    </div>`).join('');
}

function renderEvals(e) {
  const evals = (e.evaluations||[]).slice().reverse();
  if (evals.length===0) return `<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">
    <div style="font-size:24px;margin-bottom:6px">‚≠ê</div>Aucune √©valuation.<br>
    <button class="btn btn-outline btn-sm" style="margin-top:10px" onclick="openModalEval('${e.id}')">+ √âvaluer</button></div>`;

  return evals.map((ev,i)=>`
    <div class="eval-item">
      <div class="eval-header">
        <span class="eval-date">${ev.date?fmtDate(ev.date):'‚Äî'}</span>
        <div class="eval-note">
          ${renderStars(parseFloat(ev.note)||0)}
          <span class="eval-note-val">${parseFloat(ev.note)||0}/5</span>
        </div>
      </div>
      ${ev.commentaire?`<div class="eval-comment">"${ev.commentaire}"</div>`:''}
      <div class="eval-by">Par ${ev.evaluateur||'‚Äî'}</div>
    </div>`).join('');
}

function renderStars(note) {
  let html = '<div class="stars">';
  for (let i=1;i<=5;i++) {
    html += `<span class="${i<=note?'star-on':'star-off'}">‚òÖ</span>`;
  }
  return html+'</div>';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODAL EMPLOY√â
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// CONVENTIONS COLLECTIVES ‚Äî Sources : IDCC l√©gaux, L√©gifrance, fiches pratiques
// Champs : jourMax (h), hebdoMax (h), hebdoMoyMax (h/12sem), reposMin (h),
//          pauseApres (h ‚Üí d√©clenchement pause), pauseMin (min), note (info cl√©)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CCN_RULES = {
  "droit_commun": {
    label:"Code du travail", idcc:null,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"Art. L3121-18 : 10h/j max ¬∑ Art. L3121-20 : 48h/sem ¬∑ Art. L3121-33 : pause 20 min apr√®s 6h",
    primes:[], anciennete:[], treizieme:false, mutuelle:"Selon accord", congesPayes:25, rtts:0
  },
  "chr": {
    label:"H√¥tels-Caf√©s-Restaurants (CHR)", idcc:1979,
    jourMax:11.5, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 1979 ¬∑ Amplitude 13h max ¬∑ HS major√©es 10% d√®s 36h ¬∑ Repos hebdo 2j cons√©cutifs",
    primes:[
      {nom:"Indemnit√© nourriture", montant:"4,10 ‚Ç¨/repas", obligatoire:true, note:"En nature ou compensatrice (1 √† 2 repas/jour selon poste)"},
      {nom:"Majoration nuit", montant:"+10% min", obligatoire:true, note:"Travail entre 22h et 7h"},
      {nom:"Prime dimanche", montant:"+10% min", obligatoire:true, note:"Si travail habituel le dimanche"},
      {nom:"Prime anciennet√©", montant:"Voir grille CCN", obligatoire:true, note:"D√®s 1 an : +1% du SMIC ¬∑ 2 ans : +2% ¬∑ etc."}
    ],
    anciennete:[{annees:1,pct:1},{annees:2,pct:2},{annees:3,pct:3},{annees:5,pct:4},{annees:10,pct:6},{annees:15,pct:8}],
    treizieme:false, mutuelle:"Obligatoire (OCIANE, MUTEX‚Ä¶)", congesPayes:25, rtts:0
  },
  "restauration_rapide": {
    label:"Restauration rapide", idcc:1501,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 1501 ¬∑ Modulation annuelle possible ¬∑ Temps partiel fr√©quent (plannings variables)",
    primes:[
      {nom:"Indemnit√© nourriture", montant:"3,88 ‚Ç¨/repas", obligatoire:true, note:"Si pas de repas gratuit fourni"},
      {nom:"Prime habillage", montant:"~1% du salaire mensuel", obligatoire:false, note:"Si tenue obligatoire impos√©e par l'employeur"},
      {nom:"Majoration heures de nuit", montant:"+10%", obligatoire:true, note:"Entre 21h et 6h"}
    ],
    anciennete:[{annees:3,pct:1},{annees:5,pct:2},{annees:8,pct:3},{annees:12,pct:4}],
    treizieme:false, mutuelle:"Obligatoire", congesPayes:25, rtts:0
  },
  "commerce": {
    label:"Commerce de d√©tail non alimentaire", idcc:1517,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 1517 ¬∑ Modulation ¬∑ Dimanche exceptionnel possible",
    primes:[
      {nom:"Prime anciennet√©", montant:"3% d√®s 3 ans", obligatoire:true, note:"3% √† 3 ans ¬∑ 6% √† 6 ans ¬∑ 9% √† 9 ans ¬∑ +1%/an"},
      {nom:"Prime de dimanche", montant:"+25%", obligatoire:true, note:"Si travail habituel le dimanche"},
      {nom:"Prime de panier", montant:"Selon accord", obligatoire:false, note:"Si plus de 6h de travail effectif"}
    ],
    anciennete:[{annees:3,pct:3},{annees:6,pct:6},{annees:9,pct:9},{annees:12,pct:12},{annees:15,pct:15}],
    treizieme:true, mutuelle:"Obligatoire", congesPayes:25, rtts:0
  },
  "commerce_alimentaire": {
    label:"Commerce alimentaire (supermarch√©s)", idcc:2216,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 2216 ¬∑ Travail dominical fr√©quent ¬∑ Pause pay√©e 20 min apr√®s 6h",
    primes:[
      {nom:"Prime de dimanche", montant:"+25% ou +30%", obligatoire:true, note:"Selon avenant ou accord d'entreprise"},
      {nom:"Prime anciennet√©", montant:"+2% d√®s 3 ans", obligatoire:true, note:"2% √† 3 ans ¬∑ 4% √† 6 ans ¬∑ 6% √† 9 ans"},
      {nom:"Prime de vacances", montant:"1/10e des cong√©s", obligatoire:true, note:"Vers√©e avec le salaire de juin"},
      {nom:"Indemnit√© repas", montant:"Selon accord", obligatoire:false, note:"Pour temps de travail sup√©rieur √† 6h"}
    ],
    anciennete:[{annees:3,pct:2},{annees:6,pct:4},{annees:9,pct:6},{annees:12,pct:8},{annees:15,pct:10}],
    treizieme:true, mutuelle:"Obligatoire", congesPayes:25, rtts:0
  },
  "grande_distribution": {
    label:"Grande distribution", idcc:2216,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 2216 ¬∑ Amplitude max 12h ¬∑ Repos hebdo dimanche si possible",
    primes:[
      {nom:"Prime de dimanche", montant:"+25% ou +30%", obligatoire:true, note:"Selon accord d'entreprise"},
      {nom:"Prime anciennet√©", montant:"+2% √† +10%", obligatoire:true, note:"Progression par paliers de 3 ans"},
      {nom:"13e mois", montant:"1 mois de salaire brut", obligatoire:true, note:"G√©n√©ralement vers√© en novembre/d√©cembre"},
      {nom:"Prime de vacances", montant:"1/10e masse cong√©s", obligatoire:true, note:"Vers√©e en juin"}
    ],
    anciennete:[{annees:3,pct:2},{annees:6,pct:4},{annees:9,pct:6},{annees:12,pct:8},{annees:15,pct:10}],
    treizieme:true, mutuelle:"Obligatoire", congesPayes:25, rtts:0
  },
  "boulangerie": {
    label:"Boulangerie-P√¢tisserie artisanale", idcc:843,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 843 ¬∑ Travail de nuit courant ¬∑ Majoration nuit +25% ¬∑ Repos hebdo lundi fr√©quent",
    primes:[
      {nom:"Prime de nuit", montant:"+25% min", obligatoire:true, note:"Travail avant 5h ou apr√®s 21h"},
      {nom:"Prime dimanche et jours f√©ri√©s", montant:"+25%", obligatoire:true, note:"Pour chaque dimanche/f√©ri√© travaill√©"},
      {nom:"Prime anciennet√©", montant:"+2% d√®s 3 ans", obligatoire:true, note:"2% √† 3 ans ¬∑ 4% √† 6 ans ¬∑ 6% √† 9 ans"},
      {nom:"Indemnit√© repas", montant:"5,12 ‚Ç¨/repas", obligatoire:true, note:"Si repas pris sur le lieu de travail"}
    ],
    anciennete:[{annees:3,pct:2},{annees:6,pct:4},{annees:9,pct:6},{annees:12,pct:8}],
    treizieme:false, mutuelle:"Obligatoire (PROBTP ou autre)", congesPayes:25, rtts:0
  },
  "patisserie": {
    label:"P√¢tisserie (entreprises artisanales)", idcc:1267,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 1267 ¬∑ Nuit possible ¬∑ Dimanche travaill√© major√©",
    primes:[
      {nom:"Prime de nuit", montant:"+25%", obligatoire:true, note:"Travail de nuit (avant 6h ou apr√®s 20h)"},
      {nom:"Prime anciennet√©", montant:"+2%/3 ans", obligatoire:true, note:"2% √† 3 ans ¬∑ 4% √† 6 ans ¬∑ 6% √† 9 ans"},
      {nom:"Indemnit√© repas", montant:"Selon CCN", obligatoire:true, note:"En nature ou compensatrice"}
    ],
    anciennete:[{annees:3,pct:2},{annees:6,pct:4},{annees:9,pct:6},{annees:12,pct:8}],
    treizieme:false, mutuelle:"Obligatoire", congesPayes:25, rtts:0
  },
  "boucherie": {
    label:"Boucherie-Charcuterie artisanale", idcc:953,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 953 ¬∑ Horaires t√¥t le matin ¬∑ Dimanche matin courant",
    primes:[
      {nom:"Prime anciennet√©", montant:"+2%/3 ans", obligatoire:true, note:"2% √† 3 ans ¬∑ 4% √† 6 ans ¬∑ 6% √† 9 ans"},
      {nom:"Prime dimanche", montant:"+25%", obligatoire:true, note:"Dimanche travaill√© major√© 25%"},
      {nom:"Indemnit√© habillement", montant:"Selon accord", obligatoire:false, note:"Si tenue de travail obligatoire"}
    ],
    anciennete:[{annees:3,pct:2},{annees:6,pct:4},{annees:9,pct:6},{annees:12,pct:8}],
    treizieme:false, mutuelle:"Obligatoire", congesPayes:25, rtts:0
  },
  "btp": {
    label:"B√¢timent (BTP ouvriers)", idcc:1597,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 1597 ¬∑ Modulation annuelle ¬∑ Intemp√©ries ¬∑ Grand d√©placement",
    primes:[
      {nom:"Indemnit√© trajet/d√©placement", montant:"Variable (grille zonale)", obligatoire:true, note:"Petit ou grand d√©placement selon distance chantier"},
      {nom:"Prime anciennet√©", montant:"+3% √† +10%", obligatoire:true, note:"3% √† 3 ans ¬∑ 5% √† 5 ans ¬∑ 7% √† 7 ans ¬∑ 10% √† 10 ans"},
      {nom:"Prime de panier", montant:"10,30 ‚Ç¨ min/jour", obligatoire:true, note:"Si repas pris hors domicile sur chantier"},
      {nom:"Indemnit√© intemp√©ries", montant:"Prise en charge FNTP", obligatoire:true, note:"Ch√¥mage intemp√©ries : cotisation CNETP"},
      {nom:"Cong√©s pay√©s BTP", montant:"G√©r√©s par la CIBTP", obligatoire:true, note:"Taux 18% du brut cong√©s pay√©s BTP"}
    ],
    anciennete:[{annees:3,pct:3},{annees:5,pct:5},{annees:7,pct:7},{annees:10,pct:10}],
    treizieme:false, mutuelle:"Obligatoire (PRO BTP)", congesPayes:30, rtts:0
  },
  "btp_etam": {
    label:"BTP ‚Äî ETAM (techniciens/agents de ma√Ætrise)", idcc:2609,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 2609 ¬∑ Forfait jours possible pour cadres ¬∑ RTT",
    primes:[
      {nom:"Prime anciennet√©", montant:"+1%/an jusqu'√† 15%", obligatoire:true, note:"1% par an, plafonn√©e √† 15%"},
      {nom:"Indemnit√© de d√©placement", montant:"Grille zonale BTP", obligatoire:true, note:"Selon distance domicile-chantier"},
      {nom:"Prime de 13e mois", montant:"1 mois de salaire", obligatoire:true, note:"Vers√©e en d√©cembre dans la majorit√© des accords"},
      {nom:"Prime de vacances", montant:"1/10e cong√©s pay√©s", obligatoire:true, note:"Vers√©e avec le d√©part en cong√© principal"}
    ],
    anciennete:[{annees:1,pct:1},{annees:2,pct:2},{annees:3,pct:3},{annees:5,pct:5},{annees:10,pct:10},{annees:15,pct:15}],
    treizieme:true, mutuelle:"Obligatoire (PRO BTP)", congesPayes:25, rtts:12
  },
  "coiffure": {
    label:"Coiffure", idcc:2596,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 2596 ¬∑ Repos dimanche + 1 autre jour ¬∑ Samedi travaill√© courant",
    primes:[
      {nom:"Prime anciennet√©", montant:"+3% d√®s 3 ans", obligatoire:true, note:"3% √† 3 ans ¬∑ 6% √† 6 ans ¬∑ 9% √† 9 ans"},
      {nom:"Prime service/pourboires", montant:"Variable", obligatoire:false, note:"Redistribution possible via prime mensuelle"},
      {nom:"Indemnit√© repas", montant:"Selon accord", obligatoire:false, note:"Si travail en coupure sans retour domicile"}
    ],
    anciennete:[{annees:3,pct:3},{annees:6,pct:6},{annees:9,pct:9}],
    treizieme:false, mutuelle:"Obligatoire", congesPayes:25, rtts:0
  },
  "esthetique": {
    label:"Esth√©tique-Cosm√©tique-Parfumerie", idcc:3032,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 3032 ¬∑ Temps partiel fr√©quent ¬∑ Salons ouverts samedi/dimanche",
    primes:[
      {nom:"Prime anciennet√©", montant:"+1% d√®s 3 ans", obligatoire:true, note:"1% √† 3 ans ¬∑ 2% √† 6 ans ¬∑ 3% √† 9 ans"},
      {nom:"Prime commission/r√©sultats", montant:"Variable", obligatoire:false, note:"Souvent int√©gr√©e dans la r√©mun√©ration variable produits"}
    ],
    anciennete:[{annees:3,pct:1},{annees:6,pct:2},{annees:9,pct:3}],
    treizieme:false, mutuelle:"Obligatoire", congesPayes:25, rtts:0
  },
  "sante": {
    label:"Sant√© (FEHAP / EHPAD)", idcc:29,
    jourMax:12, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 29 ¬∑ Gardes 12h autoris√©es ¬∑ Cycles de 4 semaines",
    primes:[
      {nom:"Prime anciennet√©", montant:"+1% d√®s 1 an", obligatoire:true, note:"1% √† 1 an ¬∑ 2% √† 2 ans ¬∑ ‚Ä¶ ¬∑ 15% √† 15 ans"},
      {nom:"Prime de nuit", montant:"+9,15 ‚Ç¨ min/nuit", obligatoire:true, note:"Pour chaque nuit travaill√©e (21h-6h)"},
      {nom:"Prime dimanche/jours f√©ri√©s", montant:"+16,85 ‚Ç¨/jour", obligatoire:true, note:"Pour chaque dimanche et jour f√©ri√© travaill√©"},
      {nom:"Suj√©tions sp√©ciales handicap", montant:"+3,03 ‚Ç¨/h", obligatoire:true, note:"Structures accueillant des personnes handicap√©es"},
      {nom:"13e mois", montant:"1 mois de salaire", obligatoire:true, note:"Vers√© en d√©cembre"}
    ],
    anciennete:[{annees:1,pct:1},{annees:2,pct:2},{annees:3,pct:3},{annees:5,pct:5},{annees:10,pct:10},{annees:15,pct:15}],
    treizieme:true, mutuelle:"Obligatoire", congesPayes:25, rtts:18
  },
  "transport": {
    label:"Transports routiers", idcc:16,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 16 ¬∑ Modulation ¬∑ Temps de service r√©glement√© CE 561/2006",
    primes:[
      {nom:"Prime de fin d'ann√©e", montant:"1 mois de salaire", obligatoire:true, note:"√âquivalent 13e mois (accord de branche)"},
      {nom:"Indemnit√© de repas", montant:"16,20 ‚Ç¨ min (grand d√©placement)", obligatoire:true, note:"Petite restauration : 8,10 ‚Ç¨ ¬∑ D√©jeuner : 16,20 ‚Ç¨"},
      {nom:"Prime anciennet√©", montant:"+2% d√®s 2 ans", obligatoire:true, note:"2% √† 2 ans ¬∑ 4% √† 5 ans ¬∑ 6% √† 8 ans ¬∑ 8% √† 12 ans"},
      {nom:"Prime de nuit", montant:"+20%", obligatoire:true, note:"Conduite entre 22h et 5h"}
    ],
    anciennete:[{annees:2,pct:2},{annees:5,pct:4},{annees:8,pct:6},{annees:12,pct:8}],
    treizieme:true, mutuelle:"Obligatoire", congesPayes:25, rtts:0
  },
  "metallurgie": {
    label:"M√©tallurgie (nouvelle CCN 2024)", idcc:1672,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 1672 ¬∑ Nouvelle CCN 2024 (fusion) ¬∑ Forfait-jours ¬∑ Classifications A √† H",
    primes:[
      {nom:"Prime anciennet√©", montant:"+3% √† 5 ans", obligatoire:true, note:"3% √† 5 ans ¬∑ 5% √† 10 ans ¬∑ 8% √† 15 ans ¬∑ 12% √† 20 ans"},
      {nom:"13e mois", montant:"1 mois brut", obligatoire:true, note:"Maintenu depuis les anciens accords m√©tallurgie"},
      {nom:"Prime panier de nuit", montant:"7,10 ‚Ç¨ min", obligatoire:true, note:"Pour tout travail de nuit (21h-6h)"},
      {nom:"Majoration heures de nuit", montant:"+25% √† +50%", obligatoire:true, note:"+25% avant 22h/apr√®s 5h ¬∑ +50% entre 22h et 5h"}
    ],
    anciennete:[{annees:5,pct:3},{annees:10,pct:5},{annees:15,pct:8},{annees:20,pct:12}],
    treizieme:true, mutuelle:"Obligatoire", congesPayes:25, rtts:0
  },
  "syntec": {
    label:"Syntec (Ing√©nieurs et Cadres)", idcc:1486,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 1486 ¬∑ Forfait-jours cadres ¬∑ 218j/an max ¬∑ RTT nombreux",
    primes:[
      {nom:"Prime de vacances", montant:"30% de la masse CP", obligatoire:true, note:"Vers√©e avec les cong√©s pay√©s (art. 23 de la CCN)"},
      {nom:"Prime anciennet√© ETAM", montant:"+1%/an jusqu'√† 7%", obligatoire:true, note:"Pour les ETAM : +1% par an, plafonn√© √† 7%"},
      {nom:"Ticket restaurant", montant:"60% pris en charge min", obligatoire:false, note:"Pratique quasi-syst√©matique dans la branche"},
      {nom:"Mutuelle + pr√©voyance", montant:"50% employeur", obligatoire:true, note:"Minimum l√©gal + surcompl√©mentaire fr√©quente"}
    ],
    anciennete:[{annees:1,pct:1},{annees:2,pct:2},{annees:3,pct:3},{annees:4,pct:4},{annees:5,pct:5},{annees:6,pct:6},{annees:7,pct:7}],
    treizieme:false, mutuelle:"Obligatoire (50% employeur)", congesPayes:25, rtts:15
  },
  "bureaux_entreprise": {
    label:"Bureaux d'√©tudes techniques (BET)", idcc:1486,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 1486 ¬∑ Identique Syntec pour les BET ¬∑ 218 jours forfait cadres",
    primes:[
      {nom:"Prime de vacances", montant:"30% masse CP", obligatoire:true, note:"Obligation conventionnelle Syntec/BET"},
      {nom:"Prime anciennet√© ETAM", montant:"+1%/an jusqu'√† 7%", obligatoire:true, note:"Plafonn√©e √† 7% pour ETAM"}
    ],
    anciennete:[{annees:1,pct:1},{annees:2,pct:2},{annees:3,pct:3},{annees:5,pct:5},{annees:7,pct:7}],
    treizieme:false, mutuelle:"Obligatoire", congesPayes:25, rtts:15
  },
  "immobilier": {
    label:"Immobilier (agents et gestionnaires)", idcc:1527,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 1527 ¬∑ Forfait-jours cadres ¬∑ Commissions variables ¬∑ RTT",
    primes:[
      {nom:"Commission sur transactions", montant:"Variable (% CA)", obligatoire:false, note:"Pr√©vue dans le contrat ‚Äî r√©glement√©e par la CCN"},
      {nom:"Prime anciennet√©", montant:"+2%/3 ans", obligatoire:true, note:"2% √† 3 ans ¬∑ 4% √† 6 ans ¬∑ 6% √† 9 ans ¬∑ 8% √† 12 ans"},
      {nom:"13e mois", montant:"1 mois de salaire", obligatoire:true, note:"Pr√©vu dans de nombreux accords d'entreprise du secteur"}
    ],
    anciennete:[{annees:3,pct:2},{annees:6,pct:4},{annees:9,pct:6},{annees:12,pct:8}],
    treizieme:true, mutuelle:"Obligatoire", congesPayes:25, rtts:12
  },
  "agriculture": {
    label:"Production agricole", idcc:7252,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 7252 ¬∑ Saisons ¬∑ Modulation annuelle ¬∑ Travail saisonnier courant",
    primes:[
      {nom:"Prime de fin de saison", montant:"Selon accord", obligatoire:false, note:"Variable selon culture et r√©gion"},
      {nom:"Indemnit√© repas", montant:"4,40 ‚Ç¨ min", obligatoire:true, note:"Si repas non fourni sur le lieu de travail"},
      {nom:"Prime anciennet√©", montant:"+2% d√®s 3 ans", obligatoire:false, note:"2% √† 3 ans ¬∑ 4% √† 6 ans (accord de branche)"}
    ],
    anciennete:[{annees:3,pct:2},{annees:6,pct:4}],
    treizieme:false, mutuelle:"Obligatoire (CCMSA)", congesPayes:25, rtts:0
  },
  "proprete": {
    label:"Propret√© et services associ√©s", idcc:3043,
    jourMax:10, hebdoMax:48, hebdoMoyMax:44, reposMin:11, pauseApres:6, pauseMin:20,
    note:"IDCC 3043 ¬∑ Amplitude 13h possible ¬∑ Horaires d√©cal√©s (matin/soir)",
    primes:[
      {nom:"Prime anciennet√©", montant:"+2% d√®s 3 ans", obligatoire:true, note:"2% √† 3 ans ¬∑ 4% √† 6 ans ¬∑ 6% √† 9 ans ¬∑ 8% √† 12 ans"},
      {nom:"Prime de salissure", montant:"~15-20 ‚Ç¨/mois", obligatoire:false, note:"Si travaux particuli√®rement salissants"},
      {nom:"Prime de nuit", montant:"+20%", obligatoire:true, note:"Entre 21h et 6h"},
      {nom:"Indemnit√© transport", montant:"50% titre de transport", obligatoire:true, note:"Remboursement l√©gal abonnement transports en commun"}
    ],
    anciennete:[{annees:3,pct:2},{annees:6,pct:4},{annees:9,pct:6},{annees:12,pct:8}],
    treizieme:false, mutuelle:"Obligatoire", congesPayes:25, rtts:0
  },
  "securite": {
    label:"Entreprises de s√©curit√© priv√©e", idcc:1351,
    jourMax:12, hebdoMax:48, hebdoMoyMax:44, reposMin:12, pauseApres:6, pauseMin:20,
    note:"IDCC 1351 ¬∑ Amplitude 12h ¬∑ Cycles de garde ¬∑ Vacation longue",
    primes:[
      {nom:"Prime anciennet√©", montant:"+1%/an jusqu'√† 7%", obligatoire:true, note:"1% par an, plafond 7% √† 7 ans"},
      {nom:"Prime de nuit", montant:"+10% min", obligatoire:true, note:"Travail entre 21h et 6h"},
      {nom:"Prime dimanches et jours f√©ri√©s", montant:"+10% min", obligatoire:true, note:"Pour chaque dimanche/f√©ri√© travaill√©"},
      {nom:"Prime de tenue", montant:"~20 ‚Ç¨/mois", obligatoire:false, note:"Entretien de la tenue obligatoire"},
      {nom:"13e mois", montant:"1 mois de salaire", obligatoire:false, note:"Pr√©vu dans certains accords d'entreprise"}
    ],
    anciennete:[{annees:1,pct:1},{annees:2,pct:2},{annees:3,pct:3},{annees:4,pct:4},{annees:5,pct:5},{annees:6,pct:6},{annees:7,pct:7}],
    treizieme:false, mutuelle:"Obligatoire", congesPayes:25, rtts:0
  }
};

// Groupes pour affichage dans les selects
const CCN_GROUPS = [
  { label: 'üìÑ Droit commun', keys: ['droit_commun'] },
  { label: 'üçΩÔ∏è H√¥tellerie / Restauration', keys: ['chr','restauration_rapide'] },
  { label: 'üõí Commerce / Distribution', keys: ['commerce','commerce_alimentaire','grande_distribution'] },
  { label: 'ü•ñ Alimentation artisanale', keys: ['boulangerie','patisserie','boucherie'] },
  { label: 'üèóÔ∏è BTP / Artisanat', keys: ['btp','btp_etam'] },
  { label: 'üíá Coiffure / Esth√©tique', keys: ['coiffure','esthetique'] },
  { label: 'üè• Sant√© / M√©dico-social', keys: ['sante','cabinet_medical','pharmacie'] },
  { label: 'üßπ Nettoyage / Propret√©', keys: ['nettoyage'] },
  { label: 'üöõ Transport', keys: ['transport_routier','transport_voyageurs'] },
  { label: 'üöó Automobile', keys: ['automobile'] },
  { label: 'üè† Immobilier', keys: ['immobilier'] },
  { label: 'üîí S√©curit√©', keys: ['securite'] },
  { label: 'üåæ Agriculture', keys: ['agriculture','viticulture'] },
  { label: 'ü§ù Services √† la personne', keys: ['sap','aide_domicile'] },
];

// Convention par d√©faut entreprise (charg√©e depuis Firestore)
let _ccnDefaultEntreprise = '';

// Peupler le select CCN
function populateCCNSelect(selId, currentVal) {
  const el = document.getElementById(selId);
  if(!el) return;
  const firstOpt = el.querySelector('option[value=""]');
  // Vider sauf option vide
  el.innerHTML = '<option value="">‚Äî D√©faut entreprise' + (_ccnDefaultEntreprise && CCN_RULES[_ccnDefaultEntreprise] ? ' (' + CCN_RULES[_ccnDefaultEntreprise].label + ')' : '') + ' ‚Äî</option>';
  CCN_GROUPS.forEach(g => {
    const og = document.createElement('optgroup');
    og.label = g.label;
    g.keys.forEach(k => {
      const opt = document.createElement('option');
      opt.value = k;
      opt.textContent = CCN_RULES[k]?.label || k;
      if(k === currentVal) opt.selected = true;
      og.appendChild(opt);
    });
    el.appendChild(og);
  });
}

// Afficher la note de la CCN s√©lectionn√©e
function onCCNChange() {
  const sel = document.getElementById("f-ccn");
  const note = document.getElementById("f-ccn-note");
  if(!sel || !note) return;
  const key = sel.value;
  const rule = CCN_RULES[key];
  if(!rule) { note.style.display="none"; return; }

  // Primes HTML
  let primesHtml = "";
  if((rule.primes||[]).length > 0) {
    const items = rule.primes.map(p => {
      const bg = p.obligatoire ? "#f0fdf4" : "#fafafa";
      const border = p.obligatoire ? "#d1fae5" : "#f1f5f9";
      const icon = p.obligatoire ? "‚úÖ" : "‚ÑπÔ∏è";
      return `<div style="display:flex;align-items:flex-start;gap:8px;margin-bottom:6px;padding:7px 9px;background:${bg};border:1px solid ${border};border-radius:7px">
        <span style="flex-shrink:0;font-size:12px">${icon}</span>
        <div style="flex:1;min-width:0">
          <div style="font-size:11px;font-weight:700;color:#111827">${p.nom} <span style="font-weight:600;color:#059669">‚Äî ${p.montant}</span></div>
          <div style="font-size:10px;color:#6b7280;margin-top:2px">${p.note}</div>
        </div>
      </div>`;
    }).join("");
    primesHtml = `<div style="margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0">
      <div style="font-size:10px;font-weight:700;color:#374151;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üí∂ Primes &amp; Indemnit√©s obligatoires</div>
      ${items}
    </div>`;
  }

  // Anciennet√© HTML
  let ancHtml = "";
  if((rule.anciennete||[]).length > 0) {
    const badges = rule.anciennete.map(a =>
      `<span style="font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;background:#eff6ff;color:#1d4ed8;border:1px solid #bfdbfe">${a.annees}an${a.annees>1?"s":""} : +${a.pct}%</span>`
    ).join("");
    ancHtml = `<div style="margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0">
      <div style="font-size:10px;font-weight:700;color:#374151;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px">üìà Grille d'anciennet√©</div>
      <div style="display:flex;flex-wrap:wrap;gap:5px">${badges}</div>
    </div>`;
  }

  // Badges infos compl√©mentaires
  const treizBadge = rule.treizieme ? `<span style="font-size:11px;font-weight:700;padding:4px 10px;background:#fefce8;border:1px solid #fde047;border-radius:20px;color:#713f12">üéÅ 13e mois obligatoire</span>` : "";
  const cpBadge = `<span style="font-size:11px;font-weight:600;padding:4px 10px;background:#f0f4ff;border:1px solid #c7d2fe;border-radius:20px;color:#3730a3">üèñ ${rule.congesPayes||25} jours CP/an</span>`;
  const rttBadge = rule.rtts > 0 ? `<span style="font-size:11px;font-weight:600;padding:4px 10px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:20px;color:#065f46">‚è≥ ${rule.rtts} RTT/an</span>` : "";
  const mutBadge = rule.mutuelle ? `<span style="font-size:11px;font-weight:600;padding:4px 10px;background:#fdf4ff;border:1px solid #e9d5ff;border-radius:20px;color:#6b21a8">üè• ${rule.mutuelle}</span>` : "";
  const infosHtml = `<div style="margin-top:10px;padding-top:10px;border-top:1px solid #e2e8f0;display:flex;flex-wrap:wrap;gap:6px">${treizBadge}${cpBadge}${rttBadge}${mutBadge}</div>`;

  const idccBadge = rule.idcc ? `<span style="font-size:11px;font-weight:600;padding:2px 8px;background:#f0f4ff;border-radius:20px;color:#4f46e5">IDCC ${rule.idcc}</span>` : "";

  note.style.display = "";
  note.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <strong style="font-size:13px">${rule.label}</strong>
      ${idccBadge}
    </div>
    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px">
      <span style="font-size:11px;font-weight:700;padding:3px 9px;background:#f1f5f9;border-radius:6px">‚è± Jour max : ${rule.jourMax}h</span>
      <span style="font-size:11px;font-weight:700;padding:3px 9px;background:#f1f5f9;border-radius:6px">üìÖ Hebdo max : ${rule.hebdoMax}h</span>
      <span style="font-size:11px;font-weight:700;padding:3px 9px;background:#f1f5f9;border-radius:6px">‚òï Pause : ${rule.pauseMin} min / ${rule.pauseApres}h</span>
      <span style="font-size:11px;font-weight:700;padding:3px 9px;background:#f1f5f9;border-radius:6px">üåô Repos : ${rule.reposMin}h</span>
    </div>
    <div style="font-size:11px;color:#6b7280;font-style:italic">${rule.note||""}</div>
    ${infosHtml}
    ${primesHtml}
    ${ancHtml}
    <div style="margin-top:12px;padding-top:10px;border-top:1px dashed #e2e8f0">
      <div style="font-size:10px;font-weight:700;color:#374151;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">‚úèÔ∏è Notes personnalis√©es (modifications manuelles)</div>
      <textarea id="ccn-custom-note" rows="3" style="width:100%;padding:8px 10px;border:1.5px solid #e2e8f0;border-radius:8px;font-family:inherit;font-size:12px;color:#374151;resize:vertical;outline:none" placeholder="Ex : Prime anciennet√© n√©goci√©e √† +4% d√®s 2 ans ¬∑ Accord d'entreprise sur 13e mois...">${window._ccnCustomNotes && window._ccnCustomNotes[key] ? window._ccnCustomNotes[key] : ""}</textarea>
      <div style="display:flex;justify-content:flex-end;margin-top:4px">
        <button onclick="saveCCNCustomNote('${key}')" style="font-size:11px;font-weight:700;padding:5px 12px;background:#1a3dce;color:white;border:none;border-radius:7px;cursor:pointer">üíæ Sauvegarder ma note</button>
      </div>
    </div>
  `;
}
window.onCCNChange = onCCNChange;

// Stockage notes personnalis√©es CCN (en m√©moire + Firestore)
window._ccnCustomNotes = {};

async function saveCCNCustomNote(ccnKey) {
  const textarea = document.getElementById("ccn-custom-note");
  if(!textarea) return;
  const val = textarea.value.trim();
  window._ccnCustomNotes[ccnKey] = val;
  // Persister en Firestore si uid dispo
  if(window._uid && window._setDoc && window._doc && window._db) {
    try {
      await window._setDoc(
        window._doc(window._db, "rh", window._uid, "ccn_notes", "custom"),
        window._ccnCustomNotes,
        {merge:true}
      );
      // Feedback visuel
      const btn = document.querySelector("[onclick*='saveCCNCustomNote']");
      if(btn) { btn.textContent = "‚úÖ Sauvegard√©"; setTimeout(()=>{ btn.textContent = "üíæ Sauvegarder ma note"; }, 2000); }
    } catch(e) { console.warn("Erreur sauvegarde CCN note:", e); }
  }
}
window.saveCCNCustomNote = saveCCNCustomNote;

// Charger les notes custom au d√©marrage
async function loadCCNCustomNotes() {
  if(!window._uid || !window._getDoc || !window._doc || !window._db) return;
  try {
    const snap = await window._getDoc(window._doc(window._db, "rh", window._uid, "ccn_notes", "custom"));
    if(snap.exists()) window._ccnCustomNotes = snap.data() || {};
  } catch(e) { /* ignore */ }
}

window.openModalNouvelEmploye = function() {
  _editId = null;
  _photoDataURL = null;
  document.getElementById('modal-emp-title').textContent = 'üë§ Nouvel employ√©';
  populateCCNSelect('f-ccn', '');
  ['prenom','nom','naissance','nationalite','adresse','tel','email','nss',
   'poste','dept','entree','fin','brut','net','heures','iban','note','superbrut'].forEach(k => {
    const el = document.getElementById('f-'+k);
    if (el) el.value = '';
  });
  document.getElementById('f-contrat').value   = 'CDI';
  document.getElementById('f-categorie').value  = 'employe';
  document.getElementById('f-statut').value    = 'actif';
  document.getElementById('f-freq').value      = 'mensuel';
  document.getElementById('f-couleur').value   = COLORS[0];
  document.getElementById('f-entree').value    = new Date().toISOString().slice(0,10);
  // Reset PE
  const peActive = document.getElementById('pe-active');
  const peDetails = document.getElementById('pe-details');
  const peDuree = document.getElementById('pe-duree');
  if (peActive) { peActive.checked = false; }
  if (peDetails) peDetails.style.display = 'none';
  if (peDuree) peDuree.value = '';
  clearSalRecap();
  setTimeout(()=>onContratChange(), 50);
  openModal('modalEmploye');
};

window.openModalEdit = function(id) {
  const e = _employes[id];
  if (!e) return;
  _editId = id;
  _photoDataURL = null;
  document.getElementById('modal-emp-title').textContent = `‚úèÔ∏è Modifier ‚Äî ${e.prenom||''} ${e.nom||''}`;
  const set = (fid, val) => { const el=document.getElementById('f-'+fid); if(el) el.value=val||''; };
  set('prenom',e.prenom); set('nom',e.nom); set('naissance',e.dateNaissance);
  set('nationalite',e.nationalite); set('adresse',e.adresse); set('tel',e.telephone);
  set('email',e.email); set('nss',e.nss); set('poste',e.poste); set('dept',e.departement);
  set('entree',e.dateEntree); set('fin',e.dateFinContrat);
  set('brut',e.salaireBrut); set('net',e.salaireNet); set('heures',e.heuresHebdo||35);
  set('iban',e.iban); set('note',e.noteMoyenne||'');
  // Champs Administratif & Conformit√©
  const setEl = (id, val) => { const el=document.getElementById(id); if(el) el.value=val||''; };
  const setChk = (id, val) => { const el=document.getElementById(id); if(el) el.checked=!!val; };
  setEl('f-mutuelle', e.mutuelle);
  setEl('f-dpae', e.dpaeDate);
  setEl('f-visite-embauche', e.dateVisiteMedicale);
  setEl('f-visite-prochaine', e.prochaineSuiviMedical);
  const _docs = e.documents||[];
  setChk('f-doc-cni',     e.docCniRecu     || _docs.some(d=>d.type==='cni'));
  setChk('f-doc-rib',     e.docRibRecu     || _docs.some(d=>d.type==='rib'));
  setChk('f-doc-vitale',  e.docVitaleRecu  || _docs.some(d=>d.type==='vitale'));
  setChk('f-doc-contrat', e.docContratRecu || _docs.some(d=>d.type==='contrat'));
  const sbEl = document.getElementById('f-superbrut');
  if (sbEl) sbEl.value = e.salaireSuperBrut||'';
  document.getElementById('f-contrat').value  = e.typeContrat||'CDI';
  document.getElementById('f-categorie').value= e.categoriePoste||'employe';
  document.getElementById('f-statut').value   = e.statut||'actif';
  document.getElementById('f-freq').value     = e.frequence||'mensuel';
  document.getElementById('f-couleur').value  = e.couleur||COLORS[0];
  // CCN
  populateCCNSelect('f-ccn', e.ccn||'');
  onCCNChange();
  // P√©riode d'essai
  const pe = e.periodeEssai||{active:false};
  const peActive = document.getElementById('pe-active');
  const peDetails = document.getElementById('pe-details');
  if (peActive) { peActive.checked = !!pe.active; if(peDetails) peDetails.style.display = pe.active?'':'none'; }
  if (pe.active) {
    const d=document.getElementById('pe-duree'); if(d) d.value=pe.duree||'';
    const u=document.getElementById('pe-unite'); if(u) u.value=pe.unite||'mois';
    const r=document.getElementById('pe-renouv'); if(r) r.value=pe.renouvelable?'oui':'non';
  }
  // Afficher recap salaire si brut renseign√©
  if (e.salaireBrut) setTimeout(()=>calcSalaire('brut'), 50);
  // D√©clencher recalcul PE
  setTimeout(()=>onContratChange(), 50);
  openModal('modalEmploye');
};

window.saveEmploye = async function() {
  const prenom = document.getElementById('f-prenom').value.trim();
  const nom    = document.getElementById('f-nom').value.trim();
  if (!prenom||!nom) { showToast('Pr√©nom et nom obligatoires','err'); return; }

  const data = {
    prenom, nom,
    dateNaissance:   document.getElementById('f-naissance').value||null,
    nationalite:     document.getElementById('f-nationalite').value.trim()||null,
    adresse:         document.getElementById('f-adresse').value.trim()||null,
    telephone:       document.getElementById('f-tel').value.trim()||null,
    email:           document.getElementById('f-email').value.trim()||null,
    nss:             document.getElementById('f-nss').value.trim()||null,
    typeContrat:     document.getElementById('f-contrat').value,
    categoriePoste:  document.getElementById('f-categorie').value,
    statut:          document.getElementById('f-statut').value,
    poste:           document.getElementById('f-poste').value.trim()||null,
    departement:     document.getElementById('f-dept').value.trim()||null,
    dateEntree:      document.getElementById('f-entree').value||null,
    dateFinContrat:  document.getElementById('f-fin').value||null,
    salaireBrut:     parseFloat(document.getElementById('f-brut').value.replace(',','.'))||null,
    salaireNet:      parseFloat(document.getElementById('f-net').value.replace(',','.'))||null,
    salaireSuperBrut:parseFloat(document.getElementById('f-superbrut').value.replace(',','.'))||null,
    frequence:       document.getElementById('f-freq').value,
    heuresHebdo:     parseFloat(document.getElementById('f-heures').value)||35,
    iban:            document.getElementById('f-iban').value.trim()||null,
    mutuelle:        document.getElementById('f-mutuelle')?.value.trim()||null,
    dpaeDate:        document.getElementById('f-dpae')?.value||null,
    dateVisiteMedicale:    document.getElementById('f-visite-embauche')?.value||null,
    prochaineSuiviMedical: document.getElementById('f-visite-prochaine')?.value||null,
    docCniRecu:      document.getElementById('f-doc-cni')?.checked||false,
    docRibRecu:      document.getElementById('f-doc-rib')?.checked||false,
    docVitaleRecu:   document.getElementById('f-doc-vitale')?.checked||false,
    docContratRecu:  document.getElementById('f-doc-contrat')?.checked||false,
    ccn:             document.getElementById('f-ccn').value||null,
    couleur:         document.getElementById('f-couleur').value,
    // P√©riode d'essai
    periodeEssai: document.getElementById('pe-active')?.checked ? {
      active:    true,
      duree:     parseFloat(document.getElementById('pe-duree')?.value)||0,
      unite:     document.getElementById('pe-unite')?.value||'mois',
      renouvelable: document.getElementById('pe-renouv')?.value === 'oui',
      finEstimee: document.getElementById('pe-fin-info')?.textContent||null,
    } : { active: false },
    updatedAt:       Date.now()
  };

  const id = _editId || ('emp_'+Date.now());
  if (!_editId) data.createdAt = Date.now();

  // Conserver les donn√©es existantes (docs, evals, photo, publicId)
  if (_editId && _employes[_editId]) {
    data.documents  = _employes[_editId].documents  || [];
    data.evaluations= _employes[_editId].evaluations|| [];
    data.photoURL   = _employes[_editId].photoURL   || null;
    data.noteMoyenne= _employes[_editId].noteMoyenne|| null;
    data.publicId   = _employes[_editId].publicId   || null;
  }

  // G√©n√©rer un publicId unique √† la cr√©ation
  if (!data.publicId) {
    data.publicId = 'emp_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36);
  }

  // Donn√©es publiques minimales (portail salari√©)
  const publicData = {
    uid:           window._uid,
    empId:         id,
    prenom:        data.prenom        || '',
    nom:           data.nom           || '',
    poste:         data.poste         || '',
    departement:   data.departement   || '',
    typeContrat:   data.typeContrat   || '',
    couleur:       data.couleur       || '#059669',
    dateEntree:    data.dateEntree    || '',
    cpAjustAcquis: data.cpAjustAcquis || 0,
    rttAjust:      data.rttAjust      || 0,
    recupHeures:   data.recupHeures   || 0,
  };

  try {
    // √âcriture fiche priv√©e
    await window._setDoc(window._doc(window._db,'rh',window._uid,'employes',id), data);
    // √âcriture / mise √† jour fiche publique (portail salari√©)
    await window._setDoc(window._doc(window._db,'rh_employes_public',data.publicId), publicData);
    _employes[id] = { id, ...data };
    closeModal('modalEmploye');
    buildDeptFilter();
    renderList();
    openFiche(id);
    showToast(_editId?'‚úÖ Employ√© modifi√©':'‚úÖ Employ√© cr√©√©','ok');
  } catch(e) {
    showToast('Erreur : '+e.message,'err');
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PHOTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openModalPhoto = function(id) {
  _editId = id;
  const e = _employes[id];
  const preview = document.getElementById('photo-preview');
  if (e?.photoURL) {
    preview.innerHTML = `<img src="${e.photoURL}" style="width:100%;height:100%;object-fit:cover;border-radius:20px"/>`;
  } else {
    const nom = `${e?.prenom||''} ${e?.nom||''}`.trim();
    const init = nom.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
    preview.innerHTML = `<div style="font-size:32px;color:${e?.couleur||COLORS[0]}">${init}</div>`;
  }
  openModal('modalPhoto');
};

window.previewPhoto = function(input) {
  if (!input.files[0]) return;
  _photoFile = input.files[0];
  const reader = new FileReader();
  reader.onload = e => {
    _photoDataURL = e.target.result;
    document.getElementById('photo-preview').innerHTML =
      `<img src="${_photoDataURL}" style="width:100%;height:100%;object-fit:cover;border-radius:20px"/>`;
  };
  reader.readAsDataURL(input.files[0]);
};

window.savePhoto = async function() {
  if (!_editId || !_photoDataURL) { closeModal('modalPhoto'); return; }
  try {
    // Stocker en base64 directement (attention taille) ‚Äî pour production : Firebase Storage
    await window._updateDoc(window._doc(window._db,'rh',window._uid,'employes',_editId), { photoURL: _photoDataURL });
    _employes[_editId].photoURL = _photoDataURL;
    closeModal('modalPhoto');
    renderList();
    openFiche(_editId);
    showToast('‚úÖ Photo enregistr√©e','ok');
  } catch(e) { showToast('Erreur photo','err'); }
};

window.removePhoto = async function() {
  if (!_editId) return;
  try {
    await window._updateDoc(window._doc(window._db,'rh',window._uid,'employes',_editId), { photoURL: null });
    _employes[_editId].photoURL = null;
    closeModal('modalPhoto');
    renderList();
    openFiche(_editId);
    showToast('Photo supprim√©e','ok');
  } catch(e) { showToast('Erreur','err'); }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOCUMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _docEmpId = null;
window.openModalDoc = function(id) { _docEmpId=id; openModal('modalDoc'); };

window.saveDoc = async function() {
  const nom = document.getElementById('doc-nom').value.trim();
  if (!nom||!_docEmpId) return;
  const e = _employes[_docEmpId];
  if (!e) return;
  const doc = {
    nom, type: document.getElementById('doc-type').value,
    date: document.getElementById('doc-date').value||null,
    ref:  document.getElementById('doc-ref').value.trim()||null,
    addedAt: Date.now()
  };
  const docs = [...(e.documents||[]), doc];
  try {
    await window._updateDoc(window._doc(window._db,'rh',window._uid,'employes',_docEmpId),{documents:docs});
    _employes[_docEmpId].documents = docs;
    closeModal('modalDoc');
    document.getElementById('doc-nom').value='';
    document.getElementById('doc-ref').value='';
    // Rafra√Æchir docs tab si visible
    const body = document.getElementById(`docs-body-${_docEmpId}`);
    if (body) body.innerHTML = renderDocs(_employes[_docEmpId]);
    showToast('‚úÖ Document ajout√©','ok');
  } catch(err) { showToast('Erreur','err'); }
};

window.deleteDoc = async function(empId, idx) {
  if (!confirm('Supprimer ce document ?')) return;
  const docs = [...(_employes[empId].documents||[])];
  docs.splice(idx,1);
  try {
    await window._updateDoc(window._doc(window._db,'rh',window._uid,'employes',empId),{documents:docs});
    _employes[empId].documents = docs;
    const body = document.getElementById(`docs-body-${empId}`);
    if (body) body.innerHTML = renderDocs(_employes[empId]);
    showToast('Document supprim√©','ok');
  } catch(e) { showToast('Erreur','err'); }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// √âVALUATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _evalEmpId = null;
window.openModalEval = function(id) {
  _evalEmpId = id;
  document.getElementById('eval-date').value = new Date().toISOString().slice(0,10);
  document.getElementById('eval-note').value = '';
  document.getElementById('eval-comment').value = '';
  document.getElementById('eval-by').value = '';
  document.getElementById('eval-stars-preview').innerHTML = '‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ';
  openModal('modalEval');
};

// Live preview √©toiles
document.addEventListener('input', e => {
  if (e.target.id==='eval-note') {
    const n = Math.min(5,Math.max(0,parseFloat(e.target.value)||0));
    const preview = document.getElementById('eval-stars-preview');
    if (preview) {
      let stars='';
      for (let i=1;i<=5;i++) stars+=`<span style="color:${i<=n?'#f59e0b':'#e2e8f0'}">‚òÖ</span>`;
      preview.innerHTML=stars;
    }
  }
});

window.saveEval = async function() {
  if (!_evalEmpId) return;
  const note = parseFloat(document.getElementById('eval-note').value)||0;
  if (!note) { showToast('Note obligatoire','err'); return; }
  const ev = {
    note, date: document.getElementById('eval-date').value,
    commentaire: document.getElementById('eval-comment').value.trim()||null,
    evaluateur:  document.getElementById('eval-by').value.trim()||null,
    createdAt: Date.now()
  };
  const e = _employes[_evalEmpId];
  const evals = [...(e.evaluations||[]), ev];
  const noteMoy = (evals.reduce((s,x)=>s+(parseFloat(x.note)||0),0)/evals.length).toFixed(1);
  try {
    await window._updateDoc(window._doc(window._db,'rh',window._uid,'employes',_evalEmpId),{evaluations:evals,noteMoyenne:parseFloat(noteMoy)});
    _employes[_evalEmpId].evaluations = evals;
    _employes[_evalEmpId].noteMoyenne = parseFloat(noteMoy);
    closeModal('modalEval');
    const body = document.getElementById(`evals-body-${_evalEmpId}`);
    if (body) body.innerHTML = renderEvals(_employes[_evalEmpId]);
    openFiche(_evalEmpId);
    showToast(`‚úÖ √âvaluation enregistr√©e ¬∑ Moy. ${noteMoy}/5`,'ok');
  } catch(err) { showToast('Erreur','err'); }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENTRETIENS ANNUELS (dans la fiche salari√©)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Cache local des entretiens par empId
var _ficheEntretiens = {};

window.loadEntretiensTab = async function(empId) {
  const body = document.getElementById('entretiens-body-' + empId);
  if (!body) return;

  // Si d√©j√† charg√© ‚Üí re-render depuis cache
  if (_ficheEntretiens[empId]) {
    body.innerHTML = renderEntretiensTab(empId, _ficheEntretiens[empId]);
    return;
  }

  body.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px"><div style="font-size:24px;margin-bottom:6px">‚è≥</div>Chargement...</div>';
  try {
    const snap = await window._getDocs(
      window._collection(window._db, 'rh', window._uid, 'entretiens_annuels', empId, 'sessions')
    );
    const list = [];
    snap.forEach(d => list.push(Object.assign({ id: d.id }, d.data())));
    list.sort((a, b) => (b.annee || 0) - (a.annee || 0));
    _ficheEntretiens[empId] = list;
    body.innerHTML = renderEntretiensTab(empId, list);
  } catch(err) {
    console.error(err);
    body.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted);font-size:12px">Impossible de charger les entretiens.<br><small>' + (err.message||'') + '</small></div>';
  }
};

function renderEntretiensTab(empId, list) {
  if (!list || list.length === 0) {
    return `<div style="text-align:center;padding:24px;color:var(--muted);font-size:12px">
      <div style="font-size:32px;margin-bottom:8px">üéØ</div>
      Aucun entretien enregistr√© pour ce collaborateur.<br>
      <button class="btn btn-rh btn-sm" style="margin-top:12px" onclick="createEntretienFromFiche('${empId}')">+ D√©marrer un entretien</button>
    </div>`;
  }

  const typeLabels = {
    annuel: 'Entretien annuel',
    'mi-annee': 'Mi-ann√©e',
    professionnel: 'Entretien professionnel',
    retour: 'Entretien de retour'
  };

  const apprLabels = {
    exceptionnel: '‚≠ê‚≠ê‚≠ê Exceptionnel',
    tres_bien:    '‚≠ê‚≠ê Tr√®s bien',
    bien:         '‚≠ê Bien',
    ameliorer:    '‚ö†Ô∏è √Ä am√©liorer',
    insuffisant:  '‚ùå Insuffisant'
  };

  // KPIs synth√®se
  const notes = list.filter(x => x.noteGlobale).map(x => parseFloat(x.noteGlobale) || 0);
  const moyNote = notes.length > 0 ? (notes.reduce((s, v) => s + v, 0) / notes.length).toFixed(1) : null;
  const thisYear = new Date().getFullYear();
  const doneThisYear = list.some(x => x.annee == thisYear);
  const lastEnt = list[0];

  let html = '';

  // Bandeau KPI
  html += `<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:14px">
    <div style="padding:10px 12px;border-radius:9px;background:var(--rh-ghost);border:1px solid var(--rh-border);text-align:center">
      <div style="font-size:18px;font-weight:800;color:var(--rh-main)">${list.length}</div>
      <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;margin-top:2px">Entretiens</div>
    </div>
    <div style="padding:10px 12px;border-radius:9px;background:${moyNote?'var(--rh-ghost)':'#f8faff'};border:1px solid ${moyNote?'var(--rh-border)':'var(--border)'};text-align:center">
      <div style="font-size:18px;font-weight:800;color:${moyNote?'var(--rh-main)':'var(--muted)'}">${moyNote || '‚Äî'}</div>
      <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;margin-top:2px">Note moy. /5</div>
    </div>
    <div style="padding:10px 12px;border-radius:9px;background:${doneThisYear?'var(--rh-ghost)':'#fef3c7'};border:1px solid ${doneThisYear?'var(--rh-border)':'#fcd34d'};text-align:center">
      <div style="font-size:18px;font-weight:800;color:${doneThisYear?'var(--rh-main)':'#92400e'}">${doneThisYear ? '‚úì' : '‚Äî'}</div>
      <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;margin-top:2px">${thisYear}</div>
    </div>
    <div style="padding:10px 12px;border-radius:9px;background:#f8faff;border:1px solid var(--border);text-align:center">
      <div style="font-size:18px;font-weight:800;color:var(--text)">${lastEnt?.annee || '‚Äî'}</div>
      <div style="font-size:10px;color:var(--muted);font-weight:600;text-transform:uppercase;margin-top:2px">Dernier</div>
    </div>
  </div>`;

  // Liste des entretiens
  html += list.map(ent => {
    const note = parseFloat(ent.noteGlobale) || 0;
    const stars = Array.from({length:5},(_,i)=>`<span style="color:${i<note?'#f59e0b':'#e2e8f0'};font-size:13px">${i<note?'‚òÖ':'‚òÜ'}</span>`).join('');
    const statutCls = ent.statut === 'finalise'
      ? 'background:#d1fae5;color:#065f46'
      : 'background:#fef3c7;color:#92400e';
    const objCount = (ent.nouveaux_objectifs||[]).filter(o=>o.obj).length;
    const formationText = ent.besoins_formation ? 'üéì Formation identifi√©e' : '';
    const augText = ent.augmentation ? `üí∞ +${ent.augmentation}%` : '';

    return `<div style="border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:8px;transition:all .15s;cursor:pointer"
      onmouseover="this.style.borderColor='var(--rh-border)';this.style.background='var(--rh-ghost)'"
      onmouseout="this.style.borderColor='var(--border)';this.style.background=''"
      onclick="window.location.href='rh-entretiens.html'">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
        <span style="font-size:16px;font-weight:800;color:var(--rh-main);min-width:36px">${ent.annee||'‚Äî'}</span>
        <span style="font-size:12px;font-weight:600;color:var(--text)">${typeLabels[ent.type]||ent.type||'Entretien'}</span>
        <span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;${statutCls};margin-left:auto">${ent.statut==='finalise'?'‚úÖ Finalis√©':'üìù Brouillon'}</span>
      </div>
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        ${note > 0 ? `<div style="display:flex;align-items:center;gap:4px">${stars}<span style="font-size:12px;font-weight:700;color:var(--rh-main);margin-left:3px">${note}/5</span></div>` : ''}
        ${ent.appreciation_finale ? `<span style="font-size:11px;color:var(--muted)">${apprLabels[ent.appreciation_finale]||''}</span>` : ''}
        ${ent.evaluateur ? `<span style="font-size:11px;color:var(--muted)">¬∑ Par ${ent.evaluateur}</span>` : ''}
        ${ent.date ? `<span style="font-size:11px;color:var(--muted)">¬∑ ${fmtDate(ent.date)}</span>` : ''}
      </div>
      ${(objCount > 0 || formationText || augText) ? `
      <div style="display:flex;gap:8px;margin-top:7px;flex-wrap:wrap">
        ${objCount > 0 ? `<span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:12px;background:#f0f4ff;color:#1a3dce">${objCount} objectif${objCount>1?'s':''} fix√©${objCount>1?'s':''}</span>` : ''}
        ${formationText ? `<span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:12px;background:#fef3c7;color:#92400e">${formationText}</span>` : ''}
        ${augText ? `<span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:12px;background:#d1fae5;color:#065f46">${augText}</span>` : ''}
      </div>` : ''}
      ${ent.conclusions ? `<div style="margin-top:7px;font-size:11px;color:var(--muted);line-height:1.5;font-style:italic">"${ent.conclusions.slice(0,120)}${ent.conclusions.length>120?'‚Ä¶':''}"</div>` : ''}
    </div>`;
  }).join('');

  html += `<div style="text-align:center;margin-top:8px">
    <a href="rh-entretiens.html" style="font-size:12px;color:var(--rh-main);font-weight:600;text-decoration:none">
      Voir tous les entretiens dans le module d√©di√© ‚Üí
    </a>
  </div>`;

  return html;
}

window.createEntretienFromFiche = function(empId) {
  // Redirige vers le module entretiens avec l'employ√© pr√©-s√©lectionn√© via URL param
  window.location.href = 'rh-entretiens.html?empId=' + empId;
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ARCHIVAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _archiveId = null;
window.openModalArchive = function(id) {
  _archiveId = id;
  document.getElementById('arch-date').value = new Date().toISOString().slice(0,10);
  openModal('modalArchive');
};

window.confirmArchive = async function() {
  if (!_archiveId) return;
  const motif = document.getElementById('arch-motif').value;
  const date  = document.getElementById('arch-date').value;
  try {
    await window._updateDoc(window._doc(window._db,'rh',window._uid,'employes',_archiveId),
      { statut:'archive', motifDepart:motif, dateSortie:date, archivedAt:Date.now() });
    _employes[_archiveId].statut = 'archive';
    _employes[_archiveId].motifDepart = motif;
    closeModal('modalArchive');
    _currentId = null;
    renderList();
    document.getElementById('right-panel').innerHTML = `<div class="empty-fiche"><div class="icon">üì¶</div><h3 style="font-size:15px;font-weight:700">Employ√© archiv√©</h3></div>`;
    showToast('Employ√© archiv√©','ok');
  } catch(e) { showToast('Erreur','err'); }
};

window.restoreEmploye = async function(id) {
  if (!confirm('Restaurer cet employ√© ?')) return;
  try {
    await window._updateDoc(window._doc(window._db,'rh',window._uid,'employes',id),{statut:'actif',archivedAt:null});
    _employes[id].statut = 'actif';
    renderList();
    openFiche(id);
    showToast('‚úÖ Employ√© restaur√©','ok');
  } catch(e) { showToast('Erreur','err'); }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORT PDF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.exportPDF = function(id) {
  const e = _employes[id];
  if (!e) return;
  const nom = `${e.prenom||''} ${e.nom||''}`.trim();
  showToast('üìÑ G√©n√©ration PDF‚Ä¶');

  // G√©n√©ration HTML ‚Üí window.print()
  const evals = e.evaluations||[];
  const noteMoy = evals.length>0 ? (evals.reduce((s,ev)=>s+(parseFloat(ev.note)||0),0)/evals.length).toFixed(1) : null;
  const docs = e.documents||[];
  const color = e.couleur||COLORS[0];
  const init  = nom.split(' ').map(w=>w[0]).slice(0,2).join('').toUpperCase();
  const anc   = e.dateEntree ? calcAnciennete(e.dateEntree) : '‚Äî';

  const html = `<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"/>
  <title>Fiche RH ‚Äî ${nom}</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Arial,sans-serif;font-size:12px;color:#1a1f36;background:white;padding:32px;}
    h1{font-size:22px;font-weight:700;margin-bottom:4px;}
    h2{font-size:13px;font-weight:700;margin:18px 0 8px;padding-bottom:4px;border-bottom:2px solid #d1fae5;color:#059669;}
    .hero{display:flex;align-items:center;gap:18px;margin-bottom:22px;padding-bottom:18px;border-bottom:3px solid #d1fae5;}
    .av{width:64px;height:64px;border-radius:14px;background:${color};display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:800;color:white;flex-shrink:0;}
    .kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:18px;}
    .kpi{padding:10px 12px;background:#f0fdf4;border:1px solid #d1fae5;border-radius:8px;}
    .kpi-lbl{font-size:9px;font-weight:700;color:#6b7280;text-transform:uppercase;letter-spacing:.5px;}
    .kpi-v{font-size:14px;font-weight:800;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px 24px;}
    .field{margin-bottom:8px;}
    .field-lbl{font-size:9px;font-weight:700;color:#6b7280;text-transform:uppercase;}
    .field-v{font-size:12px;font-weight:600;}
    .eval{padding:10px;border:1px solid #e2e8f0;border-radius:6px;margin-bottom:6px;}
    .doc-row{display:flex;gap:8px;align-items:center;padding:7px;border:1px solid #e2e8f0;border-radius:6px;margin-bottom:5px;}
    .badge{display:inline-block;font-size:10px;font-weight:700;padding:2px 8px;border-radius:20px;background:#d1fae5;color:#065f46;}
    .footer{margin-top:24px;padding-top:12px;border-top:1px solid #e2e8f0;font-size:10px;color:#6b7280;text-align:center;}
    @media print{body{padding:16px;}}
  </style></head><body>
  <div class="hero">
    <div class="av">${e.photoURL?`<img src="${e.photoURL}" style="width:64px;height:64px;border-radius:14px;object-fit:cover"/>`:init}</div>
    <div>
      <h1>${nom}</h1>
      <div style="font-size:13px;color:#6b7280;margin-bottom:6px">${e.poste||'‚Äî'}${e.departement?' ¬∑ '+e.departement:''}</div>
      <span class="badge">${e.typeContrat||'CDI'}</span>
      ${noteMoy?`<span class="badge" style="background:#fef3c7;color:#92400e;margin-left:6px">‚≠ê ${noteMoy}/5</span>`:''}
    </div>
  </div>
  <div class="kpi-row">
    <div class="kpi"><div class="kpi-lbl">Salaire net</div><div class="kpi-v">${e.salaireNet?fmtE(e.salaireNet):'‚Äî'}</div></div>
    <div class="kpi"><div class="kpi-lbl">Anciennet√©</div><div class="kpi-v">${anc}</div></div>
    <div class="kpi"><div class="kpi-lbl">Date entr√©e</div><div class="kpi-v">${fmtDate(e.dateEntree)||'‚Äî'}</div></div>
    <div class="kpi"><div class="kpi-lbl">Heures/sem.</div><div class="kpi-v">${e.heuresHebdo||35}h</div></div>
  </div>
  <h2>üë§ Informations personnelles</h2>
  <div class="grid2">
    ${pdfField('Date de naissance',fmtDate(e.dateNaissance))}
    ${pdfField('Nationalit√©',e.nationalite)}
    ${pdfField('T√©l√©phone',e.telephone)}
    ${pdfField('Email',e.email)}
    ${pdfField('Adresse',e.adresse)}
    ${pdfField('N¬∞ SS',e.nss?maskNSS(e.nss):null)}
  </div>
  <h2>üìã Contrat & R√©mun√©ration</h2>
  <div class="grid2">
    ${pdfField('Type',e.typeContrat)} ${pdfField('Statut',e.statut)}
    ${pdfField('Date entr√©e',fmtDate(e.dateEntree))} ${pdfField('Fin contrat',fmtDate(e.dateFinContrat)||'‚Äî')}
    ${pdfField('Salaire brut',e.salaireBrut?fmtE(e.salaireBrut):null)}
    ${pdfField('Salaire net',e.salaireNet?fmtE(e.salaireNet):null)}
    ${pdfField('Fr√©quence',e.frequence||'mensuel')} ${pdfField('Heures/sem.',(e.heuresHebdo||35)+'h')}
  </div>
  ${docs.length>0?`<h2>üìé Documents RH (${docs.length})</h2>${docs.map(d=>`<div class="doc-row"><b>${d.nom}</b><span style="color:#6b7280;font-size:11px">${d.date?fmtDate(d.date):''}</span></div>`).join('')}`:''}
  ${evals.length>0?`<h2>‚≠ê √âvaluations (${evals.length})</h2>${evals.map(ev=>`<div class="eval"><b>${parseFloat(ev.note)||0}/5</b> ¬∑ ${ev.date?fmtDate(ev.date):''} ¬∑ Par ${ev.evaluateur||'‚Äî'}<br>${ev.commentaire?`<i>${ev.commentaire}</i>`:''}</div>`).join('')}`:''}
  <div class="footer">Document g√©n√©r√© le ${new Date().toLocaleDateString('fr-FR')} ¬∑ ALTEORE ‚Äî Confidentiel RH</div>
  </body></html>`;

  const w = window.open('','_blank','width=800,height=900');
  w.document.write(html);
  w.document.close();
  setTimeout(()=>{w.print();},600);
};

function pdfField(label, val) {
  return `<div class="field"><div class="field-lbl">${label}</div><div class="field-v">${val||'‚Äî'}</div></div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILITAIRES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calcAnciennete(dateEntree) {
  const diff = Date.now() - new Date(dateEntree).getTime();
  const ans  = Math.floor(diff / (365.25*86400000));
  const mois = Math.floor((diff % (365.25*86400000)) / (30.44*86400000));
  if (ans>0) return `${ans} an${ans>1?'s':''} ${mois>0?mois+'m':''}`.trim();
  if (mois>0) return `${mois} mois`;
  return 'R√©cent';
}
function fmtDate(d) {
  if (!d) return null;
  try { return new Date(d).toLocaleDateString('fr-FR'); } catch(e) { return d; }
}
function fmtE(n) {
  return (parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:0,maximumFractionDigits:0})+' ‚Ç¨';
}
function maskNSS(nss) {
  if (!nss||nss.length<8) return nss;
  return nss.slice(0,5)+'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'+nss.slice(-2);
}
function maskIBAN(iban) {
  if (!iban||iban.length<8) return iban;
  return iban.slice(0,4)+' ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ '+iban.slice(-4);
}
function showToast(msg, type='') {
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast show '+(type||'');
  setTimeout(()=>t.className='toast',3200);
}
function openModal(id) { document.getElementById(id).classList.add('show'); }
window.closeModal = function(id) { document.getElementById(id).classList.remove('show'); };

window.copyLienSalarie = function(empId, publicId) {
  const lien = 'https://alteore.com/espace-salarie.html?id=' + publicId;
  navigator.clipboard.writeText(lien).then(() => {
    showToast('üìã Lien copi√© !', 'ok');
  }).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = lien; ta.style.position='fixed'; ta.style.opacity='0';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    showToast('üìã Lien copi√© !', 'ok');
  });
};

// G√©n√®re un publicId pour un employ√© existant qui n'en a pas encore
window.genererLienSalarie = async function(empId) {
  if (!window._uid || !_employes[empId]) return;
  const e = _employes[empId];
  const publicId = 'emp_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36);
  const publicData = {
    uid:           window._uid,
    empId:         empId,
    prenom:        e.prenom        || '',
    nom:           e.nom           || '',
    poste:         e.poste         || '',
    departement:   e.departement   || '',
    typeContrat:   e.typeContrat   || '',
    couleur:       e.couleur       || '#059669',
    dateEntree:    e.dateEntree    || '',
    cpAjustAcquis: e.cpAjustAcquis || 0,
    rttAjust:      e.rttAjust      || 0,
    recupHeures:   e.recupHeures   || 0,
  };
  try {
    // Sauvegarder publicId dans la fiche priv√©e
    await window._updateDoc(window._doc(window._db,'rh',window._uid,'employes',empId), { publicId });
    // Cr√©er la fiche publique
    await window._setDoc(window._doc(window._db,'rh_employes_public',publicId), publicData);
    // Mettre √† jour le cache local
    _employes[empId].publicId = publicId;
    // Re-render la fiche pour afficher le lien
    openFiche(empId);
    showToast('‚úÖ Lien portail g√©n√©r√© !', 'ok');
  } catch(err) {
    showToast('Erreur : ' + err.message, 'err');
    console.error(err);
  }
};

// Fermer modals au clic overlay
document.querySelectorAll('.modal-overlay').forEach(o=>{
  o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('show'); });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// P√âRIODE D'ESSAI ‚Äî dur√©es l√©gales 2025
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// R√®gles l√©gales Code du travail (dur√©es en jours)
// CDI : Employ√© 60j, AM/Technicien 90j, Cadre 120j (renouvelables 1x ‚Üí max 120/180/240)
// CDD ‚â§6m : 1j/semaine plafond 14j | CDD >6m : plafond 31j
// Stage : aucune PE l√©gale, en pratique conv. de stage
// Alternance : 45 premiers jours (apprentissage)

function getPELegal(contrat, categorie, dateEntree, dateFin) {
  const info = { jours: 0, label: '‚Äî', renouvelable: false, maxJours: 0 };
  if (!contrat) return info;

  if (contrat === 'CDI') {
    const durees = { employe:60, agent_maitrise:90, cadre:120 };
    const max    = { employe:120, agent_maitrise:180, cadre:240 };
    const cat = categorie || 'employe';
    info.jours = durees[cat] || 60;
    info.maxJours = max[cat] || 120;
    info.renouvelable = true;
    const mois = Math.round(info.jours / 30.44);
    const maxMois = Math.round(info.maxJours / 30.44);
    info.label = `${mois} mois l√©gaux (max ${maxMois} m. avec renouvellement)`;
  } else if (contrat === 'CDD') {
    if (!dateEntree || !dateFin) {
      info.label = 'Renseignez les dates du CDD';
      return info;
    }
    const semaines = Math.ceil((new Date(dateFin) - new Date(dateEntree)) / (7 * 86400000));
    const estCourt = semaines <= 26; // ‚â§ 6 mois
    info.jours = estCourt ? Math.min(semaines, 14) : 31;
    info.maxJours = info.jours;
    info.renouvelable = false;
    info.label = estCourt
      ? `${info.jours} jours (1j/semaine, plafond 2 semaines)`
      : `1 mois max (CDD > 6 mois)`;
  } else if (contrat === 'Stage') {
    info.jours = 0;
    info.label = 'Aucune PE l√©gale (convention de stage)';
  } else if (contrat === 'Alternance') {
    info.jours = 45;
    info.maxJours = 45;
    info.renouvelable = false;
    info.label = '45 premiers jours (apprentissage)';
  } else {
    info.label = 'Aucune PE l√©gale';
  }
  return info;
}

window.onContratChange = function() {
  const contrat  = document.getElementById('f-contrat')?.value;
  const categorie= document.getElementById('f-categorie')?.value;
  const entree   = document.getElementById('f-entree')?.value;
  const fin      = document.getElementById('f-fin')?.value;
  const active   = document.getElementById('pe-active')?.checked;

  const legal = getPELegal(contrat, categorie, entree, fin);

  // Cacher PE pour Freelance
  const peBloc = document.getElementById('pe-bloc');
  if (contrat === 'Freelance') { peBloc.classList.add('disabled'); return; }
  peBloc.classList.remove('disabled');

  // Mettre √† jour l'info l√©gale
  const infoEl = document.getElementById('pe-legal-info');
  if (infoEl) infoEl.textContent = legal.label;

  // Pr√©-remplir la dur√©e sugg√©r√©e si vide
  const dureeInput = document.getElementById('pe-duree');
  const uniteInput = document.getElementById('pe-unite');
  if (dureeInput && uniteInput && !dureeInput.value) {
    if (legal.jours > 0) {
      if (legal.jours % 30 === 0 || legal.jours >= 30) {
        dureeInput.value = Math.round(legal.jours / 30.44);
        uniteInput.value = 'mois';
      } else if (legal.jours >= 7) {
        dureeInput.value = Math.round(legal.jours / 7);
        uniteInput.value = 'semaines';
      } else {
        dureeInput.value = legal.jours;
        uniteInput.value = 'jours';
      }
    }
  }

  // Renouvellement
  const renouvSel = document.getElementById('pe-renouv');
  if (renouvSel) renouvSel.disabled = !legal.renouvelable;

  calcPEFin();
};

window.onPEChange = function() {
  const active = document.getElementById('pe-active')?.checked;
  const details = document.getElementById('pe-details');
  if (details) details.style.display = active ? '' : 'none';
  if (active) onContratChange();
};

window.calcPEFin = function() {
  const entree  = document.getElementById('f-entree')?.value;
  const dureeV  = parseFloat(document.getElementById('pe-duree')?.value) || 0;
  const unite   = document.getElementById('pe-unite')?.value || 'mois';
  const contrat = document.getElementById('f-contrat')?.value;
  const cat     = document.getElementById('f-categorie')?.value || 'employe';
  const renouv  = document.getElementById('pe-renouv')?.value === 'oui';
  const finInfo = document.getElementById('pe-fin-info');
  const warnEl  = document.getElementById('pe-warn');
  if (!finInfo) return;

  if (!entree || !dureeV) { finInfo.textContent = '‚Äî'; return; }

  // Calcul date fin PE
  const d = new Date(entree);
  const jourTotal = unite === 'jours' ? dureeV
    : unite === 'semaines' ? dureeV * 7
    : dureeV * 30.44;
  d.setDate(d.getDate() + Math.round(jourTotal * (renouv ? 2 : 1)));
  finInfo.textContent = d.toLocaleDateString('fr-FR');

  // V√©rification d√©passement l√©gal
  const legal = getPELegal(contrat, cat, document.getElementById('f-entree')?.value, document.getElementById('f-fin')?.value);
  const totalJours = jourTotal * (renouv ? 2 : 1);
  if (legal.maxJours > 0 && totalJours > legal.maxJours) {
    warnEl.style.display = '';
    warnEl.textContent = `‚ö†Ô∏è Dur√©e totale (${Math.round(totalJours)}j) d√©passe le maximum l√©gal de ${legal.maxJours} jours pour cette cat√©gorie.`;
  } else {
    warnEl.style.display = 'none';
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CALCULATEUR SALAIRE BIDIRECTIONNEL ‚Äî Taux 2025
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Sources : URSSAF 2025, PMSS = 3 925 ‚Ç¨/mois, SMIC = 11,88 ‚Ç¨/h
// Cotisations SALARIALES (en % du brut) :
//   Maladie :       0% (sauf Alsace-Moselle +1.30%)
//   Vieillesse plaf: 6.90% (sur min(brut, PMSS))
//   Vieillesse d√©pl: 0.40% (sur brut total)
//   Ch√¥mage :        0% salari√© (supprim√©) ‚Äî int√©gr√© c√¥t√© patronal
//   CSG d√©ductible : 6.80% (sur 98.25% du brut)
//   CSG non d√©duct.: 2.40% (sur 98.25% du brut)
//   CRDS :           0.50% (sur 98.25% du brut)
//   Retraite comp T1: 3.15% (sur min(brut, PMSS))
//   Retraite comp T2: 8.64% (sur brut entre PMSS et 8√óPMSS, cadres surtout)
//   APEC (cadres) :  0.024% (sur min(brut, 4√óPMSS))
// ‚Üí Total salariales ‚âà 22‚Äì23%

// Cotisations PATRONALES :
//   Maladie :        7% (brut ‚â§ 2.25 SMIC mensuel = 4 363‚Ç¨) ou 13% au-del√†
//   AT/MP :          ~1.5% (variable secteur, on prend taux moyen)
//   Alloc. familiales: 3.45% (brut ‚â§ 3.3 SMIC = 6 401‚Ç¨) ou 5.25% au-del√†
//   Vieillesse plaf: 8.55% (sur min(brut, PMSS))
//   Vieillesse d√©pl: 2.02% (sur brut)
//   Ch√¥mage :        4.00% (depuis mai 2025, sur brut ‚â§ 4√óPMSS)
//   AGS :            0.25% (depuis juil 2025)
//   FNAL :           0.10% (<50 sal.) ou 0.50%
//   Retraite comp T1: 4.72% (sur min(brut, PMSS))
//   Retraite comp T2: 12.95% (tranche 2, surtout cadres)
//   CEG T1 :         1.29% + CEG T2 2.16% (si>PMSS)
//   APEC patronal (cadres) : 0.036%

const PMSS = 3925; // Plafond mensuel SS 2025
const SMIC_H = 11.88;
const SMIC_M = SMIC_H * 35 * 52 / 12; // ‚âà 1801.80 ‚Ç¨

function calcCotisations(brut, estCadre) {
  const b = parseFloat(brut) || 0;
  if (b <= 0) return { sal: 0, pat: 0, net: 0 };

  const assiette_csg = b * 0.9825; // abattement 1.75%
  const plaf1 = Math.min(b, PMSS);

  // ‚îÄ‚îÄ SALARIALES ‚îÄ‚îÄ
  let sal = 0;
  sal += plaf1 * 0.0690;          // vieillesse plafonn√©e
  sal += b     * 0.0040;          // vieillesse d√©plafonn√©e
  sal += assiette_csg * 0.0680;   // CSG d√©ductible
  sal += assiette_csg * 0.0240;   // CSG non d√©ductible
  sal += assiette_csg * 0.0050;   // CRDS
  sal += plaf1 * 0.0315;          // retraite compl√©mentaire T1
  if (b > PMSS) sal += Math.min(b - PMSS, 7 * PMSS) * 0.0864; // T2
  if (estCadre) {
    sal += Math.min(b, 4 * PMSS) * 0.00024; // APEC
    if (b > PMSS) sal += Math.min(b - PMSS, 7 * PMSS) * 0.0014; // CET T2
  }

  // ‚îÄ‚îÄ PATRONALES ‚îÄ‚îÄ
  let pat = 0;
  const seuil_am   = 2.25 * SMIC_M;  // ~4054‚Ç¨ ‚Äî taux r√©duit maladie
  const seuil_af   = 3.3  * SMIC_M;  // ~5946‚Ç¨ ‚Äî taux r√©duit AF
  pat += b     * (b <= seuil_am ? 0.07 : 0.13);  // maladie
  pat += b     * 0.015;               // AT/MP (taux moyen)
  pat += b     * (b <= seuil_af ? 0.0345 : 0.0525); // allocations fam.
  pat += plaf1 * 0.0855;              // vieillesse plafonn√©e
  pat += b     * 0.0202;              // vieillesse d√©plafonn√©e
  pat += Math.min(b, 4 * PMSS) * 0.04; // ch√¥mage (mai 2025)
  pat += Math.min(b, 4 * PMSS) * 0.0025; // AGS (juil 2025)
  pat += b     * 0.001;               // FNAL (taux <50 sal.)
  pat += plaf1 * 0.0472;              // retraite comp T1
  if (b > PMSS) pat += Math.min(b - PMSS, 7 * PMSS) * 0.1295; // T2
  pat += plaf1 * 0.0129;              // CEG T1
  if (b > PMSS) pat += Math.min(b - PMSS, 7 * PMSS) * 0.0216; // CEG T2
  if (estCadre) {
    pat += Math.min(b, 4 * PMSS) * 0.015;  // pr√©voyance obligatoire cadre
    pat += Math.min(b, 4 * PMSS) * 0.00036; // APEC
    if (b > PMSS) pat += Math.min(b - PMSS, 7 * PMSS) * 0.0021; // CET T2
  }

  const net = Math.round((b - sal) * 100) / 100;
  return {
    sal: Math.round(sal * 100) / 100,
    pat: Math.round(pat * 100) / 100,
    superbrut: Math.round((b + pat) * 100) / 100,
    net
  };
}

let _salMode = 'brut';
window.setSalMode = function(mode) {
  _salMode = mode;
  document.querySelectorAll('.sal-mode-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.mode === mode);
  });
  // Highlight le champ principal
  ['f-brut','f-net','f-superbrut'].forEach(id => {
    const el = document.getElementById(id);
    if (!el) return;
    el.style.borderColor = '';
    el.style.background  = '';
  });
  const mainId = mode === 'brut' ? 'f-brut' : mode === 'net' ? 'f-net' : 'f-superbrut';
  const mainEl = document.getElementById(mainId);
  if (mainEl) { mainEl.style.borderColor='#059669'; mainEl.style.background='#f0fdf4'; }
};

window.calcSalaire = function(source) {
  const cat = document.getElementById('f-categorie')?.value || 'employe';
  const estCadre = cat === 'cadre';

  let brut = 0;

  if (source === 'brut') {
    brut = parseFloat(document.getElementById('f-brut').value.replace(',','.')) || 0;
  } else if (source === 'net') {
    // Inversion : net = brut - cotisations_sal ‚Üí brut ‚âà net / (1 - txSal)
    // On it√®re pour converger (cotisations d√©pendent du brut, pas lin√©aire)
    const net = parseFloat(document.getElementById('f-net').value.replace(',','.')) || 0;
    if (!net) { clearSalRecap(); return; }
    brut = net / 0.77; // amor√ßage
    for (let i = 0; i < 10; i++) {
      const c = calcCotisations(brut, estCadre);
      brut = net + c.sal;
    }
    brut = Math.round(brut * 100) / 100;
    const brutEl = document.getElementById('f-brut');
    if (brutEl) brutEl.value = brut.toFixed(2);
  } else if (source === 'superbrut') {
    // super-brut = brut + cotisations_pat ‚Üí it√©ration
    const sb = parseFloat(document.getElementById('f-superbrut').value.replace(',','.')) || 0;
    if (!sb) { clearSalRecap(); return; }
    brut = sb / 1.42; // amor√ßage
    for (let i = 0; i < 10; i++) {
      const c = calcCotisations(brut, estCadre);
      brut = sb - c.pat;
    }
    brut = Math.round(brut * 100) / 100;
    const brutEl = document.getElementById('f-brut');
    if (brutEl) brutEl.value = brut.toFixed(2);
  }

  if (!brut) { clearSalRecap(); return; }

  const c = calcCotisations(brut, estCadre);

  // Remplir les champs non source
  if (source !== 'net') {
    const netEl = document.getElementById('f-net');
    if (netEl) netEl.value = c.net.toFixed(2);
  }
  if (source !== 'superbrut') {
    const sbEl = document.getElementById('f-superbrut');
    if (sbEl) sbEl.value = c.superbrut.toFixed(2);
  }
  if (source !== 'brut') {
    const bEl = document.getElementById('f-brut');
    if (bEl) bEl.value = brut.toFixed(2);
  }

  // Afficher le r√©cap
  const recap = document.getElementById('sal-recap');
  if (recap) {
    recap.style.display = '';
    const statut = document.getElementById('sal-recap-statut');
    if (statut) statut.textContent = estCadre ? 'Cadre' : cat === 'agent_maitrise' ? 'Agent de ma√Ætrise' : 'Employ√© / Ouvrier';
    const f2 = n => n.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' ‚Ç¨';
    document.getElementById('rc-sal').textContent = f2(c.sal);
    document.getElementById('rc-sal-pct').textContent = `${(c.sal/brut*100).toFixed(1)}% du brut`;
    document.getElementById('rc-pat').textContent = f2(c.pat);
    document.getElementById('rc-pat-pct').textContent = `${(c.pat/brut*100).toFixed(1)}% du brut`;
    document.getElementById('rc-net').textContent = f2(c.net);
    document.getElementById('rc-net-pct').textContent = `${(c.net/brut*100).toFixed(1)}% du brut`;
  }
};

function clearSalRecap() {
  const recap = document.getElementById('sal-recap');
  if (recap) recap.style.display = 'none';
}

// Recalculer quand la cat√©gorie change (cadre vs non-cadre impacte les cotisations)
document.addEventListener('change', e => {
  if (e.target.id === 'f-categorie') {
    const brut = parseFloat(document.getElementById('f-brut')?.value) || 0;
    if (brut > 0) calcSalaire('brut');
  }
});

window.setSalMode = window.setSalMode;
window.calcSalaire = window.calcSalaire;
window.onContratChange = window.onContratChange;
window.onPEChange = window.onPEChange;
window.calcPEFin = window.calcPEFin;
</script>

<script src="nav.js"></script>
<script>
(function openRhNav(){
  var tries=0;
  var t=setInterval(function(){
    var sub=document.getElementById("rh-nav-sub");
    var nav=document.getElementById("alteore-nav");
    if(sub&&nav){clearInterval(t);sub.style.maxHeight="2000px";nav.classList.add("rh-mode");}
    if(++tries>50)clearInterval(t);
  },50);
})();
</script>
</body>
</html>
