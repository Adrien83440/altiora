<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover"/>
<title>ALTIORA â€” FidÃ©lisation</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --blue:#1a3dce;--blue2:#4f7ef8;--bg:#f4f6fb;--white:#fff;
  --border:#e2e8f0;--text:#1a1f36;--muted:#6b7280;
  --green:#10b981;--red:#ef4444;--orange:#f59e0b;--purple:#6366f1;
  --pink:#ec4899;--teal:#14b8a6;
  --radius:14px;--sw:250px;
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;min-height:100vh;font-size:13px}

/* NAV */
nav{width:var(--sw);min-height:100vh;background:linear-gradient(180deg,#0f1f5c,#162366);position:fixed;top:0;left:0;display:flex;flex-direction:column;padding-bottom:20px;overflow-y:auto;z-index:99}
.logo{display:flex;align-items:center;gap:10px;padding:22px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
.logo-i{width:33px;height:33px;background:rgba(255,255,255,.14);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px}
.logo-t{font-size:17px;font-weight:800;color:#fff;letter-spacing:1px}
.ns{font-size:10px;font-weight:700;color:rgba(255,255,255,.28);letter-spacing:1px;text-transform:uppercase;padding:12px 18px 4px}
.ni{display:flex;align-items:center;gap:9px;padding:9px 18px;color:rgba(255,255,255,.55);font-size:12.5px;font-weight:500;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.ni:hover{color:#fff;background:rgba(255,255,255,.06)}
.ni.on{color:#fff;background:rgba(255,255,255,.1);border-left-color:#4f7ef8}
.sub{overflow:hidden;max-height:0;transition:max-height .3s}.sub.open{max-height:300px}
.si{display:flex;align-items:center;gap:7px;padding:7px 18px 7px 40px;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;border-left:3px solid transparent;transition:.15s}
.si:hover{color:rgba(255,255,255,.75);background:rgba(255,255,255,.04)}
.si.on{color:#fff;background:rgba(79,126,248,.15);border-left-color:rgba(79,126,248,.6)}
.dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.25)}.si.on .dot{background:#4f7ef8}
.chev{font-size:11px;color:rgba(255,255,255,.3);transition:transform .25s;margin-left:auto}
.nav-footer{margin-top:auto;padding:12px 18px 0;border-top:1px solid rgba(255,255,255,.08)}
.ucard{display:flex;align-items:center;gap:8px;padding:8px;background:rgba(255,255,255,.07);border-radius:8px;cursor:pointer;transition:.15s}
.ucard:hover{background:rgba(255,255,255,.12)}
.uav{width:29px;height:29px;background:linear-gradient(135deg,#4f7ef8,#6366f1);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:#fff}
.un{font-size:11.5px;font-weight:600;color:#fff}.upl{font-size:10px;color:rgba(255,255,255,.3)}
.lbtn{margin-left:auto;background:none;border:none;color:rgba(255,255,255,.3);cursor:pointer;font-size:13px}

/* MAIN */
main{margin-left:var(--sw);flex:1;display:flex;flex-direction:column}
.topbar{background:#fff;border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.topbar h1{font-size:16px;font-weight:700}.topbar p{font-size:11px;color:var(--muted)}
.tb-r{display:flex;gap:8px;align-items:center}

/* TABS PRINCIPAUX */
.main-tabs{display:flex;gap:0;background:#fff;border-bottom:1px solid var(--border);padding:0 24px;overflow-x:auto}
.mtab{padding:12px 18px;font-size:12.5px;font-weight:600;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:.15s;white-space:nowrap;display:flex;align-items:center;gap:6px}
.mtab:hover{color:var(--text)}
.mtab.on{color:var(--blue);border-bottom-color:var(--blue)}
.badge-tab{background:var(--blue2);color:#fff;font-size:9px;font-weight:800;padding:1px 6px;border-radius:10px}
.badge-pro{background:linear-gradient(135deg,var(--orange),#fbbf24);color:#fff;font-size:9px;font-weight:800;padding:1px 6px;border-radius:10px}

/* PANELS */
.panel{display:none;padding:20px 24px;flex-direction:column;gap:16px}
.panel.on{display:flex}

/* BOUTONS */
.btn{padding:7px 14px;border:none;border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;transition:.15s;display:inline-flex;align-items:center;gap:5px}
.btn-p{background:linear-gradient(135deg,var(--blue),var(--blue2));color:#fff;box-shadow:0 3px 10px rgba(26,61,206,.2)}
.btn-o{background:#fff;color:var(--blue);border:1.5px solid var(--border)}
.btn-o:hover{border-color:var(--blue2)}
.btn-xs{padding:4px 10px;font-size:11px}
.btn-g{background:#f0fdf4;color:var(--green);border:1.5px solid #bbf7d0}
.btn-pink{background:linear-gradient(135deg,var(--pink),#f472b6);color:#fff}
.btn-purple{background:linear-gradient(135deg,var(--purple),#818cf8);color:#fff}

/* CARDS */
.card{background:#fff;border:1px solid var(--border);border-radius:var(--radius)}
.card-head{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:#f8faff;border-radius:var(--radius) var(--radius) 0 0}
.card-title{font-size:13px;font-weight:700;display:flex;align-items:center;gap:7px}
.card-body{padding:20px}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}

/* KPI CARDS */
.kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi.blue::before{background:linear-gradient(90deg,var(--blue),var(--blue2))}
.kpi.green::before{background:linear-gradient(90deg,var(--green),#34d399)}
.kpi.orange::before{background:linear-gradient(90deg,var(--orange),#fbbf24)}
.kpi.purple::before{background:linear-gradient(90deg,var(--purple),#818cf8)}
.kpi.pink::before{background:linear-gradient(90deg,var(--pink),#f472b6)}
.kpi-ico{font-size:20px;margin-bottom:8px}
.kpi-lbl{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.kpi-val{font-size:22px;font-weight:800;margin:4px 0}
.kpi-sub{font-size:11px;color:var(--muted)}

/* SEGMENTS */
.seg-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:20px;font-size:11px;font-weight:700}
.seg-vip{background:#fef3c7;color:#92400e}
.seg-actif{background:#d1fae5;color:#065f46}
.seg-inactif{background:#f3f4f6;color:#6b7280}
.seg-nouveau{background:#ede9fe;color:#5b21b6}

/* TABLE CLIENTS */
.clients-table{width:100%;border-collapse:collapse;font-size:12px}
.clients-table th{padding:9px 14px;text-align:left;font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;background:#f8faff;border-bottom:1px solid var(--border);white-space:nowrap}
.clients-table td{padding:11px 14px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
.clients-table tr:hover td{background:#f8faff}
.client-avatar{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0}
.points-bar{background:#e2e8f0;border-radius:99px;height:5px;overflow:hidden;width:80px;display:inline-block}
.points-fill{height:100%;border-radius:99px;background:linear-gradient(90deg,var(--blue),var(--blue2))}

/* CARTE FIDELITE */
.fid-card{background:linear-gradient(135deg,#0f1f5c,#1a3dce,#4f7ef8);border-radius:16px;padding:22px;color:#fff;position:relative;overflow:hidden;min-height:160px}
.fid-card::before{content:'';position:absolute;right:-30px;top:-30px;width:160px;height:160px;border-radius:50%;background:rgba(255,255,255,.05)}
.fid-card::after{content:'';position:absolute;left:40px;bottom:-50px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.04)}
.fid-card-title{font-size:11px;font-weight:700;opacity:.6;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.fid-card-name{font-size:18px;font-weight:800;margin-bottom:14px}
.tampons-row{display:flex;gap:8px;flex-wrap:wrap}
.tampon{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,.3);display:flex;align-items:center;justify-content:center;font-size:16px;transition:.2s}
.tampon.done{background:rgba(255,255,255,.25);border-color:rgba(255,255,255,.6)}
.tampon.reward{background:linear-gradient(135deg,#f59e0b,#fbbf24);border-color:#fbbf24}
.fid-card-footer{position:absolute;bottom:16px;right:20px;font-size:10px;opacity:.5}

/* PROGRAMME POINTS */
.palier{background:#f8faff;border:1px solid var(--border);border-radius:10px;padding:14px;display:flex;align-items:center;gap:12px;transition:.2s}
.palier:hover{border-color:var(--blue2);background:#eff6ff}
.palier-pts{font-size:20px;font-weight:800;color:var(--blue);min-width:70px;text-align:center}
.palier-info{flex:1}
.palier-reward{font-size:13px;font-weight:700}
.palier-sub{font-size:11px;color:var(--muted);margin-top:2px}
.palier-badge{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;background:#ede9fe;color:var(--purple)}

/* COUPONS */
.coupon{background:#fff;border:2px dashed var(--border);border-radius:12px;padding:16px 18px;display:flex;align-items:center;gap:14px;position:relative;transition:.2s}
.coupon:hover{border-color:var(--blue2)}
.coupon.active{border-color:var(--green);background:#f0fdf4}
.coupon.expired{opacity:.5}
.coupon-val{font-size:26px;font-weight:800;color:var(--blue);min-width:70px;text-align:center;line-height:1}
.coupon-info{flex:1}
.coupon-name{font-size:13px;font-weight:700;margin-bottom:3px}
.coupon-meta{font-size:11px;color:var(--muted)}
.coupon-code{font-family:monospace;font-size:12px;font-weight:700;background:#f1f5f9;padding:3px 8px;border-radius:5px;letter-spacing:1px}
.coupon-used{font-size:11px;color:var(--muted);margin-top:4px}
.coupon-status{position:absolute;top:10px;right:10px}

/* CAMPAGNES */
.camp-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
.camp-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.camp-icon.sms{background:#fef3c7}
.camp-icon.email{background:#ede9fe}
.camp-title{font-size:13px;font-weight:700;margin-bottom:3px}
.camp-meta{font-size:11px;color:var(--muted)}
.camp-stats{text-align:right}
.camp-stat-val{font-size:15px;font-weight:800;color:var(--blue)}
.camp-stat-lbl{font-size:10px;color:var(--muted)}

/* CONFIG */
.config-row{display:flex;align-items:center;justify-content:space-between;padding:14px 0;border-bottom:1px solid var(--border)}
.config-row:last-child{border-bottom:none}
.config-label{font-size:13px;font-weight:600}
.config-sub{font-size:11px;color:var(--muted);margin-top:2px}
.config-input{display:flex;align-items:center;gap:8px}
.ci{padding:7px 12px;border:1.5px solid var(--border);border-radius:8px;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:700;width:90px;outline:none;transition:.15s;text-align:center}
.ci:focus{border-color:var(--blue2)}

/* TOGGLE */
.toggle{position:relative;width:40px;height:22px;flex-shrink:0}
.toggle input{display:none}
.toggle-slider{position:absolute;inset:0;background:#e2e8f0;border-radius:22px;cursor:pointer;transition:.3s}
.toggle-slider::before{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:#fff;top:2px;left:2px;transition:.3s;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.toggle input:checked+.toggle-slider{background:var(--green)}
.toggle input:checked+.toggle-slider::before{transform:translateX(18px)}

/* MODAL */
.modal-wrap{position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center}
.modal-wrap:not(.hidden){display:flex}
.modal-backdrop{position:absolute;inset:0;background:rgba(15,31,92,.45);backdrop-filter:blur(4px)}
.modal{background:#fff;border-radius:var(--radius);width:min(520px,95vw);max-height:92vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.25);position:relative;z-index:1;animation:modalIn .2s ease}
@keyframes modalIn{from{opacity:0;transform:translateY(16px) scale(.97)}to{opacity:1;transform:none}}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:18px 20px 14px;border-bottom:1px solid var(--border)}
.modal-title{font-size:15px;font-weight:800;display:flex;align-items:center;gap:7px}
.modal-close{background:none;border:none;font-size:16px;cursor:pointer;color:var(--muted);padding:4px 8px;border-radius:6px;line-height:1;transition:.15s}
.modal-close:hover{background:#f1f5f9;color:var(--text)}
.modal .g2,.modal .field,.modal .modal-footer{padding:0 20px}
.modal .g2:first-of-type,.modal .field:first-of-type{margin-top:16px}
.modal-footer{padding:14px 20px 20px;border-top:1px solid var(--border);margin-top:16px;display:flex;gap:8px;justify-content:flex-end}
#fc-panel-infos,#fc-panel-points,#fc-panel-carte,#fc-panel-histo{
  padding:20px 22px 16px;display:flex;flex-direction:column;gap:14px;
  min-height:200px
}
#fc-panel-infos .g2{padding:0!important;display:grid;grid-template-columns:1fr 1fr;gap:12px}
#fc-panel-infos .field,#fc-panel-infos .g2 .field{padding:0!important;margin:0}
#mw-ficheClient .modal{width:min(600px,96vw)}
#mw-ficheClient .modal-head{padding:20px 24px 16px}
#mw-ficheClient .modal-footer{padding:16px 22px 22px}
.fc-tab{padding:9px 14px;font-size:12px;font-weight:600;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:.15s;white-space:nowrap}
.fc-tab:hover{color:var(--text)}
.fc-tab.on{color:var(--blue);border-bottom-color:var(--blue)}
.field{display:flex;flex-direction:column;gap:5px;margin-bottom:12px}
.field label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.field-wrap{display:flex;align-items:center;gap:8px;padding:9px 13px;border:1.5px solid var(--border);border-radius:10px;background:#f8faff;transition:.15s}
.field-wrap:focus-within{border-color:var(--blue2);background:#fff;box-shadow:0 0 0 3px rgba(79,126,248,.1)}
.field-in{flex:1;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;color:var(--text);outline:none}
.field-sel{flex:1;border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:13px;font-weight:600;color:var(--text);outline:none;cursor:pointer}
.modal-footer{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}

/* TOAST */
.toast{position:fixed;bottom:18px;right:18px;padding:10px 16px;border-radius:9px;font-size:13px;font-weight:600;z-index:9999;transform:translateY(60px);opacity:0;transition:.3s}
.toast.show{transform:translateY(0);opacity:1}
.toast.ok{background:var(--green);color:#fff}
.toast.err{background:var(--red);color:#fff}
.toast.info{background:var(--blue);color:#fff}

/* SEARCH */
.search-wrap{display:flex;align-items:center;gap:8px;padding:8px 14px;border:1.5px solid var(--border);border-radius:10px;background:#f8faff;flex:1}
.search-wrap:focus-within{border-color:var(--blue2);background:#fff}
.search-in{border:none;background:transparent;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:500;outline:none;flex:1;min-width:0}

/* PRO LOCK */
.pro-lock{background:linear-gradient(135deg,#fffbeb,#fef3c7);border:1.5px solid #fde68a;border-radius:12px;padding:16px 20px;display:flex;align-items:center;gap:14px}
.pro-lock-ico{font-size:28px}
.pro-lock-title{font-size:13px;font-weight:800;color:#92400e;margin-bottom:3px}
.pro-lock-sub{font-size:12px;color:#92400e;opacity:.75}

/* HAMBURGER */
.hamburger{display:none;position:fixed;top:14px;left:14px;z-index:1001;width:44px;height:44px;background:#0f1f5c;border:none;border-radius:12px;cursor:pointer;flex-direction:column;align-items:center;justify-content:center;gap:5px;box-shadow:0 4px 16px rgba(15,31,92,.45)}
.hamburger span{display:block;width:20px;height:2.5px;background:#fff;border-radius:2px;transition:all .25s;pointer-events:none}
.hamburger.open span:nth-child(1){transform:translateY(7.5px) rotate(45deg)}
.hamburger.open span:nth-child(2){opacity:0;transform:scaleX(0)}
.hamburger.open span:nth-child(3){transform:translateY(-7.5px) rotate(-45deg)}
.nav-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000}
.nav-overlay.show{display:block}
html,body{overflow-x:hidden;max-width:100vw}

@media(max-width:768px){
  .hamburger{display:flex!important}
  nav{position:fixed!important;top:0!important;left:0!important;height:100vh!important;height:-webkit-fill-available!important;width:min(280px,84vw)!important;z-index:1001!important;transform:translateX(-105%)!important;transition:transform .3s cubic-bezier(.4,0,.2,1)!important;overflow-y:auto!important;-webkit-overflow-scrolling:touch!important;margin:0!important}
  nav.open{transform:translateX(0)!important;box-shadow:8px 0 32px rgba(0,0,0,.3)!important}
  main{margin-left:0!important;width:100vw!important;overflow-x:hidden!important}
  .topbar{padding:10px 10px 10px 62px!important;flex-wrap:wrap!important;gap:6px!important}
  .panel{padding:12px 10px!important}
  .g2,.g3,.g4{grid-template-columns:1fr 1fr!important;gap:10px!important}
  .main-tabs{padding:0 10px!important}
  .mtab{padding:10px 12px!important;font-size:11px!important}
  table{min-width:500px}
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
  .camp-card{grid-template-columns:auto 1fr!important}
  .camp-stats{display:none}
}
@media(max-width:420px){
  .g2,.g3,.g4{grid-template-columns:1fr!important}
}

  .sms-pack{display:flex;align-items:center;padding:16px;border:2px solid var(--border);border-radius:14px;cursor:pointer;transition:.2s;background:#fff}
  .sms-pack:hover{border-color:var(--blue);background:#f8fbff}
  .sms-pack.selected{border-color:var(--blue);background:#eff6ff;box-shadow:0 0 0 3px rgba(79,126,248,.15)}
</style>
</head>
<body>

<button class="hamburger" id="hamburger" onclick="toggleSidebar()" aria-label="Menu">
  <span></span><span></span><span></span>
</button>
<div class="nav-overlay" id="navOverlay" onclick="closeSidebar()"></div>

<nav>
  <div class="logo"><div class="logo-i">ğŸ“Š</div><div class="logo-t">ALTIORA</div></div>
  <div class="ns">Principal</div>
  <div class="ni" onclick="go('dashboard.html')"><span>ğŸ </span><span>Tableau de bord</span></div>
  <div class="ni" onclick="go('suivi-ca.html')"><span>ğŸ“ˆ</span><span>Suivi CA & RÃ©sultats</span></div>
  <div class="ni" onclick="toggleNav('kpis-sub',this)"><span>ğŸ¯</span><span style="flex:1">KPIs ClÃ©s</span><span class="chev">â€º</span></div>
  <div class="sub" id="kpis-sub">
    <div class="si" onclick="go('cout-revient.html')"><span class="dot"></span>CoÃ»t de revient</div>
    <div class="si" onclick="go('marges.html')"><span class="dot"></span>Marge brute & nette</div>
    <div class="si" onclick="go('panier-moyen.html')"><span class="dot"></span>Panier moyen</div>
  </div>
  <div class="ni" onclick="toggleNav('pil-sub',this)"><span>ğŸ§­</span><span style="flex:1">Pilotage</span><span class="chev">â€º</span></div>
  <div class="sub" id="pil-sub">
    <div class="si" onclick="go('pilotage.html?year=2025')"><span class="dot"></span>Pilotage 2025</div>
    <div class="si" onclick="go('pilotage.html?year=2026')"><span class="dot"></span>Pilotage 2026</div>
    <div class="si" onclick="go('pilotage.html?year=2027')"><span class="dot"></span>Pilotage 2027</div>
  </div>
  <div class="ni" onclick="go('dettes.html')"><span>ğŸ¦</span><span>Dettes & Emprunts</span></div>
  <div class="ns">FidÃ©lisation</div>
  <div class="ni on" onclick="toggleNav('fid-sub',this)"><span>ğŸ’</span><span style="flex:1">FidÃ©lisation</span><span class="chev" id="chev-fid" style="transform:rotate(90deg)">â€º</span></div>
  <div class="sub open" id="fid-sub">
    <div class="si on" onclick="switchTab('dashboard',this)"><span class="dot"></span>Dashboard</div>
    <div class="si" onclick="switchTab('clients',this)"><span class="dot"></span>Clients</div>
    <div class="si" onclick="switchTab('carte',this)"><span class="dot"></span>Carte fidÃ©litÃ©</div>
    <div class="si" onclick="switchTab('points',this)"><span class="dot"></span>Points & RÃ©compenses</div>
    <div class="si" onclick="switchTab('coupons',this)"><span class="dot"></span>Coupons & Offres</div>
    <div class="si" onclick="switchTab('campagnes',this)"><span class="dot"></span>Campagnes</div>
    <div class="si" onclick="switchTab('config',this)"><span class="dot"></span>Configuration</div>
  </div>
  <div class="ns">Outils</div>
  <div class="ni" onclick="go('import.html')"><span>ğŸ“¥</span><span>Import de donnÃ©es</span></div>
  <div class="nav-footer">
    <div class="ucard" onclick="go('profil.html')">
      <div class="uav" id="av">A</div>
      <div><div class="un" id="uname">Utilisateur</div><div class="upl">Plan Pro</div></div>
      <button class="lbtn" onclick="event.stopPropagation();doLogout()">â‹</button>
    </div>
  </div>
</nav>

<main>
  <div class="topbar">
    <div>
      <h1>ğŸ’ FidÃ©lisation client <span style="background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#fff;font-size:10px;font-weight:800;padding:2px 8px;border-radius:20px;margin-left:6px">PRO</span></h1>
      <p>GÃ©rez vos programmes de fidÃ©litÃ©, clients et campagnes</p>
    </div>
    <div class="tb-r">
      <button class="btn btn-o btn-xs" onclick="go('client-fidelite.html')" target="_blank">ğŸ‘ï¸ Vue client</button>
      <button class="btn btn-p btn-xs" onclick="openModal('addClient')">+ Ajouter client</button>
    </div>
  </div>

  <!-- TABS -->
  <div class="main-tabs" id="mainTabs">
    <div class="mtab on" data-tab="dashboard" onclick="switchTab('dashboard',this)">ğŸ“Š Dashboard</div>
    <div class="mtab" data-tab="clients" onclick="switchTab('clients',this)">ğŸ‘¥ Clients <span class="badge-tab" id="badge-clients">0</span></div>
    <div class="mtab" data-tab="carte" onclick="switchTab('carte',this)">ğŸ´ Carte fidÃ©litÃ©</div>
    <div class="mtab" data-tab="points" onclick="switchTab('points',this)">â­ Points & RÃ©compenses</div>
    <div class="mtab" data-tab="coupons" onclick="switchTab('coupons',this)">ğŸ« Coupons <span class="badge-tab" id="badge-coupons">0</span></div>
    <div class="mtab" data-tab="campagnes" onclick="switchTab('campagnes',this)">ğŸ“£ Campagnes <span class="badge-pro">PRO</span></div>
    <div class="mtab" data-tab="config" onclick="switchTab('config',this)">âš™ï¸ Config</div>
  </div>

  <!-- â•â•â• DASHBOARD â•â•â• -->
  <div class="panel on" id="panel-dashboard">
    <div class="g4" id="kpiGrid"></div>
    <div class="g2">
      <div class="card">
        <div class="card-head"><div class="card-title">ğŸ“ˆ Ã‰volution clients fidÃ¨les</div></div>
        <div class="card-body"><canvas id="chartClients" height="180"></canvas></div>
      </div>
      <div class="card">
        <div class="card-head"><div class="card-title">ğŸ¥§ RÃ©partition segments</div></div>
        <div class="card-body"><canvas id="chartSegments" height="180"></canvas></div>
      </div>
    </div>
    <div class="g2">
      <div class="card">
        <div class="card-head"><div class="card-title">ğŸ‚ Anniversaires ce mois</div></div>
        <div class="card-body" id="birthdayList" style="display:flex;flex-direction:column;gap:8px"></div>
      </div>
      <div class="card">
        <div class="card-head"><div class="card-title">ğŸ˜´ Clients inactifs (+60j)</div></div>
        <div class="card-body" id="inactiveList" style="display:flex;flex-direction:column;gap:8px"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â• CLIENTS â•â•â• -->
  <div class="panel" id="panel-clients">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
      <div class="search-wrap"><span>ğŸ”</span><input class="search-in" id="searchClient" placeholder="Rechercher un client..." oninput="renderClients()"/></div>
      <select class="ci" id="filterSeg" onchange="renderClients()" style="width:140px">
        <option value="">Tous les segments</option>
        <option value="vip">ğŸ‘‘ VIP</option>
        <option value="actif">âœ… Actif</option>
        <option value="inactif">ğŸ˜´ Inactif</option>
        <option value="nouveau">ğŸŒ± Nouveau</option>
      </select>
      <button class="btn btn-p btn-xs" onclick="openModal('addClient')">+ Client</button>
    </div>
    <div class="card">
      <div class="table-wrap">
        <table class="clients-table">
          <thead>
            <tr>
              <th>Client</th><th>Segment</th><th>Points</th><th>Tampons</th>
              <th>DerniÃ¨re visite</th><th>Anniversaire</th><th>Actions</th>
            </tr>
          </thead>
          <tbody id="clientsTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â•â•â• CARTE FIDELITE â•â•â• -->
  <div class="panel" id="panel-carte">
    <div class="g2">
      <div>
        <div class="card-title" style="margin-bottom:12px">ğŸ´ AperÃ§u carte client</div>
        <div class="fid-card" id="fidCardPreview">
          <div class="fid-card-title">CARTE FIDÃ‰LITÃ‰</div>
          <div class="fid-card-name" id="fidCardBusiness">Votre Boutique</div>
          <div class="tampons-row" id="fidCardTampons"></div>
          <div class="fid-card-footer">ALTIORA FIDÃ‰LITÃ‰</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn btn-o btn-xs" onclick="switchTab('clients',null);setTimeout(()=>document.getElementById('searchClient').focus(),200)">ğŸ‘¥ Voir clients</button>
          <button class="btn btn-p btn-xs" onclick="openModal('addTampon')">âœ… Valider tampon</button>
        </div>
      </div>
      <div class="card">
        <div class="card-head"><div class="card-title">âš™ï¸ Configuration carte</div></div>
        <div class="card-body">
          <div class="config-row">
            <div><div class="config-label">Tampons requis</div><div class="config-sub">Nombre de tampons avant rÃ©compense</div></div>
            <div class="config-input"><input class="ci" type="number" id="cfg-tampons" value="10" min="2" max="20" onchange="saveConfig();renderFidCard()"/ "updateFidCard();debounceSaveConfig()"></div>
          </div>
          <div class="config-row">
            <div><div class="config-label">RÃ©compense</div><div class="config-sub">Ce que le client obtient</div></div>
            <div class="config-input"><input class="ci" type="text" id="cfg-reward" value="1 produit offert" style="width:160px" onchange="saveConfig()"/ "updateFidCard();debounceSaveConfig()"></div>
          </div>
          <div class="config-row">
            <div><div class="config-label">Emoji tampon</div><div class="config-sub">IcÃ´ne affichÃ©e sur la carte</div></div>
            <div class="config-input">
              <select class="ci" id="cfg-emoji" onchange="saveConfig();renderFidCard()" style="width:80px">
                <option>â˜•</option><option>ğŸ•</option><option>ğŸ¥</option><option>ğŸ’‡</option><option>ğŸ’†</option>
                <option>ğŸ›ï¸</option><option>â­</option><option>â¤ï¸</option><option>ğŸµ</option><option>ğŸŒŸ</option>
              </select>
            </div>
          </div>
          <div class="config-row">
            <div><div class="config-label">ValiditÃ© (jours)</div><div class="config-sub">Expiration des tampons</div></div>
            <div class="config-input"><input class="ci" type="number" id="cfg-validity" value="365" min="30" onchange="saveConfig()"/></div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-head"><div class="card-title">ğŸ“Š Stats carte fidÃ©litÃ©</div></div>
      <div class="card-body">
        <div class="g4" id="carteStats"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â• POINTS & RÃ‰COMPENSES â•â•â• -->
  <div class="panel" id="panel-points">
    <div class="g2">
      <div class="card">
        <div class="card-head"><div class="card-title">âš™ï¸ RÃ¨gles de gain</div></div>
        <div class="card-body">
          <div class="config-row">
            <div><div class="config-label">Points par euro dÃ©pensÃ©</div><div class="config-sub">Ex: 1â‚¬ = 10 points</div></div>
            <div class="config-input"><input class="ci" type="number" id="cfg-pts-per-euro" value="10" min="1" onchange="saveConfig()"/ "debounceSaveConfig()"><span style="font-size:11px;color:var(--muted)">pts/â‚¬</span></div>
          </div>
          <div class="config-row">
            <div><div class="config-label">Bonus anniversaire</div><div class="config-sub">Points offerts le jour J</div></div>
            <div class="config-input"><input class="ci" type="number" id="cfg-bday-pts" value="200" onchange="saveConfig()"/ "debounceSaveConfig()"><span style="font-size:11px;color:var(--muted)">pts</span></div>
          </div>
          <div class="config-row">
            <div><div class="config-label">Bonus parrainage</div><div class="config-sub">Points offerts si parrainage</div></div>
            <div class="config-input"><input class="ci" type="number" id="cfg-ref-pts" value="500" onchange="saveConfig()"/><span style="font-size:11px;color:var(--muted)">pts</span></div>
          </div>
          <div class="config-row">
            <div><div class="config-label">Points = VIP</div><div class="config-sub">Seuil pour statut VIP</div></div>
            <div class="config-input"><input class="ci" type="number" id="cfg-vip-pts" value="2000" onchange="saveConfig()"/ "debounceSaveConfig()"><span style="font-size:11px;color:var(--muted)">pts</span></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-head">
          <div class="card-title">ğŸ† Paliers de rÃ©compenses</div>
          <button class="btn btn-o btn-xs" onclick="openModal('addPalier')">+ Palier</button>
        </div>
        <div class="card-body" style="display:flex;flex-direction:column;gap:8px" id="paliersList"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-head"><div class="card-title">ğŸ“‹ Historique points clients (top 10)</div></div>
      <div class="table-wrap">
        <table class="clients-table">
          <thead><tr><th>Client</th><th>Points totaux</th><th>Points disponibles</th><th>Statut</th><th>Action</th></tr></thead>
          <tbody id="pointsTbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â•â•â• COUPONS â•â•â• -->
  <div class="panel" id="panel-coupons">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
      <div style="display:flex;gap:8px">
        <button class="btn btn-o btn-xs" id="filt-all" onclick="filterCoupons('all',this)" style="border-color:var(--blue);color:var(--blue)">Tous</button>
        <button class="btn btn-o btn-xs" id="filt-active" onclick="filterCoupons('active',this)">Actifs</button>
        <button class="btn btn-o btn-xs" id="filt-used" onclick="filterCoupons('used',this)">UtilisÃ©s</button>
      </div>
      <button class="btn btn-p btn-xs" onclick="openModal('addCoupon')">+ CrÃ©er coupon</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px" id="couponsList"></div>
  </div>

  <!-- â•â•â• CAMPAGNES â•â•â• -->
  <div class="panel" id="panel-campagnes">

    <!-- Solde SMS -->
    <div style="background:linear-gradient(135deg,#0f1f5c,#1a3dce);border-radius:16px;padding:20px;color:#fff;margin-bottom:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
        <div>
          <div style="font-size:11px;font-weight:700;opacity:.7;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px">CrÃ©dits SMS disponibles</div>
          <div style="font-size:40px;font-weight:900;line-height:1" id="smsCreditsDisplay">â€”</div>
          <div style="font-size:12px;opacity:.7;margin-top:4px">SMS restants</div>
        </div>
        <button onclick="openModal('acheterSms')" style="background:rgba(255,255,255,.2);border:1.5px solid rgba(255,255,255,.4);color:#fff;padding:10px 18px;border-radius:12px;font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;backdrop-filter:blur(4px)">+ Acheter des SMS</button>
      </div>
    </div>

    <!-- Bouton nouvelle campagne -->
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:12px">
      <div style="font-size:13px;font-weight:700">ğŸ“£ Vos campagnes</div>
      <button class="btn btn-pink btn-xs" onclick="openModal('addCampagne')">+ Nouvelle campagne</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:10px" id="campagnesList"></div>
  </div>

  <!-- â•â•â• CONFIG â•â•â• -->
  <div class="panel" id="panel-config">
    <div class="g2">
      <div class="card">
        <div class="card-head"><div class="card-title">ğŸª Informations boutique</div></div>
        <div class="card-body">
          <div class="field"><label>Nom boutique (affichÃ© sur carte)</label><div class="field-wrap"><input class="field-in" id="cfg-shop-name" placeholder="Ma Boutique" oninput="saveConfig();renderFidCard()"/ "debounceSaveConfig()"></div></div>
          <div class="field"><label>Secteur</label><div class="field-wrap"><select class="field-sel" id="cfg-sector"><option>ğŸ¥ Boulangerie</option><option>â˜• CafÃ©</option><option>ğŸ• Restaurant</option><option>ğŸ’‡ Coiffeur</option><option>ğŸ’† Bien-Ãªtre</option><option>ğŸ›ï¸ Commerce</option><option>Autre</option></select></div></div>
          <div class="field"><label>Couleur carte</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <div class="color-pick" style="width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,#0f1f5c,#4f7ef8);cursor:pointer;border:2px solid var(--blue)" onclick="setCfgColor('blue')"></div>
              <div class="color-pick" style="width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,#065f46,#10b981);cursor:pointer" onclick="setCfgColor('green')"></div>
              <div class="color-pick" style="width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,#92400e,#f59e0b);cursor:pointer" onclick="setCfgColor('orange')"></div>
              <div class="color-pick" style="width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,#5b21b6,#6366f1);cursor:pointer" onclick="setCfgColor('purple')"></div>
              <div class="color-pick" style="width:28px;height:28px;border-radius:6px;background:linear-gradient(135deg,#831843,#ec4899);cursor:pointer" onclick="setCfgColor('pink')"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="card-head"><div class="card-title">ğŸ”” Notifications automatiques</div></div>
        <div class="card-body">
          <div class="config-row">
            <div><div class="config-label">Alerte anniversaire</div><div class="config-sub">Notifier J-7 avant l'anniversaire</div></div>
            <label class="toggle"><input type="checkbox" id="cfg-notif-bday" checked onchange="saveConfig()"/><span class="toggle-slider"></span></label>
          </div>
          <div class="config-row">
            <div><div class="config-label">Alerte inactivitÃ©</div><div class="config-sub">Notifier aprÃ¨s 60j sans visite</div></div>
            <label class="toggle"><input type="checkbox" id="cfg-notif-inactif" checked onchange="saveConfig()"/><span class="toggle-slider"></span></label>
          </div>
          <div class="config-row">
            <div><div class="config-label">Alerte palier atteint</div><div class="config-sub">Notifier quand un client monte de niveau</div></div>
            <label class="toggle"><input type="checkbox" id="cfg-notif-palier" checked onchange="saveConfig()"/><span class="toggle-slider"></span></label>
          </div>
          <div class="config-row">
            <div><div class="config-label">Coupon expiration</div><div class="config-sub">Rappel J-3 avant expiration coupon</div></div>
            <label class="toggle"><input type="checkbox" id="cfg-notif-coupon" onchange="saveConfig()"/><span class="toggle-slider"></span></label>
          </div>
        </div>
      </div>
    </div>
    <div class="card" style="border-color:#bbf7d0">
      <div class="card-head" style="background:#f0fdf4">
        <div class="card-title" style="color:#065f46">â˜ï¸ Synchronisation Firebase</div>
      </div>
      <div class="card-body">
        <div style="font-size:12px;color:var(--muted);margin-bottom:12px">
          Si vos clients existent en local mais ne sont pas visibles sur leur tÃ©lÃ©phone, cliquez ici pour les envoyer vers Firebase.
        </div>
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
          <button class="btn btn-xs" style="background:#f0fdf4;color:#065f46;border:1.5px solid #bbf7d0;font-size:12px;padding:8px 16px" onclick="syncAllToFirebase()">
            â˜ï¸ Synchroniser tous les clients vers Firebase
          </button>
          <div id="syncStatus" style="font-size:11px;color:var(--muted)"></div>
        </div>
      </div>
    </div>

    <div class="card" style="border-color:#fecaca">
      <div class="card-head" style="background:#fef2f2"><div class="card-title" style="color:var(--red)">âš ï¸ Zone danger</div></div>
      <div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-xs" style="background:#fef2f2;color:var(--red);border:1.5px solid #fecaca" onclick="if(confirm('RÃ©initialiser TOUS les points ?'))resetPoints()">ğŸ”„ Reset tous les points</button>
        <button class="btn btn-xs" style="background:#fef2f2;color:var(--red);border:1.5px solid #fecaca" onclick="if(confirm('Supprimer TOUS les clients fidÃ©litÃ© ?'))resetClients()">ğŸ—‘ï¸ Supprimer tous les clients</button>
      </div>
    </div>
  </div>
</main>

<!-- MODALS -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MODALS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- ADD CLIENT -->
<div class="modal-wrap hidden" id="mw-addClient">
  <div class="modal-backdrop" onclick="closeModal('addClient')"></div>
  <div class="modal">
    <div class="modal-head"><div class="modal-title">ğŸ‘¤ Ajouter un client</div><button class="modal-close" onclick="closeModal('addClient')">âœ•</button></div>
    <div class="g2">
      <div class="field"><label>PrÃ©nom *</label><div class="field-wrap"><input class="field-in" id="nc-prenom" placeholder="Marie"/></div></div>
      <div class="field"><label>Nom *</label><div class="field-wrap"><input class="field-in" id="nc-nom" placeholder="Martin"/></div></div>
    </div>
    <div class="field"><label>TÃ©lÃ©phone</label><div class="field-wrap"><input class="field-in" id="nc-tel" placeholder="06 12 34 56 78" type="tel"/></div></div>
    <div class="field"><label>Email</label><div class="field-wrap"><input class="field-in" id="nc-email" placeholder="marie@email.com" type="email"/></div></div>
    <div class="field"><label>Date de naissance</label><div class="field-wrap"><input class="field-in" id="nc-bday" type="date"/></div></div>
    <div class="field"><label>Points de dÃ©part</label><div class="field-wrap"><input class="field-in" id="nc-pts" type="number" value="0" min="0"/></div></div>
    <div class="modal-footer">
      <button class="btn btn-o" onclick="closeModal('addClient')">Annuler</button>
      <button class="btn btn-p" onclick="addClient()">âœ… Ajouter</button>
    </div>
  </div>
</div>

<!-- FICHE CLIENT (Ã©dition) -->
<div class="modal-wrap hidden" id="mw-ficheClient">
  <div class="modal-backdrop" onclick="closeModal('ficheClient')"></div>
  <div class="modal" style="width:min(580px,95vw)">
    <div class="modal-head"><div class="modal-title">âœï¸ Fiche client</div><button class="modal-close" onclick="closeModal('ficheClient')">âœ•</button></div>
    <div style="padding:16px 22px;border-bottom:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:10px">
        <div id="fc-avatar" style="width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;color:#fff;flex-shrink:0;background:#4f7ef8"></div>
        <div style="flex:1;min-width:0">
          <div id="fc-name" style="font-size:17px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"></div>
          <div id="fc-seg" style="font-size:12px;color:var(--muted);margin-top:2px"></div>
        </div>
        <div style="text-align:right;flex-shrink:0">
          <div style="font-size:24px;font-weight:800;color:var(--blue);white-space:nowrap" id="fc-pts-display">0</div>
          <div style="font-size:10px;color:var(--muted)">points</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="fc-link-btn" onclick="fcCopyLink()" style="padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;background:#eff6ff;color:var(--blue);border:1px solid #bfdbfe;font-family:inherit">ğŸ”— Copier le lien client</button>
        <button onclick="fcShowLink()" style="padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;background:#f0fdf4;color:var(--green);border:1px solid #bbf7d0;font-family:inherit">ğŸ‘ï¸ Voir le lien</button>
      </div>
      <div id="fc-link-display" style="display:none;margin-top:8px;font-size:9px;word-break:break-all;color:var(--muted);background:#f8faff;padding:6px 10px;border-radius:8px;border:1px solid var(--border)"></div>
    </div>
    <!-- TABS internes -->
    <div style="display:flex;gap:0;border-bottom:1px solid var(--border)">
      <div class="fc-tab on" onclick="fcTab('infos',this)">ğŸ“‹ Infos</div>
      <div class="fc-tab" onclick="fcTab('points',this)">â­ Points</div>
      <div class="fc-tab" onclick="fcTab('carte',this)">ğŸ´ Carte</div>
      <div class="fc-tab" onclick="fcTab('histo',this)">ğŸ“… Historique</div>
    </div>
    <!-- Infos -->
    <div id="fc-panel-infos">
      <div class="g2">
        <div class="field"><label>PrÃ©nom</label><div class="field-wrap"><input class="field-in" id="fc-prenom" oninput="fcAutoSave()"/></div></div>
        <div class="field"><label>Nom</label><div class="field-wrap"><input class="field-in" id="fc-nom" oninput="fcAutoSave()"/></div></div>
      </div>
      <div class="field"><label>TÃ©lÃ©phone</label><div class="field-wrap"><input class="field-in" id="fc-tel" type="tel" oninput="fcAutoSave()"/></div></div>
      <div class="field"><label>Email</label><div class="field-wrap"><input class="field-in" id="fc-email" type="email" oninput="fcAutoSave()"/></div></div>
      <div class="field"><label>Date de naissance</label><div class="field-wrap"><input class="field-in" id="fc-bday" type="date" onchange="fcAutoSave()"/></div></div>
      <div class="field"><label>Note interne</label><div class="field-wrap"><input class="field-in" id="fc-note" placeholder="Client rÃ©gulier du lundi..." oninput="fcAutoSave()"/></div></div>
    </div>
    <!-- Points -->
    <div id="fc-panel-points" class="hidden">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div style="background:#f0f9ff;border:1px solid #bae6fd;border-radius:12px;padding:16px;text-align:center">
          <div style="font-size:26px;font-weight:800;color:#0369a1" id="fc-pts-val">0</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">Points actuels</div>
        </div>
        <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:16px;text-align:center">
          <div style="font-size:26px;font-weight:800;color:var(--green)" id="fc-pts-total">0</div>
          <div style="font-size:11px;color:var(--muted);margin-top:4px">Total cumulÃ©</div>
        </div>
      </div>
      <div style="background:#f8faff;border:1px solid var(--border);border-radius:12px;padding:14px 16px">
        <div style="font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px">Ajuster les points</div>
        <div style="display:flex;gap:8px;align-items:center">
          <input class="ci" id="fc-pts-add" type="number" placeholder="100" min="1" style="flex:1;width:auto;text-align:left;font-size:13px"/>
          <button class="btn btn-g" onclick="fcAddPoints(1)">ï¼‹ Ajouter</button>
          <button class="btn" style="background:#fef2f2;color:var(--red);border:1.5px solid #fecaca" onclick="fcAddPoints(-1)">ï¼ Retirer</button>
        </div>
      </div>
      <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:12px 14px;font-size:12px;color:#92400e">
        ğŸ† Prochain palier : <span id="fc-next-palier" style="font-weight:700">â€”</span>
      </div>
    </div>
    <!-- Carte tampons -->
    <div id="fc-panel-carte" class="hidden">
      <div style="background:#f8faff;border:1px solid var(--border);border-radius:12px;padding:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:8px">
          <div style="font-size:15px;font-weight:800">Tampons : <span id="fc-tampons-count" style="color:var(--blue)">0</span><span style="color:var(--muted);font-weight:400"> / <span id="fc-tampons-max">10</span></span></div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-p btn-xs" onclick="fcAddTampon()">âœ… +1 tampon</button>
            <button class="btn btn-xs" style="background:#fef2f2;color:var(--red);border:1.5px solid #fecaca" onclick="fcResetTampons()">ğŸ”„ Reset</button>
          </div>
        </div>
        <div id="fc-tampons-grid" style="display:flex;gap:9px;flex-wrap:wrap"></div>
      </div>
      <div style="border-radius:12px;padding:13px 16px;font-size:12px;font-weight:600" id="fc-carte-info"></div>
    </div>
    <!-- Historique -->
    <div id="fc-panel-histo" class="hidden">
      <div id="fc-histo-list" style="display:flex;flex-direction:column;max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
    </div>
    <div class="modal-footer" id="fc-footer">
      <button class="btn btn-xs" style="background:#fef2f2;color:var(--red);border:1.5px solid #fecaca;margin-right:auto" onclick="fcDelete()">ğŸ—‘ï¸ Supprimer</button>
      <span id="fc-autosave-status" style="font-size:11px;color:var(--muted);margin-right:auto;display:none">ğŸ’¾ SauvegardÃ©</span>
      <button class="btn btn-o" onclick="closeModal('ficheClient')">Fermer</button>
    </div>
  </div>
</div>

<!-- ADD TAMPON -->
<div class="modal-wrap hidden" id="mw-addTampon">
  <div class="modal-backdrop" onclick="closeModal('addTampon')"></div>
  <div class="modal">
    <div class="modal-head"><div class="modal-title">âœ… Valider un tampon</div><button class="modal-close" onclick="closeModal('addTampon')">âœ•</button></div>
    <div class="field"><label>Client</label>
      <div class="field-wrap"><select class="field-sel" id="tp-client" onchange="updateTpPreview()"></select></div>
    </div>
    <div class="field"><label>Montant achat (â‚¬) â€” pour les points</label>
      <div class="field-wrap"><input class="field-in" id="tp-montant" type="number" min="0" placeholder="0" oninput="updateTpPreview()"/></div>
    </div>
    <div id="tp-preview" style="padding:12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:10px;font-size:12px;color:#065f46;margin:8px 0"></div>
    <div class="modal-footer">
      <button class="btn btn-o" onclick="closeModal('addTampon')">Annuler</button>
      <button class="btn btn-p" onclick="addTampon()">âœ… Valider le tampon</button>
    </div>
  </div>
</div>

<!-- ADD PALIER -->
<div class="modal-wrap hidden" id="mw-addPalier">
  <div class="modal-backdrop" onclick="closeModal('addPalier')"></div>
  <div class="modal">
    <div class="modal-head"><div class="modal-title">ğŸ† Ajouter un palier</div><button class="modal-close" onclick="closeModal('addPalier')">âœ•</button></div>
    <div class="field"><label>Points requis *</label><div class="field-wrap"><input class="field-in" id="np-pts" type="number" min="1" placeholder="500"/></div></div>
    <div class="field"><label>RÃ©compense *</label><div class="field-wrap"><input class="field-in" id="np-reward" placeholder="Ex: -10% sur votre prochaine commande"/></div></div>
    <div class="field"><label>IcÃ´ne</label>
      <div class="field-wrap">
        <select class="field-sel" id="np-icon">
          <option>ğŸ</option><option>â˜•</option><option>ğŸ•</option><option>ğŸ’°</option>
          <option>ğŸ‘‘</option><option>ğŸ’</option><option>ğŸŒŸ</option><option>ğŸ‰</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-o" onclick="closeModal('addPalier')">Annuler</button>
      <button class="btn btn-p" onclick="addPalier()">âœ… Ajouter</button>
    </div>
  </div>
</div>

<!-- ADD COUPON -->
<div class="modal-wrap hidden" id="mw-addCoupon">
  <div class="modal-backdrop" onclick="closeModal('addCoupon')"></div>
  <div class="modal">
    <div class="modal-head"><div class="modal-title">ğŸ« CrÃ©er un coupon</div><button class="modal-close" onclick="closeModal('addCoupon')">âœ•</button></div>
    <div class="field"><label>Nom du coupon *</label><div class="field-wrap"><input class="field-in" id="co-name" placeholder="Ex: Offre printemps"/></div></div>
    <div class="g2">
      <div class="field"><label>Type de rÃ©duction</label>
        <div class="field-wrap">
          <select class="field-sel" id="co-type">
            <option value="pct">% de rÃ©duction</option>
            <option value="eur">â‚¬ de rÃ©duction</option>
            <option value="free">Produit offert</option>
          </select>
        </div>
      </div>
      <div class="field"><label>Valeur</label><div class="field-wrap"><input class="field-in" id="co-val" type="number" min="0" placeholder="10"/><span style="font-size:11px;color:var(--muted)">% ou â‚¬</span></div></div>
    </div>
    <div class="field"><label>Attribuer Ã </label>
      <div class="field-wrap">
        <select class="field-sel" id="co-target" onchange="toggleCoClient()">
          <option value="all">Tous les clients</option>
          <option value="vip">VIP uniquement</option>
          <option value="inactif">Clients inactifs</option>
          <option value="nouveau">Nouveaux clients</option>
          <option value="one">Un client spÃ©cifique</option>
        </select>
      </div>
    </div>
    <div class="field hidden" id="co-client-field"><label>Client</label>
      <div class="field-wrap"><select class="field-sel" id="co-client"></select></div>
    </div>
    <div class="g2">
      <div class="field"><label>Date d'expiration</label><div class="field-wrap"><input class="field-in" id="co-exp" type="date"/></div></div>
      <div class="field"><label>Utilisations max</label><div class="field-wrap"><input class="field-in" id="co-max" type="number" min="1" value="1"/></div></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-o" onclick="closeModal('addCoupon')">Annuler</button>
      <button class="btn btn-p" onclick="addCoupon()">âœ… CrÃ©er le coupon</button>
    </div>
  </div>
</div>

<!-- ACHAT SMS -->
<div class="modal-wrap hidden" id="mw-acheterSms">
  <div class="modal-backdrop" onclick="closeModal('acheterSms')"></div>
  <div class="modal" style="width:min(480px,95vw)">
    <div class="modal-head">
      <div class="modal-title">ğŸ“± Acheter des SMS</div>
      <button class="modal-close" onclick="closeModal('acheterSms')">âœ•</button>
    </div>
    <div style="padding:20px">
      <div style="font-size:12px;color:var(--muted);margin-bottom:16px">Choisissez un pack â€” vos SMS sont crÃ©ditÃ©s immÃ©diatement aprÃ¨s paiement.</div>
      <div style="display:flex;flex-direction:column;gap:10px" id="sms-pack-list">
        <div id="spack_50" onclick="smsSelectPack('pack_50')" style="display:flex;align-items:center;padding:16px;border:2px solid #e2e8f0;border-radius:14px;cursor:pointer;background:#fff">
          <div style="font-size:26px;font-weight:900;color:#4f7ef8;min-width:50px">50</div>
          <div style="flex:1;padding:0 12px"><div style="font-size:14px;font-weight:800">Pack DÃ©couverte</div><div style="font-size:11px;color:#94a3b8">IdÃ©al pour tester</div></div>
          <div style="text-align:right"><div style="font-size:18px;font-weight:900;color:#4f7ef8">5â‚¬</div><div style="font-size:10px;color:#94a3b8">0,10â‚¬/SMS</div></div>
        </div>
        <div id="spack_200" onclick="smsSelectPack('pack_200')" style="display:flex;align-items:center;padding:16px;border:2px solid #e2e8f0;border-radius:14px;cursor:pointer;background:#fff">
          <div style="font-size:26px;font-weight:900;color:#4f7ef8;min-width:50px">200</div>
          <div style="flex:1;padding:0 12px"><div style="font-size:14px;font-weight:800">Pack Pro <span style="background:#4f7ef8;color:#fff;font-size:9px;padding:2px 7px;border-radius:10px;margin-left:4px">POPULAIRE</span></div><div style="font-size:11px;color:#94a3b8">Pour vos campagnes rÃ©guliÃ¨res</div></div>
          <div style="text-align:right"><div style="font-size:18px;font-weight:900;color:#4f7ef8">20â‚¬</div><div style="font-size:10px;color:#94a3b8">0,10â‚¬/SMS</div></div>
        </div>
        <div id="spack_500" onclick="smsSelectPack('pack_500')" style="display:flex;align-items:center;padding:16px;border:2px solid #e2e8f0;border-radius:14px;cursor:pointer;background:#fff">
          <div style="font-size:26px;font-weight:900;color:#4f7ef8;min-width:50px">500</div>
          <div style="flex:1;padding:0 12px"><div style="font-size:14px;font-weight:800">Pack Business</div><div style="font-size:11px;color:#94a3b8">Volume et Ã©conomies</div></div>
          <div style="text-align:right"><div style="font-size:18px;font-weight:900;color:#4f7ef8">40â‚¬</div><div style="font-size:10px;color:#94a3b8">0,08â‚¬/SMS</div></div>
        </div>
      </div>
      <button id="smsPayBtn" onclick="smsPayer()" style="width:100%;margin-top:16px;padding:14px;background:#4f7ef8;color:#fff;border:none;border-radius:12px;font-size:14px;font-weight:700;cursor:pointer;font-family:inherit">ğŸ’³ Payer avec Stripe</button>
    </div>
  </div>
</div>

<!-- ADD CAMPAGNE -->
<div class="modal-wrap hidden" id="mw-addCampagne">
  <div class="modal-backdrop" onclick="closeModal('addCampagne')"></div>
  <div class="modal">
    <div class="modal-head"><div class="modal-title">ğŸ“£ Nouvelle campagne</div><button class="modal-close" onclick="closeModal('addCampagne')">âœ•</button></div>
    <div class="field"><label>Nom de la campagne *</label><div class="field-wrap"><input class="field-in" id="ca-name" placeholder="Ex: Promo Ã©tÃ© 2026"/></div></div>
    <div class="g2">
      <div class="field"><label>Canal</label>
        <div class="field-wrap">
          <select class="field-sel" id="ca-canal">
            <option value="sms">ğŸ“± SMS</option>
            <option value="email">âœ‰ï¸ Email</option>
          </select>
        </div>
      </div>
      <div class="field"><label>Segment cible</label>
        <div class="field-wrap">
          <select class="field-sel" id="ca-seg">
            <option value="all">Tous les clients</option>
            <option value="vip">VIP</option>
            <option value="actif">Actifs</option>
            <option value="inactif">Inactifs</option>
            <option value="nouveau">Nouveaux</option>
          </select>
        </div>
      </div>
    </div>
    <div class="field"><label>Message *</label>
      <textarea id="ca-msg" oninput="updateCaPreview()" style="width:100%;padding:10px 13px;border:1.5px solid var(--border);border-radius:10px;font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;font-weight:500;resize:vertical;min-height:90px;outline:none" placeholder="Bonjour {prenom}, profitez de notre offre exclusive..."></textarea>
    </div>
    <div style="font-size:11px;color:var(--muted);margin-top:-8px;margin-bottom:10px">Variables : {prenom}, {points}, {tampons}, {coupon}</div>
    <div id="ca-preview" style="padding:10px 14px;background:#f8faff;border:1px solid var(--border);border-radius:10px;font-size:12px;color:var(--muted)">AperÃ§u : â€”</div>
    <div class="g2" style="margin-top:12px">
      <div class="field"><label>Date d'envoi</label><div class="field-wrap"><input class="field-in" id="ca-date" type="date"/></div></div>
      <div class="field"><label>Heure</label><div class="field-wrap"><input class="field-in" id="ca-heure" type="time" value="10:00"/></div></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-o" onclick="closeModal('addCampagne')">Annuler</button>
      <button class="btn btn-purple" onclick="saveCampagne(true)">ğŸ’¾ Planifier</button>
      <button class="btn btn-pink" onclick="saveCampagne(false)">ğŸš€ Envoyer (test)</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"="toast" id="toast"></div>

<script>
// â•â•â• Ã‰TAT â•â•â•
let clients=[], paliers=[], coupons=[], campagnes=[], cfg={};
const COLORS={blue:'linear-gradient(135deg,#0f1f5c,#1a3dce,#4f7ef8)',green:'linear-gradient(135deg,#065f46,#10b981)',orange:'linear-gradient(135deg,#92400e,#f59e0b)',purple:'linear-gradient(135deg,#5b21b6,#6366f1)',pink:'linear-gradient(135deg,#831843,#ec4899)'};

// â•â•â• NAV â•â•â•
function go(url){location.href=url}
function toggleNav(id,el){document.getElementById(id).classList.toggle('open');el.classList.toggle('on')}
function toggleSidebar(){var n=document.querySelector('nav'),b=document.getElementById('hamburger'),o=document.getElementById('navOverlay');n.classList.toggle('open');b.classList.toggle('open');o.classList.toggle('show');document.body.style.overflow=n.classList.contains('open')?'hidden':''}
function closeSidebar(){var n=document.querySelector('nav'),b=document.getElementById('hamburger'),o=document.getElementById('navOverlay');n.classList.remove('open');b.classList.remove('open');o.classList.remove('show');document.body.style.overflow=''}
async function doLogout(){try{if(window._signOut&&window._auth)await window._signOut(window._auth)}catch(e){}location.href='index.html'}

// â•â•â• TABS â•â•â•
function switchTab(id, el){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.mtab').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('#fid-sub .si').forEach(s=>s.classList.remove('on'));
  document.getElementById('panel-'+id).classList.add('on');
  document.querySelectorAll('.mtab').forEach(t=>{if(t.dataset.tab===id)t.classList.add('on')});
  if(el){
    if(el.classList.contains('si'))el.classList.add('on');
    else if(el.classList.contains('mtab'))el.classList.add('on');
  }
  if(id==='clients')renderClients();
  if(id==='points'){renderPaliers();renderPointsTable()}
  if(id==='coupons')renderCoupons();
  if(id==='campagnes'){renderCampagnes();loadSmsCredits();}
  if(id==='carte')renderCarteStats();
  if(id==='dashboard')renderDashboard();
}

// â•â•â• UTILS â•â•â•
function toast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+(type||'ok');setTimeout(()=>t.className='toast',3000)}
function fe(n){return(parseFloat(n)||0).toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' â‚¬'}
function fi(n){return Math.round(parseFloat(n)||0).toLocaleString('fr-FR')}
function uid(){return Date.now()+'_'+Math.random().toString(36).slice(2,7)}
function today(){return new Date().toISOString().slice(0,10)}
function daysSince(d){return Math.floor((Date.now()-new Date(d))/(86400000))}

function getSeg(c){
  const pts=c.points||0;
  const days=c.lastVisit?daysSince(c.lastVisit):999;
  const age=daysSince(c.createdAt||today());
  if(pts>=parseInt(cfg.vipPts||2000))return'vip';
  if(age<30)return'nouveau';
  if(days>60)return'inactif';
  return'actif';
}
function segBadge(s){
  const map={vip:['ğŸ‘‘ VIP','seg-vip'],actif:['âœ… Actif','seg-actif'],inactif:['ğŸ˜´ Inactif','seg-inactif'],nouveau:['ğŸŒ± Nouveau','seg-nouveau']};
  const [label,cls]=map[s]||['â€”',''];
  return`<span class="seg-badge ${cls}">${label}</span>`;
}
function avatarColor(name){const colors=['#4f7ef8','#10b981','#f59e0b','#6366f1','#ec4899','#14b8a6'];return colors[name.charCodeAt(0)%colors.length]}
function genCode(){return Math.random().toString(36).slice(2,8).toUpperCase()}

// â•â•â• LOAD / SAVE â•â•â•
function load(){
  try{clients=JSON.parse(localStorage.getItem('altiora_fid_clients')||'[]')}catch(e){clients=[]}
  try{paliers=JSON.parse(localStorage.getItem('altiora_fid_paliers')||'null')||defaultPaliers()}catch(e){paliers=defaultPaliers()}
  try{coupons=JSON.parse(localStorage.getItem('altiora_fid_coupons')||'[]')}catch(e){coupons=[]}
  try{campagnes=JSON.parse(localStorage.getItem('altiora_fid_campagnes')||'[]')}catch(e){campagnes=[]}
  try{cfg=JSON.parse(localStorage.getItem('altiora_fid_cfg')||'{}')}catch(e){cfg={}}
  // Appliquer config
  document.getElementById('cfg-tampons').value=cfg.tampons||10;
  document.getElementById('cfg-reward').value=cfg.reward||'1 produit offert';
  document.getElementById('cfg-emoji').value=cfg.emoji||'â˜•';
  document.getElementById('cfg-validity').value=cfg.validity||365;
  document.getElementById('cfg-pts-per-euro').value=cfg.ptsPerEuro||10;
  document.getElementById('cfg-bday-pts').value=cfg.bdayPts||200;
  document.getElementById('cfg-ref-pts').value=cfg.refPts||500;
  document.getElementById('cfg-vip-pts').value=cfg.vipPts||2000;
  document.getElementById('cfg-shop-name').value=cfg.shopName||'';
  document.getElementById('cfg-notif-bday').checked=cfg.notifBday!==false;
  document.getElementById('cfg-notif-inactif').checked=cfg.notifInactif!==false;
  document.getElementById('cfg-notif-palier').checked=cfg.notifPalier!==false;
  document.getElementById('cfg-notif-coupon').checked=!!cfg.notifCoupon;
  // Badges
  document.getElementById('badge-clients').textContent=clients.length;
  document.getElementById('badge-coupons').textContent=coupons.filter(c=>c.status==='active').length;
}
function save(clientsToSync){
  localStorage.setItem('altiora_fid_clients',JSON.stringify(clients));
  localStorage.setItem('altiora_fid_coupons',JSON.stringify(coupons));
  localStorage.setItem('altiora_fid_campagnes',JSON.stringify(campagnes));
  localStorage.setItem('altiora_fid_paliers',JSON.stringify(paliers));
  document.getElementById('badge-clients').textContent=clients.length;
  document.getElementById('badge-coupons').textContent=coupons.filter(c=>c.status==='active').length;
  // Sync Firebase en arriÃ¨re-plan
  if(window._uid && window._fbSaveClient){
    const toSync = clientsToSync || clients;
    const list = Array.isArray(toSync) ? toSync : [toSync];
    list.forEach(c=>{
      window._fbSaveClient(window._uid, c).catch(e=>console.warn('sync err',e));
    });
  }
}
function saveOne(client){
  // Sauvegarder un seul client localement + Firebase
  const idx=clients.findIndex(x=>x.id===client.id);
  if(idx>=0)clients[idx]=client;
  save([client]);
}
let _cfgSaveTimer=null;
function debounceSaveConfig(){
  clearTimeout(_cfgSaveTimer);
  _cfgSaveTimer=setTimeout(()=>{
    if(!window._uid||!window._fbSaveConfig)return;
    saveConfig();
    showAutoSaveIndicator();setTimeout(()=>hideAutoSaveIndicator(),2000);
  },1500);
}
function saveConfig(){
  cfg={...cfg,
    tampons:parseInt(document.getElementById('cfg-tampons').value)||10,
    reward:document.getElementById('cfg-reward').value||'1 produit offert',
    emoji:document.getElementById('cfg-emoji').value||'â˜•',
    validity:parseInt(document.getElementById('cfg-validity').value)||365,
    ptsPerEuro:parseInt(document.getElementById('cfg-pts-per-euro').value)||10,
    bdayPts:parseInt(document.getElementById('cfg-bday-pts').value)||200,
    refPts:parseInt(document.getElementById('cfg-ref-pts').value)||500,
    vipPts:parseInt(document.getElementById('cfg-vip-pts').value)||2000,
    shopName:document.getElementById('cfg-shop-name').value||'',
    notifBday:document.getElementById('cfg-notif-bday').checked,
    notifInactif:document.getElementById('cfg-notif-inactif').checked,
    notifPalier:document.getElementById('cfg-notif-palier').checked,
    notifCoupon:document.getElementById('cfg-notif-coupon').checked,
  };
  localStorage.setItem('altiora_fid_cfg',JSON.stringify(cfg));
  // Sync Firebase config
  if(window._uid && window._fbSaveConfig){
    window._fbSaveConfig(window._uid, cfg).catch(e=>console.warn('cfg sync err',e));
  }
}
function setCfgColor(c){cfg.cardColor=c;localStorage.setItem('altiora_fid_cfg',JSON.stringify(cfg));renderFidCard()}
function defaultPaliers(){return[
  {id:uid(),pts:100,reward:'CafÃ© offert',icon:'â˜•'},
  {id:uid(),pts:500,reward:'-10% sur votre prochain achat',icon:'ğŸ'},
  {id:uid(),pts:1000,reward:'Produit au choix offert',icon:'ğŸŒŸ'},
  {id:uid(),pts:2000,reward:'Statut VIP + cadeau surprise',icon:'ğŸ‘‘'},
]}

// â•â•â• DASHBOARD â•â•â•
let chartC=null, chartS=null;
function renderDashboard(){
  const total=clients.length;
  const actifs=clients.filter(c=>getSeg(c)==='actif').length;
  const vips=clients.filter(c=>getSeg(c)==='vip').length;
  const totalPts=clients.reduce((s,c)=>s+(c.points||0),0);
  const tauxRetour=total?Math.round(actifs/total*100):0;
  const couponsUsed=coupons.filter(c=>c.usedCount>0).length;

  document.getElementById('kpiGrid').innerHTML=`
    <div class="kpi blue"><div class="kpi-ico">ğŸ‘¥</div><div class="kpi-lbl">Clients fidÃ¨les</div><div class="kpi-val">${total}</div><div class="kpi-sub">${vips} VIP</div></div>
    <div class="kpi green"><div class="kpi-ico">ğŸ”„</div><div class="kpi-lbl">Taux de retour</div><div class="kpi-val">${tauxRetour}%</div><div class="kpi-sub">${actifs} actifs</div></div>
    <div class="kpi orange"><div class="kpi-ico">â­</div><div class="kpi-lbl">Points distribuÃ©s</div><div class="kpi-val">${fi(totalPts)}</div><div class="kpi-sub">${paliers.length} paliers</div></div>
    <div class="kpi purple"><div class="kpi-ico">ğŸ«</div><div class="kpi-lbl">Coupons utilisÃ©s</div><div class="kpi-val">${couponsUsed}</div><div class="kpi-sub">sur ${coupons.length} crÃ©Ã©s</div></div>`;

  // Chart Ã©volution (simulÃ©)
  const months=['Jan','FÃ©v','Mar','Avr','Mai','Jun','Jul','AoÃ»','Sep','Oct','Nov','DÃ©c'];
  const now=new Date().getMonth();
  const mois=months.slice(0,now+1);
  const data=mois.map((_,i)=>Math.max(0,total-Math.floor(Math.random()*3)*(mois.length-i)));
  if(chartC)chartC.destroy();
  chartC=new Chart(document.getElementById('chartClients'),{
    type:'line',
    data:{labels:mois,datasets:[{label:'Clients',data:data,borderColor:'#4f7ef8',backgroundColor:'rgba(79,126,248,.1)',tension:.4,fill:true,pointRadius:3}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'#f1f5f9'}}}}
  });

  // Chart segments
  const segs={vip:0,actif:0,inactif:0,nouveau:0};
  clients.forEach(c=>segs[getSeg(c)]++);
  if(chartS)chartS.destroy();
  chartS=new Chart(document.getElementById('chartSegments'),{
    type:'doughnut',
    data:{labels:['VIP ğŸ‘‘','Actif âœ…','Inactif ğŸ˜´','Nouveau ğŸŒ±'],datasets:[{data:[segs.vip,segs.actif,segs.inactif,segs.nouveau],backgroundColor:['#f59e0b','#10b981','#9ca3af','#6366f1'],borderWidth:0}]},
    options:{responsive:true,plugins:{legend:{position:'bottom',labels:{font:{size:11}}}},cutout:'65%'}
  });

  // Anniversaires ce mois
  const thisMonth=new Date().getMonth()+1;
  const bdayClients=clients.filter(c=>{if(!c.birthday)return false;const m=parseInt(c.birthday.split('-')[1]);return m===thisMonth});
  const bdayEl=document.getElementById('birthdayList');
  bdayEl.innerHTML=bdayClients.length
    ?bdayClients.map(c=>`<div style="display:flex;align-items:center;gap:10px;padding:8px;background:#fffbeb;border-radius:8px">
      <div class="client-avatar" style="background:${avatarColor(c.prenom)};font-size:11px">${c.prenom[0]}${c.nom[0]}</div>
      <div><div style="font-weight:700;font-size:12px">${c.prenom} ${c.nom}</div><div style="font-size:10px;color:var(--muted)">ğŸ‚ ${c.birthday?.slice(5).split('-').reverse().join('/')}</div></div>
      <button class="btn btn-xs btn-o" style="margin-left:auto" onclick="sendBdayBonus('${c.id}')">ğŸ Bonus</button>
    </div>`).join('')
    :`<div style="font-size:12px;color:var(--muted);text-align:center;padding:16px">Aucun anniversaire ce mois ğŸ‰</div>`;

  // Inactifs
  const inactifs=clients.filter(c=>getSeg(c)==='inactif').slice(0,4);
  const inactEl=document.getElementById('inactiveList');
  inactEl.innerHTML=inactifs.length
    ?inactifs.map(c=>`<div style="display:flex;align-items:center;gap:10px;padding:8px;background:#f9fafb;border-radius:8px">
      <div class="client-avatar" style="background:${avatarColor(c.prenom)};font-size:11px">${c.prenom[0]}${c.nom[0]}</div>
      <div><div style="font-weight:700;font-size:12px">${c.prenom} ${c.nom}</div><div style="font-size:10px;color:var(--muted)">Absent depuis ${c.lastVisit?daysSince(c.lastVisit):'-'} jours</div></div>
      <button class="btn btn-xs btn-o" style="margin-left:auto" onclick="sendReactivation('${c.id}')">ğŸ“£ Relancer</button>
    </div>`).join('')
    :`<div style="font-size:12px;color:var(--muted);text-align:center;padding:16px">Aucun client inactif ğŸ‰</div>`;
}

// â•â•â• CLIENTS â•â•â•
function renderClients(){
  const q=document.getElementById('searchClient').value.toLowerCase();
  const seg=document.getElementById('filterSeg').value;
  let list=clients.filter(c=>{
    const match=`${c.prenom} ${c.nom} ${c.tel||''} ${c.email||''}`.toLowerCase().includes(q);
    const segMatch=!seg||getSeg(c)===seg;
    return match&&segMatch;
  });
  const tb=document.getElementById('clientsTbody');
  if(!list.length){tb.innerHTML=`<tr><td colspan="7" style="text-align:center;padding:24px;color:var(--muted)">Aucun client${q?` pour "${q}"`:''}</td></tr>`;return}
  const cfgT=parseInt(cfg.tampons)||10;
  tb.innerHTML=list.map(c=>{
    const seg=getSeg(c);
    const pct=Math.min(100,Math.round(((c.points||0)/(parseInt(cfg.vipPts)||2000))*100));
    const bday=c.birthday?c.birthday.slice(5).split('-').reverse().join('/'):'-';
    const visit=c.lastVisit?new Date(c.lastVisit).toLocaleDateString('fr-FR'):'-';
    const tampons=c.tampons||0;
    return`<tr>
      <td><div style="display:flex;align-items:center;gap:9px">
        <div class="client-avatar" style="background:${avatarColor(c.prenom)}">${c.prenom[0]}${c.nom[0]}</div>
        <div><div style="font-weight:700">${c.prenom} ${c.nom}</div><div style="font-size:10px;color:var(--muted)">${c.email||c.tel||'â€”'}</div></div>
      </div></td>
      <td>${segBadge(seg)}</td>
      <td><div style="font-weight:700">${fi(c.points||0)}</div><div style="display:flex;align-items:center;gap:5px;margin-top:3px"><div class="points-bar"><div class="points-fill" style="width:${pct}%"></div></div><span style="font-size:10px;color:var(--muted)">${pct}%</span></div></td>
      <td><div style="font-size:12px;font-weight:700">${tampons}/${cfgT}</div><div style="font-size:10px;color:var(--muted)">${tampons>=cfgT?'ğŸ RÃ©compense!':''}</div></td>
      <td>${visit}</td>
      <td>${bday==='01/01'?'â€”':bday}</td>
      <td><div style="display:flex;gap:5px">
        <button class="btn btn-xs btn-o" onclick="openFicheClient('${c.id}');setTimeout(()=>fcTab('carte',document.querySelectorAll('.fc-tab')[2]),100)">âœ…</button>
        <button class="btn btn-xs" style="background:#ede9fe;color:var(--purple)" onclick="openFicheClient('${c.id}');setTimeout(()=>fcTab('points',document.querySelectorAll('.fc-tab')[1]),100)">+pts</button>
        <button class="btn btn-xs btn-o" onclick="openFicheClient('${c.id}')">âœï¸</button><button class="btn btn-xs" style="background:#fef2f2;color:var(--red)" onclick="deleteClient('${c.id}')">âœ•</button>
      </div></td>
    </tr>`;
  }).join('');
}

// â•â•â• CARTE FIDELITE â•â•â•
function renderFidCard(){
  const t=parseInt(document.getElementById('cfg-tampons').value)||10;
  const emoji=document.getElementById('cfg-emoji').value||'â˜•';
  const shopName=document.getElementById('cfg-shop-name').value||'Votre Boutique';
  const color=cfg.cardColor||'blue';
  document.getElementById('fidCardPreview').style.background=COLORS[color];
  document.getElementById('fidCardBusiness').textContent=shopName;
  const row=document.getElementById('fidCardTampons');
  row.innerHTML=Array.from({length:t},(_,i)=>`<div class="tampon ${i<Math.floor(t/2)?'done':''}">${i<Math.floor(t/2)?emoji:'â—‹'}</div>`).join('');
}
function renderCarteStats(){
  const total=clients.length;
  const withCard=clients.filter(c=>(c.tampons||0)>0).length;
  const full=clients.filter(c=>(c.tampons||0)>=(parseInt(cfg.tampons)||10)).length;
  const totalTampons=clients.reduce((s,c)=>s+(c.tampons||0),0);
  document.getElementById('carteStats').innerHTML=`
    <div class="kpi blue"><div class="kpi-ico">ğŸ´</div><div class="kpi-lbl">Cartes actives</div><div class="kpi-val">${withCard}</div><div class="kpi-sub">sur ${total} clients</div></div>
    <div class="kpi green"><div class="kpi-ico">âœ…</div><div class="kpi-lbl">Cartes complÃ¨tes</div><div class="kpi-val">${full}</div><div class="kpi-sub">RÃ©compense dispo</div></div>
    <div class="kpi orange"><div class="kpi-ico">ğŸ¯</div><div class="kpi-lbl">Tampons total</div><div class="kpi-val">${fi(totalTampons)}</div><div class="kpi-sub">Visites enregistrÃ©es</div></div>
    <div class="kpi purple"><div class="kpi-ico">ğŸ“Š</div><div class="kpi-lbl">Taux complÃ©tion</div><div class="kpi-val">${total?Math.round(withCard/total*100):0}%</div><div class="kpi-sub">des clients utilisent la carte</div></div>`;
}

// â•â•â• POINTS / PALIERS â•â•â•
function renderPaliers(){
  const el=document.getElementById('paliersList');
  el.innerHTML=paliers.sort((a,b)=>a.pts-b.pts).map(p=>`
    <div class="palier">
      <div class="palier-pts">${fi(p.pts)}<div style="font-size:9px;font-weight:600;color:var(--muted)">pts</div></div>
      <div class="palier-info"><div class="palier-reward">${p.icon} ${p.reward}</div></div>
      <button class="btn btn-xs" style="background:#fef2f2;color:var(--red)" onclick="deletePalier('${p.id}')">âœ•</button>
    </div>`).join('');
}
function renderPointsTable(){
  const sorted=[...clients].sort((a,b)=>(b.points||0)-(a.points||0)).slice(0,10);
  document.getElementById('pointsTbody').innerHTML=sorted.map(c=>`<tr>
    <td><div style="display:flex;align-items:center;gap:8px">
      <div class="client-avatar" style="background:${avatarColor(c.prenom)};width:26px;height:26px;font-size:10px">${c.prenom[0]}${c.nom[0]}</div>
      <span style="font-weight:600">${c.prenom} ${c.nom}</span>
    </div></td>
    <td style="font-weight:700">${fi(c.points||0)}</td>
    <td style="color:var(--green);font-weight:700">${fi(c.points||0)}</td>
    <td>${segBadge(getSeg(c))}</td>
    <td><button class="btn btn-xs btn-o" onclick="openFicheClient('${c.id}');setTimeout(()=>fcTab('points',document.querySelectorAll('.fc-tab')[1]),100)">+ Points</button></td>
  </tr>`).join('');
}

// â•â•â• COUPONS â•â•â•
let coupFilter='all';
function filterCoupons(f,btn){
  coupFilter=f;
  document.querySelectorAll('[id^="filt-"]').forEach(b=>{b.style.borderColor='var(--border)';b.style.color='';b.style.background=''});
  btn.style.borderColor='var(--blue)';btn.style.color='var(--blue)';
  renderCoupons();
}
function renderCoupons(){
  let list=coupons;
  if(coupFilter==='active')list=coupons.filter(c=>c.status==='active');
  if(coupFilter==='used')list=coupons.filter(c=>c.usedCount>0);
  const el=document.getElementById('couponsList');
  if(!list.length){el.innerHTML=`<div style="text-align:center;padding:32px;color:var(--muted);font-size:12px">Aucun coupon â€” crÃ©ez votre premiÃ¨re offre !</div>`;return}
  el.innerHTML=list.map(c=>{
    const typeLabel={pct:`-${c.val}%`,eur:`-${c.val}â‚¬`,free:'Gratuit'}[c.type]||c.val;
    const isExp=c.expDate&&new Date(c.expDate)<new Date();
    const status=isExp?'expired':c.status;
    const statusBadge={active:'<span style="background:#d1fae5;color:#065f46;font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px">âœ… Actif</span>',expired:'<span style="background:#f3f4f6;color:#6b7280;font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px">â° ExpirÃ©</span>',used:'<span style="background:#ede9fe;color:#5b21b6;font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px">âœ… UtilisÃ©</span>'}[status]||'';
    const targetLabel={all:'Tous les clients',vip:'VIP',inactif:'Inactifs',nouveau:'Nouveaux',one:c.targetName||'Client spÃ©cifique'}[c.target]||c.target;
    return`<div class="coupon ${status}">
      <div class="coupon-val">${typeLabel}</div>
      <div class="coupon-info">
        <div class="coupon-name">${c.name}</div>
        <div class="coupon-meta">ğŸ¯ ${targetLabel} Â· ${c.expDate?'Exp: '+new Date(c.expDate).toLocaleDateString('fr-FR'):'Sans expiration'}</div>
        <div style="margin-top:5px">Code : <span class="coupon-code">${c.code}</span></div>
        <div class="coupon-used">Utilisations : ${c.usedCount||0}/${c.maxUse||'âˆ'}</div>
      </div>
      <div class="coupon-status">${statusBadge}</div>
      <div style="display:flex;flex-direction:column;gap:5px;margin-left:8px">
        <button class="btn btn-xs btn-o" onclick="useCoupon('${c.id}')">âœ… Utiliser</button>
        <button class="btn btn-xs" style="background:#fef2f2;color:var(--red)" onclick="deleteCoupon('${c.id}')">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

// â•â•â• CAMPAGNES â•â•â•
function renderCampagnes(){
  const el=document.getElementById('campagnesList');
  if(!campagnes.length){el.innerHTML=`<div style="text-align:center;padding:32px;color:var(--muted);font-size:12px">Aucune campagne â€” crÃ©ez votre premiÃ¨re campagne !</div>`;return}
  el.innerHTML=campagnes.map(c=>{
    const nbCibles=clients.filter(cl=>(c.segment==='all'||getSeg(cl)===c.segment)&&cl.tel).length;
    const statutBadge=c.sent
      ?`<span style="background:#f0fdf4;color:var(--green);border:1px solid #bbf7d0;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700">âœ… EnvoyÃ©e (${c.sentCount||0} SMS)</span>`
      :`<span style="background:#fffbeb;color:#92400e;border:1px solid #fde68a;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700">â³ En attente</span>`;
    const sendBtn=c.canal==='sms'&&!c.sent
      ?`<button onclick="envoyerCampagneSMS(campagnes.find(x=>x.id==='${c.id}'))" style="background:var(--blue);color:#fff;border:none;padding:7px 14px;border-radius:9px;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap">ğŸ“± Envoyer (${nbCibles} SMS)</button>`
      :'';
    return`<div class="camp-card" style="flex-wrap:wrap;gap:10px">
      <div class="camp-icon ${c.canal}"><span style="font-size:22px">${c.canal==='sms'?'ğŸ“±':'âœ‰ï¸'}</span></div>
      <div style="flex:1;min-width:180px">
        <div class="camp-title">${c.name}</div>
        <div style="margin-top:3px">${statutBadge}</div>
        <div class="camp-meta" style="margin-top:4px">${c.canal.toUpperCase()} Â· ${c.segment==='all'?'Tous':c.segment} Â· ${new Date(c.date||Date.now()).toLocaleDateString('fr-FR')} ${c.heure||''}</div>
        <div style="margin-top:5px;font-size:12px;color:var(--muted);font-style:italic">"${c.msg.slice(0,60)}${c.msg.length>60?'â€¦':''}"</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <div class="camp-stats">
          <div class="camp-stat-val">${nbCibles}</div>
          <div class="camp-stat-lbl">avec tÃ©l</div>
        </div>
        ${sendBtn}
      </div>
    </div>`;
  }).join('');
}

// â•â•â• ACTIONS CLIENTS â•â•â•
function addClient(){
  const prenom=document.getElementById('nc-prenom').value.trim();
  const nom=document.getElementById('nc-nom').value.trim();
  if(!prenom||!nom){toast('PrÃ©nom et nom obligatoires','err');return}
  clients.push({
    id:uid(),prenom,nom,
    tel:document.getElementById('nc-tel').value.trim(),
    email:document.getElementById('nc-email').value.trim(),
    birthday:document.getElementById('nc-bday').value,
    points:parseInt(document.getElementById('nc-pts').value)||0,
    tampons:0,
    lastVisit:today(),
    createdAt:today(),
    history:[]
  });
  save();renderClients();closeModal();
  toast(`âœ… ${prenom} ${nom} ajoutÃ©(e) !`);
}

function deleteClient(id){
  if(!confirm('Supprimer ce client ?'))return;
  clients=clients.filter(c=>c.id!==id);
  save();renderClients();toast('Client supprimÃ©');
  if(window._uid && window._fbDeleteClient){
    window._fbDeleteClient(window._uid,id).catch(e=>console.warn('del err',e));
  }
}

function openTamponFor(id){
  openModal('addTampon');
  const sel=document.getElementById('tp-client');if(sel)sel.value=id;
  updateTpPreview();
}

function updateTpPreview(){
  const id=document.getElementById('tp-client').value;
  const c=clients.find(x=>x.id===id);
  if(!c)return;
  const cfgT=parseInt(cfg.tampons)||10;
  const montant=parseFloat(document.getElementById('tp-montant').value)||0;
  const pts=Math.round(montant*(parseInt(cfg.ptsPerEuro)||10));
  const newT=(c.tampons||0)+1;
  const reward=newT>=cfgT?`ğŸ RÃ‰COMPENSE DÃ‰BLOQUÃ‰E ! (${cfg.reward||'1 produit offert'})`:''
  document.getElementById('tp-preview').innerHTML=`${c.prenom} : ${c.tampons||0}â†’${newT} tampons Â· +${pts} points${reward?`<br><strong style="color:var(--green)">${reward}</strong>`:''}`;
}

function addTampon(){
  const id=document.getElementById('tp-client').value;
  const c=clients.find(x=>x.id===id);
  if(!c){toast('SÃ©lectionnez un client','err');return}
  const montant=parseFloat(document.getElementById('tp-montant').value)||0;
  const pts=Math.round(montant*(parseInt(cfg.ptsPerEuro)||10));
  const cfgT=parseInt(cfg.tampons)||10;
  c.tampons=(c.tampons||0)+1;
  c.points=(c.points||0)+pts;
  c.lastVisit=today();
  c.history=c.history||[];
  c.history.unshift({date:today(),type:'tampon',montant,pts});
  if(c.tampons>=cfgT){toast(`ğŸ‰ ${c.prenom} a complÃ©tÃ© sa carte ! RÃ©compense : ${cfg.reward||'1 produit offert'}`,'info');c.tampons=0}
  save();closeModal();
  toast(`âœ… Tampon validÃ© pour ${c.prenom} (+${pts} pts)`);
}

function addPointsManual(id){
  const pts=parseInt(prompt('Combien de points ajouter ?','100'));
  if(isNaN(pts)||pts<=0)return;
  const c=clients.find(x=>x.id===id);
  if(!c)return;
  c.points=(c.points||0)+pts;
  c.history=c.history||[];
  c.history.unshift({date:today(),type:'manuel',pts});
  save();
  toast(`+${pts} points ajoutÃ©s Ã  ${c.prenom}`);
  const activePanel=document.querySelector('.panel.on');
  if(activePanel?.id==='panel-clients')renderClients();
  if(activePanel?.id==='panel-points')renderPointsTable();
}

function sendBdayBonus(id){
  const c=clients.find(x=>x.id===id);
  if(!c)return;
  const pts=parseInt(cfg.bdayPts)||200;
  c.points=(c.points||0)+pts;
  save();
  toast(`ğŸ‚ Bonus anniversaire de ${pts} pts envoyÃ© Ã  ${c.prenom} !`,'info');
  renderDashboard();
}

function sendReactivation(id){
  const c=clients.find(x=>x.id===id);
  if(!c)return;
  toast(`ğŸ“£ Relance simulÃ©e envoyÃ©e Ã  ${c.prenom} ${c.nom}`,'info');
}

// â•â•â• PALIERS â•â•â•
function addPalier(){
  const pts=parseInt(document.getElementById('np-pts').value);
  const reward=document.getElementById('np-reward').value.trim();
  if(!pts||!reward){toast('Remplissez tous les champs','err');return}
  paliers.push({id:uid(),pts,reward,icon:document.getElementById('np-icon').value});
  localStorage.setItem('altiora_fid_paliers',JSON.stringify(paliers));
  renderPaliers();closeModal();toast('Palier ajoutÃ© !');
}
function deletePalier(id){paliers=paliers.filter(p=>p.id!==id);localStorage.setItem('altiora_fid_paliers',JSON.stringify(paliers));renderPaliers()}

// â•â•â• COUPONS â•â•â•
async function addCoupon(){
  const name=document.getElementById('co-name').value.trim();
  const val=parseFloat(document.getElementById('co-val').value)||0;
  if(!name){toast('Nom obligatoire','err');return}
  const target=document.getElementById('co-target').value;
  const targetClientId=target==='one'?document.getElementById('co-client').value:'';
  const targetClient=targetClientId?clients.find(c=>c.id===targetClientId):null;
  const coupon={
    id:uid(),name,
    type:document.getElementById('co-type').value,
    val,target,
    targetClientId,
    targetName:targetClient?`${targetClient.prenom} ${targetClient.nom}`:'',
    code:genCode(),
    expDate:document.getElementById('co-exp').value,
    maxUse:parseInt(document.getElementById('co-max').value)||1,
    usedCount:0,
    status:'active',
    createdAt:today()
  };
  coupons.push(coupon);
  save();
  // â”€â”€ Pousser le coupon dans fidelite_public des clients ciblÃ©s â”€â”€
  await pushCouponToClients(coupon);
  renderCoupons();closeModal();toast('ğŸ« Coupon crÃ©Ã© !');
}

async function pushCouponToClients(coupon){
  if(!window._uid||!window._fbSetDoc||!window._fbDoc||!window._fbGetDoc){
    console.warn('pushCoupon: Firebase non dispo',{uid:window._uid,setDoc:!!window._fbSetDoc});
    return;
  }
  const target=coupon.target;
  let targets=[];
  if(target==='one'){
    const c = coupon.targetClientId
      ? clients.find(x=>x.id===coupon.targetClientId)
      : clients.find(x=>(x.prenom+' '+x.nom)===coupon.targetName);
    if(c) targets=[c];
    else console.warn('pushCoupon: client non trouvÃ©',coupon.targetClientId, coupon.targetName);
  } else if(target==='all'){
    targets=clients;
  } else if(target==='vip'){
    targets=clients.filter(c=>c.points>=(cfg.vipPts||2000));
  } else if(target==='inactif'){
    const cutoff=new Date();cutoff.setMonth(cutoff.getMonth()-3);
    targets=clients.filter(c=>!c.lastVisit||new Date(c.lastVisit)<cutoff);
  } else if(target==='nouveau'){
    const cutoff=new Date();cutoff.setMonth(cutoff.getMonth()-1);
    targets=clients.filter(c=>c.createdAt&&new Date(c.createdAt)>=cutoff);
  }
  console.log('pushCoupon: cibles=',targets.map(x=>x.id));
  for(const c of targets){
    try{
      const snap=await window._fbGetDoc(window._fbDoc(window._db,'fidelite_public',c.id));
      const data=snap.exists()?snap.data():{};
      const existing=data.coupons||[];
      if(!existing.find(x=>x.id===coupon.id)){
        existing.push({
          id:coupon.id, name:coupon.name, type:coupon.type,
          val:coupon.val, code:coupon.code,
          expDate:coupon.expDate||'', status:'active'
        });
        await window._fbSetDoc(
          window._fbDoc(window._db,'fidelite_public',c.id),
          {coupons:existing},{merge:true}
        );
        console.log('pushCoupon: âœ… envoyÃ© Ã ',c.id);
      }
    }catch(e){console.error('pushCoupon err',c.id,e);}
  }
}
function useCoupon(id){
  const c=coupons.find(x=>x.id===id);
  if(!c)return;
  c.usedCount=(c.usedCount||0)+1;
  if(c.usedCount>=(c.maxUse||Infinity))c.status='used';
  save();renderCoupons();toast('âœ… Coupon marquÃ© utilisÃ©');
}
function deleteCoupon(id){coupons=coupons.filter(c=>c.id!==id);save();renderCoupons()}

// â•â•â• CAMPAGNES â•â•â•

function updateCaPreview(){
  const msg=document.getElementById('ca-msg').value;
  const sample=clients[0]||{prenom:'Marie',points:350,tampons:4};
  const preview=msg.replace('{prenom}',sample.prenom||'Marie').replace('{points}',sample.points||0).replace('{tampons}',sample.tampons||0).replace('{coupon}','PROMO10');
  document.getElementById('ca-preview').innerHTML=`<strong>AperÃ§u :</strong> ${preview}`;
}
function saveCampagne(planned){
  const name=document.getElementById('ca-name').value.trim();
  const msg=document.getElementById('ca-msg').value.trim();
  if(!name||!msg){toast('Nom et message obligatoires','err');return}
  campagnes.unshift({
    id:uid(),name,msg,planned,
    canal:document.getElementById('ca-canal').value,
    segment:document.getElementById('ca-seg').value,
    date:document.getElementById('ca-date').value||today(),
    heure:document.getElementById('ca-heure').value,
    createdAt:today()
  });
  save();renderCampagnes();closeModal();
  toast(planned?'ğŸ“… Campagne planifiÃ©e !':'ğŸš€ Campagne envoyÃ©e en test !','info');
}

// â•â•â• RESET â•â•â•
async function syncAllToFirebase(){
  if(!window._uid || !window._fbSaveClient){
    toast('âš ï¸ Connectez-vous dabord','err');return;
  }
  const btn=event.target;
  const status=document.getElementById('syncStatus');
  btn.disabled=true;btn.textContent='â³ Synchronisation...';
  status.textContent='';
  let ok=0;let err=0;
  // Sync config
  try{
    await window._fbSaveConfig(window._uid, cfg);
  }catch(e){console.warn('cfg sync err',e)}
  // Sync paliers
  try{
    await window._fbSavePaliers(window._uid, paliers);
  }catch(e){console.warn('paliers sync err',e)}
  // Sync chaque client
  for(const c of clients){
    try{
      await window._fbSaveClient(window._uid, c);
      ok++;
      status.textContent=`${ok}/${clients.length} clients synchronisÃ©s...`;
    }catch(e){
      console.warn('client sync err',c.id,e);
      err++;
    }
  }
  btn.disabled=false;btn.textContent='â˜ï¸ Synchroniser tous les clients vers Firebase';
  if(err===0){
    status.textContent=`âœ… ${ok} client${ok>1?'s':''} synchronisÃ©${ok>1?'s':''} avec succÃ¨s !`;
    status.style.color='var(--green)';
    toast(`âœ… ${ok} clients envoyÃ©s sur Firebase !`,'ok');
  }else{
    status.textContent=`âš ï¸ ${ok} ok, ${err} erreur${err>1?'s':''}`;
    status.style.color='var(--orange)';
  }
}
function showAutoSaveIndicator(ctx){
  let ind=document.getElementById('globalSaveInd');
  if(!ind){
    ind=document.createElement('div');
    ind.id='globalSaveInd';
    ind.style.cssText='position:fixed;bottom:20px;right:20px;background:#1a1f36;color:#fff;padding:8px 14px;border-radius:20px;font-size:11px;font-weight:700;z-index:9999;opacity:0;transition:.3s;pointer-events:none';
    document.body.appendChild(ind);
  }
  ind.textContent='ğŸ’¾ Sauvegarde...';
  ind.style.opacity='1';
}
function hideAutoSaveIndicator(ctx){
  const ind=document.getElementById('globalSaveInd');
  if(ind){ind.textContent='âœ… SauvegardÃ©';setTimeout(()=>{ind.style.opacity='0'},1500);}
}
function resetPoints(){clients.forEach(c=>c.points=0);save();toast('Points rÃ©initialisÃ©s')}
function resetClients(){if(!confirm('Vraiment supprimer tous les clients ?'))return;clients=[];save();renderClients();renderDashboard();toast('Clients supprimÃ©s')}

// â•â•â• MODAL â•â•â•
function openModal(id){
  // Fermer tous les autres d'abord
  document.querySelectorAll('.modal-wrap').forEach(m=>m.classList.add('hidden'));
  const mw=document.getElementById('mw-'+id);
  if(!mw){console.warn('modal non trouvÃ©:',id);return}
  mw.classList.remove('hidden');
  document.body.style.overflow='hidden';
  // Peupler selects clients
  if(id==='addTampon'||id==='addCoupon'){
    const opts=clients.map(c=>`<option value="${c.id}">${c.prenom} ${c.nom}</option>`).join('');
    const tpc=document.getElementById('tp-client');if(tpc)tpc.innerHTML=opts;
    const coc=document.getElementById('co-client');if(coc)coc.innerHTML=opts;
    if(id==='addTampon'&&clients.length)updateTpPreview();
  }
  // Dates par dÃ©faut
  const coExp=document.getElementById('co-exp');
  if(coExp&&!coExp.value){const dt=new Date();dt.setMonth(dt.getMonth()+3);coExp.value=dt.toISOString().slice(0,10)}
  const caDate=document.getElementById('ca-date');if(caDate&&!caDate.value)caDate.value=today();
}
function closeModal(id){
  if(id){document.getElementById('mw-'+id)?.classList.add('hidden')}
  else{document.querySelectorAll('.modal-wrap').forEach(m=>m.classList.add('hidden'))}
  document.body.style.overflow='';
}
function toggleCoClient(){
  const t=document.getElementById('co-target')?.value;
  document.getElementById('co-client-field')?.classList.toggle('hidden',t!=='one');
}

// â•â•â• FICHE CLIENT â•â•â•
let _fcClientId=null;
let _fcTab='infos';
function openFicheClient(id){
  _fcClientId=id;
  _fcTab='infos';
  const c=clients.find(x=>x.id===id);
  if(!c)return;
  const seg=getSeg(c);
  const segLabels={vip:'ğŸ‘‘ VIP',actif:'âœ… Actif',inactif:'ğŸ˜´ Inactif',nouveau:'ğŸŒ± Nouveau'};
  document.getElementById('fc-avatar').textContent=(c.prenom[0]||'')+(c.nom[0]||'');
  document.getElementById('fc-avatar').style.background=avatarColor(c.prenom);
  document.getElementById('fc-name').textContent=`${c.prenom} ${c.nom}`;
  document.getElementById('fc-seg').textContent=segLabels[seg]||'';
  document.getElementById('fc-pts-display').textContent=fi(c.points||0)+' pts';
  // Champs infos
  document.getElementById('fc-prenom').value=c.prenom||'';
  document.getElementById('fc-nom').value=c.nom||'';
  document.getElementById('fc-tel').value=c.tel||'';
  document.getElementById('fc-email').value=c.email||'';
  document.getElementById('fc-bday').value=c.birthday||'';
  document.getElementById('fc-note').value=c.note||'';
  // Reset tabs
  // Reset tous les panels + activer Infos
  ['infos','points','carte','histo'].forEach(p=>{
    const panel=document.getElementById('fc-panel-'+p);
    if(panel)panel.classList.toggle('hidden',p!=='infos');
  });
  document.querySelectorAll('.fc-tab').forEach((x,i)=>{
    x.classList.toggle('on',i===0);
  });
  openModal('ficheClient');
}
function fcTab(t,tabEl){
  _fcTab=t;
  document.querySelectorAll('.fc-tab').forEach(x=>x.classList.remove('on'));
  if(tabEl)tabEl.classList.add('on');
  ['infos','points','carte','histo'].forEach(p=>{
    const panel=document.getElementById('fc-panel-'+p);
    if(panel)panel.classList.toggle('hidden',p!==t);
  });
  // Scroller la modale vers le contenu
  const modal=document.querySelector('#mw-ficheClient .modal');
  if(modal){
    if(t==='histo') setTimeout(function(){modal.scrollTop=modal.scrollHeight;},50);
    else modal.scrollTop=0;
  }
  const c=clients.find(x=>x.id===_fcClientId);
  if(!c)return;
  if(t==='points'){
    document.getElementById('fc-pts-val').textContent=fi(c.points||0);
    document.getElementById('fc-pts-total').textContent=fi(c.totalPts||c.points||0);
    const nextP=[...paliers].sort((a,b)=>a.pts-b.pts).find(p=>p.pts>(c.points||0));
    document.getElementById('fc-next-palier').textContent=nextP?`${nextP.icon} ${nextP.reward} (${fi(nextP.pts-(c.points||0))} pts)` : 'ğŸ‰ Tous dÃ©bloquÃ©s !';
  }
  if(t==='carte'){
    const cfgT=parseInt(cfg.tampons)||10;
    const t2=c.tampons||0;
    document.getElementById('fc-tampons-count').textContent=t2;
    document.getElementById('fc-tampons-max').textContent=cfgT;
    const emoji=cfg.emoji||'â˜•';
    document.getElementById('fc-tampons-grid').innerHTML=Array.from({length:cfgT},(_,i)=>`
      <div style="width:36px;height:36px;border-radius:50%;border:2px solid ${i<t2?'rgba(79,126,248,.6)':'var(--border)'};display:flex;align-items:center;justify-content:center;font-size:16px;background:${i<t2?'#eff6ff':'transparent'}">${i<t2?emoji:'â—‹'}</div>`).join('');
    const ci=document.getElementById('fc-carte-info');ci.style.background=t2>=cfgT?'#f0fdf4':'#fffbeb';ci.style.border='1.5px solid '+(t2>=cfgT?'#bbf7d0':'#fde68a');ci.style.color=t2>=cfgT?'#065f46':'#92400e';ci.textContent=t2>=cfgT?`ğŸ Carte complÃ¨te ! RÃ©compense disponible : ${cfg.reward||'1 produit offert'}`:`Plus que ${cfgT-t2} tampon${cfgT-t2>1?'s':''} pour ${cfg.reward||'1 produit offert'}`;
  }
  if(t==='histo'){
    const hist=(c.history||[]).slice(0,20);
    document.getElementById('fc-histo-list').innerHTML=hist.length
      ?hist.map(h=>`<div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid #f1f5f9">
        <div style="width:32px;height:32px;border-radius:50%;background:${h.type==='tampon'?'#eff6ff':'#f0fdf4'};display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0">${h.type==='tampon'?'âœ…':'â­'}</div>
        <div><div style="font-size:12px;font-weight:700">${h.type==='tampon'?'Achat â€” tampon':'Points ajoutÃ©s'}</div>
        <div style="font-size:10px;color:var(--muted)">${new Date(h.date).toLocaleDateString('fr-FR')}${h.montant?' Â· '+h.montant+'â‚¬':''}</div></div>
        <div style="margin-left:auto;font-size:13px;font-weight:800;color:var(--green)">+${h.pts||1} ${h.pts?'pts':'tampon'}</div>
      </div>`).join('')
      :'<div style="text-align:center;padding:24px;color:var(--muted);font-size:12px">Aucune visite enregistrÃ©e</div>';
  }
}
let _fcAutoSaveTimer=null;
function fcAutoSave(){
  clearTimeout(_fcAutoSaveTimer);
  const s=document.getElementById('fc-autosave-status');
  if(s){s.style.display='inline';s.textContent='â³ Modification...';}
  _fcAutoSaveTimer=setTimeout(()=>{
    fcSave(true); // true = silent mode
  },1200);
}
function fcSave(silent){
  const c=clients.find(x=>x.id===_fcClientId);
  if(!c)return;
  c.prenom=document.getElementById('fc-prenom').value.trim()||c.prenom;
  c.nom=document.getElementById('fc-nom').value.trim()||c.nom;
  c.tel=document.getElementById('fc-tel').value.trim();
  c.email=document.getElementById('fc-email').value.trim();
  c.birthday=document.getElementById('fc-bday').value;
  c.note=document.getElementById('fc-note').value.trim();
  save();renderClients();
  // RafraÃ®chir header fiche
  document.getElementById('fc-name').textContent=`${c.prenom} ${c.nom}`;
  document.getElementById('fc-avatar').textContent=(c.prenom[0]||'')+(c.nom[0]||'');
  toast('âœ… Fiche enregistrÃ©e !');
}
function fcAddPoints(sign){
  const c=clients.find(x=>x.id===_fcClientId);if(!c)return;
  const n=parseInt(document.getElementById('fc-pts-add').value)||0;
  if(!n)return;
  c.points=Math.max(0,(c.points||0)+sign*n);
  if(sign>0)c.totalPts=(c.totalPts||0)+n;
  c.history=c.history||[];
  c.history.unshift({date:today(),type:'manuel',pts:sign*n});
  save();
  document.getElementById('fc-pts-val').textContent=fi(c.points);
  document.getElementById('fc-pts-display').textContent=fi(c.points)+' pts';
  toast((sign>0?'+':'')+sign*n+' points');
}
function fcAddTampon(){
  const c=clients.find(x=>x.id===_fcClientId);if(!c)return;
  const cfgT=parseInt(cfg.tampons)||10;
  c.tampons=(c.tampons||0)+1;
  c.lastVisit=today();
  c.history=c.history||[];
  c.history.unshift({date:today(),type:'tampon',montant:0,pts:0});
  if(c.tampons>=cfgT){toast(`ğŸ Carte complÃ¨te ! RÃ©compense : ${cfg.reward||'1 produit offert'}`,'info');c.tampons=0}
  save();fcTab('carte',null);
  toast('Tampon ajoutÃ© !');
}
function fcResetTampons(){
  if(!confirm('RÃ©initialiser la carte de ce client ?'))return;
  const c=clients.find(x=>x.id===_fcClientId);if(!c)return;
  c.tampons=0;save();fcTab('carte',null);toast('Carte rÃ©initialisÃ©e');
}
function fcDelete(){
  if(!confirm('Supprimer dÃ©finitivement ce client ?'))return;
  if(window._uid&&window._fbDeleteClient)window._fbDeleteClient(window._uid,_fcClientId).catch(()=>{});
  clients=clients.filter(x=>x.id!==_fcClientId);
  save();closeModal('ficheClient');renderClients();
  toast('Client supprimÃ©');
}
function fcShowLink(){
  const origin = location.origin;
  const pathParts = location.pathname.split('/');
  pathParts[pathParts.length-1] = 'client-fidelite.html';
  const url = origin + pathParts.join('/') + '?client=' + _fcClientId;
  const el = document.getElementById('fc-link-display');
  if(el){
    el.style.display = el.style.display==='none' ? 'block' : 'none';
    el.textContent = url;
  }
}
function fcCopyLink(){
  // Construire l'URL propre sans hash
  const origin = location.origin;
  const pathParts = location.pathname.split('/');
  pathParts[pathParts.length-1] = 'client-fidelite.html';
  const url = origin + pathParts.join('/') + '?client=' + _fcClientId;
  
  // Afficher le lien dans la fiche pour vÃ©rification
  const btn = document.getElementById('fc-link-btn');
  if(btn) btn.title = url;
  
  navigator.clipboard?.writeText(url).then(()=>{
    toast('ğŸ”— Lien copiÃ© !','info');
  }).catch(()=>{
    prompt('Copiez ce lien et envoyez-le au client :',url);
  });
}

// â•â•â• DEMO DATA â•â•â•
function seedDemo(){
  if(clients.length)return;
  const names=[['Marie','Martin'],['Jean','Dupont'],['Sophie','LefÃ¨vre'],['Pierre','Bernard'],['Emma','Dubois'],['Lucas','Moreau'],['LÃ©a','Laurent'],['Thomas','Simon']];
  const now=new Date();
  names.forEach(([prenom,nom],i)=>{
    const daysAgo=Math.floor(Math.random()*120);
    const last=new Date(now-daysAgo*86400000).toISOString().slice(0,10);
    const bm=String((i%12)+1).padStart(2,'0');
    clients.push({
      id:uid(),prenom,nom,
      email:`${prenom.toLowerCase()}@email.com`,
      tel:`06${Math.floor(Math.random()*90000000+10000000)}`,
      birthday:`1990-${bm}-15`,
      points:Math.floor(Math.random()*2500),
      tampons:Math.floor(Math.random()*(parseInt(cfg.tampons)||10)),
      lastVisit:last,
      createdAt:new Date(now-180*86400000).toISOString().slice(0,10),
      history:[]
    });
  });
  coupons=[
    {id:uid(),name:'Offre printemps',type:'pct',val:10,target:'all',code:'SPRING10',expDate:'2026-06-30',maxUse:50,usedCount:12,status:'active',createdAt:today()},
    {id:uid(),name:'CafÃ© offert',type:'free',val:0,target:'vip',code:'VIPFREE',expDate:'2026-12-31',maxUse:20,usedCount:5,status:'active',createdAt:today()},
    {id:uid(),name:'RÃ©duction anniversaire',type:'eur',val:5,target:'all',code:'BDAY5',expDate:'2025-12-31',maxUse:30,usedCount:30,status:'used',createdAt:today()},
  ];
  save();
}

// â•â•â• APPLY CONFIG (pour rechargement Firebase) â•â•â•
function applyConfig(){
  try{
    document.getElementById('cfg-tampons').value=cfg.tampons||10;
    document.getElementById('cfg-reward').value=cfg.reward||'1 produit offert';
    document.getElementById('cfg-emoji').value=cfg.emoji||'â˜•';
    document.getElementById('cfg-validity').value=cfg.validity||365;
    document.getElementById('cfg-pts-per-euro').value=cfg.ptsPerEuro||10;
    document.getElementById('cfg-bday-pts').value=cfg.bdayPts||200;
    document.getElementById('cfg-ref-pts').value=cfg.refPts||500;
    document.getElementById('cfg-vip-pts').value=cfg.vipPts||2000;
    document.getElementById('cfg-shop-name').value=cfg.shopName||'';
    document.getElementById('cfg-notif-bday').checked=cfg.notifBday!==false;
    document.getElementById('cfg-notif-inactif').checked=cfg.notifInactif!==false;
    document.getElementById('cfg-notif-palier').checked=cfg.notifPalier!==false;
    document.getElementById('cfg-notif-coupon').checked=!!cfg.notifCoupon;
    renderFidCard();
  }catch(e){}
}

// â•â•â• INIT â•â•â•
load();
seedDemo();
renderFidCard();
renderDashboard();
</script>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import{getAuth,onAuthStateChanged,signOut}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import{getFirestore,doc,setDoc,getDoc,collection,getDocs,deleteDoc,writeBatch}from"https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const FB = {apiKey:"AIzaSyB003WqdRKrT0gbv7P4BNIICuXeqbu8dR4",authDomain:"altiora-70599.firebaseapp.com",projectId:"altiora-70599",storageBucket:"altiora-70599.firebasestorage.app",messagingSenderId:"120905555746",appId:"1:120905555746:web:618460c65cdc9e57cc8f7b"};
const app=initializeApp(FB);
const auth=getAuth(app);
const db=getFirestore(app);

// â”€â”€ Expose globalement â”€â”€
window._auth=auth; window._signOut=signOut; window._db=db;
window._fbSetDoc=setDoc; window._fbGetDoc=getDoc; window._fbDoc=doc;
window._fbCollection=collection; window._fbGetDocs=getDocs;
window._fbDeleteDoc=deleteDoc; window._fbWriteBatch=writeBatch;

// â”€â”€ Helpers Firebase FidÃ©litÃ© â”€â”€
async function fbSaveClient(uid, client){
  // 1. DonnÃ©es commerÃ§ant (privÃ©es)
  await setDoc(doc(db,'fidelite',uid,'clients',client.id), client, {merge:true});
  // 2. DonnÃ©es publiques client (carte accessible sans auth)
  const pub = {
    id:client.id, prenom:client.prenom, nom:client.nom,
    points:client.points||0, tampons:client.tampons||0,
    lastVisit:client.lastVisit||'', history:(client.history||[]).slice(0,20),
    createdAt:client.createdAt||'', birthday:client.birthday||'',
    uid // pour retrouver la config du commerÃ§ant
  };
  await setDoc(doc(db,'fidelite_public',client.id), pub, {merge:true});
}
async function fbDeleteClient(uid, clientId){
  await deleteDoc(doc(db,'fidelite',uid,'clients',clientId));
  await deleteDoc(doc(db,'fidelite_public',clientId));
}
async function fbSaveConfig(uid, cfg){
  await setDoc(doc(db,'fidelite',uid,'config','main'), cfg, {merge:true});
  // Config publique (tampons, reward, emoji, shopName pour la page client)
  await setDoc(doc(db,'fidelite_public_cfg',uid), {
    tampons:cfg.tampons||10, reward:cfg.reward||'1 produit offert',
    emoji:cfg.emoji||'â˜•', shopName:cfg.shopName||'',
    cardColor:cfg.cardColor||'blue', vipPts:cfg.vipPts||2000,
    paliers:[] // rempli sÃ©parÃ©ment
  }, {merge:true});
}
async function fbSavePaliers(uid, paliers){
  await setDoc(doc(db,'fidelite_public_cfg',uid), {paliers}, {merge:true});
}
async function fbLoadAll(uid){
  // Clients
  const snap = await getDocs(collection(db,'fidelite',uid,'clients'));
  const fbClients = snap.docs.map(d=>d.data());
  // Config
  const cfgSnap = await getDoc(doc(db,'fidelite',uid,'config','main'));
  const fbCfg = cfgSnap.exists() ? cfgSnap.data() : {};
  return {clients: fbClients, cfg: fbCfg};
}

window._fbSaveClient=fbSaveClient;
window._fbDeleteClient=fbDeleteClient;
window._fbSaveConfig=fbSaveConfig;
window._fbSavePaliers=fbSavePaliers;
window._fbLoadAll=fbLoadAll;

// â”€â”€ Auth â”€â”€
onAuthStateChanged(auth, async user=>{
  if(!user){location.href='index.html';return}
  window._uid=user.uid;
  loadSmsCredits();
  const n=user.displayName||user.email?.split('@')[0]||'';
  document.getElementById('uname').textContent=n;
  document.getElementById('av').textContent=n[0]?.toUpperCase()||'A';

  showSyncBadge('â³ Connexion Firebase...');

  // â”€â”€ Test d'accÃ¨s Firebase en Ã©crivant un doc de test â”€â”€
  try{
    // 1. Test Ã©criture simple (config)
    await setDoc(doc(db,'fidelite',user.uid,'config','main'), {_ping: Date.now()}, {merge:true});
    
    // 2. Charger clients
    const snap = await getDocs(collection(db,'fidelite',user.uid,'clients'));
    const fbClients = snap.docs.map(d=>d.data());
    if(fbClients.length > 0){
      clients = fbClients;
      localStorage.setItem('altiora_fid_clients', JSON.stringify(clients));
    }

    // 3. Charger config
    const cfgSnap = await getDoc(doc(db,'fidelite',user.uid,'config','main'));
    if(cfgSnap.exists()){
      const fbCfg = cfgSnap.data();
      delete fbCfg._ping;
      if(Object.keys(fbCfg).length > 0){
        cfg = {...cfg, ...fbCfg};
        localStorage.setItem('altiora_fid_cfg', JSON.stringify(cfg));
        applyConfig();
      }
    }

    // 4. Charger paliers depuis config publique
    try{
      const pubCfgSnap = await getDoc(doc(db,'fidelite_public_cfg',user.uid));
      if(pubCfgSnap.exists() && pubCfgSnap.data().paliers?.length){
        paliers = pubCfgSnap.data().paliers;
        localStorage.setItem('altiora_fid_paliers', JSON.stringify(paliers));
      }
    }catch(e2){ /* paliers depuis localStorage si erreur */ }

    window._firebaseReady = true;
    window.renderDashboard();
    window.renderFidCard();
    document.getElementById('badge-clients').textContent=clients.length;
    document.getElementById('badge-coupons').textContent=coupons.filter(c=>c.status==='active').length;
    showSyncBadge('âœ… Firebase connectÃ©');
    setTimeout(()=>hideSyncBadge(),2500);

  }catch(e){
    console.error('Firebase error:', e.code, e.message);
    // Afficher le vrai problÃ¨me
    const code = e.code || e.name || 'inconnu';
    const msg2 = code.includes('permission') ? 'âš ï¸ RÃ¨gles Firebase â€” voir Ã©tapes'
      : code.includes('not-found') || code.includes('404') ? 'âš ï¸ Firestore non activÃ©'
      : code.includes('unavailable') ? 'âš ï¸ Firebase hors ligne'
      : 'âš ï¸ Erreur : ' + code + ' â€” ' + (e.message||'').slice(0,40);
    showSyncBadge(msg2, true);
    console.error('DÃ©tail erreur Firebase:', JSON.stringify({code:e.code,name:e.name,msg:e.message}));
    // Fonctionner quand mÃªme en local
    window._firebaseReady = true;
    window.renderDashboard();
    window.renderFidCard();
  }
});

function showSyncBadge(msg, isError){
  let b=document.getElementById('syncBadge');
  if(!b){b=document.createElement('div');b.id='syncBadge';b.style.cssText='position:fixed;top:14px;right:14px;padding:8px 14px;border-radius:20px;font-size:11px;font-weight:700;z-index:9999;color:#fff;transition:.3s;max-width:280px;text-align:center;cursor:pointer';document.body.appendChild(b)}
  b.textContent=msg;
  b.style.background=isError?'#ef4444':msg.includes('âœ…')?'#10b981':'#1a1f36';
  b.style.opacity='1';
  if(isError){
    // Afficher plus longtemps + lien vers aide
    b.title='Voir les rÃ¨gles Firebase Ã  configurer';
    setTimeout(()=>{b.style.opacity='0'},8000);
  }
}
function hideSyncBadge(){
  const b=document.getElementById('syncBadge'); if(b)b.style.opacity='0';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CRÃ‰DITS SMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var _smsCredits = 0;
var _selectedPack = 'pack_200';

async function loadSmsCredits() {
  if (!window._uid || !window._fbGetDoc || !window._fbDoc) return;
  try {
    const snap = await window._fbGetDoc(window._fbDoc(window._db, 'sms_credits', window._uid));
    _smsCredits = snap.exists() ? (parseInt(snap.data().credits) || 0) : 0;
  } catch(e) {
    _smsCredits = 0;
  }
  const el = document.getElementById('smsCreditsDisplay');
  if (el) el.textContent = _smsCredits;
}

function smsSelectPack(packId) {
  _selectedPack = packId;
  var ids = ['spack_50','spack_200','spack_500'];
  ids.forEach(function(id) {
    var el = document.getElementById(id);
    if (!el) return;
    el.style.border = '2px solid #e2e8f0';
    el.style.background = '#fff';
    el.style.boxShadow = 'none';
  });
  var num = packId.replace('pack_','');
  var sel = document.getElementById('spack_' + num);
  if (sel) {
    sel.style.border = '2px solid #4f7ef8';
    sel.style.background = '#eff6ff';
    sel.style.boxShadow = '0 0 0 3px rgba(79,126,248,.15)';
  }
}

async function smsPayer() {
  var currentUid = window._uid;
  if (!currentUid) { toast('Non connectÃ© â€” rechargez la page', 'err'); return; }
  var btn = document.getElementById('smsPayBtn');
  btn.textContent = 'â³ Redirection...';
  btn.disabled = true;
  try {
    var res = await fetch('https://altiora-theta.vercel.app/api/create-checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ packId: _selectedPack, uid: currentUid }),
    });
    var data = await res.json();
    if (data.url) {
      window.location.href = data.url;
    } else {
      toast('Erreur: ' + (data.error || 'inconnue'), 'err');
      btn.textContent = 'ğŸ’³ Payer avec Stripe';
      btn.disabled = false;
    }
  } catch(e) {
    toast('Erreur connexion: ' + e.message, 'err');
    btn.textContent = 'ğŸ’³ Payer avec Stripe';
    btn.disabled = false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENVOI CAMPAGNE SMS RÃ‰EL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function envoyerCampagneSMS(campagne) {
  if (!window._uid) { toast('Non connectÃ©', 'err'); return; }

  // SÃ©lectionner les destinataires selon le segment
  const cibles = clients.filter(function(c) {
    if (!c.tel) return false;
    if (campagne.segment === 'all') return true;
    return getSeg(c) === campagne.segment;
  });

  if (cibles.length === 0) {
    toast('Aucun client avec numÃ©ro de tÃ©lÃ©phone dans ce segment', 'err');
    return;
  }

  if (_smsCredits < cibles.length) {
    toast('Solde insuffisant (' + _smsCredits + ' SMS, ' + cibles.length + ' destinataires)', 'err');
    openModal('acheterSms');
    return;
  }

  if (!confirm('Envoyer ' + cibles.length + ' SMS ? (' + _smsCredits + ' crÃ©dits disponibles)')) return;

  toast('â³ Envoi en cours...', 'ok');

  try {
    const res = await fetch('https://altiora-theta.vercel.app/api/send-sms', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        uid: window._uid,
        campagneId: campagne.id,
        recipients: cibles.map(function(c) { return c.tel; }),
        message: campagne.msg,
        sender: (cfg.shopName || 'ALTIORA').slice(0, 11),
      }),
    });
    const data = await res.json();
    if (data.success) {
      _smsCredits = data.remaining;
      const el = document.getElementById('smsCreditsDisplay');
      if (el) el.textContent = _smsCredits;
      toast('âœ… ' + data.sent + ' SMS envoyÃ©s ! Solde : ' + data.remaining, 'ok');
      // Marquer la campagne comme envoyÃ©e
      const idx = campagnes.findIndex(function(c) { return c.id === campagne.id; });
      if (idx >= 0) { campagnes[idx].sent = true; campagnes[idx].sentCount = data.sent; save(); renderCampagnes(); }
    } else if (data.error === 'Solde insuffisant') {
      toast('Solde insuffisant â€” achetez des SMS', 'err');
      openModal('acheterSms');
    } else {
      toast('Erreur: ' + (data.error || 'inconnue'), 'err');
    }
  } catch(e) {
    toast('Erreur connexion', 'err');
  }
}

// VÃ©rifier si retour de paiement Stripe
(function checkStripeReturn() {
  const params = new URLSearchParams(window.location.search);
  if (params.get('sms') === 'success') {
    setTimeout(function() {
      toast('âœ… Paiement reÃ§u ! CrÃ©dits SMS mis Ã  jour dans quelques secondes...', 'ok');
      setTimeout(loadSmsCredits, 3000);
      // Nettoyer l'URL
      history.replaceState({}, '', window.location.pathname);
    }, 500);
  } else if (params.get('sms') === 'cancel') {
    setTimeout(function() {
      toast('Paiement annulÃ©', 'err');
      history.replaceState({}, '', window.location.pathname);
    }, 500);
  }
})();

</script>
</body>
</html>
